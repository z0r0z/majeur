<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>MAJ·DAO</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Cdefs%3E%3CradialGradient id='bg'%3E%3Cstop offset='0%25' stop-color='%230a0015'/%3E%3Cstop offset='100%25' stop-color='%23000'/%3E%3C/radialGradient%3E%3C/defs%3E%3Crect width='32' height='32' fill='url(%23bg)'/%3E%3Cg opacity='0.9'%3E%3Cline x1='16' y1='0' x2='16' y2='16' stroke='white' stroke-width='0.8' opacity='0.7'/%3E%3Cline x1='16' y1='32' x2='16' y2='16' stroke='white' stroke-width='0.8' opacity='0.7'/%3E%3Cline x1='0' y1='16' x2='16' y2='16' stroke='white' stroke-width='0.8' opacity='0.7'/%3E%3Cline x1='32' y1='16' x2='16' y2='16' stroke='white' stroke-width='0.8' opacity='0.7'/%3E%3Cline x1='3' y1='3' x2='16' y2='16' stroke='white' stroke-width='0.6' opacity='0.5'/%3E%3Cline x1='29' y1='3' x2='16' y2='16' stroke='white' stroke-width='0.6' opacity='0.5'/%3E%3Cline x1='3' y1='29' x2='16' y2='16' stroke='white' stroke-width='0.6' opacity='0.5'/%3E%3Cline x1='29' y1='29' x2='16' y2='16' stroke='white' stroke-width='0.6' opacity='0.5'/%3E%3Cline x1='8' y1='0' x2='16' y2='16' stroke='white' stroke-width='0.5' opacity='0.4'/%3E%3Cline x1='24' y1='0' x2='16' y2='16' stroke='white' stroke-width='0.5' opacity='0.4'/%3E%3Cline x1='8' y1='32' x2='16' y2='16' stroke='white' stroke-width='0.5' opacity='0.4'/%3E%3Cline x1='24' y1='32' x2='16' y2='16' stroke='white' stroke-width='0.5' opacity='0.4'/%3E%3Cline x1='0' y1='8' x2='16' y2='16' stroke='white' stroke-width='0.5' opacity='0.4'/%3E%3Cline x1='32' y1='8' x2='16' y2='16' stroke='white' stroke-width='0.5' opacity='0.4'/%3E%3Cline x1='0' y1='24' x2='16' y2='16' stroke='white' stroke-width='0.5' opacity='0.4'/%3E%3Cline x1='32' y1='24' x2='16' y2='16' stroke='white' stroke-width='0.5' opacity='0.4'/%3E%3C/g%3E%3Ccircle cx='16' cy='16' r='6' fill='none' stroke='white' stroke-width='0.6' opacity='0.4'/%3E%3Ccircle cx='16' cy='16' r='3.5' fill='none' stroke='%239d7bff' stroke-width='0.5' opacity='0.6'/%3E%3Ccircle cx='16' cy='16' r='1.5' fill='%239d7bff' opacity='0.3'/%3E%3C/svg%3E" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta name="theme-color" content="#0a0015" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.15.0/ethers.umd.min.js" integrity="sha512-UXYETj+vXKSURF1UlgVRLzWRS9ZiQTv3lcL4rbeLyqTXCPNZC6PTLF/Ik3uxm2Zo+E109cUpJPZfLxJsCgKSng==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;1,400;1,500&family=Cinzel:wght@400;500;600&display=swap");

      :root {
        /* Primary Colors */
        --primary-purple: #9d7bff;
        --light-text: #e6d9ff;
        --dark-bg: #0a0015;
        --pure-black: #000000;
        --dark-purple: #2a1a4a;

        /* Primary Purple Variations */
        --primary-purple-05: rgba(157, 123, 255, 0.05);
        --primary-purple-08: rgba(157, 123, 255, 0.08);
        --primary-purple-1: rgba(157, 123, 255, 0.1);
        --primary-purple-15: rgba(157, 123, 255, 0.15);
        --primary-purple-2: rgba(157, 123, 255, 0.2);
        --primary-purple-25: rgba(157, 123, 255, 0.25);
        --primary-purple-3: rgba(157, 123, 255, 0.3);
        --primary-purple-4: rgba(157, 123, 255, 0.4);
        --primary-purple-5: rgba(157, 123, 255, 0.5);
        --primary-purple-6: rgba(157, 123, 255, 0.6);
        --primary-purple-7: rgba(157, 123, 255, 0.7);
        --primary-purple-8: rgba(157, 123, 255, 0.8);

        /* Light Text Variations */
        --light-text-05: rgba(230, 217, 255, 0.05);
        --light-text-08: rgba(230, 217, 255, 0.08);
        --light-text-1: rgba(230, 217, 255, 0.1);
        --light-text-2: rgba(230, 217, 255, 0.2);
        --light-text-3: rgba(230, 217, 255, 0.3);
        --light-text-4: rgba(230, 217, 255, 0.4);
        --light-text-5: rgba(230, 217, 255, 0.5);
        --light-text-6: rgba(230, 217, 255, 0.6);
        --light-text-7: rgba(230, 217, 255, 0.7);
        --light-text-8: rgba(230, 217, 255, 0.8);
        --light-text-9: rgba(230, 217, 255, 0.9);

        /* Dark Backgrounds */
        --dark-bg-05: rgba(10, 0, 21, 0.05);
        --dark-bg-3: rgba(10, 0, 21, 0.3);
        --dark-bg-5: rgba(10, 0, 21, 0.5);
        --dark-bg-6: rgba(10, 0, 21, 0.6);
        --dark-bg-7: rgba(10, 0, 21, 0.7);
        --dark-bg-85: rgba(10, 0, 21, 0.85);
        --dark-bg-9: rgba(10, 0, 21, 0.9);
        --dark-bg-95: rgba(10, 0, 21, 0.95);

        /* Black Variations */
        --black-2: rgba(0, 0, 0, 0.2);
        --black-3: rgba(0, 0, 0, 0.3);
        --black-5: rgba(0, 0, 0, 0.5);
        --black-85: rgba(0, 0, 0, 0.85);

        /* Typography */
        --font-serif: 'EB Garamond', serif;
        --font-display: 'Cinzel', serif;

        /* Spacing & Sizing */
        --border-radius-sm: 4px;
        --border-radius-md: 6px;
        --border-radius-lg: 8px;

        /* Transitions */
        --transition-fast: 0.2s ease;
        --transition-normal: 0.3s ease;

        /* Mobile viewport height (set by JS to handle mobile browser chrome) */
        --vh: 1vh;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html,
      body {
        width: 100%;
        height: 100%;
        scroll-behavior: smooth;
      }

      /* Respect reduced motion preference */
      @media (prefers-reduced-motion: reduce) {
        html,
        body {
          scroll-behavior: auto;
        }

        *,
        *::before,
        *::after {
          animation-duration: 0.01ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.01ms !important;
        }
      }

      body {
        background: var(--pure-black);
        color: var(--light-text);
        font-family: var(--font-serif);
        overflow-x: hidden;
        overflow-y: auto;
        /* Improve touch scrolling on iOS */
        -webkit-overflow-scrolling: touch;
      }

      /* Global input styles for mobile optimization */
      input, textarea, select {
        font-size: 16px; /* Prevent zoom on iOS when focusing inputs */
        -webkit-appearance: none; /* Remove default iOS styling */
        appearance: none; /* Remove default styling */
        border-radius: 0; /* Prevent iOS from adding rounded corners */
      }

      /* STARRY BACKGROUND PATTERN */
      .starry-bg {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 0;
        background: radial-gradient(circle at center, #0a0015 0%, #000000 60%);
      }

      .stars-layer {
        position: absolute;
        width: 100%;
        height: 100%;
        background-image: 
          radial-gradient(2px 2px at 20px 30px, white, transparent),
          radial-gradient(2px 2px at 40px 70px, white, transparent),
          radial-gradient(1px 1px at 50px 50px, white, transparent),
          radial-gradient(1px 1px at 80px 10px, white, transparent),
          radial-gradient(2px 2px at 130px 80px, white, transparent),
          radial-gradient(1px 1px at 110px 40px, white, transparent),
          radial-gradient(1px 1px at 140px 60px, #9d7bff, transparent);
        background-size: 200px 200px;
        background-repeat: repeat;
        opacity: 0.3;
        animation: twinkle 10s infinite;
      }

      @keyframes twinkle {
        0%, 100% { opacity: 0.3; }
        50% { opacity: 0.5; }
      }

      /* SUMMON LINK */
      .summon-link {
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 1000;
        padding: 10px 18px;
        background: transparent;
        border: 1px solid rgba(157, 123, 255, 0.3);
        color: rgba(230, 217, 255, 0.7);
        font-family: "EB Garamond", serif;
        font-style: italic;
        font-size: 0.9rem;
        letter-spacing: 0.15em;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
      }

      .summon-link:hover {
        border-color: rgba(157, 123, 255, 0.5);
        color: #e6d9ff;
        background: rgba(157, 123, 255, 0.05);
      }

      /* LITE PAPER LINK */
      .litepaper-link {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
        padding: 8px 14px;
        background: rgba(10, 0, 21, 0.7);
        border: 1px solid rgba(157, 123, 255, 0.2);
        color: rgba(230, 217, 255, 0.6);
        font-family: "EB Garamond", serif;
        font-size: 0.75rem;
        letter-spacing: 0.1em;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
        text-transform: uppercase;
        backdrop-filter: blur(10px);
      }

      .litepaper-link:hover {
        border-color: rgba(157, 123, 255, 0.5);
        color: rgba(230, 217, 255, 0.9);
        background: rgba(10, 0, 21, 0.9);
        box-shadow: 0 0 15px rgba(157, 123, 255, 0.3);
      }

      /* GITHUB LINK */
      .github-link {
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 1000;
        padding: 8px 14px;
        background: rgba(10, 0, 21, 0.7);
        border: 1px solid rgba(157, 123, 255, 0.2);
        color: rgba(230, 217, 255, 0.6);
        font-family: "EB Garamond", serif;
        font-size: 0.75rem;
        letter-spacing: 0.1em;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
        text-transform: uppercase;
        backdrop-filter: blur(10px);
      }

      .github-link:hover {
        border-color: rgba(157, 123, 255, 0.5);
        color: rgba(230, 217, 255, 0.9);
        background: rgba(10, 0, 21, 0.9);
        box-shadow: 0 0 15px rgba(157, 123, 255, 0.3);
      }

      /* Hide fixed nav buttons when in DAO view */
      .hide-nav-buttons .summon-link,
      .hide-nav-buttons .litepaper-link,
      .hide-nav-buttons .github-link,
      .hide-nav-buttons .wallet-button {
        opacity: 0;
        pointer-events: none;
      }

      /* WALLET CONNECTION */
      .wallet-button {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        padding: 10px 18px;
        background: rgba(10, 0, 21, 0.9);
        border: 1px solid #9d7bff;
        color: #e6d9ff;
        font-family: "Cinzel", serif;
        font-size: 0.75rem;
        letter-spacing: 0.1em;
        cursor: pointer;
        transition: all 0.3s ease;
        will-change: transform, opacity;
      }

      .wallet-button:hover {
        background: rgba(157, 123, 255, 0.2);
        box-shadow: 0 0 20px rgba(157, 123, 255, 0.4);
      }

      .wallet-button.connected {
        color: #9d7bff;
      }

      /* SUMMONER SECTION */
      .summoner-section {
        min-height: 100vh;
        padding: 4rem 2rem;
        position: relative;
        z-index: 1;
        background: transparent;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }

      .summoner-container {
        max-width: 600px;
        width: 100%;
        padding: 3rem;
        background: rgba(10, 0, 21, 0.6);
        border: 1px solid rgba(157, 123, 255, 0.3);
        backdrop-filter: blur(10px);
      }

      .summoner-title {
        font-family: "Cinzel", serif;
        font-size: 1.8rem;
        text-align: center;
        letter-spacing: 0.3em;
        margin-bottom: 0.5rem;
        color: #e6d9ff;
        text-transform: uppercase;
      }

      .summoner-subtitle {
        font-family: "EB Garamond", serif;
        font-size: 1rem;
        text-align: center;
        margin-bottom: 2rem;
        color: rgba(230, 217, 255, 0.7);
        font-style: italic;
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      .form-label {
        display: block;
        font-family: "Cinzel", serif;
        font-size: 0.7rem;
        letter-spacing: 0.15em;
        text-transform: uppercase;
        color: rgba(230, 217, 255, 0.8);
        margin-bottom: 0.5rem;
      }

      .form-input {
        width: 100%;
        padding: 10px 14px;
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid rgba(157, 123, 255, 0.3);
        color: #e6d9ff;
        font-family: "EB Garamond", serif;
        font-size: 1rem;
        transition: all 0.3s ease;
      }

      .form-input:focus {
        outline: none;
        border-color: #9d7bff;
        box-shadow: 0 0 10px rgba(157, 123, 255, 0.2);
      }

      .form-input::placeholder {
        color: rgba(230, 217, 255, 0.4);
      }

      /* Reusable modal input styling - replaces inline styles */
      .modal-input {
        width: 100%;
        padding: 0.7rem;
        background: var(--black-3);
        border: 1px solid var(--primary-purple-3);
        color: var(--light-text);
        font-family: var(--font-serif);
        font-size: 0.9rem;
        border-radius: var(--border-radius-sm);
        transition: var(--transition-fast);
      }

      .modal-input:focus {
        outline: none;
        border-color: var(--primary-purple);
        box-shadow: 0 0 10px var(--primary-purple-2);
      }

      .modal-input::placeholder {
        color: var(--light-text-4);
      }

      .members-container {
        border: 1px solid rgba(157, 123, 255, 0.2);
        padding: 1rem;
        margin-top: 1rem;
      }

      .member-row {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
        align-items: center;
      }

      .member-address {
        flex: 2;
      }

      .member-shares {
        flex: 1;
      }

      .remove-member {
        width: 30px;
        height: 30px;
        background: rgba(255, 0, 0, 0.2);
        border: 1px solid rgba(255, 0, 0, 0.4);
        color: #ff6b6b;
        cursor: pointer;
        font-size: 1.2rem;
        line-height: 1;
        transition: all 0.3s ease;
      }

      .remove-member:hover {
        background: rgba(255, 0, 0, 0.3);
      }

      .add-member-btn {
        width: 100%;
        padding: 8px;
        background: rgba(157, 123, 255, 0.1);
        border: 1px solid rgba(157, 123, 255, 0.3);
        color: #9d7bff;
        font-family: "Cinzel", serif;
        font-size: 0.7rem;
        letter-spacing: 0.1em;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
      }

      .add-member-btn:hover {
        background: rgba(157, 123, 255, 0.2);
      }

      .summon-button {
        width: 100%;
        padding: 14px;
        margin-top: 2rem;
        background: linear-gradient(135deg, #9d7bff 0%, #6b4fb8 100%);
        border: none;
        color: #000;
        font-family: "Cinzel", serif;
        font-size: 1rem;
        letter-spacing: 0.3em;
        text-transform: uppercase;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
      }

      .summon-button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(157, 123, 255, 0.4);
      }

      .summon-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .summon-button:active:not(:disabled) {
        transform: translateY(0);
        box-shadow: 0 5px 15px rgba(157, 123, 255, 0.3);
      }

      /* Universal button enhancements */
      button:not(:disabled) {
        cursor: pointer;
      }

      button:active:not(:disabled) {
        transform: scale(0.98);
      }

      /* Smooth scrolling */
      * {
        scroll-behavior: smooth;
      }

      /* Focus styles for accessibility */
      *:focus-visible {
        outline: 2px solid #9d7bff;
        outline-offset: 2px;
      }

      /* Tooltip */
      .tooltip {
        position: relative;
        display: inline-block;
      }

      .tooltip .tooltip-text {
        visibility: hidden;
        background: rgba(10, 0, 21, 0.95);
        color: #e6d9ff;
        text-align: center;
        padding: 0.5rem 0.75rem;
        border-radius: 4px;
        border: 1px solid rgba(157, 123, 255, 0.4);
        position: absolute;
        z-index: 3000;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        white-space: nowrap;
        opacity: 0;
        transition: opacity 0.3s, visibility 0.3s;
        font-size: 0.8rem;
        font-family: "EB Garamond", serif;
        pointer-events: none;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      }

      .tooltip .tooltip-text::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: rgba(10, 0, 21, 0.95) transparent transparent transparent;
      }

      .tooltip:hover .tooltip-text {
        visibility: visible;
        opacity: 1;
      }

      /* Pulse animation for important elements */
      @keyframes pulse {
        0%, 100% {
          box-shadow: 0 0 0 0 rgba(157, 123, 255, 0.4);
        }
        50% {
          box-shadow: 0 0 0 8px rgba(157, 123, 255, 0);
        }
      }

      .pulse {
        animation: pulse 2s infinite;
      }

      /* Card fade-in animation */
      @keyframes cardFadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .card-appear {
        animation: cardFadeIn 0.4s ease-out forwards;
      }

      /* Mobile touch feedback */
      @media (hover: none) and (pointer: coarse) {
        .receipt-card:active,
        .badge-card:active,
        .balance-card:active {
          transform: scale(0.98);
          transition: transform 0.1s ease;
        }

        button:active:not(:disabled) {
          transform: scale(0.95);
          transition: transform 0.1s ease;
        }

        /* Increase touch targets on mobile */
        button {
          min-height: 44px;
          min-width: 44px;
        }
      }

      /* Improve clickable element feedback */
      a, button, [onclick], .cursor-pointer {
        -webkit-tap-highlight-color: rgba(157, 123, 255, 0.2);
      }

      /* Progress bar for network activity */
      .progress-bar {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 3px;
        background: transparent;
        z-index: 10000;
        pointer-events: none;
      }

      .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #9d7bff, #6b4fb8, #9d7bff);
        background-size: 200% 100%;
        animation: progressAnimation 1.5s ease-in-out infinite;
        box-shadow: 0 0 10px rgba(157, 123, 255, 0.5);
      }

      @keyframes progressAnimation {
        0% {
          width: 0%;
          background-position: 0% 0%;
        }
        50% {
          width: 70%;
          background-position: 100% 0%;
        }
        100% {
          width: 100%;
          background-position: 200% 0%;
        }
      }

      /* Notification toast */
      .toast-container {
        position: fixed;
        top: 80px;
        right: 20px;
        z-index: 9999;
        max-width: 400px;
      }

      .toast {
        background: rgba(10, 0, 21, 0.95);
        border: 1px solid rgba(157, 123, 255, 0.5);
        border-radius: 6px;
        padding: 1rem 1.25rem;
        margin-bottom: 0.5rem;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
        animation: slideInRight 0.3s ease-out;
        backdrop-filter: blur(10px);
      }

      @keyframes slideInRight {
        from {
          opacity: 0;
          transform: translateX(100%);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      /* Improve form inputs */
      input:focus, textarea:focus, select:focus {
        border-color: #9d7bff !important;
        box-shadow: 0 0 0 3px rgba(157, 123, 255, 0.1) !important;
      }

      /* Selection styling */
      ::selection {
        background: rgba(157, 123, 255, 0.3);
        color: #e6d9ff;
      }

      ::-moz-selection {
        background: rgba(157, 123, 255, 0.3);
        color: #e6d9ff;
      }

      /* Scrollbar styling for webkit browsers */
      ::-webkit-scrollbar {
        width: 10px;
        height: 10px;
      }

      ::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.2);
      }

      ::-webkit-scrollbar-thumb {
        background: rgba(157, 123, 255, 0.3);
        border-radius: 5px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: rgba(157, 123, 255, 0.5);
      }

      /* Custom dropdown styling */
      .custom-dropdown {
        scrollbar-width: thin;
        scrollbar-color: rgba(157, 123, 255, 0.3) rgba(0, 0, 0, 0.2);
      }

      .custom-dropdown::-webkit-scrollbar {
        width: 8px;
      }

      .custom-dropdown::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.3);
      }

      .custom-dropdown::-webkit-scrollbar-thumb {
        background: rgba(157, 123, 255, 0.4);
        border-radius: 4px;
      }

      .custom-dropdown::-webkit-scrollbar-thumb:hover {
        background: rgba(157, 123, 255, 0.6);
      }

      .advanced-toggle {
        text-align: center;
        margin: 1.5rem 0;
        cursor: pointer;
        color: #9d7bff;
        font-size: 0.9rem;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        font-family: "Cinzel", serif;
      }

      .advanced-settings {
        display: none;
        border-top: 1px solid rgba(157, 123, 255, 0.2);
        padding-top: 1.5rem;
        margin-top: 1.5rem;
      }

      .advanced-settings.show {
        display: block;
      }

      .checkbox-group {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        cursor: pointer;
        padding: 0.75rem 1rem;
        border-radius: 4px;
        transition: all 0.2s ease;
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(157, 123, 255, 0.15);
        margin: 0.5rem 0;
      }

      .checkbox-group:hover {
        background: rgba(157, 123, 255, 0.08);
        border-color: rgba(157, 123, 255, 0.3);
      }

      .checkbox-group input[type="checkbox"] {
        width: 20px;
        height: 20px;
        accent-color: #9d7bff;
        cursor: pointer;
        flex-shrink: 0;
        position: relative;
      }

      /* Enhanced visual feedback for checked state */
      .checkbox-group:has(input[type="checkbox"]:checked) {
        background: rgba(157, 123, 255, 0.12);
        border-color: rgba(157, 123, 255, 0.4);
      }

      .checkbox-group:has(input[type="checkbox"]:checked):hover {
        background: rgba(157, 123, 255, 0.18);
        border-color: rgba(157, 123, 255, 0.6);
      }

      .checkbox-group span {
        color: rgba(230, 217, 255, 0.85);
        font-family: "EB Garamond", serif;
        font-size: 1rem;
        user-select: none;
        cursor: pointer;
        transition: color 0.2s ease;
      }

      .checkbox-group:hover span {
        color: #e6d9ff;
      }

      .checkbox-group:has(input[type="checkbox"]:checked) span {
        color: #e6d9ff;
        font-weight: 500;
      }

      .status-message {
        padding: 1rem 1.25rem;
        margin-top: 1rem;
        border: 1px solid rgba(157, 123, 255, 0.3);
        background: rgba(157, 123, 255, 0.1);
        text-align: center;
        font-style: italic;
        border-radius: 6px;
        animation: slideInDown 0.3s ease-out;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(157, 123, 255, 0.15);
      }

      .status-message.success {
        border-color: rgba(102, 255, 102, 0.4);
        background: rgba(102, 255, 102, 0.1);
        color: #66ff66;
      }

      .error-message {
        border-color: rgba(255, 107, 107, 0.4);
        background: rgba(255, 107, 107, 0.1);
        color: #ff6b6b;
      }

      .status-message.warning {
        border-color: rgba(255, 193, 7, 0.4);
        background: rgba(255, 193, 7, 0.1);
        color: #ffc107;
      }

      @keyframes slideInDown {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes fadeOut {
        from {
          opacity: 1;
        }
        to {
          opacity: 0;
          transform: translateY(-10px);
        }
      }

      /* Loading spinner */
      .spinner {
        display: inline-block;
        width: 14px;
        height: 14px;
        border: 2px solid rgba(157, 123, 255, 0.3);
        border-top-color: #9d7bff;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin-right: 0.5rem;
        vertical-align: middle;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      /* Loading skeleton */
      .skeleton {
        background: linear-gradient(
          90deg,
          rgba(157, 123, 255, 0.05) 0%,
          rgba(157, 123, 255, 0.15) 50%,
          rgba(157, 123, 255, 0.05) 100%
        );
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
        border-radius: 4px;
      }

      @keyframes shimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
      }

      /* HERO / LANDER */

      .hero {
        width: 100vw;
        height: 100vh;
        position: relative;
      }

      .page {
        width: 100vw;
        height: 100vh;
        position: relative;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .hero svg {
        width: 100%;
        height: 100%;
        display: block;
      }

      .scroll-indicator {
        position: absolute;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        cursor: pointer;
        z-index: 100;
      }

      .scroll-indicator svg {
        width: 40px;
        height: 60px;
        display: block;
      }

      /* Thread Connectors */
      .thread-section {
        position: relative;
        width: 100%;
        margin: 0;
        pointer-events: none;
        z-index: 1;
      }

      .thread-hero-to-intro {
        margin-top: -100px;
        margin-bottom: -100px;
      }

      .thread-intro-to-features {
        margin-top: -50px;
        margin-bottom: -50px;
      }

      .thread-between-features {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        width: 2px;
        height: 100px;
        background: linear-gradient(180deg, 
          rgba(157, 123, 255, 0.2) 0%, 
          rgba(157, 123, 255, 0.5) 50%, 
          rgba(157, 123, 255, 0.2) 100%);
      }

      /* Radial Line Continuations */
      .radial-continuation {
        position: absolute;
        top: -100px;
        left: 0;
        width: 100%;
        height: 200px;
        pointer-events: none;
        overflow: hidden;
        z-index: 0;
      }

      .radial-lines-top {
        position: absolute;
        width: 100%;
        height: 100%;
        opacity: 0.8;
      }

      .radial-lines-bottom {
        position: absolute;
        bottom: -100px;
        left: 0;
        width: 100%;
        height: 200px;
        pointer-events: none;
        z-index: 0;
      }

      .radial-lines-bottom svg {
        width: 100%;
        height: 100%;
        opacity: 0.6;
      }

      /* Intro Panel */
      .thread-connector {
        position: absolute;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 100px;
        height: 100%;
        pointer-events: none;
        z-index: 0;
        opacity: 0.8;
      }

      .thread-container {
        position: fixed;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 100px;
        height: 100vh;
        pointer-events: none;
        z-index: 0;
        overflow: visible;
      }

      .thread-svg {
        width: 100%;
        height: 300vh;
        position: absolute;
        top: 0;
        left: 0;
      }

      .main-thread {
        stroke-dasharray: 10, 5;
        animation: flowThread 10s linear infinite;
      }

      @keyframes flowThread {
        from {
          stroke-dashoffset: 0;
        }
        to {
          stroke-dashoffset: -15;
        }
      }

      @keyframes convergeNodes {
        0%, 100% {
          transform: scale(1);
        }
        50% {
          transform: scale(0.95) translateX(10px) translateY(10px);
        }
      }

      .fade-line {
        animation: fadeIn 3s ease-in-out infinite alternate;
      }

      @keyframes fadeIn {
        from {
          opacity: 0.1;
        }
        to {
          opacity: 0.5;
        }
      }

      .intro-panel {
        min-height: 100vh;
        padding: 4rem 2rem;
        position: relative;
        z-index: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        background: transparent;
      }

      .intro-content {
        max-width: 1200px;
        width: 100%;
        display: grid;
        grid-template-columns: 1fr 1.5fr;
        gap: 4rem;
        align-items: center;
      }

      .intro-art svg {
        width: 100%;
        height: auto;
        max-width: 400px;
        margin: 0 auto;
        display: block;
      }

      .converging-nodes {
        animation: subtleConverge 6s ease-in-out infinite;
        transform-origin: 200px 200px;
      }

      @keyframes subtleConverge {
        0%, 100% { 
          transform: scale(1);
        }
        50% { 
          transform: scale(0.92);
        }
      }

      .pulse-core {
        animation: pulsate 2s ease-in-out infinite;
      }

      @keyframes pulsate {
        0%, 100% { 
          r: 15;
          opacity: 1;
        }
        50% { 
          r: 20;
          opacity: 0.8;
        }
      }

      .intro-text h2 {
        font-size: 2.5rem;
        color: #e6d9ff;
        margin-bottom: 1.5rem;
        font-weight: 400;
        letter-spacing: -0.02em;
      }

      .intro-text p {
        font-size: 1.2rem;
        line-height: 1.8;
        color: rgba(230, 217, 255, 0.8);
        margin-bottom: 1.5rem;
      }

      .intro-highlight {
        color: #9d7bff !important;
        font-weight: 500;
        font-size: 1.3rem !important;
        margin-top: 2rem !important;
      }

      .scroll-hint {
        grid-column: 1 / -1;
        text-align: center;
        margin-top: 3rem;
        opacity: 0.4;
        transition: opacity 0.3s ease;
        cursor: pointer;
      }

      .scroll-hint:hover {
        opacity: 0.7;
      }

      .scroll-hint span {
        display: block;
        margin-bottom: 0.5rem;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.15em;
        color: rgba(230, 217, 255, 0.5);
      }

      .scroll-hint svg {
        color: rgba(157, 123, 255, 0.6);
        animation: subtlePulse 3s ease-in-out infinite;
      }

      @keyframes subtlePulse {
        0%, 100% { 
          transform: translateY(0);
          opacity: 0.6;
        }
        50% { 
          transform: translateY(3px);
          opacity: 0.4;
        }
      }

      @media (max-width: 768px) {
        .intro-content {
          grid-template-columns: 1fr;
          gap: 2rem;
          text-align: center;
        }

        .intro-art {
          order: -1;
        }

        .intro-text h2 {
          font-size: 2rem;
        }

        .intro-text p {
          font-size: 1.1rem;
        }

        /* Feature pages mobile layout */
        .feature-page {
          padding: 3rem 5vw;
          min-height: auto;
        }

        .feature-inner {
          flex-direction: column;
          gap: 2.5rem;
          align-items: flex-start;
        }

        .feature-left {
          max-width: 100%;
        }

        .feature-right {
          width: 100%;
          max-width: 100%;
        }

        .feature-right svg {
          width: 100%;
          height: auto;
          max-width: 420px;
        }

        .feature-title {
          font-size: 2.5rem;
        }

        .feature-copy {
          font-size: 1rem;
          line-height: 1.6;
        }

        .feature-tag {
          font-size: 0.65rem;
        }

        .feature-meta {
          font-size: 0.75rem;
        }
      }

      /* Feature pages */

      .features {
        position: relative;
        z-index: 1;
        background: transparent;
      }

      .feature-page {
        position: relative;
        min-height: 100vh;
        display: flex;
        align-items: center;
        padding: 4rem 8vw;
        border-top: 1px solid rgba(157, 123, 255, 0.18);
      }

      .feature-inner {
        display: flex;
        gap: 4rem;
        width: 100%;
        align-items: center;
        justify-content: space-between;
      }

      .feature-left {
        flex: 1.1;
        max-width: 540px;
      }

      .feature-right {
        flex: 1;
        display: flex;
        justify-content: center;
      }

      .feature-tag {
        font-family: "Cinzel", serif;
        font-size: 0.7rem;
        letter-spacing: 0.24em;
        text-transform: uppercase;
        color: rgba(230, 217, 255, 0.55);
        margin-bottom: 0.75rem;
      }

      .feature-title {
        position: relative;
        font-family: "EB Garamond", serif;
        font-style: italic;
        font-weight: 400;
        text-transform: uppercase;
        letter-spacing: 0.35em;
        font-size: clamp(2.2rem, 4vw, 3.3rem);
        color: #e6d9ff;
        margin-bottom: 1.5rem;
      }

      .feature-title::before {
        content: attr(data-word);
        position: absolute;
        inset: 0;
        color: #000000;
        transform: translate(3px, 4px);
        filter: blur(8px);
        opacity: 0.9;
        z-index: -1;
      }

      .feature-copy {
        font-size: 1.02rem;
        line-height: 1.6;
        max-width: 36rem;
        color: rgba(230, 217, 255, 0.9);
      }

      .feature-meta {
        margin-top: 1.25rem;
        font-size: 0.8rem;
        letter-spacing: 0.18em;
        text-transform: uppercase;
        color: rgba(230, 217, 255, 0.5);
      }

      .feature-art {
        width: min(360px, 70vw);
        height: auto;
      }

      .feature-art circle,
      .feature-art path,
      .feature-art line,
      .feature-art polyline,
      .feature-art polygon,
      .feature-art rect,
      .feature-art ellipse {
        vector-effect: non-scaling-stroke;
        transform-box: fill-box;
      }

      @media (max-width: 900px) {
        .feature-page {
          padding: 3rem 1.75rem;
        }

        .feature-inner {
          flex-direction: column;
          align-items: flex-start;
        }

        .feature-right {
          width: 100%;
          justify-content: flex-start;
          margin-top: 2.5rem;
        }

        .feature-art {
          width: min(320px, 90vw);
        }
      }

      /* Mobile optimization for hero text */
      @media (max-width: 768px) {
        .hero-moloch-text {
          font-size: 48px;
          letter-spacing: 12px;
        }

        .hero-majeur-text {
          font-size: 56px;
          letter-spacing: 10px;
        }

        .hero-subtitle-text {
          font-size: 16px;
          letter-spacing: 2px;
        }
      }

      @media (max-width: 600px) {
        .hero-moloch-text {
          font-size: 38px;
          letter-spacing: 8px;
        }

        .hero-majeur-text {
          font-size: 44px;
          letter-spacing: 6px;
        }

        .hero-subtitle-text {
          font-size: 14px;
          letter-spacing: 1.5px;
        }

        .feature-title {
          letter-spacing: 0.22em;
          font-size: 2rem;
        }

        .scroll-indicator {
          bottom: 20px;
        }

        .wallet-button {
          font-size: 0.65rem;
          padding: 8px 14px;
        }

        .summon-link {
          font-size: 0.8rem;
          padding: 8px 14px;
        }

        .litepaper-link {
          font-size: 0.7rem;
          padding: 7px 12px;
          bottom: 15px;
          right: 15px;
        }

        .github-link {
          font-size: 0.7rem;
          padding: 7px 12px;
          bottom: 15px;
          left: 15px;
        }

        /* Smaller feature pages for mobile */
        .feature-page {
          padding: 2.5rem 4vw;
        }

        .feature-inner {
          gap: 2rem;
        }

        .feature-title {
          font-size: 1.8rem;
          letter-spacing: 0.2em;
        }

        .feature-copy {
          font-size: 0.95rem;
          line-height: 1.5;
        }

        .feature-right svg {
          max-width: 100%;
        }

        /* Ensure SVG text is readable on mobile */
        .feature-right svg text {
          font-size: 10px !important;
        }

        .feature-right svg text[font-size="16"],
        .feature-right svg text[font-size="18"] {
          font-size: 14px !important;
        }
      }

      @media (max-width: 400px) {
        .hero-moloch-text {
          font-size: 32px;
          letter-spacing: 6px;
        }

        .hero-majeur-text {
          font-size: 38px;
          letter-spacing: 4px;
        }

        .hero-subtitle-text {
          font-size: 12px;
          letter-spacing: 1px;
        }

        .summon-link {
          font-size: 0.75rem;
          padding: 7px 12px;
        }

        .litepaper-link {
          font-size: 0.65rem;
          padding: 6px 10px;
          bottom: 12px;
          right: 12px;
        }

        .github-link {
          font-size: 0.65rem;
          padding: 6px 10px;
          bottom: 12px;
          left: 12px;
        }

        /* Extra small mobile optimizations for feature pages */
        .feature-page {
          padding: 2rem 3vw;
        }

        .feature-inner {
          gap: 1.5rem;
        }

        .feature-title {
          font-size: 1.5rem;
          letter-spacing: 0.18em;
        }

        .feature-copy {
          font-size: 0.9rem;
          line-height: 1.5;
        }

        .feature-tag {
          font-size: 0.6rem;
        }

        .feature-meta {
          font-size: 0.7rem;
        }

        /* Further reduce SVG text size for very small screens */
        .feature-right svg text {
          font-size: 8px !important;
        }

        .feature-right svg text[font-size="16"],
        .feature-right svg text[font-size="18"] {
          font-size: 12px !important;
        }

        .feature-right svg text[font-size="12"] {
          font-size: 10px !important;
        }
      }

      /* WALLET MODAL */
      .wallet-modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(8px);
        z-index: 2000;
        align-items: center;
        justify-content: center;
      }

      .wallet-modal-overlay.show {
        display: flex;
      }

      .wallet-modal {
        background: rgba(10, 0, 21, 0.95);
        border: 1px solid rgba(157, 123, 255, 0.5);
        max-width: 420px;
        width: 90%;
        padding: 2rem;
        position: relative;
        box-shadow: 0 0 40px rgba(157, 123, 255, 0.3);
        max-height: calc(var(--vh, 1vh) * 90);
        display: flex;
        flex-direction: column;
      }

      .wallet-modal-content {
        overflow-y: auto;
        overflow-x: hidden;
        flex: 1;
        padding: 0 0.5rem;
        margin: 0 -0.5rem;
      }

      .wallet-modal-content::-webkit-scrollbar {
        width: 6px;
      }

      .wallet-modal-content::-webkit-scrollbar-track {
        background: rgba(157, 123, 255, 0.1);
        border-radius: 3px;
      }

      .wallet-modal-content::-webkit-scrollbar-thumb {
        background: rgba(157, 123, 255, 0.4);
        border-radius: 3px;
      }

      .wallet-modal-content::-webkit-scrollbar-thumb:hover {
        background: rgba(157, 123, 255, 0.6);
      }

      /* Scrollbar for ragequit token list */
      #ragequitTokenList::-webkit-scrollbar {
        width: 5px;
      }

      #ragequitTokenList::-webkit-scrollbar-track {
        background: rgba(157, 123, 255, 0.05);
        border-radius: 3px;
      }

      #ragequitTokenList::-webkit-scrollbar-thumb {
        background: rgba(157, 123, 255, 0.3);
        border-radius: 3px;
      }

      #ragequitTokenList::-webkit-scrollbar-thumb:hover {
        background: rgba(157, 123, 255, 0.5);
      }

      .wallet-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      }

      .wallet-modal-title {
        font-family: "Cinzel", serif;
        font-size: 1.2rem;
        letter-spacing: 0.2em;
        color: #e6d9ff;
        text-transform: uppercase;
      }

      .wallet-modal-close {
        background: transparent;
        border: none;
        color: rgba(230, 217, 255, 0.6);
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
      }

      .wallet-modal-close:hover {
        color: #e6d9ff;
        transform: rotate(90deg);
      }

      .wallet-option {
        display: flex;
        align-items: center;
        padding: 1rem;
        margin-bottom: 0.75rem;
        background: rgba(0, 0, 0, 0.4);
        border: 1px solid rgba(157, 123, 255, 0.3);
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .wallet-option:hover {
        background: rgba(157, 123, 255, 0.15);
        border-color: #9d7bff;
        box-shadow: 0 0 15px rgba(157, 123, 255, 0.2);
      }

      .wallet-option:last-child {
        margin-bottom: 0;
      }

      .wallet-icon {
        width: 40px;
        height: 40px;
        margin-right: 1rem;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        flex-shrink: 0;
      }

      .wallet-info {
        flex: 1;
      }

      .wallet-name {
        font-family: "Cinzel", serif;
        font-size: 0.9rem;
        letter-spacing: 0.1em;
        color: #e6d9ff;
        margin-bottom: 0.25rem;
      }

      .wallet-status {
        font-family: "EB Garamond", serif;
        font-size: 0.85rem;
        color: rgba(230, 217, 255, 0.6);
        font-style: italic;
      }

      .wallet-status.installed {
        color: #9d7bff;
      }

      /* DAO GALLERY */
      .dao-gallery-section {
        min-height: 100vh;
        padding: 4rem 2rem;
        position: relative;
        z-index: 1;
        background: transparent;
        display: none;
      }

      .dao-gallery-section.show {
        display: block;
      }

      .dao-gallery-header {
        text-align: center;
        margin-bottom: 3rem;
      }

      .dao-gallery-title {
        font-family: "Cinzel", serif;
        font-size: 2rem;
        letter-spacing: 0.3em;
        color: #e6d9ff;
        text-transform: uppercase;
        margin-bottom: 0.5rem;
      }

      .dao-gallery-subtitle {
        font-family: "EB Garamond", serif;
        font-size: 1.1rem;
        color: rgba(230, 217, 255, 0.7);
        font-style: italic;
      }

      .dao-tiles {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 2rem;
        max-width: 1400px;
        margin: 0 auto;
      }

      .dao-tile {
        background: rgba(10, 0, 21, 0.6);
        border: 1px solid rgba(157, 123, 255, 0.3);
        padding: 2rem;
        cursor: pointer;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
      }

      .dao-tile:hover {
        border-color: #9d7bff;
        box-shadow: 0 0 30px rgba(157, 123, 255, 0.3);
        transform: translateY(-5px);
      }

      .dao-tile-emblem {
        position: absolute;
        top: 1rem;
        right: 1rem;
        width: 32px;
        height: 32px;
        border: 1px solid rgba(157, 123, 255, 0.2);
        border-radius: 4px;
        overflow: hidden;
        background: rgba(10, 0, 21, 0.8);
        opacity: 0.6;
        transition: all 0.3s ease;
      }

      /* Light background for URL-imported images in tiles */
      .dao-tile-emblem.url-image {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(245, 245, 250, 0.95) 100%);
        padding: 2px;
      }

      /* For all DAOs view, position emblem below member badge */
      .all-dao-tile .dao-tile-emblem {
        top: 3.5rem;
        right: 1rem;
      }

      .dao-tile:hover .dao-tile-emblem {
        opacity: 1;
        border-color: rgba(157, 123, 255, 0.4);
      }

      .dao-tile:hover .dao-tile-emblem.url-image {
        background: linear-gradient(135deg, rgba(255, 255, 255, 1) 0%, rgba(250, 250, 255, 1) 100%);
      }

      .dao-tile-emblem img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .dao-tile-emblem.url-image img {
        object-fit: contain;
        border-radius: 2px;
      }

      /* Special GIF for DAO index 0 and 1 */
      .dao-special-gif {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 80%;
        max-width: 200px;
        height: auto;
        opacity: 0.15;
        pointer-events: none;
        z-index: 1;
        transition: all 0.3s ease;
        filter: brightness(1.2) saturate(1.3);
        mix-blend-mode: screen;
      }

      .dao-tile:hover .dao-special-gif {
        opacity: 0.3;
        transform: translate(-50%, -50%) scale(1.05);
      }

      /* Special GIF in dashboard */
      .dao-dashboard-gif {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        width: 150px;
        height: auto;
        opacity: 0.25;
        pointer-events: none;
        z-index: 5;
        transition: all 0.3s ease;
        filter: brightness(1.2) saturate(1.3);
        mix-blend-mode: screen;
        border-radius: 8px;
        animation: floatGif 6s ease-in-out infinite;
      }

      @keyframes floatGif {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
      }

      .dao-dashboard-gif:hover {
        opacity: 0.5;
        transform: scale(1.1);
      }

      @media (max-width: 768px) {
        .dao-special-gif {
          width: 70%;
          max-width: 150px;
        }

        .dao-dashboard-gif {
          width: 100px;
          bottom: 1rem;
          right: 1rem;
        }
      }

      .dao-tile-name {
        font-family: "Cinzel", serif;
        font-size: 1.4rem;
        color: #e6d9ff;
        margin-bottom: 0.5rem;
        letter-spacing: 0.1em;
      }

      .dao-tile-symbol {
        font-family: "EB Garamond", serif;
        font-size: 0.9rem;
        color: rgba(230, 217, 255, 0.6);
        margin-bottom: 1rem;
        font-style: italic;
      }

      .dao-tile-stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 1px solid rgba(157, 123, 255, 0.2);
      }

      .dao-stat {
        font-family: "EB Garamond", serif;
        font-size: 0.85rem;
      }

      .dao-stat-label {
        color: rgba(230, 217, 255, 0.5);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        font-size: 0.7rem;
        margin-bottom: 0.25rem;
      }

      .dao-stat-value {
        color: #9d7bff;
        font-size: 1.1rem;
      }

      /* ALL DAOS GALLERY */
      .all-daos-section {
        min-height: 100vh;
        padding: 4rem 2rem;
        position: relative;
        z-index: 1;
        background: transparent;
        display: none;
        border-top: 1px solid rgba(157, 123, 255, 0.15);
      }

      .all-daos-section.show {
        display: block;
      }

      .all-daos-header {
        text-align: center;
        margin-bottom: 3rem;
      }

      .all-daos-title {
        font-family: "Cinzel", serif;
        font-size: 1.8rem;
        letter-spacing: 0.3em;
        color: rgba(230, 217, 255, 0.8);
        text-transform: uppercase;
        margin-bottom: 0.5rem;
      }

      .all-daos-subtitle {
        font-family: "EB Garamond", serif;
        font-size: 1rem;
        color: rgba(230, 217, 255, 0.5);
        font-style: italic;
      }

      .all-dao-tile {
        background: rgba(10, 0, 21, 0.4);
        border: 1px solid rgba(157, 123, 255, 0.2);
        padding: 2rem;
        cursor: pointer;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
        opacity: 0.9;
      }

      .all-dao-tile:hover {
        border-color: rgba(157, 123, 255, 0.5);
        box-shadow: 0 0 20px rgba(157, 123, 255, 0.2);
        transform: translateY(-3px);
        opacity: 1;
      }

      .all-dao-tile.user-member {
        background: rgba(157, 123, 255, 0.1);
        border: 1px solid rgba(157, 123, 255, 0.4);
        opacity: 1;
      }

      .all-dao-tile.user-member::before {
        content: "★ MEMBER";
        position: absolute;
        top: 1rem;
        right: 1rem;
        font-family: "Cinzel", serif;
        font-size: 0.65rem;
        letter-spacing: 0.1em;
        color: #9d7bff;
        padding: 0.25rem 0.5rem;
        border: 1px solid rgba(157, 123, 255, 0.4);
        background: rgba(157, 123, 255, 0.1);
      }

      .dao-tile-name,
      .all-dao-tile .dao-tile-name {
        font-family: "Cinzel", serif;
        font-size: 1.4rem;
        color: #e6d9ff;
        margin-bottom: 0.5rem;
        letter-spacing: 0.1em;
      }

      /* DAO DASHBOARD */
      .dao-dashboard {
        min-height: 100vh;
        padding: 4rem 2rem;
        position: relative;
        z-index: 1;
        background: transparent;
        display: none;
      }

      .dao-dashboard.show {
        display: block;
      }

      .dao-dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 3rem;
        flex-wrap: wrap;
        gap: 1rem;
      }

      .dao-dashboard-title {
        font-family: "Cinzel", serif;
        font-size: 1.8rem;
        letter-spacing: 0.2em;
        color: #e6d9ff;
        text-transform: uppercase;
        margin-bottom: 0.5rem;
      }

      .dao-etherscan-link {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        font-family: "Courier New", monospace;
        font-size: 0.85rem;
        color: rgba(157, 123, 255, 0.7);
        text-decoration: none;
        transition: all 0.3s ease;
        padding: 0.25rem 0;
      }

      .dao-etherscan-link:hover {
        color: #9d7bff;
      }

      .dao-etherscan-link svg {
        opacity: 0.7;
        transition: opacity 0.3s ease;
      }

      .dao-etherscan-link:hover svg {
        opacity: 1;
      }

      .dao-stats-bar {
        display: flex;
        gap: 1.5rem;
        margin-top: 0.75rem;
        padding: 0.75rem 0;
        border-top: 1px solid rgba(157, 123, 255, 0.15);
      }

      .dao-stat-item {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      .dao-stat-label {
        font-family: 'Cinzel', serif;
        font-size: 0.65rem;
        color: rgba(230, 217, 255, 0.5);
        text-transform: uppercase;
        letter-spacing: 0.1em;
      }

      .dao-stat-value {
        font-family: 'EB Garamond', serif;
        font-size: 1rem;
        color: #9d7bff;
        font-weight: 500;
      }

      .back-button {
        padding: 10px 20px;
        background: rgba(10, 0, 21, 0.9);
        border: 1px solid rgba(157, 123, 255, 0.3);
        color: #e6d9ff;
        font-family: "Cinzel", serif;
        font-size: 0.75rem;
        letter-spacing: 0.1em;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
      }

      .back-button:hover {
        background: rgba(157, 123, 255, 0.2);
        border-color: #9d7bff;
      }

      .dao-view-toggle {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        border-bottom: 1px solid rgba(157, 123, 255, 0.2);
      }

      .view-toggle-btn {
        padding: 0.75rem 1.5rem;
        background: transparent;
        border: none;
        border-bottom: 2px solid transparent;
        color: rgba(230, 217, 255, 0.6);
        font-family: "Cinzel", serif;
        font-size: 0.85rem;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .view-toggle-btn:hover {
        color: rgba(230, 217, 255, 0.9);
      }

      .view-toggle-btn.active {
        color: #9d7bff;
        border-bottom-color: #9d7bff;
      }

      .dao-dashboard-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        max-width: 1600px;
        margin: 0 auto;
      }

      .dao-dashboard-content.show {
        display: grid;
      }

      .dao-dashboard-content.hide {
        display: none;
      }

      .dao-membership-content {
        display: none;
        max-width: 1200px;
        margin: 0 auto;
      }

      .dao-membership-content.show {
        display: block;
      }

      @media (max-width: 1024px) {
        .dao-dashboard-content {
          grid-template-columns: 1fr;
        }
      }

      /* MEMBERSHIP DASHBOARD */
      .membership-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
      }

      @media (max-width: 768px) {
        .membership-grid {
          grid-template-columns: 1fr;
          gap: 1.5rem;
        }

        .badge-card,
        .balance-card {
          padding: 1.5rem 1rem;
        }

        .badge-image {
          max-width: 200px;
        }

        .badge-card a,
        .badge-card button {
          font-size: 0.8rem;
          padding: 0.4rem 0.75rem !important;
        }

        .balance-value {
          font-size: 1.5rem;
        }

        .balance-label {
          font-size: 0.7rem;
          display: flex;
          align-items: center;
          flex-wrap: wrap;
        }

        .balance-item {
          margin-bottom: 1.25rem;
          padding-bottom: 1.25rem;
        }

        .receipts-panel {
          padding: 1.5rem 1rem;
        }

        .receipts-grid {
          grid-template-columns: 1fr;
          gap: 1rem;
        }

        .receipt-card {
          padding: 1rem;
        }

        .receipt-image {
          height: 120px;
        }

        .dao-panel-title {
          font-size: 0.9rem;
          letter-spacing: 0.1em;
        }
      }

      @media (max-width: 480px) {
        .membership-grid {
          gap: 1rem;
        }

        .badge-card,
        .balance-card,
        .receipts-panel {
          padding: 1rem 0.75rem;
        }

        .balance-value {
          font-size: 1.25rem;
        }

        .balance-label {
          font-size: 0.65rem;
        }

        .balance-item {
          margin-bottom: 1rem;
          padding-bottom: 1rem;
        }

        .badge-image {
          max-width: 150px;
        }

        .badge-card a,
        .badge-card button {
          font-size: 0.7rem;
          padding: 0.35rem 0.6rem !important;
        }

        .dao-panel-title {
          font-size: 0.8rem;
        }

        .receipt-card {
          padding: 0.75rem;
        }

        .receipt-image {
          height: 100px;
        }

        .receipt-name {
          font-size: 0.75rem;
        }

        .receipt-proposal {
          font-size: 0.65rem;
        }

        .receipt-vote {
          font-size: 0.8rem;
        }

        .receipt-amount {
          font-size: 0.95rem;
        }

        .view-toggle-btn {
          padding: 0.5rem 0.65rem;
          font-size: 0.65rem;
          flex: 1;
        }

        .dao-view-toggle {
          gap: 0.25rem;
        }

        .dao-tile-emblem {
          width: 24px;
          height: 24px;
          top: 0.75rem;
          right: 0.75rem;
        }

        .all-dao-tile .dao-tile-emblem {
          top: 3rem;
          right: 0.75rem;
        }
      }

      @media (max-width: 360px) {
        .view-toggle-btn {
          padding: 0.4rem 0.5rem;
          font-size: 0.6rem;
        }

        .dao-view-toggle {
          gap: 0.15rem;
        }
      }

      .badge-card {
        background: rgba(10, 0, 21, 0.6);
        border: 1px solid rgba(157, 123, 255, 0.3);
        padding: 2rem;
        backdrop-filter: blur(10px);
        text-align: center;
        border-radius: 6px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }

      .badge-card:hover {
        border-color: rgba(157, 123, 255, 0.5);
        box-shadow: 0 4px 16px rgba(157, 123, 255, 0.15);
      }

      .badge-image {
        width: 100%;
        max-width: 300px;
        height: auto;
        margin: 1rem auto;
        border: 1px solid rgba(157, 123, 255, 0.3);
        border-radius: 8px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .badge-card .badge-image:hover {
        transform: scale(1.03);
        border-color: #9d7bff;
        box-shadow: 0 4px 20px rgba(157, 123, 255, 0.3);
      }

      .balance-card {
        background: rgba(10, 0, 21, 0.6);
        border: 1px solid rgba(157, 123, 255, 0.3);
        padding: 2rem;
        backdrop-filter: blur(10px);
        border-radius: 6px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }

      .balance-card:hover {
        border-color: rgba(157, 123, 255, 0.5);
        box-shadow: 0 4px 16px rgba(157, 123, 255, 0.15);
      }

      .balance-item {
        margin-bottom: 1.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid rgba(157, 123, 255, 0.15);
      }

      .balance-item:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
      }

      .balance-label {
        font-family: "Cinzel", serif;
        font-size: 0.75rem;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: rgba(230, 217, 255, 0.6);
        margin-bottom: 0.5rem;
      }

      .balance-value {
        font-family: "EB Garamond", serif;
        font-size: 2rem;
        color: #9d7bff;
        font-weight: 500;
      }

      .receipts-panel {
        background: rgba(10, 0, 21, 0.6);
        border: 1px solid rgba(157, 123, 255, 0.3);
        padding: 2rem;
        backdrop-filter: blur(10px);
      }

      .receipts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 1rem;
        margin-top: 1.5rem;
      }

      .receipt-card {
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(157, 123, 255, 0.2);
        padding: 1.25rem;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        border-radius: 6px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }

      .receipt-card:hover {
        border-color: rgba(157, 123, 255, 0.5);
        background: rgba(157, 123, 255, 0.08);
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(157, 123, 255, 0.2);
      }

      .receipt-card:active {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(157, 123, 255, 0.15);
      }

      .receipt-image {
        width: 100%;
        height: 150px;
        object-fit: contain;
        margin-bottom: 1rem;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 4px;
      }

      .receipt-proposal {
        font-family: "Cinzel", serif;
        font-size: 0.7rem;
        letter-spacing: 0.1em;
        color: #9d7bff;
        margin-bottom: 0.5rem;
      }

      .receipt-vote {
        font-family: "EB Garamond", serif;
        font-size: 0.9rem;
        color: rgba(230, 217, 255, 0.8);
        margin-bottom: 0.5rem;
      }

      .receipt-amount {
        font-family: "EB Garamond", serif;
        font-size: 1.1rem;
        color: #e6d9ff;
        font-weight: 500;
      }

      .receipt-name {
        font-family: "Cinzel", serif;
        font-size: 0.85rem;
        color: #9d7bff;
        margin-bottom: 0.5rem;
        font-weight: 500;
      }

      .dao-panel {
        background: rgba(10, 0, 21, 0.6);
        border: 1px solid rgba(157, 123, 255, 0.3);
        padding: 2rem;
        backdrop-filter: blur(10px);
        /* Performance: CSS containment for better rendering */
        contain: layout style paint;
      }

      .dao-panel-title {
        font-family: "Cinzel", serif;
        font-size: 1.2rem;
        letter-spacing: 0.15em;
        color: #e6d9ff;
        margin-bottom: 1.5rem;
        text-transform: uppercase;
        padding-bottom: 1rem;
        border-bottom: 1px solid rgba(157, 123, 255, 0.2);
      }

      /* CHATROOM */
      .chatroom-messages {
        max-height: 400px;
        overflow-y: auto;
        margin-bottom: 1.5rem;
        padding-right: 0.5rem;
      }

      .chatroom-messages::-webkit-scrollbar {
        width: 6px;
      }

      .chatroom-messages::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.3);
      }

      .chatroom-messages::-webkit-scrollbar-thumb {
        background: rgba(157, 123, 255, 0.4);
        border-radius: 3px;
      }

      .chatroom-message {
        margin-bottom: 1rem;
        padding: 1rem;
        background: rgba(0, 0, 0, 0.3);
        border-left: 2px solid rgba(157, 123, 255, 0.3);
      }

      .chatroom-message.proposal {
        border-left-color: #9d7bff;
        background: rgba(157, 123, 255, 0.1);
      }

      .chatroom-message-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
        font-size: 0.75rem;
        color: rgba(230, 217, 255, 0.5);
      }

      .chatroom-message-text {
        font-family: "EB Garamond", serif;
        font-size: 1rem;
        line-height: 1.6;
        color: rgba(230, 217, 255, 0.9);
      }

      .chatroom-send {
        display: flex;
        gap: 1rem;
      }

      .chatroom-input {
        flex: 1;
        padding: 10px 14px;
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid rgba(157, 123, 255, 0.3);
        color: #e6d9ff;
        font-family: "EB Garamond", serif;
        font-size: 1rem;
        transition: all 0.3s ease;
      }

      .chatroom-input:focus {
        outline: none;
        border-color: #9d7bff;
        box-shadow: 0 0 10px rgba(157, 123, 255, 0.2);
      }

      .chatroom-button {
        padding: 10px 20px;
        background: linear-gradient(135deg, #9d7bff 0%, #6b4fb8 100%);
        border: none;
        color: #000;
        font-family: "Cinzel", serif;
        font-size: 0.75rem;
        letter-spacing: 0.15em;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        font-weight: 600;
      }

      .chatroom-button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(157, 123, 255, 0.4);
      }

      .chatroom-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* TREASURY */
      .treasury-section {
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 1px solid rgba(157, 123, 255, 0.2);
      }

      .treasury-title {
        font-family: "Cinzel", serif;
        font-size: 1rem;
        letter-spacing: 0.15em;
        color: #e6d9ff;
        margin-bottom: 1rem;
        text-transform: uppercase;
      }

      .deposit-button {
        background: rgba(157, 123, 255, 0.2);
        border: 1px solid rgba(157, 123, 255, 0.4);
        border-radius: 4px;
        color: #9d7bff;
        cursor: pointer;
        padding: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
      }

      .deposit-button:hover {
        background: rgba(157, 123, 255, 0.35);
        border-color: #9d7bff;
        transform: scale(1.05);
      }

      .treasury-assets {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 0.75rem;
        margin-bottom: 1.5rem;
      }

      .treasury-asset {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 1rem 0.5rem;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(157, 123, 255, 0.2);
        transition: all 0.3s ease;
      }

      .treasury-asset:hover {
        border-color: rgba(157, 123, 255, 0.4);
        background: rgba(0, 0, 0, 0.4);
      }

      .treasury-asset-icon {
        width: 32px;
        height: 32px;
        margin-bottom: 0.5rem;
      }

      .treasury-asset-symbol {
        font-family: "Cinzel", serif;
        font-size: 0.75rem;
        letter-spacing: 0.1em;
        color: #9d7bff;
        margin-bottom: 0.25rem;
        text-transform: uppercase;
      }

      .treasury-asset-balance {
        font-family: "EB Garamond", serif;
        font-size: 0.9rem;
        color: rgba(230, 217, 255, 0.9);
      }

      .ragequit-button {
        width: 100%;
        padding: 12px 20px;
        background: rgba(255, 0, 0, 0.15);
        border: 1px solid rgba(255, 0, 0, 0.3);
        color: #ff6b6b;
        font-family: "Cinzel", serif;
        font-size: 0.75rem;
        letter-spacing: 0.15em;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        font-weight: 600;
      }

      .ragequit-button:hover {
        background: rgba(255, 0, 0, 0.25);
        border-color: #ff6b6b;
      }

      /* PROPOSALS */
      #proposalsList {
        max-height: 600px;
        overflow-y: auto;
        padding-right: 0.5rem;
      }

      #proposalsList::-webkit-scrollbar {
        width: 6px;
      }

      #proposalsList::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.3);
      }

      #proposalsList::-webkit-scrollbar-thumb {
        background: rgba(157, 123, 255, 0.4);
        border-radius: 3px;
      }

      .proposal-item {
        margin-bottom: 1.5rem;
        padding: 1.5rem;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(157, 123, 255, 0.3);
      }

      .proposal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      .proposal-id {
        font-family: "Cinzel", serif;
        font-size: 0.85rem;
        color: #9d7bff;
        letter-spacing: 0.1em;
      }

      .proposal-id button.copied {
        animation: copyPulse 0.3s ease-out;
      }

      @keyframes copyPulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); }
      }

      .proposal-state {
        padding: 3px 10px;
        background: rgba(157, 123, 255, 0.08);
        border: 1px solid rgba(157, 123, 255, 0.2);
        font-family: "Cinzel", serif;
        font-size: 0.6rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        opacity: 0.75;
        color: rgba(230, 217, 255, 0.7);
      }

      .proposal-state.succeeded {
        background: rgba(0, 255, 0, 0.05);
        border-color: rgba(0, 255, 0, 0.25);
        color: rgba(95, 255, 95, 0.85);
      }

      .proposal-state.defeated {
        background: rgba(255, 0, 0, 0.05);
        border-color: rgba(255, 0, 0, 0.25);
        color: rgba(255, 107, 107, 0.85);
      }

      .proposal-description {
        font-family: "EB Garamond", serif;
        font-size: 1rem;
        line-height: 1.6;
        color: rgba(230, 217, 255, 0.9);
        margin-bottom: 1rem;
      }

      .proposal-votes {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-bottom: 1rem;
      }

      .proposal-vote-stat {
        text-align: center;
        padding: 0.75rem;
        background: rgba(0, 0, 0, 0.3);
      }

      .proposal-vote-label {
        font-family: "Cinzel", serif;
        font-size: 0.65rem;
        letter-spacing: 0.1em;
        color: rgba(230, 217, 255, 0.5);
        text-transform: uppercase;
        margin-bottom: 0.25rem;
      }

      .proposal-vote-value {
        font-family: "EB Garamond", serif;
        font-size: 1.1rem;
        color: #9d7bff;
      }

      .proposal-actions {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
      }

      .proposal-button {
        padding: 8px 16px;
        background: rgba(157, 123, 255, 0.2);
        border: 1px solid rgba(157, 123, 255, 0.4);
        color: #e6d9ff;
        font-family: "Cinzel", serif;
        font-size: 0.7rem;
        letter-spacing: 0.1em;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
      }

      .proposal-button:hover:not(:disabled) {
        background: rgba(157, 123, 255, 0.3);
        border-color: #9d7bff;
      }

      .proposal-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .proposal-button.for {
        background: rgba(0, 255, 0, 0.1);
        border-color: rgba(0, 255, 0, 0.3);
      }

      .proposal-button.against {
        background: rgba(255, 0, 0, 0.1);
        border-color: rgba(255, 0, 0, 0.3);
      }

      .proposal-button.cancel {
        background: rgba(255, 165, 0, 0.1);
        border-color: rgba(255, 165, 0, 0.3);
        color: #ffb366;
      }

      .proposal-button.cancel:hover:not(:disabled) {
        background: rgba(255, 165, 0, 0.2);
        border-color: #ffb366;
      }

      .user-vote-indicator {
        display: inline-flex;
        align-items: center;
        padding: 8px 16px;
        font-family: "EB Garamond", serif;
        font-size: 0.9rem;
        color: rgba(230, 217, 255, 0.8);
        background: rgba(157, 123, 255, 0.05);
        border: 1px solid rgba(157, 123, 255, 0.2);
        margin-right: 0.5rem;
      }

      .user-vote-indicator strong {
        color: #9d7bff;
        margin-left: 0.3rem;
      }

      .futarchy-reward-box {
        margin-top: 1rem;
        padding: 1rem;
        background: rgba(157, 123, 255, 0.05);
        border: 1px solid rgba(157, 123, 255, 0.2);
        border-left: 3px solid #9d7bff;
      }

      .futarchy-reward-title {
        font-family: "Cinzel", serif;
        font-size: 0.75rem;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: #9d7bff;
        margin-bottom: 0.5rem;
      }

      .futarchy-reward-info {
        font-family: "EB Garamond", serif;
        font-size: 0.9rem;
        color: rgba(230, 217, 255, 0.8);
        margin-bottom: 0.75rem;
      }

      .futarchy-reward-info strong {
        color: #9d7bff;
      }

      .proposal-button.claim {
        background: rgba(157, 123, 255, 0.15);
        border-color: rgba(157, 123, 255, 0.4);
        color: #9d7bff;
      }

      .proposal-button.claim:hover:not(:disabled) {
        background: rgba(157, 123, 255, 0.25);
        border-color: #9d7bff;
      }

      .proposal-form {
        padding: 1.5rem;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(157, 123, 255, 0.3);
        margin-bottom: 1.5rem;
      }

      .proposal-form-title {
        font-family: "Cinzel", serif;
        font-size: 1rem;
        letter-spacing: 0.1em;
        color: #e6d9ff;
        margin-bottom: 1rem;
        text-transform: uppercase;
      }

      .proposal-form-group {
        margin-bottom: 1rem;
      }

      .proposal-form-label {
        display: block;
        font-family: "Cinzel", serif;
        font-size: 0.7rem;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: rgba(230, 217, 255, 0.8);
        margin-bottom: 0.5rem;
      }

      .proposal-form-input {
        width: 100%;
        padding: 10px 14px;
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid rgba(157, 123, 255, 0.3);
        color: #e6d9ff;
        font-family: "EB Garamond", serif;
        font-size: 1rem;
        transition: all 0.3s ease;
      }

      .proposal-form-input:focus {
        outline: none;
        border-color: #9d7bff;
        box-shadow: 0 0 10px rgba(157, 123, 255, 0.2);
      }

      .proposal-form-textarea {
        min-height: 80px;
        resize: vertical;
      }

      /* MOBILE OPTIMIZATIONS FOR DAO DASHBOARD */
      @media (max-width: 768px) {
        .dao-dashboard {
          padding: 2rem 1rem;
        }

        .dao-dashboard-header {
          flex-direction: column;
          align-items: flex-start;
          margin-bottom: 2rem;
        }

        .dao-dashboard-header > div:first-child {
          width: 100%;
        }

        .dao-dashboard-title {
          font-size: 1.3rem;
          letter-spacing: 0.15em;
        }

        .dao-etherscan-link {
          font-size: 0.75rem;
        }

        .dao-stats-bar {
          flex-wrap: wrap;
          gap: 1rem;
        }

        .dao-stat-label {
          font-size: 0.6rem;
        }

        .dao-stat-value {
          font-size: 0.9rem;
        }

        .back-button {
          width: 100%;
          text-align: center;
        }

        .dao-view-toggle {
          gap: 0.5rem;
          margin-bottom: 1.5rem;
        }

        .view-toggle-btn {
          padding: 0.6rem 1rem;
          font-size: 0.75rem;
          letter-spacing: 0.08em;
        }

        .dao-panel {
          padding: 1.5rem 1rem;
        }

        .dao-panel-title {
          font-size: 1rem;
          margin-bottom: 1rem;
        }

        /* Chatroom mobile */
        .chatroom-messages {
          max-height: 300px;
        }

        .chatroom-message {
          padding: 0.75rem;
        }

        /* Proposals mobile */
        #proposalsList {
          max-height: 400px;
        }

        .chatroom-message-header {
          flex-direction: column;
          gap: 0.25rem;
        }

        .chatroom-send {
          flex-direction: column;
          gap: 0.75rem;
        }

        .chatroom-button {
          width: 100%;
        }

        /* Proposals mobile */
        .proposal-item {
          padding: 1rem;
        }

        .proposal-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 0.5rem;
        }

        .proposal-id {
          font-size: 0.75rem;
          word-break: break-all;
        }

        .proposal-id button {
          padding: 0.2rem !important;
        }

        .proposal-id button svg {
          width: 11px !important;
          height: 11px !important;
        }

        .proposal-votes {
          grid-template-columns: 1fr;
          gap: 0.5rem;
        }

        .proposal-vote-stat {
          display: flex;
          justify-content: space-between;
          align-items: center;
          text-align: left;
          padding: 0.5rem 0.5rem 0.5rem 0.75rem;
          background: transparent;
          border-left: 2px solid rgba(157, 123, 255, 0.3);
        }

        .proposal-vote-label {
          margin-bottom: 0;
        }

        .proposal-vote-value {
          font-weight: 600;
        }

        .proposal-actions {
          flex-direction: column;
          gap: 0.5rem;
        }

        .proposal-button {
          width: 100%;
          padding: 12px;
        }

        .user-vote-indicator {
          width: 100%;
          justify-content: center;
          margin-right: 0;
          margin-bottom: 0.5rem;
          font-size: 0.85rem;
        }

        /* Proposal form mobile */
        .proposal-form {
          padding: 1rem;
        }

        .proposal-form-title {
          font-size: 0.9rem;
        }

        .proposal-form-group {
          margin-bottom: 0.75rem;
        }

        .proposal-form-input,
        .proposal-form-textarea {
          font-size: 0.95rem;
        }
      }

      @media (max-width: 600px) {
        .dao-dashboard {
          padding: 2rem 1rem;
        }

        .dao-dashboard-header {
          margin-bottom: 2rem;
          gap: 0.75rem;
        }

        .dao-dashboard-title {
          font-size: 1.3rem;
          letter-spacing: 0.15em;
          width: 100%;
        }

        .dao-etherscan-link {
          font-size: 0.75rem;
          width: 100%;
        }

        .dao-stats-bar {
          gap: 1rem;
          flex-wrap: wrap;
          justify-content: space-between;
        }

        .dao-stat-item {
          min-width: calc(50% - 0.5rem);
        }

        .dao-stat-label {
          font-size: 0.6rem;
        }

        .dao-stat-value {
          font-size: 0.95rem;
        }

        .back-button {
          padding: 0.6rem 1.25rem;
          font-size: 0.7rem;
        }

        .dao-view-toggle {
          margin-bottom: 1.5rem;
          gap: 0.5rem;
          overflow-x: auto;
          scrollbar-width: none;
          -ms-overflow-style: none;
        }

        .dao-view-toggle::-webkit-scrollbar {
          display: none;
        }

        .view-toggle-btn {
          padding: 0.6rem 1rem;
          font-size: 0.75rem;
          white-space: nowrap;
          flex-shrink: 0;
        }

        .dao-dashboard-content {
          gap: 1.5rem;
        }

        .dao-panel {
          padding: 1.25rem 1rem;
        }

        .dao-panel-title {
          font-size: 0.85rem;
        }

        .dao-emblem {
          width: 40px;
          height: 40px;
        }

        /* Chatroom improvements */
        .chatroom-messages {
          max-height: 300px;
        }

        .chatroom-message {
          padding: 0.85rem;
        }

        .chatroom-input {
          padding: 0.7rem 1rem;
          font-size: 0.95rem;
        }

        .chatroom-button {
          padding: 0.7rem 1.25rem;
          font-size: 0.75rem;
        }

        /* Proposals improvements */
        #proposalsList {
          max-height: 400px;
        }

        .proposal-card {
          padding: 1.25rem 1rem;
        }

        /* Treasury improvements */
        .treasury-section {
          padding: 1.25rem 1rem;
        }

        .treasury-assets {
          grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
          gap: 0.65rem;
        }

        .treasury-asset {
          padding: 0.85rem 0.65rem;
        }

        .ragequit-button {
          padding: 0.75rem 1.5rem;
          font-size: 0.75rem;
        }

        /* Sales section */
        .sales-section {
          padding: 1.25rem 1rem;
        }

        .sale-card {
          padding: 1.25rem 1rem;
        }

        /* Governance info */
        .governance-info {
          padding: 1.25rem 1rem;
        }

        .governance-info-item {
          padding: 0.85rem;
        }

        /* Proposal form */
        .proposal-form {
          padding: 1.25rem 1rem;
        }

        .proposal-form-input,
        .proposal-form-select,
        .proposal-form-textarea {
          padding: 0.7rem 1rem;
          font-size: 0.95rem;
        }
      }

      @media (max-width: 480px) {
        .dao-dashboard {
          padding: 1.5rem 0.75rem;
        }

        .dao-dashboard-header {
          margin-bottom: 1.5rem;
        }

        .dao-dashboard-title {
          font-size: 1.1rem;
          letter-spacing: 0.12em;
        }

        .dao-etherscan-link {
          font-size: 0.7rem;
        }

        .dao-stats-bar {
          gap: 0.75rem;
        }

        .dao-stat-item {
          min-width: calc(50% - 0.4rem);
        }

        .dao-stat-label {
          font-size: 0.55rem;
        }

        .dao-stat-value {
          font-size: 0.85rem;
        }

        .view-toggle-btn {
          padding: 0.5rem 0.85rem;
          font-size: 0.7rem;
        }

        .dao-emblem {
          width: 36px;
          height: 36px;
        }

        /* Mobile optimizations for purchase modal and sales */
        .wallet-modal {
          width: 95%;
          padding: 1.25rem;
          margin: 0.5rem;
          max-height: calc(var(--vh, 1vh) * 95);
        }

        .wallet-modal-header {
          margin-bottom: 1rem;
          flex-shrink: 0;
        }

        .wallet-modal-title {
          font-size: 1rem;
        }

        .wallet-modal-close {
          width: 32px;
          height: 32px;
          font-size: 1.75rem;
        }

        /* Ragequit modal mobile optimizations */
        #ragequitModal .wallet-modal {
          max-width: 95%;
        }

        #ragequitModal .wallet-modal-content > div {
          padding: 0.75rem !important;
        }

        #ragequitModal h4 {
          font-size: 0.8rem !important;
          margin-bottom: 0.75rem !important;
        }

        #ragequitModal .grid-template-columns-2 {
          grid-template-columns: 1fr !important;
          gap: 0.75rem !important;
        }

        #ragequitModal input[type="text"] {
          padding: 0.6rem !important;
          font-size: 0.95rem !important;
        }

        #ragequitTokenList > div {
          padding: 0.6rem !important;
        }

        #ragequitTokenList input[type="checkbox"] {
          width: 18px !important;
          height: 18px !important;
          margin-right: 0.75rem !important;
        }

        #ragequitTokenList .token-icon {
          width: 24px !important;
          height: 24px !important;
          margin-right: 0.75rem !important;
        }

        #ragequitModal button {
          padding: 0.75rem !important;
          font-size: 0.7rem !important;
        }

        /* Transfer Receipt modal mobile optimizations */
        #transferReceiptModal .wallet-modal {
          max-width: 95%;
        }

        #transferReceiptModal h4 {
          font-size: 0.8rem !important;
        }

        #transferReceiptModal input[type="text"] {
          padding: 0.6rem !important;
          font-size: 0.95rem !important;
        }

        #transferReceiptModal button {
          padding: 0.75rem !important;
          font-size: 0.7rem !important;
        }

        #transferReceiptModal #transferReceiptId {
          font-size: 0.8rem !important;
        }

        #transferReceiptModal #transferProposalId {
          font-size: 0.85rem !important;
        }

        .wallet-modal input[type="number"] {
          font-size: 16px !important; /* Prevent zoom on iOS */
        }
      }

      /* Extra small screens */
      @media (max-width: 400px) {
        .wallet-modal {
          padding: 1rem;
          max-height: calc(var(--vh, 1vh) * 97);
        }

        #ragequitModal .wallet-modal-content > div {
          padding: 0.5rem !important;
        }

        #ragequitModal h4 {
          font-size: 0.75rem !important;
        }

        #ragequitModal input[type="text"] {
          font-size: 0.9rem !important;
        }

        #ragequitTokenList {
          max-height: 150px !important;
        }

        #ragequitTokenList > div {
          padding: 0.5rem !important;
        }

        #ragequitModal .grid-template-columns-2 {
          gap: 0.5rem !important;
        }

        #transferReceiptModal input[type="text"] {
          font-size: 0.9rem !important;
        }

        #transferReceiptModal h4 {
          font-size: 0.75rem !important;
        }

        #transferReceiptModal #transferReceiptId {
          font-size: 0.75rem !important;
        }

        #transferReceiptModal #transferProposalId {
          font-size: 0.8rem !important;
        }

        #purchaseModal input {
          font-size: 16px !important; /* Prevent zoom on iOS */
        }

        #purchaseModal button {
          min-height: 44px !important; /* Touch-friendly buttons */
        }

        #purchaseModal .wallet-modal-header h3 {
          font-size: 1rem !important;
        }

        #depositModal input,
        #depositModal select {
          font-size: 16px !important; /* Prevent zoom on iOS */
        }

        #salesSection {
          margin-top: 1rem !important;
        }

        .treasury-section {
          padding: 1rem 0.75rem;
        }

        .treasury-title {
          font-size: 0.9rem;
        }

        .deposit-button {
          padding: 0.4rem;
        }

        .deposit-button svg {
          width: 16px;
          height: 16px;
        }

        .dao-stat-label {
          font-size: 0.55rem;
        }

        .dao-stat-value {
          font-size: 0.85rem;
        }

        .dao-panel {
          padding: 1rem 0.75rem;
        }

        .dao-panel-title {
          font-size: 0.8rem;
          margin-bottom: 1rem;
          padding-bottom: 0.75rem;
        }

        /* Chatroom mobile */
        .chatroom-messages {
          max-height: 250px;
          padding-right: 0.25rem;
        }

        .chatroom-message {
          padding: 0.75rem;
          margin-bottom: 0.75rem;
        }

        .chatroom-message-header {
          font-size: 0.7rem;
          flex-wrap: wrap;
          gap: 0.25rem;
        }

        .chatroom-message-text {
          font-size: 0.9rem;
          line-height: 1.5;
        }

        .chatroom-input {
          padding: 0.65rem 0.85rem;
          font-size: 0.9rem;
        }

        .chatroom-button {
          padding: 0.65rem 1rem;
          font-size: 0.7rem;
        }

        /* Proposals mobile */
        #proposalsList {
          max-height: 350px;
        }

        .proposal-card {
          padding: 1rem 0.75rem;
          margin-bottom: 0.75rem;
        }

        .proposal-id {
          font-size: 0.7rem;
        }

        .proposal-state {
          font-size: 0.6rem;
          padding: 3px 8px;
          opacity: 1;
        }

        .proposal-title {
          font-size: 0.9rem;
          margin-bottom: 0.5rem;
        }

        .proposal-description {
          font-size: 0.85rem;
          line-height: 1.4;
        }

        .proposal-meta {
          font-size: 0.7rem;
          gap: 0.5rem;
        }

        /* Treasury mobile */
        .treasury-section {
          padding: 1rem 0.5rem;
          margin-top: 1.5rem;
        }

        .treasury-assets {
          grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
          gap: 0.5rem;
        }

        .treasury-asset {
          padding: 0.75rem 0.5rem;
          min-height: 100px;
        }

        .treasury-asset-icon {
          width: 28px;
          height: 28px;
        }

        .treasury-asset-symbol {
          font-size: 0.75rem;
        }

        .treasury-asset-balance {
          font-size: 0.75rem;
        }

        .ragequit-button {
          padding: 0.7rem 1.25rem;
          font-size: 0.7rem;
        }

        /* Sales section mobile */
        .sales-section {
          padding: 1rem 0.75rem;
        }

        .sale-card {
          padding: 1rem 0.75rem;
        }

        .sale-card-title {
          font-size: 0.85rem;
        }

        .sale-info-item {
          font-size: 0.8rem;
        }

        .purchase-button {
          padding: 0.65rem 1rem;
          font-size: 0.7rem;
        }

        /* Governance info mobile */
        .governance-info {
          padding: 1rem 0.75rem;
        }

        .governance-info-item {
          padding: 0.75rem;
          margin-bottom: 0.75rem;
        }

        .governance-info-label {
          font-size: 0.7rem;
        }

        .governance-info-value {
          font-size: 0.85rem;
        }

        /* Proposal form mobile */
        .proposal-form {
          padding: 1rem 0.75rem;
        }

        .proposal-form-title {
          font-size: 0.85rem;
          margin-bottom: 1rem;
        }

        .proposal-form-label {
          font-size: 0.75rem;
        }

        .proposal-form-input,
        .proposal-form-select,
        .proposal-form-textarea {
          padding: 0.65rem 0.85rem;
          font-size: 0.9rem;
        }

        .submit-proposal-button {
          padding: 0.75rem;
          font-size: 0.7rem;
        }
      }

      /* ENHANCED MOBILE OPTIMIZATIONS */
      @media (max-width: 768px) {
        /* Modal optimizations for mobile */
        .wallet-modal,
        .modal {
          width: 95%;
          max-width: 95vw;
          padding: 1.5rem 1rem;
          max-height: 85vh;
        }

        .wallet-modal-title,
        .modal-title {
          font-size: 1rem;
          letter-spacing: 0.15em;
        }

        .wallet-modal-close,
        .modal-close {
          width: 36px;
          height: 36px;
          font-size: 1.3rem;
        }

        .wallet-option {
          padding: 0.85rem;
          min-height: 60px;
        }

        .wallet-icon {
          width: 36px;
          height: 36px;
          margin-right: 0.85rem;
        }

        .wallet-name {
          font-size: 0.9rem;
        }

        .wallet-status {
          font-size: 0.7rem;
        }

        /* Smooth scrolling with momentum for all scrollable areas */
        .chatroom-messages,
        #proposalsList,
        .dao-members-list,
        .receipts-grid,
        .wallet-modal-content {
          -webkit-overflow-scrolling: touch;
          scroll-behavior: smooth;
        }

        /* Better touch targets - minimum 44px height */
        .chatroom-button,
        .proposal-button,
        .view-toggle-btn,
        .back-button,
        button {
          min-height: 44px;
          touch-action: manipulation;
        }

        /* Improve input touch targets */
        input,
        textarea,
        select {
          min-height: 44px;
          font-size: 16px; /* Prevents zoom on iOS */
        }

        /* Better address display - ensure truncation works */
        .dao-etherscan-link,
        .chatroom-message-header span,
        .proposal-meta span {
          word-break: break-all;
          overflow-wrap: break-word;
        }

        /* Improved modal sizing on mobile */
        .modal {
          max-height: 90vh;
          max-width: 95vw;
          margin: auto;
        }

        /* Better scrollbar for mobile webkit */
        .chatroom-messages::-webkit-scrollbar,
        #proposalsList::-webkit-scrollbar {
          width: 4px;
        }

        /* Ensure proper spacing for touch */
        .dao-panel {
          margin-bottom: 1.5rem;
        }

        /* Improve treasury grid responsiveness */
        .treasury-assets {
          grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        }

        /* Better spacing for stats on mobile */
        .dao-stats-bar {
          width: 100%;
        }

        /* Improve proposal actions stacking */
        .proposal-actions {
          width: 100%;
        }

        .proposal-button {
          width: 100%;
        }

        /* Better handling of long descriptions */
        .proposal-description,
        .chatroom-message-text {
          word-break: break-word;
          overflow-wrap: break-word;
          hyphens: auto;
        }

        /* Improve header stacking on mobile */
        .dao-dashboard-header > div:first-child {
          gap: 0.75rem;
        }

        /* Better emblem sizing */
        .dao-emblem {
          flex-shrink: 0;
        }

        /* Improve treasury asset readability */
        .treasury-asset-symbol {
          font-weight: 600;
        }

        .treasury-asset-balance {
          opacity: 0.9;
        }

        /* DAO Gallery mobile improvements */
        .dao-gallery-section {
          padding: 3rem 1.5rem;
        }

        .dao-gallery-title {
          font-size: 1.5rem;
          letter-spacing: 0.2em;
        }

        .dao-gallery-subtitle {
          font-size: 1rem;
        }

        .dao-tiles {
          grid-template-columns: 1fr;
          gap: 1.5rem;
        }

        .dao-tile {
          padding: 1.5rem 1.25rem;
        }

        .dao-tile-name {
          font-size: 1.1rem;
        }

        .dao-tile-stats {
          flex-wrap: wrap;
          gap: 0.75rem;
        }

        /* Forms mobile improvements */
        .form-group {
          margin-bottom: 1.25rem;
        }

        .form-label {
          font-size: 0.75rem;
          margin-bottom: 0.5rem;
        }

        .form-input,
        .form-select {
          padding: 0.75rem 1rem;
          font-size: 16px; /* Prevent zoom */
          min-height: 44px;
        }

        .members-container {
          gap: 1rem;
        }

        .member-row {
          flex-direction: column;
          gap: 0.75rem;
        }

        .member-input-group {
          width: 100%;
        }

        .add-member-btn,
        .remove-member-btn {
          width: 100%;
          min-height: 44px;
          padding: 0.65rem;
        }

        /* Improve governance param inputs */
        .governance-params {
          grid-template-columns: 1fr;
          gap: 1rem;
        }

        /* Better checkbox sizing for mobile */
        .checkbox-group {
          padding: 0.85rem 0.75rem;
          margin: 0.5rem 0;
          align-items: flex-start;
        }

        .checkbox-group input[type="checkbox"] {
          width: 24px;
          height: 24px;
          min-width: 24px;
          min-height: 24px;
          margin-top: 0.1rem;
        }

        .checkbox-group span {
          font-size: 0.95rem;
          line-height: 1.4;
          word-wrap: break-word;
          overflow-wrap: break-word;
        }

        /* More obvious checked state on mobile */
        .checkbox-group:has(input[type="checkbox"]:checked) {
          background: rgba(157, 123, 255, 0.15);
          border-color: rgba(157, 123, 255, 0.5);
        }
      }

      /* Extra small mobile improvements */
      @media (max-width: 375px) {
        /* Further reduce padding on very small screens */
        .dao-dashboard {
          padding: 1rem 0.5rem;
        }

        .dao-panel {
          padding: 1rem 0.65rem;
        }

        /* Smaller title for tiny screens */
        .dao-dashboard-title {
          font-size: 1rem;
          letter-spacing: 0.1em;
        }

        /* Better checkbox wrapping for very small screens */
        .checkbox-group span {
          font-size: 0.9rem;
          line-height: 1.3;
        }

        /* DAO Gallery tiny screen */
        .dao-gallery-section {
          padding: 2rem 1rem;
        }

        .dao-gallery-title {
          font-size: 1.2rem;
        }

        .dao-tiles {
          gap: 1.25rem;
        }

        .dao-tile {
          padding: 1.25rem 1rem;
        }

        /* Improve treasury grid for small screens */
        .treasury-assets {
          grid-template-columns: repeat(2, 1fr);
          gap: 0.5rem;
        }

        /* Stack view toggle buttons more tightly */
        .view-toggle-btn {
          padding: 0.5rem 0.85rem;
          font-size: 0.7rem;
        }

        /* Smaller chat messages */
        .chatroom-message {
          padding: 0.65rem;
        }

        .chatroom-message-text {
          font-size: 0.85rem;
        }

        /* Compact proposal cards */
        .proposal-card {
          padding: 0.85rem 0.65rem;
        }

        /* Better button sizing */
        .chatroom-button,
        .proposal-button {
          padding: 0.6rem 0.85rem;
          font-size: 0.65rem;
        }
      }

      /* Landscape mobile optimizations */
      @media (max-width: 896px) and (orientation: landscape) {
        /* Reduce vertical padding in landscape */
        .dao-dashboard {
          padding: 1.5rem 1rem;
        }

        /* Compact header in landscape */
        .dao-dashboard-header {
          margin-bottom: 1rem;
        }

        /* Shorter chat area in landscape */
        .chatroom-messages {
          max-height: 200px;
        }

        /* Shorter proposals list in landscape */
        #proposalsList {
          max-height: 250px;
        }

        /* Two-column layout for treasury in landscape */
        .treasury-assets {
          grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        }
      }

      /* Safe area insets for notched devices (iPhone X, etc.) */
      @supports (padding: max(0px)) {
        @media (max-width: 768px) {
          .dao-dashboard {
            padding-left: max(1rem, env(safe-area-inset-left));
            padding-right: max(1rem, env(safe-area-inset-right));
          }

          .dao-dashboard-header {
            padding-left: max(0, env(safe-area-inset-left));
            padding-right: max(0, env(safe-area-inset-right));
          }
        }
      }

      /* MEMBERS LIST */
      .dao-members-content {
        display: none;
      }

      .dao-members-content.show {
        display: block;
      }

      .members-panel {
        background: rgba(10, 0, 21, 0.6);
        border: 1px solid rgba(157, 123, 255, 0.3);
        padding: 2rem;
        backdrop-filter: blur(10px);
      }

      .members-header {
        margin-bottom: 1.5rem;
      }

      .members-stats {
        display: flex;
        gap: 2rem;
        margin-top: 1rem;
        padding: 1rem;
        background: rgba(157, 123, 255, 0.05);
        border: 1px solid rgba(157, 123, 255, 0.2);
        border-radius: 6px;
      }

      .members-stat {
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }

      .members-stat-label {
        font-family: 'Cinzel', serif;
        font-size: 0.75rem;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: rgba(230, 217, 255, 0.6);
      }

      .members-stat-value {
        font-family: 'EB Garamond', serif;
        font-size: 1.1rem;
        color: #9d7bff;
        font-weight: 500;
      }

      .members-list {
        max-height: 600px;
        overflow-y: auto;
        margin-top: 1.5rem;
      }

      .members-list::-webkit-scrollbar {
        width: 8px;
      }

      .members-list::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 4px;
      }

      .members-list::-webkit-scrollbar-thumb {
        background: rgba(157, 123, 255, 0.3);
        border-radius: 4px;
      }

      .members-list::-webkit-scrollbar-thumb:hover {
        background: rgba(157, 123, 255, 0.5);
      }

      .member-item {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 0.8fr 0.8fr 100px;
        gap: 1rem;
        padding: 1rem;
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(157, 123, 255, 0.15);
        margin-bottom: 0.75rem;
        transition: all 0.2s ease;
        align-items: center;
      }

      .member-item:hover {
        background: rgba(157, 123, 255, 0.05);
        border-color: rgba(157, 123, 255, 0.3);
      }

      .member-address {
        font-family: 'EB Garamond', serif;
        font-size: 0.9rem;
        color: #e6d9ff;
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      .member-ens {
        font-size: 1rem;
        color: #9d7bff;
        font-weight: 500;
      }

      .member-address-hex {
        font-size: 0.8rem;
        color: rgba(230, 217, 255, 0.6);
        font-family: 'Courier New', monospace;
      }

      .member-shares,
      .member-loot,
      .member-badge,
      .member-ownership {
        font-family: 'EB Garamond', serif;
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      .member-label {
        font-size: 0.65rem;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: rgba(230, 217, 255, 0.5);
      }

      .member-value {
        font-size: 0.95rem;
        color: #e6d9ff;
      }

      .member-link {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.5rem;
        background: rgba(157, 123, 255, 0.1);
        border: 1px solid rgba(157, 123, 255, 0.3);
        border-radius: 4px;
        color: #9d7bff;
        text-decoration: none;
        transition: all 0.2s ease;
      }

      .member-link:hover {
        background: rgba(157, 123, 255, 0.2);
        border-color: #9d7bff;
      }

      .member-link svg {
        width: 16px;
        height: 16px;
      }

      @media (max-width: 768px) {
        .members-stats {
          flex-direction: column;
          gap: 0.75rem;
        }

        .member-item {
          grid-template-columns: 1fr;
          gap: 0.75rem;
        }

        .member-address,
        .member-shares,
        .member-loot,
        .member-badge,
        .member-ownership {
          padding-bottom: 0.5rem;
          border-bottom: 1px solid rgba(157, 123, 255, 0.1);
        }

        .member-link {
          width: 100%;
        }
      }

      @media (max-width: 480px) {
        .members-panel {
          padding: 1rem 0.75rem;
        }

        .members-list {
          max-height: 400px;
        }

        .member-item {
          padding: 0.75rem;
        }
      }

      /* DAO EMBLEM */
      .dao-emblem {
        width: 48px;
        height: 48px;
        cursor: pointer;
        border: 1px solid rgba(157, 123, 255, 0.3);
        border-radius: 6px;
        overflow: hidden;
        transition: all 0.3s ease;
        background: rgba(10, 0, 21, 0.6);
        backdrop-filter: blur(5px);
        flex-shrink: 0;
      }

      /* Light background for URL-imported images */
      .dao-emblem.url-image {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(245, 245, 250, 0.95) 100%);
        padding: 3px;
      }

      .dao-emblem:hover {
        border-color: #9d7bff;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(157, 123, 255, 0.2);
      }

      .dao-emblem.url-image:hover {
        background: linear-gradient(135deg, rgba(255, 255, 255, 1) 0%, rgba(250, 250, 255, 1) 100%);
        box-shadow: 0 4px 12px rgba(157, 123, 255, 0.3);
      }

      .dao-emblem img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .dao-emblem.url-image img {
        object-fit: contain;
        border-radius: 3px;
      }

      /* NFT MODAL */
      .nft-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(10px);
        z-index: 10000;
        overflow-y: auto;
        padding: 2rem;
      }

      .nft-modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .nft-modal-content {
        background: rgba(10, 0, 21, 0.95);
        border: 1px solid rgba(157, 123, 255, 0.4);
        border-radius: 12px;
        padding: 2rem;
        max-width: 600px;
        width: 100%;
        position: relative;
        animation: modalSlideIn 0.3s ease;
      }

      @keyframes modalSlideIn {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .nft-modal-close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: rgba(157, 123, 255, 0.1);
        border: 1px solid rgba(157, 123, 255, 0.3);
        color: #e6d9ff;
        font-size: 1.5rem;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        line-height: 1;
      }

      .nft-modal-close:hover {
        background: rgba(157, 123, 255, 0.2);
        border-color: #9d7bff;
      }

      .nft-modal-body {
        text-align: center;
      }

      .nft-modal-image {
        width: 100%;
        max-width: 500px;
        height: auto;
        border-radius: 8px;
        border: 1px solid rgba(157, 123, 255, 0.3);
        margin-bottom: 1.5rem;
      }

      /* Light background for URL-imported images in modal */
      .nft-modal-image.url-image {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(245, 245, 250, 0.95) 100%);
        padding: 1rem;
        object-fit: contain;
      }

      .nft-modal-title {
        font-family: 'Cinzel', serif;
        font-size: 1.5rem;
        color: #9d7bff;
        margin-bottom: 1rem;
        letter-spacing: 0.1em;
      }

      .nft-modal-description {
        font-family: 'EB Garamond', serif;
        font-size: 1rem;
        color: rgba(230, 217, 255, 0.8);
        line-height: 1.6;
        margin-bottom: 1.5rem;
      }

      .nft-modal-attributes {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 0.75rem;
        margin-top: 1.5rem;
      }

      .nft-modal-attribute {
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(157, 123, 255, 0.2);
        padding: 0.75rem;
        border-radius: 6px;
      }

      .nft-modal-attribute-label {
        font-family: 'Cinzel', serif;
        font-size: 0.65rem;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: rgba(230, 217, 255, 0.6);
        margin-bottom: 0.25rem;
      }

      .nft-modal-attribute-value {
        font-family: 'EB Garamond', serif;
        font-size: 1rem;
        color: #e6d9ff;
      }

      @media (max-width: 768px) {
        .nft-modal {
          padding: 1rem;
        }

        .nft-modal-content {
          padding: 1.5rem;
          max-width: 100%;
        }

        .nft-modal-title {
          font-size: 1.2rem;
        }

        .nft-modal-description {
          font-size: 0.9rem;
        }

        .dao-emblem {
          width: 40px;
          height: 40px;
        }
      }

      @media (max-width: 480px) {
        .nft-modal {
          padding: 0.5rem;
        }

        .nft-modal-content {
          padding: 1rem;
        }

        .nft-modal-title {
          font-size: 1rem;
        }

        .nft-modal-close {
          width: 35px;
          height: 35px;
          font-size: 1.2rem;
        }

        .dao-emblem {
          width: 36px;
          height: 36px;
        }

        .nft-modal-attributes {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <!-- Progress Bar -->
    <div class="progress-bar" id="progressBar" style="display: none;">
      <div class="progress-bar-fill"></div>
    </div>

    <!-- Toast Notifications -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Starry Background -->
    <div class="starry-bg">
      <div class="stars-layer"></div>
    </div>

    <!-- Summon Link Button (top left) -->
    <button class="summon-link" onclick="document.getElementById('summoner').scrollIntoView({ behavior: 'smooth' });">
      Summon
    </button>

    <!-- Wallet Connect Button (top right) -->
    <button class="wallet-button" id="walletBtn" onclick="connectWallet()">
      CONNECT WALLET
    </button>

    <!-- Lite Paper Link (bottom right) -->
    <a href="https://wp.majeurdao.eth.limo" target="_blank" rel="noopener noreferrer" class="litepaper-link" title="Read the Majeur lite paper">
      Lite Paper
    </a>

    <!-- GitHub Link (bottom left) -->
    <a href="https://github.com/z0r0z/majeur" target="_blank" rel="noopener noreferrer" class="github-link" title="View on GitHub">
      GitHub
    </a>

    <!-- Wallet Selection Modal -->
    <div class="wallet-modal-overlay" id="walletModal">
      <div class="wallet-modal">
        <div class="wallet-modal-header">
          <h2 class="wallet-modal-title">Connect Wallet</h2>
          <button class="wallet-modal-close" onclick="closeWalletModal()">&times;</button>
        </div>
        <div id="walletOptions">
          <!-- Wallet options will be dynamically inserted here -->
        </div>
      </div>
    </div>

    <!-- TRANSFER RECEIPT MODAL -->
    <div class="wallet-modal-overlay" id="transferReceiptModal">
      <div class="wallet-modal" style="max-width: 480px;">
        <div class="wallet-modal-header">
          <h2 class="wallet-modal-title">Transfer Receipt</h2>
          <button class="wallet-modal-close" onclick="closeTransferReceiptModal()">&times;</button>
        </div>
        <div class="wallet-modal-content">
          <div style="padding: 1rem;">
            <!-- Receipt Info -->
            <div style="margin-bottom: 1.5rem; padding: 0.75rem; background: rgba(157, 123, 255, 0.1); border: 1px solid rgba(157, 123, 255, 0.3); border-radius: 4px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <div style="font-size: 0.7rem; color: rgba(230, 217, 255, 0.6);">RECEIPT ID (uint256)</div>
                <button onclick="copyReceiptId()" id="copyReceiptBtn"
                        style="padding: 0.3rem 0.6rem; background: rgba(157, 123, 255, 0.2); border: 1px solid rgba(157, 123, 255, 0.3); color: #9d7bff; font-family: 'Cinzel', serif; font-size: 0.6rem; letter-spacing: 0.1em; cursor: pointer; text-transform: uppercase; border-radius: 3px; transition: all 0.2s ease;"
                        onmouseover="this.style.background='rgba(157, 123, 255, 0.3)'"
                        onmouseout="this.style.background='rgba(157, 123, 255, 0.2)'">
                  Copy
                </button>
              </div>
              <div style="position: relative;">
                <div id="transferReceiptId" data-full-id="" style="font-size: 0.85rem; color: #e6d9ff; font-family: monospace; cursor: pointer; user-select: all;" title="Click to view full ID"></div>
                <div style="font-size: 0.65rem; color: rgba(230, 217, 255, 0.4); margin-top: 0.25rem;">Click ID or Copy button to get full value</div>
              </div>
            </div>

            <div style="margin-bottom: 1.5rem;">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                <div style="padding: 0.75rem; background: rgba(157, 123, 255, 0.1); border: 1px solid rgba(157, 123, 255, 0.3); border-radius: 4px;">
                  <div style="font-size: 0.7rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.35rem;">PROPOSAL</div>
                  <div id="transferProposalId" data-full-id="" style="font-size: 0.9rem; color: #e6d9ff; font-weight: 600; font-family: monospace; cursor: pointer; user-select: all;" title="Click to toggle full ID"></div>
                </div>
                <div style="padding: 0.75rem; background: rgba(157, 123, 255, 0.1); border: 1px solid rgba(157, 123, 255, 0.3); border-radius: 4px;">
                  <div style="font-size: 0.7rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.35rem;">AVAILABLE</div>
                  <div id="transferAvailableAmount" style="font-size: 0.85rem; color: #e6d9ff; font-weight: 600;"></div>
                </div>
              </div>
            </div>

            <!-- Transfer Details -->
            <div style="margin-bottom: 1.5rem;">
              <h4 style="font-family: 'Cinzel', serif; font-size: 0.85rem; color: #9d7bff; margin-bottom: 0.75rem; letter-spacing: 0.1em;">TRANSFER DETAILS</h4>

              <div style="margin-bottom: 0.75rem;">
                <label style="display: block; font-size: 0.7rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.4rem;">Recipient Address or ENS</label>
                <input type="text" id="transferRecipient" placeholder="0x... or vitalik.eth"
                       style="width: 100%; padding: 0.7rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 0.9rem; border-radius: 4px;">
              </div>

              <div style="margin-bottom: 0.75rem;">
                <label style="display: block; font-size: 0.7rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.4rem;">Amount to Transfer</label>
                <input type="text" id="transferAmount" placeholder="0.0" inputmode="decimal"
                       style="width: 100%; padding: 0.7rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 0.9rem; border-radius: 4px;">
                <div style="font-size: 0.65rem; color: rgba(230, 217, 255, 0.5); margin-top: 0.35rem;">
                  Click <span onclick="setTransferMaxAmount()" style="color: #9d7bff; cursor: pointer; text-decoration: underline;">here</span> to transfer all
                </div>
              </div>
            </div>

            <!-- Action Buttons -->
            <div style="display: flex; gap: 0.75rem; padding-top: 0.5rem; border-top: 1px solid rgba(157, 123, 255, 0.2);">
              <button onclick="closeTransferReceiptModal()"
                      style="flex: 1; padding: 0.85rem; background: rgba(157, 123, 255, 0.1); border: 1px solid rgba(157, 123, 255, 0.3); color: #9d7bff; font-family: 'Cinzel', serif; font-size: 0.7rem; letter-spacing: 0.15em; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; border-radius: 4px;"
                      onmouseover="this.style.background='rgba(157, 123, 255, 0.15)'"
                      onmouseout="this.style.background='rgba(157, 123, 255, 0.1)'">
                Cancel
              </button>
              <button onclick="executeReceiptTransfer()"
                      style="flex: 1; padding: 0.85rem; background: rgba(157, 123, 255, 0.2); border: 1px solid rgba(157, 123, 255, 0.4); color: #e6d9ff; font-family: 'Cinzel', serif; font-size: 0.7rem; letter-spacing: 0.15em; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; font-weight: 600; border-radius: 4px;"
                      onmouseover="this.style.background='rgba(157, 123, 255, 0.35)'; this.style.borderColor='#9d7bff'"
                      onmouseout="this.style.background='rgba(157, 123, 255, 0.2)'; this.style.borderColor='rgba(157, 123, 255, 0.4)'">
                Transfer Receipt
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- DEPOSIT MODAL -->
    <div class="wallet-modal-overlay" id="depositModal">
      <div class="wallet-modal" style="max-width: 480px;">
        <div class="wallet-modal-header">
          <h2 class="wallet-modal-title">Deposit to Treasury</h2>
          <button class="wallet-modal-close" onclick="closeDepositModal()">&times;</button>
        </div>
        <div class="wallet-modal-content">
          <div style="padding: 1rem;">
            <!-- Asset Selection -->
            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; font-size: 0.7rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.5rem; font-family: 'Cinzel', serif; letter-spacing: 0.1em;">SELECT ASSET</label>
              <div style="position: relative;">
                <div id="depositAssetDisplay" onclick="toggleDepositAssetDropdown()"
                     style="width: 100%; padding: 0.7rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 0.9rem; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                  <span>Choose an asset...</span>
                </div>
                <div id="depositAssetDropdown" class="custom-dropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 0.25rem; background: rgba(10, 0, 21, 0.95); border: 1px solid rgba(157, 123, 255, 0.4); border-radius: 4px; max-height: 250px; overflow-y: auto; z-index: 1000; backdrop-filter: blur(10px);">
                  <!-- Dropdown options will be populated here -->
                </div>
              </div>
            </div>

            <!-- Amount Input -->
            <div style="margin-bottom: 1.5rem;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <label style="font-size: 0.7rem; color: rgba(230, 217, 255, 0.6); font-family: 'Cinzel', serif; letter-spacing: 0.1em;">AMOUNT</label>
                <div style="font-size: 0.65rem; color: rgba(230, 217, 255, 0.5);">
                  Balance: <span id="depositUserBalance">0</span>
                </div>
              </div>
              <div style="position: relative;">
                <input type="text" id="depositAmount" placeholder="0.0" inputmode="decimal"
                       style="width: 100%; padding: 0.7rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 0.9rem; border-radius: 4px;">
                <div style="font-size: 0.65rem; color: rgba(230, 217, 255, 0.5); margin-top: 0.35rem;">
                  Click <span id="depositMaxButton" onclick="setDepositMax()" style="color: #9d7bff; cursor: pointer; text-decoration: underline;">here</span> to deposit max
                </div>
              </div>
            </div>

            <!-- DAO Address Display -->
            <div style="margin-bottom: 1.5rem; padding: 0.75rem; background: rgba(157, 123, 255, 0.1); border: 1px solid rgba(157, 123, 255, 0.3); border-radius: 4px;">
              <div style="font-size: 0.7rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.35rem;">DEPOSITING TO</div>
              <div id="depositDaoAddress" style="font-size: 0.75rem; color: #e6d9ff; word-break: break-all; font-family: monospace;">-</div>
            </div>

            <!-- Action Buttons -->
            <div style="display: flex; gap: 0.75rem; padding-top: 0.5rem; border-top: 1px solid rgba(157, 123, 255, 0.2);">
              <button onclick="closeDepositModal()"
                      style="flex: 1; padding: 0.85rem; background: rgba(157, 123, 255, 0.1); border: 1px solid rgba(157, 123, 255, 0.3); color: #9d7bff; font-family: 'Cinzel', serif; font-size: 0.7rem; letter-spacing: 0.15em; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; border-radius: 4px;"
                      onmouseover="this.style.background='rgba(157, 123, 255, 0.15)'"
                      onmouseout="this.style.background='rgba(157, 123, 255, 0.1)'">
                Cancel
              </button>
              <button onclick="executeDeposit()"
                      style="flex: 1; padding: 0.85rem; background: rgba(157, 123, 255, 0.2); border: 1px solid rgba(157, 123, 255, 0.4); color: #e6d9ff; font-family: 'Cinzel', serif; font-size: 0.7rem; letter-spacing: 0.15em; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; font-weight: 600; border-radius: 4px;"
                      onmouseover="this.style.background='rgba(157, 123, 255, 0.35)'; this.style.borderColor='#9d7bff'"
                      onmouseout="this.style.background='rgba(157, 123, 255, 0.2)'; this.style.borderColor='rgba(157, 123, 255, 0.4)'">
                Deposit
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- RAGEQUIT MODAL -->
    <div class="wallet-modal-overlay" id="ragequitModal">
      <div class="wallet-modal" style="max-width: 540px;">
        <div class="wallet-modal-header">
          <h2 class="wallet-modal-title">Ragequit DAO</h2>
          <button class="wallet-modal-close" onclick="closeRagequitModal()">&times;</button>
        </div>
        <div class="wallet-modal-content">
          <div style="padding: 1rem;">
            <!-- Member Balances -->
            <div style="margin-bottom: 1.5rem;">
              <h4 style="font-family: 'Cinzel', serif; font-size: 0.85rem; color: #9d7bff; margin-bottom: 0.75rem; letter-spacing: 0.1em;">YOUR BALANCES</h4>
              <div class="grid-template-columns-2" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                <div style="padding: 0.75rem; background: rgba(157, 123, 255, 0.1); border: 1px solid rgba(157, 123, 255, 0.3); border-radius: 4px;">
                  <div style="font-size: 0.7rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.35rem;">SHARES</div>
                  <div id="ragequitUserShares" style="font-size: 1.1rem; color: #e6d9ff; font-weight: 600;">0</div>
                </div>
                <div style="padding: 0.75rem; background: rgba(157, 123, 255, 0.1); border: 1px solid rgba(157, 123, 255, 0.3); border-radius: 4px;">
                  <div style="font-size: 0.7rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.35rem;">LOOT</div>
                  <div id="ragequitUserLoot" style="font-size: 1.1rem; color: #e6d9ff; font-weight: 600;">0</div>
                </div>
              </div>
            </div>

            <!-- Burn Amounts -->
            <div style="margin-bottom: 1.5rem;">
              <h4 style="font-family: 'Cinzel', serif; font-size: 0.85rem; color: #9d7bff; margin-bottom: 0.75rem; letter-spacing: 0.1em;">BURN AMOUNTS</h4>
              <div class="grid-template-columns-2" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                <div>
                  <label style="display: block; font-size: 0.7rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.4rem;">Shares to Burn</label>
                  <input type="text" id="ragequitSharesInput" placeholder="0.0" inputmode="decimal" style="width: 100%; padding: 0.7rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 0.95rem; border-radius: 4px;">
                  <div style="font-size: 0.65rem; color: rgba(230, 217, 255, 0.5); margin-top: 0.35rem;">
                    <span onclick="setRagequitMaxShares()" style="color: #9d7bff; cursor: pointer; text-decoration: underline;">Max</span>
                  </div>
                </div>
                <div>
                  <label style="display: block; font-size: 0.7rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.4rem;">Loot to Burn</label>
                  <input type="text" id="ragequitLootInput" placeholder="0.0" inputmode="decimal" style="width: 100%; padding: 0.7rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 0.95rem; border-radius: 4px;">
                  <div style="font-size: 0.65rem; color: rgba(230, 217, 255, 0.5); margin-top: 0.35rem;">
                    <span onclick="setRagequitMaxLoot()" style="color: #9d7bff; cursor: pointer; text-decoration: underline;">Max</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Token Selection -->
            <div style="margin-bottom: 1.5rem;">
              <h4 style="font-family: 'Cinzel', serif; font-size: 0.85rem; color: #9d7bff; margin-bottom: 0.75rem; letter-spacing: 0.1em;">TOKENS TO CLAIM</h4>
              <div id="ragequitTokenList" style="display: flex; flex-direction: column; gap: 0.6rem; max-height: 200px; overflow-y: auto; padding: 0.25rem;">
                <!-- Token checkboxes will be dynamically inserted here -->
              </div>

              <!-- Custom Token Input -->
              <div style="margin-top: 0.75rem; padding: 0.6rem; background: rgba(157, 123, 255, 0.05); border: 1px solid rgba(157, 123, 255, 0.2); border-radius: 4px;">
                <div style="font-size: 0.7rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.4rem;">Add Custom Token</div>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                  <input type="text" id="ragequitCustomTokenInput" placeholder="Token address (0x...)"
                         style="flex: 1; min-width: 200px; padding: 0.6rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 0.85rem; border-radius: 4px;">
                  <button onclick="addCustomRagequitToken()"
                          style="padding: 0.6rem 0.9rem; background: rgba(157, 123, 255, 0.2); border: 1px solid rgba(157, 123, 255, 0.4); color: #e6d9ff; font-family: 'Cinzel', serif; font-size: 0.65rem; letter-spacing: 0.1em; cursor: pointer; text-transform: uppercase; white-space: nowrap; border-radius: 4px;"
                          onmouseover="this.style.background='rgba(157, 123, 255, 0.3)'"
                          onmouseout="this.style.background='rgba(157, 123, 255, 0.2)'">
                    Add
                  </button>
                </div>
                <div style="font-size: 0.65rem; color: rgba(230, 217, 255, 0.5); margin-top: 0.4rem;">
                  💡 For tokens not in the list. Auto-sorted by address.
                </div>
              </div>
            </div>

            <!-- Action Buttons -->
            <div style="display: flex; gap: 0.75rem; padding-top: 0.5rem; border-top: 1px solid rgba(157, 123, 255, 0.2);">
              <button onclick="closeRagequitModal()" style="flex: 1; padding: 0.85rem; background: rgba(157, 123, 255, 0.1); border: 1px solid rgba(157, 123, 255, 0.3); color: #9d7bff; font-family: 'Cinzel', serif; font-size: 0.7rem; letter-spacing: 0.15em; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; border-radius: 4px;"
                      onmouseover="this.style.background='rgba(157, 123, 255, 0.15)'"
                      onmouseout="this.style.background='rgba(157, 123, 255, 0.1)'">
                Cancel
              </button>
              <button onclick="executeRagequit()" style="flex: 1; padding: 0.85rem; background: rgba(255, 0, 0, 0.15); border: 1px solid rgba(255, 0, 0, 0.3); color: #ff6b6b; font-family: 'Cinzel', serif; font-size: 0.7rem; letter-spacing: 0.15em; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; font-weight: 600; border-radius: 4px;"
                      onmouseover="this.style.background='rgba(255, 0, 0, 0.25)'; this.style.borderColor='rgba(255, 0, 0, 0.5)'"
                      onmouseout="this.style.background='rgba(255, 0, 0, 0.15)'; this.style.borderColor='rgba(255, 0, 0, 0.3)'">
                Execute Ragequit
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- HERO / LANDER -->
    <div class="hero page">
      <svg width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <!-- Reusable gradients and filters -->
          <radialGradient id="bgGradient">
            <stop offset="0%" style="stop-color: #0a0015; stop-opacity: 1" />
            <stop offset="100%" style="stop-color: #000000; stop-opacity: 1" />
          </radialGradient>

          <filter id="purpleGlow">
            <feGaussianBlur stdDeviation="4" result="coloredBlur" />
            <feMerge>
              <feMergeNode in="coloredBlur" />
              <feMergeNode in="SourceGraphic" />
            </feMerge>
          </filter>

          <filter id="outerGlow" x="-50%" y="-50%" width="200%" height="200%">
            <feGaussianBlur stdDeviation="8" result="bigBlur" />
            <feColorMatrix
              in="bigBlur"
              type="matrix"
              values="1 0 0 0 0.6
                      0 1 0 0 0.3
                      0 0 1 0 1
                      0 0 0 0.8 0"
            />
            <feMerge>
              <feMergeNode />
              <feMergeNode in="SourceGraphic" />
            </feMerge>
          </filter>

          <!-- Lava lamp blob patterns -->
          <pattern
            id="lavaBlobs"
            x="0"
            y="0"
            width="100%"
            height="100%"
            patternUnits="userSpaceOnUse"
          >
            <ellipse cx="20%" cy="100%" rx="80" ry="120" fill="black">
              <animate
                attributeName="cy"
                values="100%;50%;0%;50%;100%"
                dur="12s"
                repeatCount="indefinite"
              />
              <animate
                attributeName="cx"
                values="20%;35%;25%;40%;20%"
                dur="12s"
                repeatCount="indefinite"
              />
            </ellipse>
            <ellipse cx="70%" cy="0%" rx="60" ry="100" fill="black">
              <animate
                attributeName="cy"
                values="0%;60%;100%;60%;0%"
                dur="10s"
                repeatCount="indefinite"
              />
              <animate
                attributeName="cx"
                values="70%;55%;65%;75%;70%"
                dur="10s"
                repeatCount="indefinite"
              />
            </ellipse>
            <ellipse cx="50%" cy="120%" rx="50" ry="80" fill="black">
              <animate
                attributeName="cy"
                values="120%;40%;-20%;40%;120%"
                dur="15s"
                repeatCount="indefinite"
              />
            </ellipse>
          </pattern>

          <mask id="blobMask">
            <rect width="100%" height="100%" fill="white" />
            <rect width="100%" height="100%" fill="url(#lavaBlobs)" />
          </mask>

          <filter id="gooey">
            <feGaussianBlur in="SourceGraphic" stdDeviation="8" result="blur" />
            <feColorMatrix
              in="blur"
              type="matrix"
              values="1 0 0 0 0
                      0 1 0 0 0
                      0 0 1 0 0
                      0 0 0 19 -9"
            />
            <feComposite in2="SourceGraphic" operator="atop" />
          </filter>

          <pattern
            id="stars"
            x="0"
            y="0"
            width="200"
            height="200"
            patternUnits="userSpaceOnUse"
          >
            <circle cx="20" cy="30" r="0.5" fill="white" opacity="0.6">
              <animate
                attributeName="opacity"
                values="0.6;1;0.6"
                dur="3s"
                repeatCount="indefinite"
              />
            </circle>
            <circle cx="80" cy="50" r="0.8" fill="white" opacity="0.4">
              <animate
                attributeName="opacity"
                values="0.4;0.8;0.4"
                dur="4s"
                repeatCount="indefinite"
              />
            </circle>
            <circle cx="120" cy="80" r="0.3" fill="white" opacity="0.7">
              <animate
                attributeName="opacity"
                values="0.7;1;0.7"
                dur="2.5s"
                repeatCount="indefinite"
              />
            </circle>
            <circle cx="160" cy="120" r="0.6" fill="white" opacity="0.5">
              <animate
                attributeName="opacity"
                values="0.5;0.9;0.5"
                dur="3.5s"
                repeatCount="indefinite"
              />
            </circle>
            <circle cx="40" cy="140" r="0.4" fill="white" opacity="0.6">
              <animate
                attributeName="opacity"
                values="0.6;1;0.6"
                dur="2.8s"
                repeatCount="indefinite"
              />
            </circle>
            <circle cx="180" cy="20" r="0.5" fill="white" opacity="0.4">
              <animate
                attributeName="opacity"
                values="0.4;0.7;0.4"
                dur="4.2s"
                repeatCount="indefinite"
              />
            </circle>
            <circle cx="100" cy="160" r="0.7" fill="white" opacity="0.5">
              <animate
                attributeName="opacity"
                values="0.5;1;0.5"
                dur="3.3s"
                repeatCount="indefinite"
              />
            </circle>
            <circle cx="150" cy="180" r="0.4" fill="#9d7bff" opacity="0.3">
              <animate
                attributeName="opacity"
                values="0.3;0.7;0.3"
                dur="5s"
                repeatCount="indefinite"
              />
            </circle>
          </pattern>
        </defs>

        <!-- Background -->
        <rect width="100%" height="100%" fill="url(#bgGradient)" />
        <rect width="100%" height="100%" fill="url(#stars)" />

        <!-- Additional scattered stars for brightness -->
        <g opacity="0.4">
          <circle cx="10%" cy="20%" r="1" fill="white">
            <animate
              attributeName="opacity"
              values="0.4;1;0.4"
              dur="2.7s"
              repeatCount="indefinite"
            />
          </circle>
          <circle cx="90%" cy="15%" r="0.5" fill="white">
            <animate
              attributeName="opacity"
              values="0.3;0.8;0.3"
              dur="3.2s"
              repeatCount="indefinite"
            />
          </circle>
          <circle cx="85%" cy="80%" r="0.8" fill="white">
            <animate
              attributeName="opacity"
              values="0.5;1;0.5"
              dur="2.9s"
              repeatCount="indefinite"
            />
          </circle>
          <circle cx="15%" cy="85%" r="0.6" fill="white">
            <animate
              attributeName="opacity"
              values="0.4;0.9;0.4"
              dur="3.4s"
              repeatCount="indefinite"
            />
          </circle>
          <circle cx="30%" cy="10%" r="0.7" fill="#9d7bff">
            <animate
              attributeName="opacity"
              values="0.2;0.6;0.2"
              dur="4s"
              repeatCount="indefinite"
            />
          </circle>
          <circle cx="70%" cy="90%" r="0.5" fill="#9d7bff">
            <animate
              attributeName="opacity"
              values="0.3;0.7;0.3"
              dur="3.8s"
              repeatCount="indefinite"
            />
          </circle>
        </g>

        <!-- RADIATING LINES FROM TOP -->
        <g opacity="0.9">
          <line
            x1="50%"
            y1="0"
            x2="50%"
            y2="50%"
            stroke="white"
            stroke-width="1.5"
            opacity="0.8"
          >
            <animate
              attributeName="opacity"
              values="0.6;1;0.6"
              dur="4s"
              repeatCount="indefinite"
            />
          </line>
          <line
            x1="48%"
            y1="0"
            x2="49%"
            y2="50%"
            stroke="white"
            stroke-width="1.2"
            opacity="0.7"
          />
          <line
            x1="52%"
            y1="0"
            x2="51%"
            y2="50%"
            stroke="white"
            stroke-width="1.2"
            opacity="0.7"
          />
          <line
            x1="46%"
            y1="0"
            x2="48.5%"
            y2="50%"
            stroke="white"
            stroke-width="1"
            opacity="0.65"
          />
          <line
            x1="54%"
            y1="0"
            x2="51.5%"
            y2="50%"
            stroke="white"
            stroke-width="1"
            opacity="0.65"
          />
          <line
            x1="44%"
            y1="0"
            x2="48%"
            y2="50%"
            stroke="white"
            stroke-width="0.8"
            opacity="0.6"
          />
          <line
            x1="56%"
            y1="0"
            x2="52%"
            y2="50%"
            stroke="white"
            stroke-width="0.8"
            opacity="0.6"
          />
          <line
            x1="42%"
            y1="0"
            x2="47%"
            y2="50%"
            stroke="white"
            stroke-width="0.7"
            opacity="0.55"
          />
          <line
            x1="58%"
            y1="0"
            x2="53%"
            y2="50%"
            stroke="white"
            stroke-width="0.7"
            opacity="0.55"
          />
          <line
            x1="40%"
            y1="0"
            x2="46.5%"
            y2="50%"
            stroke="white"
            stroke-width="0.6"
            opacity="0.5"
          />
          <line
            x1="60%"
            y1="0"
            x2="53.5%"
            y2="50%"
            stroke="white"
            stroke-width="0.6"
            opacity="0.5"
          />
          <line
            x1="38%"
            y1="0"
            x2="46%"
            y2="50%"
            stroke="white"
            stroke-width="0.5"
            opacity="0.45"
          />
          <line
            x1="62%"
            y1="0"
            x2="54%"
            y2="50%"
            stroke="white"
            stroke-width="0.5"
            opacity="0.45"
          />
          <line
            x1="35%"
            y1="0"
            x2="45%"
            y2="50%"
            stroke="white"
            stroke-width="0.5"
            opacity="0.4"
          />
          <line
            x1="65%"
            y1="0"
            x2="55%"
            y2="50%"
            stroke="white"
            stroke-width="0.5"
            opacity="0.4"
          />
          <line
            x1="32%"
            y1="0"
            x2="44%"
            y2="50%"
            stroke="white"
            stroke-width="0.4"
            opacity="0.35"
          />
          <line
            x1="68%"
            y1="0"
            x2="56%"
            y2="50%"
            stroke="white"
            stroke-width="0.4"
            opacity="0.35"
          />
          <line
            x1="30%"
            y1="0"
            x2="43%"
            y2="50%"
            stroke="white"
            stroke-width="0.3"
            opacity="0.3"
          />
          <line
            x1="70%"
            y1="0"
            x2="57%"
            y2="50%"
            stroke="white"
            stroke-width="0.3"
            opacity="0.3"
          />
          <line
            x1="28%"
            y1="0"
            x2="42.5%"
            y2="50%"
            stroke="white"
            stroke-width="0.3"
            opacity="0.25"
          />
          <line
            x1="72%"
            y1="0"
            x2="57.5%"
            y2="50%"
            stroke="white"
            stroke-width="0.3"
            opacity="0.25"
          />
          <line
            x1="25%"
            y1="0"
            x2="42%"
            y2="50%"
            stroke="white"
            stroke-width="0.2"
            opacity="0.2"
          />
          <line
            x1="75%"
            y1="0"
            x2="58%"
            y2="50%"
            stroke="white"
            stroke-width="0.2"
            opacity="0.2"
          />
          <line
            x1="20%"
            y1="0"
            x2="41%"
            y2="50%"
            stroke="white"
            stroke-width="0.15"
            opacity="0.15"
          />
          <line
            x1="80%"
            y1="0"
            x2="59%"
            y2="50%"
            stroke="white"
            stroke-width="0.15"
            opacity="0.15"
          />
          <line
            x1="15%"
            y1="0"
            x2="40%"
            y2="50%"
            stroke="white"
            stroke-width="0.1"
            opacity="0.1"
          />
          <line
            x1="85%"
            y1="0"
            x2="60%"
            y2="50%"
            stroke="white"
            stroke-width="0.1"
            opacity="0.1"
          />
          <line
            x1="10%"
            y1="0"
            x2="39%"
            y2="50%"
            stroke="white"
            stroke-width="0.1"
            opacity="0.1"
          />
          <line
            x1="90%"
            y1="0"
            x2="61%"
            y2="50%"
            stroke="white"
            stroke-width="0.1"
            opacity="0.1"
          />
        </g>

        <!-- RADIATING LINES FROM BOTTOM -->
        <g opacity="0.9">
          <line
            x1="50%"
            y1="100%"
            x2="50%"
            y2="50%"
            stroke="white"
            stroke-width="1.5"
            opacity="0.8"
          >
            <animate
              attributeName="opacity"
              values="0.6;1;0.6"
              dur="4s"
              repeatCount="indefinite"
            />
          </line>
          <line
            x1="48%"
            y1="100%"
            x2="49%"
            y2="50%"
            stroke="white"
            stroke-width="1.2"
            opacity="0.7"
          />
          <line
            x1="52%"
            y1="100%"
            x2="51%"
            y2="50%"
            stroke="white"
            stroke-width="1.2"
            opacity="0.7"
          />
          <line
            x1="46%"
            y1="100%"
            x2="48.5%"
            y2="50%"
            stroke="white"
            stroke-width="1"
            opacity="0.65"
          />
          <line
            x1="54%"
            y1="100%"
            x2="51.5%"
            y2="50%"
            stroke="white"
            stroke-width="1"
            opacity="0.65"
          />
          <line
            x1="44%"
            y1="100%"
            x2="48%"
            y2="50%"
            stroke="white"
            stroke-width="0.8"
            opacity="0.6"
          />
          <line
            x1="56%"
            y1="100%"
            x2="52%"
            y2="50%"
            stroke="white"
            stroke-width="0.8"
            opacity="0.6"
          />
          <line
            x1="42%"
            y1="100%"
            x2="47%"
            y2="50%"
            stroke="white"
            stroke-width="0.7"
            opacity="0.55"
          />
          <line
            x1="58%"
            y1="100%"
            x2="53%"
            y2="50%"
            stroke="white"
            stroke-width="0.7"
            opacity="0.55"
          />
          <line
            x1="40%"
            y1="100%"
            x2="46.5%"
            y2="50%"
            stroke="white"
            stroke-width="0.6"
            opacity="0.5"
          />
          <line
            x1="60%"
            y1="100%"
            x2="53.5%"
            y2="50%"
            stroke="white"
            stroke-width="0.6"
            opacity="0.5"
          />
          <line
            x1="38%"
            y1="100%"
            x2="46%"
            y2="50%"
            stroke="white"
            stroke-width="0.5"
            opacity="0.45"
          />
          <line
            x1="62%"
            y1="100%"
            x2="54%"
            y2="50%"
            stroke="white"
            stroke-width="0.5"
            opacity="0.45"
          />
          <line
            x1="35%"
            y1="100%"
            x2="45%"
            y2="50%"
            stroke="white"
            stroke-width="0.5"
            opacity="0.4"
          />
          <line
            x1="65%"
            y1="100%"
            x2="55%"
            y2="50%"
            stroke="white"
            stroke-width="0.5"
            opacity="0.4"
          />
          <line
            x1="32%"
            y1="100%"
            x2="44%"
            y2="50%"
            stroke="white"
            stroke-width="0.4"
            opacity="0.35"
          />
          <line
            x1="68%"
            y1="100%"
            x2="56%"
            y2="50%"
            stroke="white"
            stroke-width="0.4"
            opacity="0.35"
          />
          <line
            x1="30%"
            y1="100%"
            x2="43%"
            y2="50%"
            stroke="white"
            stroke-width="0.3"
            opacity="0.3"
          />
          <line
            x1="70%"
            y1="100%"
            x2="57%"
            y2="50%"
            stroke="white"
            stroke-width="0.3"
            opacity="0.3"
          />
          <line
            x1="28%"
            y1="100%"
            x2="42.5%"
            y2="50%"
            stroke="white"
            stroke-width="0.3"
            opacity="0.25"
          />
          <line
            x1="72%"
            y1="100%"
            x2="57.5%"
            y2="50%"
            stroke="white"
            stroke-width="0.3"
            opacity="0.25"
          />
          <line
            x1="25%"
            y1="100%"
            x2="42%"
            y2="50%"
            stroke="white"
            stroke-width="0.2"
            opacity="0.2"
          />
          <line
            x1="75%"
            y1="100%"
            x2="58%"
            y2="50%"
            stroke="white"
            stroke-width="0.2"
            opacity="0.2"
          />
          <line
            x1="20%"
            y1="100%"
            x2="41%"
            y2="50%"
            stroke="white"
            stroke-width="0.15"
            opacity="0.15"
          />
          <line
            x1="80%"
            y1="100%"
            x2="59%"
            y2="50%"
            stroke="white"
            stroke-width="0.15"
            opacity="0.15"
          />
          <line
            x1="15%"
            y1="100%"
            x2="40%"
            y2="50%"
            stroke="white"
            stroke-width="0.1"
            opacity="0.1"
          />
          <line
            x1="85%"
            y1="100%"
            x2="60%"
            y2="50%"
            stroke="white"
            stroke-width="0.1"
            opacity="0.1"
          />
          <line
            x1="10%"
            y1="100%"
            x2="39%"
            y2="50%"
            stroke="white"
            stroke-width="0.1"
            opacity="0.1"
          />
          <line
            x1="90%"
            y1="100%"
            x2="61%"
            y2="50%"
            stroke="white"
            stroke-width="0.1"
            opacity="0.1"
          />
        </g>

        <!-- Eye circles -->
        <circle
          cx="50%"
          cy="50%"
          r="100"
          fill="none"
          stroke="white"
          stroke-width="0.8"
          opacity="0.4"
        >
          <animate
            attributeName="r"
            values="100;105;100"
            dur="8s"
            repeatCount="indefinite"
          />
        </circle>
        <circle
          cx="50%"
          cy="50%"
          r="60"
          fill="none"
          stroke="#9d7bff"
          stroke-width="0.6"
          opacity="0.5"
        >
          <animate
            attributeName="r"
            values="60;65;60"
            dur="6s"
            repeatCount="indefinite"
          />
        </circle>

        <!-- MOLOCH text -->
        <text
          class="hero-moloch-text"
          x="50%"
          y="35%"
          font-size="65"
          font-weight="400"
          text-anchor="middle"
          fill="#2a1a4a"
          opacity="0.5"
          letter-spacing="22"
          font-family="'Cinzel', serif"
        >
          MOLOCH
          <animate
            attributeName="opacity"
            values="0.5;0.65;0.5"
            dur="8s"
            repeatCount="indefinite"
          />
        </text>

        <!-- MAJEUR text + ink effect -->
        <g>
          <text
            class="hero-majeur-text"
            x="50%"
            y="65%"
            font-size="72"
            font-weight="400"
            font-style="italic"
            text-anchor="middle"
            fill="#b19cd9"
            letter-spacing="18"
            filter="url(#outerGlow)"
            font-family="'EB Garamond', serif"
          >
            MAJEUR
            <animate
              attributeName="fill"
              values="#b19cd9;#d8bfff;#b19cd9"
              dur="4s"
              repeatCount="indefinite"
            />
          </text>
          <text
            class="hero-majeur-text"
            x="50%"
            y="65%"
            font-size="72"
            font-weight="400"
            font-style="italic"
            text-anchor="middle"
            fill="#e6d9ff"
            opacity="0.8"
            letter-spacing="18"
            filter="url(#purpleGlow)"
            font-family="'EB Garamond', serif"
          >
            MAJEUR
            <animate
              attributeName="opacity"
              values="0.8;1;0.8"
              dur="3s"
              repeatCount="indefinite"
            />
          </text>
          <!-- Black ink bleed effect -->
          <g filter="url(#gooey)">
            <text
              class="hero-majeur-text"
              x="50%"
              y="65%"
              font-size="72"
              font-weight="400"
              font-style="italic"
              text-anchor="middle"
              fill="black"
              letter-spacing="18"
              mask="url(#blobMask)"
              font-family="'EB Garamond', serif"
            >
              MAJEUR
            </text>
          </g>
          <!-- Outline -->
          <text
            class="hero-majeur-text"
            x="50%"
            y="65%"
            font-size="72"
            font-weight="400"
            font-style="italic"
            text-anchor="middle"
            fill="none"
            stroke="#9d7bff"
            stroke-width="0.5"
            opacity="0.4"
            letter-spacing="18"
            font-family="'EB Garamond', serif"
          >
            MAJEUR
            <animate
              attributeName="stroke-width"
              values="0.5;1;0.5"
              dur="5s"
              repeatCount="indefinite"
            />
          </text>
        </g>

        <!-- Subtitle -->
        <text
          class="hero-subtitle-text"
          x="50%"
          y="75%"
          font-size="20"
          font-weight="400"
          text-anchor="middle"
          fill="#e6d9ff"
          opacity="0.7"
          letter-spacing="3"
          font-family="'Cinzel', serif"
        >
          GOVERNANCE FRAMEWORK
        </text>
      </svg>

      <!-- Scroll indicator -->
      <div class="scroll-indicator" aria-label="Scroll to features">
        <svg
          width="40"
          height="60"
          viewBox="0 0 40 60"
          xmlns="http://www.w3.org/2000/svg"
          onclick="document.getElementById('seats').scrollIntoView({ behavior: 'smooth' });"
        >
          <path
            d="M20 5 L20 45 M10 35 L20 45 L30 35"
            stroke="#b19cd9"
            stroke-width="2"
            fill="none"
            opacity="0.7"
          >
            <animate
              attributeName="opacity"
              values="0.4;0.9;0.4"
              dur="2s"
              repeatCount="indefinite"
            />
          </path>
        </svg>
      </div>
    </div>

    <!-- Intro Panel -->
    <section class="intro-panel">
      <!-- Subtle radial line continuations from hero -->
      <div class="radial-continuation">
        <svg viewBox="0 0 1000 300" preserveAspectRatio="xMidYMin slice" style="position: absolute; top: -150px; width: 100%; height: 300px; pointer-events: none;">
          <!-- Lines converging from wide to narrow -->
          <line x1="0" y1="0" x2="400" y2="300" stroke="rgba(230, 217, 255, 0.08)" stroke-width="1"/>
          <line x1="200" y1="0" x2="450" y2="300" stroke="rgba(230, 217, 255, 0.06)" stroke-width="1"/>
          <line x1="400" y1="0" x2="500" y2="300" stroke="rgba(230, 217, 255, 0.1)" stroke-width="1"/>
          <line x1="600" y1="0" x2="500" y2="300" stroke="rgba(230, 217, 255, 0.1)" stroke-width="1"/>
          <line x1="800" y1="0" x2="550" y2="300" stroke="rgba(230, 217, 255, 0.06)" stroke-width="1"/>
          <line x1="1000" y1="0" x2="600" y2="300" stroke="rgba(230, 217, 255, 0.08)" stroke-width="1"/>
        </svg>
      </div>
      
      <div class="intro-content">
        <div class="intro-art">
          <svg viewBox="0 0 400 400" xmlns="http://www.w3.org/2000/svg">
            <!-- Radial governance visualization -->
            <defs>
              <radialGradient id="centerGradient">
                <stop offset="0%" style="stop-color:#9d7bff;stop-opacity:0.8" />
                <stop offset="100%" style="stop-color:#6b46ff;stop-opacity:0.2" />
              </radialGradient>
              <filter id="glow">
                <feGaussianBlur stdDeviation="4" result="coloredBlur"/>
                <feMerge>
                  <feMergeNode in="coloredBlur"/>
                  <feMergeNode in="SourceGraphic"/>
                </feMerge>
              </filter>
            </defs>
            
            <!-- Central core -->
            <circle cx="200" cy="200" r="30" fill="url(#centerGradient)" filter="url(#glow)"/>
            
            <!-- Orbital rings -->
            <circle cx="200" cy="200" r="80" fill="none" stroke="#9d7bff" stroke-width="0.5" opacity="0.3"/>
            <circle cx="200" cy="200" r="120" fill="none" stroke="#9d7bff" stroke-width="0.5" opacity="0.4"/>
            <circle cx="200" cy="200" r="160" fill="none" stroke="#9d7bff" stroke-width="0.5" opacity="0.5"/>
            
            <!-- Radiating nodes -->
            <g class="converging-nodes" transform-origin="200 200">
              <!-- Inner ring nodes -->
              <circle cx="280" cy="200" r="8" fill="#9d7bff" opacity="0.9"/>
              <circle cx="200" cy="120" r="8" fill="#9d7bff" opacity="0.9"/>
              <circle cx="120" cy="200" r="8" fill="#9d7bff" opacity="0.9"/>
              <circle cx="200" cy="280" r="8" fill="#9d7bff" opacity="0.9"/>
              
              <!-- Middle ring nodes -->
              <circle cx="320" cy="200" r="6" fill="#7b5fff" opacity="0.7"/>
              <circle cx="260" cy="140" r="6" fill="#7b5fff" opacity="0.7"/>
              <circle cx="200" cy="80" r="6" fill="#7b5fff" opacity="0.7"/>
              <circle cx="140" cy="140" r="6" fill="#7b5fff" opacity="0.7"/>
              <circle cx="80" cy="200" r="6" fill="#7b5fff" opacity="0.7"/>
              <circle cx="140" cy="260" r="6" fill="#7b5fff" opacity="0.7"/>
              <circle cx="200" cy="320" r="6" fill="#7b5fff" opacity="0.7"/>
              <circle cx="260" cy="260" r="6" fill="#7b5fff" opacity="0.7"/>
              
              <!-- Outer ring nodes -->
              <circle cx="360" cy="200" r="4" fill="#6b46ff" opacity="0.5"/>
              <circle cx="320" cy="120" r="4" fill="#6b46ff" opacity="0.5"/>
              <circle cx="200" cy="40" r="4" fill="#6b46ff" opacity="0.5"/>
              <circle cx="80" cy="120" r="4" fill="#6b46ff" opacity="0.5"/>
              <circle cx="40" cy="200" r="4" fill="#6b46ff" opacity="0.5"/>
              <circle cx="80" cy="280" r="4" fill="#6b46ff" opacity="0.5"/>
              <circle cx="200" cy="360" r="4" fill="#6b46ff" opacity="0.5"/>
              <circle cx="320" cy="280" r="4" fill="#6b46ff" opacity="0.5"/>
            </g>
            
            <!-- Connecting lines -->
            <g class="connections" opacity="0.3">
              <line x1="200" y1="200" x2="280" y2="200" stroke="#9d7bff" stroke-width="1"/>
              <line x1="200" y1="200" x2="200" y2="120" stroke="#9d7bff" stroke-width="1"/>
              <line x1="200" y1="200" x2="120" y2="200" stroke="#9d7bff" stroke-width="1"/>
              <line x1="200" y1="200" x2="200" y2="280" stroke="#9d7bff" stroke-width="1"/>
              <line x1="200" y1="200" x2="260" y2="140" stroke="#7b5fff" stroke-width="0.5"/>
              <line x1="200" y1="200" x2="140" y2="140" stroke="#7b5fff" stroke-width="0.5"/>
              <line x1="200" y1="200" x2="140" y2="260" stroke="#7b5fff" stroke-width="0.5"/>
              <line x1="200" y1="200" x2="260" y2="260" stroke="#7b5fff" stroke-width="0.5"/>
            </g>
            
            <!-- Pulsing center -->
            <circle cx="200" cy="200" r="15" fill="#e6d9ff" class="pulse-core"/>
          </svg>
        </div>
        
        <div class="intro-text">
          <h2>Radical Transparency, Unlimited Power</h2>
          <p>
            Majeur is a minimal framework to manage digital organizations at any stage.
            Built on battle-tested governance primitives, flexible with modular code, 
            with new ways to reward good governance with real ownership.
          </p>
          <p class="intro-highlight">
            Deploy your DAO in minutes. Govern with clarity. Own your decisions.
          </p>
        </div>
        
        <div class="scroll-hint" onclick="document.getElementById('seats').scrollIntoView({ behavior: 'smooth' });">
          <span>Explore the Features</span>
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 5v14M19 12l-7 7-7-7"/>
          </svg>
        </div>
      </div>
    </section>

    <!-- Scroll Journey Line: Radials converge to single line -->

    <!-- Converging radials (fixed to viewport) -->
    <svg id="radial-convergence" style="
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      pointer-events: none;
      z-index: 50;
    " viewBox="0 0 100 100" preserveAspectRatio="none">
      <g id="radial-group" opacity="0.6">
        <line x1="10" y1="15" x2="50" y2="25" stroke="rgba(230, 217, 255, 0.6)" stroke-width="0.08" />
        <line x1="25" y1="15" x2="50" y2="25" stroke="rgba(230, 217, 255, 0.4)" stroke-width="0.06" />
        <line x1="40" y1="15" x2="50" y2="25" stroke="rgba(230, 217, 255, 0.8)" stroke-width="0.1" />
        <line x1="60" y1="15" x2="50" y2="25" stroke="rgba(230, 217, 255, 0.8)" stroke-width="0.1" />
        <line x1="75" y1="15" x2="50" y2="25" stroke="rgba(230, 217, 255, 0.4)" stroke-width="0.06" />
        <line x1="90" y1="15" x2="50" y2="25" stroke="rgba(230, 217, 255, 0.6)" stroke-width="0.08" />
      </g>
    </svg>

    <!-- Central journey line (fixed, visible centerline) -->
    <div id="journey-line-container" style="
      position: fixed;
      left: 50%;
      top: 0;
      width: 3px;
      height: 100vh;
      transform: translateX(-50%);
      pointer-events: none;
      z-index: 50;
      opacity: 0;
    ">
      <div id="journey-line" style="
        position: absolute;
        top: 0;
        left: 50%;
        width: 2px;
        height: 0%;
        transform: translateX(-50%);
        background: linear-gradient(
          180deg,
          rgba(157, 123, 255, 0.4) 0%,
          rgba(230, 217, 255, 0.7) 50%,
          rgba(157, 123, 255, 0.4) 100%
        );
        box-shadow:
          0 0 8px rgba(157, 123, 255, 0.6),
          0 0 16px rgba(157, 123, 255, 0.3);
      "></div>

      <div id="journey-endpoint" style="
        position: absolute;
        bottom: 0;
        left: 50%;
        width: 12px;
        height: 12px;
        transform: translate(-50%, 50%);
        border-radius: 50%;
        background: radial-gradient(circle, rgba(230, 217, 255, 1) 0%, rgba(157, 123, 255, 0.6) 100%);
        box-shadow:
          0 0 12px rgba(230, 217, 255, 0.8),
          0 0 24px rgba(157, 123, 255, 0.4);
        opacity: 0;
      "></div>
    </div>

    <!-- Feature pages -->
    <main class="features">
      <!-- 01: SEATS (Badges / SBT top-256) -->
      <section class="feature-page" id="seats">
        <div class="feature-inner">
          <div class="feature-left">
            <div class="feature-tag">Majeur Feature 01</div>
            <h2 class="feature-title" data-word="SEATS">SEATS</h2>
            <p class="feature-copy">
              The top 256 holders crystallize into <em>soulbound seats</em> –
              ERC-721 badges that auto-reassign as balances move. The bitmap
              scoreboard is maintained entirely on-chain: badges burn and remint
              as the cutline shifts, so the "inner circle" is always live.
            </p>
            <div class="feature-meta">Top-256 SBT badges · Dynamic ranking</div>
          </div>

          <div class="feature-right">
            <svg
              class="feature-art"
              viewBox="0 0 320 320"
              xmlns="http://www.w3.org/2000/svg"
            >
              <circle
                cx="160"
                cy="160"
                r="120"
                fill="none"
                stroke="#9d7bff"
                stroke-width="1"
                opacity="0.6"
              />
              <circle
                cx="160"
                cy="160"
                r="84"
                fill="none"
                stroke="#e6d9ff"
                stroke-width="0.8"
                opacity="0.7"
              />
              <circle cx="160" cy="160" r="4" fill="#e6d9ff" opacity="0.9" />

              <!-- Radial "seat" ticks -->
              <g stroke="#e6d9ff" stroke-width="0.6" opacity="0.8">
                <line x1="160" y1="34" x2="160" y2="44" />
                <line x1="160" y1="276" x2="160" y2="266" />
                <line x1="34" y1="160" x2="44" y2="160" />
                <line x1="276" y1="160" x2="266" y2="160" />
                <line x1="80" y1="80" x2="88" y2="88" />
                <line x1="240" y1="80" x2="232" y2="88" />
                <line x1="80" y1="240" x2="88" y2="232" />
                <line x1="240" y1="240" x2="232" y2="232" />
              </g>

              <!-- Orbiting "filled seats" -->
              <g fill="#e6d9ff">
                <circle cx="160" cy="40" r="3" />
                <circle cx="256" cy="160" r="3" />
                <circle cx="160" cy="280" r="3" />
                <circle cx="64" cy="160" r="3" />
              </g>

              <!-- Crown-like arc for "top" seats -->
              <path
                d="M110 112 Q160 60 210 112"
                fill="none"
                stroke="#e6d9ff"
                stroke-width="1"
                opacity="0.8"
              />
              <circle cx="132" cy="104" r="2.4" fill="#e6d9ff" />
              <circle cx="188" cy="104" r="2.4" fill="#e6d9ff" />
            </svg>
          </div>
        </div>

        <!-- Floating badge card teaser -->
        <div class="card-teaser" data-card="badge" style="
          position: absolute;
          right: 5%;
          top: 20%;
          width: 120px;
          opacity: 0.5;
          pointer-events: none;
          transform: rotate(8deg);
          z-index: 10;
          background: rgba(0, 0, 0, 0.8);
          border: 1px solid rgba(255, 255, 255, 0.3);
          border-radius: 8px;
          padding: 3px;
        ">
          <svg xmlns="http://www.w3.org/2000/svg" width="420" height="600" viewBox="0 0 420 600" style="width: 100%; height: auto; display: block;">
            <rect width="420" height="600" fill="#000"/>
            <rect x="20" y="20" width="380" height="560" fill="none" stroke="#fff" stroke-width="1"/>

            <text x="210" y="55" font-family="Garamond,serif" font-size="18" fill="#fff" text-anchor="middle" letter-spacing="3">MAJEUR DAO</text>
            <text x="210" y="75" font-family="Garamond,serif" font-size="11" fill="#fff" text-anchor="middle" letter-spacing="2">MEMBER BADGE</text>
            <line x1="40" y1="90" x2="380" y2="90" stroke="#fff" stroke-width="1"/>

            <text x="210" y="135" font-family="monospace" font-size="9" fill="#fff" text-anchor="middle">*    *   *</text>
            <text x="210" y="146" font-family="monospace" font-size="9" fill="#fff" text-anchor="middle">/|\   /|\   /|\</text>
            <text x="210" y="157" font-family="monospace" font-size="9" fill="#fff" text-anchor="middle">+---+---+---+</text>
            <text x="210" y="168" font-family="monospace" font-size="9" fill="#fff" text-anchor="middle">|   | * |   |</text>
            <text x="210" y="179" font-family="monospace" font-size="9" fill="#fff" text-anchor="middle">|   |   |   |</text>
            <text x="210" y="190" font-family="monospace" font-size="9" fill="#fff" text-anchor="middle">+---+---+---+</text>
            <text x="210" y="201" font-family="monospace" font-size="9" fill="#fff" text-anchor="middle">\         /</text>
            <text x="210" y="212" font-family="monospace" font-size="9" fill="#fff" text-anchor="middle">---------</text>

            <text x="60" y="292" font-family="monospace" font-size="9" fill="#fff">0xAbCd...1234</text>
            <text x="60" y="345" font-family="Garamond,serif" font-size="16" fill="#fff">SEAT  -3</text>
            <text x="60" y="395" font-family="monospace" font-size="9" fill="#fff">50,000 shares</text>
            <text x="60" y="445" font-family="monospace" font-size="9" fill="#fff">5.00%</text>

            <text x="210" y="500" font-family="Garamond,serif" font-size="12" fill="#fff" text-anchor="middle" letter-spacing="2">TOP 256</text>
            <text x="210" y="565" font-family="Garamond,serif" font-size="8" fill="#444" text-anchor="middle" letter-spacing="1">NON-TRANSFERABLE</text>
          </svg>
        </div>
      </section>

      <!-- 02: SPLIT (weighted delegation) -->
      <section class="feature-page" id="split">
        <div class="feature-inner">
          <div class="feature-left">
            <div class="feature-tag">Majeur Feature 02</div>
            <h2 class="feature-title" data-word="SPLIT">SPLIT</h2>
            <p class="feature-copy">
              Voting power doesn't have to follow a single delegate. Each holder
              can fan out to up to four delegates in basis-point slices, with
              exact rebalancing on every transfer. Growing their advisory.
            </p>
            <div class="feature-meta">
              Weighted delegation · Up to four delegates
            </div>
          </div>

          <div class="feature-right">
            <svg
              class="feature-art"
              viewBox="0 0 320 320"
              xmlns="http://www.w3.org/2000/svg"
            >
              <!-- Source node -->
              <circle
                cx="80"
                cy="160"
                r="10"
                fill="none"
                stroke="#e6d9ff"
                stroke-width="1.2"
              />
              <circle cx="80" cy="160" r="3" fill="#e6d9ff" />

              <!-- Delegate nodes -->
              <circle
                cx="240"
                cy="80"
                r="9"
                fill="none"
                stroke="#9d7bff"
                stroke-width="1"
              />
              <circle cx="240" cy="80" r="3" fill="#e6d9ff" />
              <circle
                cx="260"
                cy="148"
                r="9"
                fill="none"
                stroke="#9d7bff"
                stroke-width="1"
              />
              <circle cx="260" cy="148" r="3" fill="#e6d9ff" />
              <circle
                cx="240"
                cy="220"
                r="9"
                fill="none"
                stroke="#9d7bff"
                stroke-width="1"
              />
              <circle cx="240" cy="220" r="3" fill="#e6d9ff" />
              <circle
                cx="210"
                cy="160"
                r="9"
                fill="none"
                stroke="#9d7bff"
                stroke-width="1"
              />
              <circle cx="210" cy="160" r="3" fill="#e6d9ff" />

              <!-- Splitting paths -->
              <path
                d="M90 160 C140 110 190 96 232 84"
                fill="none"
                stroke="#e6d9ff"
                stroke-width="0.9"
              />
              <path
                d="M90 160 C150 148 205 144 250 148"
                fill="none"
                stroke="#e6d9ff"
                stroke-width="0.9"
              />
              <path
                d="M90 160 C140 210 190 224 232 220"
                fill="none"
                stroke="#e6d9ff"
                stroke-width="0.9"
              />
              <path
                d="M90 160 C150 160 185 160 201 160"
                fill="none"
                stroke="#e6d9ff"
                stroke-width="0.9"
              />

              <!-- BPS rings -->
              <circle
                cx="80"
                cy="160"
                r="32"
                fill="none"
                stroke="#9d7bff"
                stroke-dasharray="4 6"
                stroke-width="0.7"
                opacity="0.7"
              />
            </svg>
          </div>
        </div>
      </section>

      <!-- 03: PERMIT (one-shot intent receipts) -->
      <section class="feature-page" id="permit">
        <div class="feature-inner">
          <div class="feature-left">
            <div class="feature-tag">Majeur Feature 03</div>
            <h2 class="feature-title" data-word="PERMIT">PERMIT</h2>
            <p class="feature-copy">
              The DAO can mint one-shot ERC-6909 "permit receipts" for arbitrary
              calls. Each token is an intent hash: burn exactly one, execute
              exactly once. Permits are soulbound, and plug
              straight into the same execution path as voted proposals. 
              Great for emergency switches and agents.
            </p>
            <div class="feature-meta">ERC-6909 receipts · One-shot ops</div>
          </div>

          <div class="feature-right">
            <svg
              class="feature-art"
              viewBox="0 0 320 320"
              xmlns="http://www.w3.org/2000/svg"
            >
              <!-- Tablet -->
              <rect
                x="90"
                y="60"
                width="140"
                height="200"
                rx="16"
                ry="16"
                fill="none"
                stroke="#e6d9ff"
                stroke-width="1.1"
                opacity="0.9"
              />
              <rect
                x="102"
                y="82"
                width="116"
                height="160"
                rx="8"
                ry="8"
                fill="none"
                stroke="#9d7bff"
                stroke-width="0.9"
                opacity="0.8"
              />

              <!-- Keyhole glyph -->
              <circle
                cx="160"
                cy="132"
                r="13"
                fill="none"
                stroke="#e6d9ff"
                stroke-width="1"
              />
              <circle cx="160" cy="128" r="4" fill="#e6d9ff" />
              <path
                d="M160 136 L160 152"
                stroke="#e6d9ff"
                stroke-width="1.1"
                stroke-linecap="round"
              />

              <!-- Hash lines -->
              <g stroke="#9d7bff" stroke-width="0.7" opacity="0.7">
                <line x1="120" y1="182" x2="200" y2="182" />
                <line x1="120" y1="196" x2="184" y2="196" />
                <line x1="120" y1="210" x2="176" y2="210" />
              </g>

              <!-- "Burn" triangle -->
              <polygon
                points="64,228 92,260 36,260"
                fill="none"
                stroke="#e6d9ff"
                stroke-width="0.9"
                opacity="0.75"
              />
              <path
                d="M64 236 Q60 244 65 252"
                stroke="#e6d9ff"
                stroke-width="0.8"
                fill="none"
              />

              <!-- One-way arrow -->
              <polyline
                points="226,92 248,80 260,102"
                fill="none"
                stroke="#e6d9ff"
                stroke-width="0.9"
              />
            </svg>
          </div>
        </div>

        <!-- Floating permit card teaser -->
        <div class="card-teaser" data-card="permit" style="
          position: absolute;
          left: 5%;
          bottom: 15%;
          width: 110px;
          opacity: 0.45;
          pointer-events: none;
          transform: rotate(-12deg);
          z-index: 10;
          background: rgba(0, 0, 0, 0.8);
          border: 1px solid rgba(255, 255, 255, 0.3);
          border-radius: 8px;
          padding: 3px;
        ">
          <svg xmlns="http://www.w3.org/2000/svg" width="420" height="600" viewBox="0 0 420 600" style="width: 100%; height: auto; display: block;">
            <rect width="420" height="600" fill="#000"/>
            <rect x="20" y="20" width="380" height="560" fill="none" stroke="#fff" stroke-width="1"/>

            <text x="210" y="55" font-family="EB Garamond,serif" font-weight="600" font-size="18" fill="#fff" text-anchor="middle" letter-spacing="3">MAJEUR DAO</text>
            <text x="210" y="75" font-family="EB Garamond,serif" font-size="11" fill="#fff" text-anchor="middle" letter-spacing="2">PERMIT</text>
            <line x1="40" y1="90" x2="380" y2="90" stroke="#fff" stroke-width="1"/>

            <text x="210" y="140" font-family="Courier Prime,monospace" font-size="9" fill="#fff" text-anchor="middle">___</text>
            <text x="210" y="151" font-family="Courier Prime,monospace" font-size="9" fill="#fff" text-anchor="middle">( o )</text>
            <text x="210" y="162" font-family="Courier Prime,monospace" font-size="9" fill="#fff" text-anchor="middle">| |</text>
            <text x="210" y="173" font-family="Courier Prime,monospace" font-size="9" fill="#fff" text-anchor="middle">| |</text>
            <text x="210" y="184" font-family="Courier Prime,monospace" font-size="9" fill="#fff" text-anchor="middle">====###====</text>
            <text x="210" y="195" font-family="Courier Prime,monospace" font-size="9" fill="#fff" text-anchor="middle">| |</text>
            <text x="210" y="206" font-family="Courier Prime,monospace" font-size="9" fill="#fff" text-anchor="middle">| |</text>
            <text x="210" y="217" font-family="Courier Prime,monospace" font-size="9" fill="#fff" text-anchor="middle">|_|</text>
            <line x1="40" y1="245" x2="380" y2="245" stroke="#fff" stroke-width="1"/>

            <text x="60" y="280" font-family="EB Garamond,serif" font-size="10" fill="#aaa" letter-spacing="1">Intent ID</text>
            <text x="60" y="297" font-family="Courier Prime,monospace" font-size="9" fill="#fff">1234...5678</text>
            <text x="60" y="330" font-family="EB Garamond,serif" font-size="10" fill="#aaa" letter-spacing="1">Total Supply</text>
            <text x="60" y="350" font-family="EB Garamond,serif" font-weight="600" font-size="14" fill="#fff">5</text>

            <text x="210" y="480" font-family="EB Garamond,serif" font-size="12" fill="#fff" text-anchor="middle" letter-spacing="2">ACTIVE</text>
            <line x1="40" y1="520" x2="380" y2="520" stroke="#fff" stroke-width="1"/>
          </svg>
        </div>
      </section>

      <!-- 04: FUTARCHY -->
      <section class="feature-page" id="futarchy">
        <div class="feature-inner">
          <div class="feature-left">
            <div class="feature-tag">Majeur Feature 04</div>
            <h2 class="feature-title" data-word="FUTARCHY">FUTARCHY</h2>
            <p class="feature-copy">
              Every proposal can grow a prediction market around it. Where each vote is a token. 
              Vote receipts double as long/short claims on a reward pool, auto-funded
              from shares or loot. When the proposal resolves YES or NO, the
              winning side burns receipts to cash out their slice of the pot.
            </p>
            <div class="feature-meta">
              Market-priced governance · Auto-funded pots
            </div>
          </div>

          <div class="feature-right">
            <svg
              class="feature-art"
              viewBox="0 0 320 320"
              xmlns="http://www.w3.org/2000/svg"
            >
              <!-- Axis -->
              <line
                x1="60"
                y1="240"
                x2="260"
                y2="240"
                stroke="#e6d9ff"
                stroke-width="0.8"
              />
              <line
                x1="80"
                y1="70"
                x2="80"
                y2="252"
                stroke="#e6d9ff"
                stroke-width="0.8"
              />

              <!-- Curves for YES / NO markets -->
              <path
                d="M80 220 C120 180 160 160 210 130"
                fill="none"
                stroke="#e6d9ff"
                stroke-width="1"
              />
              <path
                d="M80 230 C120 210 170 205 230 190"
                fill="none"
                stroke="#9d7bff"
                stroke-width="1"
                stroke-dasharray="5 6"
                opacity="0.9"
              />

              <!-- Outcome nodes -->
              <circle cx="214" cy="132" r="5" fill="#e6d9ff" />
              <circle cx="232" cy="190" r="4" fill="#9d7bff" />

              <!-- Proposal orbit -->
              <circle
                cx="160"
                cy="140"
                r="80"
                fill="none"
                stroke="#9d7bff"
                stroke-width="0.7"
                opacity="0.55"
              />
              <circle cx="160" cy="140" r="3" fill="#e6d9ff" />

              <!-- Pool glyph -->
              <rect
                x="196"
                y="212"
                width="60"
                height="18"
                rx="6"
                fill="none"
                stroke="#e6d9ff"
                stroke-width="0.8"
              />
              <line
                x1="202"
                y1="220"
                x2="248"
                y2="220"
                stroke="#e6d9ff"
                stroke-width="0.8"
              />
            </svg>
          </div>
        </div>

        <!-- Floating vote receipt cards teaser -->
        <div class="card-teaser" data-card="vote-yes" style="
          position: absolute;
          right: 8%;
          top: 15%;
          width: 100px;
          opacity: 0.55;
          pointer-events: none;
          transform: rotate(15deg);
          z-index: 10;
          background: rgba(0, 0, 0, 0.8);
          border: 1px solid rgba(0, 255, 0, 0.3);
          border-radius: 8px;
          padding: 3px;
        ">
          <svg xmlns="http://www.w3.org/2000/svg" width="420" height="640" viewBox="0 0 420 640" style="width: 100%; height: auto; display: block;">
            <rect width="420" height="640" fill="#000"/>

            <rect x="20" y="40" width="380" height="560" fill="none" stroke="#0f0" stroke-width="1"/>
            <text x="210" y="75" font-family="Garamond,serif" font-size="18" fill="#fff" text-anchor="middle">MAJEUR DAO</text>
            <text x="210" y="95" font-family="Garamond,serif" font-size="11" fill="#fff" text-anchor="middle">VOTE RECE%PT</text>
            <line x1="40" y1="110" x2="380" y2="110" stroke="#fff" stroke-width="1"/>

            <text x="210" y="155" font-family="monospace" font-size="9" fill="#0f0" text-anchor="middle">|</text>
            <text x="210" y="166" font-family="monospace" font-size="9" fill="#0f0" text-anchor="middle">/_\</text>
            <text x="210" y="177" font-family="monospace" font-size="9" fill="#0f0" text-anchor="middle">/   \</text>
            <text x="210" y="188" font-family="monospace" font-size="9" fill="#0f0" text-anchor="middle">|  *  |</text>
            <text x="210" y="199" font-family="monospace" font-size="9" fill="#0f0" text-anchor="middle">|     |</text>
            <text x="210" y="210" font-family="monospace" font-size="9" fill="#0f0" text-anchor="middle">|_____|</text>

            <text x="60" y="312" font-family="monospace" font-size="9" fill="#fff">1234...5678</text>
            <text x="60" y="365" font-family="Garamond,serif" font-size="14" fill="#0f0">YES</text>
            <text x="60" y="415" font-family="monospace" font-size="9" fill="#fff">10,000 votes</text>
            <text x="60" y="465" font-family="monospace" font-size="9" fill="#fff">Pool 10 ETH</text>
            <text x="210" y="530" font-family="Garamond,serif" font-size="12" fill="#0f0" text-anchor="middle">REDEEMABLE</text>
          </svg>
        </div>
        <div class="card-teaser" data-card="vote-no" style="
          position: absolute;
          left: 10%;
          bottom: 18%;
          width: 95px;
          opacity: 0.5;
          pointer-events: none;
          transform: rotate(-10deg);
          z-index: 10;
          background: rgba(0, 0, 0, 0.8);
          border: 1px solid rgba(255, 0, 0, 0.3);
          border-radius: 8px;
          padding: 3px;
        ">
          <svg xmlns="http://www.w3.org/2000/svg" width="420" height="640" viewBox="0 0 420 640" style="width: 100%; height: auto; display: block;">
            <rect width="420" height="640" fill="#000"/>

            <rect x="20" y="40" width="380" height="560" fill="none" stroke="#f00" stroke-width="1"/>
            <text x="210" y="75" font-family="Garamond,serif" font-size="18" fill="#fff" text-anchor="middle">MAJEUR DAO</text>
            <text x="210" y="95" font-family="Garamond,serif" font-size="11" fill="#fff" text-anchor="middle">VOTE RECEIPT</text>
            <line x1="40" y1="110" x2="380" y2="110" stroke="#fff" stroke-width="1"/>

            <text x="210" y="165" font-family="monospace" font-size="9" fill="#f00" text-anchor="middle">\       /</text>
            <text x="210" y="176" font-family="monospace" font-size="9" fill="#f00" text-anchor="middle"> \     / </text>
            <text x="210" y="187" font-family="monospace" font-size="9" fill="#f00" text-anchor="middle">  \     /</text>
            <text x="210" y="198" font-family="monospace" font-size="9" fill="#f00" text-anchor="middle">    X    </text>
            <text x="210" y="209" font-family="monospace" font-size="9" fill="#f00" text-anchor="middle">  /    \   </text>
            <text x="210" y="220" font-family="monospace" font-size="9" fill="#f00" text-anchor="middle"> /    s \ </text>
            <text x="210" y="231" font-family="monospace" font-size="9" fill="#f00" text-anchor="middle">/      \</text>

            <text x="60" y="312" font-family="monospace" font-size="9" fill="#fff">1234...5678</text>
            <text x="60" y="365" font-family="Garamond,serif" font-size="14" fill="#f00">NO</text>
            <text x="60" y="415" font-family="monospace" font-size="9" fill="#fff">5 000 votes</text>
            <text x="210" y="530" font-family="Garamond,serif" font-size="12" fill="#f00" text-anchor="middle">SEALED</text>
          </svg>
        </div>
      </section>

      <!-- 05: RAGEQUIT -->
      <section class="feature-page" id="ragequit">
        <div class="feature-inner">
          <div class="feature-left">
            <div class="feature-tag">Majeur Feature 05</div>
            <h2 class="feature-title" data-word="RAGEQUIT">RAGEQUIT</h2>
            <p class="feature-copy">
              Exit remains sacred. When ragequit is enabled, members burn shares
              and loot to pull a pro-rata slice of ETH and ERC-20 reserves,
              across a basket they choose.
            </p>
            <div class="feature-meta">
              Multi-asset exits · Shares + loot basis
            </div>
          </div>

          <div class="feature-right">
            <svg
              class="feature-art"
              viewBox="0 0 320 320"
              xmlns="http://www.w3.org/2000/svg"
            >
              <!-- Broken circle -->
              <path
                d="M90 160 A70 70 0 1 1 230 160"
                fill="none"
                stroke="#e6d9ff"
                stroke-width="1"
              />
              <path
                d="M90 160 A70 70 0 0 1 130 100"
                fill="none"
                stroke="#9d7bff"
                stroke-width="1.1"
              />

              <!-- Wedge leaving -->
              <path
                d="M160 90 L200 96 A70 70 0 0 0 182 70 Z"
                fill="none"
                stroke="#e6d9ff"
                stroke-width="0.9"
              />

              <!-- Asset bars -->
              <rect
                x="70"
                y="210"
                width="36"
                height="16"
                rx="4"
                fill="none"
                stroke="#e6d9ff"
                stroke-width="0.8"
              />
              <rect
                x="116"
                y="204"
                width="36"
                height="22"
                rx="4"
                fill="none"
                stroke="#9d7bff"
                stroke-width="0.8"
              />
              <rect
                x="162"
                y="214"
                width="36"
                height="12"
                rx="4"
                fill="none"
                stroke="#e6d9ff"
                stroke-width="0.8"
              />
              <rect
                x="208"
                y="208"
                width="36"
                height="20"
                rx="4"
                fill="none"
                stroke="#9d7bff"
                stroke-width="0.8"
              />

              <!-- Flow arrows -->
              <polyline
                points="132,190 132,176 90,176"
                fill="none"
                stroke="#e6d9ff"
                stroke-width="0.8"
              />
              <polyline
                points="180,188 180,172 222,172"
                fill="none"
                stroke="#e6d9ff"
                stroke-width="0.8"
              />
            </svg>
          </div>
        </div>
      </section>

      <!-- 06: SALE -->
      <section class="feature-page" id="sale">
        <div class="feature-inner">
          <div class="feature-left">
            <div class="feature-tag">Majeur Feature 06</div>
            <h2 class="feature-title" data-word="SALE">SALE (DAICO)</h2>
            <p class="feature-copy">
              Fixed-price sales live directly on the DAO. Governance chooses the
              pay token, price, caps, and whether new shares/loot are minted or
              sold from the treasury. No separate sale contracts, no extra
              attack surface – just one primitive wired into the core.
            </p>
            <div class="feature-meta">Treasury-aware sales · ETH or ERC-20</div>
          </div>

          <div class="feature-right">
            <svg
              class="feature-art"
              viewBox="0 0 320 320"
              xmlns="http://www.w3.org/2000/svg"
            >
              <!-- Coin stack -->
              <ellipse
                cx="120"
                cy="210"
                rx="34"
                ry="10"
                fill="none"
                stroke="#e6d9ff"
                stroke-width="0.9"
              />
              <ellipse
                cx="120"
                cy="198"
                rx="34"
                ry="10"
                fill="none"
                stroke="#e6d9ff"
                stroke-width="0.9"
              />
              <ellipse
                cx="120"
                cy="186"
                rx="34"
                ry="10"
                fill="none"
                stroke="#e6d9ff"
                stroke-width="0.9"
              />

              <!-- Price tag -->
              <rect
                x="184"
                y="140"
                width="60"
                height="32"
                rx="6"
                fill="none"
                stroke="#9d7bff"
                stroke-width="0.9"
              />
              <circle cx="192" cy="156" r="2.4" fill="#e6d9ff" />
              <path
                d="M202 160 H236"
                stroke="#e6d9ff"
                stroke-width="0.9"
                stroke-linecap="round"
              />
              <path
                d="M202 150 H230"
                stroke="#e6d9ff"
                stroke-width="0.9"
                stroke-linecap="round"
              />

              <!-- Flow arrows -->
              <polyline
                points="152,178 184,164 184,140"
                fill="none"
                stroke="#e6d9ff"
                stroke-width="0.9"
              />
              <polyline
                points="212,196 184,204 152,198"
                fill="none"
                stroke="#e6d9ff"
                stroke-width="0.9"
              />
            </svg>
          </div>
        </div>
      </section>

      <!-- 07: CHANT (SBT-gated chat) -->
      <section class="feature-page" id="chant">
        <div class="feature-inner">
          <div class="feature-left">
            <div class="feature-tag">Majeur Feature 07</div>
            <h2 class="feature-title" data-word="CHANT">CHANT</h2>
            <p class="feature-copy">
              A badge-gated message feed lives inside the contract. Only
              seat-holders can emit on-chain messages, but anyone can read the
              log. The chat becomes another programmable surface for the
              renderer: council graffiti, soft signaling, or just ritual noise.
            </p>
            <div class="feature-meta">
              SBT-gated chat · On-chain social layer
            </div>
          </div>

          <div class="feature-right">
            <svg
              class="feature-art"
              viewBox="0 0 320 320"
              xmlns="http://www.w3.org/2000/svg"
            >
              <!-- Dialog bubble -->
              <path
                d="M90 108 H222 A18 18 0 0 1 240 126 V170 A18 18 0 0 1 222 188 H146 L120 210 L122 188 H90 A18 18 0 0 1 72 170 V126 A18 18 0 0 1 90 108 Z"
                fill="none"
                stroke="#e6d9ff"
                stroke-width="1"
              />

              <!-- Lines -->
              <line
                x1="104"
                y1="132"
                x2="214"
                y2="132"
                stroke="#e6d9ff"
                stroke-width="0.9"
              />
              <line
                x1="104"
                y1="148"
                x2="196"
                y2="148"
                stroke="#e6d9ff"
                stroke-width="0.9"
              />
              <line
                x1="104"
                y1="164"
                x2="180"
                y2="164"
                stroke="#e6d9ff"
                stroke-width="0.9"
              />

              <!-- Orbiting runes -->
              <circle
                cx="80"
                cy="220"
                r="4"
                fill="none"
                stroke="#9d7bff"
                stroke-width="0.9"
              />
              <circle
                cx="240"
                cy="96"
                r="4"
                fill="none"
                stroke="#9d7bff"
                stroke-width="0.9"
              />
              <circle cx="92" cy="84" r="3" fill="#e6d9ff" opacity="0.9" />
              <circle cx="238" cy="214" r="3" fill="#e6d9ff" opacity="0.9" />

              <circle
                cx="160"
                cy="160"
                r="110"
                fill="none"
                stroke="#9d7bff"
                stroke-width="0.6"
                stroke-dasharray="6 10"
                opacity="0.4"
              />
            </svg>
          </div>
        </div>
      </section>
    </main>

    <!-- SUMMONER SECTION -->
    <section class="summoner-section" id="summoner">
      <div class="summoner-container">
        <h2 class="summoner-title">Summon DAO</h2>
        <p class="summoner-subtitle">Deploy your Moloch Majeur on Ethereum</p>
        
        <form id="summonForm">
          <!-- Basic Info -->
          <div class="form-group">
            <label class="form-label">DAO Name</label>
            <input type="text" class="form-input" id="daoName" placeholder="e.g., MetaGuild" required minlength="2" maxlength="50">
            <span class="form-hint">2-50 characters</span>
          </div>

          <div class="form-group">
            <label class="form-label">DAO Symbol</label>
            <input type="text" class="form-input" id="daoSymbol" placeholder="e.g., META" maxlength="10" required>
          </div>

          <!-- Quorum Settings -->
          <div class="form-group">
            <label class="form-label">Quorum %</label>
            <input type="number" class="form-input" id="quorumBps" placeholder="50" min="0" max="100" value="50">
            <small style="color: rgba(230, 217, 255, 0.5); font-size: 0.8rem;">Percentage of votes needed for proposal validity</small>
          </div>

          <!-- Members -->
          <div class="form-group">
            <label class="form-label">Founding Members</label>
            <div class="members-container">
              <div id="foundingMembersList">
                <!-- Initial member (connected wallet) will be added by JS -->
              </div>
              <button type="button" class="add-member-btn" onclick="addMemberRow()">+ Add Member</button>
            </div>
          </div>

          <!-- Advanced Settings -->
          <div class="advanced-toggle" onclick="toggleAdvanced()">
            ▼ Advanced Settings
          </div>

          <div class="advanced-settings" id="advancedSettings">
            <div class="form-group">
              <label class="form-label checkbox-group">
                <input type="checkbox" id="ragequittable" checked>
                <span>Enable Ragequit</span>
              </label>
              <small style="color: rgba(230, 217, 255, 0.5); font-size: 0.8rem;">Allow members to exit with pro-rata treasury</small>
            </div>

            <div class="form-group">
              <label class="form-label checkbox-group">
                <input type="checkbox" id="distributeLoot">
                <span>Distribute Loot to Founders</span>
              </label>
              <div id="lootDistribution" style="display: none; margin-top: 0.5rem;">
                <div style="margin-bottom: 0.5rem;">
                  <label class="form-label checkbox-group">
                    <input type="checkbox" id="equalLoot" checked>
                    <span style="font-size: 0.9rem;">Equal distribution</span>
                  </label>
                </div>
                <input type="number" class="form-input" id="lootPerMember" placeholder="100" value="100" min="0.000000000000000001" step="any">
                <small style="color: rgba(230, 217, 255, 0.5); font-size: 0.8rem;">Loot tokens per member (or total if custom)</small>
                <div id="customLootAmounts" style="margin-top: 1rem; display: none;">
                  <!-- Will be populated with inputs for each member -->
                </div>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Proposal TTL</label>
              <div style="display: flex; gap: 0.5rem; align-items: center;">
                <input type="number" class="form-input" id="proposalTTL" placeholder="7" value="7" style="flex: 1;">
                <select class="form-input" id="proposalTTLUnit" style="width: auto;">
                  <option value="86400" selected>Days</option>
                  <option value="3600">Hours</option>
                  <option value="60">Minutes</option>
                  <option value="1">Seconds</option>
                </select>
              </div>
              <small style="color: rgba(230, 217, 255, 0.5); font-size: 0.8rem;">Time until proposals expire</small>
            </div>

            <div class="form-group">
              <label class="form-label">Timelock Delay</label>
              <div style="display: flex; gap: 0.5rem; align-items: center;">
                <input type="number" class="form-input" id="timelockDelay" placeholder="1" value="1" style="flex: 1;">
                <select class="form-input" id="timelockDelayUnit" style="width: auto;">
                  <option value="86400" selected>Days</option>
                  <option value="3600">Hours</option>
                  <option value="60">Minutes</option>
                  <option value="1">Seconds</option>
                </select>
              </div>
              <small style="color: rgba(230, 217, 255, 0.5); font-size: 0.8rem;">Delay between proposal passing and execution</small>
            </div>

            <div class="form-group">
              <label class="form-label">Proposal Threshold (optional)</label>
              <input type="number" class="form-input" id="proposalThreshold" placeholder="0" min="0" step="1">
              <small style="color: rgba(230, 217, 255, 0.5); font-size: 0.8rem;">Minimum shares required to create a proposal (cannot exceed total initial shares)</small>
            </div>

            <div class="form-group">
              <label class="form-label">Contract URI (optional)</label>
              <input type="text" class="form-input" id="daoURI" placeholder="https://example.com/metadata.json or https://example.com/logo.svg">
              <small style="color: rgba(230, 217, 255, 0.5); font-size: 0.8rem;">JSON metadata URL or direct image URL (SVG, PNG, JPG, etc.)</small>
            </div>

            <div class="form-group">
              <label class="form-label">Initial ETH Deposit (optional)</label>
              <input type="number" class="form-input" id="initialEthDeposit" placeholder="0" min="0" step="any">
              <small style="color: rgba(230, 217, 255, 0.5); font-size: 0.8rem;">Amount of ETH to deposit into treasury during summoning</small>
            </div>

            <div class="form-group">
              <label class="form-label checkbox-group">
                <input type="checkbox" id="enableSharesTransfer">
                <span>Enable Shares Transferability</span>
              </label>
              <small style="color: rgba(230, 217, 255, 0.5); font-size: 0.8rem;">Allow shares to be transferred</small>
            </div>

            <div class="form-group">
              <label class="form-label checkbox-group">
                <input type="checkbox" id="enableLootTransfer">
                <span>Enable Loot Transferability</span>
              </label>
              <small style="color: rgba(230, 217, 255, 0.5); font-size: 0.8rem;">Allow loot to be transferred</small>
            </div>

            <div class="form-group">
              <label class="form-label">Auto-Futarchy (Voter Rewards)</label>
              <select class="form-input" id="autoFutarchyPreset">
                <option value="off" selected>Off</option>
                <option value="low">Low: 0.05% supply, 2 LOOT cap</option>
                <option value="standard">Standard: 0.1% supply, 5 LOOT cap</option>
                <option value="high">High: 0.5% supply, 10 LOOT cap</option>
              </select>
              <small style="color: rgba(230, 217, 255, 0.5); font-size: 0.8rem;">Mint LOOT rewards for winning voters (% of shares+loot supply, capped per proposal)</small>
            </div>

            <div class="form-group">
              <label class="form-label">Initial Token Sale (DAICO)</label>
              <select class="form-input" id="initialSalePreset" onchange="toggleSaleConfig()">
                <option value="off" selected>Off (No initial sale)</option>
                <option value="custom">Custom Sale Configuration</option>
              </select>
              <small style="color: rgba(230, 217, 255, 0.5); font-size: 0.8rem;">Launch with an active token sale for fundraising</small>
            </div>

            <div id="saleConfigSection" style="display: none; margin-top: 1rem; padding: 1rem; background: rgba(157, 123, 255, 0.05); border: 1px solid rgba(157, 123, 255, 0.2); border-radius: 4px;">
              <div class="form-group">
                <label class="form-label">Payment Token (18-decimal only)</label>
                <div style="position: relative;">
                  <div id="salePaymentTokenDisplay" onclick="toggleSalePaymentTokenDropdown()"
                       style="width: 100%; padding: 0.7rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 0.9rem; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                    <div style="width: 24px; height: 24px; flex-shrink: 0;" id="salePaymentTokenIcon"></div>
                    <span id="salePaymentTokenLabel">DAI</span>
                  </div>
                  <div id="salePaymentTokenDropdown" class="custom-dropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 0.25rem; background: rgba(10, 0, 21, 0.95); border: 1px solid rgba(157, 123, 255, 0.4); border-radius: 4px; z-index: 1000; backdrop-filter: blur(10px);">
                    <div onclick="selectSalePaymentToken('dai')" style="padding: 0.7rem; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='rgba(157, 123, 255, 0.2)'" onmouseout="this.style.background='transparent'">
                      <div style="width: 24px; height: 24px; flex-shrink: 0;" class="token-dropdown-icon" data-token="dai"></div>
                      <span style="color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 0.9rem;">DAI</span>
                    </div>
                    <div onclick="selectSalePaymentToken('custom')" style="padding: 0.7rem; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; transition: background 0.2s; border-top: 1px solid rgba(157, 123, 255, 0.2);" onmouseover="this.style.background='rgba(157, 123, 255, 0.2)'" onmouseout="this.style.background='transparent'">
                      <div style="width: 24px; height: 24px; flex-shrink: 0;" class="token-dropdown-icon" data-token="defaultCoin"></div>
                      <span style="color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 0.9rem;">Custom Token</span>
                    </div>
                  </div>
                  <input type="hidden" class="form-input" id="salePaymentToken" value="dai">
                </div>
                <small style="color: rgba(230, 217, 255, 0.5); font-size: 0.8rem;">Use DAI for simple 1:1 pricing (1 DAI = 1 Share at cheapest). Custom token for upgrade paths.</small>
              </div>

              <div class="form-group" id="customTokenFields" style="display: none;">
                <label class="form-label">Custom Token Address</label>
                <input type="text" class="form-input" id="customTokenAddress" placeholder="0x...">
                <small style="color: rgba(230, 217, 255, 0.5); font-size: 0.8rem;">Must be an 18-decimal ERC20 token</small>
              </div>

              <div class="form-group">
                <label class="form-label">Token Type</label>
                <select class="form-input" id="saleTokenType">
                  <option value="shares">Shares (voting power)</option>
                  <option value="loot">Loot (non-voting)</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label">Price Ratio (DAI per Share/Loot)</label>
                <input type="number" class="form-input" id="salePrice" placeholder="1" step="1" min="1">
                <small style="color: rgba(230, 217, 255, 0.5); font-size: 0.8rem;">Simple integer pricing: "1" means 1 DAI = 1 Share (or custom token). Use "2" for 2 DAI per Share, etc.</small>
              </div>

              <div class="form-group">
                <label class="form-label">Sale Cap (optional)</label>
                <input type="number" class="form-input" id="saleCap" placeholder="0 for unlimited" step="any" min="0">
                <small style="color: rgba(230, 217, 255, 0.5); font-size: 0.8rem;">Maximum tokens to sell (0 = unlimited)</small>
              </div>

              <div id="summonerSaleHint" style="display: none; margin-top: 0.5rem; padding: 0.75rem; background: rgba(157, 123, 255, 0.15); border-left: 3px solid #9d7bff; font-size: 0.85rem; color: #e6d9ff; font-family: 'EB Garamond', serif; line-height: 1.5;">
                <strong style="color: #9d7bff;">Sale Preview:</strong> <span id="summonerSaleHintText"></span>
              </div>

              <div id="upgradePathHint" style="display: none; margin-top: 0.5rem; padding: 0.75rem; background: rgba(157, 123, 255, 0.05); border-left: 3px solid rgba(157, 123, 255, 0.3); font-size: 0.8rem; color: rgba(230, 217, 255, 0.8); font-family: 'EB Garamond', serif; line-height: 1.5;">
                <strong style="color: #9d7bff;">Token Upgrade Path:</strong> With 1:1 pricing and ragequit enabled, users can upgrade their tokens to DAO shares, then burn shares to reclaim tokens if desired, lowering risk.
              </div>

              <div class="form-group">
                <label class="form-label checkbox-group">
                  <input type="checkbox" id="saleMinting" checked>
                  <span>Mint New Tokens</span>
                </label>
                <small style="color: rgba(230, 217, 255, 0.5); font-size: 0.8rem;">If unchecked, will sell from DAO treasury (requires pre-allocated tokens)</small>
              </div>
            </div>
          </div>

          <button type="submit" class="summon-button" id="summonBtn" disabled>
            CONNECT WALLET TO SUMMON
          </button>
        </form>

        <div id="statusMessage"></div>
      </div>
    </section>

    <!-- PURCHASE MODAL -->
    <div class="wallet-modal-overlay" id="purchaseModal">
      <div class="wallet-modal" style="max-width: 500px;">
        <div class="wallet-modal-header">
          <h3 style="font-family: 'Cinzel', serif; font-size: 1.2rem; color: #e6d9ff; letter-spacing: 0.1em;">Purchase Tokens</h3>
          <button onclick="closePurchaseModal()" style="background: none; border: none; color: rgba(230, 217, 255, 0.6); cursor: pointer; font-size: 1.5rem;">&times;</button>
        </div>
        <div style="padding: 1.5rem;">
          <div id="purchaseModalContent"></div>
        </div>
      </div>
    </div>

    <!-- DAO GALLERY SECTION -->
    <section class="dao-gallery-section" id="daoGallery">
      <div class="dao-gallery-header">
        <h2 class="dao-gallery-title">Your DAOs</h2>
        <p class="dao-gallery-subtitle">Majeur organizations you belong to</p>
      </div>
      <div class="dao-tiles" id="daoTiles">
        <!-- DAO tiles will be dynamically rendered here -->
      </div>
    </section>

    <!-- ALL DAOS GALLERY SECTION -->
    <section class="all-daos-section" id="allDaosGallery">
      <div class="all-daos-header">
        <h2 class="all-daos-title">All DAOs</h2>
        <p class="all-daos-subtitle">Explore all Majeur organizations</p>
      </div>
      <div class="dao-tiles" id="allDaosTiles">
        <!-- All DAO tiles will be dynamically rendered here -->
      </div>
    </section>

    <!-- DAO DASHBOARD SECTION -->
    <section class="dao-dashboard" id="daoDashboard">
      <div class="dao-dashboard-header">
        <div style="display: flex; align-items: center; gap: 1rem;">
          <div id="daoEmblem" class="dao-emblem" style="display: none;" title="DAO Contract URI">
            <!-- DAO emblem will be rendered here -->
          </div>
          <div>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <h2 class="dao-dashboard-title" id="dashboardTitle">DAO Dashboard</h2>
              <button
                onclick="manualRefreshDAO()"
                id="refreshButton"
                title="Refresh DAO state"
                style="background: none; border: none; color: rgba(157, 123, 255, 0.6); cursor: pointer; padding: 0.25rem; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease;"
                onmouseover="this.style.color='#9d7bff'; this.style.transform='rotate(90deg)';"
                onmouseout="this.style.color='rgba(157, 123, 255, 0.6)'; this.style.transform='rotate(0deg)';">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="23 4 23 10 17 10"></polyline>
                  <polyline points="1 20 1 14 7 14"></polyline>
                  <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                </svg>
              </button>
            </div>
            <a class="dao-etherscan-link" id="daoEtherscanLink" href="#" target="_blank" rel="noopener noreferrer">
              <span id="daoAddressText">0x...</span>
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                <polyline points="15 3 21 3 21 9"></polyline>
                <line x1="10" y1="14" x2="21" y2="3"></line>
              </svg>
            </a>
            <div class="dao-stats-bar" id="daoStatsBar">
              <!-- Stats will be dynamically rendered here -->
            </div>
          </div>
        </div>
        <button class="back-button" onclick="backToGallery()">← Back to Gallery</button>
      </div>

      <!-- View Toggle -->
      <div class="dao-view-toggle">
        <button class="view-toggle-btn active" id="viewToggleDao" onclick="switchDaoView('dao')">DAO Dashboard</button>
        <button class="view-toggle-btn" id="viewToggleMembership" onclick="switchDaoView('membership')">My Membership</button>
        <button class="view-toggle-btn" id="viewToggleMembers" onclick="switchDaoView('members')">Members</button>
      </div>

      <!-- DAO Dashboard Content -->
      <div class="dao-dashboard-content show" id="daoDashboardView">
        <!-- Chatroom Panel -->
        <div class="dao-panel">
          <h3 class="dao-panel-title">Chatroom</h3>
          <div class="chatroom-messages" id="chatroomMessages">
            <!-- Messages will be dynamically rendered here -->
          </div>
          <div class="chatroom-send">
            <input
              type="text"
              id="chatInput"
              class="chatroom-input"
              placeholder="Type a message..."
            />
            <button class="chatroom-button" onclick="sendChatMessage()">Send</button>
          </div>

          <!-- Treasury Section -->
          <div class="treasury-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <h4 class="treasury-title" style="margin-bottom: 0;">Treasury</h4>
              <button onclick="openDepositModal()" class="deposit-button" title="Deposit assets to treasury">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </button>
            </div>
            <div class="treasury-assets" id="treasuryAssets">
              <!-- Treasury assets will be dynamically rendered here -->
            </div>
            <button class="ragequit-button" onclick="openRagequitModal()">Ragequit</button>
          </div>

          <!-- Governance Info Section -->
          <div class="treasury-section" style="margin-top: 1.5rem;">
            <h4 class="treasury-title">Governance</h4>
            <div id="governanceInfo" style="font-size: 0.85rem; color: rgba(230, 217, 255, 0.8); line-height: 1.6;">
              <!-- Governance info will be dynamically rendered here -->
            </div>
          </div>

          <!-- Sales Section -->
          <div id="salesSection" class="treasury-section" style="margin-top: 1.5rem; display: none;">
            <h4 class="treasury-title">
              Active Sales
              <a href="#" onclick="event.preventDefault(); prepareSaleProposal(); switchDaoView('dao');" title="Configure token sale" onmouseover="this.style.opacity='1'; this.style.transform='translateY(-1px)';" onmouseout="this.style.opacity='0.5'; this.style.transform='translateY(0)';" style="margin-left: 0.5rem; color: #9d7bff; opacity: 0.5; transition: all 0.2s; font-size: 0.75rem; text-decoration: none;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle;">
                  <circle cx="9" cy="21" r="1"></circle>
                  <circle cx="20" cy="21" r="1"></circle>
                  <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                </svg>
              </a>
            </h4>
            <div id="salesInfo">
              <!-- Active sales will be dynamically rendered here -->
            </div>
          </div>
        </div>

        <!-- Proposals Panel -->
        <div class="dao-panel">
          <h3 class="dao-panel-title">Proposals</h3>

          <!-- New Proposal Form -->
          <div class="proposal-form">
            <h4 class="proposal-form-title">Create Proposal</h4>
            <input type="hidden" id="proposalOp" value="0" />
            <div class="proposal-form-group">
              <label class="proposal-form-label">Target Address</label>
              <input type="text" id="proposalTo" class="proposal-form-input" placeholder="0x..." oninput="updateTargetAddressHint()" />
              <div id="targetAddressHint" style="margin-top: 0.35rem; display: none;">
                <span id="targetAddressHintBadge" style="display: inline-block; padding: 0.25rem 0.5rem; background: rgba(157, 123, 255, 0.15); border: 1px solid rgba(157, 123, 255, 0.3); border-radius: 3px; font-size: 0.7rem; color: #9d7bff; font-family: 'Cinzel', serif; letter-spacing: 0.1em;"></span>
              </div>
            </div>
            <div class="proposal-form-group" id="proposalValueGroup">
              <label class="proposal-form-label">Value (ETH)</label>
              <input type="text" id="proposalValue" class="proposal-form-input" placeholder="0" />
            </div>
            <div class="proposal-form-group">
              <label class="proposal-form-label">Data (hex)</label>
              <input type="text" id="proposalData" class="proposal-form-input" placeholder="0x" oninput="updateCalldataPreview(); updateCalldataTranslation();" />
              <div id="calldataTranslation" style="margin-top: 0.5rem; display: none; padding: 0.75rem; background: rgba(157, 123, 255, 0.1); border-left: 3px solid #9d7bff; font-size: 0.85rem;"></div>
              <div id="calldataPreview" style="margin-top: 0.5rem; display: none;">
                <a id="calldataPreviewLink" href="#" target="_blank" rel="noopener noreferrer"
                   style="font-size: 0.75rem; color: #9d7bff; text-decoration: none; display: inline-flex; align-items: center; gap: 0.35rem; opacity: 0.75; transition: opacity 0.3s ease;"
                   onmouseover="this.style.opacity='1'"
                   onmouseout="this.style.opacity='0.75'">
                  <span>🔍</span> Decode calldata on SwissKnife
                </a>
              </div>
            </div>
            <div class="proposal-form-group">
              <label class="proposal-form-label">Description</label>
              <textarea id="proposalDescription" class="proposal-form-input proposal-form-textarea" placeholder="Describe the proposal..."></textarea>
            </div>
            <div id="proposalTTLInfo" style="margin-bottom: 0.75rem; padding: 0.65rem; background: rgba(157, 123, 255, 0.08); border-left: 3px solid rgba(157, 123, 255, 0.4); border-radius: 2px; display: none;">
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="opacity: 0.7; flex-shrink: 0;">
                  <circle cx="12" cy="12" r="10"></circle>
                  <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                <span id="proposalTTLInfoText" style="font-size: 0.8rem; color: rgba(230, 217, 255, 0.75); line-height: 1.4;"></span>
              </div>
            </div>
            <button class="chatroom-button" onclick="createProposal()">Create & Publish</button>
          </div>

          <!-- Proposals List -->
          <div id="proposalsList">
            <!-- Proposals will be dynamically rendered here -->
          </div>
        </div>
      </div>

      <!-- Membership Dashboard Content -->
      <div class="dao-membership-content" id="daoMembershipView">
        <div class="membership-grid">
          <!-- Badge Card -->
          <div class="badge-card">
            <h3 class="dao-panel-title">Member Badge</h3>
            <div id="badgeContent">
              <p style="text-align: center; color: rgba(230, 217, 255, 0.6); font-style: italic;">Loading...</p>
            </div>
          </div>

          <!-- Balances Card -->
          <div class="balance-card">
            <h3 class="dao-panel-title">Your Balances</h3>
            <div class="balance-item">
              <div class="balance-label">
                Voting Shares
                <a id="sharesEtherscanLink" href="#" target="_blank" rel="noopener noreferrer" style="margin-left: 0.35rem; color: #9d7bff; opacity: 0.7; transition: all 0.2s; display: none;">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                    <polyline points="15 3 21 3 21 9"></polyline>
                    <line x1="10" y1="14" x2="21" y2="3"></line>
                  </svg>
                </a>
                <a href="#" onclick="event.preventDefault(); prepareMintProposal('shares'); switchDaoView('dao');" title="Create mint shares proposal" onmouseover="this.style.opacity='1'; this.style.transform='translateY(-1px)';" onmouseout="this.style.opacity='0.5'; this.style.transform='translateY(0)';" style="margin-left: 0.35rem; color: #9d7bff; opacity: 0.5; transition: all 0.2s; font-size: 0.75rem; text-decoration: none;">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle;">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="16"></line>
                    <line x1="8" y1="12" x2="16" y2="12"></line>
                  </svg>
                </a>
              </div>
              <div class="balance-value" id="membershipShares">0</div>
            </div>
            <div class="balance-item">
              <div class="balance-label">
                Loot
                <a id="lootEtherscanLink" href="#" target="_blank" rel="noopener noreferrer" style="margin-left: 0.35rem; color: #9d7bff; opacity: 0.7; transition: all 0.2s; display: none;">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                    <polyline points="15 3 21 3 21 9"></polyline>
                    <line x1="10" y1="14" x2="21" y2="3"></line>
                  </svg>
                </a>
                <a href="#" onclick="event.preventDefault(); prepareMintProposal('loot'); switchDaoView('dao');" title="Create mint loot proposal" onmouseover="this.style.opacity='1'; this.style.transform='translateY(-1px)';" onmouseout="this.style.opacity='0.5'; this.style.transform='translateY(0)';" style="margin-left: 0.35rem; color: #9d7bff; opacity: 0.5; transition: all 0.2s; font-size: 0.75rem; text-decoration: none;">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle;">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="16"></line>
                    <line x1="8" y1="12" x2="16" y2="12"></line>
                  </svg>
                </a>
              </div>
              <div class="balance-value" id="membershipLoot">0</div>
            </div>
            <div class="balance-item">
              <div class="balance-label">
                Badge Seat
                <a id="badgeEtherscanLink" href="#" target="_blank" rel="noopener noreferrer" style="margin-left: 0.35rem; color: #9d7bff; opacity: 0.7; transition: all 0.2s; display: none;">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                    <polyline points="15 3 21 3 21 9"></polyline>
                    <line x1="10" y1="14" x2="21" y2="3"></line>
                  </svg>
                </a>
              </div>
              <div class="balance-value" id="membershipBadge">None</div>
            </div>
          </div>
        </div>

        <!-- Vote Receipts Panel -->
        <div class="receipts-panel">
          <h3 class="dao-panel-title">Vote Receipts Collection</h3>
          <div id="receiptsGrid" class="receipts-grid">
            <!-- Receipt cards will be dynamically rendered here -->
          </div>
        </div>
      </div>

      <!-- Members List Content -->
      <div class="dao-members-content" id="daoMembersView">
        <div class="members-panel">
          <div class="members-header">
            <h3 class="dao-panel-title">DAO Members</h3>
            <div class="members-stats">
              <div class="members-stat">
                <span class="members-stat-label">Total Members:</span>
                <span class="members-stat-value" id="memberCount">0</span>
              </div>
              <div class="members-stat">
                <span class="members-stat-label">Badge Holders:</span>
                <span class="members-stat-value" id="badgeHolderCount">0</span>
              </div>
            </div>
          </div>
          <div class="members-list" id="membersList">
            <!-- Members will be dynamically rendered here -->
          </div>
        </div>
      </div>
    </section>

    <!-- Modal for NFT viewing -->
    <div id="nftModal" class="nft-modal" onclick="closeNFTModal()">
      <div class="nft-modal-content" onclick="event.stopPropagation()">
        <button class="nft-modal-close" onclick="closeNFTModal()">&times;</button>
        <div id="nftModalBody" class="nft-modal-body">
          <!-- NFT content will be dynamically rendered here -->
        </div>
      </div>
    </div>

    <!-- Web3 Integration Script -->
    <script>
      // HTML escape function to prevent XSS attacks
      function escapeHtml(unsafe) {
        if (!unsafe) return '';
        return String(unsafe)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }

      // Mobile viewport height fix for handling browser chrome
      function setVhProperty() {
        const vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
      }

      // Set on load
      setVhProperty();

      // Debounced resize handler for performance
      let resizeTimeout;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          setVhProperty();
          // Dispatch resize event for other components that need it
          window.dispatchEvent(new Event('optimizedResize'));
        }, 150);
      }, { passive: true });

      // Check for reduced motion preference
      const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

      // Lazy loading for images
      if ('IntersectionObserver' in window) {
        const imageObserver = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              const img = entry.target;
              img.src = img.dataset.src || img.src;
              imageObserver.unobserve(img);
            }
          });
        });
        document.querySelectorAll('img[data-src]').forEach(img => imageObserver.observe(img));
      }

      // Scroll-synced SVG animations for feature pages
      (function initFeatureAnimations() {
        // Skip animations if user prefers reduced motion
        if (prefersReducedMotion) return;

        const featurePages = document.querySelectorAll('.feature-page');
        let scrollProgress = new Map();
        let animationFrameId = null;

        // Calculate scroll progress for each feature page (0 to 1)
        function calculateScrollProgress(element) {
          const rect = element.getBoundingClientRect();
          const windowHeight = window.innerHeight;

          // Element enters from bottom and exits from top
          const start = windowHeight;
          const end = -rect.height;
          const range = start - end;
          const current = rect.top;

          // Progress: 0 when element is below viewport, 1 when above
          const progress = Math.max(0, Math.min(1, (start - current) / range));
          return progress;
        }

        // Apply animations based on scroll progress
        function applyAnimations() {
          featurePages.forEach((page) => {
            const progress = calculateScrollProgress(page);
            scrollProgress.set(page, progress);

            const svg = page.querySelector('.feature-art');
            if (!svg) return;

            const featureId = page.id;

            // SEATS: Rotate circles and radial ticks
            if (featureId === 'seats') {
              const circles = svg.querySelectorAll('circle');
              const groups = svg.querySelectorAll('g');

              const rotation = progress * 360 * 2; // 2 full rotations

              // Rotate the outer circle (r="120")
              circles.forEach(circle => {
                const r = circle.getAttribute('r');
                if (r === '120') {
                  circle.style.transformOrigin = 'center';
                  circle.style.transform = `rotate(${rotation}deg)`;
                } else if (r === '84') {
                  // Rotate inner circle in opposite direction
                  circle.style.transformOrigin = 'center';
                  circle.style.transform = `rotate(${-rotation * 0.7}deg)`;
                }
              });

              // Rotate radial ticks (the g with stroke and lines)
              groups.forEach(g => {
                if (g.getAttribute('stroke') === '#e6d9ff' && g.querySelector('line')) {
                  g.style.transformOrigin = '160 160';
                  g.style.transform = `rotate(${rotation * 0.5}deg)`;
                }
                // Rotate orbiting dots group
                if (g.getAttribute('fill') === '#e6d9ff' && g.querySelectorAll('circle').length > 0) {
                  g.style.transformOrigin = '160 160';
                  g.style.transform = `rotate(${rotation}deg)`;
                }
              });
            }

            // SPLIT: Animate paths with dash offset and rotate BPS ring
            if (featureId === 'split') {
              const paths = svg.querySelectorAll('path[stroke="#e6d9ff"]');
              const bpsRing = svg.querySelector('circle[stroke-dasharray]');

              paths.forEach((path) => {
                try {
                  const length = path.getTotalLength();
                  path.style.strokeDasharray = length;
                  path.style.strokeDashoffset = length * (1 - progress);
                } catch (e) {
                  // Skip if getTotalLength fails
                }
              });

              if (bpsRing) {
                const rotation = progress * 360;
                bpsRing.style.transformOrigin = 'center';
                bpsRing.style.transform = `rotate(${rotation}deg)`;
              }
            }

            // PERMIT: Rotate keyhole and pulse burn triangle
            if (featureId === 'permit') {
              const allElements = svg.querySelectorAll('*');
              const rotation = progress * 360 * 1.5; // More rotation

              allElements.forEach(el => {
                const cx = el.getAttribute('cx');
                const cy = el.getAttribute('cy');
                const r = el.getAttribute('r');

                // Rotate keyhole outer circle (cx="160" cy="132" r="13")
                if (cx === '160' && cy === '132' && r === '13') {
                  el.style.transformOrigin = '160 132';
                  el.style.transform = `rotate(${rotation}deg)`;
                }

                // Rotate keyhole dot (cx="160" cy="128" r="4")
                if (cx === '160' && cy === '128' && r === '4') {
                  const orbit = Math.sin(progress * Math.PI * 2) * 8;
                  el.style.transformOrigin = '160 132';
                  el.style.transform = `rotate(${rotation * 2}deg)`;
                }

                // Rotate tablet frames
                if (el.tagName === 'rect') {
                  const x = el.getAttribute('x');
                  if (x === '90' || x === '102') {
                    const tilt = Math.sin(progress * Math.PI) * 3;
                    el.style.transformOrigin = '160 160';
                    el.style.transform = `rotate(${tilt}deg)`;
                  }
                }

                // Pulse burn triangle
                if (el.tagName === 'polygon') {
                  const scale = 1 + Math.sin(progress * Math.PI * 4) * 0.15;
                  const glow = 0.75 + Math.sin(progress * Math.PI * 4) * 0.25;
                  el.style.transformOrigin = '64 244';
                  el.style.transform = `scale(${scale})`;
                  el.style.opacity = glow;
                }

                // Bounce one-way arrow
                if (el.tagName === 'polyline') {
                  const bounce = Math.sin(progress * Math.PI * 3) * 8;
                  el.style.transform = `translate(${bounce}, ${-bounce * 0.5})`;
                }
              });

              // Animate hash lines with draw effect
              const hashGroup = svg.querySelector('g[stroke="#9d7bff"]');
              if (hashGroup) {
                const lines = hashGroup.querySelectorAll('line');
                lines.forEach((line, i) => {
                  const x1 = parseFloat(line.getAttribute('x1'));
                  const x2 = parseFloat(line.getAttribute('x2'));
                  const length = x2 - x1;
                  const drawProgress = Math.max(0, Math.min(1, progress * 2 - i * 0.2));

                  line.style.strokeDasharray = length;
                  line.style.strokeDashoffset = length * (1 - drawProgress);
                });
              }
            }

            // FUTARCHY: Animate curves and rotate proposal orbit
            if (featureId === 'futarchy') {
              const allElements = svg.querySelectorAll('*');
              const rotation = progress * 360;

              allElements.forEach(el => {
                const cx = el.getAttribute('cx');
                const cy = el.getAttribute('cy');
                const r = el.getAttribute('r');
                const d = el.getAttribute('d');
                const x1 = el.getAttribute('x1');
                const y1 = el.getAttribute('y1');

                // Draw axis lines progressively
                if (el.tagName === 'line') {
                  const lineX1 = parseFloat(x1);
                  const lineY1 = parseFloat(y1);

                  // Horizontal axis (y1="240")
                  if (lineY1 === 240) {
                    const length = parseFloat(el.getAttribute('x2')) - lineX1;
                    const drawProgress = Math.max(0, Math.min(1, progress * 1.5));
                    el.style.strokeDasharray = length;
                    el.style.strokeDashoffset = length * (1 - drawProgress);
                  }

                  // Vertical axis (x1="80")
                  if (lineX1 === 80 && lineY1 < 240) {
                    const length = parseFloat(el.getAttribute('y2')) - lineY1;
                    const drawProgress = Math.max(0, Math.min(1, progress * 1.5));
                    el.style.strokeDasharray = length;
                    el.style.strokeDashoffset = length * (1 - drawProgress);
                  }

                  // Pool glyph line
                  if (x1 === '202') {
                    const scale = 1 + Math.sin(progress * Math.PI * 3) * 0.2;
                    el.style.transformOrigin = '225 220';
                    el.style.transform = `scaleX(${scale})`;
                  }
                }

                // Rotate proposal orbit circle (cx="160" cy="140" r="80")
                if (cx === '160' && cy === '140' && r === '80') {
                  el.style.transformOrigin = '160 140';
                  el.style.transform = `rotate(${rotation}deg)`;
                }

                // Rotate center dot (cx="160" cy="140" r="3")
                if (cx === '160' && cy === '140' && r === '3') {
                  const pulse = 1 + Math.sin(progress * Math.PI * 3) * 0.5;
                  el.style.transformOrigin = 'center';
                  el.style.transform = `scale(${pulse})`;
                }

                // Pulse outcome nodes with glow effect
                if (el.tagName === 'circle') {
                  const cxVal = parseFloat(cx);
                  const cyVal = parseFloat(cy);

                  // Node at (214, 132)
                  if (cxVal === 214 && cyVal === 132) {
                    const pulse = 1 + Math.sin(progress * Math.PI * 4) * 0.6;
                    const opacity = 1 + Math.sin(progress * Math.PI * 4) * 0.5;
                    el.style.transformOrigin = 'center';
                    el.style.transform = `scale(${pulse})`;
                    el.style.opacity = Math.min(1, opacity);
                  }

                  // Node at (232, 190)
                  if (cxVal === 232 && cyVal === 190) {
                    const pulse = 1 + Math.sin(progress * Math.PI * 4 + Math.PI) * 0.6;
                    const opacity = 1 + Math.sin(progress * Math.PI * 4 + Math.PI) * 0.5;
                    el.style.transformOrigin = 'center';
                    el.style.transform = `scale(${pulse})`;
                    el.style.opacity = Math.min(1, opacity);
                  }
                }

                // Animate market curves with progressive drawing AND wave motion
                if (el.tagName === 'path' && d && d.includes('C')) {
                  const startsWith80 = d.startsWith('M80');

                  if (startsWith80) {
                    try {
                      const pathLength = el.getTotalLength();
                      const waveOffset = Math.sin(progress * Math.PI * 3) * 10;

                      // First curve (YES market) - solid line
                      if (d.includes('210 130')) {
                        const drawProgress = Math.max(0, Math.min(1, progress * 1.8));
                        el.style.strokeDasharray = pathLength;
                        el.style.strokeDashoffset = pathLength * (1 - drawProgress);
                        el.style.transform = `translate(0, ${waveOffset})`;
                      }
                      // Second curve (NO market) - dashed line
                      else if (d.includes('230 190')) {
                        const drawProgress = Math.max(0, Math.min(1, (progress - 0.1) * 1.8));
                        el.style.strokeDasharray = `5 6, ${pathLength}`;
                        el.style.strokeDashoffset = pathLength * (1 - drawProgress);
                        el.style.transform = `translate(0, ${-waveOffset})`;
                      }
                    } catch (e) {
                      // Fallback to wave only if getTotalLength fails
                      const waveOffset = Math.sin(progress * Math.PI * 3) * 10;
                      if (d.includes('210 130')) {
                        el.style.transform = `translate(0, ${waveOffset})`;
                      } else if (d.includes('230 190')) {
                        el.style.transform = `translate(0, ${-waveOffset})`;
                      }
                    }
                  }
                }

                // Animate pool glyph rectangle with tilt
                if (el.tagName === 'rect' && el.getAttribute('x') === '196') {
                  const scale = 1 + Math.sin(progress * Math.PI * 3) * 0.12;
                  const tilt = Math.sin(progress * Math.PI * 2) * 3;
                  el.style.transformOrigin = 'center';
                  el.style.transform = `scale(${scale}) rotate(${tilt}deg)`;
                }
              });
            }

            // RAGEQUIT: Rotate broken circle and slide asset bars
            if (featureId === 'ragequit') {
              const brokenCircle = svg.querySelectorAll('path[d*="A70"]');
              const wedge = svg.querySelector('path[d*="Z"]');
              const assetBars = svg.querySelectorAll('rect[rx="4"]');

              const rotation = progress * 180;

              brokenCircle.forEach((arc) => {
                arc.style.transformOrigin = '160 160';
                arc.style.transform = `rotate(${rotation * 0.3}deg)`;
              });

              if (wedge) {
                const distance = progress * 20;
                wedge.style.transform = `translate(${distance}, ${-distance})`;
              }

              assetBars.forEach((bar, i) => {
                const offset = Math.sin(progress * Math.PI + i * 0.5) * 2;
                bar.style.transform = `translate(0, ${offset})`;
              });
            }

            // SALE: Rotate coin stack and animate flow arrows
            if (featureId === 'sale') {
              const coinEllipses = svg.querySelectorAll('ellipse');
              const flowArrows = svg.querySelectorAll('polyline');
              const priceTag = svg.querySelector('rect[x="184"]');

              const rotation = progress * 360;

              coinEllipses.forEach((ellipse, i) => {
                ellipse.style.transformOrigin = 'center';
                ellipse.style.transform = `rotate(${rotation * (1 + i * 0.1)}deg)`;
              });

              flowArrows.forEach((arrow) => {
                try {
                  const length = arrow.getTotalLength();
                  arrow.style.strokeDasharray = length;
                  arrow.style.strokeDashoffset = length * (1 - progress);
                } catch (e) {
                  // Skip if getTotalLength fails
                }
              });

              if (priceTag) {
                const scale = 1 + Math.sin(progress * Math.PI * 3) * 0.05;
                priceTag.style.transformOrigin = 'center';
                priceTag.style.transform = `scale(${scale})`;
              }
            }

            // CHANT: Rotate orbiting elements and pulse dialog
            if (featureId === 'chant') {
              const circles = svg.querySelectorAll('circle');
              const dialogBubble = svg.querySelector('path[d*="Z"]');
              const textLines = svg.querySelectorAll('line');
              const dashedCircle = svg.querySelector('circle[stroke-dasharray]');

              const rotation = progress * 360;

              // Rotate the large dashed circle (orbit ring)
              if (dashedCircle) {
                dashedCircle.style.transformOrigin = 'center';
                dashedCircle.style.transform = `rotate(${rotation * 0.5}deg)`;
              }

              // Rotate orbiting rune circles around center
              circles.forEach(circle => {
                const r = circle.getAttribute('r');
                const cx = parseFloat(circle.getAttribute('cx'));
                const cy = parseFloat(circle.getAttribute('cy'));
                const fill = circle.getAttribute('fill');
                const stroke = circle.getAttribute('stroke');

                // Small orbiting circles (not the big dashed one)
                if ((r === '4' || r === '3') && cx !== 160) {
                  circle.style.transformOrigin = '160 160';
                  circle.style.transform = `rotate(${rotation}deg)`;
                }
              });

              // Pulse dialog bubble
              if (dialogBubble) {
                const scale = 1 + Math.sin(progress * Math.PI * 3) * 0.04;
                dialogBubble.style.transformOrigin = '156 149';
                dialogBubble.style.transform = `scale(${scale})`;
              }

              // Animate text lines with typing effect
              textLines.forEach((line, i) => {
                const x1 = parseFloat(line.getAttribute('x1'));
                const x2 = parseFloat(line.getAttribute('x2'));
                const length = x2 - x1;
                const offset = Math.max(0, length * (1 - (progress * 3 - i * 0.3)));

                if (progress * 3 > i * 0.3) {
                  line.style.strokeDasharray = length;
                  line.style.strokeDashoffset = offset;
                }
              });
            }
          });
        }

        // Smooth animation loop
        function animate() {
          applyAnimations();
          animationFrameId = requestAnimationFrame(animate);
        }

        // Start animations when DOM is ready
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', () => {
            animate();
          });
        } else {
          animate();
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
          if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
          }
        });
      })();

      // Scroll Journey Line Animation
      (function initScrollJourneyLine() {
        const journeyLineContainer = document.getElementById('journey-line-container');
        const journeyLine = document.getElementById('journey-line');
        const journeyEndpoint = document.getElementById('journey-endpoint');
        const radialGroup = document.getElementById('radial-group');
        const introPanel = document.querySelector('.intro-panel');
        const summonerSection = document.getElementById('summoner');

        if (!journeyLine || !journeyLineContainer || !introPanel || !summonerSection) return;

        function updateJourneyLine() {
          const scrollY = window.scrollY;
          const windowHeight = window.innerHeight;
          const docHeight = document.documentElement.scrollHeight;

          // Get section positions
          const introPanelRect = introPanel.getBoundingClientRect();
          const introPanelTop = window.pageYOffset + introPanelRect.top;
          const introPanelBottom = introPanelTop + introPanelRect.height;

          const summonerRect = summonerSection.getBoundingClientRect();
          const summonerTop = window.pageYOffset + summonerRect.top;
          const summonerBottom = summonerTop + summonerRect.height;

          // Radial convergence: fade out radials as we scroll past intro
          const introProgress = Math.max(0, Math.min(1, (scrollY - introPanelTop) / introPanelRect.height));
          if (radialGroup) {
            radialGroup.style.opacity = Math.max(0, 0.8 * (1 - introProgress * 1.2));
          }

          // Check if summoner is in viewport (hide line when form is visible)
          const summonerInView = summonerRect.top < windowHeight && summonerRect.bottom > 0;

          // Show journey line when past intro but before summoner
          if (scrollY >= introPanelBottom - windowHeight && !summonerInView) {
            journeyLineContainer.style.opacity = '1';

            // Calculate progress from intro bottom to summoner top
            const journeyStart = introPanelBottom;
            const journeyEnd = summonerTop;
            const journeyLength = journeyEnd - journeyStart;

            // Use current scroll position to determine line progress
            const currentScroll = scrollY + windowHeight * 0.6; // Slightly ahead of center
            const lineProgress = Math.max(0, Math.min(1, (currentScroll - journeyStart) / journeyLength));

            // Grow the line from top based on progress
            journeyLine.style.height = `${lineProgress * 100}%`;

            // Show endpoint when approaching summoner (last 20% of journey)
            if (lineProgress > 0.8 && !summonerInView) {
              const endpointProgress = (lineProgress - 0.8) / 0.2;
              journeyEndpoint.style.opacity = endpointProgress;

              // Pulse the endpoint
              const pulse = 1 + Math.sin(Date.now() * 0.003) * 0.3;
              journeyEndpoint.style.width = `${12 * pulse}px`;
              journeyEndpoint.style.height = `${12 * pulse}px`;
            } else {
              journeyEndpoint.style.opacity = '0';
            }
          }
          // Fade out when summoner comes into view
          else if (summonerInView) {
            // Calculate fade based on how far summoner has scrolled into view
            const summonerProgress = Math.max(0, Math.min(1, (windowHeight - summonerRect.top) / (windowHeight * 0.3)));
            journeyLineContainer.style.opacity = Math.max(0, 1 - summonerProgress);
            journeyEndpoint.style.opacity = '0';
          }
          // Before intro: hide journey line, show radials
          else {
            journeyLineContainer.style.opacity = '0';
            journeyLine.style.height = '0%';
            journeyEndpoint.style.opacity = '0';
          }
        }

        // Update on scroll with debounce
        let scrollTimeout;
        let rafId;

        function onScroll() {
          if (scrollTimeout) clearTimeout(scrollTimeout);
          scrollTimeout = setTimeout(updateJourneyLine, 5);
        }

        // Animation loop for smooth pulsing endpoint
        function animate() {
          // Only update the pulse, not the whole line (for performance)
          const journeyEndpointOpacity = parseFloat(journeyEndpoint.style.opacity);
          if (journeyEndpointOpacity > 0) {
            const pulse = 1 + Math.sin(Date.now() * 0.003) * 0.3;
            journeyEndpoint.style.width = `${12 * pulse}px`;
            journeyEndpoint.style.height = `${12 * pulse}px`;
          }
          rafId = requestAnimationFrame(animate);
        }

        window.addEventListener('scroll', onScroll, { passive: true });
        window.addEventListener('resize', updateJourneyLine);

        // Initial setup and start animation
        updateJourneyLine();
        animate();

        // Cleanup
        window.addEventListener('beforeunload', () => {
          if (rafId) cancelAnimationFrame(rafId);
        });
      })();

      // Card Teaser Parallax Animation
      (function initCardTeasers() {
        // Skip animations if user prefers reduced motion
        if (prefersReducedMotion) return;

        const cardTeasers = document.querySelectorAll('.card-teaser');
        if (cardTeasers.length === 0) return;

        // Store initial opacity for each card
        const initialOpacities = new Map();
        cardTeasers.forEach(card => {
          const computedStyle = window.getComputedStyle(card);
          initialOpacities.set(card, parseFloat(computedStyle.opacity) || 0.4);
        });

        function updateCardPositions() {
          cardTeasers.forEach(card => {
            const cardType = card.getAttribute('data-card');
            const featurePage = card.closest('.feature-page');
            if (!featurePage) return;

            const rect = featurePage.getBoundingClientRect();
            const windowHeight = window.innerHeight;

            // Check if feature page is in viewport
            if (rect.top < windowHeight && rect.bottom > 0) {
              // Calculate progress (0 to 1) as page scrolls through viewport
              const progress = Math.max(0, Math.min(1,
                (windowHeight - rect.top) / (windowHeight + rect.height)
              ));

              // Different movement patterns based on card type
              let translateY = 0;
              let translateX = 0;
              let rotation = 0;
              let scale = 1;

              switch(cardType) {
                case 'badge':
                  // Gentle downward drift with slight rotation
                  translateY = progress * 40;
                  translateX = Math.sin(progress * Math.PI) * 15;
                  rotation = 8 + progress * 12;
                  scale = 1 + progress * 0.08;
                  break;

                case 'permit':
                  // Upward float with swing
                  translateY = -progress * 35;
                  translateX = Math.sin(progress * Math.PI * 2) * 12;
                  rotation = -12 + Math.sin(progress * Math.PI) * 10;
                  scale = 1 + progress * 0.05;
                  break;

                case 'vote-yes':
                  // Diagonal drift down-right
                  translateY = progress * 45;
                  translateX = progress * 25;
                  rotation = 15 - progress * 10;
                  scale = 1 + progress * 0.12;
                  break;

                case 'vote-no':
                  // Diagonal drift up-left
                  translateY = -progress * 40;
                  translateX = -progress * 20;
                  rotation = -10 + progress * 15;
                  scale = 1 + progress * 0.08;
                  break;
              }

              // Apply transforms
              card.style.transform = `
                translate(${translateX}px, ${translateY}px)
                rotate(${rotation}deg)
                scale(${scale})
              `;

              // Fade in/out based on progress
              const fadeInProgress = Math.min(1, progress * 3);
              const fadeOutProgress = Math.max(0, 1 - (progress - 0.65) * 3);
              const baseOpacity = initialOpacities.get(card) || 0.4;
              card.style.opacity = baseOpacity * fadeInProgress * fadeOutProgress;
            }
          });
        }

        // Update on scroll with throttle
        let scrollTicking = false;
        window.addEventListener('scroll', () => {
          if (!scrollTicking) {
            window.requestAnimationFrame(() => {
              updateCardPositions();
              scrollTicking = false;
            });
            scrollTicking = true;
          }
        }, { passive: true });

        // Initial update
        updateCardPositions();
      })();

      // Auto-save form data to prevent loss
      const formInputs = {};
      function saveToLocalStorage() {
        const formData = {
          daoName: document.getElementById('daoName')?.value || '',
          daoSymbol: document.getElementById('daoSymbol')?.value || '',
          orgURI: document.getElementById('orgURI')?.value || '',
          quorum: document.getElementById('quorum')?.value || '50',
          timestamp: Date.now()
        };
        try {
          localStorage.setItem(CONSTANTS.STORAGE_KEY_SUMMON, JSON.stringify(formData));
        } catch (e) {
          if (e.name === 'QuotaExceededError') {
            console.error('localStorage quota exceeded - draft not saved');
            // Silent failure acceptable for draft auto-save
          } else {
            console.error('Failed to save draft:', e);
          }
        }
      }

      // Restore form data on page load
      document.addEventListener('DOMContentLoaded', () => {
        try {
          const saved = localStorage.getItem(CONSTANTS.STORAGE_KEY_SUMMON);
          if (saved) {
            const data = JSON.parse(saved);
            // Only restore if less than 24 hours old
            if (Date.now() - data.timestamp < CONSTANTS.DRAFT_RETENTION_MS) {
              if (document.getElementById('daoName')) document.getElementById('daoName').value = data.daoName || '';
              if (document.getElementById('daoSymbol')) document.getElementById('daoSymbol').value = data.daoSymbol || '';
              if (document.getElementById('orgURI')) document.getElementById('orgURI').value = data.orgURI || '';
              if (document.getElementById('quorum')) {
                document.getElementById('quorum').value = data.quorum || '50';
                document.getElementById('quorumValue').textContent = (data.quorum || '50') + '%';
              }
            }
          }
        } catch (e) {
          console.warn('Could not restore form data');
        }
      });

      // Debounced form saving
      let saveTimeout;
      document.addEventListener('input', (e) => {
        if (e.target.closest('#summonForm')) {
          clearTimeout(saveTimeout);
          saveTimeout = setTimeout(saveToLocalStorage, 1000);
        }
      });

      // Enhanced error handling with user-friendly messages
      window.addEventListener('error', (e) => {
        console.error('Application error:', e);
        // Could show a user-friendly error notification here
      });

      // Network status monitoring
      let isOnline = navigator.onLine;
      window.addEventListener('online', () => {
        isOnline = true;
      });
      window.addEventListener('offline', () => {
        isOnline = false;
        console.warn('Network connection lost');
        alert('Network connection lost. Please check your internet connection.');
      });
      const SUMMONER_ADDRESS = '0x0000000000330B8df9E3bc5E553074DA58eE9138';
      const SUMMONER_ABI = [
        {
          "inputs": [
            {"internalType": "string", "name": "orgName", "type": "string"},
            {"internalType": "string", "name": "orgSymbol", "type": "string"},
            {"internalType": "string", "name": "orgURI", "type": "string"},
            {"internalType": "uint16", "name": "quorumBps", "type": "uint16"},
            {"internalType": "bool", "name": "ragequittable", "type": "bool"},
            {"internalType": "address", "name": "renderer", "type": "address"},
            {"internalType": "bytes32", "name": "salt", "type": "bytes32"},
            {"internalType": "address[]", "name": "initHolders", "type": "address[]"},
            {"internalType": "uint256[]", "name": "initShares", "type": "uint256[]"},
            {"components": [
              {"internalType": "address", "name": "target", "type": "address"},
              {"internalType": "uint256", "name": "value", "type": "uint256"},
              {"internalType": "bytes", "name": "data", "type": "bytes"}
            ], "internalType": "struct Call[]", "name": "initCalls", "type": "tuple[]"}
          ],
          "name": "summon",
          "outputs": [{"internalType": "contract Moloch", "name": "dao", "type": "address"}],
          "stateMutability": "payable",
          "type": "function"
        }
      ];

      const VIEW_HELPER_ADDRESS = '0x000000000066317bd3662A649D8901c076268Df9';
      const VIEW_HELPER_ABI = [
        {
          "inputs": [
            {"internalType": "address", "name": "user", "type": "address"},
            {"internalType": "uint256", "name": "daoStart", "type": "uint256"},
            {"internalType": "uint256", "name": "daoCount", "type": "uint256"},
            {"internalType": "uint256", "name": "proposalStart", "type": "uint256"},
            {"internalType": "uint256", "name": "proposalCount", "type": "uint256"},
            {"internalType": "uint256", "name": "messageStart", "type": "uint256"},
            {"internalType": "uint256", "name": "messageCount", "type": "uint256"}
          ],
          "name": "getUserDAOsFullState",
          "outputs": [
            {
              "components": [
                {
                  "components": [
                    {"internalType": "address", "name": "dao", "type": "address"},
                    {
                      "components": [
                        {"internalType": "string", "name": "name", "type": "string"},
                        {"internalType": "string", "name": "symbol", "type": "string"},
                        {"internalType": "string", "name": "contractURI", "type": "string"},
                        {"internalType": "address", "name": "sharesToken", "type": "address"},
                        {"internalType": "address", "name": "lootToken", "type": "address"},
                        {"internalType": "address", "name": "badgesToken", "type": "address"},
                        {"internalType": "address", "name": "renderer", "type": "address"}
                      ],
                      "internalType": "struct DAOMeta",
                      "name": "meta",
                      "type": "tuple"
                    },
                    {
                      "components": [
                        {"internalType": "uint96", "name": "proposalThreshold", "type": "uint96"},
                        {"internalType": "uint96", "name": "minYesVotesAbsolute", "type": "uint96"},
                        {"internalType": "uint96", "name": "quorumAbsolute", "type": "uint96"},
                        {"internalType": "uint64", "name": "proposalTTL", "type": "uint64"},
                        {"internalType": "uint64", "name": "timelockDelay", "type": "uint64"},
                        {"internalType": "uint16", "name": "quorumBps", "type": "uint16"},
                        {"internalType": "bool", "name": "ragequittable", "type": "bool"},
                        {"internalType": "uint256", "name": "autoFutarchyParam", "type": "uint256"},
                        {"internalType": "uint256", "name": "autoFutarchyCap", "type": "uint256"},
                        {"internalType": "address", "name": "rewardToken", "type": "address"}
                      ],
                      "internalType": "struct DAOGovConfig",
                      "name": "gov",
                      "type": "tuple"
                    },
                    {
                      "components": [
                        {"internalType": "uint256", "name": "sharesTotalSupply", "type": "uint256"},
                        {"internalType": "uint256", "name": "lootTotalSupply", "type": "uint256"},
                        {"internalType": "uint256", "name": "sharesHeldByDAO", "type": "uint256"},
                        {"internalType": "uint256", "name": "lootHeldByDAO", "type": "uint256"}
                      ],
                      "internalType": "struct DAOTokenSupplies",
                      "name": "supplies",
                      "type": "tuple"
                    },
                    {
                      "components": [
                        {"internalType": "uint256", "name": "eth", "type": "uint256"},
                        {"internalType": "uint256", "name": "usdc", "type": "uint256"},
                        {"internalType": "uint256", "name": "usdt", "type": "uint256"},
                        {"internalType": "uint256", "name": "dai", "type": "uint256"},
                        {"internalType": "uint256", "name": "wsteth", "type": "uint256"},
                        {"internalType": "uint256", "name": "reth", "type": "uint256"}
                      ],
                      "internalType": "struct DAOTreasury",
                      "name": "treasury",
                      "type": "tuple"
                    },
                    {
                      "components": [
                        {"internalType": "address", "name": "account", "type": "address"},
                        {"internalType": "uint256", "name": "shares", "type": "uint256"},
                        {"internalType": "uint256", "name": "loot", "type": "uint256"},
                        {"internalType": "uint16", "name": "seatId", "type": "uint16"},
                        {"internalType": "uint256", "name": "votingPower", "type": "uint256"},
                        {"internalType": "address[]", "name": "delegates", "type": "address[]"},
                        {"internalType": "uint32[]", "name": "delegatesBps", "type": "uint32[]"}
                      ],
                      "internalType": "struct MemberView[]",
                      "name": "members",
                      "type": "tuple[]"
                    },
                    {
                      "components": [
                        {"internalType": "uint256", "name": "id", "type": "uint256"},
                        {"internalType": "address", "name": "proposer", "type": "address"},
                        {"internalType": "uint8", "name": "state", "type": "uint8"},
                        {"internalType": "uint48", "name": "snapshotBlock", "type": "uint48"},
                        {"internalType": "uint64", "name": "createdAt", "type": "uint64"},
                        {"internalType": "uint64", "name": "queuedAt", "type": "uint64"},
                        {"internalType": "uint256", "name": "supplySnapshot", "type": "uint256"},
                        {"internalType": "uint96", "name": "forVotes", "type": "uint96"},
                        {"internalType": "uint96", "name": "againstVotes", "type": "uint96"},
                        {"internalType": "uint96", "name": "abstainVotes", "type": "uint96"},
                        {
                          "components": [
                            {"internalType": "bool", "name": "enabled", "type": "bool"},
                            {"internalType": "address", "name": "rewardToken", "type": "address"},
                            {"internalType": "uint256", "name": "pool", "type": "uint256"},
                            {"internalType": "bool", "name": "resolved", "type": "bool"},
                            {"internalType": "uint8", "name": "winner", "type": "uint8"},
                            {"internalType": "uint256", "name": "finalWinningSupply", "type": "uint256"},
                            {"internalType": "uint256", "name": "payoutPerUnit", "type": "uint256"}
                          ],
                          "internalType": "struct FutarchyView",
                          "name": "futarchy",
                          "type": "tuple"
                        },
                        {
                          "components": [
                            {"internalType": "address", "name": "voter", "type": "address"},
                            {"internalType": "uint8", "name": "support", "type": "uint8"},
                            {"internalType": "uint256", "name": "weight", "type": "uint256"}
                          ],
                          "internalType": "struct VoterView[]",
                          "name": "voters",
                          "type": "tuple[]"
                        }
                      ],
                      "internalType": "struct ProposalView[]",
                      "name": "proposals",
                      "type": "tuple[]"
                    },
                    {
                      "components": [
                        {"internalType": "uint256", "name": "index", "type": "uint256"},
                        {"internalType": "string", "name": "text", "type": "string"}
                      ],
                      "internalType": "struct MessageView[]",
                      "name": "messages",
                      "type": "tuple[]"
                    }
                  ],
                  "internalType": "struct DAOLens",
                  "name": "dao",
                  "type": "tuple"
                },
                {
                  "components": [
                    {"internalType": "address", "name": "account", "type": "address"},
                    {"internalType": "uint256", "name": "shares", "type": "uint256"},
                    {"internalType": "uint256", "name": "loot", "type": "uint256"},
                    {"internalType": "uint16", "name": "seatId", "type": "uint16"},
                    {"internalType": "uint256", "name": "votingPower", "type": "uint256"},
                    {"internalType": "address[]", "name": "delegates", "type": "address[]"},
                    {"internalType": "uint32[]", "name": "delegatesBps", "type": "uint32[]"}
                  ],
                  "internalType": "struct MemberView",
                  "name": "member",
                  "type": "tuple"
                }
              ],
              "internalType": "struct UserDAOLens[]",
              "name": "out",
              "type": "tuple[]"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [
            {"internalType": "uint256", "name": "daoStart", "type": "uint256"},
            {"internalType": "uint256", "name": "daoCount", "type": "uint256"},
            {"internalType": "uint256", "name": "proposalStart", "type": "uint256"},
            {"internalType": "uint256", "name": "proposalCount", "type": "uint256"},
            {"internalType": "uint256", "name": "messageStart", "type": "uint256"},
            {"internalType": "uint256", "name": "messageCount", "type": "uint256"}
          ],
          "name": "getDAOsFullState",
          "outputs": [
            {
              "components": [
                {"internalType": "address", "name": "dao", "type": "address"},
                {
                  "components": [
                    {"internalType": "string", "name": "name", "type": "string"},
                    {"internalType": "string", "name": "symbol", "type": "string"},
                    {"internalType": "string", "name": "contractURI", "type": "string"},
                    {"internalType": "address", "name": "sharesToken", "type": "address"},
                    {"internalType": "address", "name": "lootToken", "type": "address"},
                    {"internalType": "address", "name": "badgesToken", "type": "address"},
                    {"internalType": "address", "name": "renderer", "type": "address"}
                  ],
                  "internalType": "struct DAOMeta",
                  "name": "meta",
                  "type": "tuple"
                },
                {
                  "components": [
                    {"internalType": "uint96", "name": "proposalThreshold", "type": "uint96"},
                    {"internalType": "uint96", "name": "minYesVotesAbsolute", "type": "uint96"},
                    {"internalType": "uint96", "name": "quorumAbsolute", "type": "uint96"},
                    {"internalType": "uint64", "name": "proposalTTL", "type": "uint64"},
                    {"internalType": "uint64", "name": "timelockDelay", "type": "uint64"},
                    {"internalType": "uint16", "name": "quorumBps", "type": "uint16"},
                    {"internalType": "bool", "name": "ragequittable", "type": "bool"},
                    {"internalType": "uint256", "name": "autoFutarchyParam", "type": "uint256"},
                    {"internalType": "uint256", "name": "autoFutarchyCap", "type": "uint256"},
                    {"internalType": "address", "name": "rewardToken", "type": "address"}
                  ],
                  "internalType": "struct DAOGovConfig",
                  "name": "gov",
                  "type": "tuple"
                },
                {
                  "components": [
                    {"internalType": "uint256", "name": "sharesTotalSupply", "type": "uint256"},
                    {"internalType": "uint256", "name": "lootTotalSupply", "type": "uint256"},
                    {"internalType": "uint256", "name": "sharesHeldByDAO", "type": "uint256"},
                    {"internalType": "uint256", "name": "lootHeldByDAO", "type": "uint256"}
                  ],
                  "internalType": "struct DAOTokenSupplies",
                  "name": "supplies",
                  "type": "tuple"
                },
                {
                  "components": [
                    {"internalType": "uint256", "name": "eth", "type": "uint256"},
                    {"internalType": "uint256", "name": "usdc", "type": "uint256"},
                    {"internalType": "uint256", "name": "usdt", "type": "uint256"},
                    {"internalType": "uint256", "name": "dai", "type": "uint256"},
                    {"internalType": "uint256", "name": "wsteth", "type": "uint256"},
                    {"internalType": "uint256", "name": "reth", "type": "uint256"}
                  ],
                  "internalType": "struct DAOTreasury",
                  "name": "treasury",
                  "type": "tuple"
                },
                {
                  "components": [
                    {"internalType": "address", "name": "account", "type": "address"},
                    {"internalType": "uint256", "name": "shares", "type": "uint256"},
                    {"internalType": "uint256", "name": "loot", "type": "uint256"},
                    {"internalType": "uint16", "name": "seatId", "type": "uint16"},
                    {"internalType": "uint256", "name": "votingPower", "type": "uint256"},
                    {"internalType": "address[]", "name": "delegates", "type": "address[]"},
                    {"internalType": "uint32[]", "name": "delegatesBps", "type": "uint32[]"}
                  ],
                  "internalType": "struct MemberView[]",
                  "name": "members",
                  "type": "tuple[]"
                },
                {
                  "components": [
                    {"internalType": "uint256", "name": "id", "type": "uint256"},
                    {"internalType": "address", "name": "proposer", "type": "address"},
                    {"internalType": "uint8", "name": "state", "type": "uint8"},
                    {"internalType": "uint48", "name": "snapshotBlock", "type": "uint48"},
                    {"internalType": "uint64", "name": "createdAt", "type": "uint64"},
                    {"internalType": "uint64", "name": "queuedAt", "type": "uint64"},
                    {"internalType": "uint256", "name": "supplySnapshot", "type": "uint256"},
                    {"internalType": "uint96", "name": "forVotes", "type": "uint96"},
                    {"internalType": "uint96", "name": "againstVotes", "type": "uint96"},
                    {"internalType": "uint96", "name": "abstainVotes", "type": "uint96"},
                    {
                      "components": [
                        {"internalType": "bool", "name": "enabled", "type": "bool"},
                        {"internalType": "address", "name": "rewardToken", "type": "address"},
                        {"internalType": "uint256", "name": "pool", "type": "uint256"},
                        {"internalType": "bool", "name": "resolved", "type": "bool"},
                        {"internalType": "uint8", "name": "winner", "type": "uint8"},
                        {"internalType": "uint256", "name": "finalWinningSupply", "type": "uint256"},
                        {"internalType": "uint256", "name": "payoutPerUnit", "type": "uint256"}
                      ],
                      "internalType": "struct FutarchyView",
                      "name": "futarchy",
                      "type": "tuple"
                    },
                    {
                      "components": [
                        {"internalType": "address", "name": "voter", "type": "address"},
                        {"internalType": "uint8", "name": "support", "type": "uint8"},
                        {"internalType": "uint256", "name": "weight", "type": "uint256"}
                      ],
                      "internalType": "struct VoterView[]",
                      "name": "voters",
                      "type": "tuple[]"
                    }
                  ],
                  "internalType": "struct ProposalView[]",
                  "name": "proposals",
                  "type": "tuple[]"
                },
                {
                  "components": [
                    {"internalType": "uint256", "name": "index", "type": "uint256"},
                    {"internalType": "string", "name": "text", "type": "string"}
                  ],
                  "internalType": "struct MessageView[]",
                  "name": "messages",
                  "type": "tuple[]"
                }
              ],
              "internalType": "struct DAOLens[]",
              "name": "out",
              "type": "tuple[]"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        }
      ];

      const MOLOCH_ABI = [
        {
          "inputs": [{"internalType": "uint256", "name": "id", "type": "uint256"}],
          "name": "openProposal",
          "outputs": [],
          "stateMutability": "nonpayable",
          "type": "function"
        },
        {
          "inputs": [{"internalType": "string", "name": "message", "type": "string"}],
          "name": "chat",
          "outputs": [],
          "stateMutability": "payable",
          "type": "function"
        },
        {
          "inputs": [
            {"internalType": "uint8", "name": "op", "type": "uint8"},
            {"internalType": "address", "name": "to", "type": "address"},
            {"internalType": "uint256", "name": "value", "type": "uint256"},
            {"internalType": "bytes", "name": "data", "type": "bytes"},
            {"internalType": "bytes32", "name": "nonce", "type": "bytes32"}
          ],
          "name": "executeByVotes",
          "outputs": [
            {"internalType": "bool", "name": "ok", "type": "bool"},
            {"internalType": "bytes", "name": "retData", "type": "bytes"}
          ],
          "stateMutability": "payable",
          "type": "function"
        },
        {
          "inputs": [
            {"internalType": "uint256", "name": "id", "type": "uint256"},
            {"internalType": "uint8", "name": "support", "type": "uint8"}
          ],
          "name": "castVote",
          "outputs": [],
          "stateMutability": "nonpayable",
          "type": "function"
        },
        {
          "inputs": [{"internalType": "uint256", "name": "id", "type": "uint256"}],
          "name": "cancelVote",
          "outputs": [],
          "stateMutability": "nonpayable",
          "type": "function"
        },
        {
          "inputs": [
            {"internalType": "uint256", "name": "", "type": "uint256"},
            {"internalType": "address", "name": "", "type": "address"}
          ],
          "name": "hasVoted",
          "outputs": [{"internalType": "uint8", "name": "", "type": "uint8"}],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [],
          "name": "config",
          "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [{"internalType": "bytes[]", "name": "data", "type": "bytes[]"}],
          "name": "multicall",
          "outputs": [{"internalType": "bytes[]", "name": "results", "type": "bytes[]"}],
          "stateMutability": "nonpayable",
          "type": "function"
        },
        {
          "inputs": [
            {"internalType": "address[]", "name": "tokens", "type": "address[]"},
            {"internalType": "uint256", "name": "sharesToBurn", "type": "uint256"},
            {"internalType": "uint256", "name": "lootToBurn", "type": "uint256"}
          ],
          "name": "ragequit",
          "outputs": [],
          "stateMutability": "nonpayable",
          "type": "function"
        },
        {
          "inputs": [
            {"internalType": "address", "name": "receiver", "type": "address"},
            {"internalType": "uint256", "name": "id", "type": "uint256"},
            {"internalType": "uint256", "name": "amount", "type": "uint256"}
          ],
          "name": "transfer",
          "outputs": [{"internalType": "bool", "name": "", "type": "bool"}],
          "stateMutability": "nonpayable",
          "type": "function"
        },
        {
          "inputs": [
            {"internalType": "uint256", "name": "id", "type": "uint256"},
            {"internalType": "uint256", "name": "amount", "type": "uint256"}
          ],
          "name": "cashOutFutarchy",
          "outputs": [{"internalType": "uint256", "name": "payout", "type": "uint256"}],
          "stateMutability": "nonpayable",
          "type": "function"
        },
        {
          "inputs": [
            {"internalType": "address", "name": "owner", "type": "address"},
            {"internalType": "uint256", "name": "id", "type": "uint256"}
          ],
          "name": "balanceOf",
          "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [],
          "name": "badges",
          "outputs": [{"internalType": "address", "name": "", "type": "address"}],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [],
          "name": "shares",
          "outputs": [{"internalType": "address", "name": "", "type": "address"}],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [],
          "name": "loot",
          "outputs": [{"internalType": "address", "name": "", "type": "address"}],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [{"internalType": "uint256", "name": "id", "type": "uint256"}],
          "name": "tokenURI",
          "outputs": [{"internalType": "string", "name": "", "type": "string"}],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [],
          "name": "contractURI",
          "outputs": [{"internalType": "string", "name": "", "type": "string"}],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [{"internalType": "address", "name": "payToken", "type": "address"}],
          "name": "sales",
          "outputs": [
            {"internalType": "uint256", "name": "pricePerShare", "type": "uint256"},
            {"internalType": "uint256", "name": "cap", "type": "uint256"},
            {"internalType": "bool", "name": "minting", "type": "bool"},
            {"internalType": "bool", "name": "active", "type": "bool"},
            {"internalType": "bool", "name": "isLoot", "type": "bool"}
          ],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [
            {"internalType": "address", "name": "payToken", "type": "address"},
            {"internalType": "uint256", "name": "pricePerShare", "type": "uint256"},
            {"internalType": "uint256", "name": "cap", "type": "uint256"},
            {"internalType": "bool", "name": "minting", "type": "bool"},
            {"internalType": "bool", "name": "active", "type": "bool"},
            {"internalType": "bool", "name": "isLoot", "type": "bool"}
          ],
          "name": "setSale",
          "outputs": [],
          "stateMutability": "payable",
          "type": "function"
        },
        {
          "inputs": [
            {"internalType": "address", "name": "payToken", "type": "address"},
            {"internalType": "uint256", "name": "shareAmount", "type": "uint256"},
            {"internalType": "uint256", "name": "maxPay", "type": "uint256"}
          ],
          "name": "buyShares",
          "outputs": [],
          "stateMutability": "payable",
          "type": "function"
        }
      ];

      // ERC20 ABI for token interactions
      const ERC20_ABI = [
        {
          "inputs": [{"internalType": "address", "name": "owner", "type": "address"}, {"internalType": "address", "name": "spender", "type": "address"}],
          "name": "allowance",
          "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [{"internalType": "address", "name": "spender", "type": "address"}, {"internalType": "uint256", "name": "amount", "type": "uint256"}],
          "name": "approve",
          "outputs": [{"internalType": "bool", "name": "", "type": "bool"}],
          "stateMutability": "nonpayable",
          "type": "function"
        },
        {
          "inputs": [{"internalType": "address", "name": "account", "type": "address"}],
          "name": "balanceOf",
          "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [],
          "name": "decimals",
          "outputs": [{"internalType": "uint8", "name": "", "type": "uint8"}],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [],
          "name": "name",
          "outputs": [{"internalType": "string", "name": "", "type": "string"}],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [],
          "name": "symbol",
          "outputs": [{"internalType": "string", "name": "", "type": "string"}],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [{"internalType": "address", "name": "to", "type": "address"}, {"internalType": "uint256", "name": "amount", "type": "uint256"}],
          "name": "transfer",
          "outputs": [{"internalType": "bool", "name": "", "type": "bool"}],
          "stateMutability": "nonpayable",
          "type": "function"
        }
      ];

      // Constants for minimal proxy pattern (from Solidity reference)
      const CLONE_PREFIX = '0x602d5f8160095f39f35f5f365f5f37365f73';
      const CLONE_SUFFIX = '0x5af43d5f5f3e6029573d5ffd5b3d5ff3';

      // Implementation addresses
      const IMPLEMENTATIONS = {
        moloch: '0x643A45B599D81be3f3a68F37EB3De55fF10673C1',
        badges: '0x71e9b38d301b5a58cb998c1295045fe276acf600',
        shares: '0x47c175ce83b6b931ccbedd5ce95e701984ed96d5',
        loot: '0x6f1f2aF76a3aDD953277e9F369242697C87bc6A5'
      };

      // Token addresses from MolochViewHelper
      const TOKEN_ADDRESSES = {
        usdc: '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48',
        usdt: '0xdAC17F958D2ee523a2206206994597C13D831ec7',
        dai: '0x6B175474E89094C44Da98b954EedeAC495271d0F',
        wsteth: '0x7f39C581F595B53c5cb19bD0b3f8dA6c935E2Ca0',
        reth: '0xae78736Cd615f374D3085123A210448E74Fc6393'
      };

      // Shared interfaces (created once, reused throughout)
      const INTERFACES = {
        setQuorumBps: new ethers.Interface(['function setQuorumBps(uint16)']),
        setRagequittable: new ethers.Interface(['function setRagequittable(bool)']),
        setSale: new ethers.Interface(['function setSale(address,uint256,uint256,bool,bool,bool)']),
        setProposalTTL: new ethers.Interface(['function setProposalTTL(uint64)']),
        setTimelockDelay: new ethers.Interface(['function setTimelockDelay(uint64)']),
        mintFromMoloch: new ethers.Interface(['function mintFromMoloch(address,uint256)']),
        setProposalThreshold: new ethers.Interface(['function setProposalThreshold(uint96)']),
        setTransfersLocked: new ethers.Interface(['function setTransfersLocked(bool,bool)']),
        setAutoFutarchy: new ethers.Interface(['function setAutoFutarchy(uint256,uint256)']),
        setRenderer: new ethers.Interface(['function setRenderer(address)'])
      };

      // Helper to create minimal proxy init code
      function minimalProxyInitCode(implementation) {
        // Normalize the address to lowercase without 0x prefix
        const impl = implementation.toLowerCase().replace(/^0x/, '');
        // Ensure it's 40 characters (20 bytes)
        if (impl.length !== 40) {
          throw new Error('Invalid implementation address length');
        }
        return ethers.concat([
          CLONE_PREFIX,
          '0x' + impl,
          CLONE_SUFFIX
        ]);
      }

      // Generic CREATE2 address prediction
      function computeCreate2Address(deployer, salt, implementation) {
        const initCode = minimalProxyInitCode(implementation);
        const initCodeHash = ethers.keccak256(initCode);
        
        const encoded = ethers.solidityPacked(
          ['bytes1', 'address', 'bytes32', 'bytes32'],
          ['0xff', deployer, salt, initCodeHash]
        );
        const hash = ethers.keccak256(encoded);
        // Extract the last 20 bytes (40 hex chars) and checksum it
        const rawAddress = '0x' + hash.slice(-40);
        // Return checksummed address
        return ethers.getAddress(rawAddress);
      }

      // Predict all Majeur addresses
      function predictMajeurAddresses(initHolders, initShares, userSalt) {
        // Step 1: Recreate Summoner's salt
        const abiCoder = new ethers.AbiCoder();
        const summonerSalt = ethers.keccak256(
          abiCoder.encode(
            ['address[]', 'uint256[]', 'bytes32'],
            [initHolders, initShares, userSalt]
          )
        );
        
        // Step 2: Predict Moloch DAO clone
        const dao = computeCreate2Address(SUMMONER_ADDRESS, summonerSalt, IMPLEMENTATIONS.moloch);
        
        // Step 3: Child salt for badges/shares/loot
        // bytes32(bytes20(address(dao))) = dao address padded to 32 bytes
        const daoNoPrefix = dao.toLowerCase().replace(/^0x/, '');
        if (daoNoPrefix.length !== 40) {
          throw new Error('Invalid DAO address length');
        }
        const childSalt = '0x' + daoNoPrefix + '000000000000000000000000'; // 12 zero bytes
        
        // Step 4: Predict child clones
        const badges = computeCreate2Address(dao, childSalt, IMPLEMENTATIONS.badges);
        const shares = computeCreate2Address(dao, childSalt, IMPLEMENTATIONS.shares);
        const loot = computeCreate2Address(dao, childSalt, IMPLEMENTATIONS.loot);
        
        return { dao, badges, shares, loot };
      }

      // DOM Element Cache - reduces repeated getElementById calls
      const DOMCache = {
        // Gallery elements
        daoGallery: null,
        daoTiles: null,
        allDaosGallery: null,
        allDaosTiles: null,
        daoDashboard: null,

        // Dashboard elements
        dashboardTitle: null,
        daoEmblem: null,
        daoEtherscanLink: null,
        daoAddressText: null,
        proposalsList: null,
        chatroomMessages: null,

        // Modals
        walletModal: null,
        nftModal: null,
        purchaseModal: null,
        ragequitModal: null,

        // Forms
        proposalDescription: null,
        proposalType: null,
        proposalFields: null,

        // Cache initialization
        init() {
          this.daoGallery = document.getElementById('daoGallery');
          this.daoTiles = document.getElementById('daoTiles');
          this.allDaosGallery = document.getElementById('allDaosGallery');
          this.allDaosTiles = document.getElementById('allDaosTiles');
          this.daoDashboard = document.getElementById('daoDashboard');
          this.dashboardTitle = document.getElementById('dashboardTitle');
          this.daoEmblem = document.getElementById('daoEmblem');
          this.daoEtherscanLink = document.getElementById('daoEtherscanLink');
          this.daoAddressText = document.getElementById('daoAddressText');
          this.proposalsList = document.getElementById('proposalsList');
          this.chatroomMessages = document.getElementById('chatroomMessages');
          this.walletModal = document.getElementById('walletModal');
          this.nftModal = document.getElementById('nftModal');
          this.purchaseModal = document.getElementById('purchaseModal');
          this.ragequitModal = document.getElementById('ragequitModal');
          this.proposalDescription = document.getElementById('proposalDescription');
          this.proposalType = document.getElementById('proposalType');
          this.proposalFields = document.getElementById('proposalFields');
        },

        // Get element with fallback to getElementById
        get(id) {
          return this[id] || document.getElementById(id);
        }
      };

      // Constants - extracting magic numbers for maintainability
      const CONSTANTS = {
        // Time
        DRAFT_RETENTION_MS: 24 * 60 * 60 * 1000, // 24 hours in milliseconds
        REFRESH_COOLDOWN_MS: 5000, // 5 seconds
        TOAST_DURATION_MS: 3000,
        TOAST_DURATION_LONG_MS: 6000,

        // Token & Blockchain
        TOKEN_DECIMALS: 18,
        MIN_DISPLAY_BALANCE: 0.0001,
        BIPS_DIVISOR: 10000, // Basis points to percentage (1 bps = 0.01%)

        // UI Thresholds
        MAX_MEMBERS_DISPLAY: 100,
        MAX_PROPOSALS_DISPLAY: 50,
        ANIMATION_DELAY_MS: 50,

        // Storage
        STORAGE_KEY_SUMMON: 'molochSummonDraft',

        // Fetch Limits
        DAO_FETCH_LIMIT: 50,
        PROPOSAL_FETCH_LIMIT: 10,
        MESSAGE_FETCH_LIMIT: 10
      };

      let provider = null;
      let signer = null;
      let memberIdCounter = 1;
      let connectedWallet = null;
      let connectedAddress = null;
      let userDAOs = [];
      let allDAOs = [];
      let currentDAO = null;

      // Connection state management
      let isConnecting = false;
      let connectionTimeout = null;
      let eip6963Providers = new Map();

      // Transaction state management (prevent double-submission race conditions)
      let isSendingMessage = false;
      let isVoting = false;
      let isCancellingVote = false;
      let isCreatingProposal = false;
      let isExecutingProposal = false;

      // ENS lookup cache (prevents repeated network calls for same addresses)
      const ensCache = new Map(); // address => { name: string, timestamp: number }
      const ENS_CACHE_TTL = 24 * 60 * 60 * 1000; // 24 hours in milliseconds

      // Cached ENS lookup with TTL
      async function lookupENS(address) {
        if (!address || !provider) return null;

        const cached = ensCache.get(address.toLowerCase());
        const now = Date.now();

        // Return cached value if still valid
        if (cached && (now - cached.timestamp) < ENS_CACHE_TTL) {
          return cached.name;
        }

        // Perform lookup
        try {
          const ensName = await provider.lookupAddress(address);
          // Cache the result (even if null)
          ensCache.set(address.toLowerCase(), {
            name: ensName,
            timestamp: now
          });
          return ensName;
        } catch (error) {
          // Cache null result to avoid repeated failed lookups
          ensCache.set(address.toLowerCase(), {
            name: null,
            timestamp: now
          });
          return null;
        }
      }

      // Event listener cleanup
      let walletEventListeners = [];

      // Utility function to check if error is user rejection
      function isUserRejection(error) {
        if (!error) return false;

        // Check error codes
        if (error.code === 4001 || error.code === -32603 || error.code === 'ACTION_REJECTED') {
          return true;
        }

        // Check error message (case insensitive)
        const message = (error.message || '').toLowerCase();
        if (message.includes('user rejected') ||
            message.includes('user denied') ||
            message.includes('transaction cancelled') ||
            message.includes('cancelled by user')) {
          return true;
        }

        // Check nested error object
        if (error.error) {
          return isUserRejection(error.error);
        }

        // Check reason field
        if (error.reason) {
          const reason = error.reason.toLowerCase();
          if (reason.includes('user rejected') || reason.includes('user denied')) {
            return true;
          }
        }

        return false;
      }

      // Wallet detection configuration
      const WALLET_CONFIG = {
        metamask: {
          name: 'MetaMask',
          icon: '🦊',
          detect: () => window.ethereum?.isMetaMask,
          getProvider: () => window.ethereum
        },
        coinbase: {
          name: 'Coinbase Wallet',
          icon: '🔵',
          detect: () => window.ethereum?.isCoinbaseWallet || window.coinbaseWalletExtension,
          getProvider: () => window.ethereum?.isCoinbaseWallet ? window.ethereum : window.coinbaseWalletExtension
        },
        rabby: {
          name: 'Rabby Wallet',
          icon: '🐰',
          detect: () => window.ethereum?.isRabby,
          getProvider: () => window.ethereum
        },
        brave: {
          name: 'Brave Wallet',
          icon: '🦁',
          detect: () => window.ethereum?.isBraveWallet,
          getProvider: () => window.ethereum
        },
        trust: {
          name: 'Trust Wallet',
          icon: '⭐',
          detect: () => window.ethereum?.isTrust,
          getProvider: () => window.ethereum
        },
        okx: {
          name: 'OKX Wallet',
          icon: '⚫',
          detect: () => window.okxwallet || window.ethereum?.isOkxWallet,
          getProvider: () => window.okxwallet || window.ethereum
        },
        bitget: {
          name: 'Bitget Wallet',
          icon: '💼',
          detect: () => window.bitkeep?.ethereum || window.ethereum?.isBitKeep || window.ethereum?.isBitget,
          getProvider: () => window.bitkeep?.ethereum || window.ethereum
        },
        rainbow: {
          name: 'Rainbow',
          icon: '🌈',
          detect: () => window.ethereum?.isRainbow,
          getProvider: () => window.ethereum
        },
        frame: {
          name: 'Frame',
          icon: '🖼️',
          detect: () => window.ethereum?.isFrame,
          getProvider: () => window.ethereum
        },
        zerion: {
          name: 'Zerion',
          icon: '💎',
          detect: () => window.ethereum?.isZerion,
          getProvider: () => window.ethereum
        },
        phantom: {
          name: 'Phantom',
          icon: '👻',
          detect: () => window.phantom?.ethereum,
          getProvider: () => window.phantom?.ethereum
        }
      };

      // EIP-6963: Multi-injector wallet detection
      function initEIP6963() {
        if (typeof window === 'undefined') return;

        window.addEventListener('eip6963:announceProvider', (event) => {
          const { info, provider } = event.detail;
          eip6963Providers.set(info.uuid, { info, provider });
        });

        window.dispatchEvent(new Event('eip6963:requestProvider'));
      }

      function detectWallets() {
        const detected = [];
        const seenNames = new Set();

        // First, detect legacy injected wallets
        for (const [key, wallet] of Object.entries(WALLET_CONFIG)) {
          if (wallet.detect()) {
            detected.push({ key, ...wallet });
            seenNames.add(wallet.name.toLowerCase());
          }
        }

        // Then, add EIP-6963 detected wallets that weren't already found
        for (const [uuid, { info, provider }] of eip6963Providers.entries()) {
          const nameLower = info.name.toLowerCase();
          if (!seenNames.has(nameLower)) {
            detected.push({
              key: `eip6963_${uuid}`,
              name: info.name,
              icon: info.icon ? `<img src="${info.icon}" style="width: 1.2rem; height: 1.2rem;" alt="${info.name}"/>` : '🔌',
              detect: () => true,
              getProvider: () => provider,
              isEIP6963: true
            });
            seenNames.add(nameLower);
          }
        }

        return detected;
      }

      // LocalStorage helpers
      function saveWalletPreference(walletKey) {
        try {
          localStorage.setItem('preferredWallet', walletKey);
        } catch (e) {
          console.warn('Failed to save wallet preference:', e);
        }
      }

      function getWalletPreference() {
        try {
          return localStorage.getItem('preferredWallet');
        } catch (e) {
          console.warn('Failed to get wallet preference:', e);
          return null;
        }
      }

      function clearWalletPreference() {
        try {
          localStorage.removeItem('preferredWallet');
        } catch (e) {
          console.warn('Failed to clear wallet preference:', e);
        }
      }

      function showWalletModal() {
        const modalOverlay = document.getElementById('walletModal');
        const walletOptions = document.getElementById('walletOptions');

        // If already connected, show disconnect option
        if (connectedWallet && connectedAddress) {
          // Get wallet info - support both legacy and EIP-6963 wallets
          let wallet;
          if (connectedWallet.startsWith('eip6963_')) {
            const uuid = connectedWallet.replace('eip6963_', '');
            const eip6963Wallet = eip6963Providers.get(uuid);
            if (eip6963Wallet) {
              wallet = {
                name: eip6963Wallet.info.name,
                icon: eip6963Wallet.info.icon ? `<img src="${eip6963Wallet.info.icon}" style="width: 1.2rem; height: 1.2rem;" alt="${eip6963Wallet.info.name}"/>` : '🔌'
              };
            }
          } else {
            wallet = WALLET_CONFIG[connectedWallet];
          }

          if (wallet) {
            walletOptions.innerHTML = `
              <div style="padding: 1rem; background: rgba(157, 123, 255, 0.1); border: 1px solid rgba(157, 123, 255, 0.3); margin-bottom: 1rem;">
                <div style="display: flex; align-items: center; margin-bottom: 0.75rem;">
                  <div class="wallet-icon" style="margin-right: 1rem;">${wallet.icon}</div>
                  <div>
                    <div class="wallet-name">${wallet.name}</div>
                    <div class="wallet-status installed">Connected</div>
                  </div>
                </div>
                <div style="font-family: 'EB Garamond', serif; color: rgba(230, 217, 255, 0.8); font-size: 0.9rem; word-break: break-all;">
                  ${connectedAddress}
                </div>
              </div>
              <div class="wallet-option" onclick="disconnectWallet()" style="background: rgba(157, 123, 255, 0.1); border-color: rgba(157, 123, 255, 0.5); justify-content: center;">
                <div class="wallet-name" style="margin: 0;">Disconnect Wallet</div>
              </div>
            `;
          }
        } else {
          // Show wallet selection
          const wallets = detectWallets();

          if (wallets.length === 0) {
            walletOptions.innerHTML = `
              <div class="wallet-option" onclick="window.open('https://metamask.io/download/', '_blank')">
                <div class="wallet-icon">🦊</div>
                <div class="wallet-info">
                  <div class="wallet-name">Install MetaMask</div>
                  <div class="wallet-status">No wallet detected</div>
                </div>
              </div>
              <div class="wallet-option" onclick="window.open('https://www.coinbase.com/wallet/downloads', '_blank')">
                <div class="wallet-icon">🔵</div>
                <div class="wallet-info">
                  <div class="wallet-name">Install Coinbase Wallet</div>
                  <div class="wallet-status">Browser extension</div>
                </div>
              </div>
              <div class="wallet-option" onclick="window.open('https://rainbow.me/download', '_blank')">
                <div class="wallet-icon">🌈</div>
                <div class="wallet-info">
                  <div class="wallet-name">Install Rainbow</div>
                  <div class="wallet-status">Browser extension</div>
                </div>
              </div>
            `;
          } else {
            walletOptions.innerHTML = wallets.map(wallet => `
              <div class="wallet-option" onclick="connectWithWallet('${wallet.key}')">
                <div class="wallet-icon">${wallet.icon}</div>
                <div class="wallet-info">
                  <div class="wallet-name">${wallet.name}</div>
                  <div class="wallet-status installed">Detected</div>
                </div>
              </div>
            `).join('');
          }
        }

        modalOverlay.classList.add('show');
      }

      function closeWalletModal() {
        document.getElementById('walletModal').classList.remove('show');
      }

      // Close modal when clicking outside
      document.addEventListener('DOMContentLoaded', () => {
        const modalOverlay = document.getElementById('walletModal');
        modalOverlay.addEventListener('click', (e) => {
          if (e.target === modalOverlay) {
            closeWalletModal();
          }
        });
      });

      async function connectWithWallet(walletKey) {
        // Prevent concurrent connection attempts
        if (isConnecting) {
          showStatus('Connection already in progress', false);
          return;
        }

        closeWalletModal();

        // Get wallet config - support both legacy and EIP-6963 wallets
        let wallet;
        if (walletKey.startsWith('eip6963_')) {
          const uuid = walletKey.replace('eip6963_', '');
          const eip6963Wallet = eip6963Providers.get(uuid);
          if (eip6963Wallet) {
            wallet = {
              name: eip6963Wallet.info.name,
              icon: eip6963Wallet.info.icon ? `<img src="${eip6963Wallet.info.icon}" style="width: 1.2rem; height: 1.2rem;"/>` : '🔌',
              getProvider: () => eip6963Wallet.provider
            };
          }
        } else {
          wallet = WALLET_CONFIG[walletKey];
        }

        if (!wallet) {
          console.error('Unknown wallet:', walletKey);
          return;
        }

        const walletProvider = wallet.getProvider();
        if (!walletProvider) {
          showStatus(`${wallet.name} not found`, true);
          return;
        }

        isConnecting = true;
        showStatus(`Connecting to ${wallet.name}...`, false);

        try {
          // Set connection timeout (30 seconds)
          const timeoutPromise = new Promise((_, reject) => {
            connectionTimeout = setTimeout(() => {
              reject(new Error('Connection timeout - please try again'));
            }, 30000);
          });

          // Request accounts with timeout
          const accountsPromise = walletProvider.request({ method: 'eth_requestAccounts' });
          await Promise.race([accountsPromise, timeoutPromise]);

          // Clear timeout
          if (connectionTimeout) {
            clearTimeout(connectionTimeout);
            connectionTimeout = null;
          }

          // ethers v6 setup
          provider = new ethers.BrowserProvider(walletProvider);
          signer = await provider.getSigner();

          const address = await signer.getAddress();
          const shortAddress = address.slice(0, 6) + '...' + address.slice(-4);

          // Check network early
          const network = await provider.getNetwork();
          if (network.chainId !== 1n) {
            showStatus('Please switch to Ethereum Mainnet', true);
          }

          // Store connected wallet info
          connectedWallet = walletKey;
          connectedAddress = address;

          // Save preference to localStorage
          saveWalletPreference(walletKey);

          document.getElementById('walletBtn').textContent = shortAddress;
          document.getElementById('walletBtn').classList.add('connected');
          document.getElementById('summonBtn').disabled = false;
          document.getElementById('summonBtn').textContent = 'SUMMON DAO';

          // Initialize first member with connected wallet
          if (document.getElementById('foundingMembersList').children.length === 0) {
            const memberRow = createMemberRow(address, '1', true);
            document.getElementById('foundingMembersList').appendChild(memberRow);
            updateLootInputs();
          }

          // Setup event listeners
          setupWalletEventListeners(walletProvider);

          // Fetch user's DAOs
          showStatus('Fetching your DAOs...', false);
          await fetchUserDAOs();
          await fetchAllDAOs();
          showStatus(`Connected to ${wallet.name}`, false);
        } catch (error) {
          console.error(error);

          // Clear timeout on error
          if (connectionTimeout) {
            clearTimeout(connectionTimeout);
            connectionTimeout = null;
          }

          if (isUserRejection(error)) {
            showStatus('Connection cancelled', false);
            return;
          }

          let errorMessage = `Failed to connect ${wallet.name}`;

          if (error.code === -32002) {
            errorMessage = `Please check ${wallet.name} - a connection request is pending`;
          } else if (error.message?.includes('timeout')) {
            errorMessage = 'Connection timeout - please try again';
          } else if (error.shortMessage) {
            errorMessage = error.shortMessage;
          } else if (error.reason) {
            errorMessage = error.reason;
          } else if (error.message) {
            const msg = error.message.split('\n')[0];
            if (msg.length < 100) {
              errorMessage = msg;
            }
          }

          showStatus(errorMessage, true);
        } finally {
          isConnecting = false;
        }
      }

      async function connectWallet() {
        // Show the wallet selection modal
        showWalletModal();
      }

      // Setup wallet event listeners with proper cleanup tracking
      function setupWalletEventListeners(walletProvider) {
        // Clean up old listeners first
        cleanupWalletEventListeners();

        if (!walletProvider || !walletProvider.on) return;

        const accountsChangedHandler = async (accounts) => {
          try {
            if (accounts.length === 0) {
              // User disconnected from wallet
              disconnectWallet();
            } else {
              // Account switched - reconnect with the same wallet
              if (connectedWallet && !isConnecting) {
                await connectWithWallet(connectedWallet);
              }
            }
          } catch (error) {
            console.error('Error handling account change:', error);
            showStatus('Error updating account', true);
          }
        };

        const chainChangedHandler = async (chainId) => {
          try {
            const network = await provider?.getNetwork();
            if (network && network.chainId !== 1n) {
              showStatus('Please switch to Ethereum Mainnet', true);
            } else if (network) {
              showStatus('Network changed - refreshing data...', false);
              // Refresh DAOs instead of reloading page
              await fetchUserDAOs();
              await fetchAllDAOs();
              showStatus('Network updated', false);
            }
          } catch (error) {
            console.error('Error handling chain change:', error);
            // Fallback to page reload if handling fails
            window.location.reload();
          }
        };

        const disconnectHandler = () => {
          disconnectWallet();
        };

        // Add listeners
        walletProvider.on('accountsChanged', accountsChangedHandler);
        walletProvider.on('chainChanged', chainChangedHandler);
        walletProvider.on('disconnect', disconnectHandler);

        // Track for cleanup
        walletEventListeners.push({
          provider: walletProvider,
          events: [
            { name: 'accountsChanged', handler: accountsChangedHandler },
            { name: 'chainChanged', handler: chainChangedHandler },
            { name: 'disconnect', handler: disconnectHandler }
          ]
        });
      }

      function cleanupWalletEventListeners() {
        for (const { provider, events } of walletEventListeners) {
          if (provider && provider.removeListener) {
            for (const { name, handler } of events) {
              provider.removeListener(name, handler);
            }
          }
        }
        walletEventListeners = [];
      }

      function disconnectWallet() {
        // Clear wallet connection state
        provider = null;
        signer = null;
        connectedWallet = null;
        connectedAddress = null;
        userDAOs = [];
        allDAOs = [];
        currentDAO = null;

        // Clear connection state
        isConnecting = false;
        if (connectionTimeout) {
          clearTimeout(connectionTimeout);
          connectionTimeout = null;
        }

        // Clean up event listeners
        cleanupWalletEventListeners();

        // Clear wallet preference
        clearWalletPreference();

        // Reset UI
        const walletBtn = document.getElementById('walletBtn');
        walletBtn.textContent = 'CONNECT WALLET';
        walletBtn.classList.remove('connected');

        const summonBtn = document.getElementById('summonBtn');
        summonBtn.disabled = true;
        summonBtn.textContent = 'CONNECT WALLET TO SUMMON';

        // Clear the first member if it was auto-added
        const foundingMembersList = document.getElementById('foundingMembersList');
        if (foundingMembersList.children.length > 0) {
          const firstMember = foundingMembersList.children[0];
          const addressInput = firstMember.querySelector('.member-address');
          if (addressInput && addressInput.hasAttribute('readonly')) {
            // Clear the readonly address that was auto-populated
            addressInput.value = '';
            addressInput.removeAttribute('readonly');
            firstMember.querySelector('.member-shares').value = '';
          }
        }

        // Hide DAO galleries and dashboard
        const daoGallery = document.getElementById('daoGallery');
        if (daoGallery) daoGallery.classList.remove('show');
        const allDaosGallery = document.getElementById('allDaosGallery');
        if (allDaosGallery) allDaosGallery.classList.remove('show');
        const daoDashboard = document.getElementById('daoDashboard');
        if (daoDashboard) daoDashboard.classList.remove('show');

        // Close the modal
        closeWalletModal();

        showStatus('Wallet disconnected', false);
      }

      // Ragequit modal functions
      // Store custom tokens for ragequit (cleared on modal open)
      let ragequitCustomTokens = [];

      async function openRagequitModal() {
        if (!currentDAO) {
          showStatus('No DAO selected', true);
          return;
        }

        const modal = document.getElementById('ragequitModal');
        const member = currentDAO.member;

        // Check if user is a member
        if (!member) {
          showStatus('You are not a member of this DAO', true);
          return;
        }

        // Display user's shares and loot
        const shares = ethers.formatUnits(member.shares, 18);
        const loot = ethers.formatUnits(member.loot, 18);
        document.getElementById('ragequitUserShares').textContent = parseFloat(shares).toFixed(4);
        document.getElementById('ragequitUserLoot').textContent = parseFloat(loot).toFixed(4);

        // Clear inputs
        document.getElementById('ragequitSharesInput').value = '';
        document.getElementById('ragequitLootInput').value = '';
        document.getElementById('ragequitCustomTokenInput').value = '';

        // Clear custom tokens list
        ragequitCustomTokens = [];

        // Generate token list with checkboxes
        const tokenList = document.getElementById('ragequitTokenList');
        tokenList.innerHTML = '';

        const treasury = currentDAO.dao.treasury;
        const tokens = [
          { symbol: 'ETH', address: ethers.ZeroAddress, balance: treasury.eth, decimals: 18, icon: TOKEN_ICONS.eth },
          { symbol: 'USDC', address: TOKEN_ADDRESSES.usdc, balance: treasury.usdc, decimals: 6, icon: TOKEN_ICONS.usdc },
          { symbol: 'USDT', address: TOKEN_ADDRESSES.usdt, balance: treasury.usdt, decimals: 6, icon: TOKEN_ICONS.usdt },
          { symbol: 'DAI', address: TOKEN_ADDRESSES.dai, balance: treasury.dai, decimals: 18, icon: TOKEN_ICONS.dai },
          { symbol: 'wstETH', address: TOKEN_ADDRESSES.wsteth, balance: treasury.wsteth, decimals: 18, icon: TOKEN_ICONS.wsteth },
          { symbol: 'rETH', address: TOKEN_ADDRESSES.reth, balance: treasury.reth, decimals: 18, icon: TOKEN_ICONS.reth }
        ];

        // Add custom sale tokens if any
        if (customSaleTokens.length > 0) {
          for (const customToken of customSaleTokens) {
            try {
              const tokenContract = new ethers.Contract(customToken.address, ERC20_ABI, provider);
              const balance = await tokenContract.balanceOf(currentDAO.dao.dao);
              tokens.push({
                symbol: customToken.symbol,
                address: customToken.address,
                balance: balance,
                decimals: customToken.decimals,
                icon: TOKEN_ICONS.defaultCoin,
                isCustomSale: true
              });
            } catch (error) {
              console.error(`Error fetching balance for custom sale token ${customToken.symbol}:`, error);
            }
          }
        }

        tokens.forEach(token => {
          const formattedBalance = parseFloat(ethers.formatUnits(token.balance, token.decimals)).toFixed(4);

          const tokenDiv = document.createElement('div');
          tokenDiv.style.cssText = 'display: flex; align-items: center; padding: 0.7rem; background: rgba(157, 123, 255, 0.15); border: 2px solid rgba(157, 123, 255, 0.5); cursor: pointer; transition: all 0.2s ease; border-radius: 4px;';

          // Add sale badge for custom sale tokens
          const saleBadge = token.isCustomSale
            ? ' <span style="font-size: 0.65rem; color: #9d7bff; background: rgba(157, 123, 255, 0.15); padding: 0.15rem 0.35rem; border-radius: 2px; letter-spacing: 0.05em; margin-left: 0.35rem;">SALE</span>'
            : '';

          tokenDiv.innerHTML = `
            <input type="checkbox" id="token_${token.symbol}" value="${token.address}"
                   style="margin-right: 1rem; width: 20px; height: 20px; cursor: pointer; accent-color: #9d7bff;" checked>
            <div class="token-icon" style="width: 28px; height: 28px; margin-right: 1rem; flex-shrink: 0;">${token.icon}</div>
            <div style="flex: 1;">
              <div style="font-family: 'Cinzel', serif; font-size: 0.8rem; color: #9d7bff; margin-bottom: 0.2rem; line-height: 1.3;">${token.symbol}${saleBadge}</div>
              <div style="font-family: 'EB Garamond', serif; font-size: 0.75rem; color: rgba(230, 217, 255, 0.6); line-height: 1.3;">Balance: ${formattedBalance}</div>
            </div>
          `;

          tokenList.appendChild(tokenDiv);

          const checkbox = tokenDiv.querySelector('input[type="checkbox"]');

          // Function to update visual state
          const updateVisualState = () => {
            if (checkbox.checked) {
              tokenDiv.style.background = 'rgba(157, 123, 255, 0.15)';
              tokenDiv.style.borderColor = 'rgba(157, 123, 255, 0.5)';
              tokenDiv.style.borderWidth = '2px';
            } else {
              tokenDiv.style.background = 'rgba(0, 0, 0, 0.2)';
              tokenDiv.style.borderColor = 'rgba(157, 123, 255, 0.2)';
              tokenDiv.style.borderWidth = '1px';
            }
          };

          // Hover effects
          tokenDiv.onmouseover = () => {
            if (checkbox.checked) {
              tokenDiv.style.borderColor = 'rgba(157, 123, 255, 0.7)';
              tokenDiv.style.background = 'rgba(157, 123, 255, 0.2)';
            } else {
              tokenDiv.style.borderColor = 'rgba(157, 123, 255, 0.3)';
              tokenDiv.style.background = 'rgba(0, 0, 0, 0.3)';
            }
          };

          tokenDiv.onmouseout = () => {
            updateVisualState();
          };

          // Make the whole div clickable to toggle checkbox
          tokenDiv.onclick = (e) => {
            if (e.target.tagName !== 'INPUT') {
              checkbox.checked = !checkbox.checked;
            }
            updateVisualState();
          };

          // Listen for checkbox changes
          checkbox.onchange = () => {
            updateVisualState();
          };
        });

        modal.classList.add('show');
      }

      function closeRagequitModal() {
        document.getElementById('ragequitModal').classList.remove('show');
      }

      // Add custom token to ragequit list
      async function addCustomRagequitToken() {
        const input = document.getElementById('ragequitCustomTokenInput');
        const tokenAddress = input.value.trim();

        if (!tokenAddress || !ethers.isAddress(tokenAddress)) {
          showStatus('Invalid token address', true);
          return;
        }

        // Normalize address
        const normalizedAddress = ethers.getAddress(tokenAddress);

        // Check if already added (standard or custom)
        const tokenList = document.getElementById('ragequitTokenList');
        const existingCheckbox = tokenList.querySelector(`input[value="${normalizedAddress}"]`);
        if (existingCheckbox) {
          showStatus('Token already in list', true);
          return;
        }

        // Check if it's a forbidden address
        if (normalizedAddress === currentDAO.dao.shares ||
            normalizedAddress === currentDAO.dao.loot ||
            normalizedAddress === currentDAO.dao.dao ||
            normalizedAddress === '0x00000000000000000000000000000000000003EF') { // address(1007)
          showStatus('Cannot ragequit with shares, loot, or DAO tokens', true);
          return;
        }

        try {
          showStatus('Fetching token info...', false);

          const tokenContract = new ethers.Contract(normalizedAddress, ERC20_ABI, provider);

          // Fetch token info
          const [symbol, decimals, balance] = await Promise.all([
            tokenContract.symbol().catch(() => 'UNKNOWN'),
            tokenContract.decimals().catch(() => 18),
            tokenContract.balanceOf(currentDAO.dao.dao).catch(() => 0n)
          ]);

          const formattedBalance = parseFloat(ethers.formatUnits(balance, decimals)).toFixed(4);

          // Create token div
          const tokenDiv = document.createElement('div');
          tokenDiv.style.cssText = 'display: flex; align-items: center; padding: 0.7rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.2); cursor: pointer; transition: all 0.3s ease; border-radius: 4px;';
          tokenDiv.onmouseover = () => tokenDiv.style.borderColor = 'rgba(157, 123, 255, 0.4)';
          tokenDiv.onmouseout = () => tokenDiv.style.borderColor = 'rgba(157, 123, 255, 0.2)';

          // Custom token icon (generic coin)
          const customIcon = `<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
            <circle cx="16" cy="16" r="14" fill="none" stroke="#9d7bff" stroke-width="2"/>
            <path d="M16 8v16M8 16h16" stroke="#9d7bff" stroke-width="2" stroke-linecap="round"/>
          </svg>`;

          tokenDiv.innerHTML = `
            <input type="checkbox" id="token_custom_${normalizedAddress}" value="${normalizedAddress}"
                   style="margin-right: 1rem; width: 20px; height: 20px; cursor: pointer;" checked>
            <div class="token-icon" style="width: 28px; height: 28px; margin-right: 1rem; flex-shrink: 0;">${customIcon}</div>
            <div style="flex: 1; min-width: 0;">
              <div style="font-family: 'Cinzel', serif; font-size: 0.8rem; color: #9d7bff; margin-bottom: 0.2rem; line-height: 1.3;">${symbol} <span style="font-size: 0.65rem; opacity: 0.6;">(Custom)</span></div>
              <div style="font-family: 'EB Garamond', serif; font-size: 0.75rem; color: rgba(230, 217, 255, 0.6); line-height: 1.3;">Balance: ${formattedBalance}</div>
              <div style="font-family: 'EB Garamond', serif; font-size: 0.65rem; color: rgba(230, 217, 255, 0.4); margin-top: 0.15rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${normalizedAddress}</div>
            </div>
            <button onclick="removeCustomRagequitToken('${normalizedAddress}')"
                    style="padding: 0.35rem 0.6rem; background: rgba(255, 0, 0, 0.1); border: 1px solid rgba(255, 0, 0, 0.3); color: #ff6b6b; font-size: 0.65rem; cursor: pointer; border-radius: 4px; white-space: nowrap; flex-shrink: 0; margin-left: 0.5rem;"
                    onmouseover="this.style.background='rgba(255, 0, 0, 0.2)'"
                    onmouseout="this.style.background='rgba(255, 0, 0, 0.1)'">
              Remove
            </button>
          `;

          tokenDiv.onclick = (e) => {
            if (e.target.type !== 'checkbox' && e.target.tagName !== 'BUTTON') {
              const checkbox = tokenDiv.querySelector('input[type="checkbox"]');
              checkbox.checked = !checkbox.checked;
            }
          };

          tokenList.appendChild(tokenDiv);

          // Store custom token info
          ragequitCustomTokens.push({ address: normalizedAddress, symbol, decimals });

          // Clear input
          input.value = '';
          showStatus(`Added ${symbol} to ragequit list`, false);

        } catch (error) {
          console.error('Error fetching custom token:', error);
          showStatus('Failed to fetch token info', true);
        }
      }

      // Remove custom token from ragequit list
      function removeCustomRagequitToken(address) {
        const tokenList = document.getElementById('ragequitTokenList');
        const tokenDiv = tokenList.querySelector(`input[value="${address}"]`)?.closest('div[style*="display: flex"]');
        if (tokenDiv) {
          tokenDiv.remove();
        }
        ragequitCustomTokens = ragequitCustomTokens.filter(t => t.address !== address);
        showStatus('Token removed', false);
      }

      // Set max shares in ragequit modal
      function setRagequitMaxShares() {
        const sharesText = document.getElementById('ragequitUserShares')?.textContent;
        if (sharesText && sharesText !== '0') {
          const input = document.getElementById('ragequitSharesInput');
          input.value = sharesText;

          // Visual feedback
          input.style.borderColor = '#9d7bff';
          setTimeout(() => {
            input.style.borderColor = 'rgba(157, 123, 255, 0.3)';
          }, 500);
        }
      }

      // Set max loot in ragequit modal
      function setRagequitMaxLoot() {
        const lootText = document.getElementById('ragequitUserLoot')?.textContent;
        if (lootText && lootText !== '0') {
          const input = document.getElementById('ragequitLootInput');
          input.value = lootText;

          // Visual feedback
          input.style.borderColor = '#9d7bff';
          setTimeout(() => {
            input.style.borderColor = 'rgba(157, 123, 255, 0.3)';
          }, 500);
        }
      }

      async function executeRagequit() {
        try {
          if (!signer || !currentDAO) {
            showStatus('No wallet connected or DAO selected', true);
            return;
          }

          // Get input values
          const sharesInput = document.getElementById('ragequitSharesInput').value.trim();
          const lootInput = document.getElementById('ragequitLootInput').value.trim();

          if (!sharesInput && !lootInput) {
            showStatus('Please enter shares or loot to burn', true);
            return;
          }

          const sharesToBurn = sharesInput ? ethers.parseUnits(sharesInput, 18) : 0n;
          const lootToBurn = lootInput ? ethers.parseUnits(lootInput, 18) : 0n;

          if (sharesToBurn === 0n && lootToBurn === 0n) {
            showStatus('Must burn at least some shares or loot', true);
            return;
          }

          // Get selected tokens (includes both standard and custom tokens)
          const checkboxes = document.querySelectorAll('#ragequitTokenList input[type="checkbox"]:checked');
          if (checkboxes.length === 0) {
            showStatus('Please select at least one token to claim', true);
            return;
          }

          const tokenAddresses = Array.from(checkboxes).map(cb => cb.value);

          // CRITICAL: Sort addresses in strictly ascending order (required by contract)
          // Contract checks: if (i != 0 && tk <= prev) revert NotOk();
          // This means each address must be > previous address (no equals, no descending)
          tokenAddresses.sort((a, b) => {
            const aBig = BigInt(a);
            const bBig = BigInt(b);
            return aBig < bBig ? -1 : aBig > bBig ? 1 : 0;
          });

          // Execute ragequit
          const daoContract = new ethers.Contract(currentDAO.dao.dao, MOLOCH_ABI, signer);

          showStatus('Executing ragequit...', false);
          const tx = await daoContract.ragequit(tokenAddresses, sharesToBurn, lootToBurn);

          showStatus(`Transaction submitted. <a href="https://etherscan.io/tx/${tx.hash}" target="_blank" rel="noopener" style="color: #9d7bff; text-decoration: underline;">View on Etherscan</a>`, false);
          await tx.wait();

          showStatus(`✨ Ragequit executed successfully! <a href="https://etherscan.io/tx/${tx.hash}" target="_blank" rel="noopener" style="color: #9d7bff; text-decoration: underline;">View transaction</a>`, false);
          closeRagequitModal();

          // Refresh DAO data
          await fetchUserDAOs();
          await fetchAllDAOs();

          // Refresh current DAO view if still a member
          if (currentDAO) {
            const daoIndex = userDAOs.findIndex(udao =>
              udao.dao.dao.toLowerCase() === currentDAO.dao.dao.toLowerCase()
            );
            if (daoIndex !== -1) {
              await openDAO(daoIndex, 'user');
            } else {
              // User is no longer a member, go back to gallery
              backToGallery();
            }
          }

        } catch (error) {
          console.error('Ragequit failed:', error);

          if (isUserRejection(error)) {
            showStatus('Ragequit cancelled', false);
            return;
          }

          let errorMessage = 'Ragequit failed';

          if (error.message?.includes('NotOk')) {
            errorMessage = 'Ragequit not allowed - DAO may not allow ragequitting';
          } else if (error.shortMessage) {
            errorMessage = error.shortMessage;
          } else if (error.reason) {
            errorMessage = error.reason;
          } else if (error.message) {
            const msg = error.message.split('\n')[0];
            if (msg.length < 100) {
              errorMessage = msg;
            }
          }

          showStatus(errorMessage, true);
        }
      }

      // Transfer Receipt Modal Functions
      let currentTransferReceipt = null;

      function openTransferReceiptModal(receipt) {
        if (!currentDAO || !connectedAddress) {
          showStatus('No wallet connected or DAO selected', true);
          return;
        }

        currentTransferReceipt = receipt;

        // Helper function to truncate long IDs
        const truncateId = (id) => {
          const str = id.toString();
          if (str.length <= 20) return str;
          return `${str.slice(0, 10)}...${str.slice(-8)}`;
        };

        // Convert receipt ID from hex to decimal uint256
        const receiptIdDecimal = BigInt(receipt.receiptId).toString();

        // Display receipt info - convert hex to uint256 decimal
        const receiptIdEl = document.getElementById('transferReceiptId');
        receiptIdEl.setAttribute('data-full-id', receiptIdDecimal);
        receiptIdEl.setAttribute('data-hex-id', receipt.receiptId); // Keep hex for contract call
        receiptIdEl.textContent = truncateId(receiptIdDecimal);
        receiptIdEl.onclick = () => toggleFullId(receiptIdEl);

        const proposalIdEl = document.getElementById('transferProposalId');
        const proposalIdStr = receipt.proposalId.toString();
        proposalIdEl.setAttribute('data-full-id', proposalIdStr);
        proposalIdEl.textContent = proposalIdStr.length > 15 ? truncateId(proposalIdStr) : `#${proposalIdStr}`;
        proposalIdEl.onclick = () => toggleFullId(proposalIdEl);

        document.getElementById('transferAvailableAmount').textContent = ethers.formatUnits(receipt.balance, 18);

        // Clear inputs
        document.getElementById('transferRecipient').value = '';
        document.getElementById('transferAmount').value = '';

        // Show modal
        document.getElementById('transferReceiptModal').classList.add('show');
      }

      function toggleFullId(element) {
        const fullId = element.getAttribute('data-full-id');
        const currentText = element.textContent;
        const isProposal = element.id === 'transferProposalId';

        if (currentText.includes('...')) {
          // Show full ID
          element.textContent = isProposal && fullId.length <= 15 ? `#${fullId}` : fullId;
          element.style.wordBreak = 'break-all';
        } else {
          // Show truncated
          const truncated = fullId.length <= 20 ? fullId : `${fullId.slice(0, 10)}...${fullId.slice(-8)}`;
          element.textContent = truncated;
          element.style.wordBreak = 'normal';
        }
      }

      function closeTransferReceiptModal() {
        document.getElementById('transferReceiptModal').classList.remove('show');
        currentTransferReceipt = null;
      }

      function setTransferMaxAmount() {
        const availableAmountEl = document.getElementById('transferAvailableAmount');
        if (availableAmountEl) {
          const input = document.getElementById('transferAmount');
          input.value = availableAmountEl.textContent;

          // Visual feedback
          input.style.borderColor = '#9d7bff';
          setTimeout(() => {
            input.style.borderColor = 'rgba(157, 123, 255, 0.3)';
          }, 500);
        }
      }

      function copyReceiptId() {
        const receiptIdEl = document.getElementById('transferReceiptId');
        const fullReceiptId = receiptIdEl.getAttribute('data-full-id');

        navigator.clipboard.writeText(fullReceiptId).then(() => {
          const btn = document.getElementById('copyReceiptBtn');
          const originalText = btn.textContent;
          btn.textContent = 'Copied!';
          btn.style.background = 'rgba(102, 255, 102, 0.2)';
          btn.style.borderColor = 'rgba(102, 255, 102, 0.4)';
          btn.style.color = '#66ff66';
          setTimeout(() => {
            btn.textContent = originalText;
            btn.style.background = 'rgba(157, 123, 255, 0.2)';
            btn.style.borderColor = 'rgba(157, 123, 255, 0.3)';
            btn.style.color = '#9d7bff';
          }, 2000);
        }).catch(err => {
          console.error('Failed to copy:', err);
          showStatus('Failed to copy to clipboard', true);
        });
      }

      async function executeReceiptTransfer() {
        try {
          if (!signer || !currentDAO || !currentTransferReceipt) {
            showStatus('No wallet connected or DAO selected', true);
            return;
          }

          const recipientInput = document.getElementById('transferRecipient').value.trim();
          const amountInput = document.getElementById('transferAmount').value.trim();

          if (!recipientInput) {
            showStatus('Please enter a recipient address or ENS', true);
            return;
          }

          if (!amountInput || parseFloat(amountInput) <= 0) {
            showStatus('Please enter a valid amount', true);
            return;
          }

          const amount = ethers.parseUnits(amountInput, 18);

          // Check if amount exceeds balance
          if (amount > currentTransferReceipt.balance) {
            showStatus('Amount exceeds available balance', true);
            return;
          }

          // Resolve ENS or validate address
          let recipientAddress;
          try {
            if (recipientInput.endsWith('.eth')) {
              showStatus('Resolving ENS name...', false);
              recipientAddress = await provider.resolveName(recipientInput);
              if (!recipientAddress) {
                showStatus('ENS name not found', true);
                return;
              }
            } else {
              if (!ethers.isAddress(recipientInput)) {
                showStatus('Invalid address', true);
                return;
              }
              recipientAddress = ethers.getAddress(recipientInput);
            }
          } catch (error) {
            console.error('Error resolving address:', error);
            showStatus('Invalid address or ENS name', true);
            return;
          }

          // Execute transfer using ERC6909 transfer function
          const daoContract = new ethers.Contract(currentDAO.dao.dao, MOLOCH_ABI, signer);

          // Use hex receipt ID for contract call (ethers accepts hex strings)
          const receiptIdHex = currentTransferReceipt.receiptId;

          showStatus('Transferring receipt...', false);
          const tx = await daoContract.transfer(recipientAddress, receiptIdHex, amount);

          showStatus(`Transaction submitted. <a href="https://etherscan.io/tx/${tx.hash}" target="_blank" rel="noopener" style="color: #9d7bff; text-decoration: underline;">View on Etherscan</a>`, false);
          await tx.wait();

          showStatus(`✨ Receipt transferred successfully! <a href="https://etherscan.io/tx/${tx.hash}" target="_blank" rel="noopener" style="color: #9d7bff; text-decoration: underline;">View transaction</a>`, false);

          closeTransferReceiptModal();

          // Refresh membership to update receipt balances
          if (currentDAO.member) {
            await renderVoteReceipts();
          }

        } catch (error) {
          console.error('Transfer failed:', error);

          if (isUserRejection(error)) {
            showStatus('Transaction cancelled by user', false);
            return;
          }

          let errorMessage = 'Transfer failed';

          if (error.message?.includes('NotOk')) {
            errorMessage = 'Transfer not allowed';
          } else if (error.message?.includes('insufficient')) {
            errorMessage = 'Insufficient balance';
          } else if (error.shortMessage) {
            errorMessage = error.shortMessage;
          } else if (error.reason) {
            errorMessage = error.reason;
          } else if (error.message) {
            const msg = error.message.split('\n')[0];
            if (msg.length < 100) {
              errorMessage = msg;
            }
          }

          showStatus(errorMessage, true);
        }
      }

      // DEPOSIT MODAL FUNCTIONS
      let depositAssets = [];
      let selectedDepositAssetIndex = null;

      async function openDepositModal() {
        if (!signer || !currentDAO) {
          showStatus('Please connect wallet and select a DAO first', true);
          return;
        }

        const modal = document.getElementById('depositModal');
        modal.classList.add('show');

        // Set DAO address
        document.getElementById('depositDaoAddress').textContent = currentDAO.dao.dao;

        // Populate asset dropdown
        const dropdown = document.getElementById('depositAssetDropdown');
        dropdown.innerHTML = '';

        depositAssets = [];

        // Add standard assets with icons
        const standardAssets = [
          { symbol: 'ETH', address: ethers.ZeroAddress, decimals: 18, icon: TOKEN_ICONS.eth },
          { symbol: 'USDC', address: TOKEN_ADDRESSES.usdc, decimals: 6, icon: TOKEN_ICONS.usdc },
          { symbol: 'USDT', address: TOKEN_ADDRESSES.usdt, decimals: 6, icon: TOKEN_ICONS.usdt },
          { symbol: 'DAI', address: TOKEN_ADDRESSES.dai, decimals: 18, icon: TOKEN_ICONS.dai },
          { symbol: 'wstETH', address: TOKEN_ADDRESSES.wsteth, decimals: 18, icon: TOKEN_ICONS.wsteth },
          { symbol: 'rETH', address: TOKEN_ADDRESSES.reth, decimals: 18, icon: TOKEN_ICONS.reth }
        ];

        for (const asset of standardAssets) {
          depositAssets.push(asset);
          const option = document.createElement('div');
          const index = depositAssets.length - 1;
          option.onclick = () => selectDepositAsset(index);
          option.style.cssText = 'padding: 0.7rem; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; transition: background 0.2s;';
          option.onmouseover = () => option.style.background = 'rgba(157, 123, 255, 0.2)';
          option.onmouseout = () => option.style.background = 'transparent';
          option.innerHTML = `
            <div style="width: 24px; height: 24px; flex-shrink: 0;">${asset.icon}</div>
            <span style="color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 0.9rem;">${asset.symbol}</span>
          `;
          dropdown.appendChild(option);
        }

        // Add custom sale tokens
        if (customSaleTokens.length > 0) {
          for (const customToken of customSaleTokens) {
            depositAssets.push({
              symbol: customToken.symbol,
              address: customToken.address,
              decimals: customToken.decimals,
              icon: TOKEN_ICONS.defaultCoin
            });
            const option = document.createElement('div');
            const index = depositAssets.length - 1;
            option.onclick = () => selectDepositAsset(index);
            option.style.cssText = 'padding: 0.7rem; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; transition: background 0.2s;';
            option.onmouseover = () => option.style.background = 'rgba(157, 123, 255, 0.2)';
            option.onmouseout = () => option.style.background = 'transparent';
            option.innerHTML = `
              <div style="width: 24px; height: 24px; flex-shrink: 0;">${TOKEN_ICONS.defaultCoin}</div>
              <span style="color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 0.9rem;">${customToken.symbol} <span style="font-size: 0.75rem; opacity: 0.6;">(SALE)</span></span>
            `;
            dropdown.appendChild(option);
          }
        }

        // Reset form
        selectedDepositAssetIndex = null;
        document.getElementById('depositAssetDisplay').innerHTML = '<span>Choose an asset...</span>';
        document.getElementById('depositAmount').value = '';
        document.getElementById('depositUserBalance').textContent = '0';
      }

      function toggleDepositAssetDropdown() {
        const dropdown = document.getElementById('depositAssetDropdown');
        dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
      }

      async function selectDepositAsset(index) {
        selectedDepositAssetIndex = index;
        const asset = depositAssets[index];

        // Update display
        const display = document.getElementById('depositAssetDisplay');
        display.innerHTML = `
          <div style="width: 24px; height: 24px; flex-shrink: 0;">${asset.icon}</div>
          <span>${asset.symbol}</span>
        `;

        // Close dropdown
        document.getElementById('depositAssetDropdown').style.display = 'none';

        // Update balance
        await updateDepositBalance();
      }

      function closeDepositModal() {
        document.getElementById('depositModal').classList.remove('show');
      }

      async function updateDepositBalance() {
        if (selectedDepositAssetIndex === null) {
          document.getElementById('depositUserBalance').textContent = '0';
          return;
        }

        const asset = depositAssets[selectedDepositAssetIndex];

        try {
          let balance;
          if (asset.address === ethers.ZeroAddress) {
            // ETH balance
            balance = await provider.getBalance(await signer.getAddress());
          } else {
            // ERC20 balance
            const tokenContract = new ethers.Contract(asset.address, ERC20_ABI, provider);
            balance = await tokenContract.balanceOf(await signer.getAddress());
          }

          const formatted = parseFloat(ethers.formatUnits(balance, asset.decimals)).toFixed(4);
          document.getElementById('depositUserBalance').textContent = `${formatted} ${asset.symbol}`;
          document.getElementById('depositUserBalance').dataset.rawBalance = balance.toString();
          document.getElementById('depositUserBalance').dataset.decimals = asset.decimals;
        } catch (error) {
          console.error('Error fetching balance:', error);
          document.getElementById('depositUserBalance').textContent = '0';
        }
      }

      function setDepositMax() {
        const balanceEl = document.getElementById('depositUserBalance');
        const rawBalance = balanceEl.dataset.rawBalance;
        const decimals = balanceEl.dataset.decimals;

        if (!rawBalance || !decimals) {
          showStatus('Please select an asset first', true);
          return;
        }

        try {
          const formatted = ethers.formatUnits(rawBalance, decimals);
          document.getElementById('depositAmount').value = formatted;

          // Visual feedback
          const input = document.getElementById('depositAmount');
          input.style.borderColor = '#9d7bff';
          setTimeout(() => {
            input.style.borderColor = 'rgba(157, 123, 255, 0.3)';
          }, 500);
        } catch (error) {
          console.error('Error setting max:', error);
          showStatus('Failed to set max amount', true);
        }
      }

      async function executeDeposit() {
        try {
          if (!signer || !currentDAO) {
            showStatus('No wallet connected or DAO selected', true);
            return;
          }

          if (selectedDepositAssetIndex === null) {
            showStatus('Please select an asset', true);
            return;
          }

          const asset = depositAssets[selectedDepositAssetIndex];
          const amountInput = document.getElementById('depositAmount').value.trim();

          if (!amountInput || parseFloat(amountInput) <= 0) {
            showStatus('Please enter a valid amount', true);
            return;
          }

          const amount = ethers.parseUnits(amountInput, asset.decimals);

          // Check balance
          const balanceEl = document.getElementById('depositUserBalance');
          const rawBalance = BigInt(balanceEl.dataset.rawBalance || '0');

          if (amount > rawBalance) {
            showStatus('Amount exceeds your balance', true);
            return;
          }

          const daoAddress = currentDAO.dao.dao;

          if (asset.address === ethers.ZeroAddress) {
            // ETH deposit - simple transfer
            showStatus('Depositing ETH...', false);
            const tx = await signer.sendTransaction({
              to: daoAddress,
              value: amount
            });

            showStatus(`Transaction submitted. <a href="https://etherscan.io/tx/${tx.hash}" target="_blank" rel="noopener" style="color: #9d7bff; text-decoration: underline;">View on Etherscan</a>`, false);
            await tx.wait();

            showStatus(`✨ Deposited ${amountInput} ETH successfully! <a href="https://etherscan.io/tx/${tx.hash}" target="_blank" rel="noopener" style="color: #9d7bff; text-decoration: underline;">View transaction</a>`, false);
          } else {
            // ERC20 deposit - transfer to DAO
            const tokenContract = new ethers.Contract(asset.address, ERC20_ABI, signer);

            showStatus(`Depositing ${asset.symbol}...`, false);
            const tx = await tokenContract.transfer(daoAddress, amount);

            showStatus(`Transaction submitted. <a href="https://etherscan.io/tx/${tx.hash}" target="_blank" rel="noopener" style="color: #9d7bff; text-decoration: underline;">View on Etherscan</a>`, false);
            await tx.wait();

            showStatus(`✨ Deposited ${amountInput} ${asset.symbol} successfully! <a href="https://etherscan.io/tx/${tx.hash}" target="_blank" rel="noopener" style="color: #9d7bff; text-decoration: underline;">View transaction</a>`, false);
          }

          closeDepositModal();

          // Refresh treasury display
          setTimeout(async () => {
            await renderTreasury();
          }, 2000);

        } catch (error) {
          console.error('Deposit failed:', error);

          if (isUserRejection(error)) {
            showStatus('Transaction cancelled by user', false);
            return;
          }

          let errorMessage = 'Deposit failed';

          if (error.message?.includes('insufficient')) {
            errorMessage = 'Insufficient balance or gas';
          } else if (error.shortMessage) {
            errorMessage = error.shortMessage;
          } else if (error.reason) {
            errorMessage = error.reason;
          } else if (error.message) {
            const msg = error.message.split('\n')[0];
            if (msg.length < 100) {
              errorMessage = msg;
            }
          }

          showStatus(errorMessage, true);
        }
      }

      // Close modals when clicking outside
      document.addEventListener('DOMContentLoaded', () => {
        // Initialize token icons in summoning form
        initializeSalePaymentTokenIcons();

        const ragequitModal = document.getElementById('ragequitModal');
        if (ragequitModal) {
          ragequitModal.addEventListener('click', (e) => {
            if (e.target === ragequitModal) {
              closeRagequitModal();
            }
          });
        }

        const transferReceiptModal = document.getElementById('transferReceiptModal');
        if (transferReceiptModal) {
          transferReceiptModal.addEventListener('click', (e) => {
            if (e.target === transferReceiptModal) {
              closeTransferReceiptModal();
            }
          });
        }

        const purchaseModal = document.getElementById('purchaseModal');
        if (purchaseModal) {
          purchaseModal.addEventListener('click', (e) => {
            if (e.target === purchaseModal) {
              closePurchaseModal();
            }
          });
        }

        const depositModal = document.getElementById('depositModal');
        if (depositModal) {
          depositModal.addEventListener('click', (e) => {
            if (e.target === depositModal) {
              closeDepositModal();
            }
          });
        }

        // Close custom dropdowns when clicking outside
        document.addEventListener('click', (e) => {
          // Close deposit asset dropdown
          const depositAssetDisplay = document.getElementById('depositAssetDisplay');
          const depositAssetDropdown = document.getElementById('depositAssetDropdown');
          if (depositAssetDropdown && !depositAssetDisplay?.contains(e.target) && !depositAssetDropdown.contains(e.target)) {
            depositAssetDropdown.style.display = 'none';
          }

          // Close sale payment token dropdown
          const salePaymentTokenDisplay = document.getElementById('salePaymentTokenDisplay');
          const salePaymentTokenDropdown = document.getElementById('salePaymentTokenDropdown');
          if (salePaymentTokenDropdown && !salePaymentTokenDisplay?.contains(e.target) && !salePaymentTokenDropdown.contains(e.target)) {
            salePaymentTokenDropdown.style.display = 'none';
          }

          // Close proposal pay token dropdown
          const proposalPayTokenDisplay = document.getElementById('proposalPayTokenDisplay');
          const proposalPayTokenDropdown = document.getElementById('proposalPayTokenDropdown');
          if (proposalPayTokenDropdown && !proposalPayTokenDisplay?.contains(e.target) && !proposalPayTokenDropdown.contains(e.target)) {
            proposalPayTokenDropdown.style.display = 'none';
          }
        });
      });

      // Fetch user's DAOs from View Helper
      async function fetchUserDAOs() {
        if (!provider || !connectedAddress) return;

        try {
          const viewHelper = new ethers.Contract(VIEW_HELPER_ADDRESS, VIEW_HELPER_ABI, provider);

          // Default params: start at DAO 0, fetch up to 10 DAOs, recent 20 proposals, recent 20 messages
          const result = await viewHelper.getUserDAOsFullState(
            connectedAddress,
            0,  // daoStart
            10, // daoCount
            0,  // proposalStart
            20, // proposalCount (increased for better visibility)
            0,  // messageStart
            20  // messageCount (increased for better visibility)
          );

          userDAOs = result;

          return userDAOs;
        } catch (error) {
          console.error('Error fetching user DAOs:', error);
          return [];
        }
      }

      // Render all DAOs gallery
      function renderAllDAOsGallery() {
        const allDaosTiles = DOMCache.allDaosTiles;
        const allDaosGallery = DOMCache.allDaosGallery;

        if (!allDaosTiles) {
          return;
        }

        allDaosTiles.innerHTML = '';

        const userDAOAddresses = new Set(userDAOs.map(udao => udao.dao.dao.toLowerCase()));

        allDAOs.forEach((daoLens, index) => {
          const dao = daoLens;
          const isUserMember = userDAOAddresses.has(dao.dao.toLowerCase());

          const tile = document.createElement('div');
          tile.className = 'all-dao-tile dao-tile';
          if (isUserMember) {
            tile.classList.add('user-member');
          }
          tile.style.position = 'relative';
          tile.onclick = () => openDAO(index, 'all');

          tile.innerHTML = `
            <div class="dao-tile-emblem" id="emblem-all-${index}"></div>
            <div class="dao-tile-name">${escapeHtml(dao.meta.name)}</div>
            <div class="dao-tile-symbol">${escapeHtml(dao.meta.symbol)}</div>
            <div class="dao-tile-stats">
              <div class="dao-stat">
                <div class="dao-stat-label">Total Shares</div>
                <div class="dao-stat-value">${ethers.formatUnits(dao.supplies.sharesTotalSupply, 18)}</div>
              </div>
              <div class="dao-stat">
                <div class="dao-stat-label">Total Loot</div>
                <div class="dao-stat-value">${ethers.formatUnits(dao.supplies.lootTotalSupply, 18)}</div>
              </div>
              <div class="dao-stat">
                <div class="dao-stat-label">Proposals</div>
                <div class="dao-stat-value">${dao.proposals.length}</div>
              </div>
              <div class="dao-stat">
                <div class="dao-stat-label">Members</div>
                <div class="dao-stat-value">${dao.members.length}</div>
              </div>
            </div>
          `;

          allDaosTiles.appendChild(tile);

          // Add special gif for index 0, 1, 2, 3, and 4
          if (index >= 0 && index <= 4) {
            const gifImg = document.createElement('img');
            const gifUrls = [
              'https://content.wrappr.wtf/ipfs/bafybeidc4tl6ysvwhwbpql7xk5ol5cd22dvpmlyy76zjun4ikhrb43oqb4', // Index 0
              'https://content.wrappr.wtf/ipfs/bafybeibgfu4gh7miouopugf7tclpt4os2zr2rznhlomnletfbj5amdw4gu',   // Index 1
              'https://content.wrappr.wtf/ipfs/bafybeieemrl6ip5w7tgrpdsitw4ry2in3bko7c3oxqa7vr3lisozjbfhra',   // Index 2
              'https://content.wrappr.wtf/ipfs/bafybeiefycihryp3uybt3f3g5dr6tjonxzl6p5mq6ato74ewvf22i4p3zi',   // Index 3
              'https://content.wrappr.wtf/ipfs/bafybeiet7oxnshiv6agrmnhgdpfpmmnhfmw5px2wpozd62jhdvorzdp4fq'    // Index 4
            ];
            gifImg.src = gifUrls[index];
            gifImg.className = 'dao-special-gif';
            gifImg.alt = 'Special DAO Animation';
            tile.appendChild(gifImg);
          }

          // Render emblem asynchronously
          renderTileEmblem(dao.dao, `emblem-all-${index}`);
        });

        allDaosGallery.classList.add('show');
      }

      // Fetch all DAOs from View Helper (not filtered by user)
      async function fetchAllDAOs() {
        if (!provider) return;

        try {
          const viewHelper = new ethers.Contract(VIEW_HELPER_ADDRESS, VIEW_HELPER_ABI, provider);

          // Fetch all DAOs: start at DAO 0, fetch up to 50, recent 5 proposals, recent 5 messages
          const result = await viewHelper.getDAOsFullState(
            0, // daoStart
            50, // daoCount (get more DAOs than user filter)
            0, // proposalStart
            5, // proposalCount (fewer details for browse view)
            0, // messageStart
            5 // messageCount (fewer details for browse view)
          );

          allDAOs = result;
          renderAllDAOsGallery();

          // Render user DAOs gallery after allDAOs is loaded for proper GIF matching
          if (userDAOs.length > 0) {
            renderDAOGallery();
          }

          return allDAOs;
        } catch (error) {
          console.error('Error fetching all DAOs:', error);

          // Still render user DAOs even if allDAOs fetch fails
          if (userDAOs.length > 0) {
            renderDAOGallery();
          }

          return [];
        }
      }

      // Compute proposal ID (matches Solidity _intentHashId logic)
      //
      // MUST match exactly:
      //   Solidity: keccak256(abi.encode(address(this), op, to, value, keccak256(data), nonce, config))
      //   Types:    [address,            uint8, address, uint256, bytes32,         bytes32, uint256]
      //
      // Parameter requirements:
      //   - daoAddress: string (DAO contract address)
      //   - op: number 0-1 (0=call, 1=delegatecall)
      //   - to: string (target address)
      //   - value: BigInt (Wei amount, NOT ETH string!)
      //   - data: string (hex calldata, can be "0x" for empty)
      //   - nonce: string (hex bytes32, e.g., "0x0000...")
      //   - config: BigInt (from DAO's config() function)
      function computeProposalId(daoAddress, op, to, value, data, nonce, config) {
        const abiCoder = new ethers.AbiCoder();

        // Hash the calldata (Solidity: keccak256(data))
        const dataHash = ethers.keccak256(data);

        // Encode all parameters in the same order as Solidity
        const encoded = abiCoder.encode(
          ['address', 'uint8', 'address', 'uint256', 'bytes32', 'bytes32', 'uint256'],
          [daoAddress, op, to, value, dataHash, nonce, config]
        );

        // Return as BigInt for consistency
        return BigInt(ethers.keccak256(encoded));
      }

      // Encode proposal as tagged message (raw JSON for transparency)
      //
      // ARCHITECTURE NOTE: Moloch.sol stores only proposal IDs (hashes), not call data.
      // Chat messages serve as the "source of truth" for proposal parameters:
      //   - Proposal ID = hash(dao, op, to, value, keccak256(data), nonce, config)
      //   - Chat message contains all parameters needed for execution
      //   - UI can verify integrity by re-hashing and comparing to proposal ID
      //   - When executing, parameters are extracted from the tagged message
      //
      // This design saves gas (no redundant storage) while keeping everything on-chain.
      function encodeProposalMessage(op, to, value, data, nonce, description) {
        const proposalData = {
          type: 'PROPOSAL',
          op: op,
          to: to,
          value: value.toString(),
          data: data,
          nonce: nonce,
          description: description
        };

        // Use unique delimiters that won't appear in hex data or descriptions
        // Raw JSON (not base64) for transparency - anyone can read proposals in chat
        return `<<<PROPOSAL_DATA\n${JSON.stringify(proposalData, null, 2)}\nPROPOSAL_DATA>>>`;
      }

      // Decode proposal from tagged message
      function decodeProposalMessage(messageText) {
        // Match multiline content between delimiters
        const match = messageText.match(/<<<PROPOSAL_DATA\n([\s\S]*?)\nPROPOSAL_DATA>>>/);
        if (!match) return null;

        try {
          const decoded = JSON.parse(match[1]);
          if (decoded.type === 'PROPOSAL') {
            return decoded;
          }
        } catch (e) {
          console.error('Failed to decode proposal message:', e);
        }

        return null;
      }

      // Render DAO gallery
      function renderDAOGallery() {
        const daoTiles = DOMCache.daoTiles;
        const daoGallery = DOMCache.daoGallery;

        if (!daoTiles) return;

        daoTiles.innerHTML = '';

        if (userDAOs.length === 0) {
          daoTiles.innerHTML = '<p style="text-align: center; color: rgba(230, 217, 255, 0.6); font-style: italic;">You are not a member of any DAOs yet.</p>';
          daoGallery.classList.add('show');
          return;
        }

        userDAOs.forEach((userDAOLens, index) => {
          const dao = userDAOLens.dao;
          const member = userDAOLens.member;

          const tile = document.createElement('div');
          tile.className = 'dao-tile';
          tile.onclick = () => openDAO(index);

          const sharesBN = member.shares;
          const lootBN = member.loot;

          tile.innerHTML = `
            <div class="dao-tile-emblem" id="emblem-user-${index}"></div>
            <div class="dao-tile-name">${escapeHtml(dao.meta.name)}</div>
            <div class="dao-tile-symbol">${escapeHtml(dao.meta.symbol)}</div>
            <div class="dao-tile-stats">
              <div class="dao-stat">
                <div class="dao-stat-label">Your Shares</div>
                <div class="dao-stat-value">${ethers.formatUnits(sharesBN, 18)}</div>
              </div>
              <div class="dao-stat">
                <div class="dao-stat-label">Your Loot</div>
                <div class="dao-stat-value">${ethers.formatUnits(lootBN, 18)}</div>
              </div>
              <div class="dao-stat">
                <div class="dao-stat-label">Proposals</div>
                <div class="dao-stat-value">${dao.proposals.length}</div>
              </div>
              <div class="dao-stat">
                <div class="dao-stat-label">Messages</div>
                <div class="dao-stat-value">${dao.messages.length}</div>
              </div>
            </div>
          `;

          daoTiles.appendChild(tile);

          // Find global index by matching DAO address
          const globalIndex = allDAOs.findIndex(globalDao =>
            globalDao.dao.toLowerCase() === dao.dao.toLowerCase()
          );

          // Add special gif for global index 0, 1, 2, 3, and 4
          if (globalIndex >= 0 && globalIndex <= 4) {
            const gifImg = document.createElement('img');
            const gifUrls = [
              'https://content.wrappr.wtf/ipfs/bafybeidc4tl6ysvwhwbpql7xk5ol5cd22dvpmlyy76zjun4ikhrb43oqb4', // Index 0
              'https://content.wrappr.wtf/ipfs/bafybeibgfu4gh7miouopugf7tclpt4os2zr2rznhlomnletfbj5amdw4gu',   // Index 1
              'https://content.wrappr.wtf/ipfs/bafybeieemrl6ip5w7tgrpdsitw4ry2in3bko7c3oxqa7vr3lisozjbfhra',   // Index 2
              'https://content.wrappr.wtf/ipfs/bafybeiefycihryp3uybt3f3g5dr6tjonxzl6p5mq6ato74ewvf22i4p3zi',   // Index 3
              'https://content.wrappr.wtf/ipfs/bafybeiet7oxnshiv6agrmnhgdpfpmmnhfmw5px2wpozd62jhdvorzdp4fq'    // Index 4
            ];
            gifImg.src = gifUrls[globalIndex];
            gifImg.className = 'dao-special-gif';
            gifImg.alt = 'Special DAO Animation';
            tile.appendChild(gifImg);
          }

          // Render emblem asynchronously
          renderTileEmblem(dao.dao, `emblem-user-${index}`);
        });

        daoGallery.classList.add('show');
      }

      // Token SVG icons
      const TOKEN_ICONS = {
        eth: `<svg viewBox="0 0 32 32" version="1.1" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
          <style type="text/css">
            .st1{fill:#80D8FF;}
            .st4{fill:#55FB9B;}
            .st6{fill:#C1AEE1;}
            .st8{fill:#FF8A80;}
            .st10{fill:#FFF176;}
            .st16{fill:#42A5F5;}
            .st17{fill:#37474F;}
          </style>
          <g>
            <polygon class="st1" points="7.62,18.83 16.01,30.5 16.01,24.1"/>
            <polygon class="st16" points="16.01,30.5 24.38,18.78 16.01,24.1"/>
            <polygon class="st10" points="16.01,1.5 7.62,16.23 16.01,12.3"/>
            <polygon class="st8" points="24.38,16.18 16.01,1.5 16.01,12.3"/>
            <polygon class="st6" points="16.01,21.5 24.38,16.18 16.01,12.3"/>
            <polygon class="st4" points="16.01,12.3 7.62,16.23 16.01,21.5"/>
            <path class="st17" d="M16.01,22c-0.09,0-0.18-0.03-0.27-0.08l-8.39-5.27c-0.23-0.14-0.3-0.44-0.17-0.67l8.39-14.73c0.18-0.31,0.69-0.31,0.87,0l8.36,14.68c0.13,0.23,0.06,0.53-0.17,0.67l-8.36,5.32C16.2,21.97,16.11,22,16.01,22z M8.3,16.06l7.71,4.85l7.69-4.89L16.01,2.51L8.3,16.06z"/>
            <path class="st17" d="M16.01,31c-0.28,0-0.5-0.22-0.5-0.5v-6.4c0-0.28,0.22-0.5,0.5-0.5s0.5,0.22,0.5,0.5v6.4C16.51,30.78,16.29,31,16.01,31z"/>
            <path class="st17" d="M16.01,31c-0.16,0-0.31-0.08-0.41-0.21L7.22,19.12c-0.14-0.19-0.12-0.46,0.04-0.63c0.16-0.17,0.43-0.21,0.63-0.08l8.12,5.11l8.1-5.15c0.2-0.13,0.47-0.1,0.63,0.08c0.16,0.17,0.18,0.44,0.04,0.63l-8.36,11.72C16.33,30.92,16.16,30.98,16.01,31z M9.52,20.61l6.49,9.03l6.47-9.06l-6.2,3.94c-0.16,0.1-0.37,0.1-0.53,0L9.52,20.61z"/>
            <path class="st17" d="M16.01,22c-0.09,0-0.18-0.03-0.27-0.08l-8.39-5.27c-0.15-0.1-0.24-0.27-0.23-0.45s0.12-0.34,0.29-0.42l8.39-3.93c0.13-0.06,0.29-0.06,0.42,0l8.36,3.88c0.17,0.08,0.28,0.24,0.29,0.42c0.01,0.18-0.08,0.36-0.23,0.45l-8.36,5.32C16.2,21.97,16.11,22,16.01,22z M8.67,16.29l7.34,4.62l7.33-4.66l-7.32-3.4L8.67,16.29z"/>
            <path class="st17" d="M16.01,22c-0.28,0-0.5-0.22-0.5-0.5v-20c0-0.28,0.22-0.5,0.5-0.5s0.5,0.22,0.5,0.5v20C16.51,21.78,16.29,22,16.01,22z"/>
            <path class="st17" d="M16.01,22c-0.09,0-0.18-0.03-0.27-0.08l-8.39-5.27c-0.23-0.14-0.3-0.44-0.17-0.67l8.39-14.73c0.18-0.31,0.69-0.31,0.87,0l8.36,14.68c0.13,0.23,0.06,0.53-0.17,0.67l-8.36,5.32C16.2,21.97,16.11,22,16.01,22z M8.3,16.06l7.71,4.85l7.69-4.89L16.01,2.51L8.3,16.06z"/>
          </g>
        </svg>`,
        usdc: `<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
          <g fill="none">
            <circle fill="#3E73C4" cx="16" cy="16" r="16"/>
            <g fill="#FFF">
              <path d="M20.022 18.124c0-2.124-1.28-2.852-3.84-3.156-1.828-.243-2.193-.728-2.193-1.578 0-.85.61-1.396 1.828-1.396 1.097 0 1.707.364 2.011 1.275a.458.458 0 00.427.303h.975a.416.416 0 00.427-.425v-.06a3.04 3.04 0 00-2.743-2.489V9.142c0-.243-.183-.425-.487-.486h-.915c-.243 0-.426.182-.487.486v1.396c-1.829.242-2.986 1.456-2.986 2.974 0 2.002 1.218 2.791 3.778 3.095 1.707.303 2.255.668 2.255 1.639 0 .97-.853 1.638-2.011 1.638-1.585 0-2.133-.667-2.316-1.578-.06-.242-.244-.364-.427-.364h-1.036a.416.416 0 00-.426.425v.06c.243 1.518 1.219 2.61 3.23 2.914v1.457c0 .242.183.425.487.485h.915c.243 0 .426-.182.487-.485V21.34c1.829-.303 3.047-1.578 3.047-3.217z"/>
              <path d="M12.892 24.497c-4.754-1.7-7.192-6.98-5.424-11.653.914-2.55 2.925-4.491 5.424-5.402.244-.121.365-.303.365-.607v-.85c0-.242-.121-.424-.365-.485-.061 0-.183 0-.244.06a10.895 10.895 0 00-7.13 13.717c1.096 3.4 3.717 6.01 7.13 7.102.244.121.488 0 .548-.243.061-.06.061-.122.061-.243v-.85c0-.182-.182-.424-.365-.546zm6.46-18.936c-.244-.122-.488 0-.548.242-.061.061-.061.122-.061.243v.85c0 .243.182.485.365.607 4.754 1.7 7.192 6.98 5.424 11.653-.914 2.55-2.925 4.491-5.424 5.402-.244.121-.365.303-.365.607v.85c0 .242.121.424.365.485.061 0 .183 0 .244-.06a10.895 10.895 0 007.13-13.717c-1.096-3.46-3.778-6.07-7.13-7.162z"/>
            </g>
          </g>
        </svg>`,
        usdt: `<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
          <g fill="none" fill-rule="evenodd">
            <circle cx="16" cy="16" r="16" fill="#26A17B"/>
            <path fill="#FFF" d="M17.922 17.383v-.002c-.11.008-.677.042-1.942.042-1.01 0-1.721-.03-1.971-.042v.003c-3.888-.171-6.79-.848-6.79-1.658 0-.809 2.902-1.486 6.79-1.66v2.644c.254.018.982.061 1.988.061 1.207 0 1.812-.05 1.925-.06v-2.643c3.88.173 6.775.85 6.775 1.658 0 .81-2.895 1.485-6.775 1.657m0-3.59v-2.366h5.414V7.819H8.595v3.608h5.414v2.365c-4.4.202-7.709 1.074-7.709 2.118 0 1.044 3.309 1.915 7.709 2.118v7.582h3.913v-7.584c4.393-.202 7.694-1.073 7.694-2.116 0-1.043-3.301-1.914-7.694-2.117"/>
          </g>
        </svg>`,
        dai: `<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
          <g fill="none" fill-rule="evenodd">
            <circle fill="#F4B731" fill-rule="nonzero" cx="16" cy="16" r="16"/>
            <path d="M9.277 8h6.552c3.985 0 7.006 2.116 8.13 5.194H26v1.861h-1.611c.031.294.047.594.047.898v.046c0 .342-.02.68-.06 1.01H26v1.86h-2.08C22.767 21.905 19.77 24 15.83 24H9.277v-5.131H7v-1.86h2.277v-1.954H7v-1.86h2.277V8zm1.831 10.869v3.462h4.72c2.914 0 5.078-1.387 6.085-3.462H11.108zm11.366-1.86H11.108v-1.954h11.37c.041.307.063.622.063.944v.045c0 .329-.023.65-.067.964zM15.83 9.665c2.926 0 5.097 1.424 6.098 3.528h-10.82V9.666h4.72z" fill="#FFF"/>
          </g>
        </svg>`,
        wsteth: `<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
          <g fill="none">
            <circle fill="#00A3FF" cx="16" cy="16" r="16"/>
            <path d="M9.437 14.864l-.181.275c-2.048 3.097-1.603 7.253 1.034 9.824 1.561 1.521 3.622 2.353 5.683 2.353 0 0 0 0-6.536-12.452z" fill="#FFF"/>
            <path opacity=".6" d="M15.997 18.611l-6.56-3.747c6.56 12.452 6.56 12.452 6.56 12.452 0-2.683 0-5.623 0-8.705z" fill="#FFF"/>
            <path opacity=".6" d="M22.563 14.864l.181.275c2.048 3.097 1.603 7.253-1.034 9.824-1.561 1.521-3.622 2.353-5.683 2.353 0 0 0 0 6.536-12.452z" fill="#FFF"/>
            <path opacity=".2" d="M16.003 18.611l6.56-3.747c-6.56 12.452-6.56 12.452-6.56 12.452 0-2.683 0-5.623 0-8.705z" fill="#FFF"/>
            <path opacity=".2" d="M16.004 10.239v6.459l5.654-3.23-5.654-3.229z" fill="#FFF"/>
            <path opacity=".6" d="M16.005 10.239l-5.655 3.229 5.655 3.23v-6.46z" fill="#FFF"/>
            <path d="M16.005 4.805l-5.655 8.668 5.655-3.233V4.805z" fill="#FFF"/>
            <path opacity=".6" d="M16.004 10.238l5.658 3.23-5.658-8.674v5.444z" fill="#FFF"/>
          </g>
        </svg>`,
        reth: `<svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <linearGradient id="bgGradient" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" style="stop-color:#FFAA6B;stop-opacity:1"/>
              <stop offset="100%" style="stop-color:#FF8A5B;stop-opacity:1"/>
            </linearGradient>
          </defs>
          <circle cx="100" cy="100" r="95" fill="#FFC93D"/>
          <circle cx="100" cy="100" r="88" fill="#FF6B6B"/>
          <circle cx="100" cy="100" r="82" fill="url(#bgGradient)"/>
          <g transform="translate(100, 100) rotate(45)">
            <path d="M -8 -25 C -8 -30, -5 -35, 0 -35 C 5 -35, 8 -30, 8 -25 L 8 -5 L 18 5 L 18 15 L 8 10 L 8 20 L 0 25 L -8 20 L -8 10 L -18 15 L -18 5 L -8 -5 Z" fill="white"/>
            <circle cx="0" cy="-20" r="4" fill="#FF8A5B"/>
            <path d="M -6 20 L -9 35 L -3 30 L 0 38 L 3 30 L 9 35 L 6 20 Z" fill="white"/>
          </g>
        </svg>`,
        // Default coin icon for custom tokens
        defaultCoin: `<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
          <circle cx="16" cy="16" r="15" fill="none" stroke="#9d7bff" stroke-width="2"/>
          <circle cx="16" cy="16" r="10" fill="none" stroke="#9d7bff" stroke-width="1.5" opacity="0.4"/>
          <circle cx="16" cy="16" r="6" fill="none" stroke="#9d7bff" stroke-width="1.5" opacity="0.6"/>
          <circle cx="16" cy="16" r="2" fill="#9d7bff"/>
        </svg>`
      };

      // Render DAO stats in header
      function renderDaoStats() {
        const statsBar = document.getElementById('daoStatsBar');
        if (!statsBar || !currentDAO) return;

        const dao = currentDAO.dao;

        // Format totals
        const totalProposals = dao.proposals.length;
        // Members array structure: [0]=address, [1]=shares, [2]=loot, [3]=seatId
        const totalBadgeMembers = dao.members.filter(m => m[3] && m[3] > 0).length;
        const totalShares = parseFloat(ethers.formatEther(dao.supplies.sharesTotalSupply)).toFixed(1);
        const totalLoot = parseFloat(ethers.formatEther(dao.supplies.lootTotalSupply)).toFixed(1);

        statsBar.innerHTML = `
          <div class="dao-stat-item">
            <div class="dao-stat-label">Proposals</div>
            <div class="dao-stat-value">${totalProposals}</div>
          </div>
          <div class="dao-stat-item">
            <div class="dao-stat-label">Badge Members</div>
            <div class="dao-stat-value">${totalBadgeMembers}</div>
          </div>
          <div class="dao-stat-item">
            <div class="dao-stat-label">Total Shares</div>
            <div class="dao-stat-value">${totalShares}</div>
          </div>
          <div class="dao-stat-item">
            <div class="dao-stat-label">Total Loot</div>
            <div class="dao-stat-value">${totalLoot}</div>
          </div>
        `;
      }

      // Render governance info
      // Format seconds into human-readable time
      function formatDuration(seconds) {
        const secs = Number(seconds);
        if (secs === 0) return 'No limit';

        const days = Math.floor(secs / 86400);
        const hours = Math.floor((secs % 86400) / 3600);
        const minutes = Math.floor((secs % 3600) / 60);

        if (days > 0) {
          return hours > 0 ? `${days}d ${hours}h` : `${days} day${days !== 1 ? 's' : ''}`;
        } else if (hours > 0) {
          return minutes > 0 ? `${hours}h ${minutes}m` : `${hours} hour${hours !== 1 ? 's' : ''}`;
        } else if (minutes > 0) {
          return `${minutes} minute${minutes !== 1 ? 's' : ''}`;
        } else {
          return `${secs} second${secs !== 1 ? 's' : ''}`;
        }
      }

      // Update proposal TTL info in the proposal form
      function updateProposalTTLInfo() {
        const ttlInfoDiv = document.getElementById('proposalTTLInfo');
        const ttlInfoText = document.getElementById('proposalTTLInfoText');

        if (!ttlInfoDiv || !ttlInfoText || !currentDAO) {
          if (ttlInfoDiv) ttlInfoDiv.style.display = 'none';
          return;
        }

        const ttlSeconds = Number(currentDAO.dao.gov.proposalTTL || 0);

        if (ttlSeconds === 0) {
          ttlInfoDiv.style.display = 'none';
          return;
        }

        const ttlFormatted = formatDuration(ttlSeconds);
        const now = new Date();
        const expiryDate = new Date(now.getTime() + ttlSeconds * 1000);

        const dateOptions = { month: 'short', day: 'numeric', year: 'numeric' };
        const timeOptions = { hour: 'numeric', minute: '2-digit', hour12: true };
        const expiryDateStr = expiryDate.toLocaleDateString('en-US', dateOptions);
        const expiryTimeStr = expiryDate.toLocaleTimeString('en-US', timeOptions);

        ttlInfoText.innerHTML = `Proposal will expire in <strong>${ttlFormatted}</strong> (${expiryDateStr} at ${expiryTimeStr})`;
        ttlInfoDiv.style.display = 'block';
      }

      function renderGovernanceInfo() {
        const governanceInfo = document.getElementById('governanceInfo');
        if (!governanceInfo || !currentDAO) return;

        const gov = currentDAO.dao.gov;
        const supplies = currentDAO.dao.supplies;

        // Calculate quorum percentage
        const quorumBps = Number(gov.quorumBps);
        const quorumPercent = (quorumBps / 100).toFixed(1);

        // Format ragequittable
        const ragequittable = gov.ragequittable ? 'Enabled' : 'Disabled';

        // Format proposal TTL
        const proposalTTL = formatDuration(gov.proposalTTL || 0);

        // Format proposal threshold
        const proposalThreshold = BigInt(gov.proposalThreshold || 0);
        const proposalThresholdFormatted = proposalThreshold > 0n
          ? parseFloat(ethers.formatUnits(proposalThreshold, 18)).toFixed(2)
          : '0';

        // Format timelock delay
        const timelockDelay = formatDuration(gov.timelockDelay || 0);

        // Update proposal form TTL info
        updateProposalTTLInfo();

        // Decode futarchy settings
        let futarchyText = 'Disabled';
        const futarchyParam = BigInt(gov.autoFutarchyParam || 0);
        const futarchyCap = BigInt(gov.autoFutarchyCap || 0);

        if (futarchyParam > 0n && futarchyCap > 0n) {
          const paramBps = Number(futarchyParam);
          const paramPercent = (paramBps / 100).toFixed(2);
          const capFormatted = parseFloat(ethers.formatEther(futarchyCap)).toFixed(1);
          futarchyText = `${paramPercent}% of supply, ${capFormatted} LOOT cap`;
        }

        governanceInfo.innerHTML = `
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.5rem;">
            <div>
              <div style="font-size: 0.7rem; color: rgba(230, 217, 255, 0.5); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.25rem; display: flex; align-items: center; gap: 0.35rem;">
                Quorum
                <a href="#" onclick="event.preventDefault(); prepareQuorumProposal(); switchDaoView('dao');"
                   title="Create proposal to change quorum"
                   style="color: #9d7bff; opacity: 0.5; line-height: 1;">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="16"></line>
                    <line x1="8" y1="12" x2="16" y2="12"></line>
                  </svg>
                </a>
              </div>
              <div style="font-size: 0.95rem; color: #e6d9ff;">${quorumPercent}%</div>
            </div>
            <div>
              <div style="font-size: 0.7rem; color: rgba(230, 217, 255, 0.5); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.25rem; display: flex; align-items: center; gap: 0.35rem;">
                Ragequit
                <a href="#" onclick="event.preventDefault(); prepareRagequitProposal(); switchDaoView('dao');"
                   title="Create proposal to toggle ragequit"
                   style="color: #9d7bff; opacity: 0.5; line-height: 1;">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="16"></line>
                    <line x1="8" y1="12" x2="16" y2="12"></line>
                  </svg>
                </a>
              </div>
              <div style="font-size: 0.95rem; color: #e6d9ff;">${ragequittable}</div>
            </div>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.5rem;">
            <div>
              <div style="font-size: 0.7rem; color: rgba(230, 217, 255, 0.5); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.25rem; display: flex; align-items: center; gap: 0.35rem;">
                Proposal TTL
                <a href="#" onclick="event.preventDefault(); prepareTTLProposal(); switchDaoView('dao');"
                   title="Create proposal to change proposal TTL"
                   style="color: #9d7bff; opacity: 0.5; line-height: 1;">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="16"></line>
                    <line x1="8" y1="12" x2="16" y2="12"></line>
                  </svg>
                </a>
              </div>
              <div style="font-size: 0.95rem; color: #e6d9ff;">${proposalTTL}</div>
            </div>
            <div>
              <div style="font-size: 0.7rem; color: rgba(230, 217, 255, 0.5); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.25rem; display: flex; align-items: center; gap: 0.35rem;">
                Proposal Threshold
                <a href="#" onclick="event.preventDefault(); prepareThresholdProposal(); switchDaoView('dao');"
                   title="Create proposal to change proposal threshold"
                   style="color: #9d7bff; opacity: 0.5; line-height: 1;">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="16"></line>
                    <line x1="8" y1="12" x2="16" y2="12"></line>
                  </svg>
                </a>
              </div>
              <div style="font-size: 0.95rem; color: #e6d9ff;">${proposalThresholdFormatted} shares</div>
            </div>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.5rem;">
            <div>
              <div style="font-size: 0.7rem; color: rgba(230, 217, 255, 0.5); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.25rem; display: flex; align-items: center; gap: 0.35rem;">
                Timelock Delay
                <a href="#" onclick="event.preventDefault(); prepareTimelockDelayProposal(); switchDaoView('dao');"
                   title="Create proposal to change timelock delay"
                   style="color: #9d7bff; opacity: 0.5; line-height: 1;">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="16"></line>
                    <line x1="8" y1="12" x2="16" y2="12"></line>
                  </svg>
                </a>
              </div>
              <div style="font-size: 0.95rem; color: #e6d9ff;">${timelockDelay}</div>
            </div>
          </div>
          <div>
            <div style="font-size: 0.7rem; color: rgba(230, 217, 255, 0.5); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.25rem; display: flex; align-items: center; gap: 0.35rem;">
              Auto-Futarchy
              <a href="#" onclick="event.preventDefault(); prepareFutarchyProposal(); switchDaoView('dao');"
                 title="Create proposal to configure auto-futarchy"
                 style="color: #9d7bff; opacity: 0.5; line-height: 1;">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="12" y1="8" x2="12" y2="16"></line>
                  <line x1="8" y1="12" x2="16" y2="12"></line>
                </svg>
              </a>
            </div>
            <div style="font-size: 0.95rem; color: #e6d9ff;">${futarchyText}</div>
          </div>
          <div style="margin-top: 0.75rem;">
            <div style="font-size: 0.7rem; color: rgba(230, 217, 255, 0.5); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.25rem; display: flex; align-items: center; gap: 0.35rem;">
              Renderer
              <a href="#" onclick="event.preventDefault(); prepareRendererProposal(); switchDaoView('dao');"
                 title="Create proposal to change renderer"
                 style="color: #9d7bff; opacity: 0.5; line-height: 1;">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="12" y1="8" x2="12" y2="16"></line>
                  <line x1="8" y1="12" x2="16" y2="12"></line>
                </svg>
              </a>
            </div>
            <div style="font-size: 0.85rem; color: #e6d9ff;">
              <a href="https://etherscan.io/address/${currentDAO.dao.meta.renderer}"
                 target="_blank"
                 rel="noopener noreferrer"
                 style="color: #9d7bff; text-decoration: none; display: inline-flex; align-items: center; gap: 0.25rem;"
                 onmouseover="this.style.textDecoration='underline';"
                 onmouseout="this.style.textDecoration='none';">
                ${currentDAO.dao.meta.renderer.slice(0, 6)}...${currentDAO.dao.meta.renderer.slice(-4)}
                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                  <polyline points="15 3 21 3 21 9"></polyline>
                  <line x1="10" y1="14" x2="21" y2="3"></line>
                </svg>
              </a>
            </div>
          </div>
        `;
      }

      // Render active sales info
      async function renderSalesInfo() {
        const salesInfo = document.getElementById('salesInfo');
        const salesSection = document.getElementById('salesSection');
        if (!salesInfo || !salesSection || !currentDAO) return;

        try {
          const molochContract = new ethers.Contract(currentDAO.dao.dao, MOLOCH_ABI, provider);

          // Check sales for all supported tokens
          const tokens = [
            { symbol: 'ETH', address: ethers.ZeroAddress, decimals: 18 },
            { symbol: 'USDC', address: TOKEN_ADDRESSES.usdc, decimals: 6 },
            { symbol: 'USDT', address: TOKEN_ADDRESSES.usdt, decimals: 6 },
            { symbol: 'DAI', address: TOKEN_ADDRESSES.dai, decimals: 18 },
            { symbol: 'wstETH', address: TOKEN_ADDRESSES.wsteth, decimals: 18 },
            { symbol: 'rETH', address: TOKEN_ADDRESSES.reth, decimals: 18 }
          ];

          // Parse chat messages for SALE tags to find custom token sales
          // SALE tags can appear in two places:
          // 1. Directly in the message text
          // 2. Inside PROPOSAL_DATA JSON in the description field
          const customTokens = [];
          if (currentDAO.dao.messages && currentDAO.dao.messages.length > 0) {
            for (const message of currentDAO.dao.messages) {
              if (!message.text) continue;

              // Try to extract SALE tag from raw message first
              let textToSearch = message.text;

              // Also check if this is a proposal message - extract description
              const propData = decodeProposalMessage(message.text);
              if (propData && propData.description) {
                textToSearch += '\n' + propData.description;
              }

              const saleMatch = textToSearch.match(/<<<SALE\s+token="([^"]+)"\s+price="([^"]+)"\s+decimals="(\d+)"\s+symbol="([^"]+)"\s+SALE>>>/);
              if (saleMatch) {
                const [, tokenAddress, price, decimals, symbol] = saleMatch;

                // Normalize address for comparison
                const normalizedAddress = tokenAddress.toLowerCase();

                // Check if we already have this token
                if (!tokens.find(t => t.address.toLowerCase() === normalizedAddress) &&
                    !customTokens.find(t => t.address.toLowerCase() === normalizedAddress)) {

                  customTokens.push({
                    symbol,
                    address: tokenAddress,
                    decimals: parseInt(decimals),
                    isCustom: true
                  });

                  // Cache for other functions that might need it
                  if (!customTokenCache[normalizedAddress]) {
                    customTokenCache[normalizedAddress] = {
                      symbol,
                      decimals: parseInt(decimals),
                      name: symbol
                    };
                  }
                }
              }
            }
          }

          // Combine standard and custom tokens
          const allTokens = [...tokens, ...customTokens];

          // Batch all sales queries in parallel to reduce RPC calls
          const salePromises = allTokens.map(token =>
            molochContract.sales(token.address)
              .then(sale => ({ token, sale }))
              .catch(err => {
                console.error(`Error fetching sale for ${token.symbol} (${token.address}):`, err);
                return { token, sale: { active: false } }; // Return inactive on error
              })
          );

          const salesResults = await Promise.all(salePromises);

          const activeSales = [];
          for (const result of salesResults) {
            const { token, sale } = result;
            if (sale.active) {
              activeSales.push({
                token: token,
                pricePerShare: sale.pricePerShare,
                cap: sale.cap,
                minting: sale.minting,
                isLoot: sale.isLoot
              });
            }
          }

          // Extract active custom sale tokens for use in treasury and ragequit
          customSaleTokens = activeSales
            .filter(sale => sale.token.isCustom)
            .map(sale => ({
              symbol: sale.token.symbol,
              address: sale.token.address,
              decimals: sale.token.decimals
            }));

          if (activeSales.length === 0) {
            salesSection.style.display = 'none';
            return;
          }

          salesSection.style.display = 'block';

          let salesHTML = '';
          for (const sale of activeSales) {
            const tokenType = sale.isLoot ? 'LOOT' : 'SHARES';
            const tokenSymbol = sale.isLoot ? `${currentDAO.dao.meta.symbol}-LOOT` : currentDAO.dao.meta.symbol;
            // pricePerShare is a simple integer ratio (token-wei per share-wei)
            const priceRatio = sale.pricePerShare.toString();
            const priceFormatted = `${priceRatio}:1`;
            const capText = sale.cap > 0n ? `${parseFloat(ethers.formatEther(sale.cap)).toFixed(2)} remaining` : 'Unlimited';
            const sourceText = sale.minting ? 'Minting new' : 'From treasury';

            // Detect 1:1 ratio for governance staking/upgrade (18 decimals, price = 1)
            const is1to1Upgrade = sale.token.decimals === 18 && sale.pricePerShare === 1n;
            const displayTitle = is1to1Upgrade ? `${tokenType} GOVERNANCE STAKING/UPGRADE` : `${tokenType} SALE`;

            // Fetch DAO balance for custom tokens
            let daoBalance = '';
            if (sale.token.isCustom) {
              try {
                const tokenContract = new ethers.Contract(sale.token.address, ERC20_ABI, provider);
                const balance = await tokenContract.balanceOf(currentDAO.dao.dao);
                const balanceFormatted = parseFloat(ethers.formatUnits(balance, sale.token.decimals)).toFixed(2);
                daoBalance = `<div style="font-size: 0.75rem; color: rgba(230, 217, 255, 0.6); margin-top: 0.25rem;">DAO Balance: ${balanceFormatted} ${sale.token.symbol}</div>`;
              } catch (err) {
                console.error(`Error fetching DAO balance for ${sale.token.symbol}:`, err);
              }
            }

            // Token contract link
            const tokenContractLink = sale.token.address === ethers.ZeroAddress
              ? ''
              : `<div style="margin-top: 0.5rem; font-size: 0.7rem;">
                   <a href="https://etherscan.io/token/${sale.token.address}"
                      target="_blank"
                      rel="noopener noreferrer"
                      style="color: rgba(157, 123, 255, 0.8); text-decoration: none; display: inline-flex; align-items: center; gap: 0.25rem;"
                      onmouseover="this.style.color='#9d7bff'; this.style.textDecoration='underline';"
                      onmouseout="this.style.color='rgba(157, 123, 255, 0.8)'; this.style.textDecoration='none';">
                     <span>🔍</span> View ${sale.token.symbol} on Etherscan
                     <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                       <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                       <polyline points="15 3 21 3 21 9"></polyline>
                       <line x1="10" y1="14" x2="21" y2="3"></line>
                     </svg>
                   </a>
                 </div>`;

            salesHTML += `
              <div style="padding: 0.75rem; background: rgba(157, 123, 255, 0.05); border: 1px solid rgba(157, 123, 255, 0.2); border-radius: 4px; margin-bottom: 0.75rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                  <div style="font-family: 'Cinzel', serif; font-size: 0.85rem; color: #9d7bff; letter-spacing: 0.1em;">${displayTitle}</div>
                  <div style="font-size: 0.75rem; color: rgba(230, 217, 255, 0.6);">${sourceText}</div>
                </div>
                ${is1to1Upgrade ? '<div style="font-size: 0.75rem; color: rgba(157, 123, 255, 0.9); margin-bottom: 0.5rem; font-style: italic;">1:1 token upgrade • Ragequit to reclaim</div>' : ''}
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem;">
                  <div>
                    <div style="font-size: 0.7rem; color: rgba(230, 217, 255, 0.5);">Price</div>
                    <div style="font-size: 0.9rem; color: #e6d9ff;">${priceFormatted} ${sale.token.symbol}</div>
                  </div>
                  <div>
                    <div style="font-size: 0.7rem; color: rgba(230, 217, 255, 0.5);">Available</div>
                    <div style="font-size: 0.9rem; color: #e6d9ff;">${capText}</div>
                  </div>
                </div>
                ${daoBalance}
                ${tokenContractLink}
                <button onclick="openPurchaseModal('${sale.token.address}', '${sale.token.symbol}', ${sale.token.decimals}, ${sale.isLoot})"
                        onmouseover="this.style.background='rgba(157, 123, 255, 0.25)'; this.style.borderColor='#9d7bff';"
                        onmouseout="this.style.background='rgba(157, 123, 255, 0.15)'; this.style.borderColor='rgba(157, 123, 255, 0.3)';"
                        style="width: 100%; padding: 0.75rem; background: rgba(157, 123, 255, 0.15); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'Cinzel', serif; font-size: 0.7rem; letter-spacing: 0.12em; cursor: pointer; text-transform: uppercase; transition: all 0.2s ease; font-weight: 600; border-radius: 4px; min-height: 44px; margin-top: 0.75rem;">
                  ${is1to1Upgrade ? 'Stake/Upgrade' : `Purchase ${tokenSymbol}`}
                </button>
              </div>
            `;
          }

          salesInfo.innerHTML = salesHTML;
        } catch (error) {
          console.error('Error rendering sales:', error);
          salesSection.style.display = 'none';
        }
      }

      // Render treasury
      async function renderTreasury() {
        const treasuryAssets = document.getElementById('treasuryAssets');
        if (!treasuryAssets || !currentDAO) return;

        treasuryAssets.innerHTML = '';

        const treasury = currentDAO.dao.treasury;

        const assets = [
          { symbol: 'ETH', balance: treasury.eth, decimals: 18, icon: TOKEN_ICONS.eth, address: ethers.ZeroAddress },
          { symbol: 'USDC', balance: treasury.usdc, decimals: 6, icon: TOKEN_ICONS.usdc, address: TOKEN_ADDRESSES.usdc },
          { symbol: 'USDT', balance: treasury.usdt, decimals: 6, icon: TOKEN_ICONS.usdt, address: TOKEN_ADDRESSES.usdt },
          { symbol: 'DAI', balance: treasury.dai, decimals: 18, icon: TOKEN_ICONS.dai, address: TOKEN_ADDRESSES.dai },
          { symbol: 'wstETH', balance: treasury.wsteth, decimals: 18, icon: TOKEN_ICONS.wsteth, address: TOKEN_ADDRESSES.wsteth },
          { symbol: 'rETH', balance: treasury.reth, decimals: 18, icon: TOKEN_ICONS.reth, address: TOKEN_ADDRESSES.reth }
        ];

        // Add custom sale tokens if any
        if (customSaleTokens.length > 0) {
          for (const customToken of customSaleTokens) {
            try {
              const tokenContract = new ethers.Contract(customToken.address, ERC20_ABI, provider);
              const balance = await tokenContract.balanceOf(currentDAO.dao.dao);
              assets.push({
                symbol: customToken.symbol,
                balance: balance,
                decimals: customToken.decimals,
                icon: TOKEN_ICONS.defaultCoin,
                address: customToken.address,
                isCustomSale: true
              });
            } catch (error) {
              console.error(`Error fetching balance for custom sale token ${customToken.symbol}:`, error);
            }
          }
        }

        assets.forEach(asset => {
          const assetDiv = document.createElement('div');
          assetDiv.className = 'treasury-asset';
          assetDiv.style.cursor = 'pointer';
          assetDiv.title = `Click to create ${asset.symbol} transfer proposal`;

          const formattedBalance = parseFloat(ethers.formatUnits(asset.balance, asset.decimals)).toFixed(4);

          // Add sale badge for custom sale tokens
          const saleBadge = asset.isCustomSale
            ? '<div style="font-size: 0.6rem; color: #9d7bff; background: rgba(157, 123, 255, 0.15); padding: 0.15rem 0.35rem; border-radius: 2px; margin-top: 0.25rem; letter-spacing: 0.05em;">SALE</div>'
            : '';

          assetDiv.innerHTML = `
            <div class="treasury-asset-icon">${asset.icon}</div>
            <div class="treasury-asset-symbol">${asset.symbol}${saleBadge}</div>
            <div class="treasury-asset-balance">${formattedBalance}</div>
          `;

          assetDiv.onclick = () => prepareTransferProposal(asset);

          treasuryAssets.appendChild(assetDiv);
        });

        // Add "+ Custom" option for custom tokens
        const customAssetDiv = document.createElement('div');
        customAssetDiv.className = 'treasury-asset';
        customAssetDiv.style.cursor = 'pointer';
        customAssetDiv.style.borderStyle = 'dashed';
        customAssetDiv.style.minHeight = '120px'; // Better touch target
        customAssetDiv.title = 'Click to send or configure sale for a custom ERC20 token';

        const coinIcon = `<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
          <circle cx="16" cy="16" r="14" fill="none" stroke="#9d7bff" stroke-width="2" stroke-dasharray="2,2"/>
          <path d="M16 8v16M8 16h16" stroke="#9d7bff" stroke-width="2" stroke-linecap="round"/>
        </svg>`;

        customAssetDiv.innerHTML = `
          <div class="treasury-asset-icon">${coinIcon}</div>
          <div class="treasury-asset-symbol" style="font-size: 0.75rem;">+ Custom</div>
          <div class="treasury-asset-balance" style="font-size: 0.7rem; opacity: 0.6;">ERC20</div>
        `;

        customAssetDiv.onclick = () => prepareCustomTokenProposal();

        treasuryAssets.appendChild(customAssetDiv);
      }

      // Prepare transfer proposal from treasury asset
      async function prepareTransferProposal(asset) {
        // Clear any existing helpers first
        clearTransferHelper();
        clearMintHelper();
        clearFutarchyHelper();
        clearQuorumHelper();
        clearTTLHelper();
        clearTimelockDelayHelper();
        clearThresholdHelper();
        clearRagequitHelper();
        clearSaleHelper();

        // Scroll to proposal form
        const proposalForm = document.querySelector('.proposal-form');
        if (proposalForm) {
          proposalForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Add transfer helper UI
        let helperDiv = document.createElement('div');
        helperDiv.id = 'transferHelper';
        helperDiv.style.cssText = 'margin-bottom: 1rem; padding: 1rem; background: rgba(157, 123, 255, 0.1); border: 1px solid rgba(157, 123, 255, 0.3); border-radius: 4px;';
        proposalForm.insertBefore(helperDiv, proposalForm.querySelector('.proposal-form-group'));

        // Store asset info for later use
        helperDiv.dataset.assetSymbol = asset.symbol;
        helperDiv.dataset.assetAddress = asset.address;
        helperDiv.dataset.assetDecimals = asset.decimals;

        // Show transfer helper with Send/Sale toggle (Sale only for DAI and custom 18-decimal tokens)
        const isDaiOrCustom = asset.address?.toLowerCase() === TOKEN_ADDRESSES.dai.toLowerCase() || asset.isCustomSale === true;
        const showSaleToggle = asset.decimals === 18 && isDaiOrCustom;
        const saleButtonHTML = showSaleToggle ? `
                <button id="saleToggle" onclick="toggleProposalMode('sale')"
                        style="padding: 0.35rem 0.75rem; background: transparent; border: none; color: rgba(230, 217, 255, 0.6); font-family: 'Cinzel', serif; font-size: 0.7rem; letter-spacing: 0.1em; cursor: pointer; text-transform: uppercase; transition: all 0.2s ease;">
                  Sale
                </button>` : '';

        helperDiv.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
            <div style="display: flex; gap: 0.5rem; align-items: center;">
              <div style="font-family: 'Cinzel', serif; font-size: 0.85rem; color: #9d7bff; letter-spacing: 0.1em;">
                ${asset.symbol}
              </div>
              <div style="display: flex; background: rgba(0, 0, 0, 0.3); border-radius: 4px; overflow: hidden;">
                <button id="sendToggle" onclick="toggleProposalMode('send')"
                        style="padding: 0.35rem 0.75rem; background: rgba(157, 123, 255, 0.3); border: none; color: #e6d9ff; font-family: 'Cinzel', serif; font-size: 0.7rem; letter-spacing: 0.1em; cursor: pointer; text-transform: uppercase; transition: all 0.2s ease;">
                  Send
                </button>${saleButtonHTML}
              </div>
            </div>
            <button onclick="clearTransferHelper()" style="background: none; border: none; color: rgba(230, 217, 255, 0.6); cursor: pointer; font-size: 1.2rem; padding: 0; line-height: 1;">&times;</button>
          </div>
          <div id="proposalFields"></div>
        `;

        // Show send mode by default
        toggleProposalMode('send');
      }

      function toggleProposalMode(mode) {
        const helperDiv = document.getElementById('transferHelper');
        if (!helperDiv) return;

        const sendToggle = document.getElementById('sendToggle');
        const saleToggle = document.getElementById('saleToggle');
        const fieldsDiv = document.getElementById('proposalFields');

        const symbol = helperDiv.dataset.assetSymbol;
        const address = helperDiv.dataset.assetAddress;
        const decimals = parseInt(helperDiv.dataset.assetDecimals);

        // Validate decimals
        if (isNaN(decimals)) {
          showStatus('Invalid token configuration', true);
          return;
        }

        // Sale mode only available for 18-decimal tokens
        if (mode === 'sale' && decimals !== 18) {
          showStatus('Token sales require 18-decimal tokens for proper share pricing', true);
          return;
        }

        // Update toggle button states
        if (mode === 'send') {
          if (sendToggle) {
            sendToggle.style.background = 'rgba(157, 123, 255, 0.3)';
            sendToggle.style.color = '#e6d9ff';
          }
          if (saleToggle) {
            saleToggle.style.background = 'transparent';
            saleToggle.style.color = 'rgba(230, 217, 255, 0.6)';
          }

          // Show send fields
          fieldsDiv.innerHTML = `
            <div style="display: grid; grid-template-columns: 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
              <div>
                <label style="display: block; font-size: 0.75rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.35rem;">Recipient Address or ENS</label>
                <input type="text" id="transferRecipient" placeholder="vitalik.eth or 0x..."
                       style="width: 100%; padding: 0.6rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 16px;" />
              </div>
              <div>
                <label style="display: block; font-size: 0.75rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.35rem;">Amount (${symbol})</label>
                <input type="text" id="transferAmount" placeholder="0.0"
                       style="width: 100%; padding: 0.6rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 16px;" />
              </div>
            </div>
            <button type="button" onclick="populateTransferProposal('${symbol}', '${address}', ${decimals})"
                    onmouseover="this.style.background='rgba(157, 123, 255, 0.35)'; this.style.borderColor='#9d7bff'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(157, 123, 255, 0.3)';"
                    onmouseout="this.style.background='rgba(157, 123, 255, 0.2)'; this.style.borderColor='rgba(157, 123, 255, 0.4)'; this.style.transform='translateY(0)'; this.style.boxShadow='none';"
                    style="width: 100%; padding: 0.75rem; background: rgba(157, 123, 255, 0.2); border: 1px solid rgba(157, 123, 255, 0.4); color: #e6d9ff; font-family: 'Cinzel', serif; font-size: 0.75rem; letter-spacing: 0.15em; cursor: pointer; text-transform: uppercase; transition: all 0.2s ease; font-weight: 600;">
              Populate Proposal Form
            </button>
          `;
          setTimeout(() => {
            const recipientInput = document.getElementById('transferRecipient');
            if (recipientInput) recipientInput.focus();
          }, 100);

        } else if (mode === 'sale') {
          if (sendToggle) {
            sendToggle.style.background = 'transparent';
            sendToggle.style.color = 'rgba(230, 217, 255, 0.6)';
          }
          if (saleToggle) {
            saleToggle.style.background = 'rgba(157, 123, 255, 0.3)';
            saleToggle.style.color = '#e6d9ff';
          }

          // Show sale configuration fields
          fieldsDiv.innerHTML = `
            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-size: 0.75rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.35rem;">Token Type</label>
              <select id="modalSaleTokenType"
                      style="width: 100%; padding: 0.6rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 16px; min-height: 44px;">
                <option value="shares">Shares (Voting)</option>
                <option value="loot">Loot (Non-Voting)</option>
              </select>
            </div>
            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-size: 0.75rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.35rem;">
                Price per Token (${symbol}) <span style="color: #ff6b6b;">*</span>
                <span title="For 1:1 upgrades, use 1.0" style="cursor: help; margin-left: 0.25rem;">ℹ️</span>
              </label>
              <input type="text" id="modalSalePrice" placeholder="1.0" inputmode="decimal"
                     style="width: 100%; padding: 0.6rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 16px;" />
            </div>
            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-size: 0.75rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.35rem;">Sale Cap (0 = unlimited)</label>
              <input type="text" id="modalSaleCap" placeholder="0" inputmode="decimal"
                     style="width: 100%; padding: 0.6rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 16px;" />
            </div>
            <div style="margin-bottom: 0.75rem;">
              <label style="display: block; font-size: 0.75rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.35rem;">Status</label>
              <select id="modalSaleStatus"
                      style="width: 100%; padding: 0.6rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 16px; min-height: 44px;">
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
              </select>
            </div>
            <div style="margin-bottom: 0.75rem;">
              <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: rgba(230, 217, 255, 0.8); cursor: pointer; min-height: 44px;">
                <input type="checkbox" id="modalSaleMinting" checked
                       style="width: 1.25rem; height: 1.25rem; cursor: pointer; accent-color: #9d7bff;" />
                <span>Mint new tokens (unchecked = sell from treasury)</span>
              </label>
            </div>
            <div id="customTokenSaleHint" style="display: none; margin-bottom: 0.75rem; padding: 0.75rem; background: rgba(157, 123, 255, 0.15); border-left: 3px solid #9d7bff; font-size: 0.85rem; color: #e6d9ff; line-height: 1.5;">
              <strong style="color: #9d7bff;">Sale Preview:</strong> <span id="customTokenSaleHintText"></span>
            </div>
            <button type="button" onclick="populateSaleProposalFromToggle('${symbol}', '${address}', ${decimals})"
                    onmouseover="this.style.background='rgba(157, 123, 255, 0.35)'; this.style.borderColor='#9d7bff'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(157, 123, 255, 0.3)';"
                    onmouseout="this.style.background='rgba(157, 123, 255, 0.2)'; this.style.borderColor='rgba(157, 123, 255, 0.4)'; this.style.transform='translateY(0)'; this.style.boxShadow='none';"
                    style="width: 100%; padding: 0.75rem; background: rgba(157, 123, 255, 0.2); border: 1px solid rgba(157, 123, 255, 0.4); color: #e6d9ff; font-family: 'Cinzel', serif; font-size: 0.75rem; letter-spacing: 0.15em; cursor: pointer; text-transform: uppercase; transition: all 0.2s ease; font-weight: 600;">
              Populate Proposal Form
            </button>
          `;
          setTimeout(() => {
            const priceInput = document.getElementById('salePrice');
            if (priceInput) priceInput.focus();

            // Set up event listeners for custom token sale hints
            const capInput = document.getElementById('saleCap');
            const typeInput = document.getElementById('saleTokenType');

            if (priceInput && capInput) {
              const updateHint = () => updateCustomTokenSaleHint(symbol);

              // Remove old listeners before adding new ones to prevent memory leaks
              priceInput.removeEventListener('input', updateHint);
              capInput.removeEventListener('input', updateHint);
              typeInput.removeEventListener('change', updateHint);

              // Add fresh listeners
              priceInput.addEventListener('input', updateHint);
              capInput.addEventListener('input', updateHint);
              typeInput.addEventListener('change', updateHint);
              updateHint(); // Initial update
            }
          }, 100);
        }
      }

      // Update custom token sale hint
      function updateCustomTokenSaleHint(tokenSymbol) {
        const priceInput = document.getElementById('salePrice')?.value?.trim();
        const capInput = document.getElementById('saleCap')?.value?.trim();
        const tokenType = document.getElementById('saleTokenType')?.value || 'shares';

        const hint = document.getElementById('customTokenSaleHint');
        const hintText = document.getElementById('customTokenSaleHintText');

        if (!hint || !hintText) return;

        const price = parseFloat(priceInput);
        const cap = parseFloat(capInput);

        const tokenTypeText = tokenType === 'loot' ? 'Loot' : 'Share';

        // Show hint even without price - guide the user
        if (!priceInput || isNaN(price) || price <= 0) {
          hintText.innerHTML = `<span style="opacity: 0.6;">Enter price to see sale preview (e.g., "1 ${tokenSymbol} for 1 ${tokenTypeText}")</span>`;
          hint.style.display = 'block';
          return;
        }

        // Detect 1:1 upgrade path
        const is1to1 = price === 1;

        // Build the hint text - more natural word order: "1 DAI for 1 Share"
        let text = `<strong>${price} ${tokenSymbol}</strong> for <strong>1 ${tokenTypeText}</strong>`;

        if (cap && !isNaN(cap) && cap > 0) {
          text += ` up to <strong>${cap.toLocaleString()} ${tokenTypeText}${cap !== 1 ? 's' : ''}</strong>`;
        } else {
          text += ` <span style="opacity: 0.7;">(unlimited)</span>`;
        }

        // Add 1:1 upgrade path hint or cost example
        if (is1to1) {
          text += ` <span style="color: #9d7bff; font-weight: 600; margin-left: 0.5rem;">• 1:1 Upgrade Path</span>`;
        } else {
          // Add cost example
          const exampleAmount = 100;
          const exampleCost = exampleAmount * price;
          text += `<br><span style="opacity: 0.6; font-size: 0.85em;">Example: ${exampleCost.toLocaleString()} ${tokenSymbol} buys ${exampleAmount} ${tokenTypeText}s</span>`;
        }

        hintText.innerHTML = text;
        hint.style.display = 'block';
      }

      function clearTransferHelper() {
        const helperDiv = document.getElementById('transferHelper');
        if (helperDiv) helperDiv.remove();
      }

      // Prepare custom token proposal (Send or Sale)
      async function prepareCustomTokenProposal() {
        if (!currentDAO || !currentDAO.dao) {
          showStatus('Please select a DAO first', true);
          return;
        }

        // Clear any existing helpers first
        clearTransferHelper();
        clearMintHelper();
        clearFutarchyHelper();
        clearQuorumHelper();
        clearTTLHelper();
        clearTimelockDelayHelper();
        clearThresholdHelper();
        clearRagequitHelper();
        clearSaleHelper();

        // Scroll to proposal form
        const proposalForm = document.querySelector('.proposal-form');
        if (proposalForm) {
          proposalForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Add custom token helper UI
        let helperDiv = document.createElement('div');
        helperDiv.id = 'transferHelper';
        helperDiv.style.cssText = 'margin-bottom: 1rem; padding: 1rem; background: rgba(157, 123, 255, 0.1); border: 1px solid rgba(157, 123, 255, 0.3); border-radius: 4px;';
        proposalForm.insertBefore(helperDiv, proposalForm.querySelector('.proposal-form-group'));

        helperDiv.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
            <div style="font-family: 'Cinzel', serif; font-size: 0.85rem; color: #9d7bff; letter-spacing: 0.1em;">CUSTOM TOKEN</div>
            <button onclick="clearTransferHelper()" style="background: none; border: none; color: rgba(230, 217, 255, 0.6); cursor: pointer; font-size: 1.2rem; padding: 0; line-height: 1;">&times;</button>
          </div>
          <div style="margin-bottom: 0.75rem; padding: 0.75rem; background: rgba(157, 123, 255, 0.05); border-left: 3px solid rgba(157, 123, 255, 0.3); font-size: 0.8rem; color: rgba(230, 217, 255, 0.8); line-height: 1.5;">
            <strong>Step 1:</strong> Enter token address and click "Fetch" to load token info<br>
            <strong>Step 2:</strong> Choose "Send" or "Sale" action after token is loaded
          </div>
          <div style="margin-bottom: 0.75rem;">
            <label style="display: block; font-size: 0.75rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.35rem;">
              Token Address
              <span title="Enter a custom ERC20 token address. Use for token upgrades, custom sales, or transfers." style="cursor: help; margin-left: 0.25rem;">ℹ️</span>
            </label>
            <div style="display: flex; gap: 0.5rem;">
              <input type="text" id="proposalCustomTokenAddress" placeholder="0x..." autocomplete="off"
                     onkeydown="if(event.key==='Enter'){event.preventDefault();fetchAndShowCustomToken();}"
                     style="flex: 1; padding: 0.6rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 16px;" />
              <button type="button" onclick="fetchAndShowCustomToken()"
                      style="padding: 0.6rem 1rem; background: rgba(157, 123, 255, 0.2); border: 1px solid rgba(157, 123, 255, 0.4); color: #e6d9ff; font-family: 'Cinzel', serif; font-size: 0.75rem; letter-spacing: 0.1em; cursor: pointer; white-space: nowrap; min-height: 44px;">
                Fetch Token Info
              </button>
            </div>
            <div id="proposalCustomTokenInfoDisplay" style="margin-top: 0.5rem; font-size: 0.75rem; color: rgba(230, 217, 255, 0.7);"></div>
          </div>
          <div id="customTokenActions" style="display: none;"></div>
        `;

        setTimeout(() => {
          const addressInput = document.getElementById('proposalCustomTokenAddress');
          if (addressInput) addressInput.focus();
        }, 100);
      }

      // Fetch custom token info and show Send/Sale options
      async function fetchAndShowCustomToken() {
        try {
          const inputEl = document.getElementById('proposalCustomTokenAddress');
          const infoDiv = document.getElementById('proposalCustomTokenInfoDisplay');
          const actionsDiv = document.getElementById('customTokenActions');

          if (!infoDiv || !actionsDiv) {
            return;
          }

          if (!inputEl) {
            infoDiv.innerHTML = '<span style="color: #ff6b6b;">Input field not found - try reopening the form</span>';
            actionsDiv.style.display = 'none';
            return;
          }

          const tokenAddress = inputEl.value?.trim();

          if (!tokenAddress || tokenAddress.length === 0) {
            infoDiv.innerHTML = '<span style="color: #ff6b6b;">Please enter a token address</span>';
            actionsDiv.style.display = 'none';
            return;
          }

          // Validate Ethereum address format
          if (!ethers.isAddress(tokenAddress)) {
            infoDiv.innerHTML = '<span style="color: #ff6b6b;">Invalid Ethereum address format</span>';
            actionsDiv.style.display = 'none';
            return;
          }

          // Normalize to checksummed address
          const checksummedAddress = ethers.getAddress(tokenAddress);

          if (!currentDAO || !currentDAO.dao || !currentDAO.dao.dao) {
            infoDiv.innerHTML = '<span style="color: #ff6b6b;">Please select a DAO first</span>';
            actionsDiv.style.display = 'none';
            return;
          }

          if (!provider) {
            infoDiv.innerHTML = '<span style="color: #ff6b6b;">Wallet not connected</span>';
            actionsDiv.style.display = 'none';
            showStatus('Please connect your wallet first', true);
            return;
          }

          infoDiv.innerHTML = 'Fetching token info...';
          actionsDiv.style.display = 'none';

          const tokenContract = new ethers.Contract(checksummedAddress, ERC20_ABI, provider);

          // Fetch token info with individual error handling for better diagnostics
          let name, symbol, decimals, daoBalance;

          try {
            name = await tokenContract.name();
          } catch (e) {
            console.warn('Failed to fetch token name:', e);
            name = 'Unknown';
          }

          try {
            symbol = await tokenContract.symbol();
          } catch (e) {
            console.warn('Failed to fetch token symbol:', e);
            symbol = 'UNKNOWN';
          }

          try {
            decimals = await tokenContract.decimals();
          } catch (e) {
            console.warn('Failed to fetch token decimals:', e);
            decimals = 18;
          }

          try {
            daoBalance = await tokenContract.balanceOf(currentDAO.dao.dao);
          } catch (e) {
            console.warn('Failed to fetch DAO balance:', e);
            daoBalance = 0n;
          }

          // Cache the result
          customTokenCache[checksummedAddress.toLowerCase()] = { name, symbol, decimals: Number(decimals) };

          const balanceFormatted = parseFloat(ethers.formatUnits(daoBalance, decimals)).toFixed(2);

          infoDiv.innerHTML = `
            <div style="padding: 0.5rem; background: rgba(157, 123, 255, 0.1); border-left: 3px solid #9d7bff; border-radius: 2px;">
              <div><strong>${name}</strong> (${symbol})</div>
              <div style="font-size: 0.7rem; opacity: 0.8; margin-top: 0.25rem;">${decimals} decimals • DAO Balance: ${balanceFormatted}</div>
              <div style="font-size: 0.65rem; opacity: 0.6; margin-top: 0.25rem; font-family: monospace;">${checksummedAddress}</div>
            </div>
          `;

          // Store token info in the helper div for later use
          const helperDiv = document.getElementById('transferHelper');
          if (helperDiv) {
            helperDiv.dataset.assetSymbol = symbol;
            helperDiv.dataset.assetAddress = checksummedAddress;
            helperDiv.dataset.assetDecimals = decimals;
          }

          // Show Send/Sale toggle with clear instructions (Sale only for 18-decimal tokens)
          actionsDiv.style.display = 'block';
          const showSaleToggle = Number(decimals) === 18;
          const saleButtonHTML = showSaleToggle ? `
                <button id="saleToggle" onclick="toggleProposalMode('sale')"
                        style="flex: 1; padding: 0.5rem 0.75rem; background: transparent; border: none; color: rgba(230, 217, 255, 0.6); font-family: 'Cinzel', serif; font-size: 0.7rem; letter-spacing: 0.1em; cursor: pointer; text-transform: uppercase; transition: all 0.2s ease; min-height: 44px;">
                  Sale
                </button>` : '';
          const decimalWarning = !showSaleToggle ? `
              <div style="margin-top: 0.5rem; padding: 0.5rem; background: rgba(255, 193, 7, 0.1); border-left: 3px solid rgba(255, 193, 7, 0.5); font-size: 0.7rem; color: rgba(255, 193, 7, 0.9);">
                ⚠️ Token sales require 18-decimal tokens. This ${decimals}-decimal token can only be sent.
              </div>` : '';

          actionsDiv.innerHTML = `
            <div style="padding: 0.75rem; background: rgba(157, 123, 255, 0.1); border: 1px solid rgba(157, 123, 255, 0.3); border-radius: 4px; margin-bottom: 0.75rem;">
              <div style="font-size: 0.75rem; color: rgba(230, 217, 255, 0.8); margin-bottom: 0.5rem;">✓ Token loaded! Choose an action:</div>
              <div style="display: flex; background: rgba(0, 0, 0, 0.3); border-radius: 4px; overflow: hidden;">
                <button id="sendToggle" onclick="toggleProposalMode('send')"
                        style="flex: 1; padding: 0.5rem 0.75rem; background: rgba(157, 123, 255, 0.3); border: none; color: #e6d9ff; font-family: 'Cinzel', serif; font-size: 0.7rem; letter-spacing: 0.1em; cursor: pointer; text-transform: uppercase; transition: all 0.2s ease; min-height: 44px;">
                  Send
                </button>${saleButtonHTML}
              </div>${decimalWarning}
            </div>
            <div id="proposalFields"></div>
          `;

          // Show send mode by default
          toggleProposalMode('send');

        } catch (error) {
          console.error('Error fetching custom token:', error);
          const infoDiv = document.getElementById('proposalCustomTokenInfoDisplay');
          const actionsDiv = document.getElementById('customTokenActions');

          let errorMsg = 'Failed to fetch token info';
          if (error.message) {
            if (error.message.includes('network') || error.message.includes('connection')) {
              errorMsg = 'Network error - check your connection';
            } else if (error.message.includes('invalid') || error.message.includes('not a contract')) {
              errorMsg = 'Invalid token address - not an ERC20 contract';
            } else {
              errorMsg = `Error: ${error.message.slice(0, 100)}`;
            }
          }

          if (infoDiv) {
            infoDiv.innerHTML = `<span style="color: #ff6b6b;">${errorMsg}</span>`;
          }
          if (actionsDiv) {
            actionsDiv.style.display = 'none';
          }
        }
      }

      async function populateTransferProposal(symbol, address, decimals) {
        try {
          const recipientInput = document.getElementById('transferRecipient').value.trim();
          const amountInput = document.getElementById('transferAmount').value.trim();

          if (!recipientInput) {
            showStatus('Please enter recipient address or ENS', true);
            return;
          }

          if (!amountInput || isNaN(amountInput) || parseFloat(amountInput) <= 0) {
            showStatus('Please enter valid amount', true);
            return;
          }

          showStatus('Resolving address...', false);

          // Resolve ENS if needed
          let recipientAddress = recipientInput;
          if (recipientInput.endsWith('.eth') || !recipientInput.startsWith('0x')) {
            if (!provider) {
              showStatus('Provider not available for ENS resolution', true);
              return;
            }
            try {
              const resolved = await provider.resolveName(recipientInput);
              if (!resolved) {
                showStatus('Could not resolve ENS name', true);
                return;
              }
              recipientAddress = resolved;
              showStatus(`Resolved to ${recipientAddress.slice(0, 6)}...${recipientAddress.slice(-4)}`, false);
            } catch (error) {
              showStatus('ENS resolution failed', true);
              return;
            }
          }

          // Validate address
          if (!ethers.isAddress(recipientAddress)) {
            showStatus('Invalid address', true);
            return;
          }

          const amount = amountInput;
          const amountWei = ethers.parseUnits(amount, decimals);

          // Populate form
          if (symbol === 'ETH') {
            // For ETH: target is recipient, value is amount, no calldata
            document.getElementById('proposalTo').value = recipientAddress;
            document.getElementById('proposalValue').value = amount;
            document.getElementById('proposalData').value = '0x';
            document.getElementById('proposalDescription').value = `Transfer ${amount} ETH to ${recipientInput}`;
          } else {
            // For ERC20: target is token contract, encode transfer calldata
            // transfer(address recipient, uint256 amount)
            const abiCoder = new ethers.AbiCoder();
            const transferCalldata = '0xa9059cbb' + abiCoder.encode(
              ['address', 'uint256'],
              [recipientAddress, amountWei]
            ).slice(2);

            document.getElementById('proposalTo').value = address;
            document.getElementById('proposalValue').value = '0';
            document.getElementById('proposalData').value = transferCalldata;
            document.getElementById('proposalDescription').value = `Transfer ${amount} ${symbol} to ${recipientInput}`;
          }

          // Update UI hints and translations
          updateTargetAddressHint();
          updateCalldataTranslation();
          updateCalldataPreview();

          showStatus('Proposal form populated!', false);
          clearTransferHelper();

          // Scroll to show the populated form
          setTimeout(() => {
            document.getElementById('proposalDescription').scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);

        } catch (error) {
          console.error('Error populating transfer proposal:', error);
          showStatus('Failed to populate form: ' + error.message, true);
        }
      }

      // Prepare mint proposal for shares or loot
      async function prepareMintProposal(tokenType) {
        if (!currentDAO || !currentDAO.dao) {
          showStatus('Please select a DAO first', true);
          return;
        }

        const dao = currentDAO.dao;
        const tokenAddress = tokenType === 'shares' ? dao.meta.sharesToken : dao.meta.lootToken;
        const tokenSymbol = tokenType === 'shares' ? dao.meta.symbol : `${dao.meta.symbol}-LOOT`;

        if (!tokenAddress) {
          showStatus(`${tokenType} token address not found`, true);
          return;
        }

        // Scroll to proposal form
        const proposalForm = document.querySelector('.proposal-form');
        if (proposalForm) {
          proposalForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Add mint helper UI if not already present
        let helperDiv = document.getElementById('mintHelper');
        if (!helperDiv) {
          helperDiv = document.createElement('div');
          helperDiv.id = 'mintHelper';
          helperDiv.style.cssText = 'margin-bottom: 1rem; padding: 1rem; background: rgba(157, 123, 255, 0.1); border: 1px solid rgba(157, 123, 255, 0.3); border-radius: 4px;';
          proposalForm.insertBefore(helperDiv, proposalForm.querySelector('.proposal-form-group'));
        }

        // Show mint helper
        helperDiv.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
            <div style="font-family: 'Cinzel', serif; font-size: 0.85rem; color: #9d7bff; letter-spacing: 0.1em;">
              MINT ${tokenType.toUpperCase()}
            </div>
            <button onclick="clearMintHelper()" style="background: none; border: none; color: rgba(230, 217, 255, 0.6); cursor: pointer; font-size: 1.2rem; padding: 0; line-height: 1;">&times;</button>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
            <div>
              <label style="display: block; font-size: 0.75rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.35rem;">Recipient Address or ENS</label>
              <input type="text" id="mintRecipient" placeholder="vitalik.eth or 0x..."
                     style="width: 100%; padding: 0.6rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 0.95rem;" />
            </div>
            <div>
              <label style="display: block; font-size: 0.75rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.35rem;">Amount (${tokenSymbol})</label>
              <input type="text" id="mintAmount" placeholder="0.0"
                     style="width: 100%; padding: 0.6rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 0.95rem;" />
            </div>
          </div>
          <button onclick="populateMintProposal('${tokenType}', '${tokenSymbol}', '${tokenAddress}')"
                  onmouseover="this.style.background='rgba(157, 123, 255, 0.35)'; this.style.borderColor='#9d7bff'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(157, 123, 255, 0.3)';"
                  onmouseout="this.style.background='rgba(157, 123, 255, 0.2)'; this.style.borderColor='rgba(157, 123, 255, 0.4)'; this.style.transform='translateY(0)'; this.style.boxShadow='none';"
                  style="width: 100%; padding: 0.75rem; background: rgba(157, 123, 255, 0.2); border: 1px solid rgba(157, 123, 255, 0.4); color: #e6d9ff; font-family: 'Cinzel', serif; font-size: 0.75rem; letter-spacing: 0.15em; cursor: pointer; text-transform: uppercase; transition: all 0.2s ease; font-weight: 600;">
            Populate Proposal Form
          </button>
        `;

        // Focus on recipient input
        setTimeout(() => {
          const recipientInput = document.getElementById('mintRecipient');
          if (recipientInput) recipientInput.focus();
        }, 100);
      }

      function clearMintHelper() {
        const helperDiv = document.getElementById('mintHelper');
        if (helperDiv) helperDiv.remove();
      }

      async function populateMintProposal(tokenType, tokenSymbol, tokenAddress) {
        try {
          const recipientInput = document.getElementById('mintRecipient').value.trim();
          const amountInput = document.getElementById('mintAmount').value.trim();

          if (!recipientInput) {
            showStatus('Please enter recipient address or ENS', true);
            return;
          }

          if (!amountInput || isNaN(amountInput) || parseFloat(amountInput) <= 0) {
            showStatus('Please enter valid amount', true);
            return;
          }

          showStatus('Resolving address...', false);

          // Resolve ENS if needed
          let recipientAddress = recipientInput;
          if (recipientInput.endsWith('.eth') || !recipientInput.startsWith('0x')) {
            if (!provider) {
              showStatus('Provider not available for ENS resolution', true);
              return;
            }
            try {
              const resolved = await provider.resolveName(recipientInput);
              if (!resolved) {
                showStatus('Could not resolve ENS name', true);
                return;
              }
              recipientAddress = resolved;
              showStatus(`Resolved to ${recipientAddress.slice(0, 6)}...${recipientAddress.slice(-4)}`, false);
            } catch (error) {
              showStatus('ENS resolution failed', true);
              return;
            }
          }

          // Validate address
          if (!ethers.isAddress(recipientAddress)) {
            showStatus('Invalid address', true);
            return;
          }

          const amount = amountInput;
          const amountWei = ethers.parseUnits(amount, 18); // Shares and loot are always 18 decimals

          // Encode mintFromMoloch(address recipient, uint256 amount)
          const mintCalldata = INTERFACES.mintFromMoloch.encodeFunctionData('mintFromMoloch', [recipientAddress, amountWei]);

          document.getElementById('proposalTo').value = tokenAddress;
          document.getElementById('proposalValue').value = '0';
          document.getElementById('proposalData').value = mintCalldata;
          document.getElementById('proposalDescription').value = `Mint ${amount} ${tokenSymbol} to ${recipientInput}`;

          // Update UI hints and translations
          updateTargetAddressHint();
          updateCalldataTranslation();
          updateCalldataPreview();

          showStatus('Proposal form populated!', false);
          clearMintHelper();

          // Scroll to show the populated form
          setTimeout(() => {
            document.getElementById('proposalDescription').scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);

        } catch (error) {
          console.error('Error populating mint proposal:', error);
          showStatus('Failed to populate form: ' + error.message, true);
        }
      }

      // Prepare futarchy proposal for DAO self-configuration
      async function prepareFutarchyProposal() {
        if (!currentDAO || !currentDAO.dao) {
          showStatus('Please select a DAO first', true);
          return;
        }

        const dao = currentDAO.dao;
        const daoAddress = dao.dao;

        // Scroll to proposal form
        const proposalForm = document.querySelector('.proposal-form');
        if (proposalForm) {
          proposalForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Add futarchy helper UI if not already present
        let helperDiv = document.getElementById('futarchyHelper');
        if (!helperDiv) {
          helperDiv = document.createElement('div');
          helperDiv.id = 'futarchyHelper';
          helperDiv.style.cssText = 'margin-bottom: 1rem; padding: 1rem; background: rgba(157, 123, 255, 0.1); border: 1px solid rgba(157, 123, 255, 0.3); border-radius: 4px;';
          proposalForm.insertBefore(helperDiv, proposalForm.querySelector('.proposal-form-group'));
        }

        // Get current futarchy settings
        const currentParam = BigInt(dao.gov.autoFutarchyParam || 0);
        const currentCap = BigInt(dao.gov.autoFutarchyCap || 0);
        let currentPreset = 'off';

        if (currentParam > 0n && currentCap > 0n) {
          if (currentParam === 5n && currentCap === ethers.parseEther('2')) {
            currentPreset = 'low';
          } else if (currentParam === 10n && currentCap === ethers.parseEther('5')) {
            currentPreset = 'standard';
          } else if (currentParam === 50n && currentCap === ethers.parseEther('10')) {
            currentPreset = 'high';
          } else {
            currentPreset = 'custom';
          }
        }

        // Show futarchy helper
        helperDiv.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
            <div style="font-family: 'Cinzel', serif; font-size: 0.85rem; color: #9d7bff; letter-spacing: 0.1em;">
              CONFIGURE AUTO-FUTARCHY
            </div>
            <button onclick="clearFutarchyHelper()" style="background: none; border: none; color: rgba(230, 217, 255, 0.6); cursor: pointer; font-size: 1.2rem; padding: 0; line-height: 1;">&times;</button>
          </div>
          <div style="margin-bottom: 0.75rem;">
            <label style="display: block; font-size: 0.75rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.35rem;">Preset</label>
            <select id="futarchyPreset"
                    style="width: 100%; padding: 0.6rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 0.95rem;">
              <option value="off" ${currentPreset === 'off' ? 'selected' : ''}>Off (Disable auto-futarchy)</option>
              <option value="low" ${currentPreset === 'low' ? 'selected' : ''}>Low: 0.05% supply, 2 LOOT cap</option>
              <option value="standard" ${currentPreset === 'standard' ? 'selected' : ''}>Standard: 0.1% supply, 5 LOOT cap</option>
              <option value="high" ${currentPreset === 'high' ? 'selected' : ''}>High: 0.5% supply, 10 LOOT cap</option>
            </select>
            <div style="margin-top: 0.5rem; font-size: 0.75rem; color: rgba(230, 217, 255, 0.5);">
              Auto-futarchy mints LOOT rewards to winning voters (% of total supply, capped per proposal)
            </div>
          </div>
          <button onclick="populateFutarchyProposal('${daoAddress}')"
                  onmouseover="this.style.background='rgba(157, 123, 255, 0.35)'; this.style.borderColor='#9d7bff'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(157, 123, 255, 0.3)';"
                  onmouseout="this.style.background='rgba(157, 123, 255, 0.2)'; this.style.borderColor='rgba(157, 123, 255, 0.4)'; this.style.transform='translateY(0)'; this.style.boxShadow='none';"
                  style="width: 100%; padding: 0.75rem; background: rgba(157, 123, 255, 0.2); border: 1px solid rgba(157, 123, 255, 0.4); color: #e6d9ff; font-family: 'Cinzel', serif; font-size: 0.75rem; letter-spacing: 0.15em; cursor: pointer; text-transform: uppercase; transition: all 0.2s ease; font-weight: 600;">
            Populate Proposal Form
          </button>
        `;

        // Focus on preset dropdown
        setTimeout(() => {
          const presetSelect = document.getElementById('futarchyPreset');
          if (presetSelect) presetSelect.focus();
        }, 100);
      }

      function clearFutarchyHelper() {
        const helperDiv = document.getElementById('futarchyHelper');
        if (helperDiv) helperDiv.remove();
      }

      async function populateFutarchyProposal(daoAddress) {
        try {
          const preset = document.getElementById('futarchyPreset').value;

          let param = 0n;
          let cap = 0n;
          let description = '';

          if (preset === 'off') {
            param = 0n;
            cap = 0n;
            description = 'Disable auto-futarchy (turn off voter rewards)';
          } else if (preset === 'low') {
            param = 5n;  // 5 bps (0.05%)
            cap = ethers.parseEther('2');  // 2 LOOT
            description = 'Enable auto-futarchy: Low (0.05% supply, 2 LOOT cap)';
          } else if (preset === 'standard') {
            param = 10n;  // 10 bps (0.1%)
            cap = ethers.parseEther('5');  // 5 LOOT
            description = 'Enable auto-futarchy: Standard (0.1% supply, 5 LOOT cap)';
          } else if (preset === 'high') {
            param = 50n;  // 50 bps (0.5%)
            cap = ethers.parseEther('10');  // 10 LOOT
            description = 'Enable auto-futarchy: High (0.5% supply, 10 LOOT cap)';
          }

          // Encode setAutoFutarchy(uint256 param, uint256 cap)
          const futarchyCalldata = INTERFACES.setAutoFutarchy.encodeFunctionData('setAutoFutarchy', [param, cap]);

          document.getElementById('proposalTo').value = daoAddress;
          document.getElementById('proposalValue').value = '0';
          document.getElementById('proposalData').value = futarchyCalldata;
          document.getElementById('proposalDescription').value = description;

          // Update UI hints and translations
          updateTargetAddressHint();
          updateCalldataTranslation();
          updateCalldataPreview();

          showStatus('Proposal form populated!', false);
          clearFutarchyHelper();

          // Scroll to show the populated form
          setTimeout(() => {
            document.getElementById('proposalDescription').scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);

        } catch (error) {
          console.error('Error populating futarchy proposal:', error);
          showStatus('Failed to populate form: ' + error.message, true);
        }
      }

      // Renderer proposal helper
      async function prepareRendererProposal() {
        if (!currentDAO || !currentDAO.dao) {
          showStatus('Please select a DAO first', true);
          return;
        }

        const dao = currentDAO.dao;
        const daoAddress = dao.dao;
        const currentRenderer = dao.meta.renderer;

        // Scroll to proposal form
        const proposalForm = document.querySelector('.proposal-form');
        if (proposalForm) {
          proposalForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Add renderer helper UI if not already present
        let helperDiv = document.getElementById('rendererHelper');
        if (!helperDiv) {
          helperDiv = document.createElement('div');
          helperDiv.id = 'rendererHelper';
          helperDiv.style.cssText = 'margin-bottom: 1rem; padding: 1rem; background: rgba(157, 123, 255, 0.1); border: 1px solid rgba(157, 123, 255, 0.3); border-radius: 4px;';
          proposalForm.insertBefore(helperDiv, proposalForm.querySelector('.proposal-form-group'));
        }

        // Show renderer helper
        helperDiv.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
            <div style="font-family: 'Cinzel', serif; font-size: 0.85rem; color: #9d7bff; letter-spacing: 0.1em;">
              CHANGE RENDERER
            </div>
            <button onclick="clearRendererHelper()" style="background: none; border: none; color: rgba(230, 217, 255, 0.6); cursor: pointer; font-size: 1.2rem; padding: 0; line-height: 1;">&times;</button>
          </div>
          <div style="margin-bottom: 0.75rem;">
            <label style="display: block; font-size: 0.75rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.35rem;">Current Renderer</label>
            <div style="font-size: 0.85rem; color: rgba(230, 217, 255, 0.5); margin-bottom: 0.75rem; font-family: 'Courier New', monospace;">
              <a href="https://etherscan.io/address/${currentRenderer}" target="_blank" rel="noopener noreferrer" style="color: #9d7bff; text-decoration: none;">${currentRenderer}</a>
            </div>
            <label style="display: block; font-size: 0.75rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.35rem;">New Renderer Address</label>
            <input type="text" id="rendererAddress" placeholder="0x..."
                   style="width: 100%; padding: 0.6rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'Courier New', monospace; font-size: 0.85rem;" />
            <div style="margin-top: 0.5rem; font-size: 0.75rem; color: rgba(230, 217, 255, 0.5);">
              The renderer contract generates NFT metadata for receipts and badges
            </div>
          </div>
          <button onclick="populateRendererProposal('${daoAddress}')"
                  onmouseover="this.style.background='rgba(157, 123, 255, 0.35)'; this.style.borderColor='#9d7bff'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(157, 123, 255, 0.3)';"
                  onmouseout="this.style.background='rgba(157, 123, 255, 0.2)'; this.style.borderColor='rgba(157, 123, 255, 0.4)'; this.style.transform='translateY(0)'; this.style.boxShadow='none';"
                  style="width: 100%; padding: 0.75rem; background: rgba(157, 123, 255, 0.2); border: 1px solid rgba(157, 123, 255, 0.4); color: #e6d9ff; font-family: 'Cinzel', serif; font-size: 0.75rem; letter-spacing: 0.15em; cursor: pointer; text-transform: uppercase; transition: all 0.2s ease; font-weight: 600;">
            Populate Proposal Form
          </button>
        `;

        // Focus on input
        setTimeout(() => {
          const input = document.getElementById('rendererAddress');
          if (input) {
            input.focus();
          }
        }, 100);
      }

      function clearRendererHelper() {
        const helperDiv = document.getElementById('rendererHelper');
        if (helperDiv) helperDiv.remove();
      }

      async function populateRendererProposal(daoAddress) {
        try {
          const rendererInput = document.getElementById('rendererAddress').value.trim();

          if (!rendererInput || !ethers.isAddress(rendererInput)) {
            showStatus('Please enter a valid Ethereum address', true);
            return;
          }

          // Encode setRenderer(address)
          const rendererCalldata = INTERFACES.setRenderer.encodeFunctionData('setRenderer', [rendererInput]);

          document.getElementById('proposalTo').value = daoAddress;
          document.getElementById('proposalValue').value = '0';
          document.getElementById('proposalData').value = rendererCalldata;
          document.getElementById('proposalDescription').value = `Change renderer to ${rendererInput}`;

          // Update UI hints and translations
          updateTargetAddressHint();
          updateCalldataTranslation();
          updateCalldataPreview();

          showStatus('Proposal form populated!', false);
          clearRendererHelper();

          // Scroll to show the populated form
          setTimeout(() => {
            document.getElementById('proposalDescription').scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);

        } catch (error) {
          console.error('Error populating renderer proposal:', error);
          showStatus('Failed to populate form: ' + error.message, true);
        }
      }

      // Quorum proposal helper
      async function prepareQuorumProposal() {
        if (!currentDAO || !currentDAO.dao) {
          showStatus('Please select a DAO first', true);
          return;
        }

        const dao = currentDAO.dao;
        const daoAddress = dao.dao;
        const currentQuorum = Number(dao.gov.quorumBps) / 100;

        // Scroll to proposal form
        const proposalForm = document.querySelector('.proposal-form');
        if (proposalForm) {
          proposalForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Add quorum helper UI if not already present
        let helperDiv = document.getElementById('quorumHelper');
        if (!helperDiv) {
          helperDiv = document.createElement('div');
          helperDiv.id = 'quorumHelper';
          helperDiv.style.cssText = 'margin-bottom: 1rem; padding: 1rem; background: rgba(157, 123, 255, 0.1); border: 1px solid rgba(157, 123, 255, 0.3); border-radius: 4px;';
          proposalForm.insertBefore(helperDiv, proposalForm.querySelector('.proposal-form-group'));
        }

        // Show quorum helper
        helperDiv.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
            <div style="font-family: 'Cinzel', serif; font-size: 0.85rem; color: #9d7bff; letter-spacing: 0.1em;">
              CHANGE QUORUM
            </div>
            <button onclick="clearQuorumHelper()" style="background: none; border: none; color: rgba(230, 217, 255, 0.6); cursor: pointer; font-size: 1.2rem; padding: 0; line-height: 1;">&times;</button>
          </div>
          <div style="margin-bottom: 0.75rem;">
            <label style="display: block; font-size: 0.75rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.35rem;">New Quorum Percentage</label>
            <input type="text" id="quorumPercentage" placeholder="${currentQuorum}" value="${currentQuorum}"
                   style="width: 100%; padding: 0.6rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 0.95rem;" />
            <div style="margin-top: 0.5rem; font-size: 0.75rem; color: rgba(230, 217, 255, 0.5);">
              Quorum is the minimum % of shares required to pass proposals
            </div>
          </div>
          <button onclick="populateQuorumProposal('${daoAddress}')"
                  onmouseover="this.style.background='rgba(157, 123, 255, 0.35)'; this.style.borderColor='#9d7bff'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(157, 123, 255, 0.3)';"
                  onmouseout="this.style.background='rgba(157, 123, 255, 0.2)'; this.style.borderColor='rgba(157, 123, 255, 0.4)'; this.style.transform='translateY(0)'; this.style.boxShadow='none';"
                  style="width: 100%; padding: 0.75rem; background: rgba(157, 123, 255, 0.2); border: 1px solid rgba(157, 123, 255, 0.4); color: #e6d9ff; font-family: 'Cinzel', serif; font-size: 0.75rem; letter-spacing: 0.15em; cursor: pointer; text-transform: uppercase; transition: all 0.2s ease; font-weight: 600;">
            Populate Proposal Form
          </button>
        `;

        // Focus on input
        setTimeout(() => {
          const input = document.getElementById('quorumPercentage');
          if (input) {
            input.select();
            input.focus();
          }
        }, 100);
      }

      function clearQuorumHelper() {
        const helperDiv = document.getElementById('quorumHelper');
        if (helperDiv) helperDiv.remove();
      }

      async function populateQuorumProposal(daoAddress) {
        try {
          const percentInput = document.getElementById('quorumPercentage').value.trim();

          if (!percentInput || isNaN(percentInput) || parseFloat(percentInput) < 0 || parseFloat(percentInput) > 100) {
            showStatus('Please enter a valid percentage (0-100)', true);
            return;
          }

          const quorumBps = Math.floor(parseFloat(percentInput) * 100);

          // Encode setQuorumBps(uint16 bps)
          const calldata = INTERFACES.setQuorumBps.encodeFunctionData('setQuorumBps', [quorumBps]);

          document.getElementById('proposalTo').value = daoAddress;
          document.getElementById('proposalValue').value = '0';
          document.getElementById('proposalData').value = calldata;
          document.getElementById('proposalDescription').value = `Change quorum to ${percentInput}%`;

          // Update UI hints and translations
          updateTargetAddressHint();
          updateCalldataTranslation();
          updateCalldataPreview();

          showStatus('Proposal form populated!', false);
          clearQuorumHelper();

          // Scroll to show the populated form
          setTimeout(() => {
            document.getElementById('proposalDescription').scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);

        } catch (error) {
          console.error('Error populating quorum proposal:', error);
          showStatus('Failed to populate form: ' + error.message, true);
        }
      }

      // TTL proposal helper
      async function prepareTTLProposal() {
        if (!currentDAO || !currentDAO.dao) {
          showStatus('Please select a DAO first', true);
          return;
        }

        const dao = currentDAO.dao;
        const daoAddress = dao.dao;
        const currentTTL = Number(dao.gov.proposalTTL || 0);

        // Scroll to proposal form
        const proposalForm = document.querySelector('.proposal-form');
        if (proposalForm) {
          proposalForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Add TTL helper UI if not already present
        let helperDiv = document.getElementById('ttlHelper');
        if (!helperDiv) {
          helperDiv = document.createElement('div');
          helperDiv.id = 'ttlHelper';
          helperDiv.style.cssText = 'margin-bottom: 1rem; padding: 1rem; background: rgba(157, 123, 255, 0.1); border: 1px solid rgba(157, 123, 255, 0.3); border-radius: 4px;';
          proposalForm.insertBefore(helperDiv, proposalForm.querySelector('.proposal-form-group'));
        }

        // Convert current TTL to most appropriate unit
        let defaultValue, defaultUnit;
        if (currentTTL % 86400 === 0 && currentTTL > 0) {
          defaultValue = currentTTL / 86400;
          defaultUnit = '86400';
        } else if (currentTTL % 3600 === 0 && currentTTL > 0) {
          defaultValue = currentTTL / 3600;
          defaultUnit = '3600';
        } else if (currentTTL % 60 === 0 && currentTTL > 0) {
          defaultValue = currentTTL / 60;
          defaultUnit = '60';
        } else {
          defaultValue = currentTTL;
          defaultUnit = '1';
        }

        // Show TTL helper
        helperDiv.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
            <div style="font-family: 'Cinzel', serif; font-size: 0.85rem; color: #9d7bff; letter-spacing: 0.1em;">
              CHANGE PROPOSAL TTL
            </div>
            <button onclick="clearTTLHelper()" style="background: none; border: none; color: rgba(230, 217, 255, 0.6); cursor: pointer; font-size: 1.2rem; padding: 0; line-height: 1;">&times;</button>
          </div>
          <div style="margin-bottom: 0.75rem;">
            <label style="display: block; font-size: 0.75rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.35rem;">New Proposal TTL</label>
            <div style="display: flex; gap: 0.5rem;">
              <input type="number" id="ttlValue" placeholder="${defaultValue}" value="${defaultValue}"
                     style="flex: 1; padding: 0.6rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 0.95rem;" />
              <select id="ttlUnit" style="padding: 0.6rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 0.95rem;">
                <option value="86400" ${defaultUnit === '86400' ? 'selected' : ''}>Days</option>
                <option value="3600" ${defaultUnit === '3600' ? 'selected' : ''}>Hours</option>
                <option value="60" ${defaultUnit === '60' ? 'selected' : ''}>Minutes</option>
                <option value="1" ${defaultUnit === '1' ? 'selected' : ''}>Seconds</option>
              </select>
            </div>
            <div style="margin-top: 0.5rem; font-size: 0.75rem; color: rgba(230, 217, 255, 0.5);">
              Current: ${formatDuration(currentTTL)}. TTL determines how long proposals remain active before expiring.
            </div>
          </div>
          <button onclick="populateTTLProposal('${daoAddress}')"
                  onmouseover="this.style.background='rgba(157, 123, 255, 0.35)'; this.style.borderColor='#9d7bff'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(157, 123, 255, 0.3)';"
                  onmouseout="this.style.background='rgba(157, 123, 255, 0.2)'; this.style.borderColor='rgba(157, 123, 255, 0.4)'; this.style.transform='translateY(0)'; this.style.boxShadow='none';"
                  style="width: 100%; padding: 0.75rem; background: rgba(157, 123, 255, 0.2); border: 1px solid rgba(157, 123, 255, 0.4); color: #e6d9ff; font-family: 'Cinzel', serif; font-size: 0.75rem; letter-spacing: 0.15em; cursor: pointer; text-transform: uppercase; transition: all 0.2s ease; font-weight: 600;">
            Populate Proposal Form
          </button>
        `;

        // Focus on input
        setTimeout(() => {
          const input = document.getElementById('ttlValue');
          if (input) {
            input.select();
            input.focus();
          }
        }, 100);
      }

      function clearTTLHelper() {
        const helperDiv = document.getElementById('ttlHelper');
        if (helperDiv) helperDiv.remove();
      }

      async function populateTTLProposal(daoAddress) {
        try {
          const valueInput = document.getElementById('ttlValue').value.trim();
          const unitMultiplier = parseInt(document.getElementById('ttlUnit').value);

          if (!valueInput || isNaN(valueInput) || parseFloat(valueInput) < 0) {
            showStatus('Please enter a valid positive number', true);
            return;
          }

          const ttlSeconds = Math.floor(parseFloat(valueInput) * unitMultiplier);

          // Encode setProposalTTL(uint64)
          const calldata = INTERFACES.setProposalTTL.encodeFunctionData('setProposalTTL', [ttlSeconds]);

          document.getElementById('proposalTo').value = daoAddress;
          document.getElementById('proposalValue').value = '0';
          document.getElementById('proposalData').value = calldata;
          document.getElementById('proposalDescription').value = `Change proposal TTL to ${formatDuration(ttlSeconds)}`;

          // Update UI hints and translations
          updateTargetAddressHint();
          updateCalldataTranslation();
          updateCalldataPreview();

          showStatus('Proposal form populated!', false);
          clearTTLHelper();

          // Scroll to show the populated form
          setTimeout(() => {
            document.getElementById('proposalDescription').scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);

        } catch (error) {
          console.error('Error populating TTL proposal:', error);
          showStatus('Failed to populate form: ' + error.message, true);
        }
      }

      // Timelock Delay proposal helper
      async function prepareTimelockDelayProposal() {
        if (!currentDAO || !currentDAO.dao) {
          showStatus('Please select a DAO first', true);
          return;
        }

        const dao = currentDAO.dao;
        const daoAddress = dao.dao;
        const currentDelay = Number(dao.gov.timelockDelay || 0);

        // Scroll to proposal form
        const proposalForm = document.querySelector('.proposal-form');
        if (proposalForm) {
          proposalForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Add timelock delay helper UI if not already present
        let helperDiv = document.getElementById('timelockDelayHelper');
        if (!helperDiv) {
          helperDiv = document.createElement('div');
          helperDiv.id = 'timelockDelayHelper';
          helperDiv.style.cssText = 'margin-bottom: 1rem; padding: 1rem; background: rgba(157, 123, 255, 0.1); border: 1px solid rgba(157, 123, 255, 0.3); border-radius: 4px;';
          proposalForm.insertBefore(helperDiv, proposalForm.querySelector('.proposal-form-group'));
        }

        // Convert current delay to most appropriate unit
        let defaultValue, defaultUnit;
        if (currentDelay % 86400 === 0 && currentDelay > 0) {
          defaultValue = currentDelay / 86400;
          defaultUnit = '86400';
        } else if (currentDelay % 3600 === 0 && currentDelay > 0) {
          defaultValue = currentDelay / 3600;
          defaultUnit = '3600';
        } else if (currentDelay % 60 === 0 && currentDelay > 0) {
          defaultValue = currentDelay / 60;
          defaultUnit = '60';
        } else {
          defaultValue = currentDelay;
          defaultUnit = '1';
        }

        // Show timelock delay helper
        helperDiv.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
            <div style="font-family: 'Cinzel', serif; font-size: 0.85rem; color: #9d7bff; letter-spacing: 0.1em;">
              CHANGE TIMELOCK DELAY
            </div>
            <button onclick="clearTimelockDelayHelper()" style="background: none; border: none; color: rgba(230, 217, 255, 0.6); cursor: pointer; font-size: 1.2rem; padding: 0; line-height: 1;">&times;</button>
          </div>
          <div style="margin-bottom: 0.75rem;">
            <label style="display: block; font-size: 0.75rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.35rem;">New Timelock Delay</label>
            <div style="display: flex; gap: 0.5rem;">
              <input type="number" id="proposalTimelockDelayValue" placeholder="${defaultValue}" value="${defaultValue}"
                     style="flex: 1; padding: 0.6rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 0.95rem;" />
              <select id="proposalTimelockDelayUnit" style="padding: 0.6rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 0.95rem;">
                <option value="86400" ${defaultUnit === '86400' ? 'selected' : ''}>Days</option>
                <option value="3600" ${defaultUnit === '3600' ? 'selected' : ''}>Hours</option>
                <option value="60" ${defaultUnit === '60' ? 'selected' : ''}>Minutes</option>
                <option value="1" ${defaultUnit === '1' ? 'selected' : ''}>Seconds</option>
              </select>
            </div>
            <div style="margin-top: 0.5rem; font-size: 0.75rem; color: rgba(230, 217, 255, 0.5);">
              Current: ${formatDuration(currentDelay)}. Timelock delay determines how long to wait after a proposal passes before it can be executed.
            </div>
          </div>
          <button onclick="populateTimelockDelayProposal('${daoAddress}')"
                  onmouseover="this.style.background='rgba(157, 123, 255, 0.35)'; this.style.borderColor='#9d7bff'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(157, 123, 255, 0.3)';"
                  onmouseout="this.style.background='rgba(157, 123, 255, 0.2)'; this.style.borderColor='rgba(157, 123, 255, 0.4)'; this.style.transform='translateY(0)'; this.style.boxShadow='none';"
                  style="width: 100%; padding: 0.75rem; background: rgba(157, 123, 255, 0.2); border: 1px solid rgba(157, 123, 255, 0.4); color: #e6d9ff; font-family: 'Cinzel', serif; font-size: 0.75rem; letter-spacing: 0.15em; cursor: pointer; text-transform: uppercase; transition: all 0.2s ease; font-weight: 600;">
            Populate Proposal Form
          </button>
        `;

        // Focus on input
        setTimeout(() => {
          const input = document.getElementById('proposalTimelockDelayValue');
          if (input) {
            input.select();
            input.focus();
          }
        }, 100);
      }

      function clearTimelockDelayHelper() {
        const helperDiv = document.getElementById('timelockDelayHelper');
        if (helperDiv) helperDiv.remove();
      }

      async function populateTimelockDelayProposal(daoAddress) {
        try {
          const valueInput = document.getElementById('proposalTimelockDelayValue').value.trim();
          const unitMultiplier = parseInt(document.getElementById('proposalTimelockDelayUnit').value);

          if (!valueInput || isNaN(valueInput) || parseFloat(valueInput) < 0) {
            showStatus('Please enter a valid positive number', true);
            return;
          }

          const delaySeconds = Math.floor(parseFloat(valueInput) * unitMultiplier);

          // Encode setTimelockDelay(uint64)
          const calldata = INTERFACES.setTimelockDelay.encodeFunctionData('setTimelockDelay', [delaySeconds]);

          document.getElementById('proposalTo').value = daoAddress;
          document.getElementById('proposalValue').value = '0';
          document.getElementById('proposalData').value = calldata;
          document.getElementById('proposalDescription').value = `Change timelock delay to ${formatDuration(delaySeconds)}`;

          // Update UI hints and translations
          updateTargetAddressHint();
          updateCalldataTranslation();
          updateCalldataPreview();

          showStatus('Proposal form populated!', false);
          clearTimelockDelayHelper();

          // Scroll to show the populated form
          setTimeout(() => {
            document.getElementById('proposalDescription').scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);

        } catch (error) {
          console.error('Error populating timelock delay proposal:', error);
          showStatus('Failed to populate form: ' + error.message, true);
        }
      }

      // Proposal Threshold helper
      async function prepareThresholdProposal() {
        if (!currentDAO || !currentDAO.dao) {
          showStatus('Please select a DAO first', true);
          return;
        }

        const dao = currentDAO.dao;
        const daoAddress = dao.dao;
        const currentThreshold = BigInt(dao.gov.proposalThreshold || 0);
        const currentThresholdFormatted = parseFloat(ethers.formatUnits(currentThreshold, 18)).toFixed(2);

        // Get current total share supply (not including shares held by DAO)
        const totalShares = BigInt(dao.supplies.sharesTotalSupply || 0);
        const sharesHeldByDAO = BigInt(dao.supplies.sharesHeldByDAO || 0);
        const circulatingShares = totalShares - sharesHeldByDAO;
        const maxThreshold = parseFloat(ethers.formatUnits(circulatingShares, 18)).toFixed(2);

        // Scroll to proposal form
        const proposalForm = document.querySelector('.proposal-form');
        if (proposalForm) {
          proposalForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Add threshold helper UI if not already present
        let helperDiv = document.getElementById('thresholdHelper');
        if (!helperDiv) {
          helperDiv = document.createElement('div');
          helperDiv.id = 'thresholdHelper';
          helperDiv.style.cssText = 'margin-bottom: 1rem; padding: 1rem; background: rgba(157, 123, 255, 0.1); border: 1px solid rgba(157, 123, 255, 0.3); border-radius: 4px;';
          proposalForm.insertBefore(helperDiv, proposalForm.querySelector('.proposal-form-group'));
        }

        // Show threshold helper
        helperDiv.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
            <div style="font-family: 'Cinzel', serif; font-size: 0.85rem; color: #9d7bff; letter-spacing: 0.1em;">
              CHANGE PROPOSAL THRESHOLD
            </div>
            <button onclick="clearThresholdHelper()" style="background: none; border: none; color: rgba(230, 217, 255, 0.6); cursor: pointer; font-size: 1.2rem; padding: 0; line-height: 1;">&times;</button>
          </div>
          <div style="margin-bottom: 0.75rem;">
            <label style="display: block; font-size: 0.75rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.35rem;">New Proposal Threshold (shares)</label>
            <input type="number" id="thresholdValue" placeholder="${currentThresholdFormatted}" value="${currentThresholdFormatted}" step="0.01" min="0" max="${maxThreshold}"
                   style="width: 100%; padding: 0.6rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 0.95rem;" />
            <div style="margin-top: 0.5rem; font-size: 0.75rem; color: rgba(230, 217, 255, 0.5);">
              Current: <strong>${currentThresholdFormatted}</strong> shares. Max allowed: <strong>${maxThreshold}</strong> shares (total circulating supply).
            </div>
            <div style="margin-top: 0.35rem; font-size: 0.7rem; color: rgba(230, 217, 255, 0.4);">
              💡 Minimum shares required to create proposals. Cannot exceed current share supply.
            </div>
          </div>
          <button onclick="populateThresholdProposal('${daoAddress}', '${maxThreshold}')"
                  onmouseover="this.style.background='rgba(157, 123, 255, 0.35)'; this.style.borderColor='#9d7bff'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(157, 123, 255, 0.3)';"
                  onmouseout="this.style.background='rgba(157, 123, 255, 0.2)'; this.style.borderColor='rgba(157, 123, 255, 0.4)'; this.style.transform='translateY(0)'; this.style.boxShadow='none';"
                  style="width: 100%; padding: 0.75rem; background: rgba(157, 123, 255, 0.2); border: 1px solid rgba(157, 123, 255, 0.4); color: #e6d9ff; font-family: 'Cinzel', serif; font-size: 0.75rem; letter-spacing: 0.15em; cursor: pointer; text-transform: uppercase; transition: all 0.2s ease; font-weight: 600;">
            Populate Proposal Form
          </button>
        `;

        // Focus on input
        setTimeout(() => {
          const input = document.getElementById('thresholdValue');
          if (input) {
            input.select();
            input.focus();
          }
        }, 100);
      }

      function clearThresholdHelper() {
        const helperDiv = document.getElementById('thresholdHelper');
        if (helperDiv) helperDiv.remove();
      }

      async function populateThresholdProposal(daoAddress, maxThresholdStr) {
        try {
          const thresholdInput = document.getElementById('thresholdValue').value.trim();
          const maxThreshold = parseFloat(maxThresholdStr);

          if (!thresholdInput || isNaN(thresholdInput) || parseFloat(thresholdInput) < 0) {
            showStatus('Please enter a valid positive number', true);
            return;
          }

          const thresholdValue = parseFloat(thresholdInput);

          // Validate against max supply
          if (thresholdValue > maxThreshold) {
            showStatus(`Threshold cannot exceed total share supply (${maxThreshold} shares)`, true);
            return;
          }

          // Convert to wei (uint96)
          const thresholdWei = ethers.parseUnits(thresholdValue.toString(), 18);

          // Encode setProposalThreshold(uint96)
          const calldata = INTERFACES.setProposalThreshold.encodeFunctionData('setProposalThreshold', [thresholdWei]);

          document.getElementById('proposalTo').value = daoAddress;
          document.getElementById('proposalValue').value = '0';
          document.getElementById('proposalData').value = calldata;
          document.getElementById('proposalDescription').value = `Change proposal threshold to ${thresholdValue} shares`;

          // Update UI hints and translations
          updateTargetAddressHint();
          updateCalldataTranslation();
          updateCalldataPreview();

          showStatus('Proposal form populated!', false);
          clearThresholdHelper();

          // Scroll to show the populated form
          setTimeout(() => {
            document.getElementById('proposalDescription').scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);

        } catch (error) {
          console.error('Error populating threshold proposal:', error);
          showStatus('Failed to populate form: ' + error.message, true);
        }
      }

      // Ragequit proposal helper
      async function prepareRagequitProposal() {
        if (!currentDAO || !currentDAO.dao) {
          showStatus('Please select a DAO first', true);
          return;
        }

        const dao = currentDAO.dao;
        const daoAddress = dao.dao;
        const currentRagequit = dao.gov.ragequittable;

        // Scroll to proposal form
        const proposalForm = document.querySelector('.proposal-form');
        if (proposalForm) {
          proposalForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Add ragequit helper UI if not already present
        let helperDiv = document.getElementById('ragequitHelper');
        if (!helperDiv) {
          helperDiv = document.createElement('div');
          helperDiv.id = 'ragequitHelper';
          helperDiv.style.cssText = 'margin-bottom: 1rem; padding: 1rem; background: rgba(157, 123, 255, 0.1); border: 1px solid rgba(157, 123, 255, 0.3); border-radius: 4px;';
          proposalForm.insertBefore(helperDiv, proposalForm.querySelector('.proposal-form-group'));
        }

        const newStatus = !currentRagequit;
        const actionText = newStatus ? 'Enable' : 'Disable';

        // Show ragequit helper
        helperDiv.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
            <div style="font-family: 'Cinzel', serif; font-size: 0.85rem; color: #9d7bff; letter-spacing: 0.1em;">
              TOGGLE RAGEQUIT
            </div>
            <button onclick="clearRagequitHelper()" style="background: none; border: none; color: rgba(230, 217, 255, 0.6); cursor: pointer; font-size: 1.2rem; padding: 0; line-height: 1;">&times;</button>
          </div>
          <div style="margin-bottom: 0.75rem; padding: 0.75rem; background: rgba(157, 123, 255, 0.1); border-radius: 4px;">
            <div style="font-size: 0.85rem; color: rgba(230, 217, 255, 0.8); margin-bottom: 0.5rem;">
              Current Status: <strong>${currentRagequit ? 'Enabled' : 'Disabled'}</strong>
            </div>
            <div style="font-size: 0.85rem; color: rgba(230, 217, 255, 0.8);">
              This proposal will: <strong>${actionText} Ragequit</strong>
            </div>
            <div style="margin-top: 0.5rem; font-size: 0.75rem; color: rgba(230, 217, 255, 0.5);">
              Ragequit allows members to exit the DAO and claim their proportional share of treasury
            </div>
          </div>
          <button onclick="populateRagequitProposal('${daoAddress}', ${newStatus})"
                  onmouseover="this.style.background='rgba(157, 123, 255, 0.35)'; this.style.borderColor='#9d7bff'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(157, 123, 255, 0.3)';"
                  onmouseout="this.style.background='rgba(157, 123, 255, 0.2)'; this.style.borderColor='rgba(157, 123, 255, 0.4)'; this.style.transform='translateY(0)'; this.style.boxShadow='none';"
                  style="width: 100%; padding: 0.75rem; background: rgba(157, 123, 255, 0.2); border: 1px solid rgba(157, 123, 255, 0.4); color: #e6d9ff; font-family: 'Cinzel', serif; font-size: 0.75rem; letter-spacing: 0.15em; cursor: pointer; text-transform: uppercase; transition: all 0.2s ease; font-weight: 600;">
            Populate Proposal Form
          </button>
        `;
      }

      function clearRagequitHelper() {
        const helperDiv = document.getElementById('ragequitHelper');
        if (helperDiv) helperDiv.remove();
      }

      async function populateRagequitProposal(daoAddress, newStatus) {
        try {
          // Encode setRagequittable(bool)
          const calldata = INTERFACES.setRagequittable.encodeFunctionData('setRagequittable', [newStatus]);

          document.getElementById('proposalTo').value = daoAddress;
          document.getElementById('proposalValue').value = '0';
          document.getElementById('proposalData').value = calldata;
          document.getElementById('proposalDescription').value = `${newStatus ? 'Enable' : 'Disable'} ragequit`;

          // Update UI hints and translations
          updateTargetAddressHint();
          updateCalldataTranslation();
          updateCalldataPreview();

          showStatus('Proposal form populated!', false);
          clearRagequitHelper();

          // Scroll to show the populated form
          setTimeout(() => {
            document.getElementById('proposalDescription').scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);

        } catch (error) {
          console.error('Error populating ragequit proposal:', error);
          showStatus('Failed to populate form: ' + error.message, true);
        }
      }

      // Purchase modal functions
      async function openPurchaseModal(payToken, tokenSymbol, tokenDecimals, isLoot) {
        if (!signer) {
          showStatus('Please connect wallet first', true);
          return;
        }

        const modal = document.getElementById('purchaseModal');
        const content = document.getElementById('purchaseModalContent');

        const tokenType = isLoot ? 'LOOT' : 'SHARES';
        const daoSymbol = currentDAO.dao.meta.symbol;
        const targetSymbol = isLoot ? `${daoSymbol}-LOOT` : daoSymbol;

        // Show loading state
        content.innerHTML = `
          <div style="text-align: center; padding: 2rem; color: rgba(230, 217, 255, 0.6);">
            Loading balance...
          </div>
        `;
        modal.classList.add('show');

        try {
          // Fetch user balance and sale info
          const molochContract = new ethers.Contract(currentDAO.dao.dao, MOLOCH_ABI, provider);
          const sale = await molochContract.sales(payToken);

          let userBalance = 0n;
          if (payToken === ethers.ZeroAddress) {
            userBalance = await provider.getBalance(connectedAddress);
          } else {
            const tokenContract = new ethers.Contract(payToken, ERC20_ABI, provider);
            userBalance = await tokenContract.balanceOf(connectedAddress);
          }

          const balanceFormatted = parseFloat(ethers.formatUnits(userBalance, tokenDecimals)).toFixed(6);

          // Calculate max affordable shares based on user balance
          // pricePerShare is payToken wei per share wei
          let maxAffordable = '0';
          if (userBalance > 0n && sale.pricePerShare > 0n) {
            const maxShares = userBalance / sale.pricePerShare;
            maxAffordable = ethers.formatEther(maxShares);
          }

          content.innerHTML = `
            <div style="margin-bottom: 1rem;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <label style="font-size: 0.85rem; color: rgba(230, 217, 255, 0.7);">Amount to Purchase (${targetSymbol})</label>
                <button onclick="setMaxPurchaseAmount('${maxAffordable}')"
                        onmouseover="this.style.background='rgba(157, 123, 255, 0.25)'; this.style.color='#9d7bff';"
                        onmouseout="this.style.background='rgba(157, 123, 255, 0.1)'; this.style.color='rgba(230, 217, 255, 0.7)';"
                        style="padding: 0.35rem 0.65rem; background: rgba(157, 123, 255, 0.1); border: 1px solid rgba(157, 123, 255, 0.3); color: rgba(230, 217, 255, 0.7); font-family: 'Cinzel', serif; font-size: 0.7rem; letter-spacing: 0.1em; cursor: pointer; text-transform: uppercase; font-weight: 600; border-radius: 3px; transition: all 0.2s ease; min-height: 32px;">
                  MAX
                </button>
              </div>
              <input type="number" id="purchaseAmount" placeholder="0.0" step="any" min="0" inputmode="decimal"
                     style="width: 100%; padding: 0.875rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 16px; border-radius: 4px;" />
            </div>
            <div style="margin-bottom: 1rem; padding: 0.875rem; background: rgba(157, 123, 255, 0.05); border: 1px solid rgba(157, 123, 255, 0.2); border-radius: 4px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.35rem;">
                <span style="font-size: 0.75rem; color: rgba(230, 217, 255, 0.6);">Your Balance:</span>
                <span style="font-size: 0.85rem; color: #e6d9ff; font-weight: 600;">${balanceFormatted} ${tokenSymbol}</span>
              </div>
              <div style="font-size: 0.75rem; color: rgba(230, 217, 255, 0.5); margin-top: 0.25rem;">
                Payment will be in <strong>${tokenSymbol}</strong>
              </div>
            </div>
            <button onclick="executePurchase('${payToken}', ${tokenDecimals}, ${isLoot})"
                    onmouseover="this.style.background='rgba(157, 123, 255, 0.35)'; this.style.borderColor='#9d7bff';"
                    onmouseout="this.style.background='rgba(157, 123, 255, 0.2)'; this.style.borderColor='rgba(157, 123, 255, 0.4)';"
                    style="width: 100%; padding: 1rem; background: rgba(157, 123, 255, 0.2); border: 1px solid rgba(157, 123, 255, 0.4); color: #e6d9ff; font-family: 'Cinzel', serif; font-size: 0.8rem; letter-spacing: 0.15em; cursor: pointer; text-transform: uppercase; font-weight: 600; border-radius: 4px; transition: all 0.2s ease; min-height: 48px;">
              Confirm Purchase
            </button>
          `;
        } catch (error) {
          console.error('Error loading purchase modal:', error);
          content.innerHTML = `
            <div style="text-align: center; padding: 2rem; color: rgba(230, 217, 255, 0.6);">
              Error loading balance. Please try again.
            </div>
          `;
        }
      }

      function setMaxPurchaseAmount(maxAmount) {
        const input = document.getElementById('purchaseAmount');
        if (input) {
          // Format to remove trailing zeros
          const formatted = parseFloat(maxAmount).toString();
          input.value = formatted;
          input.focus();
        }
      }

      function closePurchaseModal() {
        document.getElementById('purchaseModal').classList.remove('show');
      }

      async function executePurchase(payToken, tokenDecimals, isLoot) {
        try {
          const amountInput = document.getElementById('purchaseAmount').value.trim();
          if (!amountInput || parseFloat(amountInput) <= 0) {
            showStatus('Please enter a valid amount', true);
            return;
          }

          const shareAmount = ethers.parseEther(amountInput);
          const molochContract = new ethers.Contract(currentDAO.dao.dao, MOLOCH_ABI, signer);
          const sale = await molochContract.sales(payToken);

          if (!sale.active) {
            showStatus('Sale is no longer active', true);
            return;
          }

          // Calculate cost
          // pricePerShare is payToken wei per share wei (no extra scaling)
          // For 18-dec tokens: pricePerShare=1 means 1:1 (1e18 tokens buys 1e18 shares)
          const cost = shareAmount * sale.pricePerShare;
          const maxPay = (cost * 105n) / 100n; // 5% slippage

          // ERC20 token: check allowance and approve if needed
          if (payToken !== ethers.ZeroAddress) {
            showStatus('Checking token allowance...', false);

            const tokenContract = new ethers.Contract(payToken, ERC20_ABI, signer);

            // Check user balance
            const userBalance = await tokenContract.balanceOf(connectedAddress);
            if (userBalance < cost) {
              showStatus(`Insufficient balance. Need ${ethers.formatUnits(cost, tokenDecimals)} tokens`, true);
              return;
            }

            // Check allowance
            const currentAllowance = await tokenContract.allowance(connectedAddress, currentDAO.dao.dao);

            if (currentAllowance < cost) {
              showStatus('Approving token spend... Please confirm in wallet', false);

              // Request approval for exact amount needed (or can use MaxUint256 for unlimited)
              const approveTx = await tokenContract.approve(currentDAO.dao.dao, cost);

              showStatus(`Approval transaction submitted. <a href="https://etherscan.io/tx/${approveTx.hash}" target="_blank" rel="noopener" style="color: #9d7bff; text-decoration: underline;">View on Etherscan</a>`, false);

              await approveTx.wait();

              showStatus('Approval confirmed! Proceeding with purchase...', false);
            }
          }

          showStatus('Confirming purchase... Please sign the transaction', false);

          let tx;
          if (payToken === ethers.ZeroAddress) {
            tx = await molochContract.buyShares(payToken, shareAmount, maxPay, { value: cost });
          } else {
            tx = await molochContract.buyShares(payToken, shareAmount, maxPay);
          }

          const tokenType = isLoot ? 'LOOT' : 'SHARES';
          showStatus(`Transaction submitted. <a href="https://etherscan.io/tx/${tx.hash}" target="_blank" rel="noopener" style="color: #9d7bff; text-decoration: underline;">View on Etherscan</a>`, false);

          await tx.wait();

          showStatus(`✨ Purchase successful! You received ${amountInput} ${tokenType}. <a href="https://etherscan.io/tx/${tx.hash}" target="_blank" rel="noopener" style="color: #9d7bff; text-decoration: underline;">View transaction</a>`, false);

          closePurchaseModal();
          await refreshCurrentDAO();
          await renderSalesInfo();
        } catch (error) {
          console.error('Purchase failed:', error);

          if (isUserRejection(error)) {
            showStatus('Transaction cancelled by user', false);
            return;
          }

          let errorMessage = 'Purchase failed';
          if (error.message?.includes('insufficient funds')) {
            errorMessage = 'Insufficient funds for transaction';
          } else if (error.message?.includes('ERC20: insufficient allowance')) {
            errorMessage = 'Insufficient token allowance. Please try again';
          } else if (error.shortMessage) {
            errorMessage = error.shortMessage;
          } else if (error.reason) {
            errorMessage = error.reason;
          } else if (error.message) {
            errorMessage = error.message.slice(0, 100);
          }

          showStatus(errorMessage, true);
        }
      }

      // Populate sale proposal from Send/Sale toggle
      async function populateSaleProposalFromToggle(symbol, address, decimals) {
        try {
          // Get elements from within the transferHelper div to avoid conflicts
          const helperDiv = document.getElementById('transferHelper');
          if (!helperDiv) {
            showStatus('Helper not found - please try again', true);
            return;
          }

          const tokenTypeEl = helperDiv.querySelector('#modalSaleTokenType');
          const priceEl = helperDiv.querySelector('#modalSalePrice');
          const capEl = helperDiv.querySelector('#modalSaleCap');
          const mintingEl = helperDiv.querySelector('#modalSaleMinting');
          const statusEl = helperDiv.querySelector('#modalSaleStatus');

          if (!priceEl) {
            showStatus('Form elements not found - please try again', true);
            return;
          }

          const tokenType = tokenTypeEl?.value;
          const priceInput = priceEl?.value?.trim();
          const capInput = capEl?.value?.trim();
          const minting = mintingEl?.checked;
          const status = statusEl?.value;

          if (!priceInput || isNaN(priceInput) || parseFloat(priceInput) <= 0) {
            showStatus('⚠️ Please enter a valid price per token (required field)', true);
            // Highlight the price field
            if (priceEl) {
              priceEl.style.border = '2px solid #ff6b6b';
              priceEl.focus();
              setTimeout(() => {
                priceEl.style.border = '1px solid rgba(157, 123, 255, 0.3)';
              }, 2000);
            }
            return;
          }

          // Price is in "token-wei per share-wei" (simple integer ratio)
          // For 1:1 with 18-decimal tokens: user enters "1", price = 1 (not 1e18!)
          // This is because contract does: cost = shareAmount * price (no scaling)
          const pricePerShare = BigInt(Math.round(parseFloat(priceInput)));
          if (pricePerShare === 0n) {
            showStatus('Price must be at least 1 (fractional prices < 1 not supported)', true);
            return;
          }

          const cap = capInput && parseFloat(capInput) > 0 ? ethers.parseEther(capInput) : 0n;
          const isLoot = tokenType === 'loot';
          const active = status === 'active';

          // Get DAO address
          if (!currentDAO || !currentDAO.dao || !currentDAO.dao.dao) {
            showStatus('DAO not loaded', true);
            return;
          }
          const daoAddress = currentDAO.dao.dao;

          // Encode setSale call
          const calldata = INTERFACES.setSale.encodeFunctionData('setSale', [
            address, pricePerShare, cap, minting, active, isLoot
          ]);

          // Populate proposal form
          document.getElementById('proposalTo').value = daoAddress;
          document.getElementById('proposalValue').value = '0';
          document.getElementById('proposalData').value = calldata;

          const tokenTypeText = isLoot ? 'LOOT' : 'SHARES';
          const sourceText = minting ? 'minting new tokens' : 'selling from treasury';
          const capText = cap > 0n ? `${ethers.formatEther(cap)} tokens` : 'unlimited';
          const statusText = active ? 'ACTIVE' : 'INACTIVE';

          let description = `Configure ${symbol} sale: ${priceInput} ${symbol} per ${tokenTypeText} token, ${capText} cap, ${sourceText}, status: ${statusText}`;

          // Always add SALE tag for tracking in UI (treasury, sales section, etc.)
          description += `\n\n<<<SALE token="${address}" price="${pricePerShare}" decimals="${decimals}" symbol="${symbol}" SALE>>>`;

          document.getElementById('proposalDescription').value = description;

          // Update UI hints and translations
          updateTargetAddressHint();
          updateCalldataTranslation();
          updateCalldataPreview();

          showStatus('Proposal form populated with sale configuration', false);
          clearTransferHelper();

          // Scroll to description
          setTimeout(() => {
            document.getElementById('proposalDescription').scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 100);
        } catch (error) {
          console.error('Error populating sale proposal:', error);
          showStatus('Failed to populate sale proposal: ' + error.message, true);
        }
      }

      // Sale proposal helper
      async function prepareSaleProposal() {
        if (!currentDAO || !currentDAO.dao) {
          showStatus('Please select a DAO first', true);
          return;
        }

        const proposalForm = document.querySelector('.proposal-form');
        if (proposalForm) {
          proposalForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        let helperDiv = document.getElementById('saleHelper');
        if (!helperDiv) {
          helperDiv = document.createElement('div');
          helperDiv.id = 'saleHelper';
          helperDiv.style.cssText = 'margin-bottom: 1rem; padding: 1rem; background: rgba(157, 123, 255, 0.1); border: 1px solid rgba(157, 123, 255, 0.3); border-radius: 4px;';
          proposalForm.insertBefore(helperDiv, proposalForm.querySelector('.proposal-form-group'));
        }

        helperDiv.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
            <div style="font-family: 'Cinzel', serif; font-size: 0.85rem; color: #9d7bff; letter-spacing: 0.1em;">CONFIGURE TOKEN SALE</div>
            <button onclick="clearSaleHelper()" style="background: none; border: none; color: rgba(230, 217, 255, 0.6); cursor: pointer; font-size: 1.2rem; padding: 0; line-height: 1;">&times;</button>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
            <div>
              <label style="display: block; font-size: 0.75rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.35rem;">
                Payment Token (18-decimal only)
                <span style="font-size: 0.65rem; opacity: 0.7; font-weight: normal;">(Use + Custom in treasury for other 18-decimal tokens)</span>
              </label>
              <div style="position: relative;">
                <div id="proposalPayTokenDisplay" onclick="toggleProposalPayTokenDropdown()"
                     style="width: 100%; padding: 0.6rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 0.95rem; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                  <div style="width: 20px; height: 20px; flex-shrink: 0;" id="proposalPayTokenIcon"></div>
                  <span id="proposalPayTokenLabel">DAI</span>
                </div>
                <div id="proposalPayTokenDropdown" class="custom-dropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 0.25rem; background: rgba(10, 0, 21, 0.95); border: 1px solid rgba(157, 123, 255, 0.4); border-radius: 4px; z-index: 1000; backdrop-filter: blur(10px);">
                  <div onclick="selectProposalPayToken('dai', '${TOKEN_ADDRESSES.dai}')" style="padding: 0.6rem; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='rgba(157, 123, 255, 0.2)'" onmouseout="this.style.background='transparent'">
                    <div style="width: 20px; height: 20px; flex-shrink: 0;" class="proposal-token-icon" data-token="dai"></div>
                    <span style="color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 0.95rem;">DAI</span>
                  </div>
                  <div onclick="selectProposalPayToken('custom', 'custom')" style="padding: 0.6rem; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; transition: background 0.2s; border-top: 1px solid rgba(157, 123, 255, 0.2);" onmouseover="this.style.background='rgba(157, 123, 255, 0.2)'" onmouseout="this.style.background='transparent'">
                    <div style="width: 20px; height: 20px; flex-shrink: 0;" class="proposal-token-icon" data-token="defaultCoin"></div>
                    <span style="color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 0.95rem;">Custom Token</span>
                  </div>
                </div>
                <input type="hidden" id="salePayToken" value="${TOKEN_ADDRESSES.dai}">
              </div>
              <div id="customSaleTokenFields" style="display: none; margin-top: 0.5rem;">
                <label style="display: block; font-size: 0.75rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.35rem;">Custom Token Address</label>
                <div style="display: flex; gap: 0.5rem;">
                  <input type="text" id="customSaleTokenAddress" placeholder="0x..."
                         onkeydown="if(event.key==='Enter'){event.preventDefault();validateCustomSaleToken();}"
                         style="flex: 1; padding: 0.6rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 0.95rem;" />
                  <button onclick="validateCustomSaleToken()" type="button"
                          style="padding: 0.6rem 1rem; background: rgba(157, 123, 255, 0.2); border: 1px solid rgba(157, 123, 255, 0.4); color: #e6d9ff; font-family: 'Cinzel', serif; font-size: 0.75rem; letter-spacing: 0.1em; cursor: pointer; white-space: nowrap; min-height: 44px;">
                    Validate
                  </button>
                </div>
                <div id="customSaleTokenInfo" style="margin-top: 0.5rem; font-size: 0.75rem; color: rgba(230, 217, 255, 0.7);"></div>
                <small style="display: block; margin-top: 0.25rem; font-size: 0.7rem; color: rgba(230, 217, 255, 0.5);">Must be an 18-decimal ERC20 token</small>
              </div>
            </div>
            <div>
              <label style="display: block; font-size: 0.75rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.35rem;">Token Type</label>
              <select id="proposalSaleTokenType" style="width: 100%; padding: 0.6rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 0.95rem;">
                <option value="false">Shares</option>
                <option value="true">Loot</option>
              </select>
            </div>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
            <div>
              <label style="display: block; font-size: 0.75rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.35rem;">
                Price per Token
                <span title="For 1:1 upgrades with 18 decimal tokens, use 1.0. This sale will be shown as 'Governance Staking/Upgrade' instead of 'Sale'." style="cursor: help; margin-left: 0.25rem;">ℹ️</span>
              </label>
              <input type="number" id="proposalSalePrice" placeholder="0.0" step="any" min="0" style="width: 100%; padding: 0.6rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 0.95rem;" />
            </div>
            <div>
              <label style="display: block; font-size: 0.75rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.35rem;">
                Cap (0 = unlimited)
                <span title="For token upgrades, set to 0 for unlimited. Users can go back and forth via ragequit." style="cursor: help; margin-left: 0.25rem;">ℹ️</span>
              </label>
              <input type="number" id="proposalSaleCap" placeholder="0" step="any" min="0" style="width: 100%; padding: 0.6rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 0.95rem;" />
            </div>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
            <div>
              <label style="display: block; font-size: 0.75rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.35rem;">Source</label>
              <select id="proposalSaleMinting" style="width: 100%; padding: 0.6rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 0.95rem;">
                <option value="true">Mint new</option>
                <option value="false">From treasury</option>
              </select>
            </div>
            <div>
              <label style="display: block; font-size: 0.75rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.35rem;">Status</label>
              <select id="proposalSaleActive" style="width: 100%; padding: 0.6rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 0.95rem;">
                <option value="true">Active</option>
                <option value="false">Inactive</option>
              </select>
            </div>
          </div>
          <div id="proposalSaleHint" style="display: none; margin-bottom: 0.75rem; padding: 0.75rem; background: rgba(157, 123, 255, 0.15); border-left: 3px solid #9d7bff; font-size: 0.85rem; color: #e6d9ff; line-height: 1.5;">
            <strong style="color: #9d7bff;">Sale Preview:</strong> <span id="proposalSaleHintText"></span>
          </div>
          <div style="margin-bottom: 0.75rem; padding: 0.75rem; background: rgba(157, 123, 255, 0.05); border-left: 3px solid rgba(157, 123, 255, 0.3); font-size: 0.8rem; color: rgba(230, 217, 255, 0.8); line-height: 1.5;">
            <strong>Token Upgrade Path:</strong> With ragequit enabled, users can upgrade their tokens to DAO shares, then burn shares to reclaim tokens if desired, lowering risk.
          </div>
          <button onclick="populateSaleProposal('${currentDAO.dao.dao}')"
                  onmouseover="this.style.background='rgba(157, 123, 255, 0.35)'; this.style.borderColor='#9d7bff';"
                  onmouseout="this.style.background='rgba(157, 123, 255, 0.2)'; this.style.borderColor='rgba(157, 123, 255, 0.4)';"
                  style="width: 100%; padding: 0.75rem; background: rgba(157, 123, 255, 0.2); border: 1px solid rgba(157, 123, 255, 0.4); color: #e6d9ff; font-family: 'Cinzel', serif; font-size: 0.75rem; letter-spacing: 0.15em; cursor: pointer; text-transform: uppercase; transition: all 0.2s ease; font-weight: 600;">
            Populate Proposal Form
          </button>
        `;

        // Initialize token icons and set up event listeners
        setTimeout(() => {
          initializeProposalPayTokenIcons();

          const priceInput = document.getElementById('salePrice');
          const capInput = document.getElementById('saleCap');
          const tokenInput = document.getElementById('salePayToken');
          const typeInput = document.getElementById('saleTokenType');

          if (priceInput && capInput) {
            // Remove old listeners before adding new ones to prevent memory leaks
            priceInput.removeEventListener('input', updateProposalSaleHint);
            capInput.removeEventListener('input', updateProposalSaleHint);
            tokenInput.removeEventListener('change', updateProposalSaleHint);
            typeInput.removeEventListener('change', updateProposalSaleHint);

            // Add fresh listeners
            priceInput.addEventListener('input', updateProposalSaleHint);
            capInput.addEventListener('input', updateProposalSaleHint);
            tokenInput.addEventListener('change', updateProposalSaleHint);
            typeInput.addEventListener('change', updateProposalSaleHint);
            updateProposalSaleHint(); // Initial update
          }
        }, 10);
      }

      // Update proposal form sale hint
      function updateProposalSaleHint() {
        const priceInput = document.getElementById('salePrice')?.value?.trim();
        const capInput = document.getElementById('saleCap')?.value?.trim();
        const tokenType = document.getElementById('saleTokenType')?.value === 'true' ? 'loot' : 'shares';
        const paymentToken = document.getElementById('salePayToken')?.value;

        const hint = document.getElementById('proposalSaleHint');
        const hintText = document.getElementById('proposalSaleHintText');

        if (!hint || !hintText) return;

        const price = parseFloat(priceInput);
        const cap = parseFloat(capInput);

        let payToken;
        if (paymentToken === 'custom') {
          payToken = 'TOKEN';
        } else {
          const tokenNames = {
            [TOKEN_ADDRESSES.dai]: 'DAI'
          };
          payToken = tokenNames[paymentToken] || 'TOKEN';
        }
        const tokenTypeText = tokenType === 'loot' ? 'Loot' : 'Share';

        // Show hint even without price - guide the user
        if (!priceInput || isNaN(price) || price <= 0) {
          hintText.innerHTML = `<span style="opacity: 0.6;">Enter price to see sale preview (e.g., "1 ${payToken} for 1 ${tokenTypeText}")</span>`;
          hint.style.display = 'block';
          return;
        }

        // Detect 1:1 upgrade path
        const is1to1 = price === 1;

        // Build the hint text - more natural word order: "1 DAI for 1 Share"
        let text = `<strong>${price} ${payToken}</strong> for <strong>1 ${tokenTypeText}</strong>`;

        if (cap && !isNaN(cap) && cap > 0) {
          text += ` up to <strong>${cap.toLocaleString()} ${tokenTypeText}${cap !== 1 ? 's' : ''}</strong>`;
        } else {
          text += ` <span style="opacity: 0.7;">(unlimited)</span>`;
        }

        // Add 1:1 upgrade path hint or cost example
        if (is1to1) {
          text += ` <span style="color: #9d7bff; font-weight: 600; margin-left: 0.5rem;">• 1:1 Upgrade Path</span>`;
        } else {
          // Add cost example
          const exampleAmount = 100;
          const exampleCost = exampleAmount * price;
          text += `<br><span style="opacity: 0.6; font-size: 0.85em;">Example: ${exampleCost.toLocaleString()} ${payToken} buys ${exampleAmount} ${tokenTypeText}s</span>`;
        }

        hintText.innerHTML = text;
        hint.style.display = 'block';
      }

      function clearSaleHelper() {
        const helperDiv = document.getElementById('saleHelper');
        if (helperDiv) helperDiv.remove();
      }

      // Proposal payment token dropdown functions
      let selectedProposalPayToken = TOKEN_ADDRESSES.dai;

      function toggleProposalPayTokenDropdown() {
        const dropdown = document.getElementById('proposalPayTokenDropdown');
        if (dropdown) {
          dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }
      }

      function selectProposalPayToken(tokenName, tokenAddress) {
        selectedProposalPayToken = tokenAddress;
        const hiddenInput = document.getElementById('salePayToken');
        if (hiddenInput) {
          hiddenInput.value = tokenAddress;
        }

        // Show/hide custom token fields
        const customTokenFields = document.getElementById('customSaleTokenFields');
        if (customTokenFields) {
          customTokenFields.style.display = tokenName === 'custom' ? 'block' : 'none';
        }

        // Update display
        const iconEl = document.getElementById('proposalPayTokenIcon');
        const labelEl = document.getElementById('proposalPayTokenLabel');
        if (iconEl && labelEl) {
          if (tokenName === 'custom') {
            iconEl.innerHTML = TOKEN_ICONS.defaultCoin || salePaymentTokenIcons.defaultCoin;
            labelEl.textContent = 'CUSTOM TOKEN';
          } else if (salePaymentTokenIcons[tokenName]) {
            iconEl.innerHTML = salePaymentTokenIcons[tokenName];
            labelEl.textContent = tokenName.toUpperCase();
          }
        }

        // Close dropdown
        const dropdown = document.getElementById('proposalPayTokenDropdown');
        if (dropdown) {
          dropdown.style.display = 'none';
        }

        // Update hint
        updateProposalSaleHint();
      }

      function initializeProposalPayTokenIcons() {
        // Initialize display icon
        const displayIcon = document.getElementById('proposalPayTokenIcon');
        if (displayIcon && salePaymentTokenIcons.dai) {
          displayIcon.innerHTML = salePaymentTokenIcons.dai;
        }

        // Initialize dropdown icons
        const dropdownIcons = document.querySelectorAll('.proposal-token-icon');
        dropdownIcons.forEach(iconEl => {
          const token = iconEl.getAttribute('data-token');
          if (token && salePaymentTokenIcons[token]) {
            iconEl.innerHTML = salePaymentTokenIcons[token];
          } else if (token === 'defaultCoin' && TOKEN_ICONS.defaultCoin) {
            iconEl.innerHTML = TOKEN_ICONS.defaultCoin;
          }
        });
      }

      // Custom token cache for info fetching
      let customTokenCache = {};

      // Track custom sale tokens across the DAO (populated by renderSalesInfo)
      let customSaleTokens = [];

      async function populateSaleProposal(daoAddress) {
        try {
          let payToken = document.getElementById('salePayToken').value;
          const priceInput = document.getElementById('proposalSalePrice').value.trim();
          const capInput = document.getElementById('proposalSaleCap').value.trim();
          const minting = document.getElementById('proposalSaleMinting').value === 'true';
          const active = document.getElementById('proposalSaleActive').value === 'true';
          const isLoot = document.getElementById('proposalSaleTokenType').value === 'true';

          if (!priceInput || parseFloat(priceInput) <= 0) {
            showStatus('Please enter a valid price', true);
            return;
          }

          // Handle custom token
          let tokenName, decimals;
          if (payToken === 'custom') {
            const customTokenAddress = document.getElementById('customSaleTokenAddress')?.value?.trim();
            if (!customTokenAddress || !ethers.isAddress(customTokenAddress)) {
              showStatus('Please enter a valid custom token address', true);
              return;
            }

            // Fetch token info
            try {
              const tokenContract = new ethers.Contract(customTokenAddress, ERC20_ABI, provider);
              tokenName = await tokenContract.symbol().catch(() => 'TOKEN');
              decimals = await tokenContract.decimals().catch(() => 18);

              if (Number(decimals) !== 18) {
                showStatus('Custom token must have 18 decimals', true);
                return;
              }

              payToken = customTokenAddress;
            } catch (error) {
              showStatus('Failed to fetch custom token info', true);
              return;
            }
          } else {
            // Standard tokens only (DAI)
            const tokenNames = {
              [TOKEN_ADDRESSES.dai]: 'DAI'
            };

            const tokenDecimals = {
              [TOKEN_ADDRESSES.dai]: 18
            };

            tokenName = tokenNames[payToken];
            decimals = tokenDecimals[payToken];
          }

          // Price is in "token-wei per share-wei" (simple integer ratio)
          // For 1:1 with 18-decimal tokens: user enters "1", price = 1 (not 1e18!)
          // This is because contract does: cost = shareAmount * price (no scaling)
          const pricePerShare = BigInt(Math.round(parseFloat(priceInput)));
          if (pricePerShare === 0n) {
            showStatus('Price must be at least 1 (fractional prices < 1 not supported)', true);
            return;
          }

          const cap = capInput && parseFloat(capInput) > 0 ? ethers.parseEther(capInput) : 0n;

          const saleCalldata = INTERFACES.setSale.encodeFunctionData('setSale', [payToken, pricePerShare, cap, minting, active, isLoot]);

          const tokenType = isLoot ? 'LOOT' : 'SHARES';
          const statusText = active ? 'Enable' : 'Disable';
          const sourceText = minting ? 'mint new' : 'sell from treasury';
          const capText = cap > 0n ? `, cap ${ethers.formatEther(cap)}` : ', unlimited';
          let description = `${statusText} ${tokenType} sale: ${priceInput} ${tokenName} per token (${sourceText}${capText})`;

          // Always add SALE tag for tracking in UI (treasury, sales section, etc.)
          description += `\n\n<<<SALE token="${payToken}" price="${pricePerShare}" decimals="${decimals}" symbol="${tokenName}" SALE>>>`;

          document.getElementById('proposalTo').value = daoAddress;
          document.getElementById('proposalValue').value = '0';
          document.getElementById('proposalData').value = saleCalldata;
          document.getElementById('proposalDescription').value = description;

          updateTargetAddressHint();
          updateCalldataTranslation();
          updateCalldataPreview();

          showStatus('Proposal form populated!', false);
          clearSaleHelper();

          setTimeout(() => {
            document.getElementById('proposalDescription').scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);
        } catch (error) {
          console.error('Error populating sale proposal:', error);
          showStatus('Failed to populate form: ' + error.message, true);
        }
      }

      // Open DAO dashboard
      async function openDAO(daoIndex, source = 'user') {
        // Get the DAO from the appropriate source
        if (source === 'all') {
          currentDAO = { dao: allDAOs[daoIndex], member: null };
        } else {
          currentDAO = userDAOs[daoIndex];
        }

        // Guard against null/undefined DAO data
        if (!currentDAO?.dao?.meta) {
          console.error('Invalid DAO data at index:', daoIndex);
          showStatus('Failed to load DAO', true);
          return;
        }

        const dashboardTitle = DOMCache.dashboardTitle;
        if (dashboardTitle) {
          dashboardTitle.textContent = currentDAO.dao.meta.name;
        }

        // Update Etherscan link
        const daoAddress = currentDAO.dao.dao;
        const etherscanLink = DOMCache.daoEtherscanLink;
        const addressText = DOMCache.daoAddressText;
        etherscanLink.href = `https://etherscan.io/address/${daoAddress}`;
        addressText.textContent = `${daoAddress.slice(0, 6)}...${daoAddress.slice(-4)}`;

        renderChatroom();
        await renderProposals();
        renderGovernanceInfo();
        await renderSalesInfo();
        await renderTreasury(); // Must be after renderSalesInfo to get customSaleTokens
        renderDaoStats();
        await renderDAOEmblem(daoAddress);

        // Show/hide membership tab based on membership status
        const membershipBtn = document.getElementById('viewToggleMembership');
        if (currentDAO.member) {
          membershipBtn.style.display = 'block';
        } else {
          membershipBtn.style.display = 'none';
          // Ensure we're on DAO view if no membership
          switchDaoView('dao');
        }

        DOMCache.daoGallery.classList.remove('show');
        DOMCache.allDaosGallery.classList.remove('show');
        DOMCache.daoDashboard.classList.add('show');

        // Hide navigation buttons when viewing DAO
        document.body.classList.add('hide-nav-buttons');

        // Hide center journey line when viewing DAO dashboard
        const journeyLineContainer = document.getElementById('journey-line-container');
        if (journeyLineContainer) {
          journeyLineContainer.style.display = 'none';
        }

        // Add special gif for index 0, 1, 2, 3, and 4 DAOs
        // Find global index by matching DAO address to ensure correct GIF assignment
        const globalIndex = allDAOs.findIndex(globalDao =>
          globalDao.dao.toLowerCase() === currentDAO.dao.dao.toLowerCase()
        );

        let existingGif = document.getElementById('dashboardGif');
        if (globalIndex >= 0 && globalIndex <= 4) {
          const gifUrls = [
            'https://content.wrappr.wtf/ipfs/bafybeidc4tl6ysvwhwbpql7xk5ol5cd22dvpmlyy76zjun4ikhrb43oqb4', // Index 0
            'https://content.wrappr.wtf/ipfs/bafybeibgfu4gh7miouopugf7tclpt4os2zr2rznhlomnletfbj5amdw4gu',   // Index 1
            'https://content.wrappr.wtf/ipfs/bafybeieemrl6ip5w7tgrpdsitw4ry2in3bko7c3oxqa7vr3lisozjbfhra',   // Index 2
            'https://content.wrappr.wtf/ipfs/bafybeiefycihryp3uybt3f3g5dr6tjonxzl6p5mq6ato74ewvf22i4p3zi',   // Index 3
            'https://content.wrappr.wtf/ipfs/bafybeiet7oxnshiv6agrmnhgdpfpmmnhfmw5px2wpozd62jhdvorzdp4fq'    // Index 4
          ];

          if (!existingGif) {
            existingGif = document.createElement('img');
            existingGif.id = 'dashboardGif';
            existingGif.className = 'dao-dashboard-gif';
            existingGif.alt = 'Special DAO Animation';
            document.body.appendChild(existingGif);
          }
          existingGif.src = gifUrls[globalIndex];
          existingGif.style.display = 'block';
        } else {
          if (existingGif) {
            existingGif.style.display = 'none';
          }
        }
      }

      // Back to gallery
      function backToGallery() {
        currentDAO = null;
        DOMCache.daoDashboard.classList.remove('show');
        DOMCache.daoGallery.classList.add('show');
        DOMCache.allDaosGallery.classList.add('show');

        // Hide dashboard gif when returning to gallery
        const existingGif = document.getElementById('dashboardGif');
        if (existingGif) {
          existingGif.style.display = 'none';
        }

        // Show navigation buttons when back to gallery
        document.body.classList.remove('hide-nav-buttons');

        // Show center journey line when back to gallery
        const journeyLineContainer = document.getElementById('journey-line-container');
        if (journeyLineContainer) {
          journeyLineContainer.style.display = '';
        }

        // Reset to DAO view
        switchDaoView('dao');
      }

      // Switch between DAO dashboard, membership, and members view
      function switchDaoView(view) {
        const daoView = document.getElementById('daoDashboardView');
        const membershipView = document.getElementById('daoMembershipView');
        const membersView = document.getElementById('daoMembersView');
        const daoBtn = document.getElementById('viewToggleDao');
        const membershipBtn = document.getElementById('viewToggleMembership');
        const membersBtn = document.getElementById('viewToggleMembers');

        // Hide all views
        daoView.classList.remove('show');
        daoView.classList.add('hide');
        membershipView.classList.remove('show');
        membersView.classList.remove('show');

        // Deactivate all buttons
        daoBtn.classList.remove('active');
        membershipBtn.classList.remove('active');
        membersBtn.classList.remove('active');

        if (view === 'membership') {
          membershipView.classList.add('show');
          membershipBtn.classList.add('active');
          renderMembership();
        } else if (view === 'members') {
          membersView.classList.add('show');
          membersBtn.classList.add('active');
          renderMembers();
        } else {
          daoView.classList.remove('hide');
          daoView.classList.add('show');
          daoBtn.classList.add('active');
        }
      }

      // Render membership dashboard
      async function renderMembership() {
        if (!currentDAO || !currentDAO.member) {
          document.getElementById('badgeContent').innerHTML = '<p style="text-align: center; color: rgba(230, 217, 255, 0.6); font-style: italic;">No membership data available</p>';
          return;
        }

        const member = currentDAO.member;
        const dao = currentDAO.dao;

        // Update balances
        const shares = ethers.formatUnits(member.shares, 18);
        const loot = ethers.formatUnits(member.loot, 18);
        document.getElementById('membershipShares').textContent = parseFloat(shares).toFixed(4);
        document.getElementById('membershipLoot').textContent = parseFloat(loot).toFixed(4);

        // Update Etherscan links for tokens
        if (dao.meta && dao.meta.sharesToken) {
          const sharesLink = document.getElementById('sharesEtherscanLink');
          sharesLink.href = `https://etherscan.io/token/${dao.meta.sharesToken}`;
          sharesLink.style.display = 'inline';
          sharesLink.onmouseover = () => { sharesLink.style.opacity = '1'; sharesLink.style.transform = 'translateY(-1px)'; };
          sharesLink.onmouseout = () => { sharesLink.style.opacity = '0.7'; sharesLink.style.transform = 'translateY(0)'; };
        }

        if (dao.meta && dao.meta.lootToken) {
          const lootLink = document.getElementById('lootEtherscanLink');
          lootLink.href = `https://etherscan.io/token/${dao.meta.lootToken}`;
          lootLink.style.display = 'inline';
          lootLink.onmouseover = () => { lootLink.style.opacity = '1'; lootLink.style.transform = 'translateY(-1px)'; };
          lootLink.onmouseout = () => { lootLink.style.opacity = '0.7'; lootLink.style.transform = 'translateY(0)'; };
        }

        if (dao.meta && dao.meta.badgesToken) {
          const badgeLink = document.getElementById('badgeEtherscanLink');
          badgeLink.href = `https://etherscan.io/token/${dao.meta.badgesToken}`;
          badgeLink.style.display = 'inline';
          badgeLink.onmouseover = () => { badgeLink.style.opacity = '1'; badgeLink.style.transform = 'translateY(-1px)'; };
          badgeLink.onmouseout = () => { badgeLink.style.opacity = '0.7'; badgeLink.style.transform = 'translateY(0)'; };
        }

        // Update badge info
        const badgeSeat = member.seatId;
        if (badgeSeat > 0) {
          document.getElementById('membershipBadge').textContent = `Seat #${badgeSeat}`;
          await renderBadge(dao.dao, badgeSeat);
        } else {
          document.getElementById('membershipBadge').textContent = 'No Badge';
          document.getElementById('badgeContent').innerHTML = '<p style="text-align: center; color: rgba(230, 217, 255, 0.6); font-style: italic; margin-top: 1rem;">You don\'t have a badge seat yet</p>';
        }

        // Render vote receipts
        await renderVoteReceipts();
      }

      // Render badge NFT
      async function renderBadge(daoAddress, seatId) {
        const badgeContent = document.getElementById('badgeContent');

        try {
          // Get badges contract address (predicted from DAO)
          const predictions = predictMajeurAddresses([], [], ethers.randomBytes(32));
          const badgesAddress = predictions.badges;

          // Use the correct badges contract from the DAO
          const molochContract = new ethers.Contract(daoAddress, MOLOCH_ABI, provider);
          const badgesAddr = await molochContract.badges();

          const badgesABI = [
            'function tokenURI(uint256) view returns (string)',
          ];
          const badgesContract = new ethers.Contract(badgesAddr, badgesABI, provider);

          const tokenURI = await badgesContract.tokenURI(seatId);

          // Parse metadata (could be data URI or IPFS)
          let metadata;
          if (tokenURI.startsWith('data:application/json;base64,')) {
            const json = atob(tokenURI.slice(29));
            metadata = JSON.parse(json);
          } else if (tokenURI.startsWith('data:application/json,')) {
            metadata = JSON.parse(decodeURIComponent(tokenURI.slice(22)));
          } else {
            // Fetch from URL
            const response = await fetch(tokenURI);
            metadata = await response.json();
          }

          // Render badge
          let imageHTML = '';
          if (metadata.image) {
            if (metadata.image.startsWith('data:image/svg+xml')) {
              imageHTML = `<img src="${metadata.image}" class="badge-image" alt="Badge #${seatId}" />`;
            } else if (metadata.image.startsWith('data:')) {
              imageHTML = `<img src="${metadata.image}" class="badge-image" alt="Badge #${seatId}" />`;
            } else {
              imageHTML = `<img src="${metadata.image}" class="badge-image" alt="Badge #${seatId}" />`;
            }
          }

          // OpenSea link
          const openseaLink = `https://opensea.io/assets/ethereum/${badgesAddr.toLowerCase()}/${seatId}`;

          badgeContent.innerHTML = `
            <div style="cursor: pointer;" onclick="openNFTModal(${JSON.stringify(metadata).replace(/"/g, '&quot;')}, 'Member Badge')">
              ${imageHTML}
            </div>
            <div style="margin-top: 1rem;">
              <div style="font-family: 'Cinzel', serif; font-size: 0.9rem; color: #9d7bff; margin-bottom: 0.5rem;">
                ${metadata.name || `Badge #${seatId}`}
              </div>
              ${metadata.description ? `<div style="font-family: 'EB Garamond', serif; font-size: 0.9rem; color: rgba(230, 217, 255, 0.8); margin-bottom: 0.75rem;">${metadata.description}</div>` : ''}
              <div style="display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap;">
                <button onclick="openNFTModal(${JSON.stringify(metadata).replace(/"/g, '&quot;')}, 'Member Badge')" style="padding: 0.5rem 1rem; background: rgba(157, 123, 255, 0.1); border: 1px solid rgba(157, 123, 255, 0.3); color: #9d7bff; font-family: 'EB Garamond', serif; font-size: 0.85rem; cursor: pointer; transition: all 0.2s; border-radius: 4px;">
                  View Details
                </button>
                <a href="${openseaLink}" target="_blank" rel="noopener noreferrer" style="display: inline-flex; align-items: center; gap: 0.4rem; font-family: 'EB Garamond', serif; font-size: 0.85rem; color: rgba(157, 123, 255, 0.8); text-decoration: none; transition: color 0.2s; padding: 0.5rem 1rem; background: rgba(157, 123, 255, 0.05); border: 1px solid rgba(157, 123, 255, 0.2); border-radius: 4px;">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                    <polyline points="15 3 21 3 21 9"></polyline>
                    <line x1="10" y1="14" x2="21" y2="3"></line>
                  </svg>
                  OpenSea
                </a>
              </div>
            </div>
          `;
        } catch (error) {
          console.error('Error rendering badge:', error);
          badgeContent.innerHTML = `
            <div style="text-align: center; padding: 2rem;">
              <div style="font-size: 3rem; margin-bottom: 1rem;">🎖️</div>
              <div style="font-family: 'Cinzel', serif; font-size: 1rem; color: #9d7bff;">Seat #${seatId}</div>
              <div style="font-family: 'EB Garamond', serif; font-size: 0.85rem; color: rgba(230, 217, 255, 0.6); margin-top: 0.5rem;">Badge metadata unavailable</div>
            </div>
          `;
        }
      }

      // Render vote receipts collection
      async function renderVoteReceipts() {
        const receiptsGrid = document.getElementById('receiptsGrid');
        if (!currentDAO || !connectedAddress) {
          receiptsGrid.innerHTML = '';
          receiptsGrid.appendChild(createEmptyState(
            '🔌',
            'WALLET NOT CONNECTED',
            'Connect your wallet to view your vote receipt collection',
            'Connect Wallet',
            connectWallet
          ));
          return;
        }

        // Show loading state
        showLoadingState(receiptsGrid, 3, 'card');

        const receipts = [];
        const molochContract = new ethers.Contract(currentDAO.dao.dao, MOLOCH_ABI, provider);

        // Use voters data from view helper to find user's votes (no hasVoted RPC calls!)
        const userVotedProposals = currentDAO.dao.proposals.filter(proposal => {
          return proposal.voters?.some(v => v.voter?.toLowerCase() === connectedAddress.toLowerCase());
        });

        // Batch balance checks in parallel
        const balancePromises = userVotedProposals.map(async (proposal) => {
          const userVote = proposal.voters.find(v => v.voter?.toLowerCase() === connectedAddress.toLowerCase());
          const support = Number(userVote.support); // 0=Against, 1=For, 2=Abstain
          const receiptId = ethers.solidityPackedKeccak256(
            ['string', 'uint256', 'uint8'],
            ['Moloch:receipt', proposal.id, support]
          );

          try {
            const balance = await molochContract.balanceOf(connectedAddress, receiptId);

            // Show receipt if:
            // 1. User still has balance > 0 (hasn't claimed), OR
            // 2. User voted on winning side of resolved futarchy (even if claimed/burned)
            const hasBalance = balance > 0n;

            const isWinningFutarchyVote = proposal.futarchy?.enabled
              && proposal.futarchy.resolved
              && Number(proposal.futarchy.winner) === support;

            if (hasBalance || isWinningFutarchyVote) {
              return {
                proposalId: proposal.id,
                support,
                balance,
                receiptId,
                claimed: !hasBalance && isWinningFutarchyVote // Track if already claimed
              };
            }
          } catch (err) {
            console.error('Error checking receipt balance:', err);
          }
          return null;
        });

        const results = await Promise.all(balancePromises);
        receipts.push(...results.filter(r => r !== null));

        if (receipts.length === 0) {
          receiptsGrid.innerHTML = '';
          receiptsGrid.appendChild(createEmptyState(
            '🎫',
            'NO VOTE RECEIPTS YET',
            'Vote on proposals to start collecting unique receipt NFTs that track your participation',
            'View Proposals',
            () => switchDaoView('dao')
          ));
          return;
        }

        // Render receipt cards with metadata
        receiptsGrid.innerHTML = '';
        showLoadingState(receiptsGrid, receipts.length, 'card');

        const supportLabels = ['Against', 'For', 'Abstain'];
        const supportColors = ['#ff6b6b', '#66ff66', '#9d7bff'];

        // Fetch metadata for all receipts
        const receiptPromises = receipts.map(async receipt => {
          try {
            const tokenURI = await molochContract.tokenURI(receipt.receiptId);

            // Parse metadata (could be data URI or IPFS)
            let metadata;
            if (tokenURI.startsWith('data:application/json;base64,')) {
              const json = atob(tokenURI.slice(29));
              metadata = JSON.parse(json);
            } else if (tokenURI.startsWith('data:application/json,')) {
              metadata = JSON.parse(decodeURIComponent(tokenURI.slice(22)));
            } else {
              // Fetch from URL
              const response = await fetch(tokenURI);
              metadata = await response.json();
            }

            return { ...receipt, metadata };
          } catch (error) {
            console.error('Error fetching receipt metadata:', error);
            return { ...receipt, metadata: null };
          }
        });

        const receiptsWithMetadata = await Promise.all(receiptPromises);

        receiptsGrid.innerHTML = '';

        receiptsWithMetadata.forEach((receipt, index) => {
          try {
            const card = document.createElement('div');
            card.className = 'receipt-card card-appear';
            card.style.animationDelay = `${index * 0.05}s`;

            const balanceFormatted = ethers.formatUnits(receipt.balance, 18);
            const supportLabel = supportLabels[receipt.support];
            const supportColor = supportColors[receipt.support];

            let imageHTML = '';
            let nameHTML = '';

            if (receipt.metadata) {
              if (receipt.metadata.image) {
                imageHTML = `<img src="${receipt.metadata.image}" class="receipt-image" alt="Receipt" />`;
              }
              if (receipt.metadata.name) {
                nameHTML = `<div class="receipt-name">${receipt.metadata.name}</div>`;
              }
            }

            // Check for futarchy claim eligibility
            let claimButtonHTML = '';
            const proposal = currentDAO.dao.proposals.find(p => p.id.toString() === receipt.proposalId.toString());

            if (proposal?.futarchy?.enabled && proposal.futarchy.resolved) {
              const winnerSupport = Number(proposal.futarchy.winner);
              const userSupport = Number(receipt.support);

              if (userSupport === winnerSupport) {
                if (receipt.claimed || receipt.balance === 0n) {
                  // Already claimed - show claimed status
                  claimButtonHTML = `
                    <div style="width: 100%; margin-top: 0.75rem; padding: 0.6rem; background: rgba(102, 255, 102, 0.1); border: 1px solid rgba(102, 255, 102, 0.3); color: #66ff66; font-family: 'Cinzel', serif; font-size: 0.65rem; letter-spacing: 0.1em; text-transform: uppercase; text-align: center; border-radius: 4px;">
                      ✓ Rewards Claimed
                    </div>
                  `;
                } else {
                  // Has unclaimed rewards
                  claimButtonHTML = `
                    <button onclick="event.stopPropagation(); claimFutarchyReward('${receipt.proposalId.toString()}', '${receipt.balance.toString()}');"
                            style="width: 100%; margin-top: 0.75rem; padding: 0.6rem; background: linear-gradient(135deg, #66ff66 0%, #44cc44 100%); border: none; color: #000; font-family: 'Cinzel', serif; font-size: 0.65rem; letter-spacing: 0.1em; cursor: pointer; text-transform: uppercase; font-weight: 600; border-radius: 4px; transition: all 0.2s ease;">
                      Claim Rewards
                    </button>
                  `;
                }
              }
            }

            // Handle display for claimed vs unclaimed receipts
            const amountDisplay = receipt.claimed || receipt.balance === 0n
              ? '<div class="receipt-amount" style="opacity: 0.6;">Receipt Claimed</div>'
              : `<div class="receipt-amount">${parseFloat(balanceFormatted).toFixed(4)} receipts</div>`;

            // Convert receipt ID from hex to decimal for display
            const receiptIdDecimal = BigInt(receipt.receiptId).toString();
            const receiptIdTruncated = receiptIdDecimal.length > 18
              ? `${receiptIdDecimal.slice(0, 10)}...${receiptIdDecimal.slice(-8)}`
              : receiptIdDecimal;

            // Add transfer button if user has balance
            const transferButtonHTML = receipt.balance > 0n
              ? `
                <button class="transfer-receipt-btn" data-receipt-index="${index}"
                        style="width: 100%; margin-top: 0.5rem; padding: 0.6rem; background: rgba(157, 123, 255, 0.15); border: 1px solid rgba(157, 123, 255, 0.3); color: #9d7bff; font-family: 'Cinzel', serif; font-size: 0.65rem; letter-spacing: 0.1em; cursor: pointer; text-transform: uppercase; border-radius: 4px; transition: all 0.2s ease;"
                        onmouseover="this.style.background='rgba(157, 123, 255, 0.25)'; this.style.borderColor='rgba(157, 123, 255, 0.5)'"
                        onmouseout="this.style.background='rgba(157, 123, 255, 0.15)'; this.style.borderColor='rgba(157, 123, 255, 0.3)'">
                  Transfer Receipt
                </button>
              `
              : '';

            card.innerHTML = `
              ${imageHTML}
              ${nameHTML}
              <div class="receipt-proposal">Proposal #${receipt.proposalId.toString().slice(0, 8)}...</div>
              <div class="receipt-vote" style="color: ${supportColor};">Voted ${supportLabel}</div>
              ${amountDisplay}
              <div style="font-size: 0.65rem; opacity: 0.5; margin-top: 0.5rem; font-family: monospace;" title="Receipt ID (uint256): ${receiptIdDecimal}">ID: ${receiptIdTruncated}</div>
              ${claimButtonHTML}
              ${transferButtonHTML}
            `;

            // Add event listener for transfer button
            if (receipt.balance > 0n) {
              const transferBtn = card.querySelector('.transfer-receipt-btn');
              if (transferBtn) {
                transferBtn.onclick = (e) => {
                  e.stopPropagation();
                  openTransferReceiptModal(receipt);
                };
              }
            }

            // Make card clickable to open modal with receipt data
            card.onclick = (e) => {
              // Don't open modal if clicking the claim button
              if (e.target.tagName === 'BUTTON') return;
              openNFTModal(receipt.metadata, 'Vote Receipt', receipt);
            };

            receiptsGrid.appendChild(card);
          } catch (renderError) {
            console.error('Error rendering receipt:', renderError);
          }
        });
      }

      // Render DAO emblem from contractURI
      async function renderDAOEmblem(daoAddress) {
        const emblem = document.getElementById('daoEmblem');
        if (!emblem) return;

        try {
          // Clear any previous url-image class
          emblem.classList.remove('url-image');

          const molochContract = new ethers.Contract(daoAddress, MOLOCH_ABI, provider);
          const contractURI = await molochContract.contractURI();

          if (!contractURI) {
            emblem.style.display = 'none';
            return;
          }

          // Check if contractURI is a direct image URL (by file extension)
          const isDirectImageURL = /\.(svg|png|jpg|jpeg|gif|webp|avif)(\?.*)?$/i.test(contractURI);

          // If it's a direct image URL, use it directly
          if (isDirectImageURL) {
            emblem.innerHTML = `<img src="${contractURI}" alt="DAO Emblem" />`;
            emblem.classList.add('url-image');
            emblem.style.display = 'block';
            emblem.onclick = () => openNFTModal({ image: contractURI }, 'DAO Contract');
            return;
          }

          // Parse metadata (JSON format)
          let metadata;
          if (contractURI.startsWith('data:application/json;base64,')) {
            const json = atob(contractURI.slice(29));
            metadata = JSON.parse(json);
          } else if (contractURI.startsWith('data:application/json,')) {
            metadata = JSON.parse(decodeURIComponent(contractURI.slice(22)));
          } else if (contractURI.startsWith('data:image/')) {
            // Direct data URI image (e.g., data:image/svg+xml,...)
            emblem.innerHTML = `<img src="${contractURI}" alt="DAO Emblem" />`;
            emblem.style.display = 'block';
            emblem.onclick = () => openNFTModal({ image: contractURI }, 'DAO Contract');
            return;
          } else {
            // Try to fetch as JSON
            const response = await fetch(contractURI);
            const contentType = response.headers.get('content-type');

            // Check if response is an image
            if (contentType && contentType.startsWith('image/')) {
              emblem.innerHTML = `<img src="${contractURI}" alt="DAO Emblem" />`;
              emblem.classList.add('url-image');
              emblem.style.display = 'block';
              emblem.onclick = () => openNFTModal({ image: contractURI }, 'DAO Contract');
              return;
            }

            // Otherwise parse as JSON metadata
            metadata = await response.json();
          }

          if (metadata && metadata.image) {
            emblem.innerHTML = `<img src="${metadata.image}" alt="DAO Emblem" />`;
            // Check if image URL is external (not data URI)
            if (!metadata.image.startsWith('data:')) {
              emblem.classList.add('url-image');
            }
            emblem.style.display = 'block';
            emblem.onclick = () => openNFTModal(metadata, 'DAO Contract');
          } else {
            emblem.style.display = 'none';
          }
        } catch (error) {
          console.error('Error rendering DAO emblem:', error);
          emblem.style.display = 'none';
        }
      }

      // Open NFT modal
      function openNFTModal(metadata, title, receiptData = null) {
        if (!metadata) return;

        const modal = document.getElementById('nftModal');
        const modalBody = document.getElementById('nftModalBody');

        let imageHTML = '';
        if (metadata.image) {
          // Add url-image class for external URLs (not data URIs)
          const urlImageClass = metadata.image.startsWith('data:') ? '' : ' url-image';
          imageHTML = `<img src="${metadata.image}" class="nft-modal-image${urlImageClass}" alt="${title}" />`;
        }

        let attributesHTML = '';
        if (metadata.attributes && Array.isArray(metadata.attributes)) {
          attributesHTML = `
            <div class="nft-modal-attributes">
              ${metadata.attributes.map(attr => `
                <div class="nft-modal-attribute">
                  <div class="nft-modal-attribute-label">${attr.trait_type || attr.type || 'Attribute'}</div>
                  <div class="nft-modal-attribute-value">${attr.value}</div>
                </div>
              `).join('')}
            </div>
          `;
        }

        // Check for futarchy claim eligibility if this is a vote receipt
        let futarchyClaimHTML = '';
        if (receiptData && currentDAO) {
          const proposal = currentDAO.dao.proposals.find(p => p.id.toString() === receiptData.proposalId.toString());

          if (proposal?.futarchy?.enabled && proposal.futarchy.resolved) {
            const winnerSupport = Number(proposal.futarchy.winner); // 0 or 1
            const userSupport = Number(receiptData.support);

            // Check if user voted on winning side (0=Against, 1=For)
            if (userSupport === winnerSupport) {
              const balanceFormatted = ethers.formatUnits(receiptData.balance, 18);
              const payoutPerUnit = proposal.futarchy.payoutPerUnit;
              const estimatedReward = (receiptData.balance * payoutPerUnit) / (10n ** 18n);
              const estimatedRewardFormatted = ethers.formatUnits(estimatedReward, 18);

              futarchyClaimHTML = `
                <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(102, 255, 102, 0.1); border: 1px solid rgba(102, 255, 102, 0.3); border-radius: 4px;">
                  <div style="font-family: 'Cinzel', serif; font-size: 0.85rem; color: #66ff66; letter-spacing: 0.1em; margin-bottom: 0.75rem; text-align: center;">
                    🎉 FUTARCHY REWARDS AVAILABLE
                  </div>
                  <div style="font-family: 'EB Garamond', serif; font-size: 0.9rem; color: rgba(230, 217, 255, 0.9); text-align: center; margin-bottom: 0.75rem;">
                    You voted on the winning side! You have <strong>${parseFloat(balanceFormatted).toFixed(4)}</strong> winning receipts.
                  </div>
                  <div style="font-size: 0.85rem; color: rgba(230, 217, 255, 0.8); text-align: center; margin-bottom: 1rem;">
                    Estimated reward: <strong>${parseFloat(estimatedRewardFormatted).toFixed(4)} LOOT</strong>
                  </div>
                  <button onclick="claimFutarchyFromReceipt('${receiptData.proposalId.toString()}', '${receiptData.balance.toString()}')"
                          style="width: 100%; padding: 0.875rem; background: linear-gradient(135deg, #66ff66 0%, #44cc44 100%); border: none; color: #000; font-family: 'Cinzel', serif; font-size: 0.8rem; letter-spacing: 0.15em; cursor: pointer; text-transform: uppercase; font-weight: 600; border-radius: 4px; transition: all 0.2s ease; min-height: 44px;">
                    Claim Rewards
                  </button>
                </div>
              `;
            }
          }
        }

        modalBody.innerHTML = `
          ${imageHTML}
          <div class="nft-modal-title">${metadata.name || title}</div>
          ${metadata.description ? `<div class="nft-modal-description">${metadata.description}</div>` : ''}
          ${attributesHTML}
          ${futarchyClaimHTML}
        `;

        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
      }

      // Claim futarchy rewards from receipt modal
      async function claimFutarchyFromReceipt(proposalId, amountStr) {
        closeNFTModal();
        await claimFutarchyReward(proposalId, amountStr);
      }

      // Close NFT modal
      function closeNFTModal() {
        const modal = document.getElementById('nftModal');
        modal.classList.remove('show');
        document.body.style.overflow = '';
      }

      // Render tile emblem (for gallery tiles)
      async function renderTileEmblem(daoAddress, emblemId) {
        const emblem = document.getElementById(emblemId);
        if (!emblem) return;

        try {
          // Clear any previous url-image class
          emblem.classList.remove('url-image');

          const molochContract = new ethers.Contract(daoAddress, MOLOCH_ABI, provider);
          const contractURI = await molochContract.contractURI();

          if (!contractURI) return;

          // Check if contractURI is a direct image URL (by file extension)
          const isDirectImageURL = /\.(svg|png|jpg|jpeg|gif|webp|avif)(\?.*)?$/i.test(contractURI);

          // If it's a direct image URL, use it directly
          if (isDirectImageURL) {
            emblem.innerHTML = `<img src="${contractURI}" alt="DAO Emblem" />`;
            emblem.classList.add('url-image');
            return;
          }

          // Parse metadata (JSON format)
          let metadata;
          if (contractURI.startsWith('data:application/json;base64,')) {
            const json = atob(contractURI.slice(29));
            metadata = JSON.parse(json);
          } else if (contractURI.startsWith('data:application/json,')) {
            metadata = JSON.parse(decodeURIComponent(contractURI.slice(22)));
          } else if (contractURI.startsWith('data:image/')) {
            // Direct data URI image (e.g., data:image/svg+xml,...)
            emblem.innerHTML = `<img src="${contractURI}" alt="DAO Emblem" />`;
            return;
          } else {
            // Try to fetch as JSON
            const response = await fetch(contractURI);
            const contentType = response.headers.get('content-type');

            // Check if response is an image
            if (contentType && contentType.startsWith('image/')) {
              emblem.innerHTML = `<img src="${contractURI}" alt="DAO Emblem" />`;
              emblem.classList.add('url-image');
              return;
            }

            // Otherwise parse as JSON metadata
            metadata = await response.json();
          }

          if (metadata && metadata.image) {
            emblem.innerHTML = `<img src="${metadata.image}" alt="DAO Emblem" />`;
            // Check if image URL is external (not data URI)
            if (!metadata.image.startsWith('data:')) {
              emblem.classList.add('url-image');
            }
          }
        } catch (error) {
          console.error('Error rendering tile emblem:', error);
        }
      }

      // Render Members List
      async function renderMembers() {
        if (!currentDAO) {
          return;
        }

        const membersList = document.getElementById('membersList');
        const memberCount = document.getElementById('memberCount');
        const badgeHolderCount = document.getElementById('badgeHolderCount');

        if (!membersList) {
          return;
        }

        membersList.innerHTML = '<p style="text-align: center; color: rgba(230, 217, 255, 0.6); font-style: italic;">Loading members...</p>';

        const members = currentDAO.dao.members;
        memberCount.textContent = members.length;

        let badgeHolders = 0;
        members.forEach(member => {
          // member[3] = seatId
          if (member[3] && member[3] > 0) badgeHolders++;
        });
        badgeHolderCount.textContent = badgeHolders;

        membersList.innerHTML = '';

        // Calculate total supply for ownership %
        const totalShares = currentDAO.dao.supplies.sharesTotalSupply;
        const totalLoot = currentDAO.dao.supplies.lootTotalSupply;
        const totalSupply = totalShares + totalLoot;

        // Reverse ENS resolution for each member (with caching)
        const membersWithENS = await Promise.all(
          members.map(async (member) => {
            // Member structure uses numeric indices: [0] = address
            const memberAddress = member[0];
            const ensName = memberAddress ? await lookupENS(memberAddress) : null;
            return { ...member, ensName };
          })
        );

        // Render each member
        try {
          membersWithENS.forEach((member, index) => {
            // Member structure from view helper uses numeric indices:
            // [0] = address, [1] = shares, [2] = loot, [3] = seatId, [4] = delegatedShares
            const memberAddress = member[0] || member.account || member.address;
            const sharesBN = member[1] !== null && member[1] !== undefined ? member[1] : 0n;
            const lootBN = member[2] !== null && member[2] !== undefined ? member[2] : 0n;
            const seatId = member[3] || 0;

            if (!memberAddress) {
              return;
            }

            const memberDiv = document.createElement('div');
            memberDiv.className = 'member-item';

            const shares = parseFloat(ethers.formatUnits(sharesBN, 18)).toFixed(4);
            const loot = parseFloat(ethers.formatUnits(lootBN, 18)).toFixed(4);
            const badgeText = (seatId && seatId > 0) ? `Seat #${seatId}` : 'None';

            // Calculate ownership %
            const memberTotal = sharesBN + lootBN;
            const ownershipPercent = totalSupply > 0n
              ? ((Number(memberTotal) / Number(totalSupply)) * 100).toFixed(2)
              : '0.00';

            memberDiv.innerHTML = `
              <div class="member-address">
                ${member.ensName ? `<div class="member-ens">${member.ensName}</div>` : ''}
                <div class="member-address-hex">${memberAddress.slice(0, 10)}...${memberAddress.slice(-8)}</div>
              </div>
              <div class="member-shares">
                <div class="member-label">Shares</div>
                <div class="member-value">${shares}</div>
              </div>
              <div class="member-loot">
                <div class="member-label">Loot</div>
                <div class="member-value">${loot}</div>
              </div>
              <div class="member-badge">
                <div class="member-label">Badge</div>
                <div class="member-value">${badgeText}</div>
              </div>
              <div class="member-ownership">
                <div class="member-label">Ownership</div>
                <div class="member-value">${ownershipPercent}%</div>
              </div>
              <a href="https://etherscan.io/address/${memberAddress}" target="_blank" rel="noopener noreferrer" class="member-link" title="View on Etherscan">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                  <polyline points="15 3 21 3 21 9"></polyline>
                  <line x1="10" y1="14" x2="21" y2="3"></line>
                </svg>
              </a>
            `;

            membersList.appendChild(memberDiv);
          });
        } catch (error) {
          console.error('Error rendering members:', error);
          membersList.innerHTML = `<p style="text-align: center; color: #ff6b6b; padding: 2rem;">Error rendering members: ${escapeHtml(error.message)}<br><small>Check console for details</small></p>`;
        }
      }

      // Render chatroom messages
      function renderChatroom() {
        const chatroomMessages = document.getElementById('chatroomMessages');
        if (!chatroomMessages || !currentDAO) return;

        chatroomMessages.innerHTML = '';

        if (currentDAO.dao.messages.length === 0) {
          chatroomMessages.innerHTML = '<p style="text-align: center; color: rgba(230, 217, 255, 0.6); font-style: italic;">No messages yet. Be the first to chat!</p>';
          return;
        }

        // Reverse to show most recent first
        const messagesReversed = [...currentDAO.dao.messages].reverse();
        messagesReversed.forEach(message => {
          const msgDiv = document.createElement('div');
          const proposalData = decodeProposalMessage(message.text);

          msgDiv.className = 'chatroom-message' + (proposalData ? ' proposal' : '');

          let messageContent = escapeHtml(message.text);
          if (proposalData) {
            // Format proposal message nicely
            const isETHTransfer = proposalData.value !== '0' && proposalData.data === '0x';
            const isTokenTransfer = proposalData.data.startsWith('0xa9059cbb');

            let formattedDetails = '';
            if (isETHTransfer) {
              const ethAmount = ethers.formatEther(proposalData.value);
              formattedDetails = `
                <div style="margin-top: 0.5rem; padding: 0.75rem; background: rgba(157, 123, 255, 0.1); border-left: 3px solid #9d7bff;">
                  <div style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 0.35rem;">ETH Transfer</div>
                  <div style="font-size: 0.9rem;">Amount: <strong>${escapeHtml(ethAmount)} ETH</strong></div>
                  <div style="font-size: 0.85rem; margin-top: 0.25rem;">To: <code style="background: rgba(0,0,0,0.3); padding: 0.2rem 0.4rem;">${escapeHtml(proposalData.to)}</code></div>
                </div>
              `;
            } else if (isTokenTransfer) {
              try {
                const abiCoder = new ethers.AbiCoder();
                const decoded = abiCoder.decode(['address', 'uint256'], '0x' + proposalData.data.slice(10));
                const recipient = decoded[0];
                const amount = decoded[1];
                // Try to identify token
                let tokenSymbol = 'TOKEN';
                if (proposalData.to.toLowerCase() === TOKEN_ADDRESSES.usdc.toLowerCase()) tokenSymbol = 'USDC';
                else if (proposalData.to.toLowerCase() === TOKEN_ADDRESSES.usdt.toLowerCase()) tokenSymbol = 'USDT';
                else if (proposalData.to.toLowerCase() === TOKEN_ADDRESSES.dai.toLowerCase()) tokenSymbol = 'DAI';
                else if (proposalData.to.toLowerCase() === TOKEN_ADDRESSES.wsteth.toLowerCase()) tokenSymbol = 'wstETH';
                else if (proposalData.to.toLowerCase() === TOKEN_ADDRESSES.reth.toLowerCase()) tokenSymbol = 'rETH';

                const decimals = (tokenSymbol === 'USDC' || tokenSymbol === 'USDT') ? 6 : 18;
                const formattedAmount = ethers.formatUnits(amount, decimals);

                formattedDetails = `
                  <div style="margin-top: 0.5rem; padding: 0.75rem; background: rgba(157, 123, 255, 0.1); border-left: 3px solid #9d7bff;">
                    <div style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 0.35rem;">${escapeHtml(tokenSymbol)} Transfer</div>
                    <div style="font-size: 0.9rem;">Amount: <strong>${escapeHtml(formattedAmount)} ${escapeHtml(tokenSymbol)}</strong></div>
                    <div style="font-size: 0.85rem; margin-top: 0.25rem;">To: <code style="background: rgba(0,0,0,0.3); padding: 0.2rem 0.4rem;">${escapeHtml(recipient)}</code></div>
                  </div>
                `;
              } catch (e) {
                formattedDetails = '';
              }
            }

            // Add SwissKnife link if calldata exists and is not empty
            let calldataLinkForMessage = '';
            if (proposalData.data && proposalData.data !== '0x' && proposalData.data.length > 2) {
              calldataLinkForMessage = `
                <div style="margin-top: 0.5rem;">
                  <a href="https://calldata.swiss-knife.xyz/decoder?calldata=${proposalData.data}"
                     target="_blank"
                     rel="noopener noreferrer"
                     style="font-size: 0.75rem; color: #9d7bff; text-decoration: none; display: inline-flex; align-items: center; gap: 0.35rem; opacity: 0.75; transition: opacity 0.3s ease;"
                     onmouseover="this.style.opacity='1'"
                     onmouseout="this.style.opacity='0.75'">
                    <span>🔍</span> Decode calldata on SwissKnife
                  </a>
                </div>
              `;
            }

            messageContent = `
              <strong style="color: #9d7bff; font-size: 0.85rem; letter-spacing: 0.1em;">PROPOSAL</strong>
              <div style="margin-top: 0.5rem; font-size: 1rem;">${escapeHtml(proposalData.description)}</div>
              ${formattedDetails}
              ${calldataLinkForMessage}
              <details style="margin-top: 0.75rem; opacity: 0.6;">
                <summary style="cursor: pointer; font-size: 0.75rem; letter-spacing: 0.05em; text-transform: uppercase;">Technical Details</summary>
                <pre style="margin-top: 0.5rem; padding: 0.5rem; background: rgba(0,0,0,0.4); overflow-x: auto; font-size: 0.7rem; border: 1px solid rgba(157, 123, 255, 0.2);">${escapeHtml(JSON.stringify({op: proposalData.op, to: proposalData.to, value: proposalData.value, data: proposalData.data.slice(0, 66) + (proposalData.data.length > 66 ? '...' : ''), nonce: proposalData.nonce}, null, 2))}</pre>
              </details>
            `;
          }

          msgDiv.innerHTML = `
            <div class="chatroom-message-header">
              <span>Message #${message.index}</span>
            </div>
            <div class="chatroom-message-text">
              ${messageContent}
            </div>
          `;

          chatroomMessages.appendChild(msgDiv);
        });

        // No auto-scroll since newest messages are now at the top
      }

      // Send chat message
      async function sendChatMessage() {
        if (!currentDAO || !signer) return;

        // Prevent race condition: don't allow multiple simultaneous messages
        if (isSendingMessage) return;

        const chatInput = document.getElementById('chatInput');
        const message = chatInput.value.trim();

        if (!message) return;

        isSendingMessage = true;
        try {
          const molochContract = new ethers.Contract(currentDAO.dao.dao, MOLOCH_ABI, signer);

          chatInput.value = 'Sending...';
          chatInput.disabled = true;

          const tx = await molochContract.chat(message);
          await tx.wait();

          chatInput.value = '';
          chatInput.disabled = false;

          // Refresh messages
          await refreshCurrentDAO();
          renderChatroom();
        } catch (error) {
          console.error('Error sending message:', error);
          chatInput.value = message; // Restore the message
          chatInput.disabled = false;

          if (isUserRejection(error)) {
            showStatus('Message cancelled', false);
            return;
          }

          let errorMessage = 'Failed to send message';
          if (error.shortMessage) {
            errorMessage = error.shortMessage;
          } else if (error.reason) {
            errorMessage = error.reason;
          } else if (error.message) {
            const msg = error.message.split('\n')[0];
            if (msg.length < 100) {
              errorMessage = msg;
            }
          }

          showStatus(errorMessage, true);
        } finally {
          isSendingMessage = false;
        }
      }

      // Render proposals
      async function renderProposals() {
        const proposalsList = document.getElementById('proposalsList');
        if (!proposalsList || !currentDAO?.dao) return;

        try {
          proposalsList.innerHTML = '';

          const proposals = currentDAO.dao.proposals || [];
          if (proposals.length === 0) {
          proposalsList.innerHTML = '<p style="text-align: center; color: rgba(230, 217, 255, 0.6); font-style: italic; margin-top: 1rem;">No proposals yet.</p>';
          return;
        }

        // Get config once for all proposals
        let daoConfig;
        try {
          const molochContract = new ethers.Contract(currentDAO.dao.dao, MOLOCH_ABI, provider);
          daoConfig = await molochContract.config();
        } catch (e) {
          console.error('Error getting DAO config:', e);
          daoConfig = 0n; // fallback
        }

        // Must match Moloch.sol enum ProposalState (line 79-87)
        const PROPOSAL_STATES = ['Unopened', 'Active', 'Queued', 'Succeeded', 'Defeated', 'Expired', 'Executed'];

        // Deduplicate proposals by ID
        const seenProposalIds = new Set();
        const uniqueProposals = currentDAO.dao.proposals.filter(proposal => {
          const id = proposal.id.toString();
          if (seenProposalIds.has(id)) {
            return false;
          }
          seenProposalIds.add(id);
          return true;
        });

        // Reverse to show most recent first
        const proposalsReversed = [...uniqueProposals].reverse();

        // Check if user has voted on any proposals (use voters data from view helper - no RPC calls!)
        const userVoteStatus = {};

        if (connectedAddress) {
          proposalsReversed.forEach(proposal => {
            // Check if user is in the voters array (already provided by view helper)
            const userVote = proposal.voters?.find(v =>
              v.voter?.toLowerCase() === connectedAddress.toLowerCase()
            );
            // userVoteStatus: 0 = not voted, 1 = Against, 2 = For, 3 = Abstain
            userVoteStatus[proposal.id.toString()] = userVote ? (Number(userVote.support) + 1) : 0;
          });
        }

        const molochContract = new ethers.Contract(currentDAO.dao.dao, MOLOCH_ABI, provider);

        proposalsReversed.forEach(proposal => {
          const proposalDiv = document.createElement('div');
          proposalDiv.className = 'proposal-item';

          // Convert state to number for comparison (might be BigInt)
          // Default to 0 if invalid to prevent NaN
          const state = proposal.state !== undefined && proposal.state !== null ? Number(proposal.state) : 0;
          const stateText = PROPOSAL_STATES[state] || `State ${state}`;
          const stateClass = stateText.toLowerCase();

          const forVotes = ethers.formatUnits(proposal.forVotes, 18);
          const againstVotes = ethers.formatUnits(proposal.againstVotes, 18);
          const abstainVotes = ethers.formatUnits(proposal.abstainVotes, 18);

          // Determine if proposal is executable
          // State 2 = Queued (timelock running), State 3 = Succeeded (passed, ready to execute)
          // For proposals with 0 TTL and 0 timelock, Succeeded means immediately executable
          const isExecutable = (state === 2 || state === 3);

          // Check if user has voted (0 = not voted, 1 = voted against, 2 = voted for, 3 = voted abstain)
          const hasVotedValue = userVoteStatus[proposal.id.toString()] || 0;
          const userHasVoted = hasVotedValue > 0;
          const userVoteType = hasVotedValue > 0 ? ['Against', 'For', 'Abstain'][hasVotedValue - 1] : null;

          // Find proposal description from messages and verify hash
          let description = `Proposal #${proposal.id.toString()}`;
          let isVerified = false;
          let verificationBadge = '';
          let proposalCalldata = null;
          let hasMessages = currentDAO.dao.messages && currentDAO.dao.messages.length > 0;

          if (hasMessages) {
            for (const msg of currentDAO.dao.messages) {
              const propData = decodeProposalMessage(msg.text);
              if (propData) {
                try {
                  // Recompute the proposal ID from the tagged data
                  const recomputedId = computeProposalId(
                    currentDAO.dao.dao,
                    propData.op,
                    propData.to,
                    BigInt(propData.value),
                    propData.data,
                    propData.nonce,
                    daoConfig
                  );

                  // Check if it matches this proposal's ID
                  if (recomputedId.toString() === proposal.id.toString()) {
                    description = propData.description || description;
                    isVerified = true;
                    proposalCalldata = propData.data;
                    break; // Found it, stop searching
                  }
                } catch (e) {
                  console.error('Error verifying proposal:', e);
                }
              }
            }
          }

          // Only show unverified badge if we have messages but couldn't verify
          // Don't show badge if messages haven't loaded yet (prevents false negatives)
          if (hasMessages && !isVerified) {
            verificationBadge = '<span style="color: #ff6b6b; font-size: 0.9rem; margin-left: 0.5rem;" title="⚠ Proposal data not found in messages - cannot verify integrity">⚠ Unverified</span>';
          }

          // Create SwissKnife link if calldata exists and is not empty
          let calldataLink = '';
          if (proposalCalldata && proposalCalldata !== '0x' && proposalCalldata.length > 2) {
            calldataLink = `
              <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(157, 123, 255, 0.15);">
                <a href="https://calldata.swiss-knife.xyz/decoder?calldata=${proposalCalldata}"
                   target="_blank"
                   rel="noopener noreferrer"
                   style="font-size: 0.8rem; color: #9d7bff; text-decoration: none; display: inline-flex; align-items: center; gap: 0.35rem; opacity: 0.8; transition: opacity 0.3s ease;"
                   onmouseover="this.style.opacity='1'"
                   onmouseout="this.style.opacity='0.8'">
                  <span>🔍</span> Decode calldata on SwissKnife
                </a>
              </div>
            `;
          }

          // Check futarchy state and user receipts
          let futarchyUI = '';
          if (proposal.futarchy && proposal.futarchy.enabled && connectedAddress) {
            const futarchy = proposal.futarchy;
            const isResolved = futarchy.resolved;

            if (isResolved) {
              // Compute receipt ID for winning side
              const winnerSupport = Number(futarchy.winner); // 0 or 1
              const receiptId = ethers.solidityPackedKeccak256(
                ['string', 'uint256', 'uint8'],
                ['Moloch:receipt', proposal.id, winnerSupport]
              );

              // Check if user holds winning receipts (this will be checked async below)
              futarchyUI = `<div class="futarchy-reward-box" id="futarchy-${proposal.id.toString()}">
                <div class="futarchy-reward-title">Futarchy Rewards</div>
                <div class="futarchy-reward-info" id="futarchy-info-${proposal.id.toString()}">Checking your rewards...</div>
              </div>`;

              // Async check receipt balance and update UI
              (async () => {
                try {
                  const userReceiptBalance = await molochContract.balanceOf(connectedAddress, receiptId);
                  const infoDiv = document.getElementById(`futarchy-info-${proposal.id.toString()}`);
                  const boxDiv = document.getElementById(`futarchy-${proposal.id.toString()}`);

                  if (userReceiptBalance > 0n) {
                    const receiptAmount = ethers.formatUnits(userReceiptBalance, 18);
                    const payoutPerUnit = futarchy.payoutPerUnit;
                    const estimatedReward = (userReceiptBalance * payoutPerUnit) / (10n ** 18n);
                    const estimatedRewardFormatted = ethers.formatUnits(estimatedReward, 18);

                    infoDiv.innerHTML = `You have <strong>${parseFloat(receiptAmount).toFixed(4)} winning receipts</strong><br>Estimated reward: <strong>${parseFloat(estimatedRewardFormatted).toFixed(4)} LOOT</strong>`;

                    const claimBtn = document.createElement('button');
                    claimBtn.className = 'proposal-button claim';
                    claimBtn.textContent = 'Claim Rewards';
                    claimBtn.onclick = () => claimFutarchyReward(proposal.id.toString(), userReceiptBalance.toString());
                    boxDiv.appendChild(claimBtn);
                  } else {
                    boxDiv.style.display = 'none';
                  }
                } catch (e) {
                  console.error('Error checking futarchy receipts:', e);
                  const boxDiv = document.getElementById(`futarchy-${proposal.id.toString()}`);
                  if (boxDiv) boxDiv.style.display = 'none';
                }
              })();
            }
          }

          const fullProposalId = proposal.id.toString();
          const truncatedId = fullProposalId.length > 12 ?
            fullProposalId.slice(0, 8) + '...' + fullProposalId.slice(-4) :
            fullProposalId;

          proposalDiv.innerHTML = `
            <div class="proposal-header">
              <span class="proposal-id" style="display: flex; align-items: center; gap: 0.35rem;">
                <span>Proposal #${truncatedId}</span>
                <button id="copy-proposal-${proposal.id}" onclick="copyProposalId('${fullProposalId}', '${proposal.id}')"
                        title="Copy full proposal ID"
                        style="background: none; border: none; color: rgba(230, 217, 255, 0.4); cursor: pointer; padding: 0.15rem; line-height: 1; transition: all 0.2s ease; display: flex; align-items: center;"
                        onmouseover="this.style.color='#9d7bff'; this.style.opacity='1';"
                        onmouseout="if (!this.classList.contains('copied')) { this.style.color='rgba(230, 217, 255, 0.4)'; }">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                  </svg>
                </button>
                ${verificationBadge}
              </span>
              <span class="proposal-state ${stateClass}">${stateText}</span>
            </div>
            <div class="proposal-description">${escapeHtml(description)}${calldataLink}</div>
            <div class="proposal-votes">
              <div class="proposal-vote-stat">
                <div class="proposal-vote-label">For</div>
                <div class="proposal-vote-value">${forVotes}</div>
              </div>
              <div class="proposal-vote-stat">
                <div class="proposal-vote-label">Against</div>
                <div class="proposal-vote-value">${againstVotes}</div>
              </div>
              <div class="proposal-vote-stat">
                <div class="proposal-vote-label">Abstain</div>
                <div class="proposal-vote-value">${abstainVotes}</div>
              </div>
            </div>
            <div class="proposal-actions">
              ${!userHasVoted && state === 1 ? `
                <button class="proposal-button for" onclick="voteOnProposal('${proposal.id.toString()}', 1)">Vote For</button>
                <button class="proposal-button against" onclick="voteOnProposal('${proposal.id.toString()}', 0)">Vote Against</button>
                <button class="proposal-button" onclick="voteOnProposal('${proposal.id.toString()}', 2)">Abstain</button>
              ` : ''}
              ${userHasVoted && state === 1 ? `
                <span class="user-vote-indicator">You voted: <strong>${userVoteType}</strong></span>
                <button class="proposal-button cancel" onclick="cancelVoteOnProposal('${proposal.id.toString()}')">Cancel Vote</button>
              ` : ''}
              ${isExecutable ?
                `<button class="proposal-button execute" onclick="executeProposalFromData('${proposal.id.toString()}')">Execute</button>` :
                ''}
            </div>
            ${futarchyUI}
          `;

          proposalsList.appendChild(proposalDiv);
        });
        } catch (error) {
          console.error('Error rendering proposals:', error);
          proposalsList.innerHTML = '<p style="text-align: center; color: rgba(255, 100, 100, 0.8); font-style: italic; margin-top: 1rem;">Failed to load proposals. Please try refreshing.</p>';
          showStatus('Failed to load proposals', true);
        }
      }

      // Vote on proposal
      async function voteOnProposal(proposalId, support) {
        if (!currentDAO || !signer) {
          showStatus('Please connect wallet and select a DAO', true);
          return;
        }

        // Prevent race condition: don't allow multiple simultaneous votes
        if (isVoting) return;

        // Validate proposalId before converting to BigInt
        if (!proposalId || proposalId === '' || (typeof proposalId === 'string' && !/^\d+$/.test(proposalId))) {
          showStatus('Invalid proposal ID', true);
          return;
        }

        isVoting = true;
        try {
          const molochContract = new ethers.Contract(currentDAO.dao.dao, MOLOCH_ABI, signer);

          // Convert string to BigInt (passed as string to avoid overflow in onclick)
          const proposalIdBigInt = BigInt(proposalId);

          const voteType = support === 1 ? 'For' : support === 0 ? 'Against' : 'Abstain';
          showStatus(`Casting vote ${voteType}...`, false);

          const tx = await molochContract.castVote(proposalIdBigInt, support);

          showStatus(`Transaction submitted. <a href="https://etherscan.io/tx/${tx.hash}" target="_blank" rel="noopener" style="color: #9d7bff; text-decoration: underline;">View on Etherscan</a>`, false);
          await tx.wait();

          showStatus(`✨ Vote ${voteType} cast! Refreshing...`, false);

          // Refresh DAO data with loading feedback
          await refreshCurrentDAO(true);
          await renderProposals();
        } catch (error) {
          console.error('Error voting:', error);

          if (isUserRejection(error)) {
            showStatus('Vote cancelled', false);
            return;
          }

          let errorMessage = 'Failed to cast vote';

          if (error.message?.includes('already voted')) {
            errorMessage = 'You have already voted on this proposal';
          } else if (error.message?.includes('not active')) {
            errorMessage = 'Proposal is not active for voting';
          } else if (error.message?.includes('insufficient')) {
            errorMessage = 'Insufficient voting power or funds';
          } else if (error.shortMessage) {
            errorMessage = error.shortMessage;
          } else if (error.reason) {
            errorMessage = error.reason;
          } else if (error.message) {
            const msg = error.message.split('\n')[0];
            if (msg.length < 100) {
              errorMessage = msg;
            }
          }

          showStatus(errorMessage, true);
        } finally {
          isVoting = false;
        }
      }

      // Cancel vote on proposal
      async function cancelVoteOnProposal(proposalId) {
        if (!currentDAO || !signer) {
          showStatus('Please connect wallet and select a DAO', true);
          return;
        }

        if (!confirm('Are you sure you want to cancel your vote on this proposal?')) {
          return;
        }

        // Validate proposalId before converting to BigInt
        if (!proposalId || proposalId === '' || (typeof proposalId === 'string' && !/^\d+$/.test(proposalId))) {
          showStatus('Invalid proposal ID', true);
          return;
        }

        // Prevent race condition: don't allow multiple simultaneous vote cancellations
        if (isCancellingVote) return;

        isCancellingVote = true;
        try {
          const molochContract = new ethers.Contract(currentDAO.dao.dao, MOLOCH_ABI, signer);

          // Convert string to BigInt (passed as string to avoid overflow in onclick)
          const proposalIdBigInt = BigInt(proposalId);

          showStatus('Cancelling vote...', false);
          const tx = await molochContract.cancelVote(proposalIdBigInt);

          showStatus(`Transaction submitted. <a href="https://etherscan.io/tx/${tx.hash}" target="_blank" rel="noopener" style="color: #9d7bff; text-decoration: underline;">View on Etherscan</a>`, false);
          await tx.wait();

          showStatus(`✨ Vote cancelled! Refreshing...`, false);

          // Refresh DAO data with loading feedback
          await refreshCurrentDAO(true);
          await renderProposals();
        } catch (error) {
          console.error('Error cancelling vote:', error);

          if (isUserRejection(error)) {
            showStatus('Vote cancellation aborted', false);
            return;
          }

          let errorMessage = 'Failed to cancel vote';

          if (error.message?.includes('not voted')) {
            errorMessage = 'You have not voted on this proposal';
          } else if (error.message?.includes('not active')) {
            errorMessage = 'Proposal is not active';
          } else if (error.shortMessage) {
            errorMessage = error.shortMessage;
          } else if (error.reason) {
            errorMessage = error.reason;
          } else if (error.message) {
            const msg = error.message.split('\n')[0];
            if (msg.length < 100) {
              errorMessage = msg;
            }
          }

          showStatus(errorMessage, true);
        } finally {
          isCancellingVote = false;
        }
      }

      // Claim futarchy rewards
      async function claimFutarchyReward(proposalId, amountStr) {
        if (!currentDAO || !signer) {
          showStatus('Please connect wallet and select a DAO', true);
          return;
        }

        // Validate inputs before converting to BigInt
        if (!proposalId || proposalId === '' || (typeof proposalId === 'string' && !/^\d+$/.test(proposalId))) {
          showStatus('Invalid proposal ID', true);
          return;
        }
        if (!amountStr || amountStr === '' || (typeof amountStr === 'string' && !/^\d+$/.test(amountStr))) {
          showStatus('Invalid amount', true);
          return;
        }

        try {
          const molochContract = new ethers.Contract(currentDAO.dao.dao, MOLOCH_ABI, signer);

          // Convert string to BigInt
          const proposalIdBigInt = BigInt(proposalId);
          const amount = BigInt(amountStr);

          showStatus('Claiming futarchy rewards...', false);
          const tx = await molochContract.cashOutFutarchy(proposalIdBigInt, amount);

          showStatus(`Transaction submitted. <a href="https://etherscan.io/tx/${tx.hash}" target="_blank" rel="noopener" style="color: #9d7bff; text-decoration: underline;">View on Etherscan</a>`, false);
          const receipt = await tx.wait();

          showStatus(`✨ Rewards claimed! Refreshing...`, false);

          // Refresh DAO data with loading feedback
          await refreshCurrentDAO(true);
          await renderProposals();
        } catch (error) {
          console.error('Error claiming futarchy rewards:', error);

          if (isUserRejection(error)) {
            showStatus('Claim cancelled', false);
            return;
          }

          let errorMessage = 'Failed to claim rewards';

          if (error.message?.includes('not enabled')) {
            errorMessage = 'Futarchy not enabled for this proposal';
          } else if (error.message?.includes('not resolved')) {
            errorMessage = 'Futarchy market not yet resolved';
          } else if (error.shortMessage) {
            errorMessage = error.shortMessage;
          } else if (error.reason) {
            errorMessage = error.reason;
          } else if (error.message) {
            const msg = error.message.split('\n')[0];
            if (msg.length < 100) {
              errorMessage = msg;
            }
          }

          showStatus(errorMessage, true);
        }
      }

      // Update calldata preview link in proposal form
      function updateCalldataPreview() {
        const calldataInput = document.getElementById('proposalData');
        const previewDiv = document.getElementById('calldataPreview');
        const previewLink = document.getElementById('calldataPreviewLink');

        if (!calldataInput || !previewDiv || !previewLink) return;

        const calldata = calldataInput.value.trim();

        // Show link only if calldata is not empty and not just "0x"
        if (calldata && calldata !== '0x' && calldata.length > 2) {
          previewLink.href = `https://calldata.swiss-knife.xyz/decoder?calldata=${calldata}`;
          previewDiv.style.display = 'block';
        } else {
          previewDiv.style.display = 'none';
        }
      }

      // Update target address hint to show token symbol if recognized
      function updateTargetAddressHint() {
        const addressInput = document.getElementById('proposalTo');
        const hintDiv = document.getElementById('targetAddressHint');
        const hintBadge = document.getElementById('targetAddressHintBadge');
        const valueGroup = document.getElementById('proposalValueGroup');

        if (!addressInput || !hintDiv || !hintBadge) return;

        const address = addressInput.value.trim().toLowerCase();

        // Check if address matches any known tokens
        const tokenMap = {
          [TOKEN_ADDRESSES.usdc.toLowerCase()]: 'USDC Token',
          [TOKEN_ADDRESSES.usdt.toLowerCase()]: 'USDT Token',
          [TOKEN_ADDRESSES.dai.toLowerCase()]: 'DAI Token',
          [TOKEN_ADDRESSES.wsteth.toLowerCase()]: 'wstETH Token',
          [TOKEN_ADDRESSES.reth.toLowerCase()]: 'rETH Token'
        };

        // Add shares and loot tokens if currentDAO is available
        if (currentDAO && currentDAO.dao && currentDAO.dao.meta) {
          if (currentDAO.dao.meta.sharesToken) {
            tokenMap[currentDAO.dao.meta.sharesToken.toLowerCase()] = `${currentDAO.dao.meta.symbol} Shares`;
          }
          if (currentDAO.dao.meta.lootToken) {
            tokenMap[currentDAO.dao.meta.lootToken.toLowerCase()] = `${currentDAO.dao.meta.symbol} Loot`;
          }
        }

        // Add the DAO's own address for self-calls
        if (currentDAO && currentDAO.dao && currentDAO.dao.dao) {
          if (address === currentDAO.dao.dao.toLowerCase()) {
            tokenMap[address] = `${currentDAO.dao.meta.symbol} DAO (Self-Call)`;
          }
        }

        if (tokenMap[address]) {
          hintBadge.textContent = `📍 ${tokenMap[address]}`;
          hintDiv.style.display = 'block';

          // Hide ETH value field for ERC20 tokens (no reason to send ETH to them)
          if (valueGroup) {
            valueGroup.style.display = 'none';
            document.getElementById('proposalValue').value = '0';
          }
        } else {
          hintDiv.style.display = 'none';

          // Show ETH value field for non-token addresses
          if (valueGroup) {
            valueGroup.style.display = 'block';
          }
        }

        // Update calldata translation when target changes
        updateCalldataTranslation();
      }

      // Translate calldata for known ERC20 functions
      function updateCalldataTranslation() {
        const targetInput = document.getElementById('proposalTo');
        const calldataInput = document.getElementById('proposalData');
        const translationDiv = document.getElementById('calldataTranslation');

        if (!targetInput || !calldataInput || !translationDiv) return;

        const target = targetInput.value.trim().toLowerCase();
        const calldata = calldataInput.value.trim();

        // Only translate if targeting a known ERC20 token
        const tokenInfo = {
          [TOKEN_ADDRESSES.usdc.toLowerCase()]: { symbol: 'USDC', decimals: 6 },
          [TOKEN_ADDRESSES.usdt.toLowerCase()]: { symbol: 'USDT', decimals: 6 },
          [TOKEN_ADDRESSES.dai.toLowerCase()]: { symbol: 'DAI', decimals: 18 },
          [TOKEN_ADDRESSES.wsteth.toLowerCase()]: { symbol: 'wstETH', decimals: 18 },
          [TOKEN_ADDRESSES.reth.toLowerCase()]: { symbol: 'rETH', decimals: 18 }
        };

        // Add shares and loot tokens if currentDAO is available
        if (currentDAO && currentDAO.dao && currentDAO.dao.meta) {
          if (currentDAO.dao.meta.sharesToken) {
            tokenInfo[currentDAO.dao.meta.sharesToken.toLowerCase()] = {
              symbol: currentDAO.dao.meta.symbol,
              decimals: 18
            };
          }
          if (currentDAO.dao.meta.lootToken) {
            tokenInfo[currentDAO.dao.meta.lootToken.toLowerCase()] = {
              symbol: `${currentDAO.dao.meta.symbol}-LOOT`,
              decimals: 18
            };
          }
        }

        const token = tokenInfo[target];

        // Check if this is a DAO self-call
        let isDaoSelfCall = false;
        if (currentDAO && currentDAO.dao && currentDAO.dao.dao) {
          isDaoSelfCall = (target === currentDAO.dao.dao.toLowerCase());
        }

        if (!calldata || calldata === '0x' || calldata.length < 10) {
          translationDiv.style.display = 'none';
          return;
        }

        // If it's neither a token nor a DAO self-call, don't translate
        if (!token && !isDaoSelfCall) {
          translationDiv.style.display = 'none';
          return;
        }

        try {
          const functionSelector = calldata.slice(0, 10).toLowerCase();
          const abiCoder = new ethers.AbiCoder();
          let translation = '';

          // setAutoFutarchy(uint256 param, uint256 cap) - 0x92a023a9 (for DAO self-calls)
          if (isDaoSelfCall && functionSelector === '0x92a023a9' && calldata.length >= 138) {
            const decoded = abiCoder.decode(['uint256', 'uint256'], '0x' + calldata.slice(10));
            const param = decoded[0];
            const cap = decoded[1];

            let futarchyDesc = 'Disabled';
            if (param > 0n && cap > 0n) {
              const paramBps = Number(param);
              const paramPercent = (paramBps / 100).toFixed(2);
              const capFormatted = parseFloat(ethers.formatEther(cap)).toFixed(1);
              futarchyDesc = `${paramPercent}% of supply, ${capFormatted} LOOT cap`;
            }

            translation = `
              <div style="opacity: 0.8; margin-bottom: 0.35rem; font-size: 0.8rem;">Configure Auto-Futarchy</div>
              <div>Set voter rewards: <strong>${futarchyDesc}</strong></div>
              <div style="margin-top: 0.25rem; font-size: 0.75rem; opacity: 0.7;">DAO self-call (governance)</div>
            `;
          }
          // setQuorumBps(uint16) - 0x0527aab6
          else if (isDaoSelfCall && functionSelector === '0x0527aab6' && calldata.length >= 74) {
            const decoded = abiCoder.decode(['uint16'], '0x' + calldata.slice(10));
            const bps = Number(decoded[0]);
            const percent = (bps / 100).toFixed(2);

            translation = `
              <div style="opacity: 0.8; margin-bottom: 0.35rem; font-size: 0.8rem;">Change Quorum</div>
              <div>Set quorum to: <strong>${percent}%</strong></div>
              <div style="margin-top: 0.25rem; font-size: 0.75rem; opacity: 0.7;">DAO self-call (governance)</div>
            `;
          }
          // setRagequittable(bool) - 0x174c480e
          else if (isDaoSelfCall && functionSelector === '0x174c480e' && calldata.length >= 74) {
            const decoded = abiCoder.decode(['bool'], '0x' + calldata.slice(10));
            const enabled = decoded[0];
            const status = enabled ? 'Enable' : 'Disable';

            translation = `
              <div style="opacity: 0.8; margin-bottom: 0.35rem; font-size: 0.8rem;">Toggle Ragequit</div>
              <div><strong>${status}</strong> ragequit functionality</div>
              <div style="margin-top: 0.25rem; font-size: 0.75rem; opacity: 0.7;">DAO self-call (governance)</div>
            `;
          }
          // setProposalTTL(uint64) - 0xff391467
          else if (isDaoSelfCall && functionSelector === '0xff391467' && calldata.length >= 74) {
            const decoded = abiCoder.decode(['uint64'], '0x' + calldata.slice(10));
            const ttlSeconds = Number(decoded[0]);
            const ttlFormatted = formatDuration(ttlSeconds);

            translation = `
              <div style="opacity: 0.8; margin-bottom: 0.35rem; font-size: 0.8rem;">Change Proposal TTL</div>
              <div>Set proposal expiration to: <strong>${ttlFormatted}</strong></div>
              <div style="margin-top: 0.25rem; font-size: 0.75rem; opacity: 0.7;">DAO self-call (governance)</div>
            `;
          }
          // setTimelockDelay(uint64) - 0x3821933a
          else if (isDaoSelfCall && functionSelector === '0x3821933a' && calldata.length >= 74) {
            const decoded = abiCoder.decode(['uint64'], '0x' + calldata.slice(10));
            const delaySeconds = Number(decoded[0]);
            const delayFormatted = formatDuration(delaySeconds);

            translation = `
              <div style="opacity: 0.8; margin-bottom: 0.35rem; font-size: 0.8rem;">Change Timelock Delay</div>
              <div>Set execution delay to: <strong>${delayFormatted}</strong></div>
              <div style="margin-top: 0.25rem; font-size: 0.75rem; opacity: 0.7;">DAO self-call (governance)</div>
            `;
          }
          // setProposalThreshold(uint96) - 0x80ca42a1
          else if (isDaoSelfCall && functionSelector === '0x80ca42a1' && calldata.length >= 74) {
            const decoded = abiCoder.decode(['uint96'], '0x' + calldata.slice(10));
            const thresholdWei = decoded[0];
            const thresholdFormatted = parseFloat(ethers.formatUnits(thresholdWei, 18)).toFixed(2);

            translation = `
              <div style="opacity: 0.8; margin-bottom: 0.35rem; font-size: 0.8rem;">Change Proposal Threshold</div>
              <div>Set minimum shares to: <strong>${thresholdFormatted}</strong></div>
              <div style="margin-top: 0.25rem; font-size: 0.75rem; opacity: 0.7;">DAO self-call (governance)</div>
            `;
          }
          // setSale(address payToken, uint256 pricePerShare, uint256 cap, bool minting, bool active, bool isLoot) - 0x48b7fef2
          else if (isDaoSelfCall && functionSelector === '0x48b7fef2' && calldata.length >= 394) {
            const decoded = abiCoder.decode(['address', 'uint256', 'uint256', 'bool', 'bool', 'bool'], '0x' + calldata.slice(10));
            const payToken = decoded[0];
            const pricePerShare = decoded[1];
            const cap = decoded[2];
            const minting = decoded[3];
            const active = decoded[4];
            const isLoot = decoded[5];

            const tokenNames = {
              [ethers.ZeroAddress.toLowerCase()]: 'ETH',
              [TOKEN_ADDRESSES.usdc.toLowerCase()]: 'USDC',
              [TOKEN_ADDRESSES.usdt.toLowerCase()]: 'USDT',
              [TOKEN_ADDRESSES.dai.toLowerCase()]: 'DAI',
              [TOKEN_ADDRESSES.wsteth.toLowerCase()]: 'wstETH',
              [TOKEN_ADDRESSES.reth.toLowerCase()]: 'rETH'
            };

            const tokenDecimals = {
              [ethers.ZeroAddress.toLowerCase()]: 18,
              [TOKEN_ADDRESSES.usdc.toLowerCase()]: 6,
              [TOKEN_ADDRESSES.usdt.toLowerCase()]: 6,
              [TOKEN_ADDRESSES.dai.toLowerCase()]: 18,
              [TOKEN_ADDRESSES.wsteth.toLowerCase()]: 18,
              [TOKEN_ADDRESSES.reth.toLowerCase()]: 18
            };

            // Check customTokenCache for custom tokens
            let tokenName = tokenNames[payToken.toLowerCase()];
            let decimals = tokenDecimals[payToken.toLowerCase()];

            if (!tokenName && customTokenCache[payToken.toLowerCase()]) {
              tokenName = customTokenCache[payToken.toLowerCase()].symbol;
              decimals = customTokenCache[payToken.toLowerCase()].decimals;
            }

            tokenName = tokenName || 'Unknown';
            decimals = decimals || 18;

            // pricePerShare is a simple integer ratio (token-wei per share-wei)
            // For display, just show the raw number (e.g., "1" for 1:1, "2" for 2:1)
            const price = pricePerShare.toString();
            const tokenType = isLoot ? 'LOOT' : 'SHARES';
            const statusText = active ? 'Enable' : 'Disable';
            const capText = cap > 0n ? `${ethers.formatEther(cap)} cap` : 'unlimited';
            const sourceText = minting ? 'mint new' : 'from treasury';

            translation = `
              <div style="opacity: 0.8; margin-bottom: 0.35rem; font-size: 0.8rem;">Configure ${tokenType} Sale</div>
              <div>${statusText}: <strong>${price}:1 ratio</strong> (${price} ${tokenName} per ${tokenType} token)</div>
              <div style="margin-top: 0.25rem; font-size: 0.75rem; opacity: 0.7;">${sourceText}, ${capText}</div>
            `;
          }
          // setRenderer(address) - 0x56d3163d
          else if (isDaoSelfCall && functionSelector === '0x56d3163d' && calldata.length >= 74) {
            const decoded = abiCoder.decode(['address'], '0x' + calldata.slice(10));
            const newRenderer = decoded[0];

            translation = `
              <div style="opacity: 0.8; margin-bottom: 0.35rem; font-size: 0.8rem;">Change Renderer</div>
              <div>Set renderer to:</div>
              <div style="margin-top: 0.25rem; font-size: 0.8rem;"><code style="background: rgba(0,0,0,0.3); padding: 0.15rem 0.35rem;">${newRenderer}</code></div>
              <div style="margin-top: 0.25rem; font-size: 0.75rem; opacity: 0.7;">DAO self-call (governance)</div>
            `;
          }
          // mintFromMoloch(address recipient, uint256 amount) - 0x2806b0af
          else if (token && functionSelector === '0x2806b0af' && calldata.length >= 138) {
            const decoded = abiCoder.decode(['address', 'uint256'], '0x' + calldata.slice(10));
            const recipient = decoded[0];
            const amount = decoded[1];
            const formattedAmount = ethers.formatUnits(amount, token.decimals);

            translation = `
              <div style="opacity: 0.8; margin-bottom: 0.35rem; font-size: 0.8rem;">Mint Tokens</div>
              <div>Mint <strong>${formattedAmount} ${token.symbol}</strong></div>
              <div style="margin-top: 0.25rem; font-size: 0.8rem;">To: <code style="background: rgba(0,0,0,0.3); padding: 0.15rem 0.35rem;">${recipient}</code></div>
            `;
          }
          // transfer(address recipient, uint256 amount) - 0xa9059cbb
          else if (token && functionSelector === '0xa9059cbb' && calldata.length >= 138) {
            const decoded = abiCoder.decode(['address', 'uint256'], '0x' + calldata.slice(10));
            const recipient = decoded[0];
            const amount = decoded[1];
            const formattedAmount = ethers.formatUnits(amount, token.decimals);

            translation = `
              <div style="opacity: 0.8; margin-bottom: 0.35rem; font-size: 0.8rem;">Transfer</div>
              <div>Send <strong>${formattedAmount} ${token.symbol}</strong></div>
              <div style="margin-top: 0.25rem; font-size: 0.8rem;">To: <code style="background: rgba(0,0,0,0.3); padding: 0.15rem 0.35rem;">${recipient}</code></div>
            `;
          }
          // approve(address spender, uint256 amount) - 0x095ea7b3
          else if (token && functionSelector === '0x095ea7b3' && calldata.length >= 138) {
            const decoded = abiCoder.decode(['address', 'uint256'], '0x' + calldata.slice(10));
            const spender = decoded[0];
            const amount = decoded[1];
            const formattedAmount = amount === ethers.MaxUint256 ? 'Unlimited' : ethers.formatUnits(amount, token.decimals);

            translation = `
              <div style="opacity: 0.8; margin-bottom: 0.35rem; font-size: 0.8rem;">Approve</div>
              <div>Allow <strong>${formattedAmount} ${token.symbol}</strong></div>
              <div style="margin-top: 0.25rem; font-size: 0.8rem;">Spender: <code style="background: rgba(0,0,0,0.3); padding: 0.15rem 0.35rem;">${spender}</code></div>
            `;
          }
          // transferFrom(address sender, address recipient, uint256 amount) - 0x23b872dd
          else if (token && functionSelector === '0x23b872dd' && calldata.length >= 202) {
            const decoded = abiCoder.decode(['address', 'address', 'uint256'], '0x' + calldata.slice(10));
            const sender = decoded[0];
            const recipient = decoded[1];
            const amount = decoded[2];
            const formattedAmount = ethers.formatUnits(amount, token.decimals);

            translation = `
              <div style="opacity: 0.8; margin-bottom: 0.35rem; font-size: 0.8rem;">Transfer From</div>
              <div>Send <strong>${formattedAmount} ${token.symbol}</strong></div>
              <div style="margin-top: 0.25rem; font-size: 0.8rem;">From: <code style="background: rgba(0,0,0,0.3); padding: 0.15rem 0.35rem;">${sender}</code></div>
              <div style="margin-top: 0.25rem; font-size: 0.8rem;">To: <code style="background: rgba(0,0,0,0.3); padding: 0.15rem 0.35rem;">${recipient}</code></div>
            `;
          }

          if (translation) {
            translationDiv.innerHTML = translation;
            translationDiv.style.display = 'block';
          } else {
            translationDiv.style.display = 'none';
          }
        } catch (e) {
          console.error('Error translating calldata:', e);
          translationDiv.style.display = 'none';
        }
      }

      // Create and publish proposal
      async function createProposal() {
        if (!currentDAO || !signer) {
          showStatus('Please connect wallet and select a DAO', true);
          return;
        }

        // Prevent race condition: don't allow multiple simultaneous proposal creations
        if (isCreatingProposal) return;

        const op = parseInt(document.getElementById('proposalOp').value);
        const to = document.getElementById('proposalTo').value;
        const value = document.getElementById('proposalValue').value;
        let data = document.getElementById('proposalData').value || '0x';
        const description = document.getElementById('proposalDescription').value;

        if (!to || !value || !description) {
          showStatus('Please fill in all required fields', true);
          return;
        }

        // Validate and normalize inputs
        try {
          // Ensure data is valid hex
          if (!data.startsWith('0x')) {
            data = '0x' + data;
          }
          if (data.length % 2 !== 0) {
            throw new Error('Data must be valid hex (even number of characters)');
          }

          // Validate address
          if (!ethers.isAddress(to)) {
            throw new Error('Invalid target address');
          }
        } catch (validationError) {
          showStatus('Validation error: ' + validationError.message, true);
          return;
        }

        // Generate random nonce (32 bytes)
        const nonce = ethers.hexlify(ethers.randomBytes(32));

        isCreatingProposal = true;
        try {
          const molochContract = new ethers.Contract(currentDAO.dao.dao, MOLOCH_ABI, signer);

          // Get config from DAO
          const config = await molochContract.config();

          // Compute proposal ID locally
          const valueWei = ethers.parseEther(value);
          const computedProposalId = computeProposalId(currentDAO.dao.dao, op, to, valueWei, data, nonce, config);

          // Encode proposal as message
          // The tagged JSON contains all execution parameters
          // The description is included in the JSON for readability
          const proposalMessage = encodeProposalMessage(op, to, valueWei, data, nonce, description);

          // Create interface for encoding multicall data
          const iface = new ethers.Interface(MOLOCH_ABI);

          // Encode chat call
          const chatCalldata = iface.encodeFunctionData('chat', [proposalMessage]);

          // Encode openProposal call
          const openProposalCalldata = iface.encodeFunctionData('openProposal', [computedProposalId]);

          // Execute multicall (chat + openProposal in one transaction)
          showStatus('Creating proposal...', false);
          const tx = await molochContract.multicall([chatCalldata, openProposalCalldata]);

          showStatus('Transaction submitted. Waiting for confirmation...', false);
          await tx.wait();

          showStatus(`✨ Proposal created! Refreshing...`, false);

          // Clear form (reset op to 0/call)
          document.getElementById('proposalOp').value = '0';
          document.getElementById('proposalTo').value = '';
          document.getElementById('proposalValue').value = '';
          document.getElementById('proposalData').value = '';
          document.getElementById('proposalDescription').value = '';

          // Clear UI hints
          updateTargetAddressHint();
          updateCalldataTranslation();
          updateCalldataPreview();

          // Refresh with loading feedback
          await refreshCurrentDAO(true);
          renderChatroom();
          await renderProposals();
        } catch (error) {
          console.error('Error creating proposal:', error);

          if (isUserRejection(error)) {
            showStatus('Proposal creation cancelled', false);
            return;
          }

          let errorMessage = 'Failed to create proposal';

          if (error.message?.includes('insufficient funds')) {
            errorMessage = 'Insufficient funds for transaction';
          } else if (error.shortMessage) {
            errorMessage = error.shortMessage;
          } else if (error.reason) {
            errorMessage = error.reason;
          } else if (error.message) {
            // Only show concise error, not the full dump
            const msg = error.message.split('\n')[0]; // Take first line only
            if (msg.length < 100) {
              errorMessage = msg;
            }
          }

          showStatus(errorMessage, true);
        } finally {
          isCreatingProposal = false;
        }
      }

      // Execute proposal by extracting parameters from tagged message
      async function executeProposalFromData(proposalId) {
        // Prevent race condition: don't allow multiple simultaneous executions
        if (isExecutingProposal) return;

        // Validate proposalId before converting to BigInt
        if (!proposalId || proposalId === '' || (typeof proposalId === 'string' && !/^\d+$/.test(proposalId))) {
          showStatus('Invalid proposal ID', true);
          return;
        }

        // Convert string to BigInt (passed as string to avoid overflow in onclick)
        const proposalIdBigInt = BigInt(proposalId);

        isExecutingProposal = true;
        try {
          const molochContract = new ethers.Contract(currentDAO.dao.dao, MOLOCH_ABI, signer);
          const config = await molochContract.config();

          // Find the proposal data from messages by matching the proposal ID
          let proposalData = null;
          for (const msg of currentDAO.dao.messages) {
            const propData = decodeProposalMessage(msg.text);
            if (propData) {
              // Verify this is the correct proposal by computing its ID
              const valueBigInt = BigInt(propData.value);
              const computedId = computeProposalId(
                currentDAO.dao.dao,
                propData.op,
                propData.to,
                valueBigInt,
                propData.data,
                propData.nonce,
                config
              );

              if (computedId.toString() === proposalIdBigInt.toString()) {
                proposalData = propData;
                break;
              }
            }
          }

          if (!proposalData) {
            showStatus('Could not find proposal data in messages', true);
            return;
          }

          // Convert stored string value back to BigInt for proper encoding
          const valueBigInt = BigInt(proposalData.value);

          if (!confirm(`Execute proposal:\n\n${proposalData.description}\n\nOp: ${proposalData.op}\nTo: ${proposalData.to}\nValue: ${ethers.formatEther(valueBigInt)} ETH\nData: ${proposalData.data.slice(0, 66)}${proposalData.data.length > 66 ? '...' : ''}`)) {
            return;
          }

          showStatus('Executing proposal...', false);

          const tx = await molochContract.executeByVotes(
            proposalData.op,
            proposalData.to,
            valueBigInt,  // Use BigInt, not string
            proposalData.data,
            proposalData.nonce
          );

          showStatus(`Transaction submitted. <a href="https://etherscan.io/tx/${tx.hash}" target="_blank" rel="noopener" style="color: #9d7bff; text-decoration: underline;">View on Etherscan</a>`, false);
          await tx.wait();

          showStatus(`✨ Proposal executed! Refreshing...`, false);

          // Refresh with loading feedback
          await refreshCurrentDAO(true);
          await renderProposals();
          await renderSalesInfo(); // Refresh sales in case it was a sale proposal
        } catch (error) {
          console.error('Error executing proposal:', error);

          if (isUserRejection(error)) {
            showStatus('Execution cancelled', false);
            return;
          }

          let errorMessage = 'Failed to execute proposal';

          if (error.message?.includes('not succeeded')) {
            errorMessage = 'Proposal has not passed or is not ready for execution';
          } else if (error.message?.includes('already executed')) {
            errorMessage = 'Proposal has already been executed';
          } else if (error.message?.includes('insufficient funds')) {
            errorMessage = 'Insufficient funds in treasury';
          } else if (error.shortMessage) {
            errorMessage = error.shortMessage;
          } else if (error.reason) {
            errorMessage = error.reason;
          } else if (error.message) {
            const msg = error.message.split('\n')[0];
            if (msg.length < 100) {
              errorMessage = msg;
            }
          }

          showStatus(errorMessage, true);
        } finally {
          isExecutingProposal = false;
        }
      }

      // Refresh current DAO data
      async function refreshCurrentDAO(showLoading = false) {
        if (!currentDAO || !provider || !connectedAddress) return;

        try {
          if (showLoading) {
            showStatus('Refreshing...', false);
          }

          const viewHelper = new ethers.Contract(VIEW_HELPER_ADDRESS, VIEW_HELPER_ABI, provider);

          // Fetch more proposals and messages (20 each) to ensure we see new items
          // Note: fetches from start (0), so we get the most recent items
          const updatedDAOs = await viewHelper.getUserDAOsFullState(
            connectedAddress,
            0,  // daoStart
            10, // daoCount
            0,  // proposalStart (0 = most recent)
            20, // proposalCount (fetch more proposals)
            0,  // messageStart (0 = most recent)
            20  // messageCount (fetch more messages)
          );

          // Find current DAO in updated list
          for (let i = 0; i < updatedDAOs.length; i++) {
            if (updatedDAOs[i].dao.dao.toLowerCase() === currentDAO.dao.dao.toLowerCase()) {
              currentDAO = updatedDAOs[i];
              userDAOs = updatedDAOs;
              break;
            }
          }

          if (showLoading) {
            showStatus('Refreshed', false);
            // Clear status after a short delay
            setTimeout(() => {
              const statusEl = document.getElementById('status');
              if (statusEl && statusEl.textContent === 'Refreshed') {
                statusEl.textContent = '';
              }
            }, 1500);
          }
        } catch (error) {
          console.error('Error refreshing DAO:', error);
          if (showLoading) {
            showStatus('Error refreshing DAO', true);
          }
        }
      }

      // Manual refresh with button animation + rate limiting
      let lastRefreshTime = 0;
      let isRefreshing = false;

      async function manualRefreshDAO() {
        const refreshBtn = document.getElementById('refreshButton');
        if (!refreshBtn || !currentDAO) return;

        // Prevent race condition: don't allow multiple simultaneous refreshes
        if (isRefreshing) return;

        // Rate limiting check
        const now = Date.now();
        const timeSinceLastRefresh = now - lastRefreshTime;
        if (timeSinceLastRefresh < CONSTANTS.REFRESH_COOLDOWN_MS) {
          const remainingSeconds = Math.ceil((CONSTANTS.REFRESH_COOLDOWN_MS - timeSinceLastRefresh) / 1000);
          showStatus(`Please wait ${remainingSeconds}s before refreshing again`, false);
          return;
        }

        isRefreshing = true;

        // Add spinning animation
        const svg = refreshBtn.querySelector('svg');
        svg.style.animation = 'spin 1s linear infinite';
        refreshBtn.disabled = true;
        refreshBtn.style.cursor = 'not-allowed';

        try {
          // Refresh DAO data
          await refreshCurrentDAO(true);

          // Re-render all views
          renderDaoStats();
          renderChatroom();
          await renderProposals();
          await renderSalesInfo();
          await renderMembership();
          await renderMembers();

          // Only update lastRefreshTime after successful completion
          lastRefreshTime = Date.now();
        } catch (error) {
          console.error('Error during manual refresh:', error);
          showStatus('Failed to refresh DAO', true);
        } finally {
          // Remove spinning animation
          svg.style.animation = '';
          refreshBtn.disabled = false;
          refreshBtn.style.cursor = 'pointer';
          isRefreshing = false;
        }
      }

      function createMemberRow(address = '', shares = '', isFirst = false) {
        const row = document.createElement('div');
        row.className = 'member-row';
        row.dataset.memberId = memberIdCounter++;
        
        row.innerHTML = `
          <input type="text" class="form-input member-address" placeholder="0x... or ENS name" value="${address}" ${isFirst ? 'readonly' : ''}>
          <input type="number" class="form-input member-shares" placeholder="Shares" value="${shares}" min="0.000000000000000001" step="any">
          ${!isFirst ? '<button type="button" class="remove-member" onclick="removeMember(this)">×</button>' : ''}
        `;
        
        return row;
      }

      function addMemberRow() {
        const memberRow = createMemberRow();
        document.getElementById('foundingMembersList').appendChild(memberRow);
        updateLootInputs();
      }

      function removeMember(button) {
        button.parentElement.remove();
        updateLootInputs();
      }

      function toggleAdvanced() {
        const advanced = document.getElementById('advancedSettings');
        advanced.classList.toggle('show');
        document.querySelector('.advanced-toggle').textContent = 
          advanced.classList.contains('show') ? '▲ Advanced Settings' : '▼ Advanced Settings';
      }

      async function resolveENS(input) {
        if (input.endsWith('.eth')) {
          try {
            const address = await provider.resolveName(input);
            if (address) return address;
            throw new Error(`Could not resolve ENS name: ${input}`);
          } catch (e) {
            console.error('ENS resolution failed:', e);
            throw new Error(`Invalid ENS name: ${input}`);
          }
        }
        return input;
      }

      // Debounce utility for performance optimization
      function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }

      // Throttle utility for scroll/resize events
      function throttle(func, limit) {
        let inThrottle;
        return function(...args) {
          if (!inThrottle) {
            func.apply(this, args);
            inThrottle = true;
            setTimeout(() => inThrottle = false, limit);
          }
        };
      }

      // Create tooltip helper
      function addTooltip(element, text) {
        if (!element || !text) return;
        element.classList.add('tooltip');
        const tooltip = document.createElement('span');
        tooltip.className = 'tooltip-text';
        tooltip.textContent = text;
        element.appendChild(tooltip);
      }

      // Create enhanced empty state
      function createEmptyState(icon, title, description, actionText = null, actionCallback = null) {
        const container = document.createElement('div');
        container.style.cssText = `
          grid-column: 1/-1;
          text-align: center;
          padding: 3rem 1.5rem;
          color: rgba(230, 217, 255, 0.6);
        `;

        container.innerHTML = `
          <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.6;">${icon}</div>
          <div style="font-family: 'Cinzel', serif; font-size: 1rem; color: rgba(230, 217, 255, 0.8); margin-bottom: 0.5rem; letter-spacing: 0.1em;">${title}</div>
          <div style="font-family: 'EB Garamond', serif; font-size: 0.9rem; font-style: italic; max-width: 400px; margin: 0 auto;">${description}</div>
        `;

        if (actionText && actionCallback) {
          const button = document.createElement('button');
          button.textContent = actionText;
          button.style.cssText = `
            margin-top: 1.5rem;
            padding: 0.75rem 1.5rem;
            background: rgba(157, 123, 255, 0.2);
            border: 1px solid rgba(157, 123, 255, 0.4);
            color: #9d7bff;
            font-family: 'Cinzel', serif;
            font-size: 0.8rem;
            letter-spacing: 0.1em;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            border-radius: 4px;
          `;
          button.onclick = actionCallback;
          button.onmouseover = () => {
            button.style.background = 'rgba(157, 123, 255, 0.3)';
            button.style.borderColor = '#9d7bff';
            button.style.transform = 'translateY(-2px)';
          };
          button.onmouseout = () => {
            button.style.background = 'rgba(157, 123, 255, 0.2)';
            button.style.borderColor = 'rgba(157, 123, 255, 0.4)';
            button.style.transform = 'translateY(0)';
          };
          container.appendChild(button);
        }

        return container;
      }

      // Create loading skeleton
      function createSkeleton(type = 'card') {
        const skeleton = document.createElement('div');
        skeleton.className = 'skeleton';

        if (type === 'card') {
          skeleton.style.cssText = 'height: 200px; width: 100%; margin-bottom: 1rem;';
        } else if (type === 'text') {
          skeleton.style.cssText = 'height: 1rem; width: 100%; margin-bottom: 0.5rem;';
        } else if (type === 'title') {
          skeleton.style.cssText = 'height: 1.5rem; width: 60%; margin-bottom: 1rem;';
        }

        return skeleton;
      }

      // Show loading state
      function showLoadingState(container, count = 3, type = 'card') {
        if (!container) return;
        container.innerHTML = '';
        for (let i = 0; i < count; i++) {
          container.appendChild(createSkeleton(type));
        }
      }

      // Progress bar utilities
      function showProgress() {
        const bar = document.getElementById('progressBar');
        if (bar) bar.style.display = 'block';
      }

      function hideProgress() {
        const bar = document.getElementById('progressBar');
        if (bar) {
          setTimeout(() => {
            bar.style.display = 'none';
          }, 300);
        }
      }

      // Toast notification system
      function showToast(message, type = 'info', duration = 4000) {
        const container = document.getElementById('toastContainer');
        if (!container) return;

        const toast = document.createElement('div');
        toast.className = 'toast';

        let icon = 'ℹ️';
        let color = '#9d7bff';

        if (type === 'success') {
          icon = '✨';
          color = '#66ff66';
        } else if (type === 'error') {
          icon = '⚠️';
          color = '#ff6b6b';
        } else if (type === 'warning') {
          icon = '⚡';
          color = '#ffc107';
        }

        toast.innerHTML = `
          <div style="display: flex; align-items: center; gap: 0.75rem;">
            <div style="font-size: 1.5rem;">${icon}</div>
            <div style="flex: 1; color: ${color}; font-family: 'EB Garamond', serif;">${message}</div>
          </div>
        `;

        container.appendChild(toast);

        // Auto remove
        setTimeout(() => {
          toast.style.animation = 'fadeOut 0.3s ease-out forwards';
          setTimeout(() => {
            container.removeChild(toast);
          }, 300);
        }, duration);
      }

      // Keyboard shortcuts (consolidated)
      document.addEventListener('keydown', (e) => {
        // ESC to close modals
        if (e.key === 'Escape') {
          closeNFTModal();
          closeWalletModal();
          closePurchaseModal();
          closeRagequitModal();
        }

        // Ctrl/Cmd + B to go back to gallery
        if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
          e.preventDefault();
          if (currentDAO) {
            backToGallery();
          }
        }

        // Ctrl/Cmd + / to show keyboard shortcuts
        if ((e.ctrlKey || e.metaKey) && e.key === '/') {
          e.preventDefault();
          showToast('Keyboard Shortcuts: Cmd/Ctrl+B = Back to Gallery | ESC = Close Modals', 'info', 6000);
        }
      });

      let statusTimeout = null;

      function showStatus(message, isError = false, type = 'info', autoDismiss = true) {
        const statusEl = document.getElementById('statusMessage');

        // Clear existing timeout
        if (statusTimeout) {
          clearTimeout(statusTimeout);
          statusTimeout = null;
        }

        // Determine status class
        let statusClass = 'status-message';
        if (isError) {
          statusClass += ' error-message';
        } else if (type === 'success') {
          statusClass += ' success';
        } else if (type === 'warning') {
          statusClass += ' warning';
        }

        // Add spinner for loading states
        const spinner = message.includes('...') && !message.includes('✨') && !message.includes('href=')
          ? '<span class="spinner"></span>'
          : '';

        statusEl.innerHTML = `<div class="${statusClass}">${spinner}${message}</div>`;

        // Auto-dismiss success messages after delay
        if (autoDismiss && !isError) {
          const delay = message.includes('✨') ? 8000 : 6000;
          statusTimeout = setTimeout(() => {
            const msgEl = statusEl.querySelector('.status-message');
            if (msgEl) {
              msgEl.style.animation = 'fadeOut 0.3s ease-out forwards';
              setTimeout(() => {
                statusEl.innerHTML = '';
              }, 300);
            }
          }, delay);
        }
      }

      function clearStatus() {
        const statusEl = document.getElementById('statusMessage');
        const msgEl = statusEl.querySelector('.status-message');
        if (msgEl) {
          msgEl.style.animation = 'fadeOut 0.3s ease-out forwards';
          setTimeout(() => {
            statusEl.innerHTML = '';
          }, 300);
        }
        if (statusTimeout) {
          clearTimeout(statusTimeout);
          statusTimeout = null;
        }
      }

      function copyProposalId(proposalId, proposalIdForButton) {
        // Use modern clipboard API
        navigator.clipboard.writeText(proposalId).then(() => {
          // Visual feedback on the button
          const btn = document.getElementById(`copy-proposal-${proposalIdForButton}`);
          if (btn) {
            const svg = btn.querySelector('svg');
            const originalColor = btn.style.color;

            // Add copied class and change appearance
            btn.classList.add('copied');
            btn.style.color = '#66ff66';
            btn.title = 'Copied!';

            // Change icon to checkmark
            if (svg) {
              svg.innerHTML = `
                <path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              `;
            }

            // Reset after 2 seconds
            setTimeout(() => {
              btn.classList.remove('copied');
              btn.style.color = 'rgba(230, 217, 255, 0.4)';
              btn.title = 'Copy full proposal ID';

              // Restore copy icon
              if (svg) {
                svg.innerHTML = `
                  <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                  <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                `;
              }
            }, 2000);
          }

          showStatus('Proposal ID copied to clipboard', false);
        }).catch((err) => {
          console.error('Failed to copy:', err);
          showStatus('Failed to copy proposal ID', true);
        });
      }

      // Sale payment token dropdown functions
      let selectedSalePaymentToken = 'dai';
      const salePaymentTokenIcons = {
        dai: TOKEN_ICONS.dai,
        defaultCoin: TOKEN_ICONS.defaultCoin
      };

      function toggleSalePaymentTokenDropdown() {
        const dropdown = document.getElementById('salePaymentTokenDropdown');
        dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
      }

      function selectSalePaymentToken(token) {
        selectedSalePaymentToken = token;
        document.getElementById('salePaymentToken').value = token;

        // Show/hide custom token fields
        const customTokenFields = document.getElementById('customTokenFields');
        if (customTokenFields) {
          customTokenFields.style.display = token === 'custom' ? 'block' : 'none';
        }

        // Update display
        const iconEl = document.getElementById('salePaymentTokenIcon');
        const labelEl = document.getElementById('salePaymentTokenLabel');
        if (iconEl && labelEl) {
          if (token === 'custom') {
            iconEl.innerHTML = salePaymentTokenIcons.defaultCoin;
            labelEl.textContent = 'CUSTOM TOKEN';
          } else {
            iconEl.innerHTML = salePaymentTokenIcons[token];
            labelEl.textContent = token.toUpperCase();
          }
        }

        // Close dropdown
        document.getElementById('salePaymentTokenDropdown').style.display = 'none';

        // Update hint
        if (typeof updateSummonerSaleHint === 'function') {
          updateSummonerSaleHint();
        }
      }

      // Validate custom sale token in summoning form
      async function validateCustomSaleToken() {
        try {
          const inputEl = document.getElementById('customSaleTokenAddress');
          const tokenAddress = inputEl?.value?.trim();
          const infoDiv = document.getElementById('customSaleTokenInfo');

          if (!infoDiv) {
            return;
          }

          if (!tokenAddress || tokenAddress.length === 0) {
            infoDiv.innerHTML = '<span style="color: #ff6b6b;">Please enter a token address</span>';
            return;
          }

          if (!ethers.isAddress(tokenAddress)) {
            infoDiv.innerHTML = '<span style="color: #ff6b6b;">Invalid Ethereum address format</span>';
            return;
          }

          // Normalize to checksummed address
          const checksummedAddress = ethers.getAddress(tokenAddress);

          if (!provider) {
            infoDiv.innerHTML = '<span style="color: #ff6b6b;">Wallet not connected</span>';
            showStatus('Please connect your wallet first', true);
            return;
          }

          infoDiv.innerHTML = 'Validating token...';

          const tokenContract = new ethers.Contract(checksummedAddress, ERC20_ABI, provider);

          // Fetch token info with individual error handling
          let name, symbol, decimals;

          try {
            name = await tokenContract.name();
          } catch (e) {
            console.warn('Failed to fetch token name:', e);
            name = 'Unknown';
          }

          try {
            symbol = await tokenContract.symbol();
          } catch (e) {
            console.warn('Failed to fetch token symbol:', e);
            symbol = 'UNKNOWN';
          }

          try {
            decimals = await tokenContract.decimals();
          } catch (e) {
            console.warn('Failed to fetch token decimals:', e);
            infoDiv.innerHTML = '<span style="color: #ff6b6b;">Failed to fetch decimals - not a valid ERC20 token</span>';
            return;
          }

          // Validate it's 18 decimals (required for sales)
          const decimalsNum = Number(decimals);
          if (decimalsNum !== 18) {
            infoDiv.innerHTML = `<span style="color: #ff6b6b;">❌ Invalid: Token has ${decimalsNum} decimals (must be 18)</span>`;
            return;
          }

          // Success - show token info
          infoDiv.innerHTML = `
            <div style="padding: 0.5rem; background: rgba(76, 175, 80, 0.1); border-left: 3px solid #4caf50; border-radius: 2px;">
              <div>✓ <strong>${name}</strong> (${symbol})</div>
              <div style="font-size: 0.7rem; opacity: 0.8; margin-top: 0.25rem;">${decimals} decimals - Valid for sale</div>
              <div style="font-size: 0.65rem; opacity: 0.6; margin-top: 0.25rem; font-family: monospace;">${checksummedAddress}</div>
            </div>
          `;

          // Cache the result
          customTokenCache[checksummedAddress.toLowerCase()] = { name, symbol, decimals: decimalsNum };

        } catch (error) {
          console.error('Error validating custom sale token:', error);
          const infoDiv = document.getElementById('customSaleTokenInfo');

          let errorMsg = 'Failed to validate token';
          if (error.message) {
            if (error.message.includes('network') || error.message.includes('connection')) {
              errorMsg = 'Network error - check your connection';
            } else if (error.message.includes('invalid') || error.message.includes('not a contract')) {
              errorMsg = 'Invalid token address - not an ERC20 contract';
            } else {
              errorMsg = `Error: ${error.message.slice(0, 100)}`;
            }
          }

          if (infoDiv) {
            infoDiv.innerHTML = `<span style="color: #ff6b6b;">${errorMsg}</span>`;
          }
        }
      }

      // Initialize token icons in summoning form dropdown
      function initializeSalePaymentTokenIcons() {
        // Initialize display icon
        const displayIcon = document.getElementById('salePaymentTokenIcon');
        if (displayIcon) {
          displayIcon.innerHTML = salePaymentTokenIcons.dai;
        }

        // Initialize dropdown icons
        const dropdownIcons = document.querySelectorAll('.token-dropdown-icon');
        dropdownIcons.forEach(iconEl => {
          const token = iconEl.getAttribute('data-token');
          if (token && salePaymentTokenIcons[token]) {
            iconEl.innerHTML = salePaymentTokenIcons[token];
          } else if (token === 'defaultCoin' && TOKEN_ICONS.defaultCoin) {
            iconEl.innerHTML = TOKEN_ICONS.defaultCoin;
          }
        });
      }

      function toggleSaleConfig() {
        const preset = document.getElementById('initialSalePreset').value;
        const section = document.getElementById('saleConfigSection');
        section.style.display = preset === 'custom' ? 'block' : 'none';

        // Set up event listeners for real-time hints when section is shown
        if (preset === 'custom') {
          setTimeout(() => {
            const priceInput = document.getElementById('salePrice');
            const capInput = document.getElementById('saleCap');
            const tokenInput = document.getElementById('salePaymentToken');
            const typeInput = document.getElementById('saleTokenType');
            const customTokenInput = document.getElementById('customTokenAddress');

            if (priceInput && capInput) {
              // Remove old listeners before adding new ones to prevent memory leaks
              priceInput.removeEventListener('input', updateSummonerSaleHint);
              capInput.removeEventListener('input', updateSummonerSaleHint);
              tokenInput.removeEventListener('change', updateSummonerSaleHint);
              typeInput.removeEventListener('change', updateSummonerSaleHint);
              if (customTokenInput) {
                customTokenInput.removeEventListener('input', updateSummonerSaleHint);
              }

              // Add fresh listeners
              priceInput.addEventListener('input', updateSummonerSaleHint);
              capInput.addEventListener('input', updateSummonerSaleHint);
              tokenInput.addEventListener('change', updateSummonerSaleHint);
              typeInput.addEventListener('change', updateSummonerSaleHint);
              if (customTokenInput) {
                customTokenInput.addEventListener('input', updateSummonerSaleHint);
              }
              updateSummonerSaleHint(); // Initial update
            }
          }, 10);
        }
      }

      // Update summoner form sale hint
      function updateSummonerSaleHint() {
        const priceInput = document.getElementById('salePrice')?.value?.trim();
        const capInput = document.getElementById('saleCap')?.value?.trim();
        const tokenType = document.getElementById('saleTokenType')?.value || 'shares';
        const paymentToken = document.getElementById('salePaymentToken')?.value || 'dai';

        const hint = document.getElementById('summonerSaleHint');
        const hintText = document.getElementById('summonerSaleHintText');

        if (!hint || !hintText) return;

        const price = parseFloat(priceInput);
        const cap = parseFloat(capInput);

        const tokenNames = {
          'dai': 'DAI',
          'custom': 'TOKEN'
        };
        const payToken = tokenNames[paymentToken] || 'TOKEN';
        const tokenTypeText = tokenType === 'loot' ? 'Loot' : 'Share';

        // Show hint even without price - guide the user
        if (!priceInput || isNaN(price) || price <= 0) {
          hintText.innerHTML = `<span style="opacity: 0.6;">Enter price to see sale preview (e.g., "1 ${payToken} for 1 ${tokenTypeText}")</span>`;
          hint.style.display = 'block';

          const upgradePathHint = document.getElementById('upgradePathHint');
          if (upgradePathHint) {
            upgradePathHint.style.display = 'none';
          }
          return;
        }

        // Detect 1:1 upgrade path
        const is1to1 = price === 1;

        // Build the hint text - more natural word order: "1 DAI for 1 Share"
        let text = `<strong>${price} ${payToken}</strong> for <strong>1 ${tokenTypeText}</strong>`;

        if (cap && !isNaN(cap) && cap > 0) {
          text += ` up to <strong>${cap.toLocaleString()} ${tokenTypeText}${cap !== 1 ? 's' : ''}</strong>`;
        } else {
          text += ` <span style="opacity: 0.7;">(unlimited)</span>`;
        }

        // Add 1:1 upgrade path hint
        if (is1to1) {
          text += ` <span style="color: #9d7bff; font-weight: 600; margin-left: 0.5rem;">• 1:1 Upgrade Path</span>`;
        } else {
          // Add cost example
          const exampleAmount = 100;
          const exampleCost = exampleAmount * price;
          text += `<br><span style="opacity: 0.6; font-size: 0.85em;">Example: ${exampleCost.toLocaleString()} ${payToken} buys ${exampleAmount} ${tokenTypeText}s</span>`;
        }

        hintText.innerHTML = text;
        hint.style.display = 'block';

        // Show/hide upgrade path explanation
        const upgradePathHint = document.getElementById('upgradePathHint');
        if (upgradePathHint) {
          upgradePathHint.style.display = is1to1 ? 'block' : 'none';
        }
      }

      // Add loot distribution toggle handler
      document.getElementById('distributeLoot')?.addEventListener('change', (e) => {
        document.getElementById('lootDistribution').style.display = e.target.checked ? 'block' : 'none';
        if (e.target.checked) {
          updateLootInputs();
        }
      });

      // Add equal loot toggle handler
      document.getElementById('equalLoot')?.addEventListener('change', (e) => {
        document.getElementById('customLootAmounts').style.display = e.target.checked ? 'none' : 'block';
        updateLootInputs();
      });

      // Update loot inputs when members change
      function updateLootInputs() {
        if (!document.getElementById('distributeLoot').checked) return;
        if (document.getElementById('equalLoot').checked) return;
        
        const customLootDiv = document.getElementById('customLootAmounts');
        const memberRows = document.querySelectorAll('.member-row');
        
        customLootDiv.innerHTML = '<div style="font-size: 0.8rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.5rem;">Custom loot per member:</div>';
        
        memberRows.forEach((row, index) => {
          const addressInput = row.querySelector('.member-address').value || `Member ${index + 1}`;
          const shortAddr = addressInput.startsWith('0x') ? 
            addressInput.slice(0, 6) + '...' + addressInput.slice(-4) : 
            addressInput;
          
          const lootInput = document.createElement('div');
          lootInput.style.marginBottom = '0.5rem';
          lootInput.innerHTML = `
            <label style="font-size: 0.8rem; color: rgba(230, 217, 255, 0.7);">${shortAddr}</label>
            <input type="number" class="form-input custom-loot-amount" data-member-index="${index}" 
                   placeholder="0" min="0" step="any" style="margin-top: 0.25rem;">
          `;
          customLootDiv.appendChild(lootInput);
        });
      }

      // Helper to calculate seconds from value and unit
      function getSecondsFromInput(valueId, unitId) {
        const value = parseInt(document.getElementById(valueId).value || 0);
        const unit = parseInt(document.getElementById(unitId).value || 1);
        return value * unit;
      }

      document.getElementById('summonForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (!signer) {
          await connectWallet();
          if (!signer) return;
        }

        const summonBtn = document.getElementById('summonBtn');
        summonBtn.disabled = true;
        summonBtn.textContent = 'SUMMONING...';

        try {
          // Check network
          const network = await provider.getNetwork();
          if (network.chainId !== 1n) {
            throw new Error('Please switch to Ethereum Mainnet');
          }

          // Gather form data
          const daoName = document.getElementById('daoName').value;
          const daoSymbol = document.getElementById('daoSymbol').value;
          const daoURI = document.getElementById('daoURI').value || '';
          const quorumBps = Math.floor(parseFloat(document.getElementById('quorumBps').value || 50) * 100);
          const ragequittable = document.getElementById('ragequittable').checked;

          // Collect members
          const memberRows = document.querySelectorAll('.member-row');
          const initHolders = [];
          const initShares = [];

          for (const row of memberRows) {
            const addressInput = row.querySelector('.member-address').value.trim();
            const sharesInput = row.querySelector('.member-shares').value;
            
            if (addressInput && sharesInput) {
              const address = await resolveENS(addressInput);
              if (!ethers.isAddress(address)) {
                throw new Error(`Invalid address: ${addressInput}`);
              }
              
              initHolders.push(address);
              // Convert shares to wei (18 decimals) - ethers v6
              initShares.push(ethers.parseEther(sharesInput));
            }
          }

          if (initHolders.length === 0) {
            throw new Error('At least one member is required');
          }

          // Calculate total initial shares for validation
          let totalShares = 0n;
          for (const shares of initShares) {
            totalShares += shares;
          }

          // Validate proposal threshold if specified
          const proposalThresholdInput = document.getElementById('proposalThreshold').value;
          let proposalThresholdWei = 0n;
          if (proposalThresholdInput && parseFloat(proposalThresholdInput) > 0) {
            proposalThresholdWei = ethers.parseEther(proposalThresholdInput);
            if (proposalThresholdWei > totalShares) {
              throw new Error(`Proposal threshold (${proposalThresholdInput}) cannot exceed total initial shares (${ethers.formatEther(totalShares)})`);
            }
          }

          // Generate random salt ONCE for this entire summon operation
          const salt = ethers.randomBytes(32);
          const saltHex = ethers.hexlify(salt);


          // Connect to summoner
          const summoner = new ethers.Contract(SUMMONER_ADDRESS, SUMMONER_ABI, signer);
          
          // Ensure initShares are BigInt for consistent encoding
          const initSharesForPrediction = initShares.map(s => BigInt(s.toString()));
          
          // Predict all addresses using the Solidity reference implementation
          const predictions = predictMajeurAddresses(
            initHolders,
            initSharesForPrediction,
            salt
          );
          
          const predictedDao = predictions.dao;
          const predictedLoot = predictions.loot;

          // Prepare init calls with predicted DAO address
          const initCalls = [];
          
          // Add proposal TTL setting if specified
          const proposalTTL = getSecondsFromInput('proposalTTL', 'proposalTTLUnit');
          if (proposalTTL > 0) {
            initCalls.push({
              target: predictedDao, // Self-call to the DAO
              value: 0n,
              data: INTERFACES.setProposalTTL.encodeFunctionData('setProposalTTL', [proposalTTL])
            });
          }

          // Add timelock delay setting if specified
          const timelockDelay = getSecondsFromInput('timelockDelay', 'timelockDelayUnit');
          if (timelockDelay > 0) {
            initCalls.push({
              target: predictedDao, // Self-call to the DAO
              value: 0n,
              data: INTERFACES.setTimelockDelay.encodeFunctionData('setTimelockDelay', [timelockDelay])
            });
          }

          // Add loot distribution if enabled
          const distributeLoot = document.getElementById('distributeLoot').checked;
          if (distributeLoot) {
            // Collect loot amounts for each member
            const lootAmounts = [];
            const equalLoot = document.getElementById('equalLoot').checked;
            
            if (equalLoot) {
              // Equal distribution
              const lootPerMember = document.getElementById('lootPerMember').value || '100';
              const lootAmount = ethers.parseEther(lootPerMember);
              for (let i = 0; i < initHolders.length; i++) {
                lootAmounts.push(lootAmount);
              }
            } else {
              // Custom amounts
              const customInputs = document.querySelectorAll('.custom-loot-amount');
              for (let i = 0; i < initHolders.length; i++) {
                const input = customInputs[i];
                const amount = input?.value || '0';
                lootAmounts.push(ethers.parseEther(amount));
              }
            }
            
            // To mint loot during init, we use the predicted loot proxy address
            // The loot implementation is shared by all Moloch clones
            const LOOT_IMPL_ADDRESS = '0x6f1f2aF76a3aDD953277e9F369242697C87bc6A5';
            
            // Create direct loot minting calls
            
            let lootCallsAdded = 0;
            for (let i = 0; i < initHolders.length; i++) {
              if (lootAmounts[i] > 0n) {
                // Add each loot mint directly to initCalls
                initCalls.push({
                  target: predictedLoot,
                  value: 0n,
                  data: INTERFACES.mintFromMoloch.encodeFunctionData('mintFromMoloch', [
                    initHolders[i],
                    lootAmounts[i]
                  ])
                });
                lootCallsAdded++;
              }
            }
            
            if (lootCallsAdded > 0) {
              // Successfully added loot minting calls to init sequence
            }
          }

          // Add proposal threshold setting if specified
          if (proposalThresholdWei > 0n) {
            initCalls.push({
              target: predictedDao, // Self-call to the DAO
              value: 0n,
              data: INTERFACES.setProposalThreshold.encodeFunctionData('setProposalThreshold', [proposalThresholdWei])
            });
          }

          // Add transferability settings if either is enabled
          const enableSharesTransfer = document.getElementById('enableSharesTransfer').checked;
          const enableLootTransfer = document.getElementById('enableLootTransfer').checked;

          if (enableSharesTransfer || enableLootTransfer) {
            // Call setTransfersLocked(bool sharesLocked, bool lootLocked)
            // Note: false = unlocked/transferable, true = locked/non-transferable
            initCalls.push({
              target: predictedDao, // Self-call to the DAO
              value: 0n,
              data: INTERFACES.setTransfersLocked.encodeFunctionData('setTransfersLocked', [
                !enableSharesTransfer, // Invert: checkbox=true means unlocked, so sharesLocked=false
                !enableLootTransfer    // Invert: checkbox=true means unlocked, so lootLocked=false
              ])
            });
          }

          // Add auto-futarchy preset if not "off"
          const futarchyPreset = document.getElementById('autoFutarchyPreset').value;
          if (futarchyPreset !== 'off') {
            let param = 0n;
            let cap = 0n;

            // Configure based on preset
            if (futarchyPreset === 'low') {
              param = 5n;  // 5 bps (0.05%)
              cap = ethers.parseEther('2');  // 2 LOOT
            } else if (futarchyPreset === 'standard') {
              param = 10n;  // 10 bps (0.1%)
              cap = ethers.parseEther('5');  // 5 LOOT
            } else if (futarchyPreset === 'high') {
              param = 50n;  // 50 bps (0.5%)
              cap = ethers.parseEther('10');  // 10 LOOT
            }

            // Add setAutoFutarchy call
            initCalls.push({
              target: predictedDao, // Self-call to the DAO
              value: 0n,
              data: INTERFACES.setAutoFutarchy.encodeFunctionData('setAutoFutarchy', [param, cap])
            });
          }

          // Add initial sale configuration if enabled
          const salePreset = document.getElementById('initialSalePreset').value;
          if (salePreset === 'custom') {
            const paymentToken = document.getElementById('salePaymentToken').value;
            const tokenType = document.getElementById('saleTokenType').value;
            const priceInput = document.getElementById('salePrice').value;
            const capInput = document.getElementById('saleCap').value;
            const minting = document.getElementById('saleMinting').checked;

            if (priceInput && parseFloat(priceInput) > 0) {
              let payToken;

              // Check if custom token is selected
              if (paymentToken === 'custom') {
                const customTokenAddress = document.getElementById('customTokenAddress').value.trim();
                if (!customTokenAddress || !ethers.isAddress(customTokenAddress)) {
                  showStatus('Please enter a valid custom token address', true);
                  throw new Error('Invalid custom token address');
                }
                payToken = customTokenAddress;
              } else {
                // Map token selection to addresses (18-decimal only)
                const tokenAddresses = {
                  'dai': TOKEN_ADDRESSES.dai
                };
                payToken = tokenAddresses[paymentToken];
              }

              // Price is in "token-wei per share-wei" (simple integer ratio)
              // For 1:1 with 18-decimal tokens: user enters "1", price = 1 (not 1e18!)
              // This is because contract does: cost = shareAmount * price (no scaling)
              const pricePerShare = BigInt(Math.round(parseFloat(priceInput)));
              if (pricePerShare === 0n) {
                showStatus('Sale price must be at least 1 (fractional prices < 1 not supported)', true);
                throw new Error('Invalid sale price');
              }

              const cap = capInput && parseFloat(capInput) > 0 ? ethers.parseEther(capInput) : 0n;
              const isLoot = tokenType === 'loot';

              // Add setSale call
              initCalls.push({
                target: predictedDao, // Self-call to the DAO
                value: 0n,
                data: INTERFACES.setSale.encodeFunctionData('setSale', [
                  payToken, pricePerShare, cap, minting, true, isLoot
                ])
              });
            }
          }

          showStatus('Preparing transaction...');

          // Get initial ETH deposit if specified
          const initialEthDepositInput = document.getElementById('initialEthDeposit').value;
          const initialEthDeposit = initialEthDepositInput && parseFloat(initialEthDepositInput) > 0
            ? ethers.parseEther(initialEthDepositInput)
            : 0n;

          // Call summon
          showStatus('Please confirm the transaction in your wallet...');

          const tx = await summoner.summon(
            daoName,
            daoSymbol,
            daoURI,
            quorumBps,
            ragequittable,
            '0x000000000011C799980827F52d3137b4abD6E654', // default renderer
            salt,
            initHolders,
            initShares,
            initCalls, 
            { value: initialEthDeposit }
          );

          showStatus(`Transaction submitted. <a href="https://etherscan.io/tx/${tx.hash}" target="_blank" rel="noopener" style="color: #9d7bff; text-decoration: underline;">View on Etherscan</a>`);

          const receipt = await tx.wait();

          // Find DAO address from events - ethers v6 syntax
          const event = receipt.logs
            .map(log => {
              try {
                return summoner.interface.parseLog(log);
              } catch {
                return null;
              }
            })
            .find(e => e && e.name === 'NewDAO');

          const daoAddress = event?.args?.dao;

          showStatus(`✨ DAO summoned successfully at: <a href="https://etherscan.io/address/${daoAddress}" target="_blank" rel="noopener" style="color: #9d7bff; text-decoration: underline;">${daoAddress}</a> | <a href="https://etherscan.io/tx/${tx.hash}" target="_blank" rel="noopener" style="color: #9d7bff; text-decoration: underline;">View transaction</a>`);

          // Refresh DAO lists to include newly summoned DAO
          if (connectedAddress) {
            await fetchUserDAOs();
            await fetchAllDAOs();
          }

          // Reset form
          document.getElementById('summonForm').reset();
          document.getElementById('foundingMembersList').innerHTML = '';
          const memberRow = createMemberRow(await signer.getAddress(), '1', true);
          document.getElementById('foundingMembersList').appendChild(memberRow);
          
          // Reset time units to defaults
          document.getElementById('proposalTTLUnit').value = '86400';
          document.getElementById('timelockDelayUnit').value = '86400';

          // Reset auto-futarchy preset to default
          document.getElementById('autoFutarchyPreset').value = 'off';

          // Reset and update loot inputs
          document.getElementById('distributeLoot').checked = false;
          document.getElementById('lootDistribution').style.display = 'none';
          updateLootInputs();

        } catch (error) {
          console.error(error);

          if (isUserRejection(error)) {
            showStatus('Summoning cancelled', false);
          } else {
            // Handle common wallet errors with user-friendly messages
            let errorMessage = 'Summoning failed';

            if (error.code === 'UNKNOWN_ERROR' && error.message?.includes('eth_blockNumber')) {
              errorMessage = 'Network connection issue. Please check your wallet is connected to the correct network and try again.';
            } else if (error.code === 'NETWORK_ERROR' || error.message?.includes('network')) {
              errorMessage = 'Network error. Please check your connection and try again.';
            } else if (error.code === -32000 || error.message?.includes('insufficient funds')) {
              errorMessage = 'Insufficient funds for transaction';
            } else if (error.message?.includes('nonce')) {
              errorMessage = 'Transaction nonce issue - please reset your wallet';
            } else if (error.shortMessage) {
              errorMessage = error.shortMessage;
            } else if (error.reason) {
              errorMessage = error.reason;
            } else if (error.message) {
              const msg = error.message.split('\n')[0];
              if (msg.length < 100) {
                errorMessage = msg;
              }
            }

            showStatus(errorMessage, true);
          }
        } finally {
          summonBtn.disabled = false;
          summonBtn.textContent = 'SUMMON DAO';
        }
      });

      // Auto-connect on load if already authorized
      window.addEventListener('load', async () => {
        // Initialize DOM cache for performance
        DOMCache.init();

        // Initialize EIP-6963 support for modern wallet detection
        initEIP6963();

        // Small delay to allow EIP-6963 providers to announce themselves
        await new Promise(resolve => setTimeout(resolve, 100));

        // Auto-reconnect logic with improved wallet preference handling
        if (window.ethereum) {
          try {
            const accounts = await window.ethereum.request({ method: 'eth_accounts' });
            if (accounts.length > 0) {
              // Try to reconnect with the user's preferred wallet
              const preferredWallet = getWalletPreference();
              const wallets = detectWallets();

              if (preferredWallet && wallets.some(w => w.key === preferredWallet)) {
                // Reconnect with preferred wallet
                await connectWithWallet(preferredWallet);
              } else if (wallets.length > 0) {
                // Fallback: connect with first detected wallet
                await connectWithWallet(wallets[0].key);
              }
            }
          } catch (error) {
            console.error('Auto-reconnect failed:', error);
            // Silently fail auto-reconnect, user can manually connect
          }
        }
      });

    </script>
  </body>
</html>
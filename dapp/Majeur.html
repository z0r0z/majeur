<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Majeur ༼ つ ◕_◕ ༽つ</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' fill='%230a0015'/%3E%3Cpath d='M16 4 L22 12 L30 12 L24 18 L26 26 L16 22 L6 26 L8 18 L2 12 L10 12 Z' fill='none' stroke='%239d7bff' stroke-width='1.5' stroke-linejoin='round'/%3E%3Ccircle cx='16' cy='16' r='2' fill='%239d7bff'/%3E%3C/svg%3E" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta name="theme-color" content="#0a0015" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.15.0/ethers.umd.min.js" integrity="sha512-UXYETj+vXKSURF1UlgVRLzWRS9ZiQTv3lcL4rbeLyqTXCPNZC6PTLF/Ik3uxm2Zo+E109cUpJPZfLxJsCgKSng==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;1,400;1,500&family=Cinzel:wght@400;500;600&display=swap");

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html,
      body {
        width: 100%;
        height: 100%;
        scroll-behavior: smooth;
      }

      body {
        background: #000;
        color: #e6d9ff;
        font-family: "EB Garamond", serif;
        overflow-x: hidden;
        overflow-y: auto;
      }

      /* STARRY BACKGROUND PATTERN */
      .starry-bg {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 0;
        background: radial-gradient(circle at center, #0a0015 0%, #000000 60%);
      }

      .stars-layer {
        position: absolute;
        width: 100%;
        height: 100%;
        background-image: 
          radial-gradient(2px 2px at 20px 30px, white, transparent),
          radial-gradient(2px 2px at 40px 70px, white, transparent),
          radial-gradient(1px 1px at 50px 50px, white, transparent),
          radial-gradient(1px 1px at 80px 10px, white, transparent),
          radial-gradient(2px 2px at 130px 80px, white, transparent),
          radial-gradient(1px 1px at 110px 40px, white, transparent),
          radial-gradient(1px 1px at 140px 60px, #9d7bff, transparent);
        background-size: 200px 200px;
        background-repeat: repeat;
        opacity: 0.3;
        animation: twinkle 10s infinite;
      }

      @keyframes twinkle {
        0%, 100% { opacity: 0.3; }
        50% { opacity: 0.5; }
      }

      /* SUMMON LINK */
      .summon-link {
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 1000;
        padding: 10px 18px;
        background: transparent;
        border: 1px solid rgba(157, 123, 255, 0.3);
        color: rgba(230, 217, 255, 0.7);
        font-family: "EB Garamond", serif;
        font-style: italic;
        font-size: 0.9rem;
        letter-spacing: 0.15em;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
      }

      .summon-link:hover {
        border-color: rgba(157, 123, 255, 0.5);
        color: #e6d9ff;
        background: rgba(157, 123, 255, 0.05);
      }

      /* WALLET CONNECTION */
      .wallet-button {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        padding: 10px 18px;
        background: rgba(10, 0, 21, 0.9);
        border: 1px solid #9d7bff;
        color: #e6d9ff;
        font-family: "Cinzel", serif;
        font-size: 0.75rem;
        letter-spacing: 0.1em;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .wallet-button:hover {
        background: rgba(157, 123, 255, 0.2);
        box-shadow: 0 0 20px rgba(157, 123, 255, 0.4);
      }

      .wallet-button.connected {
        color: #9d7bff;
      }

      /* SUMMONER SECTION */
      .summoner-section {
        min-height: 100vh;
        padding: 4rem 2rem;
        position: relative;
        z-index: 1;
        background: transparent;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }

      .summoner-container {
        max-width: 600px;
        width: 100%;
        padding: 3rem;
        background: rgba(10, 0, 21, 0.6);
        border: 1px solid rgba(157, 123, 255, 0.3);
        backdrop-filter: blur(10px);
      }

      .summoner-title {
        font-family: "Cinzel", serif;
        font-size: 1.8rem;
        text-align: center;
        letter-spacing: 0.3em;
        margin-bottom: 0.5rem;
        color: #e6d9ff;
        text-transform: uppercase;
      }

      .summoner-subtitle {
        font-family: "EB Garamond", serif;
        font-size: 1rem;
        text-align: center;
        margin-bottom: 2rem;
        color: rgba(230, 217, 255, 0.7);
        font-style: italic;
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      .form-label {
        display: block;
        font-family: "Cinzel", serif;
        font-size: 0.7rem;
        letter-spacing: 0.15em;
        text-transform: uppercase;
        color: rgba(230, 217, 255, 0.8);
        margin-bottom: 0.5rem;
      }

      .form-input {
        width: 100%;
        padding: 10px 14px;
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid rgba(157, 123, 255, 0.3);
        color: #e6d9ff;
        font-family: "EB Garamond", serif;
        font-size: 1rem;
        transition: all 0.3s ease;
      }

      .form-input:focus {
        outline: none;
        border-color: #9d7bff;
        box-shadow: 0 0 10px rgba(157, 123, 255, 0.2);
      }

      .form-input::placeholder {
        color: rgba(230, 217, 255, 0.4);
      }

      .members-container {
        border: 1px solid rgba(157, 123, 255, 0.2);
        padding: 1rem;
        margin-top: 1rem;
      }

      .member-row {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
        align-items: center;
      }

      .member-address {
        flex: 2;
      }

      .member-shares {
        flex: 1;
      }

      .remove-member {
        width: 30px;
        height: 30px;
        background: rgba(255, 0, 0, 0.2);
        border: 1px solid rgba(255, 0, 0, 0.4);
        color: #ff6b6b;
        cursor: pointer;
        font-size: 1.2rem;
        line-height: 1;
        transition: all 0.3s ease;
      }

      .remove-member:hover {
        background: rgba(255, 0, 0, 0.3);
      }

      .add-member-btn {
        width: 100%;
        padding: 8px;
        background: rgba(157, 123, 255, 0.1);
        border: 1px solid rgba(157, 123, 255, 0.3);
        color: #9d7bff;
        font-family: "Cinzel", serif;
        font-size: 0.7rem;
        letter-spacing: 0.1em;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
      }

      .add-member-btn:hover {
        background: rgba(157, 123, 255, 0.2);
      }

      .summon-button {
        width: 100%;
        padding: 14px;
        margin-top: 2rem;
        background: linear-gradient(135deg, #9d7bff 0%, #6b4fb8 100%);
        border: none;
        color: #000;
        font-family: "Cinzel", serif;
        font-size: 1rem;
        letter-spacing: 0.3em;
        text-transform: uppercase;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
      }

      .summon-button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(157, 123, 255, 0.4);
      }

      .summon-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .advanced-toggle {
        text-align: center;
        margin: 1.5rem 0;
        cursor: pointer;
        color: #9d7bff;
        font-size: 0.9rem;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        font-family: "Cinzel", serif;
      }

      .advanced-settings {
        display: none;
        border-top: 1px solid rgba(157, 123, 255, 0.2);
        padding-top: 1.5rem;
        margin-top: 1.5rem;
      }

      .advanced-settings.show {
        display: block;
      }

      .checkbox-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .checkbox-group input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: #9d7bff;
      }

      .status-message {
        padding: 1rem;
        margin-top: 1rem;
        border: 1px solid rgba(157, 123, 255, 0.3);
        background: rgba(157, 123, 255, 0.1);
        text-align: center;
        font-style: italic;
      }

      .error-message {
        border-color: rgba(255, 0, 0, 0.3);
        background: rgba(255, 0, 0, 0.1);
        color: #ff6b6b;
      }

      /* HERO / LANDER */

      .hero {
        width: 100vw;
        height: 100vh;
        position: relative;
      }

      .page {
        width: 100vw;
        height: 100vh;
        position: relative;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .hero svg {
        width: 100%;
        height: 100%;
        display: block;
      }

      .scroll-indicator {
        position: absolute;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        cursor: pointer;
        z-index: 100;
      }

      .scroll-indicator svg {
        width: 40px;
        height: 60px;
        display: block;
      }

      /* Thread Connectors */
      .thread-section {
        position: relative;
        width: 100%;
        margin: 0;
        pointer-events: none;
        z-index: 1;
      }

      .thread-hero-to-intro {
        margin-top: -100px;
        margin-bottom: -100px;
      }

      .thread-intro-to-features {
        margin-top: -50px;
        margin-bottom: -50px;
      }

      .thread-between-features {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        width: 2px;
        height: 100px;
        background: linear-gradient(180deg, 
          rgba(157, 123, 255, 0.2) 0%, 
          rgba(157, 123, 255, 0.5) 50%, 
          rgba(157, 123, 255, 0.2) 100%);
      }

      /* Radial Line Continuations */
      .radial-continuation {
        position: absolute;
        top: -100px;
        left: 0;
        width: 100%;
        height: 200px;
        pointer-events: none;
        overflow: hidden;
        z-index: 0;
      }

      .radial-lines-top {
        position: absolute;
        width: 100%;
        height: 100%;
        opacity: 0.8;
      }

      .radial-lines-bottom {
        position: absolute;
        bottom: -100px;
        left: 0;
        width: 100%;
        height: 200px;
        pointer-events: none;
        z-index: 0;
      }

      .radial-lines-bottom svg {
        width: 100%;
        height: 100%;
        opacity: 0.6;
      }

      /* Intro Panel */
      .thread-connector {
        position: absolute;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 100px;
        height: 100%;
        pointer-events: none;
        z-index: 0;
        opacity: 0.8;
      }

      .thread-container {
        position: fixed;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 100px;
        height: 100vh;
        pointer-events: none;
        z-index: 0;
        overflow: visible;
      }

      .thread-svg {
        width: 100%;
        height: 300vh;
        position: absolute;
        top: 0;
        left: 0;
      }

      .main-thread {
        stroke-dasharray: 10, 5;
        animation: flowThread 10s linear infinite;
      }

      @keyframes flowThread {
        from {
          stroke-dashoffset: 0;
        }
        to {
          stroke-dashoffset: -15;
        }
      }

      .converging-nodes {
        animation: convergeNodes 8s ease-in-out infinite;
      }

      @keyframes convergeNodes {
        0%, 100% {
          transform: scale(1);
        }
        50% {
          transform: scale(0.95) translateX(10px) translateY(10px);
        }
      }

      .fade-line {
        animation: fadeIn 3s ease-in-out infinite alternate;
      }

      @keyframes fadeIn {
        from {
          opacity: 0.1;
        }
        to {
          opacity: 0.5;
        }
      }

      .intro-panel {
        min-height: 100vh;
        padding: 4rem 2rem;
        position: relative;
        z-index: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        background: transparent;
      }

      .intro-content {
        max-width: 1200px;
        width: 100%;
        display: grid;
        grid-template-columns: 1fr 1.5fr;
        gap: 4rem;
        align-items: center;
      }

      .intro-art svg {
        width: 100%;
        height: auto;
        max-width: 400px;
        margin: 0 auto;
        display: block;
      }

      .converging-nodes {
        animation: subtleConverge 6s ease-in-out infinite;
        transform-origin: 200px 200px;
      }

      @keyframes subtleConverge {
        0%, 100% { 
          transform: scale(1);
        }
        50% { 
          transform: scale(0.92);
        }
      }

      .pulse-core {
        animation: pulsate 2s ease-in-out infinite;
      }

      @keyframes pulsate {
        0%, 100% { 
          r: 15;
          opacity: 1;
        }
        50% { 
          r: 20;
          opacity: 0.8;
        }
      }

      .intro-text h2 {
        font-size: 2.5rem;
        color: #e6d9ff;
        margin-bottom: 1.5rem;
        font-weight: 400;
        letter-spacing: -0.02em;
      }

      .intro-text p {
        font-size: 1.2rem;
        line-height: 1.8;
        color: rgba(230, 217, 255, 0.8);
        margin-bottom: 1.5rem;
      }

      .intro-highlight {
        color: #9d7bff !important;
        font-weight: 500;
        font-size: 1.3rem !important;
        margin-top: 2rem !important;
      }

      .scroll-hint {
        grid-column: 1 / -1;
        text-align: center;
        margin-top: 3rem;
        opacity: 0.4;
        transition: opacity 0.3s ease;
        cursor: pointer;
      }

      .scroll-hint:hover {
        opacity: 0.7;
      }

      .scroll-hint span {
        display: block;
        margin-bottom: 0.5rem;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.15em;
        color: rgba(230, 217, 255, 0.5);
      }

      .scroll-hint svg {
        color: rgba(157, 123, 255, 0.6);
        animation: subtlePulse 3s ease-in-out infinite;
      }

      @keyframes subtlePulse {
        0%, 100% { 
          transform: translateY(0);
          opacity: 0.6;
        }
        50% { 
          transform: translateY(3px);
          opacity: 0.4;
        }
      }

      @media (max-width: 768px) {
        .intro-content {
          grid-template-columns: 1fr;
          gap: 2rem;
          text-align: center;
        }

        .intro-art {
          order: -1;
        }

        .intro-text h2 {
          font-size: 2rem;
        }

        .intro-text p {
          font-size: 1.1rem;
        }
      }

      /* Feature pages */

      .features {
        position: relative;
        z-index: 1;
        background: transparent;
      }

      .feature-page {
        min-height: 100vh;
        display: flex;
        align-items: center;
        padding: 4rem 8vw;
        border-top: 1px solid rgba(157, 123, 255, 0.18);
      }

      .feature-inner {
        display: flex;
        gap: 4rem;
        width: 100%;
        align-items: center;
        justify-content: space-between;
      }

      .feature-left {
        flex: 1.1;
        max-width: 540px;
      }

      .feature-right {
        flex: 1;
        display: flex;
        justify-content: center;
      }

      .feature-tag {
        font-family: "Cinzel", serif;
        font-size: 0.7rem;
        letter-spacing: 0.24em;
        text-transform: uppercase;
        color: rgba(230, 217, 255, 0.55);
        margin-bottom: 0.75rem;
      }

      .feature-title {
        position: relative;
        font-family: "EB Garamond", serif;
        font-style: italic;
        font-weight: 400;
        text-transform: uppercase;
        letter-spacing: 0.35em;
        font-size: clamp(2.2rem, 4vw, 3.3rem);
        color: #e6d9ff;
        margin-bottom: 1.5rem;
      }

      .feature-title::before {
        content: attr(data-word);
        position: absolute;
        inset: 0;
        color: #000000;
        transform: translate(3px, 4px);
        filter: blur(8px);
        opacity: 0.9;
        z-index: -1;
      }

      .feature-copy {
        font-size: 1.02rem;
        line-height: 1.6;
        max-width: 36rem;
        color: rgba(230, 217, 255, 0.9);
      }

      .feature-meta {
        margin-top: 1.25rem;
        font-size: 0.8rem;
        letter-spacing: 0.18em;
        text-transform: uppercase;
        color: rgba(230, 217, 255, 0.5);
      }

      .feature-art {
        width: min(360px, 70vw);
        height: auto;
      }

      .feature-art circle,
      .feature-art path,
      .feature-art line,
      .feature-art polyline,
      .feature-art polygon {
        vector-effect: non-scaling-stroke;
      }

      @media (max-width: 900px) {
        .feature-page {
          padding: 3rem 1.75rem;
        }

        .feature-inner {
          flex-direction: column;
          align-items: flex-start;
        }

        .feature-right {
          width: 100%;
          justify-content: flex-start;
          margin-top: 2.5rem;
        }

        .feature-art {
          width: min(320px, 90vw);
        }
      }

      /* Mobile optimization for hero text */
      @media (max-width: 768px) {
        .hero-moloch-text {
          font-size: 48px;
          letter-spacing: 12px;
        }

        .hero-majeur-text {
          font-size: 56px;
          letter-spacing: 10px;
        }

        .hero-subtitle-text {
          font-size: 16px;
          letter-spacing: 2px;
        }
      }

      @media (max-width: 600px) {
        .hero-moloch-text {
          font-size: 38px;
          letter-spacing: 8px;
        }

        .hero-majeur-text {
          font-size: 44px;
          letter-spacing: 6px;
        }

        .hero-subtitle-text {
          font-size: 14px;
          letter-spacing: 1.5px;
        }

        .feature-title {
          letter-spacing: 0.22em;
          font-size: 2rem;
        }

        .scroll-indicator {
          bottom: 20px;
        }

        .wallet-button {
          font-size: 0.65rem;
          padding: 8px 14px;
        }
      }

      @media (max-width: 400px) {
        .hero-moloch-text {
          font-size: 32px;
          letter-spacing: 6px;
        }

        .hero-majeur-text {
          font-size: 38px;
          letter-spacing: 4px;
        }

        .hero-subtitle-text {
          font-size: 12px;
          letter-spacing: 1px;
        }
      }

      /* WALLET MODAL */
      .wallet-modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(8px);
        z-index: 2000;
        align-items: center;
        justify-content: center;
      }

      .wallet-modal-overlay.show {
        display: flex;
      }

      .wallet-modal {
        background: rgba(10, 0, 21, 0.95);
        border: 1px solid rgba(157, 123, 255, 0.5);
        max-width: 420px;
        width: 90%;
        padding: 2rem;
        position: relative;
        box-shadow: 0 0 40px rgba(157, 123, 255, 0.3);
      }

      .wallet-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      }

      .wallet-modal-title {
        font-family: "Cinzel", serif;
        font-size: 1.2rem;
        letter-spacing: 0.2em;
        color: #e6d9ff;
        text-transform: uppercase;
      }

      .wallet-modal-close {
        background: transparent;
        border: none;
        color: rgba(230, 217, 255, 0.6);
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
      }

      .wallet-modal-close:hover {
        color: #e6d9ff;
        transform: rotate(90deg);
      }

      .wallet-option {
        display: flex;
        align-items: center;
        padding: 1rem;
        margin-bottom: 0.75rem;
        background: rgba(0, 0, 0, 0.4);
        border: 1px solid rgba(157, 123, 255, 0.3);
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .wallet-option:hover {
        background: rgba(157, 123, 255, 0.15);
        border-color: #9d7bff;
        box-shadow: 0 0 15px rgba(157, 123, 255, 0.2);
      }

      .wallet-option:last-child {
        margin-bottom: 0;
      }

      .wallet-icon {
        width: 40px;
        height: 40px;
        margin-right: 1rem;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        flex-shrink: 0;
      }

      .wallet-info {
        flex: 1;
      }

      .wallet-name {
        font-family: "Cinzel", serif;
        font-size: 0.9rem;
        letter-spacing: 0.1em;
        color: #e6d9ff;
        margin-bottom: 0.25rem;
      }

      .wallet-status {
        font-family: "EB Garamond", serif;
        font-size: 0.85rem;
        color: rgba(230, 217, 255, 0.6);
        font-style: italic;
      }

      .wallet-status.installed {
        color: #9d7bff;
      }

      /* DAO GALLERY */
      .dao-gallery-section {
        min-height: 100vh;
        padding: 4rem 2rem;
        position: relative;
        z-index: 1;
        background: transparent;
        display: none;
      }

      .dao-gallery-section.show {
        display: block;
      }

      .dao-gallery-header {
        text-align: center;
        margin-bottom: 3rem;
      }

      .dao-gallery-title {
        font-family: "Cinzel", serif;
        font-size: 2rem;
        letter-spacing: 0.3em;
        color: #e6d9ff;
        text-transform: uppercase;
        margin-bottom: 0.5rem;
      }

      .dao-gallery-subtitle {
        font-family: "EB Garamond", serif;
        font-size: 1.1rem;
        color: rgba(230, 217, 255, 0.7);
        font-style: italic;
      }

      .dao-tiles {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 2rem;
        max-width: 1400px;
        margin: 0 auto;
      }

      .dao-tile {
        background: rgba(10, 0, 21, 0.6);
        border: 1px solid rgba(157, 123, 255, 0.3);
        padding: 2rem;
        cursor: pointer;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
      }

      .dao-tile:hover {
        border-color: #9d7bff;
        box-shadow: 0 0 30px rgba(157, 123, 255, 0.3);
        transform: translateY(-5px);
      }

      .dao-tile-emblem {
        position: absolute;
        top: 1rem;
        right: 1rem;
        width: 32px;
        height: 32px;
        border: 1px solid rgba(157, 123, 255, 0.2);
        border-radius: 4px;
        overflow: hidden;
        background: rgba(10, 0, 21, 0.8);
        opacity: 0.6;
        transition: all 0.3s ease;
      }

      /* For all DAOs view, position emblem below member badge */
      .all-dao-tile .dao-tile-emblem {
        top: 3.5rem;
        right: 1rem;
      }

      .dao-tile:hover .dao-tile-emblem {
        opacity: 1;
        border-color: rgba(157, 123, 255, 0.4);
      }

      .dao-tile-emblem img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .dao-tile-name {
        font-family: "Cinzel", serif;
        font-size: 1.4rem;
        color: #e6d9ff;
        margin-bottom: 0.5rem;
        letter-spacing: 0.1em;
      }

      .dao-tile-symbol {
        font-family: "EB Garamond", serif;
        font-size: 0.9rem;
        color: rgba(230, 217, 255, 0.6);
        margin-bottom: 1rem;
        font-style: italic;
      }

      .dao-tile-stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 1px solid rgba(157, 123, 255, 0.2);
      }

      .dao-stat {
        font-family: "EB Garamond", serif;
        font-size: 0.85rem;
      }

      .dao-stat-label {
        color: rgba(230, 217, 255, 0.5);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        font-size: 0.7rem;
        margin-bottom: 0.25rem;
      }

      .dao-stat-value {
        color: #9d7bff;
        font-size: 1.1rem;
      }

      /* ALL DAOS GALLERY */
      .all-daos-section {
        min-height: 100vh;
        padding: 4rem 2rem;
        position: relative;
        z-index: 1;
        background: transparent;
        display: none;
        border-top: 1px solid rgba(157, 123, 255, 0.15);
      }

      .all-daos-section.show {
        display: block;
      }

      .all-daos-header {
        text-align: center;
        margin-bottom: 3rem;
      }

      .all-daos-title {
        font-family: "Cinzel", serif;
        font-size: 1.8rem;
        letter-spacing: 0.3em;
        color: rgba(230, 217, 255, 0.8);
        text-transform: uppercase;
        margin-bottom: 0.5rem;
      }

      .all-daos-subtitle {
        font-family: "EB Garamond", serif;
        font-size: 1rem;
        color: rgba(230, 217, 255, 0.5);
        font-style: italic;
      }

      .all-dao-tile {
        background: rgba(10, 0, 21, 0.4);
        border: 1px solid rgba(157, 123, 255, 0.2);
        padding: 2rem;
        cursor: pointer;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
        opacity: 0.9;
      }

      .all-dao-tile:hover {
        border-color: rgba(157, 123, 255, 0.5);
        box-shadow: 0 0 20px rgba(157, 123, 255, 0.2);
        transform: translateY(-3px);
        opacity: 1;
      }

      .all-dao-tile.user-member {
        background: rgba(157, 123, 255, 0.1);
        border: 1px solid rgba(157, 123, 255, 0.4);
        opacity: 1;
      }

      .all-dao-tile.user-member::before {
        content: "★ MEMBER";
        position: absolute;
        top: 1rem;
        right: 1rem;
        font-family: "Cinzel", serif;
        font-size: 0.65rem;
        letter-spacing: 0.1em;
        color: #9d7bff;
        padding: 0.25rem 0.5rem;
        border: 1px solid rgba(157, 123, 255, 0.4);
        background: rgba(157, 123, 255, 0.1);
      }

      .dao-tile-name,
      .all-dao-tile .dao-tile-name {
        font-family: "Cinzel", serif;
        font-size: 1.4rem;
        color: #e6d9ff;
        margin-bottom: 0.5rem;
        letter-spacing: 0.1em;
      }

      /* DAO DASHBOARD */
      .dao-dashboard {
        min-height: 100vh;
        padding: 4rem 2rem;
        position: relative;
        z-index: 1;
        background: transparent;
        display: none;
      }

      .dao-dashboard.show {
        display: block;
      }

      .dao-dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 3rem;
        flex-wrap: wrap;
        gap: 1rem;
      }

      .dao-dashboard-title {
        font-family: "Cinzel", serif;
        font-size: 1.8rem;
        letter-spacing: 0.2em;
        color: #e6d9ff;
        text-transform: uppercase;
        margin-bottom: 0.5rem;
      }

      .dao-etherscan-link {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        font-family: "Courier New", monospace;
        font-size: 0.85rem;
        color: rgba(157, 123, 255, 0.7);
        text-decoration: none;
        transition: all 0.3s ease;
        padding: 0.25rem 0;
      }

      .dao-etherscan-link:hover {
        color: #9d7bff;
      }

      .dao-etherscan-link svg {
        opacity: 0.7;
        transition: opacity 0.3s ease;
      }

      .dao-etherscan-link:hover svg {
        opacity: 1;
      }

      .dao-stats-bar {
        display: flex;
        gap: 1.5rem;
        margin-top: 0.75rem;
        padding: 0.75rem 0;
        border-top: 1px solid rgba(157, 123, 255, 0.15);
      }

      .dao-stat-item {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      .dao-stat-label {
        font-family: 'Cinzel', serif;
        font-size: 0.65rem;
        color: rgba(230, 217, 255, 0.5);
        text-transform: uppercase;
        letter-spacing: 0.1em;
      }

      .dao-stat-value {
        font-family: 'EB Garamond', serif;
        font-size: 1rem;
        color: #9d7bff;
        font-weight: 500;
      }

      .back-button {
        padding: 10px 20px;
        background: rgba(10, 0, 21, 0.9);
        border: 1px solid rgba(157, 123, 255, 0.3);
        color: #e6d9ff;
        font-family: "Cinzel", serif;
        font-size: 0.75rem;
        letter-spacing: 0.1em;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
      }

      .back-button:hover {
        background: rgba(157, 123, 255, 0.2);
        border-color: #9d7bff;
      }

      .dao-view-toggle {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        border-bottom: 1px solid rgba(157, 123, 255, 0.2);
      }

      .view-toggle-btn {
        padding: 0.75rem 1.5rem;
        background: transparent;
        border: none;
        border-bottom: 2px solid transparent;
        color: rgba(230, 217, 255, 0.6);
        font-family: "Cinzel", serif;
        font-size: 0.85rem;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .view-toggle-btn:hover {
        color: rgba(230, 217, 255, 0.9);
      }

      .view-toggle-btn.active {
        color: #9d7bff;
        border-bottom-color: #9d7bff;
      }

      .dao-dashboard-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        max-width: 1600px;
        margin: 0 auto;
      }

      .dao-dashboard-content.show {
        display: grid;
      }

      .dao-dashboard-content.hide {
        display: none;
      }

      .dao-membership-content {
        display: none;
        max-width: 1200px;
        margin: 0 auto;
      }

      .dao-membership-content.show {
        display: block;
      }

      @media (max-width: 1024px) {
        .dao-dashboard-content {
          grid-template-columns: 1fr;
        }
      }

      /* MEMBERSHIP DASHBOARD */
      .membership-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
      }

      @media (max-width: 768px) {
        .membership-grid {
          grid-template-columns: 1fr;
          gap: 1.5rem;
        }

        .badge-card,
        .balance-card {
          padding: 1.5rem 1rem;
        }

        .badge-image {
          max-width: 200px;
        }

        .badge-card a,
        .badge-card button {
          font-size: 0.8rem;
          padding: 0.4rem 0.75rem !important;
        }

        .balance-value {
          font-size: 1.5rem;
        }

        .balance-label {
          font-size: 0.7rem;
          display: flex;
          align-items: center;
          flex-wrap: wrap;
        }

        .balance-item {
          margin-bottom: 1.25rem;
          padding-bottom: 1.25rem;
        }

        .receipts-panel {
          padding: 1.5rem 1rem;
        }

        .receipts-grid {
          grid-template-columns: 1fr;
          gap: 1rem;
        }

        .receipt-card {
          padding: 1rem;
        }

        .receipt-image {
          height: 120px;
        }

        .dao-panel-title {
          font-size: 0.9rem;
          letter-spacing: 0.1em;
        }
      }

      @media (max-width: 480px) {
        .membership-grid {
          gap: 1rem;
        }

        .badge-card,
        .balance-card,
        .receipts-panel {
          padding: 1rem 0.75rem;
        }

        .balance-value {
          font-size: 1.25rem;
        }

        .balance-label {
          font-size: 0.65rem;
        }

        .balance-item {
          margin-bottom: 1rem;
          padding-bottom: 1rem;
        }

        .badge-image {
          max-width: 150px;
        }

        .badge-card a,
        .badge-card button {
          font-size: 0.7rem;
          padding: 0.35rem 0.6rem !important;
        }

        .dao-panel-title {
          font-size: 0.8rem;
        }

        .receipt-card {
          padding: 0.75rem;
        }

        .receipt-image {
          height: 100px;
        }

        .receipt-name {
          font-size: 0.75rem;
        }

        .receipt-proposal {
          font-size: 0.65rem;
        }

        .receipt-vote {
          font-size: 0.8rem;
        }

        .receipt-amount {
          font-size: 0.95rem;
        }

        .view-toggle-btn {
          padding: 0.5rem 0.65rem;
          font-size: 0.65rem;
          flex: 1;
        }

        .dao-view-toggle {
          gap: 0.25rem;
        }

        .dao-tile-emblem {
          width: 24px;
          height: 24px;
          top: 0.75rem;
          right: 0.75rem;
        }

        .all-dao-tile .dao-tile-emblem {
          top: 3rem;
          right: 0.75rem;
        }
      }

      @media (max-width: 360px) {
        .view-toggle-btn {
          padding: 0.4rem 0.5rem;
          font-size: 0.6rem;
        }

        .dao-view-toggle {
          gap: 0.15rem;
        }
      }

      .badge-card {
        background: rgba(10, 0, 21, 0.6);
        border: 1px solid rgba(157, 123, 255, 0.3);
        padding: 2rem;
        backdrop-filter: blur(10px);
        text-align: center;
      }

      .badge-image {
        width: 100%;
        max-width: 300px;
        height: auto;
        margin: 1rem auto;
        border: 1px solid rgba(157, 123, 255, 0.3);
        border-radius: 8px;
        transition: all 0.3s ease;
      }

      .badge-card .badge-image:hover {
        transform: scale(1.02);
        border-color: #9d7bff;
      }

      .balance-card {
        background: rgba(10, 0, 21, 0.6);
        border: 1px solid rgba(157, 123, 255, 0.3);
        padding: 2rem;
        backdrop-filter: blur(10px);
      }

      .balance-item {
        margin-bottom: 1.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid rgba(157, 123, 255, 0.15);
      }

      .balance-item:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
      }

      .balance-label {
        font-family: "Cinzel", serif;
        font-size: 0.75rem;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: rgba(230, 217, 255, 0.6);
        margin-bottom: 0.5rem;
      }

      .balance-value {
        font-family: "EB Garamond", serif;
        font-size: 2rem;
        color: #9d7bff;
        font-weight: 500;
      }

      .receipts-panel {
        background: rgba(10, 0, 21, 0.6);
        border: 1px solid rgba(157, 123, 255, 0.3);
        padding: 2rem;
        backdrop-filter: blur(10px);
      }

      .receipts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 1rem;
        margin-top: 1.5rem;
      }

      .receipt-card {
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(157, 123, 255, 0.2);
        padding: 1.25rem;
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .receipt-card:hover {
        border-color: rgba(157, 123, 255, 0.4);
        background: rgba(157, 123, 255, 0.05);
      }

      .receipt-image {
        width: 100%;
        height: 150px;
        object-fit: contain;
        margin-bottom: 1rem;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 4px;
      }

      .receipt-proposal {
        font-family: "Cinzel", serif;
        font-size: 0.7rem;
        letter-spacing: 0.1em;
        color: #9d7bff;
        margin-bottom: 0.5rem;
      }

      .receipt-vote {
        font-family: "EB Garamond", serif;
        font-size: 0.9rem;
        color: rgba(230, 217, 255, 0.8);
        margin-bottom: 0.5rem;
      }

      .receipt-amount {
        font-family: "EB Garamond", serif;
        font-size: 1.1rem;
        color: #e6d9ff;
        font-weight: 500;
      }

      .receipt-name {
        font-family: "Cinzel", serif;
        font-size: 0.85rem;
        color: #9d7bff;
        margin-bottom: 0.5rem;
        font-weight: 500;
      }

      .dao-panel {
        background: rgba(10, 0, 21, 0.6);
        border: 1px solid rgba(157, 123, 255, 0.3);
        padding: 2rem;
        backdrop-filter: blur(10px);
      }

      .dao-panel-title {
        font-family: "Cinzel", serif;
        font-size: 1.2rem;
        letter-spacing: 0.15em;
        color: #e6d9ff;
        margin-bottom: 1.5rem;
        text-transform: uppercase;
        padding-bottom: 1rem;
        border-bottom: 1px solid rgba(157, 123, 255, 0.2);
      }

      /* CHATROOM */
      .chatroom-messages {
        max-height: 400px;
        overflow-y: auto;
        margin-bottom: 1.5rem;
        padding-right: 0.5rem;
      }

      .chatroom-messages::-webkit-scrollbar {
        width: 6px;
      }

      .chatroom-messages::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.3);
      }

      .chatroom-messages::-webkit-scrollbar-thumb {
        background: rgba(157, 123, 255, 0.4);
        border-radius: 3px;
      }

      .chatroom-message {
        margin-bottom: 1rem;
        padding: 1rem;
        background: rgba(0, 0, 0, 0.3);
        border-left: 2px solid rgba(157, 123, 255, 0.3);
      }

      .chatroom-message.proposal {
        border-left-color: #9d7bff;
        background: rgba(157, 123, 255, 0.1);
      }

      .chatroom-message-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
        font-size: 0.75rem;
        color: rgba(230, 217, 255, 0.5);
      }

      .chatroom-message-text {
        font-family: "EB Garamond", serif;
        font-size: 1rem;
        line-height: 1.6;
        color: rgba(230, 217, 255, 0.9);
      }

      .chatroom-send {
        display: flex;
        gap: 1rem;
      }

      .chatroom-input {
        flex: 1;
        padding: 10px 14px;
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid rgba(157, 123, 255, 0.3);
        color: #e6d9ff;
        font-family: "EB Garamond", serif;
        font-size: 1rem;
        transition: all 0.3s ease;
      }

      .chatroom-input:focus {
        outline: none;
        border-color: #9d7bff;
        box-shadow: 0 0 10px rgba(157, 123, 255, 0.2);
      }

      .chatroom-button {
        padding: 10px 20px;
        background: linear-gradient(135deg, #9d7bff 0%, #6b4fb8 100%);
        border: none;
        color: #000;
        font-family: "Cinzel", serif;
        font-size: 0.75rem;
        letter-spacing: 0.15em;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        font-weight: 600;
      }

      .chatroom-button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(157, 123, 255, 0.4);
      }

      .chatroom-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* TREASURY */
      .treasury-section {
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 1px solid rgba(157, 123, 255, 0.2);
      }

      .treasury-title {
        font-family: "Cinzel", serif;
        font-size: 1rem;
        letter-spacing: 0.15em;
        color: #e6d9ff;
        margin-bottom: 1rem;
        text-transform: uppercase;
      }

      .treasury-assets {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 0.75rem;
        margin-bottom: 1.5rem;
      }

      .treasury-asset {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 1rem 0.5rem;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(157, 123, 255, 0.2);
        transition: all 0.3s ease;
      }

      .treasury-asset:hover {
        border-color: rgba(157, 123, 255, 0.4);
        background: rgba(0, 0, 0, 0.4);
      }

      .treasury-asset-icon {
        width: 32px;
        height: 32px;
        margin-bottom: 0.5rem;
      }

      .treasury-asset-symbol {
        font-family: "Cinzel", serif;
        font-size: 0.75rem;
        letter-spacing: 0.1em;
        color: #9d7bff;
        margin-bottom: 0.25rem;
        text-transform: uppercase;
      }

      .treasury-asset-balance {
        font-family: "EB Garamond", serif;
        font-size: 0.9rem;
        color: rgba(230, 217, 255, 0.9);
      }

      .ragequit-button {
        width: 100%;
        padding: 12px 20px;
        background: rgba(255, 0, 0, 0.15);
        border: 1px solid rgba(255, 0, 0, 0.3);
        color: #ff6b6b;
        font-family: "Cinzel", serif;
        font-size: 0.75rem;
        letter-spacing: 0.15em;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        font-weight: 600;
      }

      .ragequit-button:hover {
        background: rgba(255, 0, 0, 0.25);
        border-color: #ff6b6b;
      }

      /* PROPOSALS */
      #proposalsList {
        max-height: 600px;
        overflow-y: auto;
        padding-right: 0.5rem;
      }

      #proposalsList::-webkit-scrollbar {
        width: 6px;
      }

      #proposalsList::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.3);
      }

      #proposalsList::-webkit-scrollbar-thumb {
        background: rgba(157, 123, 255, 0.4);
        border-radius: 3px;
      }

      .proposal-item {
        margin-bottom: 1.5rem;
        padding: 1.5rem;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(157, 123, 255, 0.3);
      }

      .proposal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      .proposal-id {
        font-family: "Cinzel", serif;
        font-size: 0.85rem;
        color: #9d7bff;
        letter-spacing: 0.1em;
      }

      .proposal-state {
        padding: 3px 10px;
        background: rgba(157, 123, 255, 0.08);
        border: 1px solid rgba(157, 123, 255, 0.2);
        font-family: "Cinzel", serif;
        font-size: 0.6rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        opacity: 0.75;
        color: rgba(230, 217, 255, 0.7);
      }

      .proposal-state.succeeded {
        background: rgba(0, 255, 0, 0.05);
        border-color: rgba(0, 255, 0, 0.25);
        color: rgba(95, 255, 95, 0.85);
      }

      .proposal-state.defeated {
        background: rgba(255, 0, 0, 0.05);
        border-color: rgba(255, 0, 0, 0.25);
        color: rgba(255, 107, 107, 0.85);
      }

      .proposal-description {
        font-family: "EB Garamond", serif;
        font-size: 1rem;
        line-height: 1.6;
        color: rgba(230, 217, 255, 0.9);
        margin-bottom: 1rem;
      }

      .proposal-votes {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-bottom: 1rem;
      }

      .proposal-vote-stat {
        text-align: center;
        padding: 0.75rem;
        background: rgba(0, 0, 0, 0.3);
      }

      .proposal-vote-label {
        font-family: "Cinzel", serif;
        font-size: 0.65rem;
        letter-spacing: 0.1em;
        color: rgba(230, 217, 255, 0.5);
        text-transform: uppercase;
        margin-bottom: 0.25rem;
      }

      .proposal-vote-value {
        font-family: "EB Garamond", serif;
        font-size: 1.1rem;
        color: #9d7bff;
      }

      .proposal-actions {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
      }

      .proposal-button {
        padding: 8px 16px;
        background: rgba(157, 123, 255, 0.2);
        border: 1px solid rgba(157, 123, 255, 0.4);
        color: #e6d9ff;
        font-family: "Cinzel", serif;
        font-size: 0.7rem;
        letter-spacing: 0.1em;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
      }

      .proposal-button:hover:not(:disabled) {
        background: rgba(157, 123, 255, 0.3);
        border-color: #9d7bff;
      }

      .proposal-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .proposal-button.for {
        background: rgba(0, 255, 0, 0.1);
        border-color: rgba(0, 255, 0, 0.3);
      }

      .proposal-button.against {
        background: rgba(255, 0, 0, 0.1);
        border-color: rgba(255, 0, 0, 0.3);
      }

      .proposal-button.cancel {
        background: rgba(255, 165, 0, 0.1);
        border-color: rgba(255, 165, 0, 0.3);
        color: #ffb366;
      }

      .proposal-button.cancel:hover:not(:disabled) {
        background: rgba(255, 165, 0, 0.2);
        border-color: #ffb366;
      }

      .user-vote-indicator {
        display: inline-flex;
        align-items: center;
        padding: 8px 16px;
        font-family: "EB Garamond", serif;
        font-size: 0.9rem;
        color: rgba(230, 217, 255, 0.8);
        background: rgba(157, 123, 255, 0.05);
        border: 1px solid rgba(157, 123, 255, 0.2);
        margin-right: 0.5rem;
      }

      .user-vote-indicator strong {
        color: #9d7bff;
        margin-left: 0.3rem;
      }

      .futarchy-reward-box {
        margin-top: 1rem;
        padding: 1rem;
        background: rgba(157, 123, 255, 0.05);
        border: 1px solid rgba(157, 123, 255, 0.2);
        border-left: 3px solid #9d7bff;
      }

      .futarchy-reward-title {
        font-family: "Cinzel", serif;
        font-size: 0.75rem;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: #9d7bff;
        margin-bottom: 0.5rem;
      }

      .futarchy-reward-info {
        font-family: "EB Garamond", serif;
        font-size: 0.9rem;
        color: rgba(230, 217, 255, 0.8);
        margin-bottom: 0.75rem;
      }

      .futarchy-reward-info strong {
        color: #9d7bff;
      }

      .proposal-button.claim {
        background: rgba(157, 123, 255, 0.15);
        border-color: rgba(157, 123, 255, 0.4);
        color: #9d7bff;
      }

      .proposal-button.claim:hover:not(:disabled) {
        background: rgba(157, 123, 255, 0.25);
        border-color: #9d7bff;
      }

      .proposal-form {
        padding: 1.5rem;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(157, 123, 255, 0.3);
        margin-bottom: 1.5rem;
      }

      .proposal-form-title {
        font-family: "Cinzel", serif;
        font-size: 1rem;
        letter-spacing: 0.1em;
        color: #e6d9ff;
        margin-bottom: 1rem;
        text-transform: uppercase;
      }

      .proposal-form-group {
        margin-bottom: 1rem;
      }

      .proposal-form-label {
        display: block;
        font-family: "Cinzel", serif;
        font-size: 0.7rem;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: rgba(230, 217, 255, 0.8);
        margin-bottom: 0.5rem;
      }

      .proposal-form-input {
        width: 100%;
        padding: 10px 14px;
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid rgba(157, 123, 255, 0.3);
        color: #e6d9ff;
        font-family: "EB Garamond", serif;
        font-size: 1rem;
        transition: all 0.3s ease;
      }

      .proposal-form-input:focus {
        outline: none;
        border-color: #9d7bff;
        box-shadow: 0 0 10px rgba(157, 123, 255, 0.2);
      }

      .proposal-form-textarea {
        min-height: 80px;
        resize: vertical;
      }

      /* MOBILE OPTIMIZATIONS FOR DAO DASHBOARD */
      @media (max-width: 768px) {
        .dao-dashboard {
          padding: 2rem 1rem;
        }

        .dao-dashboard-header {
          flex-direction: column;
          align-items: flex-start;
          margin-bottom: 2rem;
        }

        .dao-dashboard-header > div:first-child {
          width: 100%;
        }

        .dao-dashboard-title {
          font-size: 1.3rem;
          letter-spacing: 0.15em;
        }

        .dao-etherscan-link {
          font-size: 0.75rem;
        }

        .dao-stats-bar {
          flex-wrap: wrap;
          gap: 1rem;
        }

        .dao-stat-label {
          font-size: 0.6rem;
        }

        .dao-stat-value {
          font-size: 0.9rem;
        }

        .back-button {
          width: 100%;
          text-align: center;
        }

        .dao-view-toggle {
          gap: 0.5rem;
          margin-bottom: 1.5rem;
        }

        .view-toggle-btn {
          padding: 0.6rem 1rem;
          font-size: 0.75rem;
          letter-spacing: 0.08em;
        }

        .dao-panel {
          padding: 1.5rem 1rem;
        }

        .dao-panel-title {
          font-size: 1rem;
          margin-bottom: 1rem;
        }

        /* Chatroom mobile */
        .chatroom-messages {
          max-height: 300px;
        }

        .chatroom-message {
          padding: 0.75rem;
        }

        /* Proposals mobile */
        #proposalsList {
          max-height: 400px;
        }

        .chatroom-message-header {
          flex-direction: column;
          gap: 0.25rem;
        }

        .chatroom-send {
          flex-direction: column;
          gap: 0.75rem;
        }

        .chatroom-button {
          width: 100%;
        }

        /* Proposals mobile */
        .proposal-item {
          padding: 1rem;
        }

        .proposal-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 0.5rem;
        }

        .proposal-id {
          font-size: 0.75rem;
          word-break: break-all;
        }

        .proposal-votes {
          grid-template-columns: 1fr;
          gap: 0.5rem;
        }

        .proposal-vote-stat {
          display: flex;
          justify-content: space-between;
          align-items: center;
          text-align: left;
          padding: 0.5rem 0.5rem 0.5rem 0.75rem;
          background: transparent;
          border-left: 2px solid rgba(157, 123, 255, 0.3);
        }

        .proposal-vote-label {
          margin-bottom: 0;
        }

        .proposal-vote-value {
          font-weight: 600;
        }

        .proposal-actions {
          flex-direction: column;
          gap: 0.5rem;
        }

        .proposal-button {
          width: 100%;
          padding: 12px;
        }

        .user-vote-indicator {
          width: 100%;
          justify-content: center;
          margin-right: 0;
          margin-bottom: 0.5rem;
          font-size: 0.85rem;
        }

        /* Proposal form mobile */
        .proposal-form {
          padding: 1rem;
        }

        .proposal-form-title {
          font-size: 0.9rem;
        }

        .proposal-form-group {
          margin-bottom: 0.75rem;
        }

        .proposal-form-input,
        .proposal-form-textarea {
          font-size: 0.95rem;
        }
      }

      @media (max-width: 480px) {
        .dao-dashboard {
          padding: 1.5rem 0.75rem;
        }

        .dao-dashboard-title {
          font-size: 1.1rem;
        }

        .dao-etherscan-link {
          font-size: 0.7rem;
        }

        .dao-stats-bar {
          gap: 0.75rem;
        }

        .dao-stat-label {
          font-size: 0.55rem;
        }

        .dao-stat-value {
          font-size: 0.85rem;
        }

        .dao-panel {
          padding: 1rem 0.75rem;
        }

        .chatroom-messages {
          max-height: 250px;
        }

        #proposalsList {
          max-height: 350px;
        }

        .proposal-id {
          font-size: 0.7rem;
        }

        .proposal-state {
          font-size: 0.6rem;
          padding: 3px 8px;
          opacity: 1;
        }
      }

      /* MEMBERS LIST */
      .dao-members-content {
        display: none;
      }

      .dao-members-content.show {
        display: block;
      }

      .members-panel {
        background: rgba(10, 0, 21, 0.6);
        border: 1px solid rgba(157, 123, 255, 0.3);
        padding: 2rem;
        backdrop-filter: blur(10px);
      }

      .members-header {
        margin-bottom: 1.5rem;
      }

      .members-stats {
        display: flex;
        gap: 2rem;
        margin-top: 1rem;
        padding: 1rem;
        background: rgba(157, 123, 255, 0.05);
        border: 1px solid rgba(157, 123, 255, 0.2);
        border-radius: 6px;
      }

      .members-stat {
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }

      .members-stat-label {
        font-family: 'Cinzel', serif;
        font-size: 0.75rem;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: rgba(230, 217, 255, 0.6);
      }

      .members-stat-value {
        font-family: 'EB Garamond', serif;
        font-size: 1.1rem;
        color: #9d7bff;
        font-weight: 500;
      }

      .members-list {
        max-height: 600px;
        overflow-y: auto;
        margin-top: 1.5rem;
      }

      .members-list::-webkit-scrollbar {
        width: 8px;
      }

      .members-list::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 4px;
      }

      .members-list::-webkit-scrollbar-thumb {
        background: rgba(157, 123, 255, 0.3);
        border-radius: 4px;
      }

      .members-list::-webkit-scrollbar-thumb:hover {
        background: rgba(157, 123, 255, 0.5);
      }

      .member-item {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 0.8fr 0.8fr 100px;
        gap: 1rem;
        padding: 1rem;
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(157, 123, 255, 0.15);
        margin-bottom: 0.75rem;
        transition: all 0.2s ease;
        align-items: center;
      }

      .member-item:hover {
        background: rgba(157, 123, 255, 0.05);
        border-color: rgba(157, 123, 255, 0.3);
      }

      .member-address {
        font-family: 'EB Garamond', serif;
        font-size: 0.9rem;
        color: #e6d9ff;
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      .member-ens {
        font-size: 1rem;
        color: #9d7bff;
        font-weight: 500;
      }

      .member-address-hex {
        font-size: 0.8rem;
        color: rgba(230, 217, 255, 0.6);
        font-family: 'Courier New', monospace;
      }

      .member-shares,
      .member-loot,
      .member-badge,
      .member-ownership {
        font-family: 'EB Garamond', serif;
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      .member-label {
        font-size: 0.65rem;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: rgba(230, 217, 255, 0.5);
      }

      .member-value {
        font-size: 0.95rem;
        color: #e6d9ff;
      }

      .member-link {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.5rem;
        background: rgba(157, 123, 255, 0.1);
        border: 1px solid rgba(157, 123, 255, 0.3);
        border-radius: 4px;
        color: #9d7bff;
        text-decoration: none;
        transition: all 0.2s ease;
      }

      .member-link:hover {
        background: rgba(157, 123, 255, 0.2);
        border-color: #9d7bff;
      }

      .member-link svg {
        width: 16px;
        height: 16px;
      }

      @media (max-width: 768px) {
        .members-stats {
          flex-direction: column;
          gap: 0.75rem;
        }

        .member-item {
          grid-template-columns: 1fr;
          gap: 0.75rem;
        }

        .member-address,
        .member-shares,
        .member-loot,
        .member-badge,
        .member-ownership {
          padding-bottom: 0.5rem;
          border-bottom: 1px solid rgba(157, 123, 255, 0.1);
        }

        .member-link {
          width: 100%;
        }
      }

      @media (max-width: 480px) {
        .members-panel {
          padding: 1rem 0.75rem;
        }

        .members-list {
          max-height: 400px;
        }

        .member-item {
          padding: 0.75rem;
        }
      }

      /* DAO EMBLEM */
      .dao-emblem {
        width: 48px;
        height: 48px;
        cursor: pointer;
        border: 1px solid rgba(157, 123, 255, 0.3);
        border-radius: 6px;
        overflow: hidden;
        transition: all 0.3s ease;
        background: rgba(10, 0, 21, 0.6);
        backdrop-filter: blur(5px);
        flex-shrink: 0;
      }

      .dao-emblem:hover {
        border-color: #9d7bff;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(157, 123, 255, 0.2);
      }

      .dao-emblem img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      /* NFT MODAL */
      .nft-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(10px);
        z-index: 10000;
        overflow-y: auto;
        padding: 2rem;
      }

      .nft-modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .nft-modal-content {
        background: rgba(10, 0, 21, 0.95);
        border: 1px solid rgba(157, 123, 255, 0.4);
        border-radius: 12px;
        padding: 2rem;
        max-width: 600px;
        width: 100%;
        position: relative;
        animation: modalSlideIn 0.3s ease;
      }

      @keyframes modalSlideIn {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .nft-modal-close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: rgba(157, 123, 255, 0.1);
        border: 1px solid rgba(157, 123, 255, 0.3);
        color: #e6d9ff;
        font-size: 1.5rem;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        line-height: 1;
      }

      .nft-modal-close:hover {
        background: rgba(157, 123, 255, 0.2);
        border-color: #9d7bff;
      }

      .nft-modal-body {
        text-align: center;
      }

      .nft-modal-image {
        width: 100%;
        max-width: 500px;
        height: auto;
        border-radius: 8px;
        border: 1px solid rgba(157, 123, 255, 0.3);
        margin-bottom: 1.5rem;
      }

      .nft-modal-title {
        font-family: 'Cinzel', serif;
        font-size: 1.5rem;
        color: #9d7bff;
        margin-bottom: 1rem;
        letter-spacing: 0.1em;
      }

      .nft-modal-description {
        font-family: 'EB Garamond', serif;
        font-size: 1rem;
        color: rgba(230, 217, 255, 0.8);
        line-height: 1.6;
        margin-bottom: 1.5rem;
      }

      .nft-modal-attributes {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 0.75rem;
        margin-top: 1.5rem;
      }

      .nft-modal-attribute {
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(157, 123, 255, 0.2);
        padding: 0.75rem;
        border-radius: 6px;
      }

      .nft-modal-attribute-label {
        font-family: 'Cinzel', serif;
        font-size: 0.65rem;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: rgba(230, 217, 255, 0.6);
        margin-bottom: 0.25rem;
      }

      .nft-modal-attribute-value {
        font-family: 'EB Garamond', serif;
        font-size: 1rem;
        color: #e6d9ff;
      }

      @media (max-width: 768px) {
        .nft-modal {
          padding: 1rem;
        }

        .nft-modal-content {
          padding: 1.5rem;
          max-width: 100%;
        }

        .nft-modal-title {
          font-size: 1.2rem;
        }

        .nft-modal-description {
          font-size: 0.9rem;
        }

        .dao-emblem {
          width: 40px;
          height: 40px;
        }
      }

      @media (max-width: 480px) {
        .nft-modal {
          padding: 0.5rem;
        }

        .nft-modal-content {
          padding: 1rem;
        }

        .nft-modal-title {
          font-size: 1rem;
        }

        .nft-modal-close {
          width: 35px;
          height: 35px;
          font-size: 1.2rem;
        }

        .dao-emblem {
          width: 36px;
          height: 36px;
        }

        .nft-modal-attributes {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <!-- Starry Background -->
    <div class="starry-bg">
      <div class="stars-layer"></div>
    </div>

    <!-- Summon Link Button (top left) -->
    <button class="summon-link" onclick="document.getElementById('summoner').scrollIntoView({ behavior: 'smooth' });">
      Summon
    </button>

    <!-- Wallet Connect Button (top right) -->
    <button class="wallet-button" id="walletBtn" onclick="connectWallet()">
      CONNECT WALLET
    </button>

    <!-- Wallet Selection Modal -->
    <div class="wallet-modal-overlay" id="walletModal">
      <div class="wallet-modal">
        <div class="wallet-modal-header">
          <h2 class="wallet-modal-title">Connect Wallet</h2>
          <button class="wallet-modal-close" onclick="closeWalletModal()">&times;</button>
        </div>
        <div id="walletOptions">
          <!-- Wallet options will be dynamically inserted here -->
        </div>
      </div>
    </div>

    <!-- RAGEQUIT MODAL -->
    <div class="wallet-modal-overlay" id="ragequitModal">
      <div class="wallet-modal" style="max-width: 600px;">
        <div class="wallet-modal-header">
          <h2 class="wallet-modal-title">Ragequit DAO</h2>
          <button class="wallet-modal-close" onclick="closeRagequitModal()">&times;</button>
        </div>
        <div style="padding: 1.5rem;">
          <!-- Member Balances -->
          <div style="margin-bottom: 2rem;">
            <h4 style="font-family: 'Cinzel', serif; font-size: 0.9rem; color: #9d7bff; margin-bottom: 1rem; letter-spacing: 0.1em;">YOUR BALANCES</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
              <div style="padding: 1rem; background: rgba(157, 123, 255, 0.1); border: 1px solid rgba(157, 123, 255, 0.3);">
                <div style="font-size: 0.75rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.5rem;">SHARES</div>
                <div id="ragequitUserShares" style="font-size: 1.25rem; color: #e6d9ff;">0</div>
              </div>
              <div style="padding: 1rem; background: rgba(157, 123, 255, 0.1); border: 1px solid rgba(157, 123, 255, 0.3);">
                <div style="font-size: 0.75rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.5rem;">LOOT</div>
                <div id="ragequitUserLoot" style="font-size: 1.25rem; color: #e6d9ff;">0</div>
              </div>
            </div>
          </div>

          <!-- Burn Amounts -->
          <div style="margin-bottom: 2rem;">
            <h4 style="font-family: 'Cinzel', serif; font-size: 0.9rem; color: #9d7bff; margin-bottom: 1rem; letter-spacing: 0.1em;">BURN AMOUNTS</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
              <div>
                <label style="display: block; font-size: 0.75rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.5rem;">Shares to Burn</label>
                <input type="text" id="ragequitSharesInput" placeholder="0.0" style="width: 100%; padding: 0.75rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 1rem;">
              </div>
              <div>
                <label style="display: block; font-size: 0.75rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.5rem;">Loot to Burn</label>
                <input type="text" id="ragequitLootInput" placeholder="0.0" style="width: 100%; padding: 0.75rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 1rem;">
              </div>
            </div>
          </div>

          <!-- Token Selection -->
          <div style="margin-bottom: 2rem;">
            <h4 style="font-family: 'Cinzel', serif; font-size: 0.9rem; color: #9d7bff; margin-bottom: 1rem; letter-spacing: 0.1em;">TOKENS TO CLAIM</h4>
            <div id="ragequitTokenList" style="display: flex; flex-direction: column; gap: 0.75rem;">
              <!-- Token checkboxes will be dynamically inserted here -->
            </div>
          </div>

          <!-- Action Buttons -->
          <div style="display: flex; gap: 1rem;">
            <button onclick="closeRagequitModal()" style="flex: 1; padding: 12px; background: rgba(157, 123, 255, 0.1); border: 1px solid rgba(157, 123, 255, 0.3); color: #9d7bff; font-family: 'Cinzel', serif; font-size: 0.75rem; letter-spacing: 0.15em; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase;">
              Cancel
            </button>
            <button onclick="executeRagequit()" style="flex: 1; padding: 12px; background: rgba(255, 0, 0, 0.15); border: 1px solid rgba(255, 0, 0, 0.3); color: #ff6b6b; font-family: 'Cinzel', serif; font-size: 0.75rem; letter-spacing: 0.15em; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; font-weight: 600;">
              Execute Ragequit
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- HERO / LANDER -->
    <div class="hero page">
      <svg width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <!-- Reusable gradients and filters -->
          <radialGradient id="bgGradient">
            <stop offset="0%" style="stop-color: #0a0015; stop-opacity: 1" />
            <stop offset="100%" style="stop-color: #000000; stop-opacity: 1" />
          </radialGradient>

          <filter id="purpleGlow">
            <feGaussianBlur stdDeviation="4" result="coloredBlur" />
            <feMerge>
              <feMergeNode in="coloredBlur" />
              <feMergeNode in="SourceGraphic" />
            </feMerge>
          </filter>

          <filter id="outerGlow" x="-50%" y="-50%" width="200%" height="200%">
            <feGaussianBlur stdDeviation="8" result="bigBlur" />
            <feColorMatrix
              in="bigBlur"
              type="matrix"
              values="1 0 0 0 0.6
                      0 1 0 0 0.3
                      0 0 1 0 1
                      0 0 0 0.8 0"
            />
            <feMerge>
              <feMergeNode />
              <feMergeNode in="SourceGraphic" />
            </feMerge>
          </filter>

          <!-- Lava lamp blob patterns -->
          <pattern
            id="lavaBlobs"
            x="0"
            y="0"
            width="100%"
            height="100%"
            patternUnits="userSpaceOnUse"
          >
            <ellipse cx="20%" cy="100%" rx="80" ry="120" fill="black">
              <animate
                attributeName="cy"
                values="100%;50%;0%;50%;100%"
                dur="12s"
                repeatCount="indefinite"
              />
              <animate
                attributeName="cx"
                values="20%;35%;25%;40%;20%"
                dur="12s"
                repeatCount="indefinite"
              />
            </ellipse>
            <ellipse cx="70%" cy="0%" rx="60" ry="100" fill="black">
              <animate
                attributeName="cy"
                values="0%;60%;100%;60%;0%"
                dur="10s"
                repeatCount="indefinite"
              />
              <animate
                attributeName="cx"
                values="70%;55%;65%;75%;70%"
                dur="10s"
                repeatCount="indefinite"
              />
            </ellipse>
            <ellipse cx="50%" cy="120%" rx="50" ry="80" fill="black">
              <animate
                attributeName="cy"
                values="120%;40%;-20%;40%;120%"
                dur="15s"
                repeatCount="indefinite"
              />
            </ellipse>
          </pattern>

          <mask id="blobMask">
            <rect width="100%" height="100%" fill="white" />
            <rect width="100%" height="100%" fill="url(#lavaBlobs)" />
          </mask>

          <filter id="gooey">
            <feGaussianBlur in="SourceGraphic" stdDeviation="8" result="blur" />
            <feColorMatrix
              in="blur"
              type="matrix"
              values="1 0 0 0 0
                      0 1 0 0 0
                      0 0 1 0 0
                      0 0 0 19 -9"
            />
            <feComposite in2="SourceGraphic" operator="atop" />
          </filter>

          <pattern
            id="stars"
            x="0"
            y="0"
            width="200"
            height="200"
            patternUnits="userSpaceOnUse"
          >
            <circle cx="20" cy="30" r="0.5" fill="white" opacity="0.6">
              <animate
                attributeName="opacity"
                values="0.6;1;0.6"
                dur="3s"
                repeatCount="indefinite"
              />
            </circle>
            <circle cx="80" cy="50" r="0.8" fill="white" opacity="0.4">
              <animate
                attributeName="opacity"
                values="0.4;0.8;0.4"
                dur="4s"
                repeatCount="indefinite"
              />
            </circle>
            <circle cx="120" cy="80" r="0.3" fill="white" opacity="0.7">
              <animate
                attributeName="opacity"
                values="0.7;1;0.7"
                dur="2.5s"
                repeatCount="indefinite"
              />
            </circle>
            <circle cx="160" cy="120" r="0.6" fill="white" opacity="0.5">
              <animate
                attributeName="opacity"
                values="0.5;0.9;0.5"
                dur="3.5s"
                repeatCount="indefinite"
              />
            </circle>
            <circle cx="40" cy="140" r="0.4" fill="white" opacity="0.6">
              <animate
                attributeName="opacity"
                values="0.6;1;0.6"
                dur="2.8s"
                repeatCount="indefinite"
              />
            </circle>
            <circle cx="180" cy="20" r="0.5" fill="white" opacity="0.4">
              <animate
                attributeName="opacity"
                values="0.4;0.7;0.4"
                dur="4.2s"
                repeatCount="indefinite"
              />
            </circle>
            <circle cx="100" cy="160" r="0.7" fill="white" opacity="0.5">
              <animate
                attributeName="opacity"
                values="0.5;1;0.5"
                dur="3.3s"
                repeatCount="indefinite"
              />
            </circle>
            <circle cx="150" cy="180" r="0.4" fill="#9d7bff" opacity="0.3">
              <animate
                attributeName="opacity"
                values="0.3;0.7;0.3"
                dur="5s"
                repeatCount="indefinite"
              />
            </circle>
          </pattern>
        </defs>

        <!-- Background -->
        <rect width="100%" height="100%" fill="url(#bgGradient)" />
        <rect width="100%" height="100%" fill="url(#stars)" />

        <!-- Additional scattered stars for brightness -->
        <g opacity="0.4">
          <circle cx="10%" cy="20%" r="1" fill="white">
            <animate
              attributeName="opacity"
              values="0.4;1;0.4"
              dur="2.7s"
              repeatCount="indefinite"
            />
          </circle>
          <circle cx="90%" cy="15%" r="0.5" fill="white">
            <animate
              attributeName="opacity"
              values="0.3;0.8;0.3"
              dur="3.2s"
              repeatCount="indefinite"
            />
          </circle>
          <circle cx="85%" cy="80%" r="0.8" fill="white">
            <animate
              attributeName="opacity"
              values="0.5;1;0.5"
              dur="2.9s"
              repeatCount="indefinite"
            />
          </circle>
          <circle cx="15%" cy="85%" r="0.6" fill="white">
            <animate
              attributeName="opacity"
              values="0.4;0.9;0.4"
              dur="3.4s"
              repeatCount="indefinite"
            />
          </circle>
          <circle cx="30%" cy="10%" r="0.7" fill="#9d7bff">
            <animate
              attributeName="opacity"
              values="0.2;0.6;0.2"
              dur="4s"
              repeatCount="indefinite"
            />
          </circle>
          <circle cx="70%" cy="90%" r="0.5" fill="#9d7bff">
            <animate
              attributeName="opacity"
              values="0.3;0.7;0.3"
              dur="3.8s"
              repeatCount="indefinite"
            />
          </circle>
        </g>

        <!-- RADIATING LINES FROM TOP -->
        <g opacity="0.9">
          <line
            x1="50%"
            y1="0"
            x2="50%"
            y2="50%"
            stroke="white"
            stroke-width="1.5"
            opacity="0.8"
          >
            <animate
              attributeName="opacity"
              values="0.6;1;0.6"
              dur="4s"
              repeatCount="indefinite"
            />
          </line>
          <line
            x1="48%"
            y1="0"
            x2="49%"
            y2="50%"
            stroke="white"
            stroke-width="1.2"
            opacity="0.7"
          />
          <line
            x1="52%"
            y1="0"
            x2="51%"
            y2="50%"
            stroke="white"
            stroke-width="1.2"
            opacity="0.7"
          />
          <line
            x1="46%"
            y1="0"
            x2="48.5%"
            y2="50%"
            stroke="white"
            stroke-width="1"
            opacity="0.65"
          />
          <line
            x1="54%"
            y1="0"
            x2="51.5%"
            y2="50%"
            stroke="white"
            stroke-width="1"
            opacity="0.65"
          />
          <line
            x1="44%"
            y1="0"
            x2="48%"
            y2="50%"
            stroke="white"
            stroke-width="0.8"
            opacity="0.6"
          />
          <line
            x1="56%"
            y1="0"
            x2="52%"
            y2="50%"
            stroke="white"
            stroke-width="0.8"
            opacity="0.6"
          />
          <line
            x1="42%"
            y1="0"
            x2="47%"
            y2="50%"
            stroke="white"
            stroke-width="0.7"
            opacity="0.55"
          />
          <line
            x1="58%"
            y1="0"
            x2="53%"
            y2="50%"
            stroke="white"
            stroke-width="0.7"
            opacity="0.55"
          />
          <line
            x1="40%"
            y1="0"
            x2="46.5%"
            y2="50%"
            stroke="white"
            stroke-width="0.6"
            opacity="0.5"
          />
          <line
            x1="60%"
            y1="0"
            x2="53.5%"
            y2="50%"
            stroke="white"
            stroke-width="0.6"
            opacity="0.5"
          />
          <line
            x1="38%"
            y1="0"
            x2="46%"
            y2="50%"
            stroke="white"
            stroke-width="0.5"
            opacity="0.45"
          />
          <line
            x1="62%"
            y1="0"
            x2="54%"
            y2="50%"
            stroke="white"
            stroke-width="0.5"
            opacity="0.45"
          />
          <line
            x1="35%"
            y1="0"
            x2="45%"
            y2="50%"
            stroke="white"
            stroke-width="0.5"
            opacity="0.4"
          />
          <line
            x1="65%"
            y1="0"
            x2="55%"
            y2="50%"
            stroke="white"
            stroke-width="0.5"
            opacity="0.4"
          />
          <line
            x1="32%"
            y1="0"
            x2="44%"
            y2="50%"
            stroke="white"
            stroke-width="0.4"
            opacity="0.35"
          />
          <line
            x1="68%"
            y1="0"
            x2="56%"
            y2="50%"
            stroke="white"
            stroke-width="0.4"
            opacity="0.35"
          />
          <line
            x1="30%"
            y1="0"
            x2="43%"
            y2="50%"
            stroke="white"
            stroke-width="0.3"
            opacity="0.3"
          />
          <line
            x1="70%"
            y1="0"
            x2="57%"
            y2="50%"
            stroke="white"
            stroke-width="0.3"
            opacity="0.3"
          />
          <line
            x1="28%"
            y1="0"
            x2="42.5%"
            y2="50%"
            stroke="white"
            stroke-width="0.3"
            opacity="0.25"
          />
          <line
            x1="72%"
            y1="0"
            x2="57.5%"
            y2="50%"
            stroke="white"
            stroke-width="0.3"
            opacity="0.25"
          />
          <line
            x1="25%"
            y1="0"
            x2="42%"
            y2="50%"
            stroke="white"
            stroke-width="0.2"
            opacity="0.2"
          />
          <line
            x1="75%"
            y1="0"
            x2="58%"
            y2="50%"
            stroke="white"
            stroke-width="0.2"
            opacity="0.2"
          />
          <line
            x1="20%"
            y1="0"
            x2="41%"
            y2="50%"
            stroke="white"
            stroke-width="0.15"
            opacity="0.15"
          />
          <line
            x1="80%"
            y1="0"
            x2="59%"
            y2="50%"
            stroke="white"
            stroke-width="0.15"
            opacity="0.15"
          />
          <line
            x1="15%"
            y1="0"
            x2="40%"
            y2="50%"
            stroke="white"
            stroke-width="0.1"
            opacity="0.1"
          />
          <line
            x1="85%"
            y1="0"
            x2="60%"
            y2="50%"
            stroke="white"
            stroke-width="0.1"
            opacity="0.1"
          />
          <line
            x1="10%"
            y1="0"
            x2="39%"
            y2="50%"
            stroke="white"
            stroke-width="0.1"
            opacity="0.1"
          />
          <line
            x1="90%"
            y1="0"
            x2="61%"
            y2="50%"
            stroke="white"
            stroke-width="0.1"
            opacity="0.1"
          />
        </g>

        <!-- RADIATING LINES FROM BOTTOM -->
        <g opacity="0.9">
          <line
            x1="50%"
            y1="100%"
            x2="50%"
            y2="50%"
            stroke="white"
            stroke-width="1.5"
            opacity="0.8"
          >
            <animate
              attributeName="opacity"
              values="0.6;1;0.6"
              dur="4s"
              repeatCount="indefinite"
            />
          </line>
          <line
            x1="48%"
            y1="100%"
            x2="49%"
            y2="50%"
            stroke="white"
            stroke-width="1.2"
            opacity="0.7"
          />
          <line
            x1="52%"
            y1="100%"
            x2="51%"
            y2="50%"
            stroke="white"
            stroke-width="1.2"
            opacity="0.7"
          />
          <line
            x1="46%"
            y1="100%"
            x2="48.5%"
            y2="50%"
            stroke="white"
            stroke-width="1"
            opacity="0.65"
          />
          <line
            x1="54%"
            y1="100%"
            x2="51.5%"
            y2="50%"
            stroke="white"
            stroke-width="1"
            opacity="0.65"
          />
          <line
            x1="44%"
            y1="100%"
            x2="48%"
            y2="50%"
            stroke="white"
            stroke-width="0.8"
            opacity="0.6"
          />
          <line
            x1="56%"
            y1="100%"
            x2="52%"
            y2="50%"
            stroke="white"
            stroke-width="0.8"
            opacity="0.6"
          />
          <line
            x1="42%"
            y1="100%"
            x2="47%"
            y2="50%"
            stroke="white"
            stroke-width="0.7"
            opacity="0.55"
          />
          <line
            x1="58%"
            y1="100%"
            x2="53%"
            y2="50%"
            stroke="white"
            stroke-width="0.7"
            opacity="0.55"
          />
          <line
            x1="40%"
            y1="100%"
            x2="46.5%"
            y2="50%"
            stroke="white"
            stroke-width="0.6"
            opacity="0.5"
          />
          <line
            x1="60%"
            y1="100%"
            x2="53.5%"
            y2="50%"
            stroke="white"
            stroke-width="0.6"
            opacity="0.5"
          />
          <line
            x1="38%"
            y1="100%"
            x2="46%"
            y2="50%"
            stroke="white"
            stroke-width="0.5"
            opacity="0.45"
          />
          <line
            x1="62%"
            y1="100%"
            x2="54%"
            y2="50%"
            stroke="white"
            stroke-width="0.5"
            opacity="0.45"
          />
          <line
            x1="35%"
            y1="100%"
            x2="45%"
            y2="50%"
            stroke="white"
            stroke-width="0.5"
            opacity="0.4"
          />
          <line
            x1="65%"
            y1="100%"
            x2="55%"
            y2="50%"
            stroke="white"
            stroke-width="0.5"
            opacity="0.4"
          />
          <line
            x1="32%"
            y1="100%"
            x2="44%"
            y2="50%"
            stroke="white"
            stroke-width="0.4"
            opacity="0.35"
          />
          <line
            x1="68%"
            y1="100%"
            x2="56%"
            y2="50%"
            stroke="white"
            stroke-width="0.4"
            opacity="0.35"
          />
          <line
            x1="30%"
            y1="100%"
            x2="43%"
            y2="50%"
            stroke="white"
            stroke-width="0.3"
            opacity="0.3"
          />
          <line
            x1="70%"
            y1="100%"
            x2="57%"
            y2="50%"
            stroke="white"
            stroke-width="0.3"
            opacity="0.3"
          />
          <line
            x1="28%"
            y1="100%"
            x2="42.5%"
            y2="50%"
            stroke="white"
            stroke-width="0.3"
            opacity="0.25"
          />
          <line
            x1="72%"
            y1="100%"
            x2="57.5%"
            y2="50%"
            stroke="white"
            stroke-width="0.3"
            opacity="0.25"
          />
          <line
            x1="25%"
            y1="100%"
            x2="42%"
            y2="50%"
            stroke="white"
            stroke-width="0.2"
            opacity="0.2"
          />
          <line
            x1="75%"
            y1="100%"
            x2="58%"
            y2="50%"
            stroke="white"
            stroke-width="0.2"
            opacity="0.2"
          />
          <line
            x1="20%"
            y1="100%"
            x2="41%"
            y2="50%"
            stroke="white"
            stroke-width="0.15"
            opacity="0.15"
          />
          <line
            x1="80%"
            y1="100%"
            x2="59%"
            y2="50%"
            stroke="white"
            stroke-width="0.15"
            opacity="0.15"
          />
          <line
            x1="15%"
            y1="100%"
            x2="40%"
            y2="50%"
            stroke="white"
            stroke-width="0.1"
            opacity="0.1"
          />
          <line
            x1="85%"
            y1="100%"
            x2="60%"
            y2="50%"
            stroke="white"
            stroke-width="0.1"
            opacity="0.1"
          />
          <line
            x1="10%"
            y1="100%"
            x2="39%"
            y2="50%"
            stroke="white"
            stroke-width="0.1"
            opacity="0.1"
          />
          <line
            x1="90%"
            y1="100%"
            x2="61%"
            y2="50%"
            stroke="white"
            stroke-width="0.1"
            opacity="0.1"
          />
        </g>

        <!-- Eye circles -->
        <circle
          cx="50%"
          cy="50%"
          r="100"
          fill="none"
          stroke="white"
          stroke-width="0.8"
          opacity="0.4"
        >
          <animate
            attributeName="r"
            values="100;105;100"
            dur="8s"
            repeatCount="indefinite"
          />
        </circle>
        <circle
          cx="50%"
          cy="50%"
          r="60"
          fill="none"
          stroke="#9d7bff"
          stroke-width="0.6"
          opacity="0.5"
        >
          <animate
            attributeName="r"
            values="60;65;60"
            dur="6s"
            repeatCount="indefinite"
          />
        </circle>

        <!-- MOLOCH text -->
        <text
          class="hero-moloch-text"
          x="50%"
          y="35%"
          font-size="65"
          font-weight="400"
          text-anchor="middle"
          fill="#2a1a4a"
          opacity="0.5"
          letter-spacing="22"
          font-family="'Cinzel', serif"
        >
          MOLOCH
          <animate
            attributeName="opacity"
            values="0.5;0.65;0.5"
            dur="8s"
            repeatCount="indefinite"
          />
        </text>

        <!-- MAJEUR text + ink effect -->
        <g>
          <text
            class="hero-majeur-text"
            x="50%"
            y="65%"
            font-size="72"
            font-weight="400"
            font-style="italic"
            text-anchor="middle"
            fill="#b19cd9"
            letter-spacing="18"
            filter="url(#outerGlow)"
            font-family="'EB Garamond', serif"
          >
            MAJEUR
            <animate
              attributeName="fill"
              values="#b19cd9;#d8bfff;#b19cd9"
              dur="4s"
              repeatCount="indefinite"
            />
          </text>
          <text
            class="hero-majeur-text"
            x="50%"
            y="65%"
            font-size="72"
            font-weight="400"
            font-style="italic"
            text-anchor="middle"
            fill="#e6d9ff"
            opacity="0.8"
            letter-spacing="18"
            filter="url(#purpleGlow)"
            font-family="'EB Garamond', serif"
          >
            MAJEUR
            <animate
              attributeName="opacity"
              values="0.8;1;0.8"
              dur="3s"
              repeatCount="indefinite"
            />
          </text>
          <!-- Black ink bleed effect -->
          <g filter="url(#gooey)">
            <text
              class="hero-majeur-text"
              x="50%"
              y="65%"
              font-size="72"
              font-weight="400"
              font-style="italic"
              text-anchor="middle"
              fill="black"
              letter-spacing="18"
              mask="url(#blobMask)"
              font-family="'EB Garamond', serif"
            >
              MAJEUR
            </text>
          </g>
          <!-- Outline -->
          <text
            class="hero-majeur-text"
            x="50%"
            y="65%"
            font-size="72"
            font-weight="400"
            font-style="italic"
            text-anchor="middle"
            fill="none"
            stroke="#9d7bff"
            stroke-width="0.5"
            opacity="0.4"
            letter-spacing="18"
            font-family="'EB Garamond', serif"
          >
            MAJEUR
            <animate
              attributeName="stroke-width"
              values="0.5;1;0.5"
              dur="5s"
              repeatCount="indefinite"
            />
          </text>
        </g>

        <!-- Subtitle -->
        <text
          class="hero-subtitle-text"
          x="50%"
          y="75%"
          font-size="20"
          font-weight="400"
          text-anchor="middle"
          fill="#e6d9ff"
          opacity="0.7"
          letter-spacing="3"
          font-family="'Cinzel', serif"
        >
          GOVERNANCE FRAMEWORK
        </text>
      </svg>

      <!-- Scroll indicator -->
      <div class="scroll-indicator" aria-label="Scroll to features">
        <svg
          width="40"
          height="60"
          viewBox="0 0 40 60"
          xmlns="http://www.w3.org/2000/svg"
          onclick="document.getElementById('seats').scrollIntoView({ behavior: 'smooth' });"
        >
          <path
            d="M20 5 L20 45 M10 35 L20 45 L30 35"
            stroke="#b19cd9"
            stroke-width="2"
            fill="none"
            opacity="0.7"
          >
            <animate
              attributeName="opacity"
              values="0.4;0.9;0.4"
              dur="2s"
              repeatCount="indefinite"
            />
          </path>
        </svg>
      </div>
    </div>

    <!-- Intro Panel -->
    <section class="intro-panel">
      <!-- Subtle radial line continuations from hero -->
      <div class="radial-continuation">
        <svg viewBox="0 0 1000 300" preserveAspectRatio="xMidYMin slice" style="position: absolute; top: -150px; width: 100%; height: 300px; pointer-events: none;">
          <!-- Lines converging from wide to narrow -->
          <line x1="0" y1="0" x2="400" y2="300" stroke="rgba(230, 217, 255, 0.08)" stroke-width="1"/>
          <line x1="200" y1="0" x2="450" y2="300" stroke="rgba(230, 217, 255, 0.06)" stroke-width="1"/>
          <line x1="400" y1="0" x2="500" y2="300" stroke="rgba(230, 217, 255, 0.1)" stroke-width="1"/>
          <line x1="600" y1="0" x2="500" y2="300" stroke="rgba(230, 217, 255, 0.1)" stroke-width="1"/>
          <line x1="800" y1="0" x2="550" y2="300" stroke="rgba(230, 217, 255, 0.06)" stroke-width="1"/>
          <line x1="1000" y1="0" x2="600" y2="300" stroke="rgba(230, 217, 255, 0.08)" stroke-width="1"/>
        </svg>
      </div>
      
      <div class="intro-content">
        <div class="intro-art">
          <svg viewBox="0 0 400 400" xmlns="http://www.w3.org/2000/svg">
            <!-- Radial governance visualization -->
            <defs>
              <radialGradient id="centerGradient">
                <stop offset="0%" style="stop-color:#9d7bff;stop-opacity:0.8" />
                <stop offset="100%" style="stop-color:#6b46ff;stop-opacity:0.2" />
              </radialGradient>
              <filter id="glow">
                <feGaussianBlur stdDeviation="4" result="coloredBlur"/>
                <feMerge>
                  <feMergeNode in="coloredBlur"/>
                  <feMergeNode in="SourceGraphic"/>
                </feMerge>
              </filter>
            </defs>
            
            <!-- Central core -->
            <circle cx="200" cy="200" r="30" fill="url(#centerGradient)" filter="url(#glow)"/>
            
            <!-- Orbital rings -->
            <circle cx="200" cy="200" r="80" fill="none" stroke="#9d7bff" stroke-width="0.5" opacity="0.3"/>
            <circle cx="200" cy="200" r="120" fill="none" stroke="#9d7bff" stroke-width="0.5" opacity="0.4"/>
            <circle cx="200" cy="200" r="160" fill="none" stroke="#9d7bff" stroke-width="0.5" opacity="0.5"/>
            
            <!-- Radiating nodes -->
            <g class="converging-nodes" transform-origin="200 200">
              <!-- Inner ring nodes -->
              <circle cx="280" cy="200" r="8" fill="#9d7bff" opacity="0.9"/>
              <circle cx="200" cy="120" r="8" fill="#9d7bff" opacity="0.9"/>
              <circle cx="120" cy="200" r="8" fill="#9d7bff" opacity="0.9"/>
              <circle cx="200" cy="280" r="8" fill="#9d7bff" opacity="0.9"/>
              
              <!-- Middle ring nodes -->
              <circle cx="320" cy="200" r="6" fill="#7b5fff" opacity="0.7"/>
              <circle cx="260" cy="140" r="6" fill="#7b5fff" opacity="0.7"/>
              <circle cx="200" cy="80" r="6" fill="#7b5fff" opacity="0.7"/>
              <circle cx="140" cy="140" r="6" fill="#7b5fff" opacity="0.7"/>
              <circle cx="80" cy="200" r="6" fill="#7b5fff" opacity="0.7"/>
              <circle cx="140" cy="260" r="6" fill="#7b5fff" opacity="0.7"/>
              <circle cx="200" cy="320" r="6" fill="#7b5fff" opacity="0.7"/>
              <circle cx="260" cy="260" r="6" fill="#7b5fff" opacity="0.7"/>
              
              <!-- Outer ring nodes -->
              <circle cx="360" cy="200" r="4" fill="#6b46ff" opacity="0.5"/>
              <circle cx="320" cy="120" r="4" fill="#6b46ff" opacity="0.5"/>
              <circle cx="200" cy="40" r="4" fill="#6b46ff" opacity="0.5"/>
              <circle cx="80" cy="120" r="4" fill="#6b46ff" opacity="0.5"/>
              <circle cx="40" cy="200" r="4" fill="#6b46ff" opacity="0.5"/>
              <circle cx="80" cy="280" r="4" fill="#6b46ff" opacity="0.5"/>
              <circle cx="200" cy="360" r="4" fill="#6b46ff" opacity="0.5"/>
              <circle cx="320" cy="280" r="4" fill="#6b46ff" opacity="0.5"/>
            </g>
            
            <!-- Connecting lines -->
            <g class="connections" opacity="0.3">
              <line x1="200" y1="200" x2="280" y2="200" stroke="#9d7bff" stroke-width="1"/>
              <line x1="200" y1="200" x2="200" y2="120" stroke="#9d7bff" stroke-width="1"/>
              <line x1="200" y1="200" x2="120" y2="200" stroke="#9d7bff" stroke-width="1"/>
              <line x1="200" y1="200" x2="200" y2="280" stroke="#9d7bff" stroke-width="1"/>
              <line x1="200" y1="200" x2="260" y2="140" stroke="#7b5fff" stroke-width="0.5"/>
              <line x1="200" y1="200" x2="140" y2="140" stroke="#7b5fff" stroke-width="0.5"/>
              <line x1="200" y1="200" x2="140" y2="260" stroke="#7b5fff" stroke-width="0.5"/>
              <line x1="200" y1="200" x2="260" y2="260" stroke="#7b5fff" stroke-width="0.5"/>
            </g>
            
            <!-- Pulsing center -->
            <circle cx="200" cy="200" r="15" fill="#e6d9ff" class="pulse-core"/>
          </svg>
        </div>
        
        <div class="intro-text">
          <h2>Radical Simplicity, Focused Power</h2>
          <p>
            Majeur is a minimal framework to manage digital organizations.
            Built on battle-tested governance primitives, flexible with modular code, 
            with new ways to reward good governance with real ownership.
          </p>
          <p class="intro-highlight">
            Deploy your DAO in minutes. Govern with clarity. Own your decisions.
          </p>
        </div>
        
        <div class="scroll-hint" onclick="document.getElementById('seats').scrollIntoView({ behavior: 'smooth' });">
          <span>Explore the Features</span>
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 5v14M19 12l-7 7-7-7"/>
          </svg>
        </div>
      </div>
    </section>

    <!-- Central thread continuation -->
    <div style="position: relative; width: 100%; height: 2px; margin: -1px 0; pointer-events: none;">
      <div style="position: absolute; left: 50%; transform: translateX(-50%); width: 1px; height: 100%; background: rgba(230, 217, 255, 0.08);"></div>
    </div>

    <!-- Feature pages -->
    <main class="features">
      <!-- 01: SEATS (Badges / SBT top-256) -->
      <section class="feature-page" id="seats">
        <div class="feature-inner">
          <div class="feature-left">
            <div class="feature-tag">Majeur Feature 01</div>
            <h2 class="feature-title" data-word="SEATS">SEATS</h2>
            <p class="feature-copy">
              The top 256 holders crystallize into <em>soulbound seats</em> –
              ERC-721 badges that auto-reassign as balances move. The bitmap
              scoreboard is maintained entirely on-chain: badges burn and remint
              as the cutline shifts, so the "inner circle" is always live.
            </p>
            <div class="feature-meta">Top-256 SBT badges · Dynamic ranking</div>
          </div>

          <div class="feature-right">
            <svg
              class="feature-art"
              viewBox="0 0 320 320"
              xmlns="http://www.w3.org/2000/svg"
            >
              <circle
                cx="160"
                cy="160"
                r="120"
                fill="none"
                stroke="#9d7bff"
                stroke-width="1"
                opacity="0.6"
              />
              <circle
                cx="160"
                cy="160"
                r="84"
                fill="none"
                stroke="#e6d9ff"
                stroke-width="0.8"
                opacity="0.7"
              />
              <circle cx="160" cy="160" r="4" fill="#e6d9ff" opacity="0.9" />

              <!-- Radial "seat" ticks -->
              <g stroke="#e6d9ff" stroke-width="0.6" opacity="0.8">
                <line x1="160" y1="34" x2="160" y2="44" />
                <line x1="160" y1="276" x2="160" y2="266" />
                <line x1="34" y1="160" x2="44" y2="160" />
                <line x1="276" y1="160" x2="266" y2="160" />
                <line x1="80" y1="80" x2="88" y2="88" />
                <line x1="240" y1="80" x2="232" y2="88" />
                <line x1="80" y1="240" x2="88" y2="232" />
                <line x1="240" y1="240" x2="232" y2="232" />
              </g>

              <!-- Orbiting "filled seats" -->
              <g fill="#e6d9ff">
                <circle cx="160" cy="40" r="3" />
                <circle cx="256" cy="160" r="3" />
                <circle cx="160" cy="280" r="3" />
                <circle cx="64" cy="160" r="3" />
              </g>

              <!-- Crown-like arc for "top" seats -->
              <path
                d="M110 112 Q160 60 210 112"
                fill="none"
                stroke="#e6d9ff"
                stroke-width="1"
                opacity="0.8"
              />
              <circle cx="132" cy="104" r="2.4" fill="#e6d9ff" />
              <circle cx="188" cy="104" r="2.4" fill="#e6d9ff" />
            </svg>
          </div>
        </div>
      </section>

      <!-- 02: SPLIT (weighted delegation) -->
      <section class="feature-page" id="split">
        <div class="feature-inner">
          <div class="feature-left">
            <div class="feature-tag">Majeur Feature 02</div>
            <h2 class="feature-title" data-word="SPLIT">SPLIT</h2>
            <p class="feature-copy">
              Voting power doesn't have to follow a single delegate. Each holder
              can fan out to up to four delegates in basis-point slices, with
              exact rebalancing on every transfer. Growing their advisory.
            </p>
            <div class="feature-meta">
              Weighted delegation · Up to four delegates
            </div>
          </div>

          <div class="feature-right">
            <svg
              class="feature-art"
              viewBox="0 0 320 320"
              xmlns="http://www.w3.org/2000/svg"
            >
              <!-- Source node -->
              <circle
                cx="80"
                cy="160"
                r="10"
                fill="none"
                stroke="#e6d9ff"
                stroke-width="1.2"
              />
              <circle cx="80" cy="160" r="3" fill="#e6d9ff" />

              <!-- Delegate nodes -->
              <circle
                cx="240"
                cy="80"
                r="9"
                fill="none"
                stroke="#9d7bff"
                stroke-width="1"
              />
              <circle cx="240" cy="80" r="3" fill="#e6d9ff" />
              <circle
                cx="260"
                cy="148"
                r="9"
                fill="none"
                stroke="#9d7bff"
                stroke-width="1"
              />
              <circle cx="260" cy="148" r="3" fill="#e6d9ff" />
              <circle
                cx="240"
                cy="220"
                r="9"
                fill="none"
                stroke="#9d7bff"
                stroke-width="1"
              />
              <circle cx="240" cy="220" r="3" fill="#e6d9ff" />
              <circle
                cx="210"
                cy="160"
                r="9"
                fill="none"
                stroke="#9d7bff"
                stroke-width="1"
              />
              <circle cx="210" cy="160" r="3" fill="#e6d9ff" />

              <!-- Splitting paths -->
              <path
                d="M90 160 C140 110 190 96 232 84"
                fill="none"
                stroke="#e6d9ff"
                stroke-width="0.9"
              />
              <path
                d="M90 160 C150 148 205 144 250 148"
                fill="none"
                stroke="#e6d9ff"
                stroke-width="0.9"
              />
              <path
                d="M90 160 C140 210 190 224 232 220"
                fill="none"
                stroke="#e6d9ff"
                stroke-width="0.9"
              />
              <path
                d="M90 160 C150 160 185 160 201 160"
                fill="none"
                stroke="#e6d9ff"
                stroke-width="0.9"
              />

              <!-- BPS rings -->
              <circle
                cx="80"
                cy="160"
                r="32"
                fill="none"
                stroke="#9d7bff"
                stroke-dasharray="4 6"
                stroke-width="0.7"
                opacity="0.7"
              />
            </svg>
          </div>
        </div>
      </section>

      <!-- 03: PERMIT (one-shot intent receipts) -->
      <section class="feature-page" id="permit">
        <div class="feature-inner">
          <div class="feature-left">
            <div class="feature-tag">Majeur Feature 03</div>
            <h2 class="feature-title" data-word="PERMIT">PERMIT</h2>
            <p class="feature-copy">
              The DAO can mint one-shot ERC-6909 "permit receipts" for arbitrary
              calls. Each token is an intent hash: burn exactly one, execute
              exactly once. Permits are soulbound, and plug
              straight into the same execution path as voted proposals. 
              Great for emergency switches and agents.
            </p>
            <div class="feature-meta">ERC-6909 receipts · One-shot ops</div>
          </div>

          <div class="feature-right">
            <svg
              class="feature-art"
              viewBox="0 0 320 320"
              xmlns="http://www.w3.org/2000/svg"
            >
              <!-- Tablet -->
              <rect
                x="90"
                y="60"
                width="140"
                height="200"
                rx="16"
                ry="16"
                fill="none"
                stroke="#e6d9ff"
                stroke-width="1.1"
                opacity="0.9"
              />
              <rect
                x="102"
                y="82"
                width="116"
                height="160"
                rx="8"
                ry="8"
                fill="none"
                stroke="#9d7bff"
                stroke-width="0.9"
                opacity="0.8"
              />

              <!-- Keyhole glyph -->
              <circle
                cx="160"
                cy="132"
                r="13"
                fill="none"
                stroke="#e6d9ff"
                stroke-width="1"
              />
              <circle cx="160" cy="128" r="4" fill="#e6d9ff" />
              <path
                d="M160 136 L160 152"
                stroke="#e6d9ff"
                stroke-width="1.1"
                stroke-linecap="round"
              />

              <!-- Hash lines -->
              <g stroke="#9d7bff" stroke-width="0.7" opacity="0.7">
                <line x1="120" y1="182" x2="200" y2="182" />
                <line x1="120" y1="196" x2="184" y2="196" />
                <line x1="120" y1="210" x2="176" y2="210" />
              </g>

              <!-- "Burn" triangle -->
              <polygon
                points="64,228 92,260 36,260"
                fill="none"
                stroke="#e6d9ff"
                stroke-width="0.9"
                opacity="0.75"
              />
              <path
                d="M64 236 Q60 244 65 252"
                stroke="#e6d9ff"
                stroke-width="0.8"
                fill="none"
              />

              <!-- One-way arrow -->
              <polyline
                points="226,92 248,80 260,102"
                fill="none"
                stroke="#e6d9ff"
                stroke-width="0.9"
              />
            </svg>
          </div>
        </div>
      </section>

      <!-- 04: FUTARCHY -->
      <section class="feature-page" id="futarchy">
        <div class="feature-inner">
          <div class="feature-left">
            <div class="feature-tag">Majeur Feature 04</div>
            <h2 class="feature-title" data-word="FUTARCHY">FUTARCHY</h2>
            <p class="feature-copy">
              Every proposal can grow a prediction market around it. Where each vote is a token. 
              Vote receipts double as long/short claims on a reward pool, auto-funded
              from shares or loot. When the proposal resolves YES or NO, the
              winning side burns receipts to cash out their slice of the pot.
            </p>
            <div class="feature-meta">
              Market-priced governance · Auto-funded pots
            </div>
          </div>

          <div class="feature-right">
            <svg
              class="feature-art"
              viewBox="0 0 320 320"
              xmlns="http://www.w3.org/2000/svg"
            >
              <!-- Axis -->
              <line
                x1="60"
                y1="240"
                x2="260"
                y2="240"
                stroke="#e6d9ff"
                stroke-width="0.8"
              />
              <line
                x1="80"
                y1="70"
                x2="80"
                y2="252"
                stroke="#e6d9ff"
                stroke-width="0.8"
              />

              <!-- Curves for YES / NO markets -->
              <path
                d="M80 220 C120 180 160 160 210 130"
                fill="none"
                stroke="#e6d9ff"
                stroke-width="1"
              />
              <path
                d="M80 230 C120 210 170 205 230 190"
                fill="none"
                stroke="#9d7bff"
                stroke-width="1"
                stroke-dasharray="5 6"
                opacity="0.9"
              />

              <!-- Outcome nodes -->
              <circle cx="214" cy="132" r="5" fill="#e6d9ff" />
              <circle cx="232" cy="190" r="4" fill="#9d7bff" />

              <!-- Proposal orbit -->
              <circle
                cx="160"
                cy="140"
                r="80"
                fill="none"
                stroke="#9d7bff"
                stroke-width="0.7"
                opacity="0.55"
              />
              <circle cx="160" cy="140" r="3" fill="#e6d9ff" />

              <!-- Pool glyph -->
              <rect
                x="196"
                y="212"
                width="60"
                height="18"
                rx="6"
                fill="none"
                stroke="#e6d9ff"
                stroke-width="0.8"
              />
              <line
                x1="202"
                y1="220"
                x2="248"
                y2="220"
                stroke="#e6d9ff"
                stroke-width="0.8"
              />
            </svg>
          </div>
        </div>
      </section>

      <!-- 05: RAGEQUIT -->
      <section class="feature-page" id="ragequit">
        <div class="feature-inner">
          <div class="feature-left">
            <div class="feature-tag">Majeur Feature 05</div>
            <h2 class="feature-title" data-word="RAGEQUIT">RAGEQUIT</h2>
            <p class="feature-copy">
              Exit remains sacred. When ragequit is enabled, members burn shares
              and loot to pull a pro-rata slice of ETH and ERC-20 reserves,
              across a basket they choose.
            </p>
            <div class="feature-meta">
              Multi-asset exits · Shares + loot basis
            </div>
          </div>

          <div class="feature-right">
            <svg
              class="feature-art"
              viewBox="0 0 320 320"
              xmlns="http://www.w3.org/2000/svg"
            >
              <!-- Broken circle -->
              <path
                d="M90 160 A70 70 0 1 1 230 160"
                fill="none"
                stroke="#e6d9ff"
                stroke-width="1"
              />
              <path
                d="M90 160 A70 70 0 0 1 130 100"
                fill="none"
                stroke="#9d7bff"
                stroke-width="1.1"
              />

              <!-- Wedge leaving -->
              <path
                d="M160 90 L200 96 A70 70 0 0 0 182 70 Z"
                fill="none"
                stroke="#e6d9ff"
                stroke-width="0.9"
              />

              <!-- Asset bars -->
              <rect
                x="70"
                y="210"
                width="36"
                height="16"
                rx="4"
                fill="none"
                stroke="#e6d9ff"
                stroke-width="0.8"
              />
              <rect
                x="116"
                y="204"
                width="36"
                height="22"
                rx="4"
                fill="none"
                stroke="#9d7bff"
                stroke-width="0.8"
              />
              <rect
                x="162"
                y="214"
                width="36"
                height="12"
                rx="4"
                fill="none"
                stroke="#e6d9ff"
                stroke-width="0.8"
              />
              <rect
                x="208"
                y="208"
                width="36"
                height="20"
                rx="4"
                fill="none"
                stroke="#9d7bff"
                stroke-width="0.8"
              />

              <!-- Flow arrows -->
              <polyline
                points="132,190 132,176 90,176"
                fill="none"
                stroke="#e6d9ff"
                stroke-width="0.8"
              />
              <polyline
                points="180,188 180,172 222,172"
                fill="none"
                stroke="#e6d9ff"
                stroke-width="0.8"
              />
            </svg>
          </div>
        </div>
      </section>

      <!-- 06: SALE -->
      <section class="feature-page" id="sale">
        <div class="feature-inner">
          <div class="feature-left">
            <div class="feature-tag">Majeur Feature 06</div>
            <h2 class="feature-title" data-word="SALE">SALE (DAICO)</h2>
            <p class="feature-copy">
              Fixed-price sales live directly on the DAO. Governance chooses the
              pay token, price, caps, and whether new shares/loot are minted or
              sold from the treasury. No separate sale contracts, no extra
              attack surface – just one primitive wired into the core.
            </p>
            <div class="feature-meta">Treasury-aware sales · ETH or ERC-20</div>
          </div>

          <div class="feature-right">
            <svg
              class="feature-art"
              viewBox="0 0 320 320"
              xmlns="http://www.w3.org/2000/svg"
            >
              <!-- Coin stack -->
              <ellipse
                cx="120"
                cy="210"
                rx="34"
                ry="10"
                fill="none"
                stroke="#e6d9ff"
                stroke-width="0.9"
              />
              <ellipse
                cx="120"
                cy="198"
                rx="34"
                ry="10"
                fill="none"
                stroke="#e6d9ff"
                stroke-width="0.9"
              />
              <ellipse
                cx="120"
                cy="186"
                rx="34"
                ry="10"
                fill="none"
                stroke="#e6d9ff"
                stroke-width="0.9"
              />

              <!-- Price tag -->
              <rect
                x="184"
                y="140"
                width="60"
                height="32"
                rx="6"
                fill="none"
                stroke="#9d7bff"
                stroke-width="0.9"
              />
              <circle cx="192" cy="156" r="2.4" fill="#e6d9ff" />
              <path
                d="M202 160 H236"
                stroke="#e6d9ff"
                stroke-width="0.9"
                stroke-linecap="round"
              />
              <path
                d="M202 150 H230"
                stroke="#e6d9ff"
                stroke-width="0.9"
                stroke-linecap="round"
              />

              <!-- Flow arrows -->
              <polyline
                points="152,178 184,164 184,140"
                fill="none"
                stroke="#e6d9ff"
                stroke-width="0.9"
              />
              <polyline
                points="212,196 184,204 152,198"
                fill="none"
                stroke="#e6d9ff"
                stroke-width="0.9"
              />
            </svg>
          </div>
        </div>
      </section>

      <!-- 07: CHANT (SBT-gated chat) -->
      <section class="feature-page" id="chant">
        <div class="feature-inner">
          <div class="feature-left">
            <div class="feature-tag">Majeur Feature 07</div>
            <h2 class="feature-title" data-word="CHANT">CHANT</h2>
            <p class="feature-copy">
              A badge-gated message feed lives inside the contract. Only
              seat-holders can emit on-chain messages, but anyone can read the
              log. The chat becomes another programmable surface for the
              renderer: council graffiti, soft signaling, or just ritual noise.
            </p>
            <div class="feature-meta">
              SBT-gated chat · On-chain social layer
            </div>
          </div>

          <div class="feature-right">
            <svg
              class="feature-art"
              viewBox="0 0 320 320"
              xmlns="http://www.w3.org/2000/svg"
            >
              <!-- Dialog bubble -->
              <path
                d="M90 108 H222 A18 18 0 0 1 240 126 V170 A18 18 0 0 1 222 188 H146 L120 210 L122 188 H90 A18 18 0 0 1 72 170 V126 A18 18 0 0 1 90 108 Z"
                fill="none"
                stroke="#e6d9ff"
                stroke-width="1"
              />

              <!-- Lines -->
              <line
                x1="104"
                y1="132"
                x2="214"
                y2="132"
                stroke="#e6d9ff"
                stroke-width="0.9"
              />
              <line
                x1="104"
                y1="148"
                x2="196"
                y2="148"
                stroke="#e6d9ff"
                stroke-width="0.9"
              />
              <line
                x1="104"
                y1="164"
                x2="180"
                y2="164"
                stroke="#e6d9ff"
                stroke-width="0.9"
              />

              <!-- Orbiting runes -->
              <circle
                cx="80"
                cy="220"
                r="4"
                fill="none"
                stroke="#9d7bff"
                stroke-width="0.9"
              />
              <circle
                cx="240"
                cy="96"
                r="4"
                fill="none"
                stroke="#9d7bff"
                stroke-width="0.9"
              />
              <circle cx="92" cy="84" r="3" fill="#e6d9ff" opacity="0.9" />
              <circle cx="238" cy="214" r="3" fill="#e6d9ff" opacity="0.9" />

              <circle
                cx="160"
                cy="160"
                r="110"
                fill="none"
                stroke="#9d7bff"
                stroke-width="0.6"
                stroke-dasharray="6 10"
                opacity="0.4"
              />
            </svg>
          </div>
        </div>
      </section>
    </main>

    <!-- SUMMONER SECTION -->
    <section class="summoner-section" id="summoner">
      <div class="summoner-container">
        <h2 class="summoner-title">Summon DAO</h2>
        <p class="summoner-subtitle">Deploy your Moloch Majeur on Ethereum</p>
        
        <form id="summonForm">
          <!-- Basic Info -->
          <div class="form-group">
            <label class="form-label">DAO Name</label>
            <input type="text" class="form-input" id="daoName" placeholder="e.g., MetaGuild" required minlength="2" maxlength="50">
            <span class="form-hint">2-50 characters</span>
          </div>

          <div class="form-group">
            <label class="form-label">DAO Symbol</label>
            <input type="text" class="form-input" id="daoSymbol" placeholder="e.g., META" maxlength="10" required>
          </div>

          <!-- Quorum Settings -->
          <div class="form-group">
            <label class="form-label">Quorum %</label>
            <input type="number" class="form-input" id="quorumBps" placeholder="50" min="0" max="100" value="50">
            <small style="color: rgba(230, 217, 255, 0.5); font-size: 0.8rem;">Percentage of votes needed for proposal validity</small>
          </div>

          <!-- Members -->
          <div class="form-group">
            <label class="form-label">Founding Members</label>
            <div class="members-container">
              <div id="foundingMembersList">
                <!-- Initial member (connected wallet) will be added by JS -->
              </div>
              <button type="button" class="add-member-btn" onclick="addMemberRow()">+ Add Member</button>
            </div>
          </div>

          <!-- Advanced Settings -->
          <div class="advanced-toggle" onclick="toggleAdvanced()">
            ▼ Advanced Settings
          </div>

          <div class="advanced-settings" id="advancedSettings">
            <div class="form-group">
              <label class="form-label checkbox-group">
                <input type="checkbox" id="ragequittable" checked>
                <span>Enable Ragequit</span>
              </label>
              <small style="color: rgba(230, 217, 255, 0.5); font-size: 0.8rem;">Allow members to exit with pro-rata treasury</small>
            </div>

            <div class="form-group">
              <label class="form-label checkbox-group">
                <input type="checkbox" id="distributeLoot">
                <span>Distribute Loot to Founders</span>
              </label>
              <div id="lootDistribution" style="display: none; margin-top: 0.5rem;">
                <div style="margin-bottom: 0.5rem;">
                  <label class="form-label checkbox-group">
                    <input type="checkbox" id="equalLoot" checked>
                    <span style="font-size: 0.9rem;">Equal distribution</span>
                  </label>
                </div>
                <input type="number" class="form-input" id="lootPerMember" placeholder="100" value="100" min="0.000000000000000001" step="any">
                <small style="color: rgba(230, 217, 255, 0.5); font-size: 0.8rem;">Loot tokens per member (or total if custom)</small>
                <div id="customLootAmounts" style="margin-top: 1rem; display: none;">
                  <!-- Will be populated with inputs for each member -->
                </div>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Proposal TTL</label>
              <div style="display: flex; gap: 0.5rem; align-items: center;">
                <input type="number" class="form-input" id="proposalTTL" placeholder="7" value="7" style="flex: 1;">
                <select class="form-input" id="proposalTTLUnit" style="width: auto;">
                  <option value="86400" selected>Days</option>
                  <option value="3600">Hours</option>
                  <option value="60">Minutes</option>
                  <option value="1">Seconds</option>
                </select>
              </div>
              <small style="color: rgba(230, 217, 255, 0.5); font-size: 0.8rem;">Time until proposals expire</small>
            </div>

            <div class="form-group">
              <label class="form-label">Timelock Delay</label>
              <div style="display: flex; gap: 0.5rem; align-items: center;">
                <input type="number" class="form-input" id="timelockDelay" placeholder="1" value="1" style="flex: 1;">
                <select class="form-input" id="timelockDelayUnit" style="width: auto;">
                  <option value="86400" selected>Days</option>
                  <option value="3600">Hours</option>
                  <option value="60">Minutes</option>
                  <option value="1">Seconds</option>
                </select>
              </div>
              <small style="color: rgba(230, 217, 255, 0.5); font-size: 0.8rem;">Delay between proposal passing and execution</small>
            </div>

            <div class="form-group">
              <label class="form-label">Proposal Threshold (optional)</label>
              <input type="number" class="form-input" id="proposalThreshold" placeholder="0" min="0" step="1">
              <small style="color: rgba(230, 217, 255, 0.5); font-size: 0.8rem;">Minimum shares required to create a proposal (cannot exceed total initial shares)</small>
            </div>

            <div class="form-group">
              <label class="form-label">URI (optional)</label>
              <input type="text" class="form-input" id="daoURI" placeholder="https://ipfs.io/ipfs/...">
            </div>

            <div class="form-group">
              <label class="checkbox-container">
                <input type="checkbox" id="enableSharesTransfer">
                <span>Enable Shares Transferability</span>
              </label>
              <small style="color: rgba(230, 217, 255, 0.5); font-size: 0.8rem;">Allow shares to be transferred</small>
            </div>

            <div class="form-group">
              <label class="checkbox-container">
                <input type="checkbox" id="enableLootTransfer">
                <span>Enable Loot Transferability</span>
              </label>
              <small style="color: rgba(230, 217, 255, 0.5); font-size: 0.8rem;">Allow loot to be transferred</small>
            </div>

            <div class="form-group">
              <label class="form-label">Auto-Futarchy (Voter Rewards)</label>
              <select class="form-input" id="autoFutarchyPreset">
                <option value="off" selected>Off</option>
                <option value="low">Low: 0.05% supply, 2 LOOT cap</option>
                <option value="standard">Standard: 0.1% supply, 5 LOOT cap</option>
                <option value="high">High: 0.5% supply, 10 LOOT cap</option>
              </select>
              <small style="color: rgba(230, 217, 255, 0.5); font-size: 0.8rem;">Mint LOOT rewards for winning voters (% of shares+loot supply, capped per proposal)</small>
            </div>

            <div class="form-group">
              <label class="form-label">Initial Token Sale (DAICO)</label>
              <select class="form-input" id="initialSalePreset" onchange="toggleSaleConfig()">
                <option value="off" selected>Off (No initial sale)</option>
                <option value="custom">Custom Sale Configuration</option>
              </select>
              <small style="color: rgba(230, 217, 255, 0.5); font-size: 0.8rem;">Launch with an active token sale for fundraising</small>
            </div>

            <div id="saleConfigSection" style="display: none; margin-top: 1rem; padding: 1rem; background: rgba(157, 123, 255, 0.05); border: 1px solid rgba(157, 123, 255, 0.2); border-radius: 4px;">
              <div class="form-group">
                <label class="form-label">Payment Token</label>
                <select class="form-input" id="salePaymentToken">
                  <option value="eth">ETH</option>
                  <option value="usdc">USDC</option>
                  <option value="usdt">USDT</option>
                  <option value="dai">DAI</option>
                  <option value="wsteth">wstETH</option>
                  <option value="reth">rETH</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label">Token Type</label>
                <select class="form-input" id="saleTokenType">
                  <option value="shares">Shares (voting power)</option>
                  <option value="loot">Loot (non-voting)</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label">Price per Token</label>
                <input type="number" class="form-input" id="salePrice" placeholder="e.g., 0.1" step="any" min="0">
                <small style="color: rgba(230, 217, 255, 0.5); font-size: 0.8rem;">Price in payment token per share/loot</small>
              </div>

              <div class="form-group">
                <label class="form-label">Sale Cap (optional)</label>
                <input type="number" class="form-input" id="saleCap" placeholder="0 for unlimited" step="any" min="0">
                <small style="color: rgba(230, 217, 255, 0.5); font-size: 0.8rem;">Maximum tokens to sell (0 = unlimited)</small>
              </div>

              <div class="form-group">
                <label class="checkbox-container">
                  <input type="checkbox" id="saleMinting" checked>
                  <span>Mint New Tokens</span>
                </label>
                <small style="color: rgba(230, 217, 255, 0.5); font-size: 0.8rem;">If unchecked, will sell from DAO treasury (requires pre-allocated tokens)</small>
              </div>
            </div>
          </div>

          <button type="submit" class="summon-button" id="summonBtn" disabled>
            CONNECT WALLET TO SUMMON
          </button>
        </form>

        <div id="statusMessage"></div>
      </div>
    </section>

    <!-- PURCHASE MODAL -->
    <div class="wallet-modal-overlay" id="purchaseModal">
      <div class="wallet-modal" style="max-width: 500px;">
        <div class="wallet-modal-header">
          <h3 style="font-family: 'Cinzel', serif; font-size: 1.2rem; color: #e6d9ff; letter-spacing: 0.1em;">Purchase Tokens</h3>
          <button onclick="closePurchaseModal()" style="background: none; border: none; color: rgba(230, 217, 255, 0.6); cursor: pointer; font-size: 1.5rem;">&times;</button>
        </div>
        <div style="padding: 1.5rem;">
          <div id="purchaseModalContent"></div>
        </div>
      </div>
    </div>

    <!-- DAO GALLERY SECTION -->
    <section class="dao-gallery-section" id="daoGallery">
      <div class="dao-gallery-header">
        <h2 class="dao-gallery-title">Your DAOs</h2>
        <p class="dao-gallery-subtitle">Majeur organizations you belong to</p>
      </div>
      <div class="dao-tiles" id="daoTiles">
        <!-- DAO tiles will be dynamically rendered here -->
      </div>
    </section>

    <!-- ALL DAOS GALLERY SECTION -->
    <section class="all-daos-section" id="allDaosGallery">
      <div class="all-daos-header">
        <h2 class="all-daos-title">All DAOs</h2>
        <p class="all-daos-subtitle">Explore all Majeur organizations</p>
      </div>
      <div class="dao-tiles" id="allDaosTiles">
        <!-- All DAO tiles will be dynamically rendered here -->
      </div>
    </section>

    <!-- DAO DASHBOARD SECTION -->
    <section class="dao-dashboard" id="daoDashboard">
      <div class="dao-dashboard-header">
        <div style="display: flex; align-items: center; gap: 1rem;">
          <div id="daoEmblem" class="dao-emblem" style="display: none;" title="DAO Contract URI">
            <!-- DAO emblem will be rendered here -->
          </div>
          <div>
            <h2 class="dao-dashboard-title" id="dashboardTitle">DAO Dashboard</h2>
            <a class="dao-etherscan-link" id="daoEtherscanLink" href="#" target="_blank" rel="noopener noreferrer">
              <span id="daoAddressText">0x...</span>
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                <polyline points="15 3 21 3 21 9"></polyline>
                <line x1="10" y1="14" x2="21" y2="3"></line>
              </svg>
            </a>
            <div class="dao-stats-bar" id="daoStatsBar">
              <!-- Stats will be dynamically rendered here -->
            </div>
          </div>
        </div>
        <button class="back-button" onclick="backToGallery()">← Back to Gallery</button>
      </div>

      <!-- View Toggle -->
      <div class="dao-view-toggle">
        <button class="view-toggle-btn active" id="viewToggleDao" onclick="switchDaoView('dao')">DAO Dashboard</button>
        <button class="view-toggle-btn" id="viewToggleMembership" onclick="switchDaoView('membership')">My Membership</button>
        <button class="view-toggle-btn" id="viewToggleMembers" onclick="switchDaoView('members')">Members</button>
      </div>

      <!-- DAO Dashboard Content -->
      <div class="dao-dashboard-content show" id="daoDashboardView">
        <!-- Chatroom Panel -->
        <div class="dao-panel">
          <h3 class="dao-panel-title">Chatroom</h3>
          <div class="chatroom-messages" id="chatroomMessages">
            <!-- Messages will be dynamically rendered here -->
          </div>
          <div class="chatroom-send">
            <input
              type="text"
              id="chatInput"
              class="chatroom-input"
              placeholder="Type a message..."
            />
            <button class="chatroom-button" onclick="sendChatMessage()">Send</button>
          </div>

          <!-- Treasury Section -->
          <div class="treasury-section">
            <h4 class="treasury-title">Treasury</h4>
            <div class="treasury-assets" id="treasuryAssets">
              <!-- Treasury assets will be dynamically rendered here -->
            </div>
            <button class="ragequit-button" onclick="openRagequitModal()">Ragequit</button>
          </div>

          <!-- Governance Info Section -->
          <div class="treasury-section" style="margin-top: 1.5rem;">
            <h4 class="treasury-title">Governance</h4>
            <div id="governanceInfo" style="font-size: 0.85rem; color: rgba(230, 217, 255, 0.8); line-height: 1.6;">
              <!-- Governance info will be dynamically rendered here -->
            </div>
          </div>

          <!-- Sales Section -->
          <div id="salesSection" class="treasury-section" style="margin-top: 1.5rem; display: none;">
            <h4 class="treasury-title">
              Active Sales
              <a href="#" onclick="event.preventDefault(); prepareSaleProposal(); switchDaoView('dao');" title="Configure token sale" onmouseover="this.style.opacity='1'; this.style.transform='translateY(-1px)';" onmouseout="this.style.opacity='0.5'; this.style.transform='translateY(0)';" style="margin-left: 0.5rem; color: #9d7bff; opacity: 0.5; transition: all 0.2s; font-size: 0.75rem; text-decoration: none;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle;">
                  <circle cx="9" cy="21" r="1"></circle>
                  <circle cx="20" cy="21" r="1"></circle>
                  <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                </svg>
              </a>
            </h4>
            <div id="salesInfo">
              <!-- Active sales will be dynamically rendered here -->
            </div>
          </div>
        </div>

        <!-- Proposals Panel -->
        <div class="dao-panel">
          <h3 class="dao-panel-title">Proposals</h3>

          <!-- New Proposal Form -->
          <div class="proposal-form">
            <h4 class="proposal-form-title">Create Proposal</h4>
            <input type="hidden" id="proposalOp" value="0" />
            <div class="proposal-form-group">
              <label class="proposal-form-label">Target Address</label>
              <input type="text" id="proposalTo" class="proposal-form-input" placeholder="0x..." oninput="updateTargetAddressHint()" />
              <div id="targetAddressHint" style="margin-top: 0.35rem; display: none;">
                <span id="targetAddressHintBadge" style="display: inline-block; padding: 0.25rem 0.5rem; background: rgba(157, 123, 255, 0.15); border: 1px solid rgba(157, 123, 255, 0.3); border-radius: 3px; font-size: 0.7rem; color: #9d7bff; font-family: 'Cinzel', serif; letter-spacing: 0.1em;"></span>
              </div>
            </div>
            <div class="proposal-form-group" id="proposalValueGroup">
              <label class="proposal-form-label">Value (ETH)</label>
              <input type="text" id="proposalValue" class="proposal-form-input" placeholder="0" />
            </div>
            <div class="proposal-form-group">
              <label class="proposal-form-label">Data (hex)</label>
              <input type="text" id="proposalData" class="proposal-form-input" placeholder="0x" oninput="updateCalldataPreview(); updateCalldataTranslation();" />
              <div id="calldataTranslation" style="margin-top: 0.5rem; display: none; padding: 0.75rem; background: rgba(157, 123, 255, 0.1); border-left: 3px solid #9d7bff; font-size: 0.85rem;"></div>
              <div id="calldataPreview" style="margin-top: 0.5rem; display: none;">
                <a id="calldataPreviewLink" href="#" target="_blank" rel="noopener noreferrer"
                   style="font-size: 0.75rem; color: #9d7bff; text-decoration: none; display: inline-flex; align-items: center; gap: 0.35rem; opacity: 0.75; transition: opacity 0.3s ease;"
                   onmouseover="this.style.opacity='1'"
                   onmouseout="this.style.opacity='0.75'">
                  <span>🔍</span> Decode calldata on SwissKnife
                </a>
              </div>
            </div>
            <div class="proposal-form-group">
              <label class="proposal-form-label">Description</label>
              <textarea id="proposalDescription" class="proposal-form-input proposal-form-textarea" placeholder="Describe the proposal..."></textarea>
            </div>
            <button class="chatroom-button" onclick="createProposal()">Create & Publish</button>
          </div>

          <!-- Proposals List -->
          <div id="proposalsList">
            <!-- Proposals will be dynamically rendered here -->
          </div>
        </div>
      </div>

      <!-- Membership Dashboard Content -->
      <div class="dao-membership-content" id="daoMembershipView">
        <div class="membership-grid">
          <!-- Badge Card -->
          <div class="badge-card">
            <h3 class="dao-panel-title">Member Badge</h3>
            <div id="badgeContent">
              <p style="text-align: center; color: rgba(230, 217, 255, 0.6); font-style: italic;">Loading...</p>
            </div>
          </div>

          <!-- Balances Card -->
          <div class="balance-card">
            <h3 class="dao-panel-title">Your Balances</h3>
            <div class="balance-item">
              <div class="balance-label">
                Voting Shares
                <a id="sharesEtherscanLink" href="#" target="_blank" rel="noopener noreferrer" style="margin-left: 0.35rem; color: #9d7bff; opacity: 0.7; transition: all 0.2s; display: none;">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                    <polyline points="15 3 21 3 21 9"></polyline>
                    <line x1="10" y1="14" x2="21" y2="3"></line>
                  </svg>
                </a>
                <a href="#" onclick="event.preventDefault(); prepareMintProposal('shares'); switchDaoView('dao');" title="Create mint shares proposal" onmouseover="this.style.opacity='1'; this.style.transform='translateY(-1px)';" onmouseout="this.style.opacity='0.5'; this.style.transform='translateY(0)';" style="margin-left: 0.35rem; color: #9d7bff; opacity: 0.5; transition: all 0.2s; font-size: 0.75rem; text-decoration: none;">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle;">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="16"></line>
                    <line x1="8" y1="12" x2="16" y2="12"></line>
                  </svg>
                </a>
              </div>
              <div class="balance-value" id="membershipShares">0</div>
            </div>
            <div class="balance-item">
              <div class="balance-label">
                Loot
                <a id="lootEtherscanLink" href="#" target="_blank" rel="noopener noreferrer" style="margin-left: 0.35rem; color: #9d7bff; opacity: 0.7; transition: all 0.2s; display: none;">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                    <polyline points="15 3 21 3 21 9"></polyline>
                    <line x1="10" y1="14" x2="21" y2="3"></line>
                  </svg>
                </a>
                <a href="#" onclick="event.preventDefault(); prepareMintProposal('loot'); switchDaoView('dao');" title="Create mint loot proposal" onmouseover="this.style.opacity='1'; this.style.transform='translateY(-1px)';" onmouseout="this.style.opacity='0.5'; this.style.transform='translateY(0)';" style="margin-left: 0.35rem; color: #9d7bff; opacity: 0.5; transition: all 0.2s; font-size: 0.75rem; text-decoration: none;">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle;">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="16"></line>
                    <line x1="8" y1="12" x2="16" y2="12"></line>
                  </svg>
                </a>
              </div>
              <div class="balance-value" id="membershipLoot">0</div>
            </div>
            <div class="balance-item">
              <div class="balance-label">
                Badge Seat
                <a id="badgeEtherscanLink" href="#" target="_blank" rel="noopener noreferrer" style="margin-left: 0.35rem; color: #9d7bff; opacity: 0.7; transition: all 0.2s; display: none;">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                    <polyline points="15 3 21 3 21 9"></polyline>
                    <line x1="10" y1="14" x2="21" y2="3"></line>
                  </svg>
                </a>
              </div>
              <div class="balance-value" id="membershipBadge">None</div>
            </div>
          </div>
        </div>

        <!-- Vote Receipts Panel -->
        <div class="receipts-panel">
          <h3 class="dao-panel-title">Vote Receipts Collection</h3>
          <div id="receiptsGrid" class="receipts-grid">
            <!-- Receipt cards will be dynamically rendered here -->
          </div>
        </div>
      </div>

      <!-- Members List Content -->
      <div class="dao-members-content" id="daoMembersView">
        <div class="members-panel">
          <div class="members-header">
            <h3 class="dao-panel-title">DAO Members</h3>
            <div class="members-stats">
              <div class="members-stat">
                <span class="members-stat-label">Total Members:</span>
                <span class="members-stat-value" id="memberCount">0</span>
              </div>
              <div class="members-stat">
                <span class="members-stat-label">Badge Holders:</span>
                <span class="members-stat-value" id="badgeHolderCount">0</span>
              </div>
            </div>
          </div>
          <div class="members-list" id="membersList">
            <!-- Members will be dynamically rendered here -->
          </div>
        </div>
      </div>
    </section>

    <!-- Modal for NFT viewing -->
    <div id="nftModal" class="nft-modal" onclick="closeNFTModal()">
      <div class="nft-modal-content" onclick="event.stopPropagation()">
        <button class="nft-modal-close" onclick="closeNFTModal()">&times;</button>
        <div id="nftModalBody" class="nft-modal-body">
          <!-- NFT content will be dynamically rendered here -->
        </div>
      </div>
    </div>

    <!-- Web3 Integration Script -->
    <script>
      // Lazy loading for images
      if ('IntersectionObserver' in window) {
        const imageObserver = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              const img = entry.target;
              img.src = img.dataset.src || img.src;
              imageObserver.unobserve(img);
            }
          });
        });
        document.querySelectorAll('img[data-src]').forEach(img => imageObserver.observe(img));
      }

      // Auto-save form data to prevent loss
      const formInputs = {};
      function saveToLocalStorage() {
        const formData = {
          daoName: document.getElementById('daoName')?.value || '',
          daoSymbol: document.getElementById('daoSymbol')?.value || '',
          orgURI: document.getElementById('orgURI')?.value || '',
          quorum: document.getElementById('quorum')?.value || '50',
          timestamp: Date.now()
        };
        try {
          localStorage.setItem('molochSummonDraft', JSON.stringify(formData));
        } catch (e) {
          console.warn('Could not save to localStorage');
        }
      }

      // Restore form data on page load
      document.addEventListener('DOMContentLoaded', () => {
        try {
          const saved = localStorage.getItem('molochSummonDraft');
          if (saved) {
            const data = JSON.parse(saved);
            // Only restore if less than 24 hours old
            if (Date.now() - data.timestamp < 24 * 60 * 60 * 1000) {
              if (document.getElementById('daoName')) document.getElementById('daoName').value = data.daoName || '';
              if (document.getElementById('daoSymbol')) document.getElementById('daoSymbol').value = data.daoSymbol || '';
              if (document.getElementById('orgURI')) document.getElementById('orgURI').value = data.orgURI || '';
              if (document.getElementById('quorum')) {
                document.getElementById('quorum').value = data.quorum || '50';
                document.getElementById('quorumValue').textContent = (data.quorum || '50') + '%';
              }
            }
          }
        } catch (e) {
          console.warn('Could not restore form data');
        }
      });

      // Debounced form saving
      let saveTimeout;
      document.addEventListener('input', (e) => {
        if (e.target.closest('#summonForm')) {
          clearTimeout(saveTimeout);
          saveTimeout = setTimeout(saveToLocalStorage, 1000);
        }
      });

      // Enhanced error handling with user-friendly messages
      window.addEventListener('error', (e) => {
        console.error('Application error:', e);
        // Could show a user-friendly error notification here
      });

      // Network status monitoring
      let isOnline = navigator.onLine;
      window.addEventListener('online', () => {
        isOnline = true;
        console.log('Network connection restored');
      });
      window.addEventListener('offline', () => {
        isOnline = false;
        console.warn('Network connection lost');
        alert('Network connection lost. Please check your internet connection.');
      });
      const SUMMONER_ADDRESS = '0x0000000000330B8df9E3bc5E553074DA58eE9138';
      const SUMMONER_ABI = [
        {
          "inputs": [
            {"internalType": "string", "name": "orgName", "type": "string"},
            {"internalType": "string", "name": "orgSymbol", "type": "string"},
            {"internalType": "string", "name": "orgURI", "type": "string"},
            {"internalType": "uint16", "name": "quorumBps", "type": "uint16"},
            {"internalType": "bool", "name": "ragequittable", "type": "bool"},
            {"internalType": "address", "name": "renderer", "type": "address"},
            {"internalType": "bytes32", "name": "salt", "type": "bytes32"},
            {"internalType": "address[]", "name": "initHolders", "type": "address[]"},
            {"internalType": "uint256[]", "name": "initShares", "type": "uint256[]"},
            {"components": [
              {"internalType": "address", "name": "target", "type": "address"},
              {"internalType": "uint256", "name": "value", "type": "uint256"},
              {"internalType": "bytes", "name": "data", "type": "bytes"}
            ], "internalType": "struct Call[]", "name": "initCalls", "type": "tuple[]"}
          ],
          "name": "summon",
          "outputs": [{"internalType": "contract Moloch", "name": "dao", "type": "address"}],
          "stateMutability": "payable",
          "type": "function"
        }
      ];

      const VIEW_HELPER_ADDRESS = '0x000000000066317bd3662A649D8901c076268Df9';
      const VIEW_HELPER_ABI = [
        {
          "inputs": [
            {"internalType": "address", "name": "user", "type": "address"},
            {"internalType": "uint256", "name": "daoStart", "type": "uint256"},
            {"internalType": "uint256", "name": "daoCount", "type": "uint256"},
            {"internalType": "uint256", "name": "proposalStart", "type": "uint256"},
            {"internalType": "uint256", "name": "proposalCount", "type": "uint256"},
            {"internalType": "uint256", "name": "messageStart", "type": "uint256"},
            {"internalType": "uint256", "name": "messageCount", "type": "uint256"}
          ],
          "name": "getUserDAOsFullState",
          "outputs": [
            {
              "components": [
                {
                  "components": [
                    {"internalType": "address", "name": "dao", "type": "address"},
                    {
                      "components": [
                        {"internalType": "string", "name": "name", "type": "string"},
                        {"internalType": "string", "name": "symbol", "type": "string"},
                        {"internalType": "string", "name": "contractURI", "type": "string"},
                        {"internalType": "address", "name": "sharesToken", "type": "address"},
                        {"internalType": "address", "name": "lootToken", "type": "address"},
                        {"internalType": "address", "name": "badgesToken", "type": "address"},
                        {"internalType": "address", "name": "renderer", "type": "address"}
                      ],
                      "internalType": "struct DAOMeta",
                      "name": "meta",
                      "type": "tuple"
                    },
                    {
                      "components": [
                        {"internalType": "uint96", "name": "proposalThreshold", "type": "uint96"},
                        {"internalType": "uint96", "name": "minYesVotesAbsolute", "type": "uint96"},
                        {"internalType": "uint96", "name": "quorumAbsolute", "type": "uint96"},
                        {"internalType": "uint64", "name": "proposalTTL", "type": "uint64"},
                        {"internalType": "uint64", "name": "timelockDelay", "type": "uint64"},
                        {"internalType": "uint16", "name": "quorumBps", "type": "uint16"},
                        {"internalType": "bool", "name": "ragequittable", "type": "bool"},
                        {"internalType": "uint256", "name": "autoFutarchyParam", "type": "uint256"},
                        {"internalType": "uint256", "name": "autoFutarchyCap", "type": "uint256"},
                        {"internalType": "address", "name": "rewardToken", "type": "address"}
                      ],
                      "internalType": "struct DAOGovConfig",
                      "name": "gov",
                      "type": "tuple"
                    },
                    {
                      "components": [
                        {"internalType": "uint256", "name": "sharesTotalSupply", "type": "uint256"},
                        {"internalType": "uint256", "name": "lootTotalSupply", "type": "uint256"},
                        {"internalType": "uint256", "name": "sharesHeldByDAO", "type": "uint256"},
                        {"internalType": "uint256", "name": "lootHeldByDAO", "type": "uint256"}
                      ],
                      "internalType": "struct DAOTokenSupplies",
                      "name": "supplies",
                      "type": "tuple"
                    },
                    {
                      "components": [
                        {"internalType": "uint256", "name": "eth", "type": "uint256"},
                        {"internalType": "uint256", "name": "usdc", "type": "uint256"},
                        {"internalType": "uint256", "name": "usdt", "type": "uint256"},
                        {"internalType": "uint256", "name": "dai", "type": "uint256"},
                        {"internalType": "uint256", "name": "wsteth", "type": "uint256"},
                        {"internalType": "uint256", "name": "reth", "type": "uint256"}
                      ],
                      "internalType": "struct DAOTreasury",
                      "name": "treasury",
                      "type": "tuple"
                    },
                    {
                      "components": [
                        {"internalType": "address", "name": "account", "type": "address"},
                        {"internalType": "uint256", "name": "shares", "type": "uint256"},
                        {"internalType": "uint256", "name": "loot", "type": "uint256"},
                        {"internalType": "uint16", "name": "seatId", "type": "uint16"},
                        {"internalType": "uint256", "name": "votingPower", "type": "uint256"},
                        {"internalType": "address[]", "name": "delegates", "type": "address[]"},
                        {"internalType": "uint32[]", "name": "delegatesBps", "type": "uint32[]"}
                      ],
                      "internalType": "struct MemberView[]",
                      "name": "members",
                      "type": "tuple[]"
                    },
                    {
                      "components": [
                        {"internalType": "uint256", "name": "id", "type": "uint256"},
                        {"internalType": "address", "name": "proposer", "type": "address"},
                        {"internalType": "uint8", "name": "state", "type": "uint8"},
                        {"internalType": "uint48", "name": "snapshotBlock", "type": "uint48"},
                        {"internalType": "uint64", "name": "createdAt", "type": "uint64"},
                        {"internalType": "uint64", "name": "queuedAt", "type": "uint64"},
                        {"internalType": "uint256", "name": "supplySnapshot", "type": "uint256"},
                        {"internalType": "uint96", "name": "forVotes", "type": "uint96"},
                        {"internalType": "uint96", "name": "againstVotes", "type": "uint96"},
                        {"internalType": "uint96", "name": "abstainVotes", "type": "uint96"},
                        {
                          "components": [
                            {"internalType": "bool", "name": "enabled", "type": "bool"},
                            {"internalType": "address", "name": "rewardToken", "type": "address"},
                            {"internalType": "uint256", "name": "pool", "type": "uint256"},
                            {"internalType": "bool", "name": "resolved", "type": "bool"},
                            {"internalType": "uint8", "name": "winner", "type": "uint8"},
                            {"internalType": "uint256", "name": "finalWinningSupply", "type": "uint256"},
                            {"internalType": "uint256", "name": "payoutPerUnit", "type": "uint256"}
                          ],
                          "internalType": "struct FutarchyView",
                          "name": "futarchy",
                          "type": "tuple"
                        },
                        {
                          "components": [
                            {"internalType": "address", "name": "voter", "type": "address"},
                            {"internalType": "uint8", "name": "support", "type": "uint8"},
                            {"internalType": "uint256", "name": "weight", "type": "uint256"}
                          ],
                          "internalType": "struct VoterView[]",
                          "name": "voters",
                          "type": "tuple[]"
                        }
                      ],
                      "internalType": "struct ProposalView[]",
                      "name": "proposals",
                      "type": "tuple[]"
                    },
                    {
                      "components": [
                        {"internalType": "uint256", "name": "index", "type": "uint256"},
                        {"internalType": "string", "name": "text", "type": "string"}
                      ],
                      "internalType": "struct MessageView[]",
                      "name": "messages",
                      "type": "tuple[]"
                    }
                  ],
                  "internalType": "struct DAOLens",
                  "name": "dao",
                  "type": "tuple"
                },
                {
                  "components": [
                    {"internalType": "address", "name": "account", "type": "address"},
                    {"internalType": "uint256", "name": "shares", "type": "uint256"},
                    {"internalType": "uint256", "name": "loot", "type": "uint256"},
                    {"internalType": "uint16", "name": "seatId", "type": "uint16"},
                    {"internalType": "uint256", "name": "votingPower", "type": "uint256"},
                    {"internalType": "address[]", "name": "delegates", "type": "address[]"},
                    {"internalType": "uint32[]", "name": "delegatesBps", "type": "uint32[]"}
                  ],
                  "internalType": "struct MemberView",
                  "name": "member",
                  "type": "tuple"
                }
              ],
              "internalType": "struct UserDAOLens[]",
              "name": "out",
              "type": "tuple[]"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [
            {"internalType": "uint256", "name": "daoStart", "type": "uint256"},
            {"internalType": "uint256", "name": "daoCount", "type": "uint256"},
            {"internalType": "uint256", "name": "proposalStart", "type": "uint256"},
            {"internalType": "uint256", "name": "proposalCount", "type": "uint256"},
            {"internalType": "uint256", "name": "messageStart", "type": "uint256"},
            {"internalType": "uint256", "name": "messageCount", "type": "uint256"}
          ],
          "name": "getDAOsFullState",
          "outputs": [
            {
              "components": [
                {"internalType": "address", "name": "dao", "type": "address"},
                {
                  "components": [
                    {"internalType": "string", "name": "name", "type": "string"},
                    {"internalType": "string", "name": "symbol", "type": "string"},
                    {"internalType": "string", "name": "contractURI", "type": "string"},
                    {"internalType": "address", "name": "sharesToken", "type": "address"},
                    {"internalType": "address", "name": "lootToken", "type": "address"},
                    {"internalType": "address", "name": "badgesToken", "type": "address"},
                    {"internalType": "address", "name": "renderer", "type": "address"}
                  ],
                  "internalType": "struct DAOMeta",
                  "name": "meta",
                  "type": "tuple"
                },
                {
                  "components": [
                    {"internalType": "uint96", "name": "proposalThreshold", "type": "uint96"},
                    {"internalType": "uint96", "name": "minYesVotesAbsolute", "type": "uint96"},
                    {"internalType": "uint96", "name": "quorumAbsolute", "type": "uint96"},
                    {"internalType": "uint64", "name": "proposalTTL", "type": "uint64"},
                    {"internalType": "uint64", "name": "timelockDelay", "type": "uint64"},
                    {"internalType": "uint16", "name": "quorumBps", "type": "uint16"},
                    {"internalType": "bool", "name": "ragequittable", "type": "bool"},
                    {"internalType": "uint256", "name": "autoFutarchyParam", "type": "uint256"},
                    {"internalType": "uint256", "name": "autoFutarchyCap", "type": "uint256"},
                    {"internalType": "address", "name": "rewardToken", "type": "address"}
                  ],
                  "internalType": "struct DAOGovConfig",
                  "name": "gov",
                  "type": "tuple"
                },
                {
                  "components": [
                    {"internalType": "uint256", "name": "sharesTotalSupply", "type": "uint256"},
                    {"internalType": "uint256", "name": "lootTotalSupply", "type": "uint256"},
                    {"internalType": "uint256", "name": "sharesHeldByDAO", "type": "uint256"},
                    {"internalType": "uint256", "name": "lootHeldByDAO", "type": "uint256"}
                  ],
                  "internalType": "struct DAOTokenSupplies",
                  "name": "supplies",
                  "type": "tuple"
                },
                {
                  "components": [
                    {"internalType": "uint256", "name": "eth", "type": "uint256"},
                    {"internalType": "uint256", "name": "usdc", "type": "uint256"},
                    {"internalType": "uint256", "name": "usdt", "type": "uint256"},
                    {"internalType": "uint256", "name": "dai", "type": "uint256"},
                    {"internalType": "uint256", "name": "wsteth", "type": "uint256"},
                    {"internalType": "uint256", "name": "reth", "type": "uint256"}
                  ],
                  "internalType": "struct DAOTreasury",
                  "name": "treasury",
                  "type": "tuple"
                },
                {
                  "components": [
                    {"internalType": "address", "name": "account", "type": "address"},
                    {"internalType": "uint256", "name": "shares", "type": "uint256"},
                    {"internalType": "uint256", "name": "loot", "type": "uint256"},
                    {"internalType": "uint16", "name": "seatId", "type": "uint16"},
                    {"internalType": "uint256", "name": "votingPower", "type": "uint256"},
                    {"internalType": "address[]", "name": "delegates", "type": "address[]"},
                    {"internalType": "uint32[]", "name": "delegatesBps", "type": "uint32[]"}
                  ],
                  "internalType": "struct MemberView[]",
                  "name": "members",
                  "type": "tuple[]"
                },
                {
                  "components": [
                    {"internalType": "uint256", "name": "id", "type": "uint256"},
                    {"internalType": "address", "name": "proposer", "type": "address"},
                    {"internalType": "uint8", "name": "state", "type": "uint8"},
                    {"internalType": "uint48", "name": "snapshotBlock", "type": "uint48"},
                    {"internalType": "uint64", "name": "createdAt", "type": "uint64"},
                    {"internalType": "uint64", "name": "queuedAt", "type": "uint64"},
                    {"internalType": "uint256", "name": "supplySnapshot", "type": "uint256"},
                    {"internalType": "uint96", "name": "forVotes", "type": "uint96"},
                    {"internalType": "uint96", "name": "againstVotes", "type": "uint96"},
                    {"internalType": "uint96", "name": "abstainVotes", "type": "uint96"},
                    {
                      "components": [
                        {"internalType": "bool", "name": "enabled", "type": "bool"},
                        {"internalType": "address", "name": "rewardToken", "type": "address"},
                        {"internalType": "uint256", "name": "pool", "type": "uint256"},
                        {"internalType": "bool", "name": "resolved", "type": "bool"},
                        {"internalType": "uint8", "name": "winner", "type": "uint8"},
                        {"internalType": "uint256", "name": "finalWinningSupply", "type": "uint256"},
                        {"internalType": "uint256", "name": "payoutPerUnit", "type": "uint256"}
                      ],
                      "internalType": "struct FutarchyView",
                      "name": "futarchy",
                      "type": "tuple"
                    },
                    {
                      "components": [
                        {"internalType": "address", "name": "voter", "type": "address"},
                        {"internalType": "uint8", "name": "support", "type": "uint8"},
                        {"internalType": "uint256", "name": "weight", "type": "uint256"}
                      ],
                      "internalType": "struct VoterView[]",
                      "name": "voters",
                      "type": "tuple[]"
                    }
                  ],
                  "internalType": "struct ProposalView[]",
                  "name": "proposals",
                  "type": "tuple[]"
                },
                {
                  "components": [
                    {"internalType": "uint256", "name": "index", "type": "uint256"},
                    {"internalType": "string", "name": "text", "type": "string"}
                  ],
                  "internalType": "struct MessageView[]",
                  "name": "messages",
                  "type": "tuple[]"
                }
              ],
              "internalType": "struct DAOLens[]",
              "name": "out",
              "type": "tuple[]"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        }
      ];

      const MOLOCH_ABI = [
        {
          "inputs": [{"internalType": "uint256", "name": "id", "type": "uint256"}],
          "name": "openProposal",
          "outputs": [],
          "stateMutability": "nonpayable",
          "type": "function"
        },
        {
          "inputs": [{"internalType": "string", "name": "message", "type": "string"}],
          "name": "chat",
          "outputs": [],
          "stateMutability": "payable",
          "type": "function"
        },
        {
          "inputs": [
            {"internalType": "uint8", "name": "op", "type": "uint8"},
            {"internalType": "address", "name": "to", "type": "address"},
            {"internalType": "uint256", "name": "value", "type": "uint256"},
            {"internalType": "bytes", "name": "data", "type": "bytes"},
            {"internalType": "bytes32", "name": "nonce", "type": "bytes32"}
          ],
          "name": "executeByVotes",
          "outputs": [
            {"internalType": "bool", "name": "ok", "type": "bool"},
            {"internalType": "bytes", "name": "retData", "type": "bytes"}
          ],
          "stateMutability": "payable",
          "type": "function"
        },
        {
          "inputs": [
            {"internalType": "uint256", "name": "id", "type": "uint256"},
            {"internalType": "uint8", "name": "support", "type": "uint8"}
          ],
          "name": "castVote",
          "outputs": [],
          "stateMutability": "nonpayable",
          "type": "function"
        },
        {
          "inputs": [{"internalType": "uint256", "name": "id", "type": "uint256"}],
          "name": "cancelVote",
          "outputs": [],
          "stateMutability": "nonpayable",
          "type": "function"
        },
        {
          "inputs": [
            {"internalType": "uint256", "name": "", "type": "uint256"},
            {"internalType": "address", "name": "", "type": "address"}
          ],
          "name": "hasVoted",
          "outputs": [{"internalType": "uint8", "name": "", "type": "uint8"}],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [],
          "name": "config",
          "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [{"internalType": "bytes[]", "name": "data", "type": "bytes[]"}],
          "name": "multicall",
          "outputs": [{"internalType": "bytes[]", "name": "results", "type": "bytes[]"}],
          "stateMutability": "nonpayable",
          "type": "function"
        },
        {
          "inputs": [
            {"internalType": "address[]", "name": "tokens", "type": "address[]"},
            {"internalType": "uint256", "name": "sharesToBurn", "type": "uint256"},
            {"internalType": "uint256", "name": "lootToBurn", "type": "uint256"}
          ],
          "name": "ragequit",
          "outputs": [],
          "stateMutability": "nonpayable",
          "type": "function"
        },
        {
          "inputs": [
            {"internalType": "uint256", "name": "id", "type": "uint256"},
            {"internalType": "uint256", "name": "amount", "type": "uint256"}
          ],
          "name": "cashOutFutarchy",
          "outputs": [{"internalType": "uint256", "name": "payout", "type": "uint256"}],
          "stateMutability": "nonpayable",
          "type": "function"
        },
        {
          "inputs": [
            {"internalType": "address", "name": "owner", "type": "address"},
            {"internalType": "uint256", "name": "id", "type": "uint256"}
          ],
          "name": "balanceOf",
          "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [],
          "name": "badges",
          "outputs": [{"internalType": "address", "name": "", "type": "address"}],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [],
          "name": "shares",
          "outputs": [{"internalType": "address", "name": "", "type": "address"}],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [],
          "name": "loot",
          "outputs": [{"internalType": "address", "name": "", "type": "address"}],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [{"internalType": "uint256", "name": "id", "type": "uint256"}],
          "name": "tokenURI",
          "outputs": [{"internalType": "string", "name": "", "type": "string"}],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [],
          "name": "contractURI",
          "outputs": [{"internalType": "string", "name": "", "type": "string"}],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [{"internalType": "address", "name": "payToken", "type": "address"}],
          "name": "sales",
          "outputs": [
            {"internalType": "uint256", "name": "pricePerShare", "type": "uint256"},
            {"internalType": "uint256", "name": "cap", "type": "uint256"},
            {"internalType": "bool", "name": "minting", "type": "bool"},
            {"internalType": "bool", "name": "active", "type": "bool"},
            {"internalType": "bool", "name": "isLoot", "type": "bool"}
          ],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [
            {"internalType": "address", "name": "payToken", "type": "address"},
            {"internalType": "uint256", "name": "pricePerShare", "type": "uint256"},
            {"internalType": "uint256", "name": "cap", "type": "uint256"},
            {"internalType": "bool", "name": "minting", "type": "bool"},
            {"internalType": "bool", "name": "active", "type": "bool"},
            {"internalType": "bool", "name": "isLoot", "type": "bool"}
          ],
          "name": "setSale",
          "outputs": [],
          "stateMutability": "payable",
          "type": "function"
        },
        {
          "inputs": [
            {"internalType": "address", "name": "payToken", "type": "address"},
            {"internalType": "uint256", "name": "shareAmount", "type": "uint256"},
            {"internalType": "uint256", "name": "maxPay", "type": "uint256"}
          ],
          "name": "buyShares",
          "outputs": [],
          "stateMutability": "payable",
          "type": "function"
        }
      ];

      // Constants for minimal proxy pattern (from Solidity reference)
      const CLONE_PREFIX = '0x602d5f8160095f39f35f5f365f5f37365f73';
      const CLONE_SUFFIX = '0x5af43d5f5f3e6029573d5ffd5b3d5ff3';

      // Implementation addresses
      const IMPLEMENTATIONS = {
        moloch: '0x643A45B599D81be3f3a68F37EB3De55fF10673C1',
        badges: '0x71e9b38d301b5a58cb998c1295045fe276acf600',
        shares: '0x47c175ce83b6b931ccbedd5ce95e701984ed96d5',
        loot: '0x6f1f2aF76a3aDD953277e9F369242697C87bc6A5'
      };

      // Token addresses from MolochViewHelper
      const TOKEN_ADDRESSES = {
        usdc: '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48',
        usdt: '0xdAC17F958D2ee523a2206206994597C13D831ec7',
        dai: '0x6B175474E89094C44Da98b954EedeAC495271d0F',
        wsteth: '0x7f39C581F595B53c5cb19bD0b3f8dA6c935E2Ca0',
        reth: '0xae78736Cd615f374D3085123A210448E74Fc6393'
      };

      // Helper to create minimal proxy init code
      function minimalProxyInitCode(implementation) {
        // Normalize the address to lowercase without 0x prefix
        const impl = implementation.toLowerCase().replace(/^0x/, '');
        // Ensure it's 40 characters (20 bytes)
        if (impl.length !== 40) {
          throw new Error('Invalid implementation address length');
        }
        return ethers.concat([
          CLONE_PREFIX,
          '0x' + impl,
          CLONE_SUFFIX
        ]);
      }

      // Generic CREATE2 address prediction
      function computeCreate2Address(deployer, salt, implementation) {
        const initCode = minimalProxyInitCode(implementation);
        const initCodeHash = ethers.keccak256(initCode);
        
        const encoded = ethers.solidityPacked(
          ['bytes1', 'address', 'bytes32', 'bytes32'],
          ['0xff', deployer, salt, initCodeHash]
        );
        const hash = ethers.keccak256(encoded);
        // Extract the last 20 bytes (40 hex chars) and checksum it
        const rawAddress = '0x' + hash.slice(-40);
        // Return checksummed address
        return ethers.getAddress(rawAddress);
      }

      // Predict all Majeur addresses
      function predictMajeurAddresses(initHolders, initShares, userSalt) {
        // Step 1: Recreate Summoner's salt
        const abiCoder = new ethers.AbiCoder();
        const summonerSalt = ethers.keccak256(
          abiCoder.encode(
            ['address[]', 'uint256[]', 'bytes32'],
            [initHolders, initShares, userSalt]
          )
        );
        
        // Step 2: Predict Moloch DAO clone
        const dao = computeCreate2Address(SUMMONER_ADDRESS, summonerSalt, IMPLEMENTATIONS.moloch);
        
        // Step 3: Child salt for badges/shares/loot
        // bytes32(bytes20(address(dao))) = dao address padded to 32 bytes
        const daoNoPrefix = dao.toLowerCase().replace(/^0x/, '');
        if (daoNoPrefix.length !== 40) {
          throw new Error('Invalid DAO address length');
        }
        const childSalt = '0x' + daoNoPrefix + '000000000000000000000000'; // 12 zero bytes
        
        // Step 4: Predict child clones
        const badges = computeCreate2Address(dao, childSalt, IMPLEMENTATIONS.badges);
        const shares = computeCreate2Address(dao, childSalt, IMPLEMENTATIONS.shares);
        const loot = computeCreate2Address(dao, childSalt, IMPLEMENTATIONS.loot);
        
        return { dao, badges, shares, loot };
      }

      let provider = null;
      let signer = null;
      let memberIdCounter = 1;
      let connectedWallet = null;
      let connectedAddress = null;
      let userDAOs = [];
      let allDAOs = [];
      let currentDAO = null;

      // Utility function to check if error is user rejection
      function isUserRejection(error) {
        if (!error) return false;

        // Check error codes
        if (error.code === 4001 || error.code === -32603 || error.code === 'ACTION_REJECTED') {
          return true;
        }

        // Check error message (case insensitive)
        const message = (error.message || '').toLowerCase();
        if (message.includes('user rejected') ||
            message.includes('user denied') ||
            message.includes('transaction cancelled') ||
            message.includes('cancelled by user')) {
          return true;
        }

        // Check nested error object
        if (error.error) {
          return isUserRejection(error.error);
        }

        // Check reason field
        if (error.reason) {
          const reason = error.reason.toLowerCase();
          if (reason.includes('user rejected') || reason.includes('user denied')) {
            return true;
          }
        }

        return false;
      }

      // Wallet detection configuration
      const WALLET_CONFIG = {
        metamask: {
          name: 'MetaMask',
          icon: '🦊',
          detect: () => window.ethereum?.isMetaMask,
          getProvider: () => window.ethereum
        },
        coinbase: {
          name: 'Coinbase Wallet',
          icon: '🔵',
          detect: () => window.ethereum?.isCoinbaseWallet || window.coinbaseWalletExtension,
          getProvider: () => window.ethereum?.isCoinbaseWallet ? window.ethereum : window.coinbaseWalletExtension
        },
        brave: {
          name: 'Brave Wallet',
          icon: '🦁',
          detect: () => window.ethereum?.isBraveWallet,
          getProvider: () => window.ethereum
        },
        trust: {
          name: 'Trust Wallet',
          icon: '⭐',
          detect: () => window.ethereum?.isTrust,
          getProvider: () => window.ethereum
        },
        rainbow: {
          name: 'Rainbow',
          icon: '🌈',
          detect: () => window.ethereum?.isRainbow,
          getProvider: () => window.ethereum
        },
        zerion: {
          name: 'Zerion',
          icon: '💎',
          detect: () => window.ethereum?.isZerion,
          getProvider: () => window.ethereum
        }
      };

      function detectWallets() {
        const detected = [];
        for (const [key, wallet] of Object.entries(WALLET_CONFIG)) {
          if (wallet.detect()) {
            detected.push({ key, ...wallet });
          }
        }
        return detected;
      }

      function showWalletModal() {
        const modalOverlay = document.getElementById('walletModal');
        const walletOptions = document.getElementById('walletOptions');

        // If already connected, show disconnect option
        if (connectedWallet && connectedAddress) {
          const wallet = WALLET_CONFIG[connectedWallet];
          walletOptions.innerHTML = `
            <div style="padding: 1rem; background: rgba(157, 123, 255, 0.1); border: 1px solid rgba(157, 123, 255, 0.3); margin-bottom: 1rem;">
              <div style="display: flex; align-items: center; margin-bottom: 0.75rem;">
                <div class="wallet-icon" style="margin-right: 1rem;">${wallet.icon}</div>
                <div>
                  <div class="wallet-name">${wallet.name}</div>
                  <div class="wallet-status installed">Connected</div>
                </div>
              </div>
              <div style="font-family: 'EB Garamond', serif; color: rgba(230, 217, 255, 0.8); font-size: 0.9rem; word-break: break-all;">
                ${connectedAddress}
              </div>
            </div>
            <div class="wallet-option" onclick="disconnectWallet()" style="background: rgba(157, 123, 255, 0.1); border-color: rgba(157, 123, 255, 0.5); justify-content: center;">
              <div class="wallet-name" style="margin: 0;">Disconnect Wallet</div>
            </div>
          `;
        } else {
          // Show wallet selection
          const wallets = detectWallets();

          if (wallets.length === 0) {
            walletOptions.innerHTML = `
              <div class="wallet-option" onclick="window.open('https://metamask.io/download/', '_blank')">
                <div class="wallet-icon">🦊</div>
                <div class="wallet-info">
                  <div class="wallet-name">Install MetaMask</div>
                  <div class="wallet-status">No wallet detected</div>
                </div>
              </div>
              <div class="wallet-option" onclick="window.open('https://www.coinbase.com/wallet/downloads', '_blank')">
                <div class="wallet-icon">🔵</div>
                <div class="wallet-info">
                  <div class="wallet-name">Install Coinbase Wallet</div>
                  <div class="wallet-status">Browser extension</div>
                </div>
              </div>
              <div class="wallet-option" onclick="window.open('https://rainbow.me/download', '_blank')">
                <div class="wallet-icon">🌈</div>
                <div class="wallet-info">
                  <div class="wallet-name">Install Rainbow</div>
                  <div class="wallet-status">Browser extension</div>
                </div>
              </div>
            `;
          } else {
            walletOptions.innerHTML = wallets.map(wallet => `
              <div class="wallet-option" onclick="connectWithWallet('${wallet.key}')">
                <div class="wallet-icon">${wallet.icon}</div>
                <div class="wallet-info">
                  <div class="wallet-name">${wallet.name}</div>
                  <div class="wallet-status installed">Detected</div>
                </div>
              </div>
            `).join('');
          }
        }

        modalOverlay.classList.add('show');
      }

      function closeWalletModal() {
        document.getElementById('walletModal').classList.remove('show');
      }

      // Close modal when clicking outside
      document.addEventListener('DOMContentLoaded', () => {
        const modalOverlay = document.getElementById('walletModal');
        modalOverlay.addEventListener('click', (e) => {
          if (e.target === modalOverlay) {
            closeWalletModal();
          }
        });
      });

      async function connectWithWallet(walletKey) {
        closeWalletModal();

        const wallet = WALLET_CONFIG[walletKey];
        if (!wallet) {
          console.error('Unknown wallet:', walletKey);
          return;
        }

        const walletProvider = wallet.getProvider();
        if (!walletProvider) {
          showStatus(`${wallet.name} not found`, true);
          return;
        }

        try {
          // Request accounts
          await walletProvider.request({ method: 'eth_requestAccounts' });

          // ethers v6 setup
          provider = new ethers.BrowserProvider(walletProvider);
          signer = await provider.getSigner();

          const address = await signer.getAddress();
          const shortAddress = address.slice(0, 6) + '...' + address.slice(-4);

          // Store connected wallet info
          connectedWallet = walletKey;
          connectedAddress = address;

          document.getElementById('walletBtn').textContent = shortAddress;
          document.getElementById('walletBtn').classList.add('connected');
          document.getElementById('summonBtn').disabled = false;
          document.getElementById('summonBtn').textContent = 'SUMMON DAO';

          // Check network
          const network = await provider.getNetwork();
          if (network.chainId !== 1n) {
            showStatus('Please switch to Ethereum Mainnet', true);
          }

          // Initialize first member with connected wallet
          if (document.getElementById('foundingMembersList').children.length === 0) {
            const memberRow = createMemberRow(address, '1', true);
            document.getElementById('foundingMembersList').appendChild(memberRow);
            updateLootInputs();
          }

          // Fetch user's DAOs
          showStatus('Fetching your DAOs...', false);
          await fetchUserDAOs();
          await fetchAllDAOs();
          showStatus(`Connected to ${wallet.name}`, false);
        } catch (error) {
          console.error(error);

          if (isUserRejection(error)) {
            showStatus('Connection cancelled', false);
            return;
          }

          let errorMessage = `Failed to connect ${wallet.name}`;

          if (error.code === -32002) {
            errorMessage = `Please check ${wallet.name} - a connection request is pending`;
          } else if (error.shortMessage) {
            errorMessage = error.shortMessage;
          } else if (error.reason) {
            errorMessage = error.reason;
          } else if (error.message) {
            const msg = error.message.split('\n')[0];
            if (msg.length < 100) {
              errorMessage = msg;
            }
          }

          showStatus(errorMessage, true);
        }
      }

      async function connectWallet() {
        // Show the wallet selection modal
        showWalletModal();
      }

      function disconnectWallet() {
        // Clear wallet connection state
        provider = null;
        signer = null;
        connectedWallet = null;
        connectedAddress = null;
        userDAOs = [];
        allDAOs = [];
        currentDAO = null;

        // Reset UI
        const walletBtn = document.getElementById('walletBtn');
        walletBtn.textContent = 'CONNECT WALLET';
        walletBtn.classList.remove('connected');

        const summonBtn = document.getElementById('summonBtn');
        summonBtn.disabled = true;
        summonBtn.textContent = 'CONNECT WALLET TO SUMMON';

        // Clear the first member if it was auto-added
        const foundingMembersList = document.getElementById('foundingMembersList');
        if (foundingMembersList.children.length > 0) {
          const firstMember = foundingMembersList.children[0];
          const addressInput = firstMember.querySelector('.member-address');
          if (addressInput && addressInput.hasAttribute('readonly')) {
            // Clear the readonly address that was auto-populated
            addressInput.value = '';
            addressInput.removeAttribute('readonly');
            firstMember.querySelector('.member-shares').value = '';
          }
        }

        // Hide DAO galleries and dashboard
        const daoGallery = document.getElementById('daoGallery');
        if (daoGallery) daoGallery.classList.remove('show');
        const allDaosGallery = document.getElementById('allDaosGallery');
        if (allDaosGallery) allDaosGallery.classList.remove('show');
        const daoDashboard = document.getElementById('daoDashboard');
        if (daoDashboard) daoDashboard.classList.remove('show');

        // Close the modal
        closeWalletModal();

        showStatus('Wallet disconnected', false);
      }

      // Ragequit modal functions
      function openRagequitModal() {
        if (!currentDAO) {
          showStatus('No DAO selected', true);
          return;
        }

        const modal = document.getElementById('ragequitModal');
        const member = currentDAO.member;

        // Check if user is a member
        if (!member) {
          showStatus('You are not a member of this DAO', true);
          return;
        }

        // Display user's shares and loot
        const shares = ethers.formatUnits(member.shares, 18);
        const loot = ethers.formatUnits(member.loot, 18);
        document.getElementById('ragequitUserShares').textContent = parseFloat(shares).toFixed(4);
        document.getElementById('ragequitUserLoot').textContent = parseFloat(loot).toFixed(4);

        // Clear inputs
        document.getElementById('ragequitSharesInput').value = '';
        document.getElementById('ragequitLootInput').value = '';

        // Generate token list with checkboxes
        const tokenList = document.getElementById('ragequitTokenList');
        tokenList.innerHTML = '';

        const treasury = currentDAO.dao.treasury;
        const tokens = [
          { symbol: 'USDC', address: TOKEN_ADDRESSES.usdc, balance: treasury.usdc, decimals: 6, icon: TOKEN_ICONS.usdc },
          { symbol: 'USDT', address: TOKEN_ADDRESSES.usdt, balance: treasury.usdt, decimals: 6, icon: TOKEN_ICONS.usdt },
          { symbol: 'DAI', address: TOKEN_ADDRESSES.dai, balance: treasury.dai, decimals: 18, icon: TOKEN_ICONS.dai },
          { symbol: 'wstETH', address: TOKEN_ADDRESSES.wsteth, balance: treasury.wsteth, decimals: 18, icon: TOKEN_ICONS.wsteth },
          { symbol: 'rETH', address: TOKEN_ADDRESSES.reth, balance: treasury.reth, decimals: 18, icon: TOKEN_ICONS.reth }
        ];

        // Note: ETH is handled separately in ragequit, not included in token array

        tokens.forEach(token => {
          const formattedBalance = parseFloat(ethers.formatUnits(token.balance, token.decimals)).toFixed(4);

          const tokenDiv = document.createElement('div');
          tokenDiv.style.cssText = 'display: flex; align-items: center; padding: 0.75rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.2); cursor: pointer; transition: all 0.3s ease;';
          tokenDiv.onmouseover = () => tokenDiv.style.borderColor = 'rgba(157, 123, 255, 0.4)';
          tokenDiv.onmouseout = () => tokenDiv.style.borderColor = 'rgba(157, 123, 255, 0.2)';

          tokenDiv.innerHTML = `
            <input type="checkbox" id="token_${token.symbol}" value="${token.address}"
                   style="margin-right: 1rem; width: 20px; height: 20px; cursor: pointer;" checked>
            <div style="width: 28px; height: 28px; margin-right: 1rem;">${token.icon}</div>
            <div style="flex: 1;">
              <div style="font-family: 'Cinzel', serif; font-size: 0.85rem; color: #9d7bff; margin-bottom: 0.25rem;">${token.symbol}</div>
              <div style="font-family: 'EB Garamond', serif; font-size: 0.8rem; color: rgba(230, 217, 255, 0.6);">Balance: ${formattedBalance}</div>
            </div>
          `;

          tokenList.appendChild(tokenDiv);

          // Make the whole div clickable to toggle checkbox
          tokenDiv.onclick = (e) => {
            if (e.target.tagName !== 'INPUT') {
              const checkbox = tokenDiv.querySelector('input[type="checkbox"]');
              checkbox.checked = !checkbox.checked;
            }
          };
        });

        modal.classList.add('show');
      }

      function closeRagequitModal() {
        document.getElementById('ragequitModal').classList.remove('show');
      }

      async function executeRagequit() {
        try {
          if (!signer || !currentDAO) {
            showStatus('No wallet connected or DAO selected', true);
            return;
          }

          // Get input values
          const sharesInput = document.getElementById('ragequitSharesInput').value.trim();
          const lootInput = document.getElementById('ragequitLootInput').value.trim();

          if (!sharesInput && !lootInput) {
            showStatus('Please enter shares or loot to burn', true);
            return;
          }

          const sharesToBurn = sharesInput ? ethers.parseUnits(sharesInput, 18) : 0n;
          const lootToBurn = lootInput ? ethers.parseUnits(lootInput, 18) : 0n;

          if (sharesToBurn === 0n && lootToBurn === 0n) {
            showStatus('Must burn at least some shares or loot', true);
            return;
          }

          // Get selected tokens
          const checkboxes = document.querySelectorAll('#ragequitTokenList input[type="checkbox"]:checked');
          if (checkboxes.length === 0) {
            showStatus('Please select at least one token to claim', true);
            return;
          }

          const tokenAddresses = Array.from(checkboxes).map(cb => cb.value);

          // Sort addresses (required by contract)
          tokenAddresses.sort((a, b) => {
            const aBig = BigInt(a);
            const bBig = BigInt(b);
            return aBig < bBig ? -1 : aBig > bBig ? 1 : 0;
          });

          // Execute ragequit
          const daoContract = new ethers.Contract(currentDAO.dao.dao, MOLOCH_ABI, signer);

          showStatus('Executing ragequit...', false);
          const tx = await daoContract.ragequit(tokenAddresses, sharesToBurn, lootToBurn);

          showStatus('Transaction submitted. Waiting for confirmation...', false);
          await tx.wait();

          showStatus('Ragequit executed successfully!', false);
          closeRagequitModal();

          // Refresh DAO data
          await fetchUserDAOs();
          await fetchAllDAOs();

          // Refresh current DAO view if still a member
          if (currentDAO) {
            const daoIndex = userDAOs.findIndex(udao =>
              udao.dao.dao.toLowerCase() === currentDAO.dao.dao.toLowerCase()
            );
            if (daoIndex !== -1) {
              await openDAO(daoIndex, 'user');
            } else {
              // User is no longer a member, go back to gallery
              backToGallery();
            }
          }

        } catch (error) {
          console.error('Ragequit failed:', error);

          if (isUserRejection(error)) {
            showStatus('Ragequit cancelled', false);
            return;
          }

          let errorMessage = 'Ragequit failed';

          if (error.message?.includes('NotOk')) {
            errorMessage = 'Ragequit not allowed - DAO may not allow ragequitting';
          } else if (error.shortMessage) {
            errorMessage = error.shortMessage;
          } else if (error.reason) {
            errorMessage = error.reason;
          } else if (error.message) {
            const msg = error.message.split('\n')[0];
            if (msg.length < 100) {
              errorMessage = msg;
            }
          }

          showStatus(errorMessage, true);
        }
      }

      // Close modals when clicking outside
      document.addEventListener('DOMContentLoaded', () => {
        const ragequitModal = document.getElementById('ragequitModal');
        if (ragequitModal) {
          ragequitModal.addEventListener('click', (e) => {
            if (e.target === ragequitModal) {
              closeRagequitModal();
            }
          });
        }

        const purchaseModal = document.getElementById('purchaseModal');
        if (purchaseModal) {
          purchaseModal.addEventListener('click', (e) => {
            if (e.target === purchaseModal) {
              closePurchaseModal();
            }
          });
        }
      });

      // Fetch user's DAOs from View Helper
      async function fetchUserDAOs() {
        if (!provider || !connectedAddress) return;

        try {
          const viewHelper = new ethers.Contract(VIEW_HELPER_ADDRESS, VIEW_HELPER_ABI, provider);

          // Default params: start at DAO 0, fetch up to 10, recent 10 proposals, recent 10 messages
          const result = await viewHelper.getUserDAOsFullState(
            connectedAddress,
            0, // daoStart
            10, // daoCount
            0, // proposalStart
            10, // proposalCount
            0, // messageStart
            10 // messageCount
          );

          userDAOs = result;

          if (userDAOs.length > 0) {
            renderDAOGallery();
          }

          return userDAOs;
        } catch (error) {
          console.error('Error fetching user DAOs:', error);
          return [];
        }
      }

      // Render all DAOs gallery
      function renderAllDAOsGallery() {
        const allDaosTiles = document.getElementById('allDaosTiles');
        const allDaosGallery = document.getElementById('allDaosGallery');

        if (!allDaosTiles) {
          return;
        }

        allDaosTiles.innerHTML = '';

        const userDAOAddresses = new Set(userDAOs.map(udao => udao.dao.dao.toLowerCase()));

        allDAOs.forEach((daoLens, index) => {
          const dao = daoLens;
          const isUserMember = userDAOAddresses.has(dao.dao.toLowerCase());

          const tile = document.createElement('div');
          tile.className = 'all-dao-tile dao-tile';
          if (isUserMember) {
            tile.classList.add('user-member');
          }
          tile.style.position = 'relative';
          tile.onclick = () => openDAO(index, 'all');

          tile.innerHTML = `
            <div class="dao-tile-emblem" id="emblem-all-${index}"></div>
            <div class="dao-tile-name">${dao.meta.name}</div>
            <div class="dao-tile-symbol">${dao.meta.symbol}</div>
            <div class="dao-tile-stats">
              <div class="dao-stat">
                <div class="dao-stat-label">Total Shares</div>
                <div class="dao-stat-value">${ethers.formatUnits(dao.supplies.sharesTotalSupply, 18)}</div>
              </div>
              <div class="dao-stat">
                <div class="dao-stat-label">Total Loot</div>
                <div class="dao-stat-value">${ethers.formatUnits(dao.supplies.lootTotalSupply, 18)}</div>
              </div>
              <div class="dao-stat">
                <div class="dao-stat-label">Proposals</div>
                <div class="dao-stat-value">${dao.proposals.length}</div>
              </div>
              <div class="dao-stat">
                <div class="dao-stat-label">Members</div>
                <div class="dao-stat-value">${dao.members.length}</div>
              </div>
            </div>
          `;

          allDaosTiles.appendChild(tile);

          // Render emblem asynchronously
          renderTileEmblem(dao.dao, `emblem-all-${index}`);
        });

        allDaosGallery.classList.add('show');
      }

      // Fetch all DAOs from View Helper (not filtered by user)
      async function fetchAllDAOs() {
        if (!provider) return;

        try {
          const viewHelper = new ethers.Contract(VIEW_HELPER_ADDRESS, VIEW_HELPER_ABI, provider);

          // Fetch all DAOs: start at DAO 0, fetch up to 50, recent 5 proposals, recent 5 messages
          const result = await viewHelper.getDAOsFullState(
            0, // daoStart
            50, // daoCount (get more DAOs than user filter)
            0, // proposalStart
            5, // proposalCount (fewer details for browse view)
            0, // messageStart
            5 // messageCount (fewer details for browse view)
          );

          allDAOs = result;
          renderAllDAOsGallery();

          return allDAOs;
        } catch (error) {
          console.error('Error fetching all DAOs:', error);
          return [];
        }
      }

      // Compute proposal ID (matches Solidity _intentHashId logic)
      //
      // MUST match exactly:
      //   Solidity: keccak256(abi.encode(address(this), op, to, value, keccak256(data), nonce, config))
      //   Types:    [address,            uint8, address, uint256, bytes32,         bytes32, uint256]
      //
      // Parameter requirements:
      //   - daoAddress: string (DAO contract address)
      //   - op: number 0-1 (0=call, 1=delegatecall)
      //   - to: string (target address)
      //   - value: BigInt (Wei amount, NOT ETH string!)
      //   - data: string (hex calldata, can be "0x" for empty)
      //   - nonce: string (hex bytes32, e.g., "0x0000...")
      //   - config: BigInt (from DAO's config() function)
      function computeProposalId(daoAddress, op, to, value, data, nonce, config) {
        const abiCoder = new ethers.AbiCoder();

        // Hash the calldata (Solidity: keccak256(data))
        const dataHash = ethers.keccak256(data);

        // Encode all parameters in the same order as Solidity
        const encoded = abiCoder.encode(
          ['address', 'uint8', 'address', 'uint256', 'bytes32', 'bytes32', 'uint256'],
          [daoAddress, op, to, value, dataHash, nonce, config]
        );

        // Return as BigInt for consistency
        return BigInt(ethers.keccak256(encoded));
      }

      // Encode proposal as tagged message (raw JSON for transparency)
      //
      // ARCHITECTURE NOTE: Moloch.sol stores only proposal IDs (hashes), not call data.
      // Chat messages serve as the "source of truth" for proposal parameters:
      //   - Proposal ID = hash(dao, op, to, value, keccak256(data), nonce, config)
      //   - Chat message contains all parameters needed for execution
      //   - UI can verify integrity by re-hashing and comparing to proposal ID
      //   - When executing, parameters are extracted from the tagged message
      //
      // This design saves gas (no redundant storage) while keeping everything on-chain.
      function encodeProposalMessage(op, to, value, data, nonce, description) {
        const proposalData = {
          type: 'PROPOSAL',
          op: op,
          to: to,
          value: value.toString(),
          data: data,
          nonce: nonce,
          description: description
        };

        // Use unique delimiters that won't appear in hex data or descriptions
        // Raw JSON (not base64) for transparency - anyone can read proposals in chat
        return `<<<PROPOSAL_DATA\n${JSON.stringify(proposalData, null, 2)}\nPROPOSAL_DATA>>>`;
      }

      // Decode proposal from tagged message
      function decodeProposalMessage(messageText) {
        // Match multiline content between delimiters
        const match = messageText.match(/<<<PROPOSAL_DATA\n([\s\S]*?)\nPROPOSAL_DATA>>>/);
        if (!match) return null;

        try {
          const decoded = JSON.parse(match[1]);
          if (decoded.type === 'PROPOSAL') {
            return decoded;
          }
        } catch (e) {
          console.error('Failed to decode proposal message:', e);
        }

        return null;
      }

      // Render DAO gallery
      function renderDAOGallery() {
        const daoTiles = document.getElementById('daoTiles');
        const daoGallery = document.getElementById('daoGallery');

        if (!daoTiles) return;

        daoTiles.innerHTML = '';

        if (userDAOs.length === 0) {
          daoTiles.innerHTML = '<p style="text-align: center; color: rgba(230, 217, 255, 0.6); font-style: italic;">You are not a member of any DAOs yet.</p>';
          daoGallery.classList.add('show');
          return;
        }

        userDAOs.forEach((userDAOLens, index) => {
          const dao = userDAOLens.dao;
          const member = userDAOLens.member;

          const tile = document.createElement('div');
          tile.className = 'dao-tile';
          tile.onclick = () => openDAO(index);

          const sharesBN = member.shares;
          const lootBN = member.loot;

          tile.innerHTML = `
            <div class="dao-tile-emblem" id="emblem-user-${index}"></div>
            <div class="dao-tile-name">${dao.meta.name}</div>
            <div class="dao-tile-symbol">${dao.meta.symbol}</div>
            <div class="dao-tile-stats">
              <div class="dao-stat">
                <div class="dao-stat-label">Your Shares</div>
                <div class="dao-stat-value">${ethers.formatUnits(sharesBN, 18)}</div>
              </div>
              <div class="dao-stat">
                <div class="dao-stat-label">Your Loot</div>
                <div class="dao-stat-value">${ethers.formatUnits(lootBN, 18)}</div>
              </div>
              <div class="dao-stat">
                <div class="dao-stat-label">Proposals</div>
                <div class="dao-stat-value">${dao.proposals.length}</div>
              </div>
              <div class="dao-stat">
                <div class="dao-stat-label">Messages</div>
                <div class="dao-stat-value">${dao.messages.length}</div>
              </div>
            </div>
          `;

          daoTiles.appendChild(tile);

          // Render emblem asynchronously
          renderTileEmblem(dao.dao, `emblem-user-${index}`);
        });

        daoGallery.classList.add('show');
      }

      // Token SVG icons
      const TOKEN_ICONS = {
        eth: `<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
          <path d="M16 0l-1.5 5.1v17.3l1.5 1.5 7-4.2L16 0z" fill="#9d7bff" opacity="0.6"/>
          <path d="M16 0L9 19.7l7 4.2V0z" fill="#9d7bff"/>
          <path d="M16 26l-.8.9v5.4l.8 2.4 7-9.8L16 26z" fill="#9d7bff" opacity="0.6"/>
          <path d="M16 34.7v-8.8L9 24.9l7 9.8z" fill="#9d7bff"/>
          <path d="M16 23.9l7-4.2-7-3.2v7.4z" fill="#9d7bff" opacity="0.4"/>
          <path d="M9 19.7l7 4.2v-7.4l-7 3.2z" fill="#9d7bff" opacity="0.8"/>
        </svg>`,
        usdc: `<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
          <circle cx="16" cy="16" r="15" fill="none" stroke="#9d7bff" stroke-width="2"/>
          <path d="M20 12c0-2-1.5-3-4-3s-4 1-4 3c0 1.5 1 2.5 4 3s4 1.5 4 3c0 2-1.5 3-4 3s-4-1-4-3M16 7v2M16 23v2"
                stroke="#9d7bff" stroke-width="2" stroke-linecap="round" fill="none"/>
        </svg>`,
        usdt: `<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
          <circle cx="16" cy="16" r="15" fill="none" stroke="#9d7bff" stroke-width="2"/>
          <path d="M12 10h8M16 10v14M12 16h8" stroke="#9d7bff" stroke-width="2" stroke-linecap="round"/>
          <circle cx="16" cy="16" r="4" fill="none" stroke="#9d7bff" stroke-width="1.5"/>
        </svg>`,
        dai: `<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
          <circle cx="16" cy="16" r="15" fill="none" stroke="#9d7bff" stroke-width="2"/>
          <path d="M11 10h6c3 0 5 2 5 6s-2 6-5 6h-6V10z" fill="none" stroke="#9d7bff" stroke-width="2" stroke-linejoin="round"/>
          <path d="M9 14h14M9 18h14" stroke="#9d7bff" stroke-width="1.5"/>
        </svg>`,
        wsteth: `<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
          <circle cx="16" cy="16" r="15" fill="none" stroke="#9d7bff" stroke-width="2" stroke-dasharray="3,3"/>
          <path d="M16 8l-6 10 6 3.5 6-3.5L16 8z" fill="none" stroke="#9d7bff" stroke-width="2" stroke-linejoin="round"/>
          <path d="M10 18l6 6 6-6" fill="none" stroke="#9d7bff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>`,
        reth: `<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
          <circle cx="16" cy="16" r="15" fill="none" stroke="#9d7bff" stroke-width="2"/>
          <path d="M12 22V10h5.5c2 0 3.5 1.5 3.5 3s-1.5 3-3.5 3H12"
                fill="none" stroke="#9d7bff" stroke-width="2" stroke-linejoin="round"/>
          <line x1="12" y1="16" x2="19" y2="22" stroke="#9d7bff" stroke-width="2" stroke-linecap="round"/>
        </svg>`
      };

      // Render DAO stats in header
      function renderDaoStats() {
        const statsBar = document.getElementById('daoStatsBar');
        if (!statsBar || !currentDAO) return;

        const dao = currentDAO.dao;

        // Format totals
        const totalProposals = dao.proposals.length;
        // Members array structure: [0]=address, [1]=shares, [2]=loot, [3]=seatId
        const totalBadgeMembers = dao.members.filter(m => m[3] && m[3] > 0).length;
        const totalShares = parseFloat(ethers.formatEther(dao.supplies.sharesTotalSupply)).toFixed(1);
        const totalLoot = parseFloat(ethers.formatEther(dao.supplies.lootTotalSupply)).toFixed(1);

        statsBar.innerHTML = `
          <div class="dao-stat-item">
            <div class="dao-stat-label">Proposals</div>
            <div class="dao-stat-value">${totalProposals}</div>
          </div>
          <div class="dao-stat-item">
            <div class="dao-stat-label">Badge Members</div>
            <div class="dao-stat-value">${totalBadgeMembers}</div>
          </div>
          <div class="dao-stat-item">
            <div class="dao-stat-label">Total Shares</div>
            <div class="dao-stat-value">${totalShares}</div>
          </div>
          <div class="dao-stat-item">
            <div class="dao-stat-label">Total Loot</div>
            <div class="dao-stat-value">${totalLoot}</div>
          </div>
        `;
      }

      // Render governance info
      function renderGovernanceInfo() {
        const governanceInfo = document.getElementById('governanceInfo');
        if (!governanceInfo || !currentDAO) return;

        const gov = currentDAO.dao.gov;
        const supplies = currentDAO.dao.supplies;

        // Calculate quorum percentage
        const quorumBps = Number(gov.quorumBps);
        const quorumPercent = (quorumBps / 100).toFixed(1);

        // Format ragequittable
        const ragequittable = gov.ragequittable ? 'Enabled' : 'Disabled';

        // Decode futarchy settings
        let futarchyText = 'Disabled';
        const futarchyParam = BigInt(gov.autoFutarchyParam || 0);
        const futarchyCap = BigInt(gov.autoFutarchyCap || 0);

        if (futarchyParam > 0n && futarchyCap > 0n) {
          const paramBps = Number(futarchyParam);
          const paramPercent = (paramBps / 100).toFixed(2);
          const capFormatted = parseFloat(ethers.formatEther(futarchyCap)).toFixed(1);
          futarchyText = `${paramPercent}% of supply, ${capFormatted} LOOT cap`;
        }

        governanceInfo.innerHTML = `
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.5rem;">
            <div>
              <div style="font-size: 0.7rem; color: rgba(230, 217, 255, 0.5); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.25rem; display: flex; align-items: center; gap: 0.35rem;">
                Quorum
                <a href="#" onclick="event.preventDefault(); prepareQuorumProposal(); switchDaoView('dao');"
                   title="Create proposal to change quorum"
                   style="color: #9d7bff; opacity: 0.5; line-height: 1;">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="16"></line>
                    <line x1="8" y1="12" x2="16" y2="12"></line>
                  </svg>
                </a>
              </div>
              <div style="font-size: 0.95rem; color: #e6d9ff;">${quorumPercent}%</div>
            </div>
            <div>
              <div style="font-size: 0.7rem; color: rgba(230, 217, 255, 0.5); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.25rem; display: flex; align-items: center; gap: 0.35rem;">
                Ragequit
                <a href="#" onclick="event.preventDefault(); prepareRagequitProposal(); switchDaoView('dao');"
                   title="Create proposal to toggle ragequit"
                   style="color: #9d7bff; opacity: 0.5; line-height: 1;">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="16"></line>
                    <line x1="8" y1="12" x2="16" y2="12"></line>
                  </svg>
                </a>
              </div>
              <div style="font-size: 0.95rem; color: #e6d9ff;">${ragequittable}</div>
            </div>
          </div>
          <div>
            <div style="font-size: 0.7rem; color: rgba(230, 217, 255, 0.5); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.25rem; display: flex; align-items: center; gap: 0.35rem;">
              Auto-Futarchy
              <a href="#" onclick="event.preventDefault(); prepareFutarchyProposal(); switchDaoView('dao');"
                 title="Create proposal to configure auto-futarchy"
                 style="color: #9d7bff; opacity: 0.5; line-height: 1;">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="12" y1="8" x2="12" y2="16"></line>
                  <line x1="8" y1="12" x2="16" y2="12"></line>
                </svg>
              </a>
            </div>
            <div style="font-size: 0.95rem; color: #e6d9ff;">${futarchyText}</div>
          </div>
        `;
      }

      // Render active sales info
      async function renderSalesInfo() {
        const salesInfo = document.getElementById('salesInfo');
        const salesSection = document.getElementById('salesSection');
        if (!salesInfo || !salesSection || !currentDAO) return;

        try {
          const molochContract = new ethers.Contract(currentDAO.dao.dao, MOLOCH_ABI, provider);

          // Check sales for all supported tokens
          const tokens = [
            { symbol: 'ETH', address: ethers.ZeroAddress, decimals: 18 },
            { symbol: 'USDC', address: TOKEN_ADDRESSES.usdc, decimals: 6 },
            { symbol: 'USDT', address: TOKEN_ADDRESSES.usdt, decimals: 6 },
            { symbol: 'DAI', address: TOKEN_ADDRESSES.dai, decimals: 18 },
            { symbol: 'wstETH', address: TOKEN_ADDRESSES.wsteth, decimals: 18 },
            { symbol: 'rETH', address: TOKEN_ADDRESSES.reth, decimals: 18 }
          ];

          // Batch all sales queries in parallel to reduce RPC calls
          const salePromises = tokens.map(token =>
            molochContract.sales(token.address).catch(err => {
              console.error(`Error fetching sale for ${token.symbol}:`, err);
              return { active: false }; // Return inactive on error
            })
          );

          const salesResults = await Promise.all(salePromises);

          const activeSales = [];
          salesResults.forEach((sale, index) => {
            if (sale.active) {
              activeSales.push({
                token: tokens[index],
                pricePerShare: sale.pricePerShare,
                cap: sale.cap,
                minting: sale.minting,
                isLoot: sale.isLoot
              });
            }
          });

          if (activeSales.length === 0) {
            salesSection.style.display = 'none';
            return;
          }

          salesSection.style.display = 'block';

          let salesHTML = '';
          for (const sale of activeSales) {
            const tokenType = sale.isLoot ? 'LOOT' : 'SHARES';
            const tokenSymbol = sale.isLoot ? `${currentDAO.dao.meta.symbol}-LOOT` : currentDAO.dao.meta.symbol;
            const priceFormatted = parseFloat(ethers.formatUnits(sale.pricePerShare, sale.token.decimals)).toFixed(sale.token.decimals === 6 ? 2 : 4);
            const capText = sale.cap > 0n ? `${parseFloat(ethers.formatEther(sale.cap)).toFixed(2)} remaining` : 'Unlimited';
            const sourceText = sale.minting ? 'Minting new' : 'From treasury';

            salesHTML += `
              <div style="padding: 0.75rem; background: rgba(157, 123, 255, 0.05); border: 1px solid rgba(157, 123, 255, 0.2); border-radius: 4px; margin-bottom: 0.75rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                  <div style="font-family: 'Cinzel', serif; font-size: 0.85rem; color: #9d7bff; letter-spacing: 0.1em;">${tokenType} SALE</div>
                  <div style="font-size: 0.75rem; color: rgba(230, 217, 255, 0.6);">${sourceText}</div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem;">
                  <div>
                    <div style="font-size: 0.7rem; color: rgba(230, 217, 255, 0.5);">Price</div>
                    <div style="font-size: 0.9rem; color: #e6d9ff;">${priceFormatted} ${sale.token.symbol}</div>
                  </div>
                  <div>
                    <div style="font-size: 0.7rem; color: rgba(230, 217, 255, 0.5);">Available</div>
                    <div style="font-size: 0.9rem; color: #e6d9ff;">${capText}</div>
                  </div>
                </div>
                <button onclick="openPurchaseModal('${sale.token.address}', '${sale.token.symbol}', ${sale.token.decimals}, ${sale.isLoot})"
                        onmouseover="this.style.background='rgba(157, 123, 255, 0.25)'; this.style.borderColor='#9d7bff';"
                        onmouseout="this.style.background='rgba(157, 123, 255, 0.15)'; this.style.borderColor='rgba(157, 123, 255, 0.3)';"
                        style="width: 100%; padding: 0.6rem; background: rgba(157, 123, 255, 0.15); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'Cinzel', serif; font-size: 0.7rem; letter-spacing: 0.12em; cursor: pointer; text-transform: uppercase; transition: all 0.2s ease; font-weight: 600;">
                  Purchase ${tokenSymbol}
                </button>
              </div>
            `;
          }

          salesInfo.innerHTML = salesHTML;
        } catch (error) {
          console.error('Error rendering sales:', error);
          salesSection.style.display = 'none';
        }
      }

      // Render treasury
      function renderTreasury() {
        const treasuryAssets = document.getElementById('treasuryAssets');
        if (!treasuryAssets || !currentDAO) return;

        treasuryAssets.innerHTML = '';

        const treasury = currentDAO.dao.treasury;

        const assets = [
          { symbol: 'ETH', balance: treasury.eth, decimals: 18, icon: TOKEN_ICONS.eth, address: ethers.ZeroAddress },
          { symbol: 'USDC', balance: treasury.usdc, decimals: 6, icon: TOKEN_ICONS.usdc, address: TOKEN_ADDRESSES.usdc },
          { symbol: 'USDT', balance: treasury.usdt, decimals: 6, icon: TOKEN_ICONS.usdt, address: TOKEN_ADDRESSES.usdt },
          { symbol: 'DAI', balance: treasury.dai, decimals: 18, icon: TOKEN_ICONS.dai, address: TOKEN_ADDRESSES.dai },
          { symbol: 'wstETH', balance: treasury.wsteth, decimals: 18, icon: TOKEN_ICONS.wsteth, address: TOKEN_ADDRESSES.wsteth },
          { symbol: 'rETH', balance: treasury.reth, decimals: 18, icon: TOKEN_ICONS.reth, address: TOKEN_ADDRESSES.reth }
        ];

        assets.forEach(asset => {
          const assetDiv = document.createElement('div');
          assetDiv.className = 'treasury-asset';
          assetDiv.style.cursor = 'pointer';
          assetDiv.title = `Click to create ${asset.symbol} transfer proposal`;

          const formattedBalance = parseFloat(ethers.formatUnits(asset.balance, asset.decimals)).toFixed(4);

          assetDiv.innerHTML = `
            <div class="treasury-asset-icon">${asset.icon}</div>
            <div class="treasury-asset-symbol">${asset.symbol}</div>
            <div class="treasury-asset-balance">${formattedBalance}</div>
          `;

          assetDiv.onclick = () => prepareTransferProposal(asset);

          treasuryAssets.appendChild(assetDiv);
        });
      }

      // Prepare transfer proposal from treasury asset
      async function prepareTransferProposal(asset) {
        // Clear any existing helpers first
        clearTransferHelper();
        clearMintHelper();
        clearFutarchyHelper();
        clearQuorumHelper();
        clearRagequitHelper();
        clearSaleHelper();

        // Scroll to proposal form
        const proposalForm = document.querySelector('.proposal-form');
        if (proposalForm) {
          proposalForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Add transfer helper UI
        let helperDiv = document.createElement('div');
        helperDiv.id = 'transferHelper';
        helperDiv.style.cssText = 'margin-bottom: 1rem; padding: 1rem; background: rgba(157, 123, 255, 0.1); border: 1px solid rgba(157, 123, 255, 0.3); border-radius: 4px;';
        proposalForm.insertBefore(helperDiv, proposalForm.querySelector('.proposal-form-group'));

        // Store asset info for later use
        helperDiv.dataset.assetSymbol = asset.symbol;
        helperDiv.dataset.assetAddress = asset.address;
        helperDiv.dataset.assetDecimals = asset.decimals;

        // Show transfer helper with Send/Sale toggle
        helperDiv.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
            <div style="display: flex; gap: 0.5rem; align-items: center;">
              <div style="font-family: 'Cinzel', serif; font-size: 0.85rem; color: #9d7bff; letter-spacing: 0.1em;">
                ${asset.symbol}
              </div>
              <div style="display: flex; background: rgba(0, 0, 0, 0.3); border-radius: 4px; overflow: hidden;">
                <button id="sendToggle" onclick="toggleProposalMode('send')"
                        style="padding: 0.35rem 0.75rem; background: rgba(157, 123, 255, 0.3); border: none; color: #e6d9ff; font-family: 'Cinzel', serif; font-size: 0.7rem; letter-spacing: 0.1em; cursor: pointer; text-transform: uppercase; transition: all 0.2s ease;">
                  Send
                </button>
                <button id="saleToggle" onclick="toggleProposalMode('sale')"
                        style="padding: 0.35rem 0.75rem; background: transparent; border: none; color: rgba(230, 217, 255, 0.6); font-family: 'Cinzel', serif; font-size: 0.7rem; letter-spacing: 0.1em; cursor: pointer; text-transform: uppercase; transition: all 0.2s ease;">
                  Sale
                </button>
              </div>
            </div>
            <button onclick="clearTransferHelper()" style="background: none; border: none; color: rgba(230, 217, 255, 0.6); cursor: pointer; font-size: 1.2rem; padding: 0; line-height: 1;">&times;</button>
          </div>
          <div id="proposalFields"></div>
        `;

        // Show send mode by default
        toggleProposalMode('send');
      }

      function toggleProposalMode(mode) {
        const helperDiv = document.getElementById('transferHelper');
        if (!helperDiv) return;

        const sendToggle = document.getElementById('sendToggle');
        const saleToggle = document.getElementById('saleToggle');
        const fieldsDiv = document.getElementById('proposalFields');

        const symbol = helperDiv.dataset.assetSymbol;
        const address = helperDiv.dataset.assetAddress;
        const decimals = helperDiv.dataset.assetDecimals;

        // Update toggle button states
        if (mode === 'send') {
          sendToggle.style.background = 'rgba(157, 123, 255, 0.3)';
          sendToggle.style.color = '#e6d9ff';
          saleToggle.style.background = 'transparent';
          saleToggle.style.color = 'rgba(230, 217, 255, 0.6)';

          // Show send fields
          fieldsDiv.innerHTML = `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
              <div>
                <label style="display: block; font-size: 0.75rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.35rem;">Recipient Address or ENS</label>
                <input type="text" id="transferRecipient" placeholder="vitalik.eth or 0x..."
                       style="width: 100%; padding: 0.6rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 0.95rem;" />
              </div>
              <div>
                <label style="display: block; font-size: 0.75rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.35rem;">Amount (${symbol})</label>
                <input type="text" id="transferAmount" placeholder="0.0"
                       style="width: 100%; padding: 0.6rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 0.95rem;" />
              </div>
            </div>
            <button type="button" onclick="populateTransferProposal('${symbol}', '${address}', ${decimals})"
                    onmouseover="this.style.background='rgba(157, 123, 255, 0.35)'; this.style.borderColor='#9d7bff'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(157, 123, 255, 0.3)';"
                    onmouseout="this.style.background='rgba(157, 123, 255, 0.2)'; this.style.borderColor='rgba(157, 123, 255, 0.4)'; this.style.transform='translateY(0)'; this.style.boxShadow='none';"
                    style="width: 100%; padding: 0.75rem; background: rgba(157, 123, 255, 0.2); border: 1px solid rgba(157, 123, 255, 0.4); color: #e6d9ff; font-family: 'Cinzel', serif; font-size: 0.75rem; letter-spacing: 0.15em; cursor: pointer; text-transform: uppercase; transition: all 0.2s ease; font-weight: 600;">
              Populate Proposal Form
            </button>
          `;
          setTimeout(() => {
            const recipientInput = document.getElementById('transferRecipient');
            if (recipientInput) recipientInput.focus();
          }, 100);

        } else if (mode === 'sale') {
          sendToggle.style.background = 'transparent';
          sendToggle.style.color = 'rgba(230, 217, 255, 0.6)';
          saleToggle.style.background = 'rgba(157, 123, 255, 0.3)';
          saleToggle.style.color = '#e6d9ff';

          // Show sale configuration fields
          fieldsDiv.innerHTML = `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
              <div>
                <label style="display: block; font-size: 0.75rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.35rem;">Token Type</label>
                <select id="saleTokenType"
                        style="width: 100%; padding: 0.6rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 0.95rem;">
                  <option value="shares">Shares (Voting)</option>
                  <option value="loot">Loot (Non-Voting)</option>
                </select>
              </div>
              <div>
                <label style="display: block; font-size: 0.75rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.35rem;">
                  Price per Token (${symbol}) <span style="color: #ff6b6b;">*</span>
                </label>
                <input type="text" id="salePrice" placeholder="1.0"
                       style="width: 100%; padding: 0.6rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 0.95rem;" />
              </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
              <div>
                <label style="display: block; font-size: 0.75rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.35rem;">Sale Cap (0 = unlimited)</label>
                <input type="text" id="saleCap" placeholder="0"
                       style="width: 100%; padding: 0.6rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 0.95rem;" />
              </div>
              <div>
                <label style="display: block; font-size: 0.75rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.35rem;">Status</label>
                <select id="saleStatus"
                        style="width: 100%; padding: 0.6rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 0.95rem;">
                  <option value="active">Active</option>
                  <option value="inactive">Inactive</option>
                </select>
              </div>
            </div>
            <div style="margin-bottom: 0.75rem;">
              <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: rgba(230, 217, 255, 0.8); cursor: pointer;">
                <input type="checkbox" id="saleMinting" checked
                       style="width: 1rem; height: 1rem; cursor: pointer;" />
                <span>Mint new tokens (unchecked = sell from treasury)</span>
              </label>
            </div>
            <button type="button" onclick="populateSaleProposalFromToggle('${symbol}', '${address}', ${decimals})"
                    onmouseover="this.style.background='rgba(157, 123, 255, 0.35)'; this.style.borderColor='#9d7bff'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(157, 123, 255, 0.3)';"
                    onmouseout="this.style.background='rgba(157, 123, 255, 0.2)'; this.style.borderColor='rgba(157, 123, 255, 0.4)'; this.style.transform='translateY(0)'; this.style.boxShadow='none';"
                    style="width: 100%; padding: 0.75rem; background: rgba(157, 123, 255, 0.2); border: 1px solid rgba(157, 123, 255, 0.4); color: #e6d9ff; font-family: 'Cinzel', serif; font-size: 0.75rem; letter-spacing: 0.15em; cursor: pointer; text-transform: uppercase; transition: all 0.2s ease; font-weight: 600;">
              Populate Proposal Form
            </button>
          `;
          setTimeout(() => {
            const priceInput = document.getElementById('salePrice');
            if (priceInput) priceInput.focus();
          }, 100);
        }
      }

      function clearTransferHelper() {
        const helperDiv = document.getElementById('transferHelper');
        if (helperDiv) helperDiv.remove();
      }

      async function populateTransferProposal(symbol, address, decimals) {
        try {
          const recipientInput = document.getElementById('transferRecipient').value.trim();
          const amountInput = document.getElementById('transferAmount').value.trim();

          if (!recipientInput) {
            showStatus('Please enter recipient address or ENS', true);
            return;
          }

          if (!amountInput || isNaN(amountInput) || parseFloat(amountInput) <= 0) {
            showStatus('Please enter valid amount', true);
            return;
          }

          showStatus('Resolving address...', false);

          // Resolve ENS if needed
          let recipientAddress = recipientInput;
          if (recipientInput.endsWith('.eth') || !recipientInput.startsWith('0x')) {
            if (!provider) {
              showStatus('Provider not available for ENS resolution', true);
              return;
            }
            try {
              const resolved = await provider.resolveName(recipientInput);
              if (!resolved) {
                showStatus('Could not resolve ENS name', true);
                return;
              }
              recipientAddress = resolved;
              showStatus(`Resolved to ${recipientAddress.slice(0, 6)}...${recipientAddress.slice(-4)}`, false);
            } catch (error) {
              showStatus('ENS resolution failed', true);
              return;
            }
          }

          // Validate address
          if (!ethers.isAddress(recipientAddress)) {
            showStatus('Invalid address', true);
            return;
          }

          const amount = amountInput;
          const amountWei = ethers.parseUnits(amount, decimals);

          // Populate form
          if (symbol === 'ETH') {
            // For ETH: target is recipient, value is amount, no calldata
            document.getElementById('proposalTo').value = recipientAddress;
            document.getElementById('proposalValue').value = amount;
            document.getElementById('proposalData').value = '0x';
            document.getElementById('proposalDescription').value = `Transfer ${amount} ETH to ${recipientInput}`;
          } else {
            // For ERC20: target is token contract, encode transfer calldata
            // transfer(address recipient, uint256 amount)
            const abiCoder = new ethers.AbiCoder();
            const transferCalldata = '0xa9059cbb' + abiCoder.encode(
              ['address', 'uint256'],
              [recipientAddress, amountWei]
            ).slice(2);

            document.getElementById('proposalTo').value = address;
            document.getElementById('proposalValue').value = '0';
            document.getElementById('proposalData').value = transferCalldata;
            document.getElementById('proposalDescription').value = `Transfer ${amount} ${symbol} to ${recipientInput}`;
          }

          // Update UI hints and translations
          updateTargetAddressHint();
          updateCalldataTranslation();
          updateCalldataPreview();

          showStatus('Proposal form populated!', false);
          clearTransferHelper();

          // Scroll to show the populated form
          setTimeout(() => {
            document.getElementById('proposalDescription').scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);

        } catch (error) {
          console.error('Error populating transfer proposal:', error);
          showStatus('Failed to populate form: ' + error.message, true);
        }
      }

      // Prepare mint proposal for shares or loot
      async function prepareMintProposal(tokenType) {
        if (!currentDAO || !currentDAO.dao) {
          showStatus('Please select a DAO first', true);
          return;
        }

        const dao = currentDAO.dao;
        const tokenAddress = tokenType === 'shares' ? dao.meta.sharesToken : dao.meta.lootToken;
        const tokenSymbol = tokenType === 'shares' ? dao.meta.symbol : `${dao.meta.symbol}-LOOT`;

        if (!tokenAddress) {
          showStatus(`${tokenType} token address not found`, true);
          return;
        }

        // Scroll to proposal form
        const proposalForm = document.querySelector('.proposal-form');
        if (proposalForm) {
          proposalForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Add mint helper UI if not already present
        let helperDiv = document.getElementById('mintHelper');
        if (!helperDiv) {
          helperDiv = document.createElement('div');
          helperDiv.id = 'mintHelper';
          helperDiv.style.cssText = 'margin-bottom: 1rem; padding: 1rem; background: rgba(157, 123, 255, 0.1); border: 1px solid rgba(157, 123, 255, 0.3); border-radius: 4px;';
          proposalForm.insertBefore(helperDiv, proposalForm.querySelector('.proposal-form-group'));
        }

        // Show mint helper
        helperDiv.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
            <div style="font-family: 'Cinzel', serif; font-size: 0.85rem; color: #9d7bff; letter-spacing: 0.1em;">
              MINT ${tokenType.toUpperCase()}
            </div>
            <button onclick="clearMintHelper()" style="background: none; border: none; color: rgba(230, 217, 255, 0.6); cursor: pointer; font-size: 1.2rem; padding: 0; line-height: 1;">&times;</button>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
            <div>
              <label style="display: block; font-size: 0.75rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.35rem;">Recipient Address or ENS</label>
              <input type="text" id="mintRecipient" placeholder="vitalik.eth or 0x..."
                     style="width: 100%; padding: 0.6rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 0.95rem;" />
            </div>
            <div>
              <label style="display: block; font-size: 0.75rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.35rem;">Amount (${tokenSymbol})</label>
              <input type="text" id="mintAmount" placeholder="0.0"
                     style="width: 100%; padding: 0.6rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 0.95rem;" />
            </div>
          </div>
          <button onclick="populateMintProposal('${tokenType}', '${tokenSymbol}', '${tokenAddress}')"
                  onmouseover="this.style.background='rgba(157, 123, 255, 0.35)'; this.style.borderColor='#9d7bff'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(157, 123, 255, 0.3)';"
                  onmouseout="this.style.background='rgba(157, 123, 255, 0.2)'; this.style.borderColor='rgba(157, 123, 255, 0.4)'; this.style.transform='translateY(0)'; this.style.boxShadow='none';"
                  style="width: 100%; padding: 0.75rem; background: rgba(157, 123, 255, 0.2); border: 1px solid rgba(157, 123, 255, 0.4); color: #e6d9ff; font-family: 'Cinzel', serif; font-size: 0.75rem; letter-spacing: 0.15em; cursor: pointer; text-transform: uppercase; transition: all 0.2s ease; font-weight: 600;">
            Populate Proposal Form
          </button>
        `;

        // Focus on recipient input
        setTimeout(() => {
          const recipientInput = document.getElementById('mintRecipient');
          if (recipientInput) recipientInput.focus();
        }, 100);
      }

      function clearMintHelper() {
        const helperDiv = document.getElementById('mintHelper');
        if (helperDiv) helperDiv.remove();
      }

      async function populateMintProposal(tokenType, tokenSymbol, tokenAddress) {
        try {
          const recipientInput = document.getElementById('mintRecipient').value.trim();
          const amountInput = document.getElementById('mintAmount').value.trim();

          if (!recipientInput) {
            showStatus('Please enter recipient address or ENS', true);
            return;
          }

          if (!amountInput || isNaN(amountInput) || parseFloat(amountInput) <= 0) {
            showStatus('Please enter valid amount', true);
            return;
          }

          showStatus('Resolving address...', false);

          // Resolve ENS if needed
          let recipientAddress = recipientInput;
          if (recipientInput.endsWith('.eth') || !recipientInput.startsWith('0x')) {
            if (!provider) {
              showStatus('Provider not available for ENS resolution', true);
              return;
            }
            try {
              const resolved = await provider.resolveName(recipientInput);
              if (!resolved) {
                showStatus('Could not resolve ENS name', true);
                return;
              }
              recipientAddress = resolved;
              showStatus(`Resolved to ${recipientAddress.slice(0, 6)}...${recipientAddress.slice(-4)}`, false);
            } catch (error) {
              showStatus('ENS resolution failed', true);
              return;
            }
          }

          // Validate address
          if (!ethers.isAddress(recipientAddress)) {
            showStatus('Invalid address', true);
            return;
          }

          const amount = amountInput;
          const amountWei = ethers.parseUnits(amount, 18); // Shares and loot are always 18 decimals

          // Encode mintFromMoloch(address recipient, uint256 amount)
          const abiCoder = new ethers.AbiCoder();
          const mintCalldata = '0x7c1fb593' + abiCoder.encode(
            ['address', 'uint256'],
            [recipientAddress, amountWei]
          ).slice(2);

          document.getElementById('proposalTo').value = tokenAddress;
          document.getElementById('proposalValue').value = '0';
          document.getElementById('proposalData').value = mintCalldata;
          document.getElementById('proposalDescription').value = `Mint ${amount} ${tokenSymbol} to ${recipientInput}`;

          // Update UI hints and translations
          updateTargetAddressHint();
          updateCalldataTranslation();
          updateCalldataPreview();

          showStatus('Proposal form populated!', false);
          clearMintHelper();

          // Scroll to show the populated form
          setTimeout(() => {
            document.getElementById('proposalDescription').scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);

        } catch (error) {
          console.error('Error populating mint proposal:', error);
          showStatus('Failed to populate form: ' + error.message, true);
        }
      }

      // Prepare futarchy proposal for DAO self-configuration
      async function prepareFutarchyProposal() {
        if (!currentDAO || !currentDAO.dao) {
          showStatus('Please select a DAO first', true);
          return;
        }

        const dao = currentDAO.dao;
        const daoAddress = dao.dao;

        // Scroll to proposal form
        const proposalForm = document.querySelector('.proposal-form');
        if (proposalForm) {
          proposalForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Add futarchy helper UI if not already present
        let helperDiv = document.getElementById('futarchyHelper');
        if (!helperDiv) {
          helperDiv = document.createElement('div');
          helperDiv.id = 'futarchyHelper';
          helperDiv.style.cssText = 'margin-bottom: 1rem; padding: 1rem; background: rgba(157, 123, 255, 0.1); border: 1px solid rgba(157, 123, 255, 0.3); border-radius: 4px;';
          proposalForm.insertBefore(helperDiv, proposalForm.querySelector('.proposal-form-group'));
        }

        // Get current futarchy settings
        const currentParam = BigInt(dao.gov.autoFutarchyParam || 0);
        const currentCap = BigInt(dao.gov.autoFutarchyCap || 0);
        let currentPreset = 'off';

        if (currentParam > 0n && currentCap > 0n) {
          if (currentParam === 5n && currentCap === ethers.parseEther('2')) {
            currentPreset = 'low';
          } else if (currentParam === 10n && currentCap === ethers.parseEther('5')) {
            currentPreset = 'standard';
          } else if (currentParam === 50n && currentCap === ethers.parseEther('10')) {
            currentPreset = 'high';
          } else {
            currentPreset = 'custom';
          }
        }

        // Show futarchy helper
        helperDiv.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
            <div style="font-family: 'Cinzel', serif; font-size: 0.85rem; color: #9d7bff; letter-spacing: 0.1em;">
              CONFIGURE AUTO-FUTARCHY
            </div>
            <button onclick="clearFutarchyHelper()" style="background: none; border: none; color: rgba(230, 217, 255, 0.6); cursor: pointer; font-size: 1.2rem; padding: 0; line-height: 1;">&times;</button>
          </div>
          <div style="margin-bottom: 0.75rem;">
            <label style="display: block; font-size: 0.75rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.35rem;">Preset</label>
            <select id="futarchyPreset"
                    style="width: 100%; padding: 0.6rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 0.95rem;">
              <option value="off" ${currentPreset === 'off' ? 'selected' : ''}>Off (Disable auto-futarchy)</option>
              <option value="low" ${currentPreset === 'low' ? 'selected' : ''}>Low: 0.05% supply, 2 LOOT cap</option>
              <option value="standard" ${currentPreset === 'standard' ? 'selected' : ''}>Standard: 0.1% supply, 5 LOOT cap</option>
              <option value="high" ${currentPreset === 'high' ? 'selected' : ''}>High: 0.5% supply, 10 LOOT cap</option>
            </select>
            <div style="margin-top: 0.5rem; font-size: 0.75rem; color: rgba(230, 217, 255, 0.5);">
              Auto-futarchy mints LOOT rewards to winning voters (% of total supply, capped per proposal)
            </div>
          </div>
          <button onclick="populateFutarchyProposal('${daoAddress}')"
                  onmouseover="this.style.background='rgba(157, 123, 255, 0.35)'; this.style.borderColor='#9d7bff'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(157, 123, 255, 0.3)';"
                  onmouseout="this.style.background='rgba(157, 123, 255, 0.2)'; this.style.borderColor='rgba(157, 123, 255, 0.4)'; this.style.transform='translateY(0)'; this.style.boxShadow='none';"
                  style="width: 100%; padding: 0.75rem; background: rgba(157, 123, 255, 0.2); border: 1px solid rgba(157, 123, 255, 0.4); color: #e6d9ff; font-family: 'Cinzel', serif; font-size: 0.75rem; letter-spacing: 0.15em; cursor: pointer; text-transform: uppercase; transition: all 0.2s ease; font-weight: 600;">
            Populate Proposal Form
          </button>
        `;

        // Focus on preset dropdown
        setTimeout(() => {
          const presetSelect = document.getElementById('futarchyPreset');
          if (presetSelect) presetSelect.focus();
        }, 100);
      }

      function clearFutarchyHelper() {
        const helperDiv = document.getElementById('futarchyHelper');
        if (helperDiv) helperDiv.remove();
      }

      async function populateFutarchyProposal(daoAddress) {
        try {
          const preset = document.getElementById('futarchyPreset').value;

          let param = 0n;
          let cap = 0n;
          let description = '';

          if (preset === 'off') {
            param = 0n;
            cap = 0n;
            description = 'Disable auto-futarchy (turn off voter rewards)';
          } else if (preset === 'low') {
            param = 5n;  // 5 bps (0.05%)
            cap = ethers.parseEther('2');  // 2 LOOT
            description = 'Enable auto-futarchy: Low (0.05% supply, 2 LOOT cap)';
          } else if (preset === 'standard') {
            param = 10n;  // 10 bps (0.1%)
            cap = ethers.parseEther('5');  // 5 LOOT
            description = 'Enable auto-futarchy: Standard (0.1% supply, 5 LOOT cap)';
          } else if (preset === 'high') {
            param = 50n;  // 50 bps (0.5%)
            cap = ethers.parseEther('10');  // 10 LOOT
            description = 'Enable auto-futarchy: High (0.5% supply, 10 LOOT cap)';
          }

          // Encode setAutoFutarchy(uint256 param, uint256 cap)
          const abiCoder = new ethers.AbiCoder();
          const futarchyCalldata = '0xc7b6a5b7' + abiCoder.encode(
            ['uint256', 'uint256'],
            [param, cap]
          ).slice(2);

          document.getElementById('proposalTo').value = daoAddress;
          document.getElementById('proposalValue').value = '0';
          document.getElementById('proposalData').value = futarchyCalldata;
          document.getElementById('proposalDescription').value = description;

          // Update UI hints and translations
          updateTargetAddressHint();
          updateCalldataTranslation();
          updateCalldataPreview();

          showStatus('Proposal form populated!', false);
          clearFutarchyHelper();

          // Scroll to show the populated form
          setTimeout(() => {
            document.getElementById('proposalDescription').scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);

        } catch (error) {
          console.error('Error populating futarchy proposal:', error);
          showStatus('Failed to populate form: ' + error.message, true);
        }
      }

      // Quorum proposal helper
      async function prepareQuorumProposal() {
        if (!currentDAO || !currentDAO.dao) {
          showStatus('Please select a DAO first', true);
          return;
        }

        const dao = currentDAO.dao;
        const daoAddress = dao.dao;
        const currentQuorum = Number(dao.gov.quorumBps) / 100;

        // Scroll to proposal form
        const proposalForm = document.querySelector('.proposal-form');
        if (proposalForm) {
          proposalForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Add quorum helper UI if not already present
        let helperDiv = document.getElementById('quorumHelper');
        if (!helperDiv) {
          helperDiv = document.createElement('div');
          helperDiv.id = 'quorumHelper';
          helperDiv.style.cssText = 'margin-bottom: 1rem; padding: 1rem; background: rgba(157, 123, 255, 0.1); border: 1px solid rgba(157, 123, 255, 0.3); border-radius: 4px;';
          proposalForm.insertBefore(helperDiv, proposalForm.querySelector('.proposal-form-group'));
        }

        // Show quorum helper
        helperDiv.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
            <div style="font-family: 'Cinzel', serif; font-size: 0.85rem; color: #9d7bff; letter-spacing: 0.1em;">
              CHANGE QUORUM
            </div>
            <button onclick="clearQuorumHelper()" style="background: none; border: none; color: rgba(230, 217, 255, 0.6); cursor: pointer; font-size: 1.2rem; padding: 0; line-height: 1;">&times;</button>
          </div>
          <div style="margin-bottom: 0.75rem;">
            <label style="display: block; font-size: 0.75rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.35rem;">New Quorum Percentage</label>
            <input type="text" id="quorumPercentage" placeholder="${currentQuorum}" value="${currentQuorum}"
                   style="width: 100%; padding: 0.6rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 0.95rem;" />
            <div style="margin-top: 0.5rem; font-size: 0.75rem; color: rgba(230, 217, 255, 0.5);">
              Quorum is the minimum % of shares required to pass proposals
            </div>
          </div>
          <button onclick="populateQuorumProposal('${daoAddress}')"
                  onmouseover="this.style.background='rgba(157, 123, 255, 0.35)'; this.style.borderColor='#9d7bff'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(157, 123, 255, 0.3)';"
                  onmouseout="this.style.background='rgba(157, 123, 255, 0.2)'; this.style.borderColor='rgba(157, 123, 255, 0.4)'; this.style.transform='translateY(0)'; this.style.boxShadow='none';"
                  style="width: 100%; padding: 0.75rem; background: rgba(157, 123, 255, 0.2); border: 1px solid rgba(157, 123, 255, 0.4); color: #e6d9ff; font-family: 'Cinzel', serif; font-size: 0.75rem; letter-spacing: 0.15em; cursor: pointer; text-transform: uppercase; transition: all 0.2s ease; font-weight: 600;">
            Populate Proposal Form
          </button>
        `;

        // Focus on input
        setTimeout(() => {
          const input = document.getElementById('quorumPercentage');
          if (input) {
            input.select();
            input.focus();
          }
        }, 100);
      }

      function clearQuorumHelper() {
        const helperDiv = document.getElementById('quorumHelper');
        if (helperDiv) helperDiv.remove();
      }

      async function populateQuorumProposal(daoAddress) {
        try {
          const percentInput = document.getElementById('quorumPercentage').value.trim();

          if (!percentInput || isNaN(percentInput) || parseFloat(percentInput) < 0 || parseFloat(percentInput) > 100) {
            showStatus('Please enter a valid percentage (0-100)', true);
            return;
          }

          const quorumBps = Math.floor(parseFloat(percentInput) * 100);

          // Encode setQuorum(uint256 bps)
          const iface = new ethers.Interface(['function setQuorum(uint256)']);
          const calldata = iface.encodeFunctionData('setQuorum', [quorumBps]);

          document.getElementById('proposalTo').value = daoAddress;
          document.getElementById('proposalValue').value = '0';
          document.getElementById('proposalData').value = calldata;
          document.getElementById('proposalDescription').value = `Change quorum to ${percentInput}%`;

          // Update UI hints and translations
          updateTargetAddressHint();
          updateCalldataTranslation();
          updateCalldataPreview();

          showStatus('Proposal form populated!', false);
          clearQuorumHelper();

          // Scroll to show the populated form
          setTimeout(() => {
            document.getElementById('proposalDescription').scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);

        } catch (error) {
          console.error('Error populating quorum proposal:', error);
          showStatus('Failed to populate form: ' + error.message, true);
        }
      }

      // Ragequit proposal helper
      async function prepareRagequitProposal() {
        if (!currentDAO || !currentDAO.dao) {
          showStatus('Please select a DAO first', true);
          return;
        }

        const dao = currentDAO.dao;
        const daoAddress = dao.dao;
        const currentRagequit = dao.gov.ragequittable;

        // Scroll to proposal form
        const proposalForm = document.querySelector('.proposal-form');
        if (proposalForm) {
          proposalForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Add ragequit helper UI if not already present
        let helperDiv = document.getElementById('ragequitHelper');
        if (!helperDiv) {
          helperDiv = document.createElement('div');
          helperDiv.id = 'ragequitHelper';
          helperDiv.style.cssText = 'margin-bottom: 1rem; padding: 1rem; background: rgba(157, 123, 255, 0.1); border: 1px solid rgba(157, 123, 255, 0.3); border-radius: 4px;';
          proposalForm.insertBefore(helperDiv, proposalForm.querySelector('.proposal-form-group'));
        }

        const newStatus = !currentRagequit;
        const actionText = newStatus ? 'Enable' : 'Disable';

        // Show ragequit helper
        helperDiv.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
            <div style="font-family: 'Cinzel', serif; font-size: 0.85rem; color: #9d7bff; letter-spacing: 0.1em;">
              TOGGLE RAGEQUIT
            </div>
            <button onclick="clearRagequitHelper()" style="background: none; border: none; color: rgba(230, 217, 255, 0.6); cursor: pointer; font-size: 1.2rem; padding: 0; line-height: 1;">&times;</button>
          </div>
          <div style="margin-bottom: 0.75rem; padding: 0.75rem; background: rgba(157, 123, 255, 0.1); border-radius: 4px;">
            <div style="font-size: 0.85rem; color: rgba(230, 217, 255, 0.8); margin-bottom: 0.5rem;">
              Current Status: <strong>${currentRagequit ? 'Enabled' : 'Disabled'}</strong>
            </div>
            <div style="font-size: 0.85rem; color: rgba(230, 217, 255, 0.8);">
              This proposal will: <strong>${actionText} Ragequit</strong>
            </div>
            <div style="margin-top: 0.5rem; font-size: 0.75rem; color: rgba(230, 217, 255, 0.5);">
              Ragequit allows members to exit the DAO and claim their proportional share of treasury
            </div>
          </div>
          <button onclick="populateRagequitProposal('${daoAddress}', ${newStatus})"
                  onmouseover="this.style.background='rgba(157, 123, 255, 0.35)'; this.style.borderColor='#9d7bff'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(157, 123, 255, 0.3)';"
                  onmouseout="this.style.background='rgba(157, 123, 255, 0.2)'; this.style.borderColor='rgba(157, 123, 255, 0.4)'; this.style.transform='translateY(0)'; this.style.boxShadow='none';"
                  style="width: 100%; padding: 0.75rem; background: rgba(157, 123, 255, 0.2); border: 1px solid rgba(157, 123, 255, 0.4); color: #e6d9ff; font-family: 'Cinzel', serif; font-size: 0.75rem; letter-spacing: 0.15em; cursor: pointer; text-transform: uppercase; transition: all 0.2s ease; font-weight: 600;">
            Populate Proposal Form
          </button>
        `;
      }

      function clearRagequitHelper() {
        const helperDiv = document.getElementById('ragequitHelper');
        if (helperDiv) helperDiv.remove();
      }

      async function populateRagequitProposal(daoAddress, newStatus) {
        try {
          // Encode setRagequittable(bool)
          const iface = new ethers.Interface(['function setRagequittable(bool)']);
          const calldata = iface.encodeFunctionData('setRagequittable', [newStatus]);

          document.getElementById('proposalTo').value = daoAddress;
          document.getElementById('proposalValue').value = '0';
          document.getElementById('proposalData').value = calldata;
          document.getElementById('proposalDescription').value = `${newStatus ? 'Enable' : 'Disable'} ragequit`;

          // Update UI hints and translations
          updateTargetAddressHint();
          updateCalldataTranslation();
          updateCalldataPreview();

          showStatus('Proposal form populated!', false);
          clearRagequitHelper();

          // Scroll to show the populated form
          setTimeout(() => {
            document.getElementById('proposalDescription').scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);

        } catch (error) {
          console.error('Error populating ragequit proposal:', error);
          showStatus('Failed to populate form: ' + error.message, true);
        }
      }

      // Purchase modal functions
      function openPurchaseModal(payToken, tokenSymbol, tokenDecimals, isLoot) {
        if (!signer) {
          showStatus('Please connect wallet first', true);
          return;
        }

        const modal = document.getElementById('purchaseModal');
        const content = document.getElementById('purchaseModalContent');

        const tokenType = isLoot ? 'LOOT' : 'SHARES';
        const daoSymbol = currentDAO.dao.meta.symbol;
        const targetSymbol = isLoot ? `${daoSymbol}-LOOT` : daoSymbol;

        content.innerHTML = `
          <div style="margin-bottom: 1rem;">
            <label style="display: block; font-size: 0.85rem; color: rgba(230, 217, 255, 0.7); margin-bottom: 0.5rem;">Amount to Purchase (${targetSymbol})</label>
            <input type="number" id="purchaseAmount" placeholder="0.0" step="any" min="0"
                   style="width: 100%; padding: 0.75rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 1rem;" />
          </div>
          <div style="margin-bottom: 1.5rem; padding: 0.75rem; background: rgba(157, 123, 255, 0.1); border-radius: 4px; font-size: 0.85rem; color: rgba(230, 217, 255, 0.8);">
            Payment will be in <strong>${tokenSymbol}</strong>
          </div>
          <button onclick="executePurchase('${payToken}', ${tokenDecimals}, ${isLoot})"
                  style="width: 100%; padding: 0.875rem; background: rgba(157, 123, 255, 0.2); border: 1px solid rgba(157, 123, 255, 0.4); color: #e6d9ff; font-family: 'Cinzel', serif; font-size: 0.8rem; letter-spacing: 0.15em; cursor: pointer; text-transform: uppercase; font-weight: 600;">
            Confirm Purchase
          </button>
        `;

        modal.classList.add('show');
      }

      function closePurchaseModal() {
        document.getElementById('purchaseModal').classList.remove('show');
      }

      async function executePurchase(payToken, tokenDecimals, isLoot) {
        try {
          const amountInput = document.getElementById('purchaseAmount').value.trim();
          if (!amountInput || parseFloat(amountInput) <= 0) {
            showStatus('Please enter a valid amount', true);
            return;
          }

          const shareAmount = ethers.parseEther(amountInput);
          const molochContract = new ethers.Contract(currentDAO.dao.dao, MOLOCH_ABI, signer);
          const sale = await molochContract.sales(payToken);

          if (!sale.active) {
            showStatus('Sale is no longer active', true);
            return;
          }

          const cost = shareAmount * sale.pricePerShare / (10n ** 18n);
          const maxPay = cost * 105n / 100n; // 5% slippage

          showStatus('Confirming purchase...', false);

          let tx;
          if (payToken === ethers.ZeroAddress) {
            tx = await molochContract.buyShares(payToken, shareAmount, maxPay, { value: cost });
          } else {
            tx = await molochContract.buyShares(payToken, shareAmount, maxPay);
          }

          showStatus('Transaction submitted. Waiting for confirmation...', false);
          await tx.wait();

          const tokenType = isLoot ? 'LOOT' : 'SHARES';
          showStatus(`Purchase successful! You received ${amountInput} ${tokenType}`, false);
          closePurchaseModal();
          await refreshCurrentDAO();
          await renderSalesInfo();
        } catch (error) {
          console.error('Purchase failed:', error);

          if (isUserRejection(error)) {
            showStatus('Purchase cancelled', false);
            return;
          }

          let errorMessage = 'Purchase failed';
          if (error.message?.includes('insufficient')) {
            errorMessage = 'Insufficient balance or allowance';
          } else if (error.shortMessage) {
            errorMessage = error.shortMessage;
          } else if (error.reason) {
            errorMessage = error.reason;
          }

          showStatus(errorMessage, true);
        }
      }

      // Populate sale proposal from Send/Sale toggle
      async function populateSaleProposalFromToggle(symbol, address, decimals) {
        try {
          // Get elements from within the transferHelper div to avoid conflicts
          const helperDiv = document.getElementById('transferHelper');
          if (!helperDiv) {
            showStatus('Helper not found - please try again', true);
            return;
          }

          const tokenTypeEl = helperDiv.querySelector('#saleTokenType');
          const priceEl = helperDiv.querySelector('#salePrice');
          const capEl = helperDiv.querySelector('#saleCap');
          const mintingEl = helperDiv.querySelector('#saleMinting');
          const statusEl = helperDiv.querySelector('#saleStatus');

          if (!priceEl) {
            showStatus('Form elements not found - please try again', true);
            return;
          }

          const tokenType = tokenTypeEl?.value;
          const priceInput = priceEl?.value?.trim();
          const capInput = capEl?.value?.trim();
          const minting = mintingEl?.checked;
          const status = statusEl?.value;

          if (!priceInput || isNaN(priceInput) || parseFloat(priceInput) <= 0) {
            showStatus('⚠️ Please enter a valid price per token (required field)', true);
            // Highlight the price field
            if (priceEl) {
              priceEl.style.border = '2px solid #ff6b6b';
              priceEl.focus();
              setTimeout(() => {
                priceEl.style.border = '1px solid rgba(157, 123, 255, 0.3)';
              }, 2000);
            }
            return;
          }

          const pricePerShare = ethers.parseUnits(priceInput, decimals);
          const cap = capInput && parseFloat(capInput) > 0 ? ethers.parseEther(capInput) : 0n;
          const isLoot = tokenType === 'loot';
          const active = status === 'active';

          // Get DAO address
          if (!currentDAO || !currentDAO.dao || !currentDAO.dao.dao) {
            showStatus('DAO not loaded', true);
            return;
          }
          const daoAddress = currentDAO.dao.dao;

          // Encode setSale call
          const saleIface = new ethers.Interface([
            'function setSale(address,uint256,uint256,bool,bool,bool)'
          ]);
          const calldata = saleIface.encodeFunctionData('setSale', [
            address, pricePerShare, cap, minting, active, isLoot
          ]);

          // Populate proposal form
          document.getElementById('proposalTo').value = daoAddress;
          document.getElementById('proposalValue').value = '0';
          document.getElementById('proposalData').value = calldata;

          const tokenTypeText = isLoot ? 'LOOT' : 'SHARES';
          const sourceText = minting ? 'minting new tokens' : 'selling from treasury';
          const capText = cap > 0n ? `${ethers.formatEther(cap)} tokens` : 'unlimited';
          const statusText = active ? 'ACTIVE' : 'INACTIVE';

          document.getElementById('proposalDescription').value =
            `Configure ${symbol} sale: ${priceInput} ${symbol} per ${tokenTypeText} token, ${capText} cap, ${sourceText}, status: ${statusText}`;

          // Update UI hints and translations
          updateTargetAddressHint();
          updateCalldataTranslation();
          updateCalldataPreview();

          showStatus('Proposal form populated with sale configuration', false);
          clearTransferHelper();

          // Scroll to description
          setTimeout(() => {
            document.getElementById('proposalDescription').scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 100);
        } catch (error) {
          console.error('Error populating sale proposal:', error);
          showStatus('Failed to populate sale proposal: ' + error.message, true);
        }
      }

      // Sale proposal helper
      async function prepareSaleProposal() {
        if (!currentDAO || !currentDAO.dao) {
          showStatus('Please select a DAO first', true);
          return;
        }

        const proposalForm = document.querySelector('.proposal-form');
        if (proposalForm) {
          proposalForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        let helperDiv = document.getElementById('saleHelper');
        if (!helperDiv) {
          helperDiv = document.createElement('div');
          helperDiv.id = 'saleHelper';
          helperDiv.style.cssText = 'margin-bottom: 1rem; padding: 1rem; background: rgba(157, 123, 255, 0.1); border: 1px solid rgba(157, 123, 255, 0.3); border-radius: 4px;';
          proposalForm.insertBefore(helperDiv, proposalForm.querySelector('.proposal-form-group'));
        }

        helperDiv.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
            <div style="font-family: 'Cinzel', serif; font-size: 0.85rem; color: #9d7bff; letter-spacing: 0.1em;">CONFIGURE TOKEN SALE</div>
            <button onclick="clearSaleHelper()" style="background: none; border: none; color: rgba(230, 217, 255, 0.6); cursor: pointer; font-size: 1.2rem; padding: 0; line-height: 1;">&times;</button>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
            <div>
              <label style="display: block; font-size: 0.75rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.35rem;">Payment Token</label>
              <select id="salePayToken" style="width: 100%; padding: 0.6rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 0.95rem;">
                <option value="${ethers.ZeroAddress}">ETH</option>
                <option value="${TOKEN_ADDRESSES.usdc}">USDC</option>
                <option value="${TOKEN_ADDRESSES.usdt}">USDT</option>
                <option value="${TOKEN_ADDRESSES.dai}">DAI</option>
                <option value="${TOKEN_ADDRESSES.wsteth}">wstETH</option>
                <option value="${TOKEN_ADDRESSES.reth}">rETH</option>
              </select>
            </div>
            <div>
              <label style="display: block; font-size: 0.75rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.35rem;">Token Type</label>
              <select id="saleTokenType" style="width: 100%; padding: 0.6rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 0.95rem;">
                <option value="false">Shares</option>
                <option value="true">Loot</option>
              </select>
            </div>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
            <div>
              <label style="display: block; font-size: 0.75rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.35rem;">Price per Token</label>
              <input type="number" id="salePrice" placeholder="0.0" step="any" min="0" style="width: 100%; padding: 0.6rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 0.95rem;" />
            </div>
            <div>
              <label style="display: block; font-size: 0.75rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.35rem;">Cap (0 = unlimited)</label>
              <input type="number" id="saleCap" placeholder="0" step="any" min="0" style="width: 100%; padding: 0.6rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 0.95rem;" />
            </div>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
            <div>
              <label style="display: block; font-size: 0.75rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.35rem;">Source</label>
              <select id="saleMinting" style="width: 100%; padding: 0.6rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 0.95rem;">
                <option value="true">Mint new</option>
                <option value="false">From treasury</option>
              </select>
            </div>
            <div>
              <label style="display: block; font-size: 0.75rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.35rem;">Status</label>
              <select id="saleActive" style="width: 100%; padding: 0.6rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(157, 123, 255, 0.3); color: #e6d9ff; font-family: 'EB Garamond', serif; font-size: 0.95rem;">
                <option value="true">Active</option>
                <option value="false">Inactive</option>
              </select>
            </div>
          </div>
          <button onclick="populateSaleProposal('${currentDAO.dao.dao}')"
                  onmouseover="this.style.background='rgba(157, 123, 255, 0.35)'; this.style.borderColor='#9d7bff';"
                  onmouseout="this.style.background='rgba(157, 123, 255, 0.2)'; this.style.borderColor='rgba(157, 123, 255, 0.4)';"
                  style="width: 100%; padding: 0.75rem; background: rgba(157, 123, 255, 0.2); border: 1px solid rgba(157, 123, 255, 0.4); color: #e6d9ff; font-family: 'Cinzel', serif; font-size: 0.75rem; letter-spacing: 0.15em; cursor: pointer; text-transform: uppercase; transition: all 0.2s ease; font-weight: 600;">
            Populate Proposal Form
          </button>
        `;
      }

      function clearSaleHelper() {
        const helperDiv = document.getElementById('saleHelper');
        if (helperDiv) helperDiv.remove();
      }

      async function populateSaleProposal(daoAddress) {
        try {
          const payToken = document.getElementById('salePayToken').value;
          const priceInput = document.getElementById('salePrice').value.trim();
          const capInput = document.getElementById('saleCap').value.trim();
          const minting = document.getElementById('saleMinting').value === 'true';
          const active = document.getElementById('saleActive').value === 'true';
          const isLoot = document.getElementById('saleTokenType').value === 'true';

          if (!priceInput || parseFloat(priceInput) <= 0) {
            showStatus('Please enter a valid price', true);
            return;
          }

          const tokenNames = {
            [ethers.ZeroAddress]: 'ETH',
            [TOKEN_ADDRESSES.usdc]: 'USDC',
            [TOKEN_ADDRESSES.usdt]: 'USDT',
            [TOKEN_ADDRESSES.dai]: 'DAI',
            [TOKEN_ADDRESSES.wsteth]: 'wstETH',
            [TOKEN_ADDRESSES.reth]: 'rETH'
          };

          const tokenDecimals = {
            [ethers.ZeroAddress]: 18,
            [TOKEN_ADDRESSES.usdc]: 6,
            [TOKEN_ADDRESSES.usdt]: 6,
            [TOKEN_ADDRESSES.dai]: 18,
            [TOKEN_ADDRESSES.wsteth]: 18,
            [TOKEN_ADDRESSES.reth]: 18
          };

          const tokenName = tokenNames[payToken];
          const decimals = tokenDecimals[payToken];

          const pricePerShare = ethers.parseUnits(priceInput, decimals);
          const cap = capInput && parseFloat(capInput) > 0 ? ethers.parseEther(capInput) : 0n;

          const abiCoder = new ethers.AbiCoder();
          const saleCalldata = '0x62843c99' + abiCoder.encode(
            ['address', 'uint256', 'uint256', 'bool', 'bool', 'bool'],
            [payToken, pricePerShare, cap, minting, active, isLoot]
          ).slice(2);

          const tokenType = isLoot ? 'LOOT' : 'SHARES';
          const statusText = active ? 'Enable' : 'Disable';
          const sourceText = minting ? 'mint new' : 'sell from treasury';
          const capText = cap > 0n ? `, cap ${ethers.formatEther(cap)}` : ', unlimited';
          const description = `${statusText} ${tokenType} sale: ${priceInput} ${tokenName} per token (${sourceText}${capText})`;

          document.getElementById('proposalTo').value = daoAddress;
          document.getElementById('proposalValue').value = '0';
          document.getElementById('proposalData').value = saleCalldata;
          document.getElementById('proposalDescription').value = description;

          updateTargetAddressHint();
          updateCalldataTranslation();
          updateCalldataPreview();

          showStatus('Proposal form populated!', false);
          clearSaleHelper();

          setTimeout(() => {
            document.getElementById('proposalDescription').scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);
        } catch (error) {
          console.error('Error populating sale proposal:', error);
          showStatus('Failed to populate form: ' + error.message, true);
        }
      }

      // Open DAO dashboard
      async function openDAO(daoIndex, source = 'user') {
        // Get the DAO from the appropriate source
        if (source === 'all') {
          currentDAO = { dao: allDAOs[daoIndex], member: null };
        } else {
          currentDAO = userDAOs[daoIndex];
        }

        const dashboardTitle = document.getElementById('dashboardTitle');
        dashboardTitle.textContent = currentDAO.dao.meta.name;

        // Update Etherscan link
        const daoAddress = currentDAO.dao.dao;
        const etherscanLink = document.getElementById('daoEtherscanLink');
        const addressText = document.getElementById('daoAddressText');
        etherscanLink.href = `https://etherscan.io/address/${daoAddress}`;
        addressText.textContent = `${daoAddress.slice(0, 6)}...${daoAddress.slice(-4)}`;

        renderChatroom();
        await renderProposals();
        renderTreasury();
        renderGovernanceInfo();
        await renderSalesInfo();
        renderDaoStats();
        await renderDAOEmblem(daoAddress);

        // Show/hide membership tab based on membership status
        const membershipBtn = document.getElementById('viewToggleMembership');
        if (currentDAO.member) {
          membershipBtn.style.display = 'block';
        } else {
          membershipBtn.style.display = 'none';
          // Ensure we're on DAO view if no membership
          switchDaoView('dao');
        }

        document.getElementById('daoGallery').classList.remove('show');
        document.getElementById('allDaosGallery').classList.remove('show');
        document.getElementById('daoDashboard').classList.add('show');
      }

      // Back to gallery
      function backToGallery() {
        currentDAO = null;
        document.getElementById('daoDashboard').classList.remove('show');
        document.getElementById('daoGallery').classList.add('show');
        document.getElementById('allDaosGallery').classList.add('show');

        // Reset to DAO view
        switchDaoView('dao');
      }

      // Switch between DAO dashboard, membership, and members view
      function switchDaoView(view) {
        const daoView = document.getElementById('daoDashboardView');
        const membershipView = document.getElementById('daoMembershipView');
        const membersView = document.getElementById('daoMembersView');
        const daoBtn = document.getElementById('viewToggleDao');
        const membershipBtn = document.getElementById('viewToggleMembership');
        const membersBtn = document.getElementById('viewToggleMembers');

        // Hide all views
        daoView.classList.remove('show');
        daoView.classList.add('hide');
        membershipView.classList.remove('show');
        membersView.classList.remove('show');

        // Deactivate all buttons
        daoBtn.classList.remove('active');
        membershipBtn.classList.remove('active');
        membersBtn.classList.remove('active');

        if (view === 'membership') {
          membershipView.classList.add('show');
          membershipBtn.classList.add('active');
          renderMembership();
        } else if (view === 'members') {
          membersView.classList.add('show');
          membersBtn.classList.add('active');
          renderMembers();
        } else {
          daoView.classList.remove('hide');
          daoView.classList.add('show');
          daoBtn.classList.add('active');
        }
      }

      // Render membership dashboard
      async function renderMembership() {
        if (!currentDAO || !currentDAO.member) {
          document.getElementById('badgeContent').innerHTML = '<p style="text-align: center; color: rgba(230, 217, 255, 0.6); font-style: italic;">No membership data available</p>';
          return;
        }

        const member = currentDAO.member;
        const dao = currentDAO.dao;

        // Update balances
        const shares = ethers.formatUnits(member.shares, 18);
        const loot = ethers.formatUnits(member.loot, 18);
        document.getElementById('membershipShares').textContent = parseFloat(shares).toFixed(4);
        document.getElementById('membershipLoot').textContent = parseFloat(loot).toFixed(4);

        // Update Etherscan links for tokens
        if (dao.meta && dao.meta.sharesToken) {
          const sharesLink = document.getElementById('sharesEtherscanLink');
          sharesLink.href = `https://etherscan.io/token/${dao.meta.sharesToken}`;
          sharesLink.style.display = 'inline';
          sharesLink.onmouseover = () => { sharesLink.style.opacity = '1'; sharesLink.style.transform = 'translateY(-1px)'; };
          sharesLink.onmouseout = () => { sharesLink.style.opacity = '0.7'; sharesLink.style.transform = 'translateY(0)'; };
        }

        if (dao.meta && dao.meta.lootToken) {
          const lootLink = document.getElementById('lootEtherscanLink');
          lootLink.href = `https://etherscan.io/token/${dao.meta.lootToken}`;
          lootLink.style.display = 'inline';
          lootLink.onmouseover = () => { lootLink.style.opacity = '1'; lootLink.style.transform = 'translateY(-1px)'; };
          lootLink.onmouseout = () => { lootLink.style.opacity = '0.7'; lootLink.style.transform = 'translateY(0)'; };
        }

        if (dao.meta && dao.meta.badgesToken) {
          const badgeLink = document.getElementById('badgeEtherscanLink');
          badgeLink.href = `https://etherscan.io/token/${dao.meta.badgesToken}`;
          badgeLink.style.display = 'inline';
          badgeLink.onmouseover = () => { badgeLink.style.opacity = '1'; badgeLink.style.transform = 'translateY(-1px)'; };
          badgeLink.onmouseout = () => { badgeLink.style.opacity = '0.7'; badgeLink.style.transform = 'translateY(0)'; };
        }

        // Update badge info
        const badgeSeat = member.seatId;
        if (badgeSeat > 0) {
          document.getElementById('membershipBadge').textContent = `Seat #${badgeSeat}`;
          await renderBadge(dao.dao, badgeSeat);
        } else {
          document.getElementById('membershipBadge').textContent = 'No Badge';
          document.getElementById('badgeContent').innerHTML = '<p style="text-align: center; color: rgba(230, 217, 255, 0.6); font-style: italic; margin-top: 1rem;">You don\'t have a badge seat yet</p>';
        }

        // Render vote receipts
        await renderVoteReceipts();
      }

      // Render badge NFT
      async function renderBadge(daoAddress, seatId) {
        const badgeContent = document.getElementById('badgeContent');

        try {
          // Get badges contract address (predicted from DAO)
          const predictions = predictMajeurAddresses([], [], ethers.randomBytes(32));
          const badgesAddress = predictions.badges;

          // Use the correct badges contract from the DAO
          const molochContract = new ethers.Contract(daoAddress, MOLOCH_ABI, provider);
          const badgesAddr = await molochContract.badges();

          const badgesABI = [
            'function tokenURI(uint256) view returns (string)',
          ];
          const badgesContract = new ethers.Contract(badgesAddr, badgesABI, provider);

          const tokenURI = await badgesContract.tokenURI(seatId);

          // Parse metadata (could be data URI or IPFS)
          let metadata;
          if (tokenURI.startsWith('data:application/json;base64,')) {
            const json = atob(tokenURI.slice(29));
            metadata = JSON.parse(json);
          } else if (tokenURI.startsWith('data:application/json,')) {
            metadata = JSON.parse(decodeURIComponent(tokenURI.slice(22)));
          } else {
            // Fetch from URL
            const response = await fetch(tokenURI);
            metadata = await response.json();
          }

          // Render badge
          let imageHTML = '';
          if (metadata.image) {
            if (metadata.image.startsWith('data:image/svg+xml')) {
              imageHTML = `<img src="${metadata.image}" class="badge-image" alt="Badge #${seatId}" />`;
            } else if (metadata.image.startsWith('data:')) {
              imageHTML = `<img src="${metadata.image}" class="badge-image" alt="Badge #${seatId}" />`;
            } else {
              imageHTML = `<img src="${metadata.image}" class="badge-image" alt="Badge #${seatId}" />`;
            }
          }

          // OpenSea link
          const openseaLink = `https://opensea.io/assets/ethereum/${badgesAddr.toLowerCase()}/${seatId}`;

          badgeContent.innerHTML = `
            <div style="cursor: pointer;" onclick="openNFTModal(${JSON.stringify(metadata).replace(/"/g, '&quot;')}, 'Member Badge')">
              ${imageHTML}
            </div>
            <div style="margin-top: 1rem;">
              <div style="font-family: 'Cinzel', serif; font-size: 0.9rem; color: #9d7bff; margin-bottom: 0.5rem;">
                ${metadata.name || `Badge #${seatId}`}
              </div>
              ${metadata.description ? `<div style="font-family: 'EB Garamond', serif; font-size: 0.9rem; color: rgba(230, 217, 255, 0.8); margin-bottom: 0.75rem;">${metadata.description}</div>` : ''}
              <div style="display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap;">
                <button onclick="openNFTModal(${JSON.stringify(metadata).replace(/"/g, '&quot;')}, 'Member Badge')" style="padding: 0.5rem 1rem; background: rgba(157, 123, 255, 0.1); border: 1px solid rgba(157, 123, 255, 0.3); color: #9d7bff; font-family: 'EB Garamond', serif; font-size: 0.85rem; cursor: pointer; transition: all 0.2s; border-radius: 4px;">
                  View Details
                </button>
                <a href="${openseaLink}" target="_blank" rel="noopener noreferrer" style="display: inline-flex; align-items: center; gap: 0.4rem; font-family: 'EB Garamond', serif; font-size: 0.85rem; color: rgba(157, 123, 255, 0.8); text-decoration: none; transition: color 0.2s; padding: 0.5rem 1rem; background: rgba(157, 123, 255, 0.05); border: 1px solid rgba(157, 123, 255, 0.2); border-radius: 4px;">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                    <polyline points="15 3 21 3 21 9"></polyline>
                    <line x1="10" y1="14" x2="21" y2="3"></line>
                  </svg>
                  OpenSea
                </a>
              </div>
            </div>
          `;
        } catch (error) {
          console.error('Error rendering badge:', error);
          badgeContent.innerHTML = `
            <div style="text-align: center; padding: 2rem;">
              <div style="font-size: 3rem; margin-bottom: 1rem;">🎖️</div>
              <div style="font-family: 'Cinzel', serif; font-size: 1rem; color: #9d7bff;">Seat #${seatId}</div>
              <div style="font-family: 'EB Garamond', serif; font-size: 0.85rem; color: rgba(230, 217, 255, 0.6); margin-top: 0.5rem;">Badge metadata unavailable</div>
            </div>
          `;
        }
      }

      // Render vote receipts collection
      async function renderVoteReceipts() {
        const receiptsGrid = document.getElementById('receiptsGrid');
        if (!currentDAO || !connectedAddress) {
          receiptsGrid.innerHTML = '<p style="text-align: center; color: rgba(230, 217, 255, 0.6); font-style: italic; grid-column: 1/-1;">Connect wallet to view receipts</p>';
          return;
        }

        const receipts = [];
        const molochContract = new ethers.Contract(currentDAO.dao.dao, MOLOCH_ABI, provider);

        // Use voters data from view helper to find user's votes (no hasVoted RPC calls!)
        const userVotedProposals = currentDAO.dao.proposals.filter(proposal => {
          return proposal.voters?.some(v => v.voter?.toLowerCase() === connectedAddress.toLowerCase());
        });

        // Batch balance checks in parallel
        const balancePromises = userVotedProposals.map(async (proposal) => {
          const userVote = proposal.voters.find(v => v.voter?.toLowerCase() === connectedAddress.toLowerCase());
          const support = Number(userVote.support); // 0=Against, 1=For, 2=Abstain
          const receiptId = ethers.solidityPackedKeccak256(
            ['string', 'uint256', 'uint8'],
            ['Moloch:receipt', proposal.id, support]
          );

          try {
            const balance = await molochContract.balanceOf(connectedAddress, receiptId);
            if (balance > 0n) {
              return {
                proposalId: proposal.id,
                support,
                balance,
                receiptId
              };
            }
          } catch (err) {
            console.error('Error checking receipt balance:', err);
          }
          return null;
        });

        const results = await Promise.all(balancePromises);
        receipts.push(...results.filter(r => r !== null));

        if (receipts.length === 0) {
          receiptsGrid.innerHTML = '<p style="text-align: center; color: rgba(230, 217, 255, 0.6); font-style: italic; grid-column: 1/-1;">No vote receipts yet. Vote on proposals to collect them!</p>';
          return;
        }

        // Render receipt cards with metadata
        receiptsGrid.innerHTML = '<p style="text-align: center; color: rgba(230, 217, 255, 0.6); font-style: italic; grid-column: 1/-1;">Loading receipt metadata...</p>';

        const supportLabels = ['Against', 'For', 'Abstain'];
        const supportColors = ['#ff6b6b', '#66ff66', '#9d7bff'];

        // Fetch metadata for all receipts
        const receiptPromises = receipts.map(async receipt => {
          try {
            const tokenURI = await molochContract.tokenURI(receipt.receiptId);

            // Parse metadata (could be data URI or IPFS)
            let metadata;
            if (tokenURI.startsWith('data:application/json;base64,')) {
              const json = atob(tokenURI.slice(29));
              metadata = JSON.parse(json);
            } else if (tokenURI.startsWith('data:application/json,')) {
              metadata = JSON.parse(decodeURIComponent(tokenURI.slice(22)));
            } else {
              // Fetch from URL
              const response = await fetch(tokenURI);
              metadata = await response.json();
            }

            return { ...receipt, metadata };
          } catch (error) {
            console.error('Error fetching receipt metadata:', error);
            return { ...receipt, metadata: null };
          }
        });

        const receiptsWithMetadata = await Promise.all(receiptPromises);

        receiptsGrid.innerHTML = '';

        receiptsWithMetadata.forEach(receipt => {
          const card = document.createElement('div');
          card.className = 'receipt-card';

          const balanceFormatted = ethers.formatUnits(receipt.balance, 18);
          const supportLabel = supportLabels[receipt.support];
          const supportColor = supportColors[receipt.support];

          let imageHTML = '';
          let nameHTML = '';

          if (receipt.metadata) {
            if (receipt.metadata.image) {
              imageHTML = `<img src="${receipt.metadata.image}" class="receipt-image" alt="Receipt" />`;
            }
            if (receipt.metadata.name) {
              nameHTML = `<div class="receipt-name">${receipt.metadata.name}</div>`;
            }
          }

          card.innerHTML = `
            ${imageHTML}
            ${nameHTML}
            <div class="receipt-proposal">Proposal #${receipt.proposalId.toString().slice(0, 8)}...</div>
            <div class="receipt-vote" style="color: ${supportColor};">Voted ${supportLabel}</div>
            <div class="receipt-amount">${parseFloat(balanceFormatted).toFixed(4)} receipts</div>
          `;

          // Make card clickable to open modal
          card.onclick = () => openNFTModal(receipt.metadata, 'Vote Receipt');

          receiptsGrid.appendChild(card);
        });
      }

      // Render DAO emblem from contractURI
      async function renderDAOEmblem(daoAddress) {
        const emblem = document.getElementById('daoEmblem');
        if (!emblem) return;

        try {
          const molochContract = new ethers.Contract(daoAddress, MOLOCH_ABI, provider);
          const contractURI = await molochContract.contractURI();

          if (!contractURI) {
            emblem.style.display = 'none';
            return;
          }

          // Parse metadata
          let metadata;
          if (contractURI.startsWith('data:application/json;base64,')) {
            const json = atob(contractURI.slice(29));
            metadata = JSON.parse(json);
          } else if (contractURI.startsWith('data:application/json,')) {
            metadata = JSON.parse(decodeURIComponent(contractURI.slice(22)));
          } else {
            const response = await fetch(contractURI);
            metadata = await response.json();
          }

          if (metadata && metadata.image) {
            emblem.innerHTML = `<img src="${metadata.image}" alt="DAO Emblem" />`;
            emblem.style.display = 'block';
            emblem.onclick = () => openNFTModal(metadata, 'DAO Contract');
          } else {
            emblem.style.display = 'none';
          }
        } catch (error) {
          console.error('Error rendering DAO emblem:', error);
          emblem.style.display = 'none';
        }
      }

      // Open NFT modal
      function openNFTModal(metadata, title) {
        if (!metadata) return;

        const modal = document.getElementById('nftModal');
        const modalBody = document.getElementById('nftModalBody');

        let imageHTML = '';
        if (metadata.image) {
          imageHTML = `<img src="${metadata.image}" class="nft-modal-image" alt="${title}" />`;
        }

        let attributesHTML = '';
        if (metadata.attributes && Array.isArray(metadata.attributes)) {
          attributesHTML = `
            <div class="nft-modal-attributes">
              ${metadata.attributes.map(attr => `
                <div class="nft-modal-attribute">
                  <div class="nft-modal-attribute-label">${attr.trait_type || attr.type || 'Attribute'}</div>
                  <div class="nft-modal-attribute-value">${attr.value}</div>
                </div>
              `).join('')}
            </div>
          `;
        }

        modalBody.innerHTML = `
          ${imageHTML}
          <div class="nft-modal-title">${metadata.name || title}</div>
          ${metadata.description ? `<div class="nft-modal-description">${metadata.description}</div>` : ''}
          ${attributesHTML}
        `;

        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
      }

      // Close NFT modal
      function closeNFTModal() {
        const modal = document.getElementById('nftModal');
        modal.classList.remove('show');
        document.body.style.overflow = '';
      }

      // Close modal with ESC key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeNFTModal();
        }
      });

      // Render tile emblem (for gallery tiles)
      async function renderTileEmblem(daoAddress, emblemId) {
        const emblem = document.getElementById(emblemId);
        if (!emblem) return;

        try {
          const molochContract = new ethers.Contract(daoAddress, MOLOCH_ABI, provider);
          const contractURI = await molochContract.contractURI();

          if (!contractURI) return;

          // Parse metadata
          let metadata;
          if (contractURI.startsWith('data:application/json;base64,')) {
            const json = atob(contractURI.slice(29));
            metadata = JSON.parse(json);
          } else if (contractURI.startsWith('data:application/json,')) {
            metadata = JSON.parse(decodeURIComponent(contractURI.slice(22)));
          } else {
            const response = await fetch(contractURI);
            metadata = await response.json();
          }

          if (metadata && metadata.image) {
            emblem.innerHTML = `<img src="${metadata.image}" alt="DAO Emblem" />`;
          }
        } catch (error) {
          console.error('Error rendering tile emblem:', error);
        }
      }

      // Render Members List
      async function renderMembers() {
        if (!currentDAO) {
          return;
        }

        const membersList = document.getElementById('membersList');
        const memberCount = document.getElementById('memberCount');
        const badgeHolderCount = document.getElementById('badgeHolderCount');

        if (!membersList) {
          console.error('membersList element NOT FOUND!');
          return;
        }

        membersList.innerHTML = '<p style="text-align: center; color: rgba(230, 217, 255, 0.6); font-style: italic;">Loading members...</p>';

        const members = currentDAO.dao.members;
        memberCount.textContent = members.length;

        let badgeHolders = 0;
        members.forEach(member => {
          // member[3] = seatId
          if (member[3] && member[3] > 0) badgeHolders++;
        });
        badgeHolderCount.textContent = badgeHolders;

        membersList.innerHTML = '';

        // Calculate total supply for ownership %
        const totalShares = currentDAO.dao.supplies.sharesTotalSupply;
        const totalLoot = currentDAO.dao.supplies.lootTotalSupply;
        const totalSupply = totalShares + totalLoot;

        // Reverse ENS resolution for each member
        const membersWithENS = await Promise.all(
          members.map(async (member) => {
            let ensName = null;
            // Member structure uses numeric indices: [0] = address
            const memberAddress = member[0];
            if (memberAddress) {
              try {
                ensName = await provider.lookupAddress(memberAddress);
              } catch (error) {
                // ENS lookup failed, continue without it
              }
            }
            return { ...member, ensName };
          })
        );

        // Render each member
        try {
          membersWithENS.forEach((member, index) => {
            // Member structure from view helper uses numeric indices:
            // [0] = address, [1] = shares, [2] = loot, [3] = seatId, [4] = delegatedShares
            const memberAddress = member[0] || member.account || member.address;
            const sharesBN = member[1] !== null && member[1] !== undefined ? member[1] : 0n;
            const lootBN = member[2] !== null && member[2] !== undefined ? member[2] : 0n;
            const seatId = member[3] || 0;

            if (!memberAddress) {
              return;
            }

            const memberDiv = document.createElement('div');
            memberDiv.className = 'member-item';

            const shares = parseFloat(ethers.formatUnits(sharesBN, 18)).toFixed(4);
            const loot = parseFloat(ethers.formatUnits(lootBN, 18)).toFixed(4);
            const badgeText = (seatId && seatId > 0) ? `Seat #${seatId}` : 'None';

            // Calculate ownership %
            const memberTotal = sharesBN + lootBN;
            const ownershipPercent = totalSupply > 0n
              ? ((Number(memberTotal) / Number(totalSupply)) * 100).toFixed(2)
              : '0.00';

            memberDiv.innerHTML = `
              <div class="member-address">
                ${member.ensName ? `<div class="member-ens">${member.ensName}</div>` : ''}
                <div class="member-address-hex">${memberAddress.slice(0, 10)}...${memberAddress.slice(-8)}</div>
              </div>
              <div class="member-shares">
                <div class="member-label">Shares</div>
                <div class="member-value">${shares}</div>
              </div>
              <div class="member-loot">
                <div class="member-label">Loot</div>
                <div class="member-value">${loot}</div>
              </div>
              <div class="member-badge">
                <div class="member-label">Badge</div>
                <div class="member-value">${badgeText}</div>
              </div>
              <div class="member-ownership">
                <div class="member-label">Ownership</div>
                <div class="member-value">${ownershipPercent}%</div>
              </div>
              <a href="https://etherscan.io/address/${memberAddress}" target="_blank" rel="noopener noreferrer" class="member-link" title="View on Etherscan">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                  <polyline points="15 3 21 3 21 9"></polyline>
                  <line x1="10" y1="14" x2="21" y2="3"></line>
                </svg>
              </a>
            `;

            membersList.appendChild(memberDiv);
          });
        } catch (error) {
          console.error('Error rendering members:', error);
          membersList.innerHTML = `<p style="text-align: center; color: #ff6b6b; padding: 2rem;">Error rendering members: ${error.message}<br><small>Check console for details</small></p>`;
        }
      }

      // Render chatroom messages
      function renderChatroom() {
        const chatroomMessages = document.getElementById('chatroomMessages');
        if (!chatroomMessages || !currentDAO) return;

        chatroomMessages.innerHTML = '';

        if (currentDAO.dao.messages.length === 0) {
          chatroomMessages.innerHTML = '<p style="text-align: center; color: rgba(230, 217, 255, 0.6); font-style: italic;">No messages yet. Be the first to chat!</p>';
          return;
        }

        currentDAO.dao.messages.forEach(message => {
          const msgDiv = document.createElement('div');
          const proposalData = decodeProposalMessage(message.text);

          msgDiv.className = 'chatroom-message' + (proposalData ? ' proposal' : '');

          let messageContent = message.text;
          if (proposalData) {
            // Format proposal message nicely
            const isETHTransfer = proposalData.value !== '0' && proposalData.data === '0x';
            const isTokenTransfer = proposalData.data.startsWith('0xa9059cbb');

            let formattedDetails = '';
            if (isETHTransfer) {
              const ethAmount = ethers.formatEther(proposalData.value);
              formattedDetails = `
                <div style="margin-top: 0.5rem; padding: 0.75rem; background: rgba(157, 123, 255, 0.1); border-left: 3px solid #9d7bff;">
                  <div style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 0.35rem;">ETH Transfer</div>
                  <div style="font-size: 0.9rem;">Amount: <strong>${ethAmount} ETH</strong></div>
                  <div style="font-size: 0.85rem; margin-top: 0.25rem;">To: <code style="background: rgba(0,0,0,0.3); padding: 0.2rem 0.4rem;">${proposalData.to}</code></div>
                </div>
              `;
            } else if (isTokenTransfer) {
              try {
                const abiCoder = new ethers.AbiCoder();
                const decoded = abiCoder.decode(['address', 'uint256'], '0x' + proposalData.data.slice(10));
                const recipient = decoded[0];
                const amount = decoded[1];
                // Try to identify token
                let tokenSymbol = 'TOKEN';
                if (proposalData.to.toLowerCase() === TOKEN_ADDRESSES.usdc.toLowerCase()) tokenSymbol = 'USDC';
                else if (proposalData.to.toLowerCase() === TOKEN_ADDRESSES.usdt.toLowerCase()) tokenSymbol = 'USDT';
                else if (proposalData.to.toLowerCase() === TOKEN_ADDRESSES.dai.toLowerCase()) tokenSymbol = 'DAI';
                else if (proposalData.to.toLowerCase() === TOKEN_ADDRESSES.wsteth.toLowerCase()) tokenSymbol = 'wstETH';
                else if (proposalData.to.toLowerCase() === TOKEN_ADDRESSES.reth.toLowerCase()) tokenSymbol = 'rETH';

                const decimals = (tokenSymbol === 'USDC' || tokenSymbol === 'USDT') ? 6 : 18;
                const formattedAmount = ethers.formatUnits(amount, decimals);

                formattedDetails = `
                  <div style="margin-top: 0.5rem; padding: 0.75rem; background: rgba(157, 123, 255, 0.1); border-left: 3px solid #9d7bff;">
                    <div style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 0.35rem;">${tokenSymbol} Transfer</div>
                    <div style="font-size: 0.9rem;">Amount: <strong>${formattedAmount} ${tokenSymbol}</strong></div>
                    <div style="font-size: 0.85rem; margin-top: 0.25rem;">To: <code style="background: rgba(0,0,0,0.3); padding: 0.2rem 0.4rem;">${recipient}</code></div>
                  </div>
                `;
              } catch (e) {
                formattedDetails = '';
              }
            }

            // Add SwissKnife link if calldata exists and is not empty
            let calldataLinkForMessage = '';
            if (proposalData.data && proposalData.data !== '0x' && proposalData.data.length > 2) {
              calldataLinkForMessage = `
                <div style="margin-top: 0.5rem;">
                  <a href="https://calldata.swiss-knife.xyz/decoder?calldata=${proposalData.data}"
                     target="_blank"
                     rel="noopener noreferrer"
                     style="font-size: 0.75rem; color: #9d7bff; text-decoration: none; display: inline-flex; align-items: center; gap: 0.35rem; opacity: 0.75; transition: opacity 0.3s ease;"
                     onmouseover="this.style.opacity='1'"
                     onmouseout="this.style.opacity='0.75'">
                    <span>🔍</span> Decode calldata on SwissKnife
                  </a>
                </div>
              `;
            }

            messageContent = `
              <strong style="color: #9d7bff; font-size: 0.85rem; letter-spacing: 0.1em;">PROPOSAL</strong>
              <div style="margin-top: 0.5rem; font-size: 1rem;">${proposalData.description}</div>
              ${formattedDetails}
              ${calldataLinkForMessage}
              <details style="margin-top: 0.75rem; opacity: 0.6;">
                <summary style="cursor: pointer; font-size: 0.75rem; letter-spacing: 0.05em; text-transform: uppercase;">Technical Details</summary>
                <pre style="margin-top: 0.5rem; padding: 0.5rem; background: rgba(0,0,0,0.4); overflow-x: auto; font-size: 0.7rem; border: 1px solid rgba(157, 123, 255, 0.2);">${JSON.stringify({op: proposalData.op, to: proposalData.to, value: proposalData.value, data: proposalData.data.slice(0, 66) + (proposalData.data.length > 66 ? '...' : ''), nonce: proposalData.nonce}, null, 2)}</pre>
              </details>
            `;
          }

          msgDiv.innerHTML = `
            <div class="chatroom-message-header">
              <span>Message #${message.index}</span>
            </div>
            <div class="chatroom-message-text">
              ${messageContent}
            </div>
          `;

          chatroomMessages.appendChild(msgDiv);
        });

        chatroomMessages.scrollTop = chatroomMessages.scrollHeight;
      }

      // Send chat message
      async function sendChatMessage() {
        if (!currentDAO || !signer) return;

        const chatInput = document.getElementById('chatInput');
        const message = chatInput.value.trim();

        if (!message) return;

        try {
          const molochContract = new ethers.Contract(currentDAO.dao.dao, MOLOCH_ABI, signer);

          const tx = await molochContract.chat(message);
          chatInput.value = 'Sending...';
          chatInput.disabled = true;

          await tx.wait();

          chatInput.value = '';
          chatInput.disabled = false;

          // Refresh messages
          await refreshCurrentDAO();
          renderChatroom();
        } catch (error) {
          console.error('Error sending message:', error);
          chatInput.value = message; // Restore the message
          chatInput.disabled = false;

          if (isUserRejection(error)) {
            showStatus('Message cancelled', false);
            return;
          }

          let errorMessage = 'Failed to send message';
          if (error.shortMessage) {
            errorMessage = error.shortMessage;
          } else if (error.reason) {
            errorMessage = error.reason;
          } else if (error.message) {
            const msg = error.message.split('\n')[0];
            if (msg.length < 100) {
              errorMessage = msg;
            }
          }

          showStatus(errorMessage, true);
        }
      }

      // Render proposals
      async function renderProposals() {
        const proposalsList = document.getElementById('proposalsList');
        if (!proposalsList || !currentDAO) return;

        proposalsList.innerHTML = '';

        if (currentDAO.dao.proposals.length === 0) {
          proposalsList.innerHTML = '<p style="text-align: center; color: rgba(230, 217, 255, 0.6); font-style: italic; margin-top: 1rem;">No proposals yet.</p>';
          return;
        }

        // Get config once for all proposals
        let daoConfig;
        try {
          const molochContract = new ethers.Contract(currentDAO.dao.dao, MOLOCH_ABI, provider);
          daoConfig = await molochContract.config();
        } catch (e) {
          console.error('Error getting DAO config:', e);
          daoConfig = 0n; // fallback
        }

        // Must match Moloch.sol enum ProposalState (line 79-87)
        const PROPOSAL_STATES = ['Unopened', 'Active', 'Queued', 'Succeeded', 'Defeated', 'Expired', 'Executed'];

        // Deduplicate proposals by ID
        const seenProposalIds = new Set();
        const uniqueProposals = currentDAO.dao.proposals.filter(proposal => {
          const id = proposal.id.toString();
          if (seenProposalIds.has(id)) {
            return false;
          }
          seenProposalIds.add(id);
          return true;
        });

        // Check if user has voted on any proposals (use voters data from view helper - no RPC calls!)
        const userVoteStatus = {};

        if (connectedAddress) {
          uniqueProposals.forEach(proposal => {
            // Check if user is in the voters array (already provided by view helper)
            const userVote = proposal.voters?.find(v =>
              v.voter?.toLowerCase() === connectedAddress.toLowerCase()
            );
            // userVoteStatus: 0 = not voted, 1 = Against, 2 = For, 3 = Abstain
            userVoteStatus[proposal.id.toString()] = userVote ? (Number(userVote.support) + 1) : 0;
          });
        }

        const molochContract = new ethers.Contract(currentDAO.dao.dao, MOLOCH_ABI, provider);

        uniqueProposals.forEach(proposal => {
          const proposalDiv = document.createElement('div');
          proposalDiv.className = 'proposal-item';

          // Convert state to number for comparison (might be BigInt)
          const state = Number(proposal.state);
          const stateText = PROPOSAL_STATES[state] || `State ${state}`;
          const stateClass = stateText.toLowerCase();

          const forVotes = ethers.formatUnits(proposal.forVotes, 18);
          const againstVotes = ethers.formatUnits(proposal.againstVotes, 18);
          const abstainVotes = ethers.formatUnits(proposal.abstainVotes, 18);

          // Determine if proposal is executable
          // State 2 = Queued (timelock running), State 3 = Succeeded (passed, ready to execute)
          // For proposals with 0 TTL and 0 timelock, Succeeded means immediately executable
          const isExecutable = (state === 2 || state === 3);

          // Check if user has voted (0 = not voted, 1 = voted against, 2 = voted for, 3 = voted abstain)
          const hasVotedValue = userVoteStatus[proposal.id.toString()] || 0;
          const userHasVoted = hasVotedValue > 0;
          const userVoteType = hasVotedValue > 0 ? ['Against', 'For', 'Abstain'][hasVotedValue - 1] : null;

          // Find proposal description from messages and verify hash
          let description = `Proposal #${proposal.id.toString()}`;
          let isVerified = false;
          let verificationBadge = '';
          let proposalCalldata = null;

          currentDAO.dao.messages.forEach(msg => {
            const propData = decodeProposalMessage(msg.text);
            if (propData) {
              try {
                // Recompute the proposal ID from the tagged data
                const recomputedId = computeProposalId(
                  currentDAO.dao.dao,
                  propData.op,
                  propData.to,
                  BigInt(propData.value),
                  propData.data,
                  propData.nonce,
                  daoConfig
                );

                // Check if it matches this proposal's ID
                if (recomputedId.toString() === proposal.id.toString()) {
                  description = propData.description || description;
                  isVerified = true;
                  proposalCalldata = propData.data;
                }
              } catch (e) {
                console.error('Error verifying proposal:', e);
              }
            }
          });

          // Only show badge if NOT verified (warning flag)
          if (!isVerified) {
            verificationBadge = '<span style="color: #ff6b6b; font-size: 0.9rem; margin-left: 0.5rem;" title="⚠ Proposal data not found in messages - cannot verify integrity">⚠ Unverified</span>';
          }

          // Create SwissKnife link if calldata exists and is not empty
          let calldataLink = '';
          if (proposalCalldata && proposalCalldata !== '0x' && proposalCalldata.length > 2) {
            calldataLink = `
              <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(157, 123, 255, 0.15);">
                <a href="https://calldata.swiss-knife.xyz/decoder?calldata=${proposalCalldata}"
                   target="_blank"
                   rel="noopener noreferrer"
                   style="font-size: 0.8rem; color: #9d7bff; text-decoration: none; display: inline-flex; align-items: center; gap: 0.35rem; opacity: 0.8; transition: opacity 0.3s ease;"
                   onmouseover="this.style.opacity='1'"
                   onmouseout="this.style.opacity='0.8'">
                  <span>🔍</span> Decode calldata on SwissKnife
                </a>
              </div>
            `;
          }

          // Check futarchy state and user receipts
          let futarchyUI = '';
          if (proposal.futarchy && proposal.futarchy.enabled && connectedAddress) {
            const futarchy = proposal.futarchy;
            const isResolved = futarchy.resolved;

            if (isResolved) {
              // Compute receipt ID for winning side
              const winnerSupport = Number(futarchy.winner); // 0 or 1
              const receiptId = ethers.solidityPackedKeccak256(
                ['string', 'uint256', 'uint8'],
                ['Moloch:receipt', proposal.id, winnerSupport]
              );

              // Check if user holds winning receipts (this will be checked async below)
              futarchyUI = `<div class="futarchy-reward-box" id="futarchy-${proposal.id.toString()}">
                <div class="futarchy-reward-title">Futarchy Rewards</div>
                <div class="futarchy-reward-info" id="futarchy-info-${proposal.id.toString()}">Checking your rewards...</div>
              </div>`;

              // Async check receipt balance and update UI
              (async () => {
                try {
                  const userReceiptBalance = await molochContract.balanceOf(connectedAddress, receiptId);
                  const infoDiv = document.getElementById(`futarchy-info-${proposal.id.toString()}`);
                  const boxDiv = document.getElementById(`futarchy-${proposal.id.toString()}`);

                  if (userReceiptBalance > 0n) {
                    const receiptAmount = ethers.formatUnits(userReceiptBalance, 18);
                    const payoutPerUnit = futarchy.payoutPerUnit;
                    const estimatedReward = (userReceiptBalance * payoutPerUnit) / (10n ** 18n);
                    const estimatedRewardFormatted = ethers.formatUnits(estimatedReward, 18);

                    infoDiv.innerHTML = `You have <strong>${parseFloat(receiptAmount).toFixed(4)} winning receipts</strong><br>Estimated reward: <strong>${parseFloat(estimatedRewardFormatted).toFixed(4)} LOOT</strong>`;

                    const claimBtn = document.createElement('button');
                    claimBtn.className = 'proposal-button claim';
                    claimBtn.textContent = 'Claim Rewards';
                    claimBtn.onclick = () => claimFutarchyReward(proposal.id.toString(), userReceiptBalance.toString());
                    boxDiv.appendChild(claimBtn);
                  } else {
                    boxDiv.style.display = 'none';
                  }
                } catch (e) {
                  console.error('Error checking futarchy receipts:', e);
                  const boxDiv = document.getElementById(`futarchy-${proposal.id.toString()}`);
                  if (boxDiv) boxDiv.style.display = 'none';
                }
              })();
            }
          }

          const fullProposalId = proposal.id.toString();
          const truncatedId = fullProposalId.length > 12 ?
            fullProposalId.slice(0, 8) + '...' + fullProposalId.slice(-4) :
            fullProposalId;

          proposalDiv.innerHTML = `
            <div class="proposal-header">
              <span class="proposal-id" style="display: flex; align-items: center; gap: 0.35rem;">
                <span>Proposal #${truncatedId}</span>
                <button onclick="copyProposalId('${fullProposalId}')"
                        title="Copy full proposal ID"
                        style="background: none; border: none; color: rgba(230, 217, 255, 0.4); cursor: pointer; padding: 0.15rem; line-height: 1; transition: all 0.2s ease;"
                        onmouseover="this.style.color='#9d7bff'; this.style.opacity='1';"
                        onmouseout="this.style.color='rgba(230, 217, 255, 0.4)'; this.style.opacity='1';">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                  </svg>
                </button>
                ${verificationBadge}
              </span>
              <span class="proposal-state ${stateClass}">${stateText}</span>
            </div>
            <div class="proposal-description">${description}${calldataLink}</div>
            <div class="proposal-votes">
              <div class="proposal-vote-stat">
                <div class="proposal-vote-label">For</div>
                <div class="proposal-vote-value">${forVotes}</div>
              </div>
              <div class="proposal-vote-stat">
                <div class="proposal-vote-label">Against</div>
                <div class="proposal-vote-value">${againstVotes}</div>
              </div>
              <div class="proposal-vote-stat">
                <div class="proposal-vote-label">Abstain</div>
                <div class="proposal-vote-value">${abstainVotes}</div>
              </div>
            </div>
            <div class="proposal-actions">
              ${!userHasVoted && state === 1 ? `
                <button class="proposal-button for" onclick="voteOnProposal('${proposal.id.toString()}', 1)">Vote For</button>
                <button class="proposal-button against" onclick="voteOnProposal('${proposal.id.toString()}', 0)">Vote Against</button>
                <button class="proposal-button" onclick="voteOnProposal('${proposal.id.toString()}', 2)">Abstain</button>
              ` : ''}
              ${userHasVoted && state === 1 ? `
                <span class="user-vote-indicator">You voted: <strong>${userVoteType}</strong></span>
                <button class="proposal-button cancel" onclick="cancelVoteOnProposal('${proposal.id.toString()}')">Cancel Vote</button>
              ` : ''}
              ${isExecutable ?
                `<button class="proposal-button execute" onclick="executeProposalFromData('${proposal.id.toString()}')">Execute</button>` :
                ''}
            </div>
            ${futarchyUI}
          `;

          proposalsList.appendChild(proposalDiv);
        });
      }

      // Vote on proposal
      async function voteOnProposal(proposalId, support) {
        if (!currentDAO || !signer) {
          showStatus('Please connect wallet and select a DAO', true);
          return;
        }

        try {
          const molochContract = new ethers.Contract(currentDAO.dao.dao, MOLOCH_ABI, signer);

          // Convert string to BigInt (passed as string to avoid overflow in onclick)
          const proposalIdBigInt = BigInt(proposalId);

          const voteType = support === 1 ? 'For' : support === 0 ? 'Against' : 'Abstain';
          showStatus(`Casting vote ${voteType}...`, false);

          const tx = await molochContract.castVote(proposalIdBigInt, support);

          showStatus('Transaction submitted. Waiting for confirmation...', false);
          await tx.wait();

          showStatus(`Vote ${voteType} submitted successfully!`, false);

          // Refresh DAO data
          await refreshCurrentDAO();
          await renderProposals();
        } catch (error) {
          console.error('Error voting:', error);

          if (isUserRejection(error)) {
            showStatus('Vote cancelled', false);
            return;
          }

          let errorMessage = 'Failed to cast vote';

          if (error.message?.includes('already voted')) {
            errorMessage = 'You have already voted on this proposal';
          } else if (error.message?.includes('not active')) {
            errorMessage = 'Proposal is not active for voting';
          } else if (error.message?.includes('insufficient')) {
            errorMessage = 'Insufficient voting power or funds';
          } else if (error.shortMessage) {
            errorMessage = error.shortMessage;
          } else if (error.reason) {
            errorMessage = error.reason;
          } else if (error.message) {
            const msg = error.message.split('\n')[0];
            if (msg.length < 100) {
              errorMessage = msg;
            }
          }

          showStatus(errorMessage, true);
        }
      }

      // Cancel vote on proposal
      async function cancelVoteOnProposal(proposalId) {
        if (!currentDAO || !signer) {
          showStatus('Please connect wallet and select a DAO', true);
          return;
        }

        if (!confirm('Are you sure you want to cancel your vote on this proposal?')) {
          return;
        }

        try {
          const molochContract = new ethers.Contract(currentDAO.dao.dao, MOLOCH_ABI, signer);

          // Convert string to BigInt (passed as string to avoid overflow in onclick)
          const proposalIdBigInt = BigInt(proposalId);

          showStatus('Cancelling vote...', false);
          const tx = await molochContract.cancelVote(proposalIdBigInt);

          showStatus('Transaction submitted. Waiting for confirmation...', false);
          await tx.wait();

          showStatus('Vote cancelled successfully!', false);

          // Refresh DAO data
          await refreshCurrentDAO();
          await renderProposals();
        } catch (error) {
          console.error('Error cancelling vote:', error);

          if (isUserRejection(error)) {
            showStatus('Vote cancellation aborted', false);
            return;
          }

          let errorMessage = 'Failed to cancel vote';

          if (error.message?.includes('not voted')) {
            errorMessage = 'You have not voted on this proposal';
          } else if (error.message?.includes('not active')) {
            errorMessage = 'Proposal is not active';
          } else if (error.shortMessage) {
            errorMessage = error.shortMessage;
          } else if (error.reason) {
            errorMessage = error.reason;
          } else if (error.message) {
            const msg = error.message.split('\n')[0];
            if (msg.length < 100) {
              errorMessage = msg;
            }
          }

          showStatus(errorMessage, true);
        }
      }

      // Claim futarchy rewards
      async function claimFutarchyReward(proposalId, amountStr) {
        if (!currentDAO || !signer) {
          showStatus('Please connect wallet and select a DAO', true);
          return;
        }

        try {
          const molochContract = new ethers.Contract(currentDAO.dao.dao, MOLOCH_ABI, signer);

          // Convert string to BigInt
          const proposalIdBigInt = BigInt(proposalId);
          const amount = BigInt(amountStr);

          showStatus('Claiming futarchy rewards...', false);
          const tx = await molochContract.cashOutFutarchy(proposalIdBigInt, amount);

          showStatus('Transaction submitted. Waiting for confirmation...', false);
          const receipt = await tx.wait();

          showStatus('Rewards claimed successfully!', false);

          // Refresh DAO data
          await refreshCurrentDAO();
          await renderProposals();
        } catch (error) {
          console.error('Error claiming futarchy rewards:', error);

          if (isUserRejection(error)) {
            showStatus('Claim cancelled', false);
            return;
          }

          let errorMessage = 'Failed to claim rewards';

          if (error.message?.includes('not enabled')) {
            errorMessage = 'Futarchy not enabled for this proposal';
          } else if (error.message?.includes('not resolved')) {
            errorMessage = 'Futarchy market not yet resolved';
          } else if (error.shortMessage) {
            errorMessage = error.shortMessage;
          } else if (error.reason) {
            errorMessage = error.reason;
          } else if (error.message) {
            const msg = error.message.split('\n')[0];
            if (msg.length < 100) {
              errorMessage = msg;
            }
          }

          showStatus(errorMessage, true);
        }
      }

      // Update calldata preview link in proposal form
      function updateCalldataPreview() {
        const calldataInput = document.getElementById('proposalData');
        const previewDiv = document.getElementById('calldataPreview');
        const previewLink = document.getElementById('calldataPreviewLink');

        if (!calldataInput || !previewDiv || !previewLink) return;

        const calldata = calldataInput.value.trim();

        // Show link only if calldata is not empty and not just "0x"
        if (calldata && calldata !== '0x' && calldata.length > 2) {
          previewLink.href = `https://calldata.swiss-knife.xyz/decoder?calldata=${calldata}`;
          previewDiv.style.display = 'block';
        } else {
          previewDiv.style.display = 'none';
        }
      }

      // Update target address hint to show token symbol if recognized
      function updateTargetAddressHint() {
        const addressInput = document.getElementById('proposalTo');
        const hintDiv = document.getElementById('targetAddressHint');
        const hintBadge = document.getElementById('targetAddressHintBadge');
        const valueGroup = document.getElementById('proposalValueGroup');

        if (!addressInput || !hintDiv || !hintBadge) return;

        const address = addressInput.value.trim().toLowerCase();

        // Check if address matches any known tokens
        const tokenMap = {
          [TOKEN_ADDRESSES.usdc.toLowerCase()]: 'USDC Token',
          [TOKEN_ADDRESSES.usdt.toLowerCase()]: 'USDT Token',
          [TOKEN_ADDRESSES.dai.toLowerCase()]: 'DAI Token',
          [TOKEN_ADDRESSES.wsteth.toLowerCase()]: 'wstETH Token',
          [TOKEN_ADDRESSES.reth.toLowerCase()]: 'rETH Token'
        };

        // Add shares and loot tokens if currentDAO is available
        if (currentDAO && currentDAO.dao && currentDAO.dao.meta) {
          if (currentDAO.dao.meta.sharesToken) {
            tokenMap[currentDAO.dao.meta.sharesToken.toLowerCase()] = `${currentDAO.dao.meta.symbol} Shares`;
          }
          if (currentDAO.dao.meta.lootToken) {
            tokenMap[currentDAO.dao.meta.lootToken.toLowerCase()] = `${currentDAO.dao.meta.symbol} Loot`;
          }
        }

        // Add the DAO's own address for self-calls
        if (currentDAO && currentDAO.dao && currentDAO.dao.dao) {
          if (address === currentDAO.dao.dao.toLowerCase()) {
            tokenMap[address] = `${currentDAO.dao.meta.symbol} DAO (Self-Call)`;
          }
        }

        if (tokenMap[address]) {
          hintBadge.textContent = `📍 ${tokenMap[address]}`;
          hintDiv.style.display = 'block';

          // Hide ETH value field for ERC20 tokens (no reason to send ETH to them)
          if (valueGroup) {
            valueGroup.style.display = 'none';
            document.getElementById('proposalValue').value = '0';
          }
        } else {
          hintDiv.style.display = 'none';

          // Show ETH value field for non-token addresses
          if (valueGroup) {
            valueGroup.style.display = 'block';
          }
        }

        // Update calldata translation when target changes
        updateCalldataTranslation();
      }

      // Translate calldata for known ERC20 functions
      function updateCalldataTranslation() {
        const targetInput = document.getElementById('proposalTo');
        const calldataInput = document.getElementById('proposalData');
        const translationDiv = document.getElementById('calldataTranslation');

        if (!targetInput || !calldataInput || !translationDiv) return;

        const target = targetInput.value.trim().toLowerCase();
        const calldata = calldataInput.value.trim();

        // Only translate if targeting a known ERC20 token
        const tokenInfo = {
          [TOKEN_ADDRESSES.usdc.toLowerCase()]: { symbol: 'USDC', decimals: 6 },
          [TOKEN_ADDRESSES.usdt.toLowerCase()]: { symbol: 'USDT', decimals: 6 },
          [TOKEN_ADDRESSES.dai.toLowerCase()]: { symbol: 'DAI', decimals: 18 },
          [TOKEN_ADDRESSES.wsteth.toLowerCase()]: { symbol: 'wstETH', decimals: 18 },
          [TOKEN_ADDRESSES.reth.toLowerCase()]: { symbol: 'rETH', decimals: 18 }
        };

        // Add shares and loot tokens if currentDAO is available
        if (currentDAO && currentDAO.dao && currentDAO.dao.meta) {
          if (currentDAO.dao.meta.sharesToken) {
            tokenInfo[currentDAO.dao.meta.sharesToken.toLowerCase()] = {
              symbol: currentDAO.dao.meta.symbol,
              decimals: 18
            };
          }
          if (currentDAO.dao.meta.lootToken) {
            tokenInfo[currentDAO.dao.meta.lootToken.toLowerCase()] = {
              symbol: `${currentDAO.dao.meta.symbol}-LOOT`,
              decimals: 18
            };
          }
        }

        const token = tokenInfo[target];

        // Check if this is a DAO self-call
        let isDaoSelfCall = false;
        if (currentDAO && currentDAO.dao && currentDAO.dao.dao) {
          isDaoSelfCall = (target === currentDAO.dao.dao.toLowerCase());
        }

        if (!calldata || calldata === '0x' || calldata.length < 10) {
          translationDiv.style.display = 'none';
          return;
        }

        // If it's neither a token nor a DAO self-call, don't translate
        if (!token && !isDaoSelfCall) {
          translationDiv.style.display = 'none';
          return;
        }

        try {
          const functionSelector = calldata.slice(0, 10).toLowerCase();
          const abiCoder = new ethers.AbiCoder();
          let translation = '';

          // setAutoFutarchy(uint256 param, uint256 cap) - 0xc7b6a5b7 (for DAO self-calls)
          if (isDaoSelfCall && functionSelector === '0xc7b6a5b7' && calldata.length >= 138) {
            const decoded = abiCoder.decode(['uint256', 'uint256'], '0x' + calldata.slice(10));
            const param = decoded[0];
            const cap = decoded[1];

            let futarchyDesc = 'Disabled';
            if (param > 0n && cap > 0n) {
              const paramBps = Number(param);
              const paramPercent = (paramBps / 100).toFixed(2);
              const capFormatted = parseFloat(ethers.formatEther(cap)).toFixed(1);
              futarchyDesc = `${paramPercent}% of supply, ${capFormatted} LOOT cap`;
            }

            translation = `
              <div style="opacity: 0.8; margin-bottom: 0.35rem; font-size: 0.8rem;">Configure Auto-Futarchy</div>
              <div>Set voter rewards: <strong>${futarchyDesc}</strong></div>
              <div style="margin-top: 0.25rem; font-size: 0.75rem; opacity: 0.7;">DAO self-call (governance)</div>
            `;
          }
          // setSale(address payToken, uint256 pricePerShare, uint256 cap, bool minting, bool active, bool isLoot) - 0x62843c99
          else if (isDaoSelfCall && functionSelector === '0x62843c99' && calldata.length >= 202) {
            const decoded = abiCoder.decode(['address', 'uint256', 'uint256', 'bool', 'bool', 'bool'], '0x' + calldata.slice(10));
            const payToken = decoded[0];
            const pricePerShare = decoded[1];
            const cap = decoded[2];
            const minting = decoded[3];
            const active = decoded[4];
            const isLoot = decoded[5];

            const tokenNames = {
              [ethers.ZeroAddress.toLowerCase()]: 'ETH',
              [TOKEN_ADDRESSES.usdc.toLowerCase()]: 'USDC',
              [TOKEN_ADDRESSES.usdt.toLowerCase()]: 'USDT',
              [TOKEN_ADDRESSES.dai.toLowerCase()]: 'DAI',
              [TOKEN_ADDRESSES.wsteth.toLowerCase()]: 'wstETH',
              [TOKEN_ADDRESSES.reth.toLowerCase()]: 'rETH'
            };

            const tokenDecimals = {
              [ethers.ZeroAddress.toLowerCase()]: 18,
              [TOKEN_ADDRESSES.usdc.toLowerCase()]: 6,
              [TOKEN_ADDRESSES.usdt.toLowerCase()]: 6,
              [TOKEN_ADDRESSES.dai.toLowerCase()]: 18,
              [TOKEN_ADDRESSES.wsteth.toLowerCase()]: 18,
              [TOKEN_ADDRESSES.reth.toLowerCase()]: 18
            };

            const tokenName = tokenNames[payToken.toLowerCase()] || 'Unknown';
            const decimals = tokenDecimals[payToken.toLowerCase()] || 18;
            const price = ethers.formatUnits(pricePerShare, decimals);
            const tokenType = isLoot ? 'LOOT' : 'SHARES';
            const statusText = active ? 'Enable' : 'Disable';
            const capText = cap > 0n ? `${ethers.formatEther(cap)} cap` : 'unlimited';
            const sourceText = minting ? 'mint new' : 'from treasury';

            translation = `
              <div style="opacity: 0.8; margin-bottom: 0.35rem; font-size: 0.8rem;">Configure ${tokenType} Sale</div>
              <div>${statusText}: <strong>${price} ${tokenName}</strong> per token</div>
              <div style="margin-top: 0.25rem; font-size: 0.75rem; opacity: 0.7;">${sourceText}, ${capText}</div>
            `;
          }
          // mintFromMoloch(address recipient, uint256 amount) - 0x7c1fb593
          else if (token && functionSelector === '0x7c1fb593' && calldata.length >= 138) {
            const decoded = abiCoder.decode(['address', 'uint256'], '0x' + calldata.slice(10));
            const recipient = decoded[0];
            const amount = decoded[1];
            const formattedAmount = ethers.formatUnits(amount, token.decimals);

            translation = `
              <div style="opacity: 0.8; margin-bottom: 0.35rem; font-size: 0.8rem;">Mint Tokens</div>
              <div>Mint <strong>${formattedAmount} ${token.symbol}</strong></div>
              <div style="margin-top: 0.25rem; font-size: 0.8rem;">To: <code style="background: rgba(0,0,0,0.3); padding: 0.15rem 0.35rem;">${recipient}</code></div>
            `;
          }
          // transfer(address recipient, uint256 amount) - 0xa9059cbb
          else if (token && functionSelector === '0xa9059cbb' && calldata.length >= 138) {
            const decoded = abiCoder.decode(['address', 'uint256'], '0x' + calldata.slice(10));
            const recipient = decoded[0];
            const amount = decoded[1];
            const formattedAmount = ethers.formatUnits(amount, token.decimals);

            translation = `
              <div style="opacity: 0.8; margin-bottom: 0.35rem; font-size: 0.8rem;">Transfer</div>
              <div>Send <strong>${formattedAmount} ${token.symbol}</strong></div>
              <div style="margin-top: 0.25rem; font-size: 0.8rem;">To: <code style="background: rgba(0,0,0,0.3); padding: 0.15rem 0.35rem;">${recipient}</code></div>
            `;
          }
          // approve(address spender, uint256 amount) - 0x095ea7b3
          else if (token && functionSelector === '0x095ea7b3' && calldata.length >= 138) {
            const decoded = abiCoder.decode(['address', 'uint256'], '0x' + calldata.slice(10));
            const spender = decoded[0];
            const amount = decoded[1];
            const formattedAmount = amount === ethers.MaxUint256 ? 'Unlimited' : ethers.formatUnits(amount, token.decimals);

            translation = `
              <div style="opacity: 0.8; margin-bottom: 0.35rem; font-size: 0.8rem;">Approve</div>
              <div>Allow <strong>${formattedAmount} ${token.symbol}</strong></div>
              <div style="margin-top: 0.25rem; font-size: 0.8rem;">Spender: <code style="background: rgba(0,0,0,0.3); padding: 0.15rem 0.35rem;">${spender}</code></div>
            `;
          }
          // transferFrom(address sender, address recipient, uint256 amount) - 0x23b872dd
          else if (token && functionSelector === '0x23b872dd' && calldata.length >= 202) {
            const decoded = abiCoder.decode(['address', 'address', 'uint256'], '0x' + calldata.slice(10));
            const sender = decoded[0];
            const recipient = decoded[1];
            const amount = decoded[2];
            const formattedAmount = ethers.formatUnits(amount, token.decimals);

            translation = `
              <div style="opacity: 0.8; margin-bottom: 0.35rem; font-size: 0.8rem;">Transfer From</div>
              <div>Send <strong>${formattedAmount} ${token.symbol}</strong></div>
              <div style="margin-top: 0.25rem; font-size: 0.8rem;">From: <code style="background: rgba(0,0,0,0.3); padding: 0.15rem 0.35rem;">${sender}</code></div>
              <div style="margin-top: 0.25rem; font-size: 0.8rem;">To: <code style="background: rgba(0,0,0,0.3); padding: 0.15rem 0.35rem;">${recipient}</code></div>
            `;
          }

          if (translation) {
            translationDiv.innerHTML = translation;
            translationDiv.style.display = 'block';
          } else {
            translationDiv.style.display = 'none';
          }
        } catch (e) {
          console.error('Error translating calldata:', e);
          translationDiv.style.display = 'none';
        }
      }

      // Create and publish proposal
      async function createProposal() {
        if (!currentDAO || !signer) {
          showStatus('Please connect wallet and select a DAO', true);
          return;
        }

        const op = parseInt(document.getElementById('proposalOp').value);
        const to = document.getElementById('proposalTo').value;
        const value = document.getElementById('proposalValue').value;
        let data = document.getElementById('proposalData').value || '0x';
        const description = document.getElementById('proposalDescription').value;

        if (!to || !value || !description) {
          showStatus('Please fill in all required fields', true);
          return;
        }

        // Validate and normalize inputs
        try {
          // Ensure data is valid hex
          if (!data.startsWith('0x')) {
            data = '0x' + data;
          }
          if (data.length % 2 !== 0) {
            throw new Error('Data must be valid hex (even number of characters)');
          }

          // Validate address
          if (!ethers.isAddress(to)) {
            throw new Error('Invalid target address');
          }
        } catch (validationError) {
          showStatus('Validation error: ' + validationError.message, true);
          return;
        }

        // Generate random nonce (32 bytes)
        const nonce = ethers.hexlify(ethers.randomBytes(32));

        try {
          const molochContract = new ethers.Contract(currentDAO.dao.dao, MOLOCH_ABI, signer);

          // Get config from DAO
          const config = await molochContract.config();

          // Compute proposal ID locally
          const valueWei = ethers.parseEther(value);
          const computedProposalId = computeProposalId(currentDAO.dao.dao, op, to, valueWei, data, nonce, config);

          // Encode proposal as message
          // The tagged JSON contains all execution parameters
          // The description is included in the JSON for readability
          const proposalMessage = encodeProposalMessage(op, to, valueWei, data, nonce, description);

          // Create interface for encoding multicall data
          const iface = new ethers.Interface(MOLOCH_ABI);

          // Encode chat call
          const chatCalldata = iface.encodeFunctionData('chat', [proposalMessage]);

          // Encode openProposal call
          const openProposalCalldata = iface.encodeFunctionData('openProposal', [computedProposalId]);

          // Execute multicall (chat + openProposal in one transaction)
          showStatus('Creating proposal...', false);
          const tx = await molochContract.multicall([chatCalldata, openProposalCalldata]);

          showStatus('Transaction submitted. Waiting for confirmation...', false);
          await tx.wait();

          showStatus(`Proposal created successfully! ID: ${computedProposalId.toString()}`, false);

          // Clear form (reset op to 0/call)
          document.getElementById('proposalOp').value = '0';
          document.getElementById('proposalTo').value = '';
          document.getElementById('proposalValue').value = '';
          document.getElementById('proposalData').value = '';
          document.getElementById('proposalDescription').value = '';

          // Clear UI hints
          updateTargetAddressHint();
          updateCalldataTranslation();
          updateCalldataPreview();

          // Refresh
          await refreshCurrentDAO();
          renderChatroom();
          await renderProposals();
        } catch (error) {
          console.error('Error creating proposal:', error);

          if (isUserRejection(error)) {
            showStatus('Proposal creation cancelled', false);
            return;
          }

          let errorMessage = 'Failed to create proposal';

          if (error.message?.includes('insufficient funds')) {
            errorMessage = 'Insufficient funds for transaction';
          } else if (error.shortMessage) {
            errorMessage = error.shortMessage;
          } else if (error.reason) {
            errorMessage = error.reason;
          } else if (error.message) {
            // Only show concise error, not the full dump
            const msg = error.message.split('\n')[0]; // Take first line only
            if (msg.length < 100) {
              errorMessage = msg;
            }
          }

          showStatus(errorMessage, true);
        }
      }

      // Execute proposal by extracting parameters from tagged message
      async function executeProposalFromData(proposalId) {
        // Convert string to BigInt (passed as string to avoid overflow in onclick)
        const proposalIdBigInt = BigInt(proposalId);

        try {
          const molochContract = new ethers.Contract(currentDAO.dao.dao, MOLOCH_ABI, signer);
          const config = await molochContract.config();

          // Find the proposal data from messages by matching the proposal ID
          let proposalData = null;
          for (const msg of currentDAO.dao.messages) {
            const propData = decodeProposalMessage(msg.text);
            if (propData) {
              // Verify this is the correct proposal by computing its ID
              const valueBigInt = BigInt(propData.value);
              const computedId = computeProposalId(
                currentDAO.dao.dao,
                propData.op,
                propData.to,
                valueBigInt,
                propData.data,
                propData.nonce,
                config
              );

              if (computedId.toString() === proposalIdBigInt.toString()) {
                proposalData = propData;
                break;
              }
            }
          }

          if (!proposalData) {
            showStatus('Could not find proposal data in messages', true);
            return;
          }

          // Convert stored string value back to BigInt for proper encoding
          const valueBigInt = BigInt(proposalData.value);

          if (!confirm(`Execute proposal:\n\n${proposalData.description}\n\nOp: ${proposalData.op}\nTo: ${proposalData.to}\nValue: ${ethers.formatEther(valueBigInt)} ETH\nData: ${proposalData.data.slice(0, 66)}${proposalData.data.length > 66 ? '...' : ''}`)) {
            return;
          }

          showStatus('Executing proposal...', false);

          const tx = await molochContract.executeByVotes(
            proposalData.op,
            proposalData.to,
            valueBigInt,  // Use BigInt, not string
            proposalData.data,
            proposalData.nonce
          );

          showStatus('Transaction submitted. Waiting for confirmation...', false);
          await tx.wait();

          showStatus('Proposal executed successfully!', false);

          // Refresh
          await refreshCurrentDAO();
          await renderProposals();
        } catch (error) {
          console.error('Error executing proposal:', error);

          if (isUserRejection(error)) {
            showStatus('Execution cancelled', false);
            return;
          }

          let errorMessage = 'Failed to execute proposal';

          if (error.message?.includes('not succeeded')) {
            errorMessage = 'Proposal has not passed or is not ready for execution';
          } else if (error.message?.includes('already executed')) {
            errorMessage = 'Proposal has already been executed';
          } else if (error.message?.includes('insufficient funds')) {
            errorMessage = 'Insufficient funds in treasury';
          } else if (error.shortMessage) {
            errorMessage = error.shortMessage;
          } else if (error.reason) {
            errorMessage = error.reason;
          } else if (error.message) {
            const msg = error.message.split('\n')[0];
            if (msg.length < 100) {
              errorMessage = msg;
            }
          }

          showStatus(errorMessage, true);
        }
      }

      // Refresh current DAO data
      async function refreshCurrentDAO() {
        if (!currentDAO || !provider || !connectedAddress) return;

        try {
          const viewHelper = new ethers.Contract(VIEW_HELPER_ADDRESS, VIEW_HELPER_ABI, provider);

          // Find the current DAO's index in the summoner
          // For now, just refresh all user DAOs and find it
          const updatedDAOs = await viewHelper.getUserDAOsFullState(
            connectedAddress,
            0,
            10,
            0,
            10,
            0,
            10
          );

          // Find current DAO in updated list
          for (let i = 0; i < updatedDAOs.length; i++) {
            if (updatedDAOs[i].dao.dao.toLowerCase() === currentDAO.dao.dao.toLowerCase()) {
              currentDAO = updatedDAOs[i];
              userDAOs = updatedDAOs;
              break;
            }
          }
        } catch (error) {
          console.error('Error refreshing DAO:', error);
        }
      }

      function createMemberRow(address = '', shares = '', isFirst = false) {
        const row = document.createElement('div');
        row.className = 'member-row';
        row.dataset.memberId = memberIdCounter++;
        
        row.innerHTML = `
          <input type="text" class="form-input member-address" placeholder="0x... or ENS name" value="${address}" ${isFirst ? 'readonly' : ''}>
          <input type="number" class="form-input member-shares" placeholder="Shares" value="${shares}" min="0.000000000000000001" step="any">
          ${!isFirst ? '<button type="button" class="remove-member" onclick="removeMember(this)">×</button>' : ''}
        `;
        
        return row;
      }

      function addMemberRow() {
        const memberRow = createMemberRow();
        document.getElementById('foundingMembersList').appendChild(memberRow);
        updateLootInputs();
      }

      function removeMember(button) {
        button.parentElement.remove();
        updateLootInputs();
      }

      function toggleAdvanced() {
        const advanced = document.getElementById('advancedSettings');
        advanced.classList.toggle('show');
        document.querySelector('.advanced-toggle').textContent = 
          advanced.classList.contains('show') ? '▲ Advanced Settings' : '▼ Advanced Settings';
      }

      async function resolveENS(input) {
        if (input.endsWith('.eth')) {
          try {
            const address = await provider.resolveName(input);
            if (address) return address;
            throw new Error(`Could not resolve ENS name: ${input}`);
          } catch (e) {
            console.error('ENS resolution failed:', e);
            throw new Error(`Invalid ENS name: ${input}`);
          }
        }
        return input;
      }

      function showStatus(message, isError = false) {
        const statusEl = document.getElementById('statusMessage');
        statusEl.innerHTML = `<div class="status-message ${isError ? 'error-message' : ''}">${message}</div>`;
        if (!isError) {
          setTimeout(() => statusEl.innerHTML = '', 10000);
        }
      }

      function copyProposalId(proposalId) {
        // Create a temporary textarea to copy the proposal ID
        const textarea = document.createElement('textarea');
        textarea.value = proposalId;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();

        try {
          document.execCommand('copy');
          showStatus('Proposal ID copied to clipboard', false);
        } catch (err) {
          // Fallback to modern clipboard API
          navigator.clipboard.writeText(proposalId).then(() => {
            showStatus('Proposal ID copied to clipboard', false);
          }).catch(() => {
            showStatus('Failed to copy proposal ID', true);
          });
        } finally {
          document.body.removeChild(textarea);
        }
      }

      function toggleSaleConfig() {
        const preset = document.getElementById('initialSalePreset').value;
        const section = document.getElementById('saleConfigSection');
        section.style.display = preset === 'custom' ? 'block' : 'none';
      }

      // Add loot distribution toggle handler
      document.getElementById('distributeLoot')?.addEventListener('change', (e) => {
        document.getElementById('lootDistribution').style.display = e.target.checked ? 'block' : 'none';
        if (e.target.checked) {
          updateLootInputs();
        }
      });

      // Add equal loot toggle handler
      document.getElementById('equalLoot')?.addEventListener('change', (e) => {
        document.getElementById('customLootAmounts').style.display = e.target.checked ? 'none' : 'block';
        updateLootInputs();
      });

      // Update loot inputs when members change
      function updateLootInputs() {
        if (!document.getElementById('distributeLoot').checked) return;
        if (document.getElementById('equalLoot').checked) return;
        
        const customLootDiv = document.getElementById('customLootAmounts');
        const memberRows = document.querySelectorAll('.member-row');
        
        customLootDiv.innerHTML = '<div style="font-size: 0.8rem; color: rgba(230, 217, 255, 0.6); margin-bottom: 0.5rem;">Custom loot per member:</div>';
        
        memberRows.forEach((row, index) => {
          const addressInput = row.querySelector('.member-address').value || `Member ${index + 1}`;
          const shortAddr = addressInput.startsWith('0x') ? 
            addressInput.slice(0, 6) + '...' + addressInput.slice(-4) : 
            addressInput;
          
          const lootInput = document.createElement('div');
          lootInput.style.marginBottom = '0.5rem';
          lootInput.innerHTML = `
            <label style="font-size: 0.8rem; color: rgba(230, 217, 255, 0.7);">${shortAddr}</label>
            <input type="number" class="form-input custom-loot-amount" data-member-index="${index}" 
                   placeholder="0" min="0" step="any" style="margin-top: 0.25rem;">
          `;
          customLootDiv.appendChild(lootInput);
        });
      }

      // Helper to calculate seconds from value and unit
      function getSecondsFromInput(valueId, unitId) {
        const value = parseInt(document.getElementById(valueId).value || 0);
        const unit = parseInt(document.getElementById(unitId).value || 1);
        return value * unit;
      }

      // CREATE2 address prediction
      function predictCreate2Address(deployer, salt, initCodeHash) {
        const encoded = ethers.solidityPacked(
          ['bytes1', 'address', 'bytes32', 'bytes32'],
          ['0xff', deployer, salt, initCodeHash]
        );
        const hash = ethers.keccak256(encoded);
        return '0x' + hash.slice(-40);
      }

      // Predict Moloch DAO address
      function predictDaoAddress(summonerAddress, implementationAddress, initHolders, initShares, userSalt) {
        // Summoner uses: keccak256(abi.encode(initHolders, initShares, salt))
        const abiCoder = new ethers.AbiCoder();
        const saltData = abiCoder.encode(
          ['address[]', 'uint256[]', 'bytes32'],
          [initHolders, initShares, userSalt]
        );
        const salt = ethers.keccak256(saltData);

        // Minimal proxy bytecode that summoner deploys
        // This is the exact bytecode from the summoner's create2 call
        const proxyBytecode = ethers.concat([
          '0x602d5f8160095f39f35f5f365f5f37365f73',
          ethers.zeroPadValue(implementationAddress, 20),
          '0x5af43d5f5f3e6029573d5ffd5b3d5ff3'
        ]);
        
        const initCodeHash = ethers.keccak256(proxyBytecode);
        return predictCreate2Address(summonerAddress, salt, initCodeHash);
      }

      document.getElementById('summonForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (!signer) {
          await connectWallet();
          if (!signer) return;
        }

        const summonBtn = document.getElementById('summonBtn');
        summonBtn.disabled = true;
        summonBtn.textContent = 'SUMMONING...';

        try {
          // Check network
          const network = await provider.getNetwork();
          if (network.chainId !== 1n) {
            throw new Error('Please switch to Ethereum Mainnet');
          }

          // Gather form data
          const daoName = document.getElementById('daoName').value;
          const daoSymbol = document.getElementById('daoSymbol').value;
          const daoURI = document.getElementById('daoURI').value || '';
          const quorumBps = Math.floor(parseFloat(document.getElementById('quorumBps').value || 50) * 100);
          const ragequittable = document.getElementById('ragequittable').checked;

          // Collect members
          const memberRows = document.querySelectorAll('.member-row');
          const initHolders = [];
          const initShares = [];

          for (const row of memberRows) {
            const addressInput = row.querySelector('.member-address').value.trim();
            const sharesInput = row.querySelector('.member-shares').value;
            
            if (addressInput && sharesInput) {
              const address = await resolveENS(addressInput);
              if (!ethers.isAddress(address)) {
                throw new Error(`Invalid address: ${addressInput}`);
              }
              
              initHolders.push(address);
              // Convert shares to wei (18 decimals) - ethers v6
              initShares.push(ethers.parseEther(sharesInput));
            }
          }

          if (initHolders.length === 0) {
            throw new Error('At least one member is required');
          }

          // Calculate total initial shares for validation
          let totalShares = 0n;
          for (const shares of initShares) {
            totalShares += shares;
          }

          // Validate proposal threshold if specified
          const proposalThresholdInput = document.getElementById('proposalThreshold').value;
          let proposalThresholdWei = 0n;
          if (proposalThresholdInput && parseFloat(proposalThresholdInput) > 0) {
            proposalThresholdWei = ethers.parseEther(proposalThresholdInput);
            if (proposalThresholdWei > totalShares) {
              throw new Error(`Proposal threshold (${proposalThresholdInput}) cannot exceed total initial shares (${ethers.formatEther(totalShares)})`);
            }
          }

          // Generate random salt ONCE for this entire summon operation
          const salt = ethers.randomBytes(32);
          const saltHex = ethers.hexlify(salt);


          // Connect to summoner
          const summoner = new ethers.Contract(SUMMONER_ADDRESS, SUMMONER_ABI, signer);
          
          // Ensure initShares are BigInt for consistent encoding
          const initSharesForPrediction = initShares.map(s => BigInt(s.toString()));
          
          // Predict all addresses using the Solidity reference implementation
          const predictions = predictMajeurAddresses(
            initHolders,
            initSharesForPrediction,
            salt
          );
          
          const predictedDao = predictions.dao;
          const predictedLoot = predictions.loot;

          // Prepare init calls with predicted DAO address
          const initCalls = [];
          
          // Add proposal TTL setting if specified
          const proposalTTL = getSecondsFromInput('proposalTTL', 'proposalTTLUnit');
          if (proposalTTL > 0) {
            const iface = new ethers.Interface(['function setProposalTTL(uint64)']);
            initCalls.push({
              target: predictedDao, // Self-call to the DAO
              value: 0n,
              data: iface.encodeFunctionData('setProposalTTL', [proposalTTL])
            });
          }

          // Add timelock delay setting if specified
          const timelockDelay = getSecondsFromInput('timelockDelay', 'timelockDelayUnit');
          if (timelockDelay > 0) {
            const iface = new ethers.Interface(['function setTimelockDelay(uint64)']);
            initCalls.push({
              target: predictedDao, // Self-call to the DAO
              value: 0n,
              data: iface.encodeFunctionData('setTimelockDelay', [timelockDelay])
            });
          }

          // Add loot distribution if enabled
          const distributeLoot = document.getElementById('distributeLoot').checked;
          if (distributeLoot) {
            // Collect loot amounts for each member
            const lootAmounts = [];
            const equalLoot = document.getElementById('equalLoot').checked;
            
            if (equalLoot) {
              // Equal distribution
              const lootPerMember = document.getElementById('lootPerMember').value || '100';
              const lootAmount = ethers.parseEther(lootPerMember);
              for (let i = 0; i < initHolders.length; i++) {
                lootAmounts.push(lootAmount);
              }
            } else {
              // Custom amounts
              const customInputs = document.querySelectorAll('.custom-loot-amount');
              for (let i = 0; i < initHolders.length; i++) {
                const input = customInputs[i];
                const amount = input?.value || '0';
                lootAmounts.push(ethers.parseEther(amount));
              }
            }
            
            // To mint loot during init, we use the predicted loot proxy address
            // The loot implementation is shared by all Moloch clones
            const LOOT_IMPL_ADDRESS = '0x6f1f2aF76a3aDD953277e9F369242697C87bc6A5';
            
            // Create direct loot minting calls
            const lootInterface = new ethers.Interface(['function mintFromMoloch(address,uint256)']);
            
            let lootCallsAdded = 0;
            for (let i = 0; i < initHolders.length; i++) {
              if (lootAmounts[i] > 0n) {
                // Add each loot mint directly to initCalls
                initCalls.push({
                  target: predictedLoot,
                  value: 0n,
                  data: lootInterface.encodeFunctionData('mintFromMoloch', [
                    initHolders[i],
                    lootAmounts[i]
                  ])
                });
                lootCallsAdded++;
              }
            }
            
            if (lootCallsAdded > 0) {
              // Successfully added loot minting calls to init sequence
            }
          }

          // Add proposal threshold setting if specified
          if (proposalThresholdWei > 0n) {
            const iface = new ethers.Interface(['function setProposalThreshold(uint96)']);
            initCalls.push({
              target: predictedDao, // Self-call to the DAO
              value: 0n,
              data: iface.encodeFunctionData('setProposalThreshold', [proposalThresholdWei])
            });
          }

          // Add transferability settings if either is enabled
          const enableSharesTransfer = document.getElementById('enableSharesTransfer').checked;
          const enableLootTransfer = document.getElementById('enableLootTransfer').checked;

          if (enableSharesTransfer || enableLootTransfer) {
            // Call setTransfersLocked(bool sharesLocked, bool lootLocked)
            // Note: false = unlocked/transferable, true = locked/non-transferable
            const iface = new ethers.Interface(['function setTransfersLocked(bool sharesLocked, bool lootLocked)']);
            initCalls.push({
              target: predictedDao, // Self-call to the DAO
              value: 0n,
              data: iface.encodeFunctionData('setTransfersLocked', [
                !enableSharesTransfer, // Invert: checkbox=true means unlocked, so sharesLocked=false
                !enableLootTransfer    // Invert: checkbox=true means unlocked, so lootLocked=false
              ])
            });
          }

          // Add auto-futarchy preset if not "off"
          const futarchyPreset = document.getElementById('autoFutarchyPreset').value;
          if (futarchyPreset !== 'off') {
            let param = 0n;
            let cap = 0n;

            // Configure based on preset
            if (futarchyPreset === 'low') {
              param = 5n;  // 5 bps (0.05%)
              cap = ethers.parseEther('2');  // 2 LOOT
            } else if (futarchyPreset === 'standard') {
              param = 10n;  // 10 bps (0.1%)
              cap = ethers.parseEther('5');  // 5 LOOT
            } else if (futarchyPreset === 'high') {
              param = 50n;  // 50 bps (0.5%)
              cap = ethers.parseEther('10');  // 10 LOOT
            }

            // Add setAutoFutarchy call
            const futarchyIface = new ethers.Interface(['function setAutoFutarchy(uint256,uint256)']);
            initCalls.push({
              target: predictedDao, // Self-call to the DAO
              value: 0n,
              data: futarchyIface.encodeFunctionData('setAutoFutarchy', [param, cap])
            });
          }

          // Add initial sale configuration if enabled
          const salePreset = document.getElementById('initialSalePreset').value;
          if (salePreset === 'custom') {
            const paymentToken = document.getElementById('salePaymentToken').value;
            const tokenType = document.getElementById('saleTokenType').value;
            const priceInput = document.getElementById('salePrice').value;
            const capInput = document.getElementById('saleCap').value;
            const minting = document.getElementById('saleMinting').checked;

            if (priceInput && parseFloat(priceInput) > 0) {
              // Map token selection to addresses
              const tokenAddresses = {
                'eth': ethers.ZeroAddress,
                'usdc': TOKEN_ADDRESSES.usdc,
                'usdt': TOKEN_ADDRESSES.usdt,
                'dai': TOKEN_ADDRESSES.dai,
                'wsteth': TOKEN_ADDRESSES.wsteth,
                'reth': TOKEN_ADDRESSES.reth
              };

              const tokenDecimals = {
                'eth': 18, 'usdc': 6, 'usdt': 6,
                'dai': 18, 'wsteth': 18, 'reth': 18
              };

              const payToken = tokenAddresses[paymentToken];
              const decimals = tokenDecimals[paymentToken];
              const pricePerShare = ethers.parseUnits(priceInput, decimals);
              const cap = capInput && parseFloat(capInput) > 0 ? ethers.parseEther(capInput) : 0n;
              const isLoot = tokenType === 'loot';

              // Add setSale call
              const saleIface = new ethers.Interface([
                'function setSale(address,uint256,uint256,bool,bool,bool)'
              ]);
              initCalls.push({
                target: predictedDao, // Self-call to the DAO
                value: 0n,
                data: saleIface.encodeFunctionData('setSale', [
                  payToken, pricePerShare, cap, minting, true, isLoot
                ])
              });
            }
          }

          showStatus('Preparing transaction...');

          // Call summon
          showStatus('Please confirm the transaction in your wallet...');
          
          const tx = await summoner.summon(
            daoName,
            daoSymbol,
            daoURI,
            quorumBps,
            ragequittable,
            '0x00000000005556244d291c4c7187cdf3702a0019', // default renderer
            salt,
            initHolders,
            initShares,
            initCalls, // Now passing actual initCalls
            { value: 0 }
          );

          showStatus(`Transaction submitted: ${tx.hash.slice(0, 10)}...`);
          
          const receipt = await tx.wait();
          
          // Find DAO address from events - ethers v6 syntax
          const event = receipt.logs
            .map(log => {
              try {
                return summoner.interface.parseLog(log);
              } catch {
                return null;
              }
            })
            .find(e => e && e.name === 'NewDAO');
            
          const daoAddress = event?.args?.dao;
          
          showStatus(`✨ DAO summoned successfully at: <a href="https://etherscan.io/address/${daoAddress}" target="_blank">${daoAddress}</a>`);
          
          // Reset form
          document.getElementById('summonForm').reset();
          document.getElementById('foundingMembersList').innerHTML = '';
          const memberRow = createMemberRow(await signer.getAddress(), '1', true);
          document.getElementById('foundingMembersList').appendChild(memberRow);
          
          // Reset time units to defaults
          document.getElementById('proposalTTLUnit').value = '86400';
          document.getElementById('timelockDelayUnit').value = '86400';

          // Reset auto-futarchy preset to default
          document.getElementById('autoFutarchyPreset').value = 'off';

          // Reset and update loot inputs
          document.getElementById('distributeLoot').checked = false;
          document.getElementById('lootDistribution').style.display = 'none';
          updateLootInputs();

        } catch (error) {
          console.error(error);

          if (isUserRejection(error)) {
            showStatus('Summoning cancelled', false);
          } else {
            // Handle common wallet errors with user-friendly messages
            let errorMessage = 'Summoning failed';

            if (error.code === 'UNKNOWN_ERROR' && error.message?.includes('eth_blockNumber')) {
              errorMessage = 'Network connection issue. Please check your wallet is connected to the correct network and try again.';
            } else if (error.code === 'NETWORK_ERROR' || error.message?.includes('network')) {
              errorMessage = 'Network error. Please check your connection and try again.';
            } else if (error.code === -32000 || error.message?.includes('insufficient funds')) {
              errorMessage = 'Insufficient funds for transaction';
            } else if (error.message?.includes('nonce')) {
              errorMessage = 'Transaction nonce issue - please reset your wallet';
            } else if (error.shortMessage) {
              errorMessage = error.shortMessage;
            } else if (error.reason) {
              errorMessage = error.reason;
            } else if (error.message) {
              const msg = error.message.split('\n')[0];
              if (msg.length < 100) {
                errorMessage = msg;
              }
            }

            showStatus(errorMessage, true);
          }
        } finally {
          summonBtn.disabled = false;
          summonBtn.textContent = 'SUMMON DAO';
        }
      });

      // Auto-connect on load if already authorized
      window.addEventListener('load', async () => {
        if (window.ethereum) {
          const accounts = await window.ethereum.request({ method: 'eth_accounts' });
          if (accounts.length > 0) {
            // Auto-connect with the first detected wallet
            const wallets = detectWallets();
            if (wallets.length > 0) {
              await connectWithWallet(wallets[0].key);
            }
          }
        }
      });

      // Handle account changes
      if (window.ethereum) {
        window.ethereum.on('accountsChanged', async (accounts) => {
          if (accounts.length === 0) {
            // User disconnected from wallet
            disconnectWallet();
          } else {
            // Account switched - reconnect with the same wallet
            if (connectedWallet) {
              await connectWithWallet(connectedWallet);
            }
          }
        });

        window.ethereum.on('chainChanged', () => {
          window.location.reload();
        });
      }
    </script>
  </body>
</html>